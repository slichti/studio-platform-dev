
> api@0.0.0 test:integration
> vitest --config vitest.config.integration.ts test/integration/vod.integration.test.ts --run


 RUN  v3.2.4 /Users/slichti/GitHub/studio-platform-dev/packages/api

Using vars defined in .dev.vars
[vpw:debug] Adding `enable_nodejs_tty_module` compatibility flag during tests as this feature is needed to support the Vitest runner.
[vpw:debug] Adding `enable_nodejs_fs_module` compatibility flag during tests as this feature is needed to support the Vitest runner.
[vpw:debug] Adding `enable_nodejs_http_modules` compatibility flag during tests as this feature is needed to support the Vitest runner.
[vpw:debug] Adding `enable_nodejs_perf_hooks_module` compatibility flag during tests as this feature is needed to support the Vitest runner.
[vpw:info] Starting isolated runtimes for vitest.config.integration.ts...
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/index.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/rrule.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/dateutil.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/helpers.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/weekday.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterresult.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/callbackiterresult.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/nlp/index.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/nlp/totext.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/nlp/i18n.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/nlp/parsetext.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/types.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/parseoptions.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/datetime.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/parsestring.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/optionstostring.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/datewithzone.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/cache.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iter/index.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterinfo/index.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterinfo/yearinfo.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/masks.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterinfo/monthinfo.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterinfo/easter.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iter/poslist.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/rruleset.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterset.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/rrulestr.js" points to missing source files
stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should list catchable recordings in the public video library
<-- GET /guest/videos/vod-studio

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should list catchable recordings in the public video library
--> GET /guest/videos/vod-studio [32m200[0m 7ms

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should list catchable recordings in the public video library
{"timestamp":"2026-02-19T12:25:24.109Z","level":"info","message":"Request completed: GET /guest/videos/vod-studio","traceId":"5259aba0-ab09-4f20-a338-678e950fbdb8","environment":"test","status":200,"durationMs":8}

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should full workflow: fulfill purchase and then grant access (with multi-video content)
[Stripe] Checkout Completed: cs_vod_full_1 (Metadata: {"tenantId":"vod_tenant","type":"recording_purchase","recordingId":"vod_class_1","userId":"guest"})

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should full workflow: fulfill purchase and then grant access (with multi-video content)
[Stripe] Processing Recording Purchase: vod_class_1

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should full workflow: fulfill purchase and then grant access (with multi-video content)
[Stripe] Triggering product_purchase automation for User guest_u_7b64aa2a-c014-4425-8e8a-32c9cd20b1cd

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should full workflow: fulfill purchase and then grant access (with multi-video content)
<-- GET /classes/vod_class_1/recording

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should full workflow: fulfill purchase and then grant access (with multi-video content)
[TenantMiddleware DEBUG] Path: /classes/vod_class_1/recording, Host: localhost, Header ID: vod_tenant, Header Slug: undefined

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should full workflow: fulfill purchase and then grant access (with multi-video content)
[DEBUG] TenantMiddleware: User guest_u_7b64aa2a-c014-4425-8e8a-32c9cd20b1cd found: YES
[DEBUG] User Role: user, isPlatformAdmin: false
[DEBUG] isPlatformAdmin resolved to: false

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should full workflow: fulfill purchase and then grant access (with multi-video content)
--> GET /classes/vod_class_1/recording [32m200[0m 13ms

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should full workflow: fulfill purchase and then grant access (with multi-video content)
{"timestamp":"2026-02-19T12:25:24.151Z","level":"info","message":"Request completed: GET /classes/vod_class_1/recording","traceId":"67020925-8aad-45f7-9d5e-cca21b4c27cc","environment":"test","userId":"guest_u_7b64aa2a-c014-4425-8e8a-32c9cd20b1cd","tenantId":"vod_tenant","status":200,"durationMs":13}

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should deny access if recording is not purchased
<-- GET /classes/vod_class_1/recording

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should deny access if recording is not purchased
[TenantMiddleware DEBUG] Path: /classes/vod_class_1/recording, Host: localhost, Header ID: vod_tenant, Header Slug: undefined

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should deny access if recording is not purchased
[DEBUG] TenantMiddleware: User thief_2 found: NO
[DEBUG] isPlatformAdmin resolved to: false

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should deny access if recording is not purchased
--> GET /classes/vod_class_1/recording [33m403[0m 8ms

stdout | test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should deny access if recording is not purchased
{"timestamp":"2026-02-19T12:25:24.167Z","level":"info","message":"Request completed: GET /classes/vod_class_1/recording","traceId":"3727cec7-a1a5-4b14-abbc-119d9489cf2f","environment":"test","userId":"thief_2","tenantId":"vod_tenant","status":403,"durationMs":9}

 â¯ test/integration/vod.integration.test.ts (4 tests | 1 failed) 155ms
   âœ“ VOD Monetization (Integration) > should list catchable recordings in the public video library 39ms
   âœ“ VOD Monetization (Integration) > should full workflow: fulfill purchase and then grant access (with multi-video content) 37ms
   âœ“ VOD Monetization (Integration) > should deny access if recording is not purchased 15ms
   Ã— VOD Monetization (Integration) > should deny access to a COURSE for a member with VOD access but NO booking 9ms
     â†’ Failed query: insert into "membership_plans" ("id", "tenant_id", "name", "description", "price", "currency", "interval", "image_url", "overlay_title", "overlay_subtitle", "vod_enabled", "active", "created_at", "updated_at") values (?, ?, ?, null, ?, ?, ?, null, null, null, ?, ?, (strftime('%s', 'now')), (strftime('%s', 'now')))
params: plan_with_vod,vod_tenant,VOD Plan,0,usd,month,1,1

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 1 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/integration/vod.integration.test.ts > VOD Monetization (Integration) > should deny access to a COURSE for a member with VOD access but NO booking
Error: Failed query: insert into "membership_plans" ("id", "tenant_id", "name", "description", "price", "currency", "interval", "image_url", "overlay_title", "overlay_subtitle", "vod_enabled", "active", "created_at", "updated_at") values (?, ?, ?, null, ?, ?, ?, null, null, null, ?, ?, (strftime('%s', 'now')), (strftime('%s', 'now')))
params: plan_with_vod,vod_tenant,VOD Plan,0,usd,month,1,1
 â¯ D1PreparedQuery.queryWithCache Users/slichti/GitHub/studio-platform-dev/node_modules/drizzle-orm/sqlite-core/session.js:43:15
 â¯ D1PreparedQuery.run Users/slichti/GitHub/studio-platform-dev/node_modules/drizzle-orm/d1/session.js:119:12
 â¯ test/integration/vod.integration.test.ts:168:9


Caused by: Error: D1_ERROR: table membership_plans has no column named updated_at: SQLITE_ERROR
 â¯ D1DatabaseSessionAlwaysPrimary._sendOrThrow cloudflare-internal:d1-api:139:19
 â¯ cloudflare-internal:d1-api:348:41
 â¯ D1PreparedQuery.queryWithCache Users/slichti/GitHub/studio-platform-dev/node_modules/drizzle-orm/sqlite-core/session.js:41:16
 â¯ D1PreparedQuery.run Users/slichti/GitHub/studio-platform-dev/node_modules/drizzle-orm/d1/session.js:119:12
 â¯ test/integration/vod.integration.test.ts:168:9

Caused by: Error: table membership_plans has no column named updated_at: SQLITE_ERROR
 â¯ D1DatabaseSessionAlwaysPrimary._sendOrThrow cloudflare-internal:d1-api:140:24
 â¯ cloudflare-internal:d1-api:348:41
 â¯ D1PreparedQuery.queryWithCache Users/slichti/GitHub/studio-platform-dev/node_modules/drizzle-orm/sqlite-core/session.js:41:16
 â¯ D1PreparedQuery.run Users/slichti/GitHub/studio-platform-dev/node_modules/drizzle-orm/d1/session.js:119:12
 â¯ test/integration/vod.integration.test.ts:168:9

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯


 Test Files  1 failed (1)
      Tests  1 failed | 3 passed (4)
   Start at  07:25:15
   Duration  8.79s (transform 1.23s, setup 39ms, collect 6.02s, tests 155ms, environment 0ms, prepare 385ms)

[vpw:debug] Shutting down runtimes...
npm error Lifecycle script `test:integration` failed with error:
npm error code 1
npm error path /Users/slichti/GitHub/studio-platform-dev/packages/api
npm error workspace api@0.0.0
npm error location /Users/slichti/GitHub/studio-platform-dev/packages/api
npm error command failed
npm error command sh -c vitest --config vitest.config.integration.ts test/integration/vod.integration.test.ts --run
