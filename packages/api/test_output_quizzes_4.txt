
> api@0.0.0 test:integration
> vitest --config vitest.config.integration.ts test/integration/quizzes.integration.test.ts --run


 RUN  v3.2.4 /Users/slichti/GitHub/studio-platform-dev/packages/api

Using vars defined in .dev.vars
[vpw:debug] Adding `enable_nodejs_tty_module` compatibility flag during tests as this feature is needed to support the Vitest runner.
[vpw:debug] Adding `enable_nodejs_fs_module` compatibility flag during tests as this feature is needed to support the Vitest runner.
[vpw:debug] Adding `enable_nodejs_http_modules` compatibility flag during tests as this feature is needed to support the Vitest runner.
[vpw:debug] Adding `enable_nodejs_perf_hooks_module` compatibility flag during tests as this feature is needed to support the Vitest runner.
[vpw:info] Starting isolated runtimes for vitest.config.integration.ts...
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/index.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/rrule.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/dateutil.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/helpers.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/weekday.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterresult.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/callbackiterresult.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/nlp/index.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/nlp/totext.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/nlp/i18n.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/nlp/parsetext.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/types.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/parseoptions.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/datetime.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/parsestring.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/optionstostring.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/datewithzone.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/cache.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iter/index.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterinfo/index.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterinfo/yearinfo.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/masks.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterinfo/monthinfo.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterinfo/easter.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iter/poslist.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/rruleset.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/iterset.js" points to missing source files
Sourcemap for "/Users/slichti/GitHub/studio-platform-dev/node_modules/rrule/dist/esm/rrulestr.js" points to missing source files
stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should create and retrieve a quiz with questions
<-- POST /quizzes

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should create and retrieve a quiz with questions
[AUTH] POST http://localhost/quizzes - Auth: None
[AUTH] POST http://localhost/quizzes - Auth: None
[TenantMiddleware DEBUG] Path: /quizzes, Host: localhost, Header ID: quiz_tenant, Header Slug: undefined

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should create and retrieve a quiz with questions
[DEBUG] TenantMiddleware: User admin_user found: NO
[DEBUG] isPlatformAdmin resolved to: false

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should create and retrieve a quiz with questions
[TenantMiddleware DEBUG] Path: /quizzes, Host: localhost, Header ID: quiz_tenant, Header Slug: undefined

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should create and retrieve a quiz with questions
[DEBUG] TenantMiddleware: User admin_user found: NO
[DEBUG] isPlatformAdmin resolved to: false

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should create and retrieve a quiz with questions
--> POST /quizzes [33m403[0m 17ms

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should create and retrieve a quiz with questions
{"timestamp":"2026-02-19T13:59:17.952Z","level":"info","message":"Request completed: POST /quizzes","traceId":"2c1b7960-40ee-44e4-ac26-1be693e6a5f3","environment":"test","userId":"admin_user","tenantId":"quiz_tenant","status":403,"durationMs":19}

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should calculate score and pass/fail for a submission
<-- POST /quizzes/q_test_1/submit

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should calculate score and pass/fail for a submission
[AUTH] POST http://localhost/quizzes/q_test_1/submit - Auth: None
[TenantMiddleware DEBUG] Path: /quizzes/q_test_1/submit, Host: localhost, Header ID: quiz_tenant, Header Slug: undefined

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should calculate score and pass/fail for a submission
[DEBUG] TenantMiddleware: User student_1 found: YES
[DEBUG] User Role: user, isPlatformAdmin: false
[DEBUG] isPlatformAdmin resolved to: false

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should calculate score and pass/fail for a submission
--> POST /quizzes/q_test_1/submit [32m200[0m 10ms

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should calculate score and pass/fail for a submission
{"timestamp":"2026-02-19T13:59:17.979Z","level":"info","message":"Request completed: POST /quizzes/q_test_1/submit","traceId":"dd4bd734-ac34-4cfd-903b-9446a0eb5993","environment":"test","userId":"student_1","tenantId":"quiz_tenant","status":200,"durationMs":10}

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should return quizzes within a Course collection
<-- GET /classes/c_course_1/recording

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should return quizzes within a Course collection
[TenantMiddleware DEBUG] Path: /classes/c_course_1/recording, Host: localhost, Header ID: quiz_tenant, Header Slug: undefined

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should return quizzes within a Course collection
[DEBUG] TenantMiddleware: User student_1 found: YES
[DEBUG] User Role: user, isPlatformAdmin: false
[DEBUG] isPlatformAdmin resolved to: false

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should return quizzes within a Course collection
--> GET /classes/c_course_1/recording [32m200[0m 11ms

stdout | test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should return quizzes within a Course collection
{"timestamp":"2026-02-19T13:59:18.003Z","level":"info","message":"Request completed: GET /classes/c_course_1/recording","traceId":"e140ed4c-fe6f-4b8c-807c-952fb3a6d414","environment":"test","userId":"student_1","tenantId":"quiz_tenant","status":200,"durationMs":11}

 â¯ test/integration/quizzes.integration.test.ts (3 tests | 1 failed) 139ms
   Ã— Course Quiz System (Integration) > should create and retrieve a quiz with questions 44ms
     â†’ expected 403 to be 200 // Object.is equality
   âœ“ Course Quiz System (Integration) > should calculate score and pass/fail for a submission 21ms
   âœ“ Course Quiz System (Integration) > should return quizzes within a Course collection 23ms

â¯â¯â¯â¯â¯â¯â¯ Failed Tests 1 â¯â¯â¯â¯â¯â¯â¯

 FAIL  test/integration/quizzes.integration.test.ts > Course Quiz System (Integration) > should create and retrieve a quiz with questions
AssertionError: expected 403 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 403

 â¯ test/integration/quizzes.integration.test.ts:58:28
     56| 
     57|         const data = await res.json() as any;
     58|         expect(res.status).toBe(200);
       |                            ^
     59|         expect(data.id).toBeDefined();
     60| 

â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯


 Test Files  1 failed (1)
      Tests  1 failed | 2 passed (3)
   Start at  08:59:12
   Duration  5.22s (transform 878ms, setup 29ms, collect 3.60s, tests 139ms, environment 0ms, prepare 270ms)

[vpw:debug] Shutting down runtimes...
npm error Lifecycle script `test:integration` failed with error:
npm error code 1
npm error path /Users/slichti/GitHub/studio-platform-dev/packages/api
npm error workspace api@0.0.0
npm error location /Users/slichti/GitHub/studio-platform-dev/packages/api
npm error command failed
npm error command sh -c vitest --config vitest.config.integration.ts test/integration/quizzes.integration.test.ts --run
