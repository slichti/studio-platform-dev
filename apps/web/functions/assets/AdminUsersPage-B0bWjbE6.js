import{jsxs as n,jsx as e,Fragment as ee}from"react/jsx-runtime";import{useLoaderData as te,useSearchParams as re,useSubmit as ne,Form as se,Link as ie}from"react-router";import{useState as c,useMemo as ae,useEffect as le}from"react";import{useAuth as oe}from"@clerk/react-router";import{B as g,I as S,D as E,j as I,k as P,l as j,m as ce,X as L,L as $,g as M,a as A}from"./server-build-DYgJutU4.js";import"react-router-dom";import"isbot";import"react-dom/server";import"@clerk/react-router/server";import"@tanstack/react-query";import"sonner";import"isomorphic-dompurify";import"lucide-react";import"fuse.js";import"clsx";import"tailwind-merge";import"date-fns";import"@headlessui/react";import"class-variance-authority";/* empty css                    */import"react-error-boundary";import"react-easy-crop";import"recharts";import"@stripe/stripe-js";import"@stripe/react-stripe-js";import"react-qr-code";function Me(){const{users:s,tenants:x}=te(),[h,O]=re(),u=ne(),{getToken:p,userId:b}=oe(),[a,z]=c(new Set),[y,G]=c(!1),[T,J]=c(new Set),[f,d]=c({isOpen:!1,type:"success",message:""}),[H,C]=c(!1),[l,w]=c({firstName:"",lastName:"",email:"",isPlatformAdmin:!1,initialTenantId:"",initialRole:"student"}),[N,k]=c(null),[v,D]=c(null),[W,B]=c(!1),m=Array.isArray(s)?s:[],F=ae(()=>{if(!y)return null;const t={};return t.platform_admins={tenant:{id:"platform_admins",name:"Platform Administrators"},users:[]},m.forEach(r=>{r.isPlatformAdmin&&t.platform_admins.users.push(r),r.memberships&&r.memberships.length>0?r.memberships.forEach(i=>{const o=i.tenant.id;t[o]||(t[o]={tenant:i.tenant,users:[]});const Z=i.roles?.[0]?.role||i.role||"member";t[o].users.push({...r,contextRole:Z})}):(t.unassigned||(t.unassigned={tenant:{id:"unassigned",name:"Unassigned / Global"},users:[]}),t.unassigned.users.push(r))}),t.platform_admins.users.length===0&&delete t.platform_admins,t},[m,y]),V=t=>{t.preventDefault();const i=new FormData(t.currentTarget).get("search");O(o=>(i?o.set("search",i):o.delete("search"),o))},q=()=>{a.size===m.length?z(new Set):z(new Set(m.map(t=>t.id)))},_=t=>{const r=new Set(a);r.has(t)?r.delete(t):r.add(t),z(r)},X=t=>{const r=new Set(T);r.has(t)?r.delete(t):r.add(t),J(r)},U=async(t,r)=>{if(a.size!==0)try{const i=await p(),o=await A("/admin/users/bulk",i,{method:"PATCH",body:JSON.stringify({userIds:Array.from(a),action:t,value:r})});if(o.error)throw new Error(o.error);d({isOpen:!0,type:"success",title:"Execution Complete",message:`Successfully updated ${a.size} users.`}),z(new Set),u(h)}catch(i){d({isOpen:!0,type:"error",title:"Error",message:i.message})}},K=async()=>{if(!(!l.email||!l.firstName||!l.lastName))try{const t=await p(),r=await A("/admin/users",t,{method:"POST",body:JSON.stringify(l)});if(r.error)throw new Error(r.error);d({isOpen:!0,type:"success",title:"User Created",message:"User created successfully."}),C(!1),w({firstName:"",lastName:"",email:"",isPlatformAdmin:!1,initialTenantId:"",initialRole:"student"}),u(h)}catch(t){d({isOpen:!0,type:"error",title:"Creation Failed",message:t.message})}},Q=async()=>{if(N)try{const t=await p(),r=await A("/admin/impersonate",t,{method:"POST",body:JSON.stringify({targetUserId:N})});if(r.error)throw new Error(r.error);if(r.token){document.cookie=`__impersonate_token=${r.token}; path=/; max-age=3600; samesite=lax; secure`;const i=m.find(o=>o.id===N);i&&i.memberships&&i.memberships.length>0?window.location.href=`/studio/${i.memberships[0].tenant.slug}`:window.location.href="/dashboard"}}catch(t){d({isOpen:!0,type:"error",title:"Impersonation Failed",message:t.message})}finally{k(null)}},Y=async()=>{if(v)try{const t=await p(),r=await A(`/admin/users/${v.id}`,t,{method:"DELETE"});if(r.error)throw new Error(r.error);u(h),d({isOpen:!0,type:"success",title:"User Deleted",message:`User ${v.email} has been deleted.`})}catch(t){d({isOpen:!0,type:"error",title:"Deletion Failed",message:t.message})}finally{D(null)}};return n("div",{className:"space-y-6",children:[n("div",{className:"flex items-center justify-between",children:[n("div",{children:[e("h1",{className:"text-2xl font-bold text-zinc-900 dark:text-zinc-100",children:"Global User Directory"}),e("p",{className:"text-zinc-500 dark:text-zinc-400",children:"Manage all users across the platform."})]}),n(g,{onClick:()=>C(!0),className:"flex items-center gap-2",children:[e(me,{})," Add User"]})]}),n("div",{className:"flex flex-col sm:flex-row gap-4 justify-between bg-white dark:bg-zinc-900 p-4 rounded-lg border border-zinc-200 dark:border-zinc-800 shadow-sm",children:[n(se,{onSubmit:V,className:"relative w-full sm:w-96",children:[e(S,{name:"search",defaultValue:h.get("search")||"",placeholder:"Search users...",className:"pl-10"}),e(he,{className:"absolute left-3 top-2.5 h-5 w-5 text-zinc-400"})]}),e("div",{className:"flex items-center gap-3",children:n("label",{className:"flex items-center gap-2 text-sm text-zinc-600 dark:text-zinc-300 font-medium cursor-pointer",children:[e("input",{type:"checkbox",checked:y,onChange:t=>G(t.target.checked),className:"rounded border-zinc-300 dark:border-zinc-600 text-zinc-900 focus:ring-zinc-900 dark:bg-zinc-700 h-4 w-4"}),"Group by Tenant"]})})]}),a.size>0&&n("div",{className:"fixed bottom-6 left-1/2 -translate-x-1/2 bg-zinc-900 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-6 z-50 animate-in slide-in-from-bottom-4",children:[n("span",{className:"font-medium",children:[a.size," users selected"]}),e("div",{className:"h-4 w-px bg-zinc-700"}),n("div",{className:"flex gap-2",children:[e("button",{onClick:()=>U("set_role","owner"),className:"hover:text-zinc-300 text-sm font-medium",children:"Make Owner"}),e("button",{onClick:()=>U("set_role","admin"),className:"hover:text-zinc-300 text-sm font-medium",children:"Make Admin"}),e("button",{onClick:()=>U("set_role","user"),className:"hover:text-zinc-300 text-sm font-medium",children:"Demote"}),e("div",{className:"w-px h-4 bg-zinc-700 mx-2"}),e("button",{onClick:()=>B(!0),className:"text-red-400 hover:text-red-300 text-sm font-medium",children:"Delete Selected"})]})]}),n("div",{className:"bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 overflow-hidden shadow-sm",children:[n("div",{className:"grid grid-cols-12 gap-4 p-4 border-b border-zinc-100 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/50 text-xs font-medium text-zinc-500 dark:text-zinc-400 uppercase items-center",children:[e("div",{className:"col-span-1 flex items-center justify-center",children:e("input",{type:"checkbox",onChange:q,checked:a.size===m.length&&m.length>0,className:"rounded border-zinc-300 dark:border-zinc-600 dark:bg-zinc-800 h-4 w-4"})}),e("div",{className:"col-span-3",children:"User"}),e("div",{className:"col-span-3",children:"Email"}),e("div",{className:"col-span-2",children:"Role"}),e("div",{className:"col-span-2",children:"Joined"}),e("div",{className:"col-span-1",children:"MFA"}),e("div",{className:"col-span-1 text-right",children:"Actions"})]}),y&&F?Object.entries(F).map(([t,r])=>n("div",{className:"border-b border-zinc-100 dark:border-zinc-800 last:border-0",children:[n("div",{className:"p-3 bg-zinc-50/50 dark:bg-zinc-900/50 flex items-center gap-2 cursor-pointer",onClick:()=>X(t),children:[e("span",{className:"text-zinc-400",children:T.has(t)?"▼":"▶"}),e("span",{className:"font-semibold text-zinc-700 dark:text-zinc-300 text-sm",children:r.tenant.name}),e("span",{className:"text-xs text-zinc-400 bg-white dark:bg-zinc-800 border px-1.5 py-0.5 rounded-full",children:r.users.length})]}),T.has(t)&&r.users.map(i=>e(R,{user:i,selected:a.has(i.id),toggle:()=>_(i.id),currentUserId:b,contextRole:i.contextRole,onImpersonate:()=>k(i.id),onDelete:()=>D(i)},`${i.id}-${t}`))]},t)):m.map(t=>e(R,{user:t,selected:a.has(t.id),toggle:()=>_(t.id),currentUserId:b,onImpersonate:()=>k(t.id),onDelete:()=>D(t)},t.id))]}),e(E,{open:H,onOpenChange:C,children:n(I,{children:[n(P,{children:[e(j,{children:"Add New User"}),e(ce,{children:"Create a new user profile manually."})]}),n("div",{className:"space-y-4 py-4",children:[n("div",{className:"grid grid-cols-2 gap-4",children:[n("div",{children:[e(L,{children:"First Name"}),e(S,{value:l.firstName,onChange:t=>w({...l,firstName:t.target.value}),placeholder:"Jane"})]}),n("div",{children:[e(L,{children:"Last Name"}),e(S,{value:l.lastName,onChange:t=>w({...l,lastName:t.target.value}),placeholder:"Doe"})]})]}),n("div",{children:[e(L,{children:"Email Address"}),e(S,{type:"email",value:l.email,onChange:t=>w({...l,email:t.target.value}),placeholder:"jane@example.com"})]}),n("label",{className:"flex items-center gap-2 text-sm text-zinc-700 dark:text-zinc-300 cursor-pointer",children:[e("input",{type:"checkbox",checked:l.isPlatformAdmin,onChange:t=>w({...l,isPlatformAdmin:t.target.checked}),className:"rounded border-zinc-300"}),"Platform Administrator"]})]}),n($,{children:[e(g,{variant:"outline",onClick:()=>C(!1),children:"Cancel"}),e(g,{onClick:K,disabled:!l.email||!l.firstName,children:"Create User"})]})]})}),e(E,{open:f.isOpen,onOpenChange:t=>d({...f,isOpen:t}),children:n(I,{children:[e(P,{children:e(j,{className:f.type==="error"?"text-red-500":"text-green-500",children:f.title||"Status"})}),e("div",{className:"py-4 text-zinc-600 dark:text-zinc-300",children:f.message}),e($,{children:e(g,{onClick:()=>d({...f,isOpen:!1}),children:"Close"})})]})}),e(M,{open:!!v,onOpenChange:t=>!t&&D(null),onConfirm:Y,title:"Delete User",description:n(ee,{children:["Are you sure you want to delete ",e("strong",{children:v?.email}),"?"]}),confirmText:"Delete",variant:"destructive"}),e(M,{open:W,onOpenChange:B,onConfirm:()=>U("delete",!0),title:"Delete Multiple Users",description:`Delete ${a.size} users?`,confirmText:"Delete Users",variant:"destructive"}),e(E,{open:!!N,onOpenChange:t=>!t&&k(null),children:n(I,{children:[e(P,{children:e(j,{children:"Confirm Impersonation"})}),e("div",{className:"py-4 text-zinc-600 dark:text-zinc-300",children:n("p",{children:["Sign in as ",e("strong",{children:m.find(t=>t.id===N)?.email}),"?"]})}),n($,{children:[e(g,{variant:"outline",onClick:()=>k(null),children:"Cancel"}),e(g,{onClick:Q,children:"Sign In as User"})]})]})})]})}function R({user:s,selected:x,toggle:h,currentUserId:O,contextRole:u,onImpersonate:p,onDelete:b}){let a=`${s.profile?.firstName||""} ${s.profile?.lastName||""}`.trim()||s.email;return n("div",{className:`grid grid-cols-12 gap-4 p-4 border-b border-zinc-100 dark:border-zinc-800 items-center hover:bg-zinc-50 dark:hover:bg-zinc-800/30 transition-colors ${x?"bg-blue-50/50":""}`,children:[e("div",{className:"col-span-1 flex justify-center",children:e("input",{type:"checkbox",className:"rounded border-zinc-300",checked:x,onChange:h})}),n("div",{className:"col-span-3 font-medium text-zinc-900 dark:text-zinc-100 flex items-center gap-3",children:[e("div",{className:"w-8 h-8 rounded-full bg-zinc-200 dark:bg-zinc-700 flex items-center justify-center text-xs font-bold overflow-hidden shrink-0",children:s.profile?.portraitUrl?e("img",{src:s.profile.portraitUrl,alt:"",className:"w-full h-full object-cover"}):a[0]||"U"}),n("div",{className:"truncate",children:[e("div",{className:"truncate",children:a}),u&&e("div",{className:"text-xs text-zinc-400 capitalize",children:u})]})]}),e("div",{className:"col-span-3 text-zinc-600 dark:text-zinc-400 text-sm truncate",children:s.email}),e("div",{className:"col-span-2",children:e("span",{className:`px-2 py-0.5 rounded text-xs font-bold ${s.role==="owner"?"bg-amber-100 text-amber-800":s.role==="admin"||s.isPlatformAdmin?"bg-purple-100 text-purple-800":"text-zinc-400"}`,children:s.role||"User"})}),e("div",{className:"col-span-2 text-zinc-400 text-xs",children:e(de,{date:s.createdAt})}),e("div",{className:"col-span-1",children:s.mfaEnabled&&e("span",{className:"bg-green-50 text-green-700 px-2 py-1 rounded-full text-xs font-medium",children:"MFA"})}),e("div",{className:"col-span-1",children:n("div",{className:"flex gap-3 justify-end items-center",children:[p&&!s.isPlatformAdmin&&e("button",{onClick:p,className:"text-zinc-500",children:e(pe,{})}),b&&s.id!==O&&e("button",{onClick:b,className:"text-red-400",children:e(ue,{})}),e(ie,{to:`/admin/users/${s.id}`,className:"text-blue-600 font-medium text-sm",children:"Edit"})]})})]})}function de({date:s}){const[x,h]=c(null);return le(()=>{h(s?new Date(s).toLocaleDateString():"Never")},[s]),e("span",{children:x||"..."})}const me=()=>n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),he=({className:s})=>e("svg",{className:s,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})}),pe=()=>n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),e("circle",{cx:"12",cy:"7",r:"4"})]}),ue=()=>n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e("polyline",{points:"3 6 5 6 21 6"}),e("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]});export{Me as default};
