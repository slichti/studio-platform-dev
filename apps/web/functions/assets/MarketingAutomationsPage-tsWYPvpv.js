import{jsxs as i,jsx as e}from"react/jsx-runtime";import{useLoaderData as K,useSubmit as Q}from"react-router";import{useState as a,useEffect as W}from"react";import{Zap as w,Plus as ee,Users as U,Calendar as te,Target as ne,Clock as X,Bell as ie,X as J,Trash2 as L,Pencil as le,Pause as ae,Play as se,Loader2 as re,Sparkles as oe}from"lucide-react";import{g as ce}from"./server-build-DYgJutU4.js";import"react-router-dom";import"isbot";import"react-dom/server";import"@clerk/react-router";import"@clerk/react-router/server";import"@tanstack/react-query";import"sonner";import"isomorphic-dompurify";import"fuse.js";import"clsx";import"tailwind-merge";import"date-fns";import"@headlessui/react";import"class-variance-authority";/* empty css                    */import"react-error-boundary";import"react-easy-crop";import"recharts";import"@stripe/stripe-js";import"@stripe/react-stripe-js";import"react-qr-code";const Y=[{id:"new_member",label:"New Member Signs Up",icon:U},{id:"class_booked",label:"Class Booked",icon:te},{id:"class_missed",label:"Class No-Show",icon:ne},{id:"inactive_days",label:"Inactive for X Days",icon:X},{id:"birthday",label:"Member Birthday",icon:ie},{id:"membership_expiring",label:"Membership Expiring",icon:X},{id:"product_purchase",label:"Product Purchased",icon:w},{id:"subscription_canceled",label:"Subscription Canceled (Period End)",icon:J},{id:"subscription_terminated",label:"Subscription Terminated",icon:L},{id:"student_updated",label:"Student Profile Updated",icon:U}],de=[{id:"immediate",label:"Immediately"},{id:"delay",label:"Delay (Hours)"},{id:"before",label:"Before Event (Hours)"}];function Fe(){const{automations:N,stats:d}=K(),l=Q(),[s,m]=a(!1),[p,u]=a(null),[c,h]=a(null),b=n=>{l({intent:"toggle",id:n},{method:"post"})},y=n=>{u(n)},C=()=>{p&&(l({intent:"delete",id:p},{method:"post"}),u(null))},f=()=>{h(null),m(!0)},g=n=>{h(n),m(!0)};return i("div",{className:"flex flex-col h-full bg-zinc-50",children:[e("header",{className:"bg-white border-b border-zinc-200 px-6 py-4",children:i("div",{className:"flex items-center justify-between",children:[i("div",{className:"flex items-center gap-3",children:[e("div",{className:"p-2 bg-gradient-to-br from-violet-500 to-purple-600 rounded-lg text-white",children:e(w,{size:20})}),i("div",{children:[e("h1",{className:"text-xl font-bold text-zinc-900",children:"Automations"}),e("p",{className:"text-sm text-zinc-500",children:"Set up automated email & SMS campaigns"})]})]}),i("button",{onClick:f,className:"px-4 py-2 bg-zinc-900 text-white rounded-lg text-sm font-medium hover:bg-zinc-800 flex items-center gap-2",children:[e(ee,{size:16})," Create Automation"]})]})}),i("div",{className:"flex-1 overflow-y-auto p-6",children:[d&&i("div",{className:"grid grid-cols-4 gap-4 mb-6",children:[i("div",{className:"bg-white rounded-lg border border-zinc-200 p-4",children:[e("div",{className:"text-2xl font-bold text-zinc-900",children:d.totalAutomations||0}),e("div",{className:"text-xs text-zinc-500",children:"Total Automations"})]}),i("div",{className:"bg-white rounded-lg border border-zinc-200 p-4",children:[e("div",{className:"text-2xl font-bold text-green-600",children:d.activeCount||0}),e("div",{className:"text-xs text-zinc-500",children:"Active"})]}),i("div",{className:"bg-white rounded-lg border border-zinc-200 p-4",children:[e("div",{className:"text-2xl font-bold text-blue-600",children:d.emailsSent||0}),e("div",{className:"text-xs text-zinc-500",children:"Emails Sent (30d)"})]}),i("div",{className:"bg-white rounded-lg border border-zinc-200 p-4",children:[e("div",{className:"text-2xl font-bold text-purple-600",children:d.smsSent||0}),e("div",{className:"text-xs text-zinc-500",children:"SMS Sent (30d)"})]})]}),N.length===0?i("div",{className:"text-center py-20 bg-white rounded-xl border border-zinc-200",children:[e(w,{size:48,className:"mx-auto mb-4 text-zinc-300"}),e("p",{className:"text-zinc-500 mb-4",children:"No automations yet"}),e("button",{onClick:f,className:"text-sm text-zinc-900 underline",children:"Create your first"})]}):e("div",{className:"space-y-4",children:N.map(n=>{const r=Y.find(x=>x.id===n.triggerEvent||x.id===n.trigger),o=r?.icon||w;return e("div",{className:`bg-white rounded-xl border ${n.isActive?"border-green-200":"border-zinc-200"} p-5`,children:i("div",{className:"flex items-start justify-between",children:[i("div",{className:"flex items-start gap-4",children:[e("div",{className:`p-3 rounded-xl ${n.isActive?"bg-green-100":"bg-zinc-100"}`,children:e(o,{size:24,className:n.isActive?"text-green-600":"text-zinc-400"})}),i("div",{children:[i("div",{className:"flex items-center gap-2",children:[e("h3",{className:"font-bold text-zinc-900",children:n.name||n.subject}),e("span",{className:`px-2 py-0.5 rounded-full text-xs font-medium ${n.isActive?"bg-green-100 text-green-700":"bg-zinc-100 text-zinc-500"}`,children:n.isActive?"Active":"Paused"})]}),i("p",{className:"text-sm text-zinc-500 mt-1",children:["Trigger: ",r?.label||n.triggerEvent]}),n.timingType!=="immediate"&&i("p",{className:"text-xs text-zinc-400 mt-1",children:["Timing: ",n.timingType==="delay"?`Delay ${n.timingValue}h`:`Before ${n.timingValue}h`]}),e("div",{className:"flex items-center gap-4 mt-2 text-xs text-zinc-400",children:i("span",{children:["Runs: ",n.runCount||0]})})]})]}),i("div",{className:"flex items-center gap-2",children:[e("button",{onClick:()=>g(n),className:"p-2 hover:bg-zinc-100 rounded-lg text-zinc-500",children:e(le,{size:16})}),e("button",{onClick:()=>b(n.id),className:`p-2 rounded-lg ${n.isActive?"hover:bg-yellow-50 text-yellow-600":"hover:bg-green-50 text-green-600"}`,children:n.isActive?e(ae,{size:16}):e(se,{size:16})}),e("button",{onClick:()=>y(n.id),className:"p-2 hover:bg-red-50 rounded-lg text-red-500",children:e(L,{size:16})})]})]})},n.id)})})]}),s&&e(me,{initialData:c,onClose:()=>m(!1),onSave:n=>{const r=new FormData;r.append("intent",c?"update":"create"),c&&r.append("id",c.id);for(const o of Object.keys(n))typeof n[o]=="object"?r.append(o,JSON.stringify(n[o])):r.append(o,n[o]);l(r,{method:"post"}),m(!1)}}),e(ce,{open:!!p,onOpenChange:n=>!n&&u(null),onConfirm:C,title:"Delete Automation",description:"Are you sure you want to delete this automation?",confirmText:"Delete",variant:"destructive"})]})}function me({onClose:N,onSave:d,initialData:l}){const[s,m]=a(1),[p,u]=a(""),[c,h]=a("new_student"),[b,y]=a("immediate"),[C,f]=a("0"),[g,n]=a("all"),[r,o]=a(""),[x,I]=a(""),[A,M]=a(!1),[E,P]=a("percent"),[V,_]=a("10"),[$,B]=a("7"),[z,v]=a("simple"),[S,T]=a(""),[G,k]=a(""),[F,O]=a(""),[H,R]=a(!1),Z=async()=>{R(!0);try{const t=await window.Clerk?.session?.getToken(),D=window.location.pathname.split("/")[2],j=await(await fetch("https://studio-platform-api.slichti.workers.dev/marketing/automations/ai/generate",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`,"X-Tenant-Slug":D},body:JSON.stringify({trigger:c})})).json();j.success&&(T(j.subject),k(j.content),v("simple"))}finally{R(!1)}};W(()=>{l&&(u(l.name||l.subject||""),h(l.triggerEvent||"new_student"),y(l.timingType||"immediate"),f(String(l.timingValue||0)),l.audienceFilter&&(n("filter"),o(String(l.audienceFilter.ageMin||"")),I(String(l.audienceFilter.ageMax||""))),l.couponConfig&&(M(!0),P(l.couponConfig.type||"percent"),_(String(l.couponConfig.value||10)),B(String(l.couponConfig.validityDays||7))),l.templateId?(v("template"),O(l.templateId)):(v("simple"),k(l.content||"")),T(l.subject||""))},[l]);const q=()=>{const t={name:p,trigger:c,timingType:b,timingValue:parseInt(C)||0,isActive:!0};g==="filter"&&(t.audienceFilter={ageMin:parseInt(r),ageMax:parseInt(x)}),A&&(t.couponConfig={type:E,value:parseInt(V),validityDays:parseInt($)}),z==="template"?(t.templateId=F,t.subject=S||"Notification"):(t.subject=S,t.content=G),d(t)};return e("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",children:i("div",{className:"bg-white rounded-xl shadow-xl max-w-lg w-full",children:[i("div",{className:"p-4 border-b flex justify-between items-center text-zinc-900 dark:text-zinc-100",children:[e("h2",{className:"text-lg font-bold",children:l?"Edit Automation":"Create Automation"}),e("button",{onClick:N,children:e(J,{size:20})})]}),i("div",{className:"p-6",children:[e("div",{className:"flex gap-2 mb-6",children:[1,2,3,4].map(t=>e("div",{className:`h-1 flex-1 rounded-full ${t<=s?"bg-purple-600":"bg-zinc-100"}`},t))}),s===1&&i("div",{className:"space-y-4",children:[e("input",{value:p,onChange:t=>u(t.target.value),className:"w-full px-3 py-2 border rounded-lg",placeholder:"Automation Name"}),e("div",{className:"grid grid-cols-2 gap-2 h-48 overflow-y-auto",children:Y.map(t=>i("button",{onClick:()=>h(t.id),className:`p-3 rounded-lg border text-left flex items-center gap-2 ${c===t.id?"border-purple-500 bg-purple-50":"hover:bg-zinc-50"}`,children:[e(t.icon,{size:16})," ",e("span",{className:"text-sm",children:t.label})]},t.id))}),e("select",{value:b,onChange:t=>y(t.target.value),className:"w-full p-2 border rounded-lg",children:de.map(t=>e("option",{value:t.id,children:t.label},t.id))}),b!=="immediate"&&e("input",{type:"number",value:C,onChange:t=>f(t.target.value),className:"w-full p-2 border rounded-lg",placeholder:"Hours"})]}),s===2&&i("div",{className:"space-y-4",children:[i("label",{className:"flex items-center gap-2",children:[e("input",{type:"radio",checked:g==="all",onChange:()=>n("all")})," All Members"]}),i("label",{className:"flex items-center gap-2",children:[e("input",{type:"radio",checked:g==="filter",onChange:()=>n("filter")})," Filtered"]}),g==="filter"&&i("div",{className:"flex gap-2",children:[e("input",{value:r,onChange:t=>o(t.target.value),placeholder:"Min Age",className:"p-2 border rounded flex-1"}),e("input",{value:x,onChange:t=>I(t.target.value),placeholder:"Max Age",className:"p-2 border rounded flex-1"})]})]}),s===3&&i("div",{className:"space-y-4",children:[i("label",{className:"flex items-center gap-2 cursor-pointer",children:[e("input",{type:"checkbox",checked:A,onChange:t=>M(t.target.checked)})," Add Coupon"]}),A&&i("div",{className:"space-y-2",children:[i("select",{value:E,onChange:t=>P(t.target.value),className:"w-full p-2 border rounded",children:[e("option",{value:"percent",children:"Percentage"}),e("option",{value:"amount",children:"Amount"})]}),e("input",{value:V,onChange:t=>_(t.target.value),placeholder:"Value",className:"w-full p-2 border rounded"}),e("input",{value:$,onChange:t=>B(t.target.value),placeholder:"Validity (Days)",className:"w-full p-2 border rounded"})]})]}),s===4&&i("div",{className:"space-y-4",children:[i("button",{onClick:Z,disabled:H,className:"w-full py-2 bg-purple-600 text-white rounded gap-2 flex items-center justify-center",children:[H?e(re,{className:"animate-spin"}):e(oe,{size:16})," AI Generate"]}),e("input",{value:S,onChange:t=>T(t.target.value),className:"w-full p-2 border rounded",placeholder:"Subject"}),i("div",{className:"flex gap-2",children:[e("button",{onClick:()=>v("simple"),className:`flex-1 p-2 ${z==="simple"?"bg-zinc-100 font-bold":""}`,children:"Simple"}),e("button",{onClick:()=>v("template"),className:`flex-1 p-2 ${z==="template"?"bg-zinc-100 font-bold":""}`,children:"Template"})]}),z==="simple"?e("textarea",{value:G,onChange:t=>k(t.target.value),className:"w-full h-32 p-2 border rounded"}):e("input",{value:F,onChange:t=>O(t.target.value),className:"w-full p-2 border rounded",placeholder:"Template ID"})]})]}),i("div",{className:"p-4 border-t flex justify-between",children:[s>1&&e("button",{onClick:()=>m(s-1),className:"p-2",children:"Back"}),e("button",{onClick:s<4?()=>m(s+1):q,className:"ml-auto px-6 py-2 bg-zinc-900 text-white rounded",children:s<4?"Next":"Save"})]})]})})}export{Fe as default};
