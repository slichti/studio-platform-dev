import{jsxs as n,jsx as e}from"react/jsx-runtime";import{useOutletContext as G}from"react-router";import{useState as r,useEffect as A}from"react";import{useAuth as K}from"@clerk/react-router";import{E as Q,p as V,C as W,a as o}from"./server-build-tAMGW7nt.js";import"react-router-dom";import"isbot";import"react-dom/server";import"@clerk/react-router/server";import"@tanstack/react-query";import"sonner";import"isomorphic-dompurify";import"lucide-react";import"fuse.js";import"clsx";import"tailwind-merge";import"date-fns";import"@headlessui/react";import"class-variance-authority";/* empty css                    */import"react-error-boundary";import"react-easy-crop";import"recharts";import"@stripe/stripe-js";import"@stripe/react-stripe-js";import"react-qr-code";function ve(){const{tenant:l,roles:T}=G(),u=T.includes("owner"),I=()=>{const t="https://studio-platform-api.slichti.workers.dev";window.location.href=`${t}/studios/stripe/connect?tenantId=${l.id}`},{getToken:d}=K(),[x,j]=r(null),[k,E]=r([]),[v,L]=r(null),[b,m]=r({isOpen:!1,message:""}),[g,z]=r({isOpen:!1,message:""}),[p,y]=r(null);A(()=>{if(!l.stripeAccountId||!u)return;(async()=>{const a=await d(),s="https://studio-platform-api.slichti.workers.dev";o(`${s}/commerce/stats`,a).then(i=>{i&&j(i)}),o(`${s}/commerce/transactions`,a).then(i=>{i&&i.transactions&&E(i.transactions)}),o(`${s}/commerce/balance`,a).then(i=>{i&&!i.error&&L(i)})})()},[l.id,u,d]);const[h,w]=r("overview"),[f,C]=r([]),[R,O]=r(null);A(()=>{h==="failed"&&u&&(async()=>{const a=await d(),i=await o("https://studio-platform-api.slichti.workers.dev/failed-payments",a);i?.payments&&C(i.payments)})()},[h,u,d]);const M=async()=>{if(p){O(p);try{const t=await d(),s=await o(`https://studio-platform-api.slichti.workers.dev/failed-payments/${p}/retry`,t,{method:"POST"});s.success?(z({isOpen:!0,message:`Payment successful! (Status: ${s.status})`}),C(i=>i.filter(Y=>Y.id!==p))):m({isOpen:!0,message:s.error||"Retry failed"})}catch{m({isOpen:!0,message:"Error processing retry"})}finally{O(null),y(null)}}},[c,B]=r(null),[q,N]=r(!1),[S,D]=r(""),[$,U]=r(""),[F,P]=r(!1),H=t=>{B(t),D((t.amount/100).toFixed(2)),N(!0)},J=async()=>{if(c){P(!0);try{const t=await d();let a="pos";c.description?.includes("Pack")&&(a="pack"),c.description?.includes("Membership")&&(a="membership");const s=await o("https://studio-platform-api.slichti.workers.dev/refunds",t,{method:"POST",body:JSON.stringify({amount:Math.round(parseFloat(S)*100),reason:$,referenceId:c.id,type:c.type||a})});s&&!s.error?(z({isOpen:!0,message:"Refund processed successfully"}),N(!1)):m({isOpen:!0,message:s?.error||"Refund failed"})}catch(t){m({isOpen:!0,message:t.message||"Refund failed"})}finally{P(!1)}}};return n("div",{className:"max-w-4xl text-zinc-900 dark:text-zinc-100",children:[e(Q,{isOpen:b.isOpen,onClose:()=>m({...b,isOpen:!1}),message:b.message}),e(V,{isOpen:g.isOpen,onClose:()=>z({...g,isOpen:!1}),message:g.message}),e(W,{isOpen:!!p,onClose:()=>y(null),onConfirm:M,title:"Retry Payment",message:"Attempt to charge the customer's payment method now?",confirmText:"Charge Now"}),n("div",{className:"flex items-center justify-between mb-6",children:[e("h1",{className:"text-2xl font-bold",children:"Finances"}),n("div",{className:"flex bg-zinc-100 dark:bg-zinc-800 p-1 rounded-lg",children:[e("button",{onClick:()=>w("overview"),className:`px-4 py-1.5 text-sm font-medium rounded-md transition ${h==="overview"?"bg-white dark:bg-black shadow-sm text-zinc-900 dark:text-zinc-100":"text-zinc-500 hover:text-zinc-700"}`,children:"Overview"}),n("button",{onClick:()=>w("failed"),className:`px-4 py-1.5 text-sm font-medium rounded-md transition flex items-center gap-2 ${h==="failed"?"bg-white dark:bg-black shadow-sm text-zinc-900 dark:text-zinc-100":"text-zinc-500 hover:text-zinc-700"}`,children:["Failed Payments",f.length>0&&e("span",{className:"w-5 h-5 flex items-center justify-center bg-red-100 text-red-600 text-xs rounded-full",children:f.length})]})]})]}),q&&e("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 overflow-y-auto",children:n("div",{className:"bg-white dark:bg-zinc-900 rounded-xl shadow-xl border border-zinc-200 dark:border-zinc-800 w-full max-w-md p-6 animate-in fade-in zoom-in duration-200",children:[e("h3",{className:"text-lg font-bold mb-4",children:"Process Refund"}),n("p",{className:"text-sm text-zinc-500 mb-6",children:["Refund for ",c?.description," on ",new Date(c?.date).toLocaleDateString()]}),n("div",{className:"space-y-4",children:[n("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Amount ($)"}),e("input",{type:"number",value:S,onChange:t=>D(t.target.value),className:"w-full bg-zinc-50 dark:bg-zinc-800 border-none rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-200 dark:focus:ring-zinc-700"})]}),n("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Reason"}),e("textarea",{value:$,onChange:t=>U(t.target.value),placeholder:"Customer requested...",className:"w-full bg-zinc-50 dark:bg-zinc-800 border-none rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-200 dark:focus:ring-zinc-700"})]})]}),n("div",{className:"flex gap-3 mt-6 justify-end",children:[e("button",{onClick:()=>N(!1),className:"px-4 py-2 text-zinc-600 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-md",children:"Cancel"}),e("button",{onClick:J,disabled:F,className:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50",children:F?"Processing...":"Confirm Refund"})]})]})}),h==="failed"?e("div",{className:"space-y-6",children:n("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg overflow-hidden",children:[n("div",{className:"p-4 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/50",children:[e("h3",{className:"font-semibold",children:"Failed Subscription Payments"}),e("p",{className:"text-sm text-zinc-500",children:"Subscriptions currently suspended due to payment failure."})]}),f.length===0?e("div",{className:"p-12 text-center text-zinc-500",children:e("p",{children:"No failed payments found. All subscriptions are healthy."})}):n("table",{className:"min-w-full text-sm",children:[e("thead",{children:n("tr",{className:"border-b border-zinc-200 dark:border-zinc-800",children:[e("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Customer"}),e("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Plan"}),e("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Status"}),e("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Date"}),e("th",{className:"text-right px-4 py-3 font-medium text-zinc-500",children:"Action"})]})}),e("tbody",{children:f.map(t=>n("tr",{className:"border-b last:border-0 border-zinc-200 dark:border-zinc-800",children:[n("td",{className:"px-4 py-3",children:[e("div",{className:"font-medium text-zinc-900 dark:text-zinc-100",children:t.member?.user?.name||"Unknown"}),e("div",{className:"text-xs text-zinc-500",children:t.member?.user?.email})]}),e("td",{className:"px-4 py-3 text-zinc-600",children:t.planId}),e("td",{className:"px-4 py-3",children:e("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${t.dunningState==="failed"?"bg-red-100 text-red-800":"bg-amber-100 text-amber-800"}`,children:t.dunningState?.toUpperCase()})}),e("td",{className:"px-4 py-3 text-zinc-500",children:t.lastDunningAt?new Date(t.lastDunningAt).toLocaleDateString():"-"}),e("td",{className:"px-4 py-3 text-right",children:e("button",{onClick:()=>y(t.id),disabled:R===t.id,className:"text-xs bg-zinc-900 text-white px-3 py-1.5 rounded hover:bg-zinc-800 disabled:opacity-50",children:R===t.id?"Retrying...":"Retry Payment"})})]},t.id))})]})]})}):l.stripeAccountId?n("div",{className:"space-y-6",children:[n("div",{className:"bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-800 flex items-center justify-between",children:[n("div",{className:"flex items-center gap-3",children:[e("div",{className:"w-8 h-8 rounded-full bg-green-100 dark:bg-green-800 flex items-center justify-center text-green-600 dark:text-green-300",children:"âœ“"}),n("div",{children:[e("h3",{className:"font-semibold text-green-800 dark:text-green-300",children:"Stripe Connected"}),e("p",{className:"text-sm text-green-600 dark:text-green-400",children:"Your account is ready to process payments."})]})]}),e("div",{className:"text-sm font-mono text-zinc-500 dark:text-zinc-400",children:l.stripeAccountId})]}),n("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[n("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-lg shadow-sm",children:[e("div",{className:"text-sm font-medium mb-1 text-zinc-500 dark:text-zinc-400",children:"Total Revenue"}),n("div",{className:"text-3xl font-bold",children:["$",x?(x.totalRevenue/100).toFixed(2):"0.00"]})]}),n("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-lg shadow-sm",children:[e("div",{className:"text-sm font-medium mb-1 text-zinc-500 dark:text-zinc-400",children:"Monthly Recurring"}),n("div",{className:"text-3xl font-bold",children:["$",x?(x.mrr/100).toFixed(2):"0.00"]})]}),n("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-lg shadow-sm",children:[e("div",{className:"text-sm font-medium mb-1 text-zinc-500 dark:text-zinc-400",children:"Stripe Balance"}),n("div",{className:"text-3xl font-bold",children:["$",v?(v.available/100).toFixed(2):"0.00"]})]})]}),n("div",{className:"p-4 rounded-lg bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800",children:[e("h3",{className:"font-semibold mb-4 text-zinc-900 dark:text-zinc-100",children:"Transaction History"}),k.length===0?e("p",{className:"text-sm text-zinc-500 dark:text-zinc-400",children:"No recent transactions."}):n("table",{className:"min-w-full text-sm",children:[e("thead",{children:n("tr",{className:"border-b border-zinc-200 dark:border-zinc-700",children:[e("th",{className:"text-left py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Date"}),e("th",{className:"text-left py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Description"}),e("th",{className:"text-left py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Customer"}),e("th",{className:"text-right py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Amount"}),e("th",{className:"text-right py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Actions"})]})}),e("tbody",{children:k.map(t=>n("tr",{className:"border-b last:border-0 border-zinc-200 dark:border-zinc-700",children:[e("td",{className:"py-2 text-zinc-600 dark:text-zinc-400",children:new Date(t.date).toLocaleDateString()}),e("td",{className:"py-2 text-zinc-600 dark:text-zinc-400",children:t.description}),e("td",{className:"py-2 text-zinc-600 dark:text-zinc-400",children:t.customer}),n("td",{className:"py-2 text-right text-zinc-900 dark:text-zinc-100",children:["$",(t.amount/100).toFixed(2)]}),e("td",{className:"py-2 text-right",children:e("button",{onClick:()=>H(t),className:"text-xs text-red-600 hover:text-red-700 hover:underline",children:"Refund"})})]},t.id))})]})]})]}):n("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-8 rounded-lg shadow-sm text-center",children:[e("div",{className:"mb-4 text-4xl",children:"ðŸ’³"}),e("h2",{className:"text-xl font-bold mb-2",children:"Setup Payouts"}),e("p",{className:"mb-6 max-w-md mx-auto text-zinc-500 dark:text-zinc-400",children:"Connect with Stripe to start accepting payments for class packs and memberships. Funds will be deposited directly to your bank account."}),e("button",{onClick:I,className:"bg-[#635BFF] text-white px-6 py-2.5 rounded-md font-medium hover:bg-[#534be0] transition-colors inline-flex items-center gap-2",children:e("span",{children:"Connect with Stripe"})})]})]})}export{ve as default};
