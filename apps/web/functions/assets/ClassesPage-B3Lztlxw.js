import{jsxs as i,jsx as a,Fragment as $}from"react/jsx-runtime";import{useParams as F,useOutletContext as _,useSearchParams as H}from"react-router";import{useState as l}from"react";import{Plus as G,Calendar as Y,Clock as Z,Users as ee,Video as ae,ArchiveRestore as te,Archive as se}from"lucide-react";import{toast as n}from"sonner";import{useQueryClient as ie}from"@tanstack/react-query";import{useAuth as re}from"@clerk/react-router";import{Q as ne,R as oe,B as d,t as ce,e as B,f as O,h,N as x,U as le,V as de,W as me,C as P,a as c}from"./server-build-tAMGW7nt.js";import"react-router-dom";import"isbot";import"react-dom/server";import"@clerk/react-router/server";import"isomorphic-dompurify";import"fuse.js";import"clsx";import"tailwind-merge";import"date-fns";import"@headlessui/react";import"class-variance-authority";/* empty css                    */import"react-error-boundary";import"react-easy-crop";import"recharts";import"@stripe/stripe-js";import"@stripe/react-stripe-js";import"react-qr-code";function Me(){const{slug:r}=F(),{roles:C,tenant:D,me:E,member:j}=_()||{},{getToken:m}=re(),u=ie(),[N,I]=H(),g=C?.includes("owner")||C?.includes("instructor"),w=N.get("includeArchived")==="true",{data:Q=[],isLoading:q,error:ue}=ne(r,{status:w?"all":"active"}),{data:p}=oe(r),z=p?.family||[],[f,L]=l({locations:[],instructors:[],plans:[]});l(()=>{if(!g)return;(async()=>{const t=await m();if(t)try{const[e,W,U]=await Promise.all([c("/locations",t,{headers:{"X-Tenant-Slug":r}}).catch(()=>({locations:[]})),c("/members?role=instructor",t,{headers:{"X-Tenant-Slug":r}}).catch(()=>({members:[]})),c("/memberships/plans",t,{headers:{"X-Tenant-Slug":r}}).catch(()=>[])]);L({locations:e.locations||[],instructors:W.members||[],plans:U||[]})}catch(e){console.error("Metadata fetch error",e)}})()});const[S,A]=l(null),[M,v]=l(!1),[o,b]=l(null),[y,k]=l(null),T=Q.reduce((s,t)=>{const e=new Date(t.startTime).toLocaleDateString(void 0,{weekday:"long",month:"long",day:"numeric"});return s[e]||(s[e]=[]),s[e].push(t),s},{}),R=()=>{u.invalidateQueries({queryKey:["classes",r]}),v(!1)},X=async()=>{if(!o)return;const{id:s,archive:t}=o;try{const e=await m();await c(`/classes/${s}`,e,{method:"PATCH",headers:{"X-Tenant-Slug":r},body:JSON.stringify({status:t?"archived":"active"})}),u.invalidateQueries({queryKey:["classes",r]}),n.success(t?"Class archived":"Class restored")}catch{n.error("Failed to update class status")}finally{b(null)}},V=async()=>{if(y)try{const s=await m();await c(`/bookings/${y.bookingId}`,s,{method:"DELETE",headers:{"X-Tenant-Slug":r}}),u.invalidateQueries({queryKey:["classes",r]}),n.success("Booking cancelled")}catch(s){n.error(s.message||"Failed to cancel")}finally{k(null)}},J=async s=>{try{const t=await m();await c(`/waitlist/${s.id}/join`,t,{method:"POST",headers:{"X-Tenant-Slug":r},body:JSON.stringify({})}),u.invalidateQueries({queryKey:["classes",r]}),n.success("Joined waitlist")}catch(t){n.error(t.message)}},K=async s=>{try{const t=await m();await c("/bookings",t,{method:"POST",headers:{"X-Tenant-Slug":r},body:JSON.stringify({classId:s.id,attendanceType:"in_person"})}),u.invalidateQueries({queryKey:["classes",r]}),n.success("Class booked!")}catch(t){n.error(t.message)}};return i("div",{className:"space-y-6",children:[i("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[i("div",{children:[a("h1",{className:"text-2xl font-bold tracking-tight text-zinc-900 dark:text-zinc-50",children:"Class Schedule"}),a("p",{className:"text-zinc-500 dark:text-zinc-400",children:"View and book upcoming classes."})]}),a("div",{className:"flex items-center gap-2",children:g&&i($,{children:[i("label",{className:"flex items-center gap-1.5 text-sm cursor-pointer mr-2 select-none",children:[a("input",{type:"checkbox",className:"rounded border-zinc-300 dark:border-zinc-700 dark:bg-zinc-800",checked:w,onChange:s=>{const t=new URLSearchParams(N);s.target.checked?t.set("includeArchived","true"):t.delete("includeArchived"),I(t)}}),a("span",{className:"text-zinc-600 dark:text-zinc-400",children:"Show Archived"})]}),i(d,{onClick:()=>v(!0),children:[a(G,{className:"h-4 w-4 mr-2"})," Create Class"]})]})})]}),a(ce,{children:a("div",{className:"space-y-8",children:q?Array.from({length:3}).map((s,t)=>a(B,{className:"opacity-50",children:a(O,{className:"p-6 h-24 animate-pulse bg-zinc-100 dark:bg-zinc-800",children:a("div",{})})},t)):Object.keys(T).length===0?a("div",{className:"p-12 text-center text-zinc-500 dark:text-zinc-400 bg-zinc-50 dark:bg-zinc-900/50 border border-dashed border-zinc-300 dark:border-zinc-700 rounded-lg",children:"No upcoming classes scheduled."}):Object.entries(T).map(([s,t])=>i("div",{className:"space-y-4",children:[a("div",{className:"sticky top-0 bg-white/95 dark:bg-zinc-950/95 py-2 z-10 backdrop-blur border-b border-zinc-100 dark:border-zinc-900",children:i("h3",{className:"text-lg font-semibold flex items-center gap-2",children:[a(Y,{className:"h-5 w-5 text-zinc-400 ml-1"}),s]})}),a("div",{className:"grid grid-cols-1 gap-4",children:t.map(e=>a(B,{className:x("transition-all hover:shadow-md",e.status==="archived"&&"opacity-60 bg-zinc-50 dark:bg-zinc-900/50"),children:i(O,{className:"p-4 sm:p-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[i("div",{className:"space-y-2 flex-1",children:[i("div",{className:"flex items-center gap-2",children:[a("span",{className:"font-bold text-lg",children:e.title}),e.status==="archived"&&a(h,{variant:"secondary",className:"text-xs",children:"Archived"}),e.userBookingStatus==="confirmed"&&a(h,{variant:"success",className:"text-xs",children:"Booked"}),e.userBookingStatus==="waitlisted"&&a(h,{variant:"warning",className:"text-xs",children:"Waitlisted"})]}),i("div",{className:"flex flex-wrap gap-x-6 gap-y-2 text-sm text-zinc-500 dark:text-zinc-400",children:[i("div",{className:"flex items-center gap-1.5",children:[a(Z,{className:"h-4 w-4"}),new Date(e.startTime).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a("span",{className:"text-zinc-300 dark:text-zinc-700",children:"â€¢"}),e.durationMinutes," min"]}),e.instructor?.user?.profile&&i("div",{className:"flex items-center gap-1.5",children:[a(ee,{className:"h-4 w-4"}),"with ",e.instructor.user.profile.firstName]}),e.zoomEnabled&&i("div",{className:"flex items-center gap-1.5 text-blue-600 dark:text-blue-400",children:[a(ae,{className:"h-4 w-4"}),"Virtual Option"]})]}),e.capacity&&i("div",{className:"flex gap-2 pt-1",children:[i(h,{variant:"outline",className:x("font-normal",(e.inPersonCount||0)>=e.capacity?"text-red-600 border-red-200 bg-red-50 dark:bg-red-900/10 dark:border-red-900/30":""),children:["In-Person: ",e.inPersonCount||0," / ",e.capacity]}),e.zoomEnabled&&i(h,{variant:"outline",className:"font-normal text-blue-600 border-blue-200 bg-blue-50 dark:bg-blue-900/10 dark:border-blue-900/30",children:["Virtual: ",e.virtualCount||0]})]})]}),i("div",{className:"flex items-center gap-3 shrink-0",children:[g&&a(d,{variant:"ghost",size:"icon",onClick:()=>b({id:e.id,archive:e.status!=="archived"}),title:e.status==="archived"?"Restore Class":"Archive Class",children:e.status==="archived"?a(te,{className:"h-4 w-4"}):a(se,{className:"h-4 w-4"})}),e.status!=="archived"&&(E?e.userBookingStatus==="confirmed"?a("div",{className:"flex flex-col items-end gap-2",children:a(d,{variant:"destructive",size:"sm",onClick:()=>k({bookingId:e.userBooking.id,classId:e.id}),children:"Cancel"})}):e.userBookingStatus==="waitlisted"?a(d,{variant:"secondary",disabled:!0,size:"sm",children:"On Waitlist"}):(e.inPersonCount||0)>=(e.capacity||1/0)&&!e.zoomEnabled?a(d,{variant:"secondary",onClick:()=>J(e),children:"Join Waitlist"}):a(d,{onClick:()=>z.length>0||e.zoomEnabled?A(e):K(e),children:"Book Class"}):a("a",{href:"/sign-in",className:x(le({variant:"outline"})),children:"Login to Book"}))]})]})},e.id))})]},s))})}),a(de,{isOpen:M,onClose:()=>v(!1),onSuccess:R,tenantId:D?.id,locations:f.locations,instructors:f.instructors,plans:f.plans}),a(me,{isOpen:!!S,onClose:()=>A(null),classEvent:S,family:z,member:p?.profile?.id?{id:p.profile.id,...p.profile}:j}),a(P,{isOpen:!!o,onClose:()=>b(null),onConfirm:X,title:o?.archive?"Archive Class":"Restore Class",message:`Are you sure you want to ${o?.archive?"archive":"unarchive"} this class?`,confirmText:o?.archive?"Archive":"Restore",isDestructive:o?.archive}),a(P,{isOpen:!!y,onClose:()=>k(null),onConfirm:V,title:"Cancel Booking",message:"Are you sure you want to cancel this booking?",confirmText:"Cancel Booking",isDestructive:!0})]})}export{Me as default};
