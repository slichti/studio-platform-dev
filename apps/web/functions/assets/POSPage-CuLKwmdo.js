import{jsxs as r,jsx as t}from"react/jsx-runtime";import{useState as i,useEffect as O}from"react";import{useOutletContext as he}from"react-router";import{a as p}from"./server-build-DYgJutU4.js";import{Wifi as D,Plus as Q,Edit as be,Archive as fe,X as J,User as xe,Search as ge,Trash2 as ye,ShoppingCart as ze,CreditCard as Ne,Loader2 as we}from"lucide-react";import{loadStripeTerminal as ve}from"@stripe/terminal-js";import"react-router-dom";import"isbot";import"react-dom/server";import"@clerk/react-router";import"@clerk/react-router/server";import"@tanstack/react-query";import"sonner";import"isomorphic-dompurify";import"fuse.js";import"clsx";import"tailwind-merge";import"date-fns";import"@headlessui/react";import"class-variance-authority";/* empty css                    */import"react-error-boundary";import"react-easy-crop";import"recharts";import"@stripe/stripe-js";import"@stripe/react-stripe-js";import"react-qr-code";function Ze(){const{tenant:h,token:a}=he()||{},[x,b]=i([]),[s,d]=i([]),[v,f]=i(!0),[o,u]=i(!1),[g,te]=i(null),[y,z]=i("disconnected"),[U,re]=i([]),[V,L]=i(null),[ne,k]=i(!1),[ie,C]=i(!1),[G,W]=i(null),[ae,X]=i(0),[l,S]=i(null),[_,$]=i(!1),[N,B]=i(""),[se,H]=i([]),[ce,K]=i(!1),[le,q]=i(!1),[w,A]=i(""),[oe,P]=i(0),[Y,R]=i(""),[j,T]=i(null);O(()=>{de()},[ae,h]);const de=async()=>{try{const e=await p("/pos/products",a);e.products&&b(e.products.filter(n=>n.isActive))}catch(e){console.error(e)}finally{f(!1)}};O(()=>{if(!h)return;(async()=>{const n=await ve();if(!n)return;const m=n.create({onFetchConnectionToken:async()=>{const c=await p("/pos/connection-token",a,{method:"POST"});if(c.error)throw new Error(c.error);return c.secret},onUnexpectedReaderDisconnect:()=>{z("disconnected"),L(null)}});te(m)})()},[h]);const ue=async e=>{z("connecting");try{const n=await g.connectReader(e);n.reader?(L(n.reader),z("connected"),k(!1)):(console.error("Connect failed",n.error),z("disconnected"))}catch(n){console.error("Connect error",n),z("disconnected")}},me=e=>{d(n=>n.find(c=>c.productId===e.id)?n.map(c=>c.productId===e.id?{...c,quantity:c.quantity+1}:c):[...n,{productId:e.id,name:e.name,price:e.price,quantity:1}])},pe=e=>{d(n=>n.filter(m=>m.productId!==e))},F=s.reduce((e,n)=>e+n.price*n.quantity,0),Z=Math.max(0,F-oe),ee=async()=>{if(w){u(!0),R("");try{const e=await p("/pos/validate-coupon",a,{method:"POST",body:JSON.stringify({code:w,cartTotal:F})});e.valid?(P(e.discountAmount),T({code:w,id:e.couponId}),R("")):(R(e.error||"Invalid coupon"),P(0),T(null))}catch(e){R(e.message)}finally{u(!1)}}};O(()=>{s.length===0?(P(0),T(null),A("")):j&&ee()},[s.length]);const I=async e=>{if(s.length!==0){u(!0);try{if(e==="terminal"){if(y!=="connected"||!V){alert("Please connect a reader first."),u(!1),k(!0);return}const n=await p("/pos/process-payment",a,{method:"POST",body:JSON.stringify({items:s,customerId:l?.stripeCustomerId})});if(n.error)throw new Error(n.error);const m=n.clientSecret,c=await g.collectPaymentMethod(m);if(c.error)throw new Error(c.error.message);const M=await g.processPayment(c.paymentIntent);if(M.error)throw new Error(M.error.message);await E("card",M.paymentIntent.id,l?.id)}else e==="card"?await E("card","manual_entry",l?.id):await E("cash",null,l?.id);d([]),S(null),alert("Order Completed!"),X(n=>n+1)}catch(n){console.error(n),alert(`Checkout Failed: ${n.message}`)}finally{u(!1)}}},E=async(e,n,m)=>{await p("/pos/orders",a,{method:"POST",body:JSON.stringify({items:s,memberId:m||null,paymentMethod:e,totalAmount:Z,couponCode:j?.code})})};return O(()=>{if(!N||N.length<2){H([]);return}const e=setTimeout(async()=>{K(!0);try{const n=await p(`/pos/customers?query=${N}`,a);H(n.customers||[])}catch(n){console.error(n)}finally{K(!1)}},500);return()=>clearTimeout(e)},[N]),r("div",{className:"flex h-full",children:[r("div",{className:"flex-1 p-6 overflow-y-auto bg-zinc-50 dark:bg-zinc-950",children:[r("div",{className:"flex justify-between items-center mb-6",children:[r("div",{children:[t("h1",{className:"text-2xl font-bold text-zinc-900 dark:text-zinc-100",children:"POS & Retail"}),t("p",{className:"text-sm text-zinc-500",children:"Manage inventory and process sales."})]}),r("div",{className:"flex gap-2",children:[r("button",{onClick:()=>k(!0),className:`flex items-center gap-2 px-3 py-2 rounded-lg border text-sm transition-colors ${y==="connected"?"bg-green-50 text-green-700 border-green-200":"bg-white text-zinc-700 border-zinc-200"}`,children:[t(D,{size:16}),y==="connected"?V?.label||"Reader Connected":"Connect Reader"]}),r("button",{onClick:()=>{W(null),C(!0)},className:"flex items-center gap-2 px-3 py-2 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 rounded-lg text-sm hover:opacity-90",children:[t(Q,{size:16})," Add Product"]})]})]}),t("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:x.map(e=>r("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 flex flex-col gap-3 shadow-sm hover:shadow-md transition-shadow group relative",children:[t("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1",children:t("button",{onClick:()=>{W(e),C(!0)},className:"p-1.5 bg-zinc-100 rounded text-zinc-600 hover:text-blue-600",children:t(be,{size:14})})}),t("div",{className:"aspect-square bg-zinc-100 dark:bg-zinc-800 rounded-lg flex items-center justify-center text-zinc-300",children:e.imageUrl?t("img",{src:e.imageUrl,className:"w-full h-full object-cover rounded-lg"}):t(fe,{size:32})}),r("div",{children:[r("div",{className:"flex justify-between items-start",children:[t("h3",{className:"font-medium text-zinc-900 dark:text-zinc-100 truncate",children:e.name}),r("span",{className:"text-xs font-bold bg-zinc-100 dark:bg-zinc-800 px-1.5 py-0.5 rounded text-zinc-600",children:["$",(e.price/100).toFixed(2)]})]}),t("p",{className:"text-xs text-zinc-500 truncate",children:e.category||"General"})]}),r("div",{className:"mt-auto pt-2 flex items-center justify-between",children:[r("span",{className:`text-xs ${e.stockQuantity>0?"text-green-600":"text-red-500"} font-medium`,children:[e.stockQuantity," in stock"]}),t("button",{onClick:()=>me(e),disabled:e.stockQuantity<=0,className:"p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed",children:t(Q,{size:16})})]})]},e.id))})]}),r("div",{className:"w-96 bg-white dark:bg-zinc-900 border-l border-zinc-200 dark:border-zinc-800 flex flex-col z-10 shadow-xl",children:[t("div",{className:"p-4 border-b border-zinc-100 dark:border-zinc-800",children:l?r("div",{className:"flex justify-between items-center bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800",children:[r("div",{className:"flex items-center gap-3",children:[t("div",{className:"w-8 h-8 rounded-full bg-blue-200 text-blue-700 flex items-center justify-center text-xs font-bold",children:l.profile?.firstName?.[0]||l.name?.[0]||"C"}),r("div",{children:[t("div",{className:"text-sm font-medium text-blue-900 dark:text-blue-100",children:l.profile?`${l.profile.firstName} ${l.profile.lastName}`:l.name}),t("div",{className:"text-[10px] text-blue-600 dark:text-blue-300 truncate w-32",children:l.email})]})]}),t("button",{onClick:()=>S(null),className:"text-blue-400 hover:text-blue-600",children:t(J,{size:14})})]}):r("div",{className:"relative",children:[r("button",{onClick:()=>$(!_),className:"w-full flex items-center justify-between px-3 py-2 bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg text-sm text-zinc-500 hover:border-blue-400 transition-colors",children:[r("span",{className:"flex items-center gap-2",children:[t(xe,{size:14})," Add Customer to Sale"]}),t(Q,{size:14})]}),_&&r("div",{className:"absolute top-12 left-0 right-0 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg shadow-lg p-2 z-20",children:[r("div",{className:"flex items-center gap-2 px-2 py-1 bg-zinc-50 rounded border border-zinc-100 mb-2",children:[t(ge,{size:14,className:"text-zinc-400"}),t("input",{autoFocus:!0,className:"bg-transparent text-sm w-full outline-none",placeholder:"Search name or email...",value:N,onChange:e=>B(e.target.value)})]}),r("div",{className:"max-h-48 overflow-y-auto space-y-1",children:[ce&&t("div",{className:"text-xs text-center p-2 text-zinc-400",children:"Searching..."}),se.map(e=>r("button",{onClick:()=>{S(e),$(!1),B("")},className:"w-full text-left p-2 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded text-sm group",children:[t("div",{className:"font-medium",children:e.profile?`${e.profile.firstName} ${e.profile.lastName}`:e.name}),t("div",{className:"text-xs text-zinc-500",children:e.email})]},e.id||e.stripeCustomerId)),t("button",{onClick:()=>{q(!0),$(!1)},className:"w-full text-left p-2 border-t border-zinc-100 text-blue-600 text-xs font-medium hover:bg-blue-50 rounded mt-1",children:"+ Create New Customer"})]})]})]})}),r("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[s.map((e,n)=>r("div",{className:"flex justify-between items-center group",children:[r("div",{children:[t("div",{className:"text-sm font-medium text-zinc-900 dark:text-zinc-100",children:e.name}),r("div",{className:"text-xs text-zinc-500",children:["$",(e.price/100).toFixed(2)," x ",e.quantity]})]}),r("div",{className:"flex items-center gap-3",children:[r("div",{className:"font-medium text-sm",children:["$",(e.price*e.quantity/100).toFixed(2)]}),t("button",{onClick:()=>pe(e.productId),className:"text-zinc-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",children:t(ye,{size:14})})]})]},n)),s.length===0&&r("div",{className:"h-full flex flex-col items-center justify-center text-zinc-400 space-y-2 opacity-50",children:[t(ze,{size:32}),t("span",{className:"text-sm",children:"Cart is empty"})]})]}),r("div",{className:"p-4 border-t border-zinc-200 dark:border-zinc-800 bg-zinc-50/50 space-y-3",children:[r("div",{className:"flex gap-2",children:[t("input",{className:"flex-1 px-3 py-2 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg text-sm uppercase font-mono",placeholder:"PROMO CODE",value:w,onChange:e=>A(e.target.value.toUpperCase()),disabled:!!j}),j?t("button",{onClick:()=>{T(null),P(0),A("")},className:"px-3 py-2 bg-red-100 text-red-600 rounded-lg text-sm font-medium hover:bg-red-200",children:"Remove"}):t("button",{onClick:ee,disabled:!w||s.length===0,className:"px-3 py-2 bg-zinc-900 dark:bg-zinc-700 text-white rounded-lg text-sm font-medium hover:opacity-90 disabled:opacity-50",children:"Apply"})]}),Y&&t("div",{className:"text-xs text-red-500 font-medium",children:Y}),r("div",{className:"flex justify-between items-center text-sm text-zinc-500",children:[t("span",{children:"Subtotal"}),r("span",{children:["$",(F/100).toFixed(2)]})]}),r("div",{className:"flex justify-between items-center text-lg font-bold text-zinc-900 dark:text-zinc-100",children:[t("span",{children:"Total"}),r("span",{children:["$",(Z/100).toFixed(2)]})]}),r("div",{className:"grid grid-cols-2 gap-2",children:[r("button",{disabled:o||s.length===0,onClick:()=>I("card"),className:"bg-white border border-zinc-200 text-zinc-700 py-3 rounded-lg font-medium hover:bg-zinc-50 flex items-center justify-center gap-2 disabled:opacity-50",children:[t(Ne,{size:16})," Manual Card"]}),t("button",{disabled:o||s.length===0,onClick:()=>I("cash"),className:"bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 disabled:opacity-50",children:"Cash"})]}),r("button",{disabled:o||s.length===0,onClick:()=>I("terminal"),className:`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition-all ${y==="connected"?"bg-blue-600 hover:bg-blue-700 text-white shadow-blue-200 dark:shadow-blue-900/20":"bg-zinc-200 text-zinc-500 cursor-not-allowed"}`,children:[o?t(we,{className:"animate-spin"}):t(D,{size:20}),y==="connected"?"Charge Application":"Connect Reader to Charge"]})]})]}),ie&&t("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:r("div",{className:"bg-white dark:bg-zinc-900 w-full max-w-md rounded-2xl p-6 space-y-4",children:[r("div",{className:"flex justify-between items-center text-zinc-900 dark:text-zinc-100",children:[t("h2",{className:"text-lg font-bold",children:G?"Edit Product":"New Product"}),t("button",{onClick:()=>C(!1),children:t(J,{size:20})})]}),t(ke,{token:a,product:G,onSuccess:()=>{C(!1),X(e=>e+1)}})]})}),ne&&t("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:r("div",{className:"bg-white dark:bg-zinc-900 w-full max-w-lg rounded-2xl p-6 space-y-6",children:[r("div",{className:"flex justify-between items-center text-zinc-900 dark:text-zinc-100",children:[r("h2",{className:"text-xl font-bold flex items-center gap-2",children:[t(D,{})," Connect Reader"]}),t("button",{onClick:()=>k(!1),children:t(J,{size:20})})]}),t("div",{className:"space-y-4",children:U.length===0?t("button",{onClick:async()=>{u(!0);const e=await g.discoverReaders({discoveryMethod:"internet",simulated:!1}).catch(()=>({}));e.discoveredReaders&&re(e.discoveredReaders),u(!1)},className:"w-full py-3 bg-blue-600 text-white rounded-lg",children:o?"Scanning...":"Scan for Readers"}):U.map((e,n)=>r("button",{onClick:()=>ue(e),className:"w-full p-4 border rounded-lg text-left",children:[t("div",{className:"font-bold",children:e.label||e.serialNumber}),t("div",{className:"text-xs",children:e.deviceType})]},n))})]})}),le&&t("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:r("div",{className:"bg-white dark:bg-zinc-900 w-full max-w-md rounded-2xl p-6",children:[t("h2",{className:"text-lg font-bold mb-4 text-zinc-900 dark:text-zinc-100",children:"Create New Customer"}),t(Ce,{token:a,onSuccess:e=>{S(e),q(!1)},onCancel:()=>q(!1)})]})})]})}function ke({token:h,product:a,onSuccess:x}){const[b,s]=i(!1);return r("form",{className:"space-y-4",onSubmit:async d=>{d.preventDefault(),s(!0);const v=new FormData(d.currentTarget),f=Object.fromEntries(v),o={...f,price:Math.round(parseFloat(f.price)*100),stockQuantity:parseInt(f.stockQuantity),isActive:!0},u=a?`/pos/products/${a.id}`:"/pos/products";await p(u,h,{method:a?"PUT":"POST",body:JSON.stringify(o)}),s(!1),x()},children:[t("input",{name:"name",defaultValue:a?.name,required:!0,className:"w-full p-2 border rounded dark:bg-zinc-800 dark:text-zinc-100",placeholder:"Product Name"}),r("div",{className:"grid grid-cols-2 gap-4",children:[t("input",{name:"price",type:"number",step:"0.01",defaultValue:a?a.price/100:"",required:!0,className:"w-full p-2 border rounded dark:bg-zinc-800 dark:text-zinc-100",placeholder:"Price ($)"}),t("input",{name:"stockQuantity",type:"number",defaultValue:a?.stockQuantity,required:!0,className:"w-full p-2 border rounded dark:bg-zinc-800 dark:text-zinc-100",placeholder:"Stock"})]}),t("textarea",{name:"description",defaultValue:a?.description,className:"w-full p-2 border rounded dark:bg-zinc-800 dark:text-zinc-100 h-20",placeholder:"Description"}),t("button",{disabled:b,type:"submit",className:"w-full bg-zinc-900 dark:bg-zinc-100 dark:text-zinc-900 text-white rounded p-2",children:b?"Saving...":"Save Product"})]})}function Ce({token:h,onSuccess:a,onCancel:x}){const[b,s]=i(!1);return r("form",{className:"space-y-4",onSubmit:async d=>{d.preventDefault(),s(!0);const v=new FormData(d.currentTarget),f=Object.fromEntries(v),o=await p("/pos/customers",h,{method:"POST",body:JSON.stringify(f)});s(!1),o.customer&&a(o.customer)},children:[t("input",{name:"name",required:!0,className:"w-full p-2 border rounded dark:bg-zinc-800",placeholder:"Jane Doe"}),t("input",{name:"email",type:"email",required:!0,className:"w-full p-2 border rounded dark:bg-zinc-800",placeholder:"jane@example.com"}),r("div",{className:"flex gap-2 justify-end",children:[t("button",{type:"button",onClick:x,className:"px-4 py-2 border rounded text-zinc-900 dark:text-zinc-100",children:"Cancel"}),t("button",{type:"submit",disabled:b,className:"px-4 py-2 bg-blue-600 text-white rounded",children:b?"Creating...":"Create Customer"})]})]})}export{Ze as default};
