import{jsx as e,jsxs as t,Fragment as I}from"react/jsx-runtime";import{useParams as Y,useOutletContext as W}from"react-router";import{useState as c}from"react";import{a as v,T as Z,b as _,c as M,d as D,e as A,f as ee,I as k,B as N,g as F,h as S,D as L,i as te,j as X,k as j,l as H,m as G,S as ne}from"./server-build-tAMGW7nt.js";import{DollarSign as Q,CheckCircle2 as ae,AlertCircle as re}from"lucide-react";import{format as K}from"date-fns";import{toast as g}from"sonner";import{useQuery as B,useMutation as z,useQueryClient as J}from"@tanstack/react-query";import{useAuth as P}from"@clerk/react-router";import"react-router-dom";import"isbot";import"react-dom/server";import"@clerk/react-router/server";import"isomorphic-dompurify";import"fuse.js";import"clsx";import"tailwind-merge";import"@headlessui/react";import"class-variance-authority";/* empty css                    */import"react-error-boundary";import"react-easy-crop";import"recharts";import"@stripe/stripe-js";import"@stripe/react-stripe-js";import"react-qr-code";function ie(r){const{getToken:d}=P();return B({queryKey:["payroll-history",r],queryFn:async()=>{const m=await d();return(await v("/payroll/history",m,{headers:{"X-Tenant-Slug":r}})).history||[]},enabled:!!r})}function oe(r){const{getToken:d}=P();return B({queryKey:["payroll-config",r],queryFn:async()=>{const m=await d(),p=await v("/payroll/config",m,{headers:{"X-Tenant-Slug":r}});if(p.error)throw new Error(p.error);return p.instructors||[]},enabled:!!r})}function $e(){const{slug:r}=Y(),{tenant:d}=W(),{getToken:m}=P();return r?t("div",{className:"p-8 max-w-6xl mx-auto",children:[t("div",{className:"mb-8",children:[e("h1",{className:"text-2xl font-bold text-zinc-900 dark:text-zinc-100",children:"Instructor Payroll"}),e("p",{className:"text-zinc-500 text-sm",children:"Automate calculation and tracking of payouts."})]}),t(Z,{defaultValue:"run",className:"space-y-6",children:[t(_,{children:[e(M,{value:"run",children:"Run Payroll"}),e(M,{value:"history",children:"History"}),e(M,{value:"config",children:"Configuration"})]}),e(D,{value:"run",children:e(se,{slug:r})}),e(D,{value:"history",children:e(le,{slug:r})}),e(D,{value:"config",children:e(ce,{slug:r})})]})]}):e("div",{children:"Invalid Slug"})}function se({slug:r}){const{getToken:d}=P(),[m,p]=c(K(new Date(new Date().getFullYear(),new Date().getMonth(),1),"yyyy-MM-dd")),[C,y]=c(K(new Date,"yyyy-MM-dd")),[s,u]=c(null),[f,b]=c(!1),h=z({mutationFn:async({commit:n})=>{const i=await d(),o=await v("/payroll/generate",i,{method:"POST",headers:{"X-Tenant-Slug":r},body:JSON.stringify({startDate:m,endDate:C,commit:n})});if(o.error)throw new Error(o.error);return o},onSuccess:(n,i)=>{i.commit?(g.success(`Successfully generated ${n.count} payouts.`),u(null),b(!1)):u(n.preview||[])},onError:n=>g.error(n.message)});return t(A,{children:[t(ee,{className:"p-6",children:[e("h3",{className:"text-lg font-semibold mb-4",children:"Generate Cycle"}),t("div",{className:"flex flex-col sm:flex-row gap-4 items-end mb-6",children:[t("div",{children:[e("label",{className:"block text-xs font-medium text-zinc-500 mb-1",children:"Start Date"}),e(k,{type:"date",value:m,onChange:n=>p(n.target.value),className:"w-[180px]"})]}),t("div",{children:[e("label",{className:"block text-xs font-medium text-zinc-500 mb-1",children:"End Date"}),e(k,{type:"date",value:C,onChange:n=>y(n.target.value),className:"w-[180px]"})]}),e(N,{onClick:()=>h.mutate({commit:!1}),disabled:h.isPending,children:h.isPending&&!f?"Processing...":"Preview Calculation"})]}),s&&t("div",{className:"space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-300",children:[t("div",{className:"bg-zinc-50 dark:bg-zinc-800/50 p-4 rounded-lg flex justify-between items-center border border-zinc-100 dark:border-zinc-700",children:[e("span",{className:"font-medium text-zinc-700 dark:text-zinc-300",children:"Total Calculation"}),t("span",{className:"text-xl font-bold text-green-600",children:["$",(s.reduce((n,i)=>n+i.amount,0)/100).toFixed(2)]})]}),e("div",{className:"space-y-2",children:s.map(n=>t("div",{className:"border border-zinc-200 dark:border-zinc-800 rounded p-4 flex justify-between items-start bg-white dark:bg-zinc-900",children:[t("div",{children:[t("div",{className:"font-semibold text-zinc-900 dark:text-zinc-100 flex items-center gap-2",children:["Instructor",t("span",{className:"text-xs font-normal text-zinc-500 bg-zinc-100 px-1.5 py-0.5 rounded dark:bg-zinc-800",children:[n.instructorId.substring(0,8),"..."]})]}),t("div",{className:"text-xs text-zinc-500 mt-1",children:[n.itemCount," items calculated"]}),e("ul",{className:"mt-2 text-xs text-zinc-500 space-y-1",children:n.items.map((i,o)=>t("li",{children:["â€¢ ",i.title," (",new Date(i.date).toLocaleDateString(),"): ",i.details," = ",t("strong",{children:["$",(i.amount/100).toFixed(2)]})]},o))})]}),t("div",{className:"text-lg font-bold",children:["$",(n.amount/100).toFixed(2)]})]},n.instructorId))}),s.length===0&&e("div",{className:"text-zinc-500 text-sm italic",children:"No payouts calculated for this period. Check configurations or activity logs."}),s.length>0&&e("div",{className:"flex justify-end mt-6",children:e(N,{onClick:()=>b(!0),className:"bg-green-600 hover:bg-green-700 text-white",children:"Generate & Save"})})]})]}),e(F,{open:f,onOpenChange:b,onConfirm:()=>h.mutate({commit:!0}),title:"Confirm Payroll Generation",description:"This will create payout records for the calculated amounts. These will appear in history as 'Processing' or 'Pending'.",confirmText:h.isPending?"Generating...":"Generate Records"})]})}function le({slug:r}){const{getToken:d}=P(),m=J(),{data:p=[],isLoading:C}=ie(r),[y,s]=c(null),[u,f]=c(null),b=z({mutationFn:async n=>{const i=await d(),o=await v(`/payroll/${n}/approve`,i,{method:"POST",headers:{"X-Tenant-Slug":r}});if(o.error)throw new Error(o.error);return o},onSuccess:()=>{m.invalidateQueries({queryKey:["payroll-history",r]}),s(null),g.success("Marked as paid")},onError:n=>g.error(n.message)}),h=z({mutationFn:async n=>{const i=await d(),o=await v(`/payroll/${n}/pay`,i,{method:"POST",headers:{"X-Tenant-Slug":r}});if(o.error)throw new Error(o.error);return o},onSuccess:n=>{m.invalidateQueries({queryKey:["payroll-history",r]}),f(null),g.success("Payment Successful! Transfer ID: "+n.transferId)},onError:n=>g.error(n.message)});return C?e("div",{children:"Loading history..."}):t(I,{children:[e(A,{className:"overflow-hidden border-zinc-200 dark:border-zinc-800",children:t("table",{className:"w-full text-sm text-left",children:[e("thead",{className:"bg-zinc-50 dark:bg-zinc-800 text-zinc-500 font-medium border-b border-zinc-200 dark:border-zinc-800",children:t("tr",{children:[e("th",{className:"p-4",children:"Period"}),e("th",{className:"p-4",children:"Instructor"}),e("th",{className:"p-4",children:"Amount"}),e("th",{className:"p-4",children:"Status"}),e("th",{className:"p-4",children:"Actions"})]})}),t("tbody",{className:"divide-y divide-zinc-200 dark:divide-zinc-800",children:[p.map(n=>t("tr",{children:[t("td",{className:"p-4",children:[new Date(n.periodStart).toLocaleDateString()," - ",new Date(n.periodEnd).toLocaleDateString()]}),t("td",{className:"p-4 font-medium",children:[t("div",{children:[n.instructorFirstName," ",n.instructorLastName]}),n.stripeAccountId&&e(S,{variant:"outline",className:"text-[10px] text-green-600 border-green-200 mt-1",children:"Stripe Connected"})]}),t("td",{className:"p-4 font-mono font-medium",children:["$",(n.amount/100).toFixed(2)]}),e("td",{className:"p-4",children:e(S,{variant:n.status==="paid"?"success":"warning",children:n.status.toUpperCase()})}),t("td",{className:"p-4 flex gap-2",children:[n.status!=="paid"&&t(I,{children:[e(N,{variant:"outline",size:"sm",onClick:()=>s(n.id),children:"Mark Paid"}),n.stripeAccountId&&t(N,{size:"sm",onClick:()=>f(n.id),className:"bg-green-600 hover:bg-green-700 text-white",children:[e(Q,{size:14,className:"mr-1"})," Pay Now"]})]}),n.status==="paid"&&n.paidAt&&t("span",{className:"text-xs text-zinc-400",children:["Paid ",new Date(n.paidAt).toLocaleDateString()]})]})]},n.id)),p.length===0&&e("tr",{children:e("td",{colSpan:5,className:"p-8 text-center text-zinc-500",children:"No history found."})})]})]})}),e(F,{open:!!y,onOpenChange:n=>!n&&s(null),onConfirm:()=>{y&&b.mutate(y)},title:"Mark as Paid",description:"Are you sure you want to manually mark this record as paid?",confirmText:"Mark Paid"}),e(F,{open:!!u,onOpenChange:n=>!n&&f(null),onConfirm:()=>{u&&h.mutate(u)},title:"Process Stripe Transfer",description:"This will instantly transfer funds from your platform balance to the instructor's connected Stripe account. This cannot be undone.",confirmText:h.isPending?"Processing...":"Pay Now"})]})}function ce({slug:r}){const{getToken:d}=P(),m=J(),{data:p=[],isLoading:C}=oe(r),[y,s]=c(null),[u,f]=c("flat"),[b,h]=c("0"),[n,i]=c(!1),[o,E]=c(null),[T,O]=c(""),[$,R]=c(""),q=z({mutationFn:async()=>{const a=await d();let l=parseFloat(b);l=Math.round(l*100);const x=await v("/payroll/config",a,{method:"POST",headers:{"X-Tenant-Slug":r},body:JSON.stringify({memberId:y,payModel:u,rate:l})});if(x.error)throw new Error(x.error);return x},onSuccess:()=>{m.invalidateQueries({queryKey:["payroll-config",r]}),s(null),g.success("Configuration saved")},onError:a=>g.error(a.message)}),w=z({mutationFn:async()=>{const a=await d(),l=Math.round(parseFloat(T)*100),x=await v("/payroll/transfer",a,{method:"POST",headers:{"X-Tenant-Slug":r},body:JSON.stringify({instructorId:o.memberId,amount:l,notes:$||"Manual Ad-Hoc Payout"})});if(x.error)throw new Error(x.error);return x},onSuccess:()=>{g.success("Transfer Successful"),i(!1),E(null)},onError:a=>g.error(a.message)}),U=a=>{s(a.memberId),a.config?.payModel?(f(a.config.payModel),h((a.config.rate/100).toString())):(f("flat"),h("0"))},V=a=>{E(a),O(""),R(""),i(!0)};return C?e("div",{children:"Loading config..."}):t(I,{children:[e(A,{className:"overflow-hidden border-zinc-200 dark:border-zinc-800",children:t("table",{className:"w-full text-sm text-left",children:[e("thead",{className:"bg-zinc-50 dark:bg-zinc-800 text-zinc-500 font-medium border-b border-zinc-200 dark:border-zinc-800",children:t("tr",{children:[e("th",{className:"p-4",children:"Name"}),e("th",{className:"p-4",children:"Stripe Status"}),e("th",{className:"p-4",children:"Current Model"}),e("th",{className:"p-4",children:"Rate"}),e("th",{className:"p-4",children:"Action"})]})}),e("tbody",{className:"divide-y divide-zinc-200 dark:divide-zinc-800",children:p.map(a=>t("tr",{children:[t("td",{className:"p-4 font-medium",children:[a.firstName," ",a.lastName]}),e("td",{className:"p-4",children:a.stripeAccountId?t(S,{variant:"success",className:"text-xs",children:[e(ae,{size:12,className:"mr-1"})," Connected"]}):e(S,{variant:"secondary",className:"text-xs",children:"Not Connected"})}),e("td",{className:"p-4 text-zinc-600 dark:text-zinc-400 capitalize",children:a.config?a.config.payModel:"Not Set"}),e("td",{className:"p-4 font-mono",children:a.config?a.config.payModel==="percentage"?`${a.config.rate/100}%`:`$${(a.config.rate/100).toFixed(2)}`:"-"}),t("td",{className:"p-4 flex gap-2",children:[t(L,{open:y===a.memberId,onOpenChange:l=>!l&&s(null),children:[e(te,{asChild:!0,children:e(N,{variant:"outline",size:"sm",onClick:()=>U(a),children:"Configure"})}),t(X,{children:[t(j,{children:[e(H,{children:"Configure Payroll"}),t(G,{children:["Set default pay rate for ",a.firstName,"."]})]}),t("div",{className:"space-y-4 py-4",children:[t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Pay Model"}),t(ne,{value:u,onChange:l=>f(l.target.value),className:"w-full border-zinc-300",children:[e("option",{value:"flat",children:"Flat Rate (Per Class)"}),e("option",{value:"hourly",children:"Hourly Rate"}),e("option",{value:"percentage",children:"Revenue Share (%)"})]})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:u==="percentage"?"Percentage (%)":"Rate ($)"}),e(k,{type:"number",step:"0.01",value:b,onChange:l=>h(l.target.value)})]}),e(N,{onClick:()=>q.mutate(),className:"w-full",disabled:q.isPending,children:"Save Configuration"})]})]})]}),a.stripeAccountId&&t(N,{size:"sm",onClick:()=>V(a),className:"bg-green-600 hover:bg-green-700 text-white",children:[e(Q,{size:14,className:"mr-1"})," Pay"]})]})]},a.memberId))})]})}),e(L,{open:n,onOpenChange:i,children:t(X,{children:[t(j,{children:[e(H,{children:"Manual Payout"}),t(G,{children:["Send an ad-hoc payment to ",o?.firstName,"."]})]}),t("div",{className:"space-y-4 py-4",children:[t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Amount ($)"}),t("div",{className:"relative",children:[e("span",{className:"absolute left-3 top-2 text-zinc-500",children:"$"}),e(k,{type:"number",min:"0.50",step:"0.01",value:T,onChange:a=>O(a.target.value),className:"pl-8",placeholder:"0.00"})]})]}),t("div",{children:[e("label",{className:"block text-sm font-medium mb-1",children:"Note / Reference"}),e(k,{type:"text",value:$,onChange:a=>R(a.target.value),placeholder:"e.g. Bonus for weekend workshop"})]}),t("div",{className:"bg-yellow-50 text-yellow-800 text-xs p-3 rounded flex gap-2",children:[e(re,{size:16,className:"shrink-0"}),e("p",{children:"Funds will be transferred immediately from your platform balance to the instructor's Stripe account. This cannot be undone."})]}),e(N,{onClick:()=>w.mutate(),disabled:w.isPending||!T,className:`w-full ${w.isPending?"bg-zinc-400":"bg-green-600 hover:bg-green-700"}`,children:w.isPending?"Processing...":"Transfer Funds"})]})]})})]})}export{$e as default};
