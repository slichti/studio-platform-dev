import{jsxs as s,jsx as e}from"react/jsx-runtime";import{useLoaderData as D,useNavigate as $}from"react-router";import{useState as a}from"react";import{useAuth as E}from"@clerk/react-router";import{M as L,C as x,E as J,a as u}from"./server-build-DYgJutU4.js";import"react-router-dom";import"isbot";import"react-dom/server";import"@clerk/react-router/server";import"@tanstack/react-query";import"sonner";import"isomorphic-dompurify";import"lucide-react";import"fuse.js";import"clsx";import"tailwind-merge";import"date-fns";import"@headlessui/react";import"class-variance-authority";/* empty css                    */import"react-error-boundary";import"react-easy-crop";import"recharts";import"@stripe/stripe-js";import"@stripe/react-stripe-js";import"react-qr-code";function ue(){const{user:i,tenants:v}=D(),{getToken:m}=E(),y=$(),[N,C]=a(i.isPlatformAdmin),[w,z]=a(!1),[k,S]=a(""),[d,O]=a(i.memberships||[]),[I,p]=a(!1),[r,h]=a({tenantId:"",role:"student"}),[o,l]=a({isOpen:!1,type:"success",message:""}),[f,g]=a(null),[A,b]=a(!1),M=async()=>{z(!0),S("");try{const t=await m();await u(`/admin/users/${i.id}`,t,{method:"PUT",body:JSON.stringify({isPlatformAdmin:N})}),y("/admin/users")}catch(t){S(t.message||"Failed to update user")}finally{z(!1)}},j=async()=>{if(r.tenantId)try{const t=await m();await u(`/admin/users/${i.id}/memberships`,t,{method:"POST",body:JSON.stringify(r)});const n=v.find(c=>c.id===r.tenantId);O([...d,{id:"temp",tenant:n,role:r.role}]),p(!1),h({tenantId:"",role:"student"}),l({isOpen:!0,type:"success",message:"Access granted successfully."})}catch(t){l({isOpen:!0,type:"error",message:t.message})}},T=t=>{g(t)},U=async()=>{if(!f)return;const t=f;try{const n=await m();await u(`/admin/users/${i.id}/memberships`,n,{method:"DELETE",body:JSON.stringify({tenantId:t})}),O(d.filter(c=>c.tenant.id!==t))}catch(n){l({isOpen:!0,type:"error",message:n.message})}finally{g(null)}},P=()=>{b(!0)},R=async()=>{try{const t=await m(),n=await u("/admin/impersonate",t,{method:"POST",body:JSON.stringify({targetUserId:i.id})});if(n.token)if(localStorage.setItem("impersonation_token",n.token),document.cookie=`__impersonate_token=${n.token}; path=/; max-age=3600; SameSite=Lax`,d.length>0){const c=d[0].tenant.slug;window.location.href=`/studio/${c}`}else l({isOpen:!0,type:"error",message:"User has no studio memberships to access."})}catch(t){l({isOpen:!0,type:"error",message:`Impersonation failed: ${t.message}`})}finally{b(!1)}};return s("div",{className:"max-w-4xl mx-auto space-y-8",children:[s("div",{className:"flex items-center justify-between",children:[s("div",{children:[e("button",{onClick:()=>y("/admin/users"),className:"text-sm text-zinc-500 hover:text-zinc-900 mb-2 flex items-center gap-1",children:"â† Back to Directory"}),e("h2",{className:"text-2xl font-bold",children:"Edit User"})]}),e("div",{className:"flex gap-2",children:s("button",{onClick:P,className:"px-4 py-2 border border-purple-200 bg-purple-50 text-purple-700 hover:bg-purple-100 rounded-lg transition-colors font-medium text-sm flex items-center gap-2",children:[s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),e("circle",{cx:"12",cy:"7",r:"4"})]}),"Impersonate"]})})]}),s("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-8",children:[e("div",{className:"md:col-span-2 space-y-6",children:s("div",{className:"bg-white border border-zinc-200 rounded-lg p-6 shadow-sm",children:[s("div",{className:"flex items-center gap-4 mb-6",children:[e("div",{className:"w-16 h-16 rounded-full bg-zinc-100 flex items-center justify-center text-xl font-bold text-zinc-500 overflow-hidden",children:i.profile?.portraitUrl?e("img",{src:i.profile.portraitUrl,className:"w-full h-full object-cover"}):i.profile?.firstName?.[0]||"U"}),s("div",{children:[e("div",{className:"font-semibold text-xl",children:i.email==="slichti@gmail.com"&&i.profile?.firstName==="System"&&i.profile?.lastName==="Admin"?"Steven Lichti":`${i.profile?.firstName} ${i.profile?.lastName}`}),e("div",{className:"text-zinc-500",children:i.email}),e("div",{className:"text-zinc-400 font-mono text-xs mt-1",children:i.id})]})]}),s("div",{className:"pt-6 border-t border-zinc-100",children:[e("h3",{className:"text-sm font-medium text-zinc-900 mb-4",children:"Platform Roles"}),s("label",{className:"flex items-start gap-3 cursor-pointer p-4 rounded-lg border border-zinc-200 hover:bg-zinc-50 transition-colors",children:[e("input",{type:"checkbox",checked:N,onChange:t=>C(t.target.checked),className:"mt-1 w-5 h-5 rounded border-zinc-300 text-indigo-600 focus:ring-indigo-500"}),s("div",{children:[e("div",{className:"font-medium text-zinc-900",children:"Platform Administrator"}),e("div",{className:"text-sm text-zinc-500 mt-1",children:"Grants full access to modify all tenants, users, and system settings."})]})]})]}),e("div",{className:"mt-6 flex justify-end",children:e("button",{onClick:M,disabled:w,className:"px-4 py-2 bg-zinc-900 hover:bg-zinc-800 text-white rounded-lg transition-colors font-medium text-sm disabled:opacity-50",children:w?"Saving...":"Update Profile"})}),k&&e("div",{className:"mt-4 text-red-600 text-sm text-center",children:k})]})}),e("div",{className:"md:col-span-1 space-y-6",children:s("div",{className:"bg-white border border-zinc-200 rounded-lg p-6 shadow-sm h-full",children:[s("div",{className:"flex items-center justify-between mb-4",children:[e("h3",{className:"font-semibold text-zinc-900",children:"Studio Access"}),e("button",{onClick:()=>p(!0),className:"text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded hover:bg-blue-100 font-medium",children:"+ Add"})]}),d.length===0?e("div",{className:"text-center py-8 text-zinc-500 text-sm bg-zinc-50 rounded-lg border border-dashed border-zinc-200",children:"This user does not belong to any studios."}):e("div",{className:"space-y-3",children:d.map(t=>s("div",{className:"p-3 border border-zinc-200 rounded-lg bg-zinc-50/50 flex justify-between items-center group",children:[s("div",{children:[e("div",{className:"font-medium text-sm text-zinc-900",children:t.tenant.name}),e("div",{className:"text-xs text-zinc-500 capitalize",children:t.role||t.roles?.map(n=>n.role).join(", ")||"No Role"})]}),e("button",{onClick:()=>T(t.tenant.id),className:"text-zinc-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-all p-1",title:"Remove access",children:s("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e("path",{d:"M18 6 6 18"}),e("path",{d:"m6 6 12 12"})]})})]},t.tenant.id))}),e("div",{className:"mt-4 text-xs text-zinc-400 leading-relaxed",children:"Users can have different roles (Owner, Instructor, Student) in different studios."})]})})]}),e(L,{isOpen:I,onClose:()=>p(!1),title:"Grant Studio Access",children:s("div",{className:"space-y-4",children:[s("div",{children:[e("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Select Studio"}),s("select",{className:"w-full border border-zinc-300 rounded-md p-2 text-sm",value:r.tenantId,onChange:t=>h({...r,tenantId:t.target.value}),children:[e("option",{value:"",children:"-- Select a Studio --"}),v.map(t=>s("option",{value:t.id,children:[t.name," (",t.slug,")"]},t.id))]})]}),s("div",{children:[e("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Role"}),s("select",{className:"w-full border border-zinc-300 rounded-md p-2 text-sm",value:r.role,onChange:t=>h({...r,role:t.target.value}),children:[e("option",{value:"student",children:"Student"}),e("option",{value:"instructor",children:"Instructor"}),e("option",{value:"owner",children:"Owner"})]}),s("div",{className:"mt-2 text-xs text-zinc-500 bg-zinc-50 p-2 rounded border border-zinc-200 leading-relaxed",children:[e("strong",{children:"Note:"})," Owners generally function as Instructors and Students as well. Instructors often participate as Students.",e("br",{}),e("br",{}),"This system treats roles independently, so you may assign multiple roles to a user for a single studio if needed."]})]}),s("div",{className:"pt-4 flex justify-end gap-2",children:[e("button",{onClick:()=>p(!1),className:"px-3 py-2 text-zinc-600 hover:bg-zinc-100 rounded text-sm",children:"Cancel"}),e("button",{onClick:j,disabled:!r.tenantId,className:"px-3 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded text-sm disabled:opacity-50",children:"Grant Access"})]})]})}),e(x,{isOpen:o.isOpen&&o.type==="success",onClose:()=>l({...o,isOpen:!1}),onConfirm:()=>l({...o,isOpen:!1}),title:"Success",message:o.message,confirmText:"OK",cancelText:"Close"}),e(J,{isOpen:o.isOpen&&o.type==="error",onClose:()=>l({...o,isOpen:!1}),title:"Error",message:o.message}),e(x,{isOpen:!!f,onClose:()=>g(null),onConfirm:U,title:"Remove Studio Access",message:"Are you sure you want to remove this user from the studio?",isDestructive:!0,confirmText:"Remove Access"}),e(x,{isOpen:A,onClose:()=>b(!1),onConfirm:R,title:"Impersonate User",message:`You are about to sign in as ${i.email}. This will assume their identity.`,confirmText:"Impersonate",isDestructive:!0})]})}export{ue as default};
