import{jsxs as n,jsx as e}from"react/jsx-runtime";import se,{useState as r,useEffect as B}from"react";import{useLoaderData as le,useParams as ce,useOutletContext as oe,useSearchParams as de}from"react-router";import{Gift as me,Link as ue,Plus as H,Search as pe,Ticket as xe,MoreHorizontal as be,History as V,Mail as he,Ban as ge,ChevronUp as fe,Loader2 as ze}from"lucide-react";import{toast as h}from"sonner";import{C as ke,a as g}from"./server-build-tAMGW7nt.js";import"react-router-dom";import"isbot";import"react-dom/server";import"@clerk/react-router";import"@clerk/react-router/server";import"@tanstack/react-query";import"isomorphic-dompurify";import"fuse.js";import"clsx";import"tailwind-merge";import"date-fns";import"@headlessui/react";import"class-variance-authority";/* empty css                    */import"react-error-boundary";import"react-easy-crop";import"recharts";import"@stripe/stripe-js";import"@stripe/react-stripe-js";import"react-qr-code";function Ye(){const{giftCards:U,token:p}=le(),{slug:o}=ce(),{roles:$}=oe()||{},s=$?.includes("owner")||$?.includes("instructor"),[f,q]=r(U),[w,J]=r(""),[d,m]=r(!1),[x,F]=r("list"),[Q,I]=r(!1),[Y,z]=r(!1),[y,T]=r(null),[R,A]=r([]),[_,P]=r(!1),[X,b]=r(null),[l,k]=r({amount:"",recipientEmail:"",notes:""}),[Ne,W]=r(null),[v,C]=r(null),[D,S]=r(""),[we,M]=r(!1),[a,c]=r({amount:"50",customAmount:"",isForSelf:!0,recipientEmail:"",recipientName:"",senderName:"",message:""}),G=async()=>{const t=await g("/gift-cards",p,{headers:{"X-Tenant-Slug":o}});q(t.giftCards||[])},K=async t=>{t.preventDefault(),m(!0);try{const i=await g("/gift-cards/issue",p,{method:"POST",headers:{"X-Tenant-Slug":o},body:JSON.stringify({amount:parseFloat(l.amount)*100,recipientEmail:l.recipientEmail,notes:l.notes})});if(i.error)throw new Error(i.error);W(`Card Issued: ${i.code}`),k({amount:"",recipientEmail:"",notes:""}),await G()}catch(i){h.error(i.message)}finally{m(!1)}},Z=t=>{C(t)},ee=async()=>{if(v){m(!0);try{const t=await g(`/gift-cards/${v}/resend`,p,{method:"POST",headers:{"X-Tenant-Slug":o}});if(t.error)throw new Error(t.error);h.success("Email resent successfully!")}catch(t){h.error(t.message)}finally{m(!1),C(null)}}},te=async t=>{t.preventDefault(),m(!0);try{const i=await g("/gift-cards/claim",p,{method:"POST",headers:{"X-Tenant-Slug":o},body:JSON.stringify({code:D})});if(i.error)throw new Error(i.error);S(""),M(!0),await G(),setTimeout(()=>{z(!1),M(!1)},1500)}catch(i){h.error(i.message)}finally{m(!1)}},j=async t=>{if(y===t){T(null);return}T(t),P(!0),A([]);try{const i=await g(`/gift-cards/${t}/transactions`,p,{headers:{"X-Tenant-Slug":o}});i.transactions&&A(i.transactions)}catch(i){console.error(i)}finally{P(!1)}},O=f.filter(t=>t.code.toLowerCase().includes(w.toLowerCase())||t.recipientEmail?.toLowerCase().includes(w.toLowerCase())),ne=()=>{const t=a.amount==="custom"?a.customAmount:a.amount,i=parseFloat(t)*100,u=new URLSearchParams;return u.set("giftCardAmount",i.toString()),a.isForSelf||(a.recipientEmail&&u.set("recipientEmail",a.recipientEmail),a.recipientName&&u.set("recipientName",a.recipientName),a.senderName&&u.set("senderName",a.senderName),a.message&&u.set("message",a.message)),`/studio/${o}/checkout?${u.toString()}`},[ae,ie]=de(),E=ae.get("claimCode");B(()=>{E&&(S(E.toUpperCase()),z(!0),ie(t=>(t.delete("claimCode"),t)))},[E]),B(()=>{const t=()=>b(null);return window.addEventListener("click",t),()=>window.removeEventListener("click",t)},[]);const N=f.reduce((t,i)=>t+i.initialValue,0),L=f.reduce((t,i)=>t+(i.status==="active"?i.currentBalance:0),0),re=N>0?(N-L)/N*100:0;return n("div",{className:"p-8 max-w-7xl mx-auto",children:[n("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4",children:[n("div",{children:[n("h1",{className:"text-3xl font-extrabold text-zinc-900 dark:text-zinc-100 flex items-center gap-3",children:[e(me,{className:"text-blue-600"})," Gift Cards"]}),e("p",{className:"text-sm text-zinc-500 mt-1",children:s?"Issue and manage gift cards. Sell them at checkout via POS.":"View your balance or purchase a gift card."})]}),!s&&n("div",{className:"flex bg-zinc-100 dark:bg-zinc-800 p-1 rounded-xl",children:[e("button",{onClick:()=>F("list"),className:`px-4 py-2 text-sm font-bold rounded-lg transition-all ${x==="list"?"bg-white dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 shadow-sm":"text-zinc-500 hover:text-zinc-900 dark:text-zinc-400"}`,children:"My Cards"}),e("button",{onClick:()=>F("buy"),className:`px-4 py-2 text-sm font-bold rounded-lg transition-all ${x==="buy"?"bg-white dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 shadow-sm":"text-zinc-500 hover:text-zinc-900 dark:text-zinc-400"}`,children:"Buy Gift Card"})]}),n("div",{className:"flex gap-2",children:[x==="list"&&!s&&n("button",{onClick:()=>z(!0),className:"bg-white dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 border border-zinc-200 dark:border-zinc-700 px-6 py-3 rounded-2xl font-bold flex items-center gap-2 hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-all",children:[e(ue,{size:18})," Link Card"]}),s&&x==="list"&&n("button",{onClick:()=>I(!0),className:"bg-zinc-900 dark:bg-zinc-100 dark:text-zinc-900 text-white px-6 py-3 rounded-2xl font-bold flex items-center gap-2 shadow-lg hover:translate-y-[-2px] transition-all",children:[e(H,{size:20})," Issue New Card"]})]})]}),s||x==="list"?n("div",{className:"space-y-8",children:[s?n("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 animate-in fade-in slide-in-from-top-4",children:[n("div",{className:"bg-white dark:bg-zinc-900 p-6 rounded-3xl border border-zinc-100 dark:border-zinc-800 shadow-sm",children:[e("p",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest mb-1",children:"Total Liability"}),n("h2",{className:"text-2xl font-black text-zinc-900 dark:text-zinc-100",children:["$",(L/100).toLocaleString()]})]}),n("div",{className:"bg-white dark:bg-zinc-900 p-6 rounded-3xl border border-zinc-100 dark:border-zinc-800 shadow-sm",children:[e("p",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest mb-1",children:"Total Issued"}),n("h2",{className:"text-2xl font-black text-zinc-900 dark:text-zinc-100",children:["$",(N/100).toLocaleString()]})]}),n("div",{className:"bg-white dark:bg-zinc-900 p-6 rounded-3xl border border-zinc-100 dark:border-zinc-800 shadow-sm",children:[e("p",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest mb-1",children:"Redemption Rate"}),n("h2",{className:"text-2xl font-black text-zinc-900 dark:text-zinc-100",children:[re.toFixed(1),"%"]})]}),n("div",{className:"bg-white dark:bg-zinc-900 p-6 rounded-3xl border border-zinc-100 dark:border-zinc-800 shadow-sm",children:[e("p",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest mb-1",children:"Active Cards"}),e("h2",{className:"text-2xl font-black text-zinc-900 dark:text-zinc-100",children:f.filter(t=>t.status==="active").length})]})]}):e("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:n("div",{className:"bg-white dark:bg-zinc-900 p-6 rounded-3xl border border-zinc-100 dark:border-zinc-800 shadow-sm",children:[e("p",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest mb-1",children:"My Balance"}),n("h2",{className:"text-2xl font-black text-zinc-900 dark:text-zinc-100",children:["$",(L/100).toLocaleString()]})]})}),n("div",{className:"space-y-4",children:[s&&n("div",{className:"relative",children:[e(pe,{className:"absolute left-4 top-1/2 -translate-y-1/2 h-4 w-4 text-zinc-400"}),e("input",{type:"text",placeholder:"Find by code or email...",value:w,onChange:t=>J(t.target.value),className:"w-full pl-12 pr-4 py-3 bg-white dark:bg-zinc-900 border border-zinc-100 dark:border-zinc-800 rounded-2xl text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-sm"})]}),e("div",{className:"bg-white dark:bg-zinc-900 rounded-3xl border border-zinc-100 dark:border-zinc-800 shadow-sm overflow-visible",children:O.length===0?n("div",{className:"p-12 text-center text-zinc-500",children:[e(xe,{className:"h-12 w-12 mx-auto mb-4 opacity-20"}),e("p",{children:"No gift cards found."})]}):n("table",{className:"w-full text-left",children:[e("thead",{className:"bg-zinc-50 dark:bg-zinc-800/50",children:n("tr",{children:[e("th",{className:"px-6 py-4 text-[10px] font-bold text-zinc-500 uppercase tracking-widest",children:"Code"}),e("th",{className:"px-6 py-4 text-[10px] font-bold text-zinc-500 uppercase tracking-widest",children:"Balance"}),e("th",{className:"px-6 py-4 text-[10px] font-bold text-zinc-500 uppercase tracking-widest",children:"Status"}),e("th",{className:"px-6 py-4 text-[10px] font-bold text-zinc-500 uppercase tracking-widest",children:"Issued"}),s&&e("th",{className:"px-6 py-4 text-[10px] font-bold text-zinc-500 uppercase tracking-widest",children:"Recipient"}),e("th",{className:"px-6 py-4"})]})}),e("tbody",{className:"divide-y divide-zinc-50 dark:divide-zinc-800",children:O.map(t=>n(se.Fragment,{children:[n("tr",{className:"hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition-colors",children:[e("td",{className:"px-6 py-4 font-mono font-bold text-zinc-900 dark:text-zinc-100",children:t.code}),n("td",{className:"px-6 py-4",children:[n("span",{className:"font-bold text-zinc-900 dark:text-zinc-100",children:["$",(t.currentBalance/100).toFixed(2)]}),n("span",{className:"text-zinc-400 text-xs ml-1",children:["/ $",(t.initialValue/100).toFixed(2)]})]}),e("td",{className:"px-6 py-4",children:e("span",{className:`text-[10px] font-bold px-2.5 py-1 rounded-full uppercase tracking-tighter ${t.status==="active"?"bg-emerald-100 text-emerald-700":t.status==="exhausted"?"bg-zinc-200 text-zinc-600":"bg-red-100 text-red-700"}`,children:t.status})}),e("td",{className:"px-6 py-4 text-xs text-zinc-500",children:new Date(t.createdAt).toLocaleDateString()}),s&&e("td",{className:"px-6 py-4 text-xs text-zinc-500",children:t.recipientEmail||"-"}),e("td",{className:"px-6 py-4 text-right relative",children:s?n("div",{className:"relative",children:[e("button",{onClick:i=>{i.stopPropagation(),b(X===t.id?null:t.id)},className:"text-zinc-400 hover:text-blue-600 transition-colors p-2 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800",children:e(be,{size:16})}),X===t.id&&n("div",{className:"absolute right-0 top-full mt-1 w-48 bg-white dark:bg-zinc-900 rounded-xl shadow-xl border border-zinc-100 dark:border-zinc-800 z-50 overflow-hidden py-1",children:[n("button",{onClick:()=>{b(null),j(t.id)},className:"w-full text-left px-4 py-2.5 text-sm hover:bg-zinc-50 dark:hover:bg-zinc-800 flex items-center gap-2",children:[e(V,{size:14})," View History"]}),n("button",{onClick:()=>{b(null),Z(t.id)},disabled:d,className:"w-full text-left px-4 py-2.5 text-sm hover:bg-zinc-50 dark:hover:bg-zinc-800 flex items-center gap-2",children:[e(he,{size:14})," ",d?"Sending...":"Resend Email"]}),n("button",{onClick:()=>{b(null),h.info("Void feature coming soon")},className:"w-full text-left px-4 py-2.5 text-sm hover:bg-zinc-50 dark:hover:bg-zinc-800 text-red-600 flex items-center gap-2 border-t border-zinc-100 dark:border-zinc-800",children:[e(ge,{size:14})," Void Card"]})]})]}):e("button",{onClick:()=>j(t.id),className:"text-zinc-400 hover:text-blue-600 transition-colors p-2",children:y===t.id?e(fe,{size:16}):e(V,{size:16})})})]}),y===t.id&&e("tr",{className:"bg-zinc-50/50 dark:bg-zinc-800/20",children:e("td",{colSpan:s?6:5,className:"px-6 py-4",children:n("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-100 dark:border-zinc-800 rounded-xl p-4 animate-in slide-in-from-top-2",children:[e("h4",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest mb-3",children:"Transaction History"}),_?e("div",{className:"flex justify-center py-4",children:e(ze,{className:"animate-spin text-zinc-300"})}):R.length===0?e("p",{className:"text-sm text-zinc-500",children:"No transactions found."}):e("div",{className:"space-y-2",children:R.map(i=>n("div",{className:"flex justify-between items-center text-sm p-2 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded-lg",children:[n("div",{className:"flex items-center gap-3",children:[e("div",{className:`w-8 h-8 rounded-full flex items-center justify-center ${i.amount>0?"bg-emerald-100 text-emerald-600":"bg-red-100 text-red-600"}`,children:i.amount>0?e(H,{size:14}):e("div",{className:"w-2 h-[2px] bg-current"})}),n("div",{children:[e("p",{className:"font-medium text-zinc-900 dark:text-zinc-100 capitalize",children:i.type}),e("p",{className:"text-xs text-zinc-400",children:new Date(i.createdAt).toLocaleString()})]})]}),n("span",{className:`font-mono font-bold ${i.amount>0?"text-emerald-600":"text-zinc-900 dark:text-zinc-100"}`,children:[i.amount>0?"+":"","$",(i.amount/100).toFixed(2)]})]},i.id))})]})})})]},t.id))})]})})]})]}):e("div",{className:"max-w-3xl mx-auto",children:n("div",{className:"bg-white dark:bg-zinc-900 rounded-3xl border border-zinc-100 dark:border-zinc-800 shadow-xl overflow-hidden",children:[n("div",{className:"p-8 border-b border-zinc-100 dark:border-zinc-800 bg-zinc-50/50 dark:bg-zinc-800/30",children:[e("h2",{className:"text-2xl font-black text-zinc-900 dark:text-zinc-100 mb-2",children:"Purchase Gift Card"}),e("p",{className:"text-zinc-500",children:"Give the gift of yoga and wellness. Sent instantly via email."})]}),n("div",{className:"p-8 space-y-8",children:[n("div",{className:"space-y-4",children:[e("label",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest",children:"Select Amount"}),e("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:["25","50","100","custom"].map(t=>e("button",{onClick:()=>c({...a,amount:t}),className:`py-4 px-4 rounded-2xl font-bold border-2 transition-all ${a.amount===t?"border-blue-600 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400":"border-zinc-200 dark:border-zinc-800 text-zinc-600 dark:text-zinc-400 hover:border-zinc-300"}`,children:t==="custom"?"Custom":`$${t}`},t))}),a.amount==="custom"&&e("div",{className:"animate-in fade-in slide-in-from-top-2",children:n("div",{className:"relative",children:[e("span",{className:"absolute left-4 top-1/2 -translate-y-1/2 font-bold text-zinc-400",children:"$"}),e("input",{type:"number",placeholder:"Enter amount (e.g. 150)",value:a.customAmount,onChange:t=>c({...a,customAmount:t.target.value}),className:"w-full pl-8 pr-4 py-4 bg-zinc-50 dark:bg-zinc-800 border-none rounded-2xl font-bold text-lg outline-none focus:ring-2 focus:ring-blue-500"})]})})]}),n("div",{className:"space-y-4",children:[e("label",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest",children:"Who is this for?"}),n("div",{className:"flex bg-zinc-100 dark:bg-zinc-800 p-1 rounded-2xl",children:[e("button",{onClick:()=>c({...a,isForSelf:!0}),className:`flex-1 py-3 px-4 rounded-xl text-sm font-bold transition-all ${a.isForSelf?"bg-white dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 shadow-sm":"text-zinc-500"}`,children:"For Me"}),e("button",{onClick:()=>c({...a,isForSelf:!1}),className:`flex-1 py-3 px-4 rounded-xl text-sm font-bold transition-all ${a.isForSelf?"text-zinc-500":"bg-white dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 shadow-sm"}`,children:"For Someone Else"})]})]}),!a.isForSelf&&n("div",{className:"space-y-4 animate-in fade-in slide-in-from-top-4",children:[n("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[n("div",{className:"space-y-1",children:[e("label",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest",children:"Recipient Name"}),e("input",{type:"text",placeholder:"Jane Doe",value:a.recipientName,onChange:t=>c({...a,recipientName:t.target.value}),className:"w-full px-4 py-3 bg-zinc-50 dark:bg-zinc-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500"})]}),n("div",{className:"space-y-1",children:[e("label",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest",children:"Recipient Email"}),e("input",{type:"email",placeholder:"jane@example.com",value:a.recipientEmail,onChange:t=>c({...a,recipientEmail:t.target.value}),className:"w-full px-4 py-3 bg-zinc-50 dark:bg-zinc-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500"})]})]}),n("div",{className:"space-y-1",children:[e("label",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest",children:"Your Name (From)"}),e("input",{type:"text",placeholder:"Your Name",value:a.senderName,onChange:t=>c({...a,senderName:t.target.value}),className:"w-full px-4 py-3 bg-zinc-50 dark:bg-zinc-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500"})]}),n("div",{className:"space-y-1",children:[e("label",{className:"text-xs font-bold text-zinc-400 uppercase tracking-widest",children:"Message (Optional)"}),e("textarea",{placeholder:"Enjoy!",rows:3,value:a.message,onChange:t=>c({...a,message:t.target.value}),className:"w-full px-4 py-3 bg-zinc-50 dark:bg-zinc-800 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 resize-none"})]})]}),e("div",{className:"pt-4",children:e("a",{href:ne(),className:`block w-full py-4 rounded-2xl font-black text-center transition-all ${!a.isForSelf&&!a.recipientEmail||a.amount==="custom"&&!a.customAmount?"bg-zinc-100 text-zinc-400 cursor-not-allowed":"bg-zinc-900 text-white dark:bg-zinc-100 dark:text-zinc-900 hover:scale-[1.02] shadow-xl"}`,children:"Proceed to Checkout"})})]})]})}),Y&&e("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto",children:n("div",{className:"bg-white dark:bg-zinc-900 rounded-3xl p-8 max-w-md w-full shadow-2xl",children:[e("h2",{className:"text-2xl font-black text-zinc-900 dark:text-zinc-100 mb-2",children:"Link Gift Card"}),n("form",{onSubmit:te,className:"space-y-4",children:[e("input",{type:"text",placeholder:"GIFT-XXXX-XXXX",className:"w-full px-4 py-3 bg-zinc-50 dark:bg-zinc-800 rounded-xl font-mono uppercase",value:D,onChange:t=>S(t.target.value.toUpperCase()),required:!0}),n("div",{className:"flex gap-2",children:[e("button",{type:"button",onClick:()=>z(!1),className:"flex-1 py-3 font-bold text-zinc-500",children:"Cancel"}),e("button",{type:"submit",disabled:d,className:"flex-1 py-3 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 font-bold rounded-xl",children:d?"...":"Link Card"})]})]})]})}),Q&&e("div",{className:"fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto",children:n("div",{className:"bg-white dark:bg-zinc-900 rounded-3xl p-8 max-w-md w-full shadow-2xl",children:[e("h2",{className:"text-2xl font-black text-zinc-900 dark:text-zinc-100 mb-2",children:"Issue Gift Card"}),n("form",{onSubmit:K,className:"space-y-4",children:[e("input",{type:"number",placeholder:"50.00",className:"w-full px-4 py-3 bg-zinc-50 dark:bg-zinc-800 rounded-xl font-bold",value:l.amount,onChange:t=>k({...l,amount:t.target.value}),required:!0}),e("input",{type:"email",placeholder:"customer@example.com",className:"w-full px-4 py-3 bg-zinc-50 dark:bg-zinc-800 rounded-xl",value:l.recipientEmail,onChange:t=>k({...l,recipientEmail:t.target.value})}),e("input",{type:"text",placeholder:"Internal notes",className:"w-full px-4 py-3 bg-zinc-50 dark:bg-zinc-800 rounded-xl",value:l.notes,onChange:t=>k({...l,notes:t.target.value})}),n("div",{className:"flex gap-2",children:[e("button",{type:"button",onClick:()=>I(!1),className:"flex-1 py-3 font-bold text-zinc-500",children:"Cancel"}),e("button",{type:"submit",disabled:d,className:"flex-1 py-3 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 font-bold rounded-xl",children:d?"...":"Issue Card"})]})]})]})}),e(ke,{isOpen:!!v,onClose:()=>C(null),onConfirm:ee,title:"Resend Gift Card",message:"Are you sure you want to resend the gift card email?",confirmText:"Resend Email"})]})}export{Ye as default};
