import{jsxs as t,jsx as e,Fragment as B}from"react/jsx-runtime";import{useLoaderData as V,useRevalidator as J,useSearchParams as R,useOutletContext as q,Link as X}from"react-router";import{n as A,a as I}from"./server-build-DYgJutU4.js";import{Upload as H,Image as O,Film as F,Folder as M,X as $,Info as K,Plus as G,RefreshCw as Q,Save as W}from"lucide-react";import{useState as c,useEffect as Y}from"react";import{toast as j}from"sonner";import"react-router-dom";import"isbot";import"react-dom/server";import"@clerk/react-router";import"@clerk/react-router/server";import"@tanstack/react-query";import"isomorphic-dompurify";import"fuse.js";import"clsx";import"tailwind-merge";import"date-fns";import"@headlessui/react";import"class-variance-authority";/* empty css                    */import"react-error-boundary";import"react-easy-crop";import"recharts";import"@stripe/stripe-js";import"@stripe/react-stripe-js";import"react-qr-code";function Pe(){const{videos:i,storageUsage:a,images:s,collections:n}=V(),m=J(),[N,u]=R(),{isStudentView:g}=q()||{},p=N.get("tab")||"videos",d=g&&p==="images"?"videos":p,[v,w]=c("grid"),[b,f]=c(null),[U,S]=c(!1),[y,T]=c("video"),[h,x]=c(!1),[C,z]=c(null),P=async r=>{x(!0);try{const o=await window.Clerk?.session?.getToken(),l=await I("/video-management/upload-url",o,{method:"POST",body:JSON.stringify({type:"vod"}),headers:{"X-Tenant-Slug":window.tenantSlug||""}}),{uploadUrl:k,uid:L}=l,E=new FormData;if(E.append("file",r),!(await fetch(k,{method:"POST",body:E})).ok)throw new Error("Upload to video server failed");await I("/video-management/",o,{method:"POST",body:JSON.stringify({title:r.name,cloudflareStreamId:L})}),m.revalidate()}catch(o){console.error(o),z("Upload failed: "+o.message)}finally{x(!1)}},D=async r=>{x(!0),z(null);try{const o=await window.Clerk?.session?.getToken(),l=new FormData;if(l.append("file",r),!(await fetch("/api/r2-image",{method:"POST",headers:{Authorization:`Bearer ${o}`},body:l})).ok)throw new Error("Image upload failed");m.revalidate()}catch(o){z("Upload failed: "+o.message)}finally{x(!1)}};return t("div",{className:"flex h-[calc(100vh-64px)] overflow-hidden",children:[t("div",{className:"flex-1 flex flex-col min-w-0 bg-zinc-50/50 dark:bg-zinc-950",children:[t("div",{className:"p-6 border-b border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900",children:[t("div",{className:"flex justify-between items-center mb-6",children:[t("div",{children:[e("h1",{className:"text-2xl font-bold text-zinc-900 dark:text-zinc-100",children:"Media Library"}),e("p",{className:"text-zinc-500 dark:text-zinc-400",children:g?"Browse class recordings and video content.":"Manage your class recordings and photo assets."})]}),t("div",{className:"flex items-center gap-4",children:[!g&&t("div",{className:"bg-zinc-100 dark:bg-zinc-800 px-4 py-2 rounded-lg text-sm",children:[e("span",{className:"font-medium text-zinc-600 dark:text-zinc-400",children:"Storage Used: "}),e("span",{className:"font-bold text-zinc-900 dark:text-zinc-200",children:A(a)})]}),!g&&(d==="videos"?t("label",{className:`bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 px-4 py-2 rounded-lg font-medium cursor-pointer hover:bg-zinc-800 dark:hover:bg-zinc-200 transition flex items-center gap-2 ${h?"opacity-70 cursor-not-allowed":""}`,children:[e(H,{size:18}),h?"Uploading...":"Upload Video",e("input",{type:"file",accept:"video/*",className:"hidden",onChange:r=>r.target.files?.[0]&&P(r.target.files[0]),disabled:h})]}):t("label",{className:`bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 px-4 py-2 rounded-lg font-medium cursor-pointer hover:bg-zinc-800 dark:hover:bg-zinc-200 transition flex items-center gap-2 ${h?"opacity-70 cursor-not-allowed":""}`,children:[e(O,{size:18}),h?"Uploading...":"Upload Image",e("input",{type:"file",accept:"image/*",className:"hidden",onChange:r=>r.target.files?.[0]&&D(r.target.files[0]),disabled:h})]}))]})]}),t("div",{className:"flex space-x-6 border-b border-zinc-100 dark:border-zinc-800 -mb-px",children:[t("button",{onClick:()=>u({tab:"videos"}),className:`pb-3 text-sm font-medium flex items-center gap-2 border-b-2 transition ${d==="videos"?"border-zinc-900 dark:border-zinc-100 text-zinc-900 dark:text-zinc-100":"border-transparent text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200"}`,children:[e(F,{size:16})," Videos (",i.length,")"]}),t("button",{onClick:()=>u({tab:"collections"}),className:`pb-3 text-sm font-medium flex items-center gap-2 border-b-2 transition ${d==="collections"?"border-zinc-900 dark:border-zinc-100 text-zinc-900 dark:text-zinc-100":"border-transparent text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200"}`,children:[e(M,{size:16})," Collections (",n.length,")"]}),!g&&t("button",{onClick:()=>u({tab:"images"}),className:`pb-3 text-sm font-medium flex items-center gap-2 border-b-2 transition ${d==="images"?"border-zinc-900 dark:border-zinc-100 text-zinc-900 dark:text-zinc-100":"border-transparent text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-200"}`,children:[e(O,{size:16})," Photos (",s.length,")"]})]})]}),t("div",{className:"flex-1 overflow-y-auto p-6",children:[C&&t("div",{className:"bg-red-50 text-red-600 p-3 rounded mb-4 text-sm flex justify-between items-center",children:[C,e("button",{onClick:()=>z(null),children:e($,{size:14})})]}),d==="videos"?e(Z,{videos:i,onSelect:f,selectedId:b?.id}):d==="collections"?e(_,{collections:n}):e(ee,{images:s,onSelect:f,selectedId:b?.id})]})]}),b&&e(te,{item:b,type:d==="videos"?"video":"image",onClose:()=>f(null),onUpdate:()=>{m.revalidate()}})]})}function Z({videos:i,onSelect:a,selectedId:s}){return i.length===0?e("div",{className:"text-gray-400 text-center py-20",children:"No videos found."}):e("div",{className:"bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 shadow-sm overflow-hidden",children:t("table",{className:"w-full text-sm text-left",children:[e("thead",{className:"bg-zinc-50 dark:bg-zinc-800/50 border-b border-zinc-200 dark:border-zinc-800 font-medium text-zinc-500 dark:text-zinc-400",children:t("tr",{children:[e("th",{className:"px-4 py-3",children:"Title"}),e("th",{className:"px-4 py-3",children:"Duration"}),e("th",{className:"px-4 py-3",children:"Tags"}),e("th",{className:"px-4 py-3 w-10"})]})}),e("tbody",{className:"divide-y divide-zinc-100 dark:divide-zinc-800",children:i.map(n=>t("tr",{onClick:()=>a(n),className:`cursor-pointer hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition ${s===n.id?"bg-blue-50/50 dark:bg-blue-900/10":""}`,children:[e("td",{className:"px-4 py-3 font-medium text-zinc-900 dark:text-zinc-100",children:n.title}),e("td",{className:"px-4 py-3 text-zinc-500 dark:text-zinc-400",children:n.duration?Math.floor(n.duration/60)+"m":"--"}),e("td",{className:"px-4 py-3",children:t("div",{className:"flex flex-wrap gap-1",children:[n.tags?.slice(0,3).map(m=>e("span",{className:"px-1.5 py-0.5 bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-300 rounded text-xs",children:m},m)),n.tags?.length>3&&t("span",{className:"text-xs text-zinc-400",children:["+",n.tags.length-3]})]})}),e("td",{className:"px-4 py-3 text-right",children:e("button",{className:"text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300",children:e(K,{size:16})})})]},n.id))})]})})}function _({collections:i,onCreate:a}){return i.length===0&&!a?e("div",{className:"text-gray-400 text-center py-20",children:"No collections found."}):t("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[i.map(s=>e(X,{to:`collections/${s.id}`,className:"block group",children:t("div",{className:"bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 p-6 hover:border-black dark:hover:border-zinc-400 transition shadow-sm h-full flex flex-col",children:[t("div",{className:"flex items-start justify-between mb-4",children:[e("div",{className:"p-3 bg-zinc-100 dark:bg-zinc-800 rounded-lg group-hover:bg-zinc-900 dark:group-hover:bg-zinc-100 group-hover:text-white dark:group-hover:text-black transition",children:e(M,{size:24})}),t("span",{className:"text-xs text-zinc-400 font-mono",children:["#",s.slug]})]}),e("h3",{className:"font-bold text-lg mb-1 text-zinc-900 dark:text-zinc-100",children:s.title}),e("p",{className:"text-sm text-zinc-500 dark:text-zinc-400 line-clamp-2 mb-4 flex-1",children:s.description||"No description"}),e("div",{className:"text-xs text-zinc-400 font-medium",children:"Click to manage items â†’"})]})},s.id)),t("div",{className:"border-2 border-dashed border-zinc-200 rounded-lg p-6 flex flex-col items-center justify-center text-zinc-400 hover:bg-zinc-50 hover:border-zinc-300 transition cursor-pointer min-h-[200px]",onClick:a,children:[e(G,{size:32}),e("span",{className:"mt-2 text-sm font-medium",children:"Create Collection"})]})]})}function ee({images:i,onSelect:a,selectedId:s}){return i.length===0?e("div",{className:"text-gray-400 text-center py-20",children:"No images found."}):e("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4",children:i.map(n=>t("div",{onClick:()=>a(n),className:`bg-white dark:bg-zinc-900 rounded border aspect-square relative group cursor-pointer overflow-hidden ${s===n.id?"ring-2 ring-blue-500 ring-offset-2 dark:ring-offset-zinc-900":"hover:border-zinc-300 dark:hover:border-zinc-600 border-zinc-200 dark:border-zinc-800"}`,children:[e("img",{src:n.fileUrl,alt:n.title,className:"w-full h-full object-cover"}),t("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-end p-3",children:[e("p",{className:"text-white text-sm font-medium truncate",children:n.title||n.originalName}),e("p",{className:"text-white/80 text-xs",children:A(n.sizeBytes)})]})]},n.id))})}function te({item:i,type:a,onClose:s,onUpdate:n}){const[m,N]=c(i.title||i.originalName||""),[u,g]=c(i.description||""),[p,d]=c(i.tags||[]),[v,w]=c(""),[b,f]=c(!1),[U,S]=c(i.accessLevel||"members"),[y,T]=c(i.posterUrl||""),[h,x]=c(!1);Y(()=>{N(i.title||i.originalName||""),g(i.description||""),d(i.tags||[]),a==="video"&&(S(i.accessLevel||"members"),T(i.posterUrl||"")),w("")},[i,a]);const C=r=>{r.key==="Enter"&&v.trim()&&(r.preventDefault(),p.includes(v.trim())||d([...p,v.trim()]),w(""))},z=r=>{d(p.filter(o=>o!==r))},P=async r=>{x(!0);try{const o=await window.Clerk?.session?.getToken(),l=new FormData;l.append("file",r);const k=await fetch("/api/r2-image",{method:"POST",headers:{Authorization:`Bearer ${o}`},body:l});if(!k.ok)throw new Error("Upload failed");const L=await k.json();T(L.url)}catch(o){console.error(o),j.error("Poster upload failed")}finally{x(!1)}},D=async()=>{f(!0);try{const r=await window.Clerk?.session?.getToken(),o=a==="video"?`/video-management/${i.id}`:`/uploads/images/${i.id}`,l={title:m,description:u,tags:p};a==="video"&&(l.accessLevel=U,l.posterUrl=y),await I(o,r,{method:"PATCH",body:JSON.stringify(l)}),n(),j.success("Changes saved.")}catch(r){console.error(r),j.error("Failed to save changes.")}finally{f(!1)}};return t("div",{className:"w-80 bg-white dark:bg-zinc-900 border-l border-zinc-200 dark:border-zinc-800 shadow-xl flex flex-col overflow-hidden animate-in slide-in-from-right-10 duration-200",children:[t("div",{className:"p-4 border-b border-zinc-100 dark:border-zinc-800 flex justify-between items-center bg-zinc-50 dark:bg-zinc-800/50",children:[t("span",{className:"font-semibold text-sm uppercase text-zinc-500 dark:text-zinc-400 tracking-wide",children:[a," Details"]}),e("button",{onClick:s,className:"text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300",children:e($,{size:18})})]}),t("div",{className:"flex-1 overflow-y-auto p-4 space-y-6",children:[t("div",{className:"aspect-video bg-zinc-100 rounded-lg overflow-hidden border border-zinc-200 flex items-center justify-center relative group",children:[a==="image"?e("img",{src:i.fileUrl,className:"w-full h-full object-contain"}):y?e("img",{src:y,className:"w-full h-full object-cover"}):t("div",{className:"flex flex-col items-center gap-2 text-zinc-400",children:[e(F,{size:24}),e("span",{className:"text-xs",children:"No preview available"})]}),a==="video"&&t("label",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition",children:[e("input",{type:"file",accept:"image/*",className:"hidden",onChange:r=>r.target.files?.[0]&&P(r.target.files[0]),disabled:h}),t("span",{className:"text-white text-xs font-medium flex items-center gap-2",children:[h?e(Q,{className:"animate-spin",size:16}):e(O,{size:16}),"Change Poster"]})]})]}),t("div",{className:"grid grid-cols-2 gap-2 text-xs text-zinc-500",children:[t("div",{className:"bg-zinc-50 p-2 rounded",children:[e("span",{className:"block font-medium text-zinc-700",children:"Size"}),A(i.sizeBytes)]}),t("div",{className:"bg-zinc-50 p-2 rounded",children:[e("span",{className:"block font-medium text-zinc-700",children:"Created"}),new Date(i.createdAt).toLocaleDateString()]})]}),t("div",{className:"space-y-4",children:[t("div",{children:[e("label",{className:"block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1",children:"Title"}),e("input",{type:"text",value:m,onChange:r=>N(r.target.value),className:"w-full px-3 py-2 border border-zinc-200 dark:border-zinc-700 dark:bg-zinc-800 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent outline-none"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1",children:"Description"}),e("textarea",{value:u,onChange:r=>g(r.target.value),rows:3,className:"w-full px-3 py-2 border border-zinc-200 dark:border-zinc-700 dark:bg-zinc-800 dark:text-white rounded-lg text-sm focus:ring-2 focus:ring-black dark:focus:ring-white focus:border-transparent outline-none resize-none"})]}),t("div",{children:[e("label",{className:"block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1",children:"Tags / Labels"}),t("div",{className:"min-h-[40px] p-2 border border-zinc-200 dark:border-zinc-700 rounded-lg bg-white dark:bg-zinc-800 flex flex-wrap gap-2 focus-within:ring-2 focus-within:ring-black dark:focus-within:ring-white focus-within:border-transparent",children:[p.map(r=>t("span",{className:"inline-flex items-center gap-1 bg-zinc-100 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-200 px-2 py-1 rounded text-xs font-medium",children:[r,e("button",{onClick:()=>z(r),className:"hover:text-red-500",children:e($,{size:10})})]},r)),e("input",{type:"text",value:v,onChange:r=>w(r.target.value),onKeyDown:C,placeholder:p.length===0?"Type and enter...":"",className:"flex-1 min-w-[60px] text-sm outline-none bg-transparent dark:text-white"})]}),e("p",{className:"text-xs text-zinc-400 mt-1",children:"Press Enter to add tag"})]}),a==="video"&&t("div",{children:[e("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Access Level"}),t("select",{value:U,onChange:r=>S(r.target.value),className:"w-full px-2 py-2 border border-zinc-200 rounded-lg text-sm outline-none",children:[e("option",{value:"public",children:"Public (Everyone)"}),e("option",{value:"members",children:"Members Only (Logged In)"}),e("option",{value:"private",children:"Private (Admin Only)"})]})]})]})]}),e("div",{className:"p-4 border-t border-zinc-100 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-800/50",children:e("button",{onClick:D,disabled:b,className:"w-full bg-black dark:bg-zinc-100 text-white dark:text-zinc-900 py-2 rounded-lg font-medium text-sm hover:bg-zinc-800 dark:hover:bg-zinc-200 disabled:opacity-50 flex items-center justify-center gap-2",children:b?"Saving...":t(B,{children:[e(W,{size:16})," Save Usage"]})})})]})}export{Pe as default};
