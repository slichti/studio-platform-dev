import{jsxs as a,jsx as e,Fragment as B}from"react/jsx-runtime";import{useState as c,useEffect as P}from"react";import{useOutletContext as q}from"react-router";import{a as p,o as b}from"./server-build-DYgJutU4.js";import{BarChart3 as D,Layers as X,Filter as J,Calendar as U,RefreshCw as W,DollarSign as I,Users as R,UserPlus as Q,Download as V,Save as G}from"lucide-react";import{ResponsiveContainer as Y,BarChart as H,CartesianGrid as _,XAxis as L,YAxis as T,Tooltip as M,Legend as A,Bar as h,LineChart as Z,Line as x}from"recharts";import{format as N,subDays as ee}from"date-fns";import"react-router-dom";import"isbot";import"react-dom/server";import"@clerk/react-router";import"@clerk/react-router/server";import"@tanstack/react-query";import"sonner";import"isomorphic-dompurify";import"fuse.js";import"clsx";import"tailwind-merge";import"@headlessui/react";import"class-variance-authority";/* empty css                    */import"react-error-boundary";import"react-easy-crop";import"@stripe/stripe-js";import"@stripe/react-stripe-js";import"react-qr-code";function Re(){const{tenant:m}=q(),[k,w]=c(!1),[r,$]=c(null),[S,O]=c([]),F=[{id:"revenue",label:"Revenue"},{id:"attendance",label:"Attendance"},{id:"new_signups",label:"New Signups"},{id:"active_members",label:"Active Members"}],[n,g]=c(["revenue"]),[d,f]=c(["date"]),[u,y]=c("bar"),[s,z]=c({start:N(ee(new Date,30),"yyyy-MM-dd"),end:N(new Date,"yyyy-MM-dd")}),[v,te]=c({}),K=async()=>{try{const t=await p("/reports/custom/query",null,{method:"POST",body:JSON.stringify({metrics:n,dimensions:d,filters:{startDate:s.start,endDate:s.end,...v},format:"csv"}),headers:{"X-Tenant-Slug":m?.slug}}),i=new Blob([t],{type:"text/csv"}),l=window.URL.createObjectURL(i),o=document.createElement("a");o.href=l,o.download=`report-${N(new Date,"yyyy-MM-dd")}.csv`,document.body.appendChild(o),o.click(),o.remove()}catch(t){console.error("Export failed",t)}};P(()=>{C()},[]);const C=async()=>{try{const t=await p("/reports/custom",null,{headers:{"X-Tenant-Slug":m?.slug}});t.reports&&O(t.reports)}catch(t){console.error("Failed to load saved reports",t)}},j=async()=>{w(!0);try{const t=await p("/reports/custom/query",null,{method:"POST",body:JSON.stringify({metrics:n,dimensions:d,filters:{startDate:s.start,endDate:s.end,...v}}),headers:{"X-Tenant-Slug":m?.slug}});$(t)}catch(t){console.error("Query failed",t)}finally{w(!1)}},E=async t=>{try{return await p("/reports/custom",null,{method:"POST",body:JSON.stringify({name:t,config:{metrics:n,dimensions:d,dateRange:s,filters:v,chartType:u},isPublic:!1}),headers:{"X-Tenant-Slug":m?.slug}}),C(),!0}catch{return!1}};return a("div",{className:"animate-in fade-in duration-500",children:[e("div",{className:"flex items-center justify-between mb-8",children:a("div",{children:[a("h2",{className:"text-xl font-semibold mb-2 flex items-center gap-2",children:[e(D,{className:"text-blue-600",size:20})," Custom Report Builder"]}),e("p",{className:"text-zinc-500 dark:text-zinc-400 text-sm",children:"Design ad-hoc queries and analyze studio performance."})]})}),a("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-8",children:[a("div",{className:"lg:col-span-1 space-y-6",children:[a("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-5 shadow-sm",children:[a("h3",{className:"font-semibold text-zinc-900 dark:text-zinc-100 mb-4 flex items-center gap-2 text-sm",children:[e(X,{size:16})," Metrics"]}),e("div",{className:"space-y-2",children:F.map(t=>a("label",{className:"flex items-center gap-2 text-sm text-zinc-600 dark:text-zinc-300 cursor-pointer",children:[e("input",{type:"checkbox",checked:n.includes(t.id),onChange:i=>{i.target.checked?g([...n,t.id]):g(n.filter(l=>l!==t.id))},className:"rounded border-zinc-300 text-blue-600 focus:ring-blue-500"}),e("span",{className:"capitalize",children:t.label})]},t.id))})]}),a("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-5 shadow-sm",children:[a("h3",{className:"font-semibold text-zinc-900 dark:text-zinc-100 mb-4 flex items-center gap-2 text-sm",children:[e(J,{size:16})," Dimensions"]}),e("div",{className:"space-y-2",children:["date","instructor","payment_method"].map(t=>a("label",{className:"flex items-center gap-2 text-sm text-zinc-600 dark:text-zinc-300 cursor-pointer",children:[e("input",{type:"checkbox",checked:d.includes(t),onChange:i=>{i.target.checked?f([...d,t]):f(d.filter(l=>l!==t))},className:"rounded border-zinc-300 text-blue-600 focus:ring-blue-500"}),e("span",{className:"capitalize",children:t.replace("_"," ")})]},t))})]}),a("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-5 shadow-sm",children:[a("h3",{className:"font-semibold text-zinc-900 dark:text-zinc-100 mb-4 flex items-center gap-2 text-sm",children:[e(U,{size:16})," Date Range (Custom)"]}),a("div",{className:"space-y-3",children:[e("input",{type:"date",value:s.start,onChange:t=>z({...s,start:t.target.value}),className:"w-full px-3 py-2 text-sm border border-zinc-200 dark:border-zinc-700 rounded-lg bg-zinc-50 dark:bg-zinc-950"}),e("input",{type:"date",value:s.end,onChange:t=>z({...s,end:t.target.value}),className:"w-full px-3 py-2 text-sm border border-zinc-200 dark:border-zinc-700 rounded-lg bg-zinc-50 dark:bg-zinc-950"})]})]}),e("button",{onClick:j,disabled:k,className:"w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition-all shadow-lg flex items-center justify-center gap-2 disabled:opacity-50",children:k?e(W,{className:"animate-spin",size:18}):"Run Report"}),S.length>0&&a("div",{className:"mt-8",children:[e("h4",{className:"text-xs font-bold text-zinc-500 uppercase tracking-wider mb-3",children:"Saved Reports"}),e("ul",{className:"space-y-2",children:S.map(t=>e("li",{className:"text-sm",children:e("button",{onClick:()=>{const i=typeof t.config=="string"?JSON.parse(t.config):t.config;g(i.metrics||[]),f(i.dimensions||[]),i.dateRange&&z(i.dateRange),i.chartType&&y(i.chartType)},className:"text-zinc-600 dark:text-zinc-400 hover:text-blue-600 text-left block w-full truncate",children:t.name})},t.id))})]})]}),e("div",{className:"lg:col-span-3 space-y-6",children:r?a(B,{children:[a("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[n.includes("revenue")&&e(b,{title:"Total Revenue",value:`$${r.summary?.revenue?.toFixed(2)||"0.00"}`,icon:e(I,{size:20,className:"text-blue-500"})}),n.includes("attendance")&&e(b,{title:"Total Attendance",value:r.summary?.attendance||0,icon:e(R,{size:20,className:"text-emerald-500"})}),n.includes("new_signups")&&e(b,{title:"New Signups",value:r.summary?.new_signups||0,icon:e(Q,{size:20,className:"text-amber-500"})}),n.includes("active_members")&&e(b,{title:"Active Members",value:r.summary?.active_members||0,icon:e(R,{size:20,className:"text-zinc-500"})})]}),a("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-xl shadow-sm h-[450px]",children:[a("div",{className:"flex items-center justify-between mb-4",children:[e("h3",{className:"text-sm font-bold text-zinc-500 uppercase",children:"Visualization"}),a("div",{className:"flex bg-zinc-100 dark:bg-zinc-800 p-1 rounded-lg",children:[e("button",{onClick:()=>y("bar"),className:`px-3 py-1 text-xs font-medium rounded-md ${u==="bar"?"bg-white shadow-sm text-zinc-900":"text-zinc-500"}`,children:"Bar"}),e("button",{onClick:()=>y("line"),className:`px-3 py-1 text-xs font-medium rounded-md ${u==="line"?"bg-white shadow-sm text-zinc-900":"text-zinc-500"}`,children:"Line"})]})]}),e(Y,{width:"100%",height:"90%",children:u==="bar"?a(H,{data:r.chartData,children:[e(_,{strokeDasharray:"3 3",opacity:.1,vertical:!1}),e(L,{dataKey:"name",axisLine:!1,tickLine:!1,tick:{fill:"#71717a",fontSize:12},dy:10}),e(T,{axisLine:!1,tickLine:!1,tick:{fill:"#71717a",fontSize:12},tickFormatter:t=>n.includes("revenue")&&t>100?`$${t}`:t}),e(M,{contentStyle:{borderRadius:"8px",border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"},cursor:{fill:"rgba(0,0,0,0.05)"}}),e(A,{}),n.includes("revenue")&&e(h,{dataKey:"revenue",fill:"#2563eb",radius:[4,4,0,0],name:"Revenue ($)"}),n.includes("attendance")&&e(h,{dataKey:"attendance",fill:"#059669",radius:[4,4,0,0],name:"Attendance"}),n.includes("new_signups")&&e(h,{dataKey:"new_signups",fill:"#F59E0B",radius:[4,4,0,0],name:"New Signups"}),n.includes("active_members")&&e(h,{dataKey:"active_members",fill:"#71717a",radius:[4,4,0,0],name:"Active Members"})]}):a(Z,{data:r.chartData,children:[e(_,{strokeDasharray:"3 3",opacity:.1,vertical:!1}),e(L,{dataKey:"name",axisLine:!1,tickLine:!1,tick:{fill:"#71717a",fontSize:12},dy:10}),e(T,{axisLine:!1,tickLine:!1,tick:{fill:"#71717a",fontSize:12},tickFormatter:t=>n.includes("revenue")&&t>100?`$${t}`:t}),e(M,{contentStyle:{borderRadius:"8px",border:"none",boxShadow:"0 4px 12px rgba(0,0,0,0.1)"}}),e(A,{}),n.includes("revenue")&&e(x,{type:"monotone",dataKey:"revenue",stroke:"#2563eb",strokeWidth:3,dot:{r:4},activeDot:{r:6},name:"Revenue ($)"}),n.includes("attendance")&&e(x,{type:"monotone",dataKey:"attendance",stroke:"#059669",strokeWidth:3,dot:{r:4},activeDot:{r:6},name:"Attendance"}),n.includes("new_signups")&&e(x,{type:"monotone",dataKey:"new_signups",stroke:"#F59E0B",strokeWidth:3,dot:{r:4},activeDot:{r:6},name:"New Signups"}),n.includes("active_members")&&e(x,{type:"monotone",dataKey:"active_members",stroke:"#71717a",strokeWidth:3,dot:{r:4},activeDot:{r:6},name:"Active Members"})]})})]}),a("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl overflow-hidden shadow-sm",children:[a("div",{className:"px-6 py-4 border-b border-zinc-100 dark:border-zinc-800 flex justify-between items-center bg-zinc-50/50 dark:bg-zinc-900/50",children:[e("h3",{className:"text-sm font-bold text-zinc-500 uppercase",children:"Raw Data"}),a("button",{onClick:K,className:"text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-1",children:[e(V,{size:14})," Export CSV"]})]}),e("div",{className:"overflow-x-auto",children:a("table",{className:"w-full text-sm text-left text-zinc-900",children:[e("thead",{className:"text-xs text-zinc-500 uppercase bg-zinc-50 dark:bg-zinc-900/50",children:a("tr",{children:[e("th",{className:"px-6 py-3",children:"Dimension"}),n.includes("revenue")&&e("th",{className:"px-6 py-3",children:"Revenue"}),n.includes("attendance")&&e("th",{className:"px-6 py-3",children:"Attendance"}),n.includes("new_signups")&&e("th",{className:"px-6 py-3",children:"New Signups"}),n.includes("active_members")&&e("th",{className:"px-6 py-3",children:"Active Members"})]})}),e("tbody",{className:"divide-y divide-zinc-100 dark:divide-zinc-800",children:r.chartData.map((t,i)=>a("tr",{className:"hover:bg-zinc-50 transition-colors",children:[e("td",{className:"px-6 py-4 font-medium",children:t.name}),n.includes("revenue")&&a("td",{className:"px-6 py-4 text-zinc-600",children:["$",t.revenue?.toFixed(2)]}),n.includes("attendance")&&e("td",{className:"px-6 py-4 text-zinc-600",children:t.attendance}),n.includes("new_signups")&&e("td",{className:"px-6 py-4 text-zinc-600",children:t.new_signups}),n.includes("active_members")&&e("td",{className:"px-6 py-4 text-zinc-600",children:t.active_members})]},i))})]})})]}),e("div",{className:"flex justify-end gap-3",children:a("button",{onClick:()=>{const t=prompt("Enter report name:");t&&E(t)},className:"px-6 py-2 border border-zinc-200 rounded-lg text-sm font-medium hover:bg-zinc-50 flex items-center gap-2",children:[e(G,{size:16})," Save Configuration"]})})]}):a("div",{className:"h-96 border-2 border-dashed border-zinc-200 dark:border-zinc-800 rounded-2xl flex flex-col items-center justify-center text-zinc-400 bg-zinc-50/50 dark:bg-zinc-900/50",children:[e(D,{size:48,className:"mb-4 opacity-50"}),e("p",{className:"font-medium",children:"Configure metrics and run query to see results"})]})})]})]})}export{Re as default};
