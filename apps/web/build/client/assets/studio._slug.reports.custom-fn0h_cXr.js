import{w as O,e as E,d as A,L as I}from"./chunk-JMJ3UQ3L-DIHTCPR9.js";import{j as e}from"./vendor-puck-EFhZVjRu.js";import{a}from"./vendor-sentry-BD1MTpLq.js";import{a as d}from"./api-D1U4i9fn.js";import{C as B}from"./ConfirmDialog-DqDjwe4K.js";import{F}from"./funnel-CMCL3Bgb.js";import{L as P}from"./loader-circle-CaGZsKjo.js";import{T as Q}from"./trash-2-DU-4PZMS.js";import{S as $}from"./save-f-wzAblY.js";import{R as q,B as K,C as M,X as _,Y as G,T as J,L as X,a as k}from"./vendor-charts-BQhvGvjY.js";import{C as Y}from"./chart-column-BictQ20g.js";import"./button-Bn3mr4O5.js";import"./dialog-BbMbq4lO.js";import"./portal-BBJKmgiS.js";import"./x-6mvJS0UK.js";import"./createLucideIcon-DgXJrNmH.js";const pe=O(function(){const{tenant:U}=E()||{},{slug:N}=A(),[g,z]=a.useState([]),[b,j]=a.useState(!1),[i,l]=a.useState(["revenue"]),[o,m]=a.useState(["date"]),[n,c]=a.useState({start:"",end:""}),[v,w]=a.useState(""),[r,S]=a.useState(null),[x,y]=a.useState(""),[p,u]=a.useState(null);a.useEffect(()=>{h();const s=new Date,t=new Date;t.setDate(s.getDate()-30),c({start:t.toISOString().split("T")[0],end:s.toISOString().split("T")[0]})},[]);const h=async()=>{const s=await window.Clerk?.session?.getToken();try{const t=await d("/reports/custom",s);z(t.reports||[])}catch(t){console.error("Failed to load reports",t)}},C=async()=>{j(!0);const s=await window.Clerk?.session?.getToken();try{const t=await d("/reports/custom/query",s,{method:"POST",body:JSON.stringify({metrics:i,dimensions:o,filters:{startDate:n.start,endDate:n.end,instructorId:v||void 0}})});S(t)}catch(t){console.error(t),alert("Query failed")}finally{j(!1)}},D=async()=>{if(!x)return alert("Enter a name");const s=await window.Clerk?.session?.getToken();try{await d("/reports/custom",s,{method:"POST",body:JSON.stringify({name:x,config:{metrics:i,dimensions:o,filters:{startDate:n.start,endDate:n.end,instructorId:v}}})}),y(""),h()}catch(t){console.error(t)}},R=s=>{const t=s.config;t.metrics&&l(t.metrics),t.dimensions&&m(t.dimensions),t.filters&&(c({start:t.filters.startDate?new Date(t.filters.startDate).toISOString().split("T")[0]:"",end:t.filters.endDate?new Date(t.filters.endDate).toISOString().split("T")[0]:""}),w(t.filters.instructorId||""))},T=(s,t)=>{t.stopPropagation(),u(s)},L=async()=>{if(!p)return;const s=await window.Clerk?.session?.getToken();await d(`/reports/custom/${p}`,s,{method:"DELETE"}),h(),u(null)};return e.jsxs("div",{className:"p-8 max-w-7xl mx-auto min-h-screen",children:[e.jsx("div",{className:"flex justify-between items-center mb-8",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 text-zinc-500 mb-1",children:[e.jsx(I,{to:`/studio/${N}/reports`,className:"hover:underline",children:"Analytics"}),e.jsx("span",{children:"/"}),e.jsx("span",{children:"Custom Query"})]}),e.jsx("h1",{className:"text-2xl font-bold text-zinc-900 dark:text-zinc-100",children:"Custom Report Builder"})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-8",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-zinc-900 p-4 rounded-xl border border-zinc-200 dark:border-zinc-800 shadow-sm",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(F,{size:16})," Query Options"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-zinc-500 uppercase mb-2 block",children:"Metrics"}),e.jsx("div",{className:"space-y-2",children:["revenue","attendance"].map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:i.includes(s),onChange:t=>{t.target.checked?l([...i,s]):l(i.filter(f=>f!==s))},className:"rounded border-zinc-300 text-brand-600 focus:ring-brand-500"}),e.jsx("span",{className:"capitalize",children:s})]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-zinc-500 uppercase mb-2 block",children:"Group By"}),e.jsx("div",{className:"space-y-2",children:["date","instructor"].map(s=>e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[e.jsx("input",{type:"checkbox",checked:o.includes(s),onChange:t=>{t.target.checked?m([...o,s]):m(o.filter(f=>f!==s))}}),e.jsx("span",{className:"capitalize",children:s})]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-zinc-500 uppercase mb-2 block",children:"Date Range"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsx("input",{type:"date",value:n.start,onChange:s=>c({...n,start:s.target.value}),className:"w-full text-xs p-2 rounded border dark:bg-zinc-800 dark:border-zinc-700"}),e.jsx("input",{type:"date",value:n.end,onChange:s=>c({...n,end:s.target.value}),className:"w-full text-xs p-2 rounded border dark:bg-zinc-800 dark:border-zinc-700"})]})]}),e.jsxs("button",{onClick:C,disabled:b,className:"w-full py-2 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 rounded-lg font-medium hover:opacity-90 flex justify-center items-center gap-2",children:[b&&e.jsx(P,{size:16,className:"animate-spin"}),"Run Query"]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-zinc-900 p-4 rounded-xl border border-zinc-200 dark:border-zinc-800 shadow-sm",children:[e.jsx("h3",{className:"font-semibold mb-4 text-sm",children:"Saved Reports"}),e.jsxs("div",{className:"space-y-2",children:[g.map(s=>e.jsxs("div",{onClick:()=>R(s),className:"p-3 bg-zinc-50 dark:bg-zinc-800 rounded-lg cursor-pointer hover:bg-zinc-100 dark:hover:bg-zinc-700 group flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-medium",children:s.name}),e.jsx("button",{onClick:t=>T(s.id,t),className:"text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1 hover:bg-red-50 dark:hover:bg-red-900/20 rounded",children:e.jsx(Q,{size:12})})]},s.id)),g.length===0&&e.jsx("p",{className:"text-xs text-zinc-500",children:"No saved reports."})]})]})]}),e.jsxs("div",{className:"lg:col-span-3 space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-zinc-900 p-4 rounded-xl border border-zinc-200 dark:border-zinc-800 shadow-sm flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Results"}),r&&e.jsxs("div",{className:"flex gap-4 text-sm text-zinc-500",children:[r.summary.revenue!==void 0&&e.jsxs("span",{children:["Revenue: ",e.jsxs("b",{children:["$",r.summary.revenue.toFixed(2)]})]}),r.summary.attendance!==void 0&&e.jsxs("span",{children:["Attendance: ",e.jsx("b",{children:r.summary.attendance})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"Report Name",value:x,onChange:s=>y(s.target.value),className:"px-3 py-1.5 rounded border border-zinc-300 dark:border-zinc-700 bg-transparent text-sm"}),e.jsxs("button",{onClick:D,className:"flex items-center gap-2 px-3 py-1.5 bg-zinc-100 dark:bg-zinc-800 hover:bg-zinc-200 rounded text-sm font-medium",children:[e.jsx($,{size:14})," Save"]})]})]}),e.jsx("div",{className:"bg-white dark:bg-zinc-900 p-6 rounded-xl border border-zinc-200 dark:border-zinc-800 shadow-sm min-h-[400px]",children:r&&r.chartData&&r.chartData.length>0?e.jsx(q,{width:"100%",height:400,children:e.jsxs(K,{data:r.chartData,children:[e.jsx(M,{strokeDasharray:"3 3",vertical:!1,stroke:"#E4E4E7"}),e.jsx(_,{dataKey:"name",axisLine:!1,tickLine:!1,tick:{fill:"#71717A",fontSize:12},dy:10,tickFormatter:s=>s.length>10?new Date(s).toLocaleDateString():s}),e.jsx(G,{axisLine:!1,tickLine:!1,tick:{fill:"#71717A",fontSize:12}}),e.jsx(J,{contentStyle:{borderRadius:"8px",border:"none",boxShadow:"0 4px 6px -1px rgb(0 0 0 / 0.1)"}}),e.jsx(X,{}),i.includes("revenue")&&e.jsx(k,{dataKey:"revenue",fill:"#3B82F6",name:"Revenue ($)",radius:[4,4,0,0]}),i.includes("attendance")&&e.jsx(k,{dataKey:"attendance",fill:"#10B981",name:"Attendance",radius:[4,4,0,0]})]})}):e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-zinc-400",children:[e.jsx(Y,{size:48,className:"mb-4 opacity-50"}),e.jsx("p",{children:"Run a query to see results"})]})})]})]}),e.jsx(B,{open:!!p,onOpenChange:s=>!s&&u(null),onConfirm:L,title:"Delete Report",description:"Are you sure you want to delete this saved report?",confirmText:"Delete",variant:"destructive"})]})});export{pe as default};
