import{w as U,c as A,d as q,r}from"./chunk-JMJ3UQ3L-ksN8Xei4.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{C as H}from"./ChatWindow-DIoWjLXp.js";import{M as W}from"./message-circle--AEHEzUf.js";import{X}from"./x-BxAStoFO.js";import"./send-BUtu0ahM.js";import"./createLucideIcon-mmuW3u_I.js";const ee=U(function(){const{apiUrl:u,tenant:g}=A(),{slug:a}=q(),[z,j]=r.useState("welcome"),[m,S]=r.useState(null),[N,v]=r.useState(!1),x=(()=>{if(!g?.chatConfig?.schedule)return!0;const{timezone:t,schedule:o}=g.chatConfig;try{const s=new Date,n=new Intl.DateTimeFormat("en-US",{timeZone:t||"UTC",weekday:"short",hour:"numeric",minute:"numeric",hour12:!1}).formatToParts(s),y=n.find(c=>c.type==="weekday")?.value,i=parseInt(n.find(c=>c.type==="hour")?.value||"0"),f=parseInt(n.find(c=>c.type==="minute")?.value||"0"),l=i*60+f;if(!y)return!0;const p=o[y];if(!p||!Array.isArray(p)||p.length!==2)return!1;const[O,P]=p,[I,M]=O.split(":").map(Number),[_,D]=P.split(":").map(Number),J=I*60+M,R=_*60+D;return l>=J&&l<R}catch(s){return console.error("Timezone Check Error",s),!0}})(),[b,T]=r.useState(""),[w,k]=r.useState(""),[d,$]=r.useState("");r.useEffect(()=>{const t=localStorage.getItem(`chat_session_${a}`);if(t)try{const o=JSON.parse(t);S(o),j("chat")}catch{localStorage.removeItem(`chat_session_${a}`)}},[a]);const E=async t=>{t.preventDefault(),v(!0);try{const s=await(await fetch(`${u}/guest/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:b,email:w})})).json();if(s.error)throw new Error(s.error);const h=s.token,n=s.user,i=await(await fetch(`${u}/chat/rooms`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h}`,"X-Tenant-Slug":a||""},body:JSON.stringify({type:"support",name:`Support: ${b}`,customer_email:w,metadata:{source:"widget",initialMessage:d},priority:"normal"})})).json();if(i.error)throw new Error(i.error);const f=i.id;d.trim()&&await fetch(`${u}/chat/rooms/${f}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h}`,"X-Tenant-Slug":a||""},body:JSON.stringify({content:d})});const l={token:h,roomId:f,user:n};S(l),localStorage.setItem(`chat_session_${a}`,JSON.stringify(l)),j("chat")}catch(o){alert("Failed to start chat: "+o.message)}finally{v(!1)}},C=()=>{window.parent.postMessage({type:"studio-chat-close"},"*")};return z==="welcome"?e.jsxs("div",{className:"h-screen w-screen bg-white flex flex-col font-sans",children:[e.jsx("div",{className:"bg-blue-600 p-4 text-white flex justify-between items-center shadow-md",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{size:20}),e.jsx("h1",{className:"font-semibold",children:"Support Chat"})]})}),e.jsxs("div",{className:"flex-1 p-6 flex flex-col justify-center",children:[e.jsx("p",{className:"text-zinc-600 mb-6 text-center",children:x?"Welcome! Please fill in your details to start a support chat with us.":`We are currently offline. Please leave a message and we'll get back to you at ${g?.chatConfig?.offlineEmail||"email"}.`}),e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Name"}),e.jsx("input",{required:!0,className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",placeholder:"Your Name",value:b,onChange:t=>T(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Email"}),e.jsx("input",{required:!0,type:"email",className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",placeholder:"you@example.com",value:w,onChange:t=>k(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Message"}),e.jsx("textarea",{required:!0,rows:3,className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",placeholder:"How can we help?",value:d,onChange:t=>$(t.target.value)})]}),e.jsx("button",{type:"submit",disabled:N,className:`w-full text-white font-semibold py-3 rounded-lg shadow-sm disabled:opacity-50 ${x?"bg-blue-600 hover:bg-blue-700":"bg-zinc-800 hover:bg-zinc-900"}`,children:N?"Sending...":x?"Start Chat":"Send Message"})]})]}),e.jsx("div",{className:"p-4 text-center text-xs text-zinc-400 border-t border-zinc-100",children:"Powered by Studio Platform"})]}):m?e.jsx("div",{className:"h-screen w-screen bg-white",children:e.jsxs("div",{className:"h-full flex flex-col relative",children:[e.jsx("div",{className:"absolute top-0 right-0 z-50 p-2 hidden",children:e.jsx("button",{onClick:C,children:e.jsx(X,{})})}),e.jsx(H,{roomId:m.roomId,token:m.token,currentUser:m.user,wsUrl:u,onClose:C})]})}):null});export{ee as default};
