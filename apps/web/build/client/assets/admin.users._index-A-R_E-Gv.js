import{w as M,d as B,u as G,h as F,a as J,r as d,F as I,L as W}from"./chunk-JMJ3UQ3L-Dzyq37y6.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{a as v}from"./api-piI5qlNr.js";import{M as H}from"./Modal-Ccs7c619.js";import{C as V,E as q}from"./Dialogs-BuTG-RoC.js";import{u as K}from"./chunk-OT5FTIRN-VRdL-y8m.js";import"./index-B3WcaCfs.js";import"./index-D9_Tf6xB.js";const ae=M(function(){const{users:o,tenants:u,error:z}=B(),[c,f]=G(),g=F();J();const[a,b]=d.useState(new Set),[j,O]=d.useState(!1),[y,U]=d.useState(new Set),[m,x]=d.useState({isOpen:!1,type:"success",message:""}),[E,N]=d.useState(!1),[i,p]=d.useState({firstName:"",lastName:"",email:"",isSystemAdmin:!1,initialTenantId:"",initialRole:"student"}),h=Array.isArray(o)?o:[],k=d.useMemo(()=>{if(!j)return null;const s={};return h.forEach(t=>{t.memberships&&t.memberships.length>0?t.memberships.forEach(n=>{const l=n.tenant.id;s[l]||(s[l]={tenant:n.tenant,users:[]}),s[l].users.push({...t,contextRole:n.role})}):(s.unassigned||(s.unassigned={tenant:{id:"unassigned",name:"Unassigned / Global"},users:[]}),s.unassigned.users.push(t))}),s},[h,j]),D=s=>{s.preventDefault();const n=new FormData(s.currentTarget).get("search");f(l=>(n?l.set("search",n):l.delete("search"),l))},L=()=>{a.size===h.length?b(new Set):b(new Set(h.map(s=>s.id)))},S=s=>{const t=new Set(a);t.has(s)?t.delete(s):t.add(s),b(t)},T=s=>{const t=new Set(y);t.has(s)?t.delete(s):t.add(s),U(t)},{getToken:w}=K(),C=async(s,t)=>{if(a.size!==0)try{const n=await w(),l=await v("/admin/users/bulk",n,{method:"PATCH",body:JSON.stringify({userIds:Array.from(a),action:s,value:t})});if(l.error)throw new Error(l.error);x({isOpen:!0,type:"success",message:`Successfully updated ${a.size} users.`}),b(new Set),g(c)}catch(n){x({isOpen:!0,type:"error",message:n.message})}},_=async()=>{if(!(!i.email||!i.firstName||!i.lastName))try{const s=await w(),t=await v("/admin/users",s,{method:"POST",body:JSON.stringify(i)});if(t.error)throw new Error(t.error);x({isOpen:!0,type:"success",message:"User created successfully."}),N(!1),p({firstName:"",lastName:"",email:"",isSystemAdmin:!1,initialTenantId:"",initialRole:"student"}),g(c)}catch(s){x({isOpen:!0,type:"error",message:s.message})}},R=async s=>{if(confirm("Are you sure you want to sign in as this user?"))try{const t=await w(),n=await v("/admin/impersonate",t,{method:"POST",body:JSON.stringify({targetUserId:s})});if(n.error)throw new Error(n.error);if(n.token){localStorage.setItem("impersonation_token",n.token);const l=h.find($=>$.id===s);l&&l.memberships&&l.memberships.length>0?window.location.href=`/studio/${l.memberships[0].tenant.slug}`:window.location.href="/dashboard"}}catch(t){x({isOpen:!0,type:"error",message:t.message})}},P=async s=>{if(confirm(`Are you sure you want to PERMANENTLY delete user ${s.email}? This cannot be undone.`))try{const t=await w(),n=await v(`/admin/users/${s.id}`,t,{method:"DELETE"});if(n.error)throw new Error(n.error);g(c)}catch(t){x({isOpen:!0,type:"error",message:t.message})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-zinc-900",children:"Global User Directory"}),e.jsx("p",{className:"text-zinc-500",children:"Manage all users across the platform."})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>N(!0),className:"bg-zinc-900 text-white px-4 py-2 rounded-lg hover:bg-zinc-800 font-medium text-sm flex items-center gap-2",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"Add User"]})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-between bg-white p-4 rounded-lg border border-zinc-200 shadow-sm",children:[e.jsxs(I,{onSubmit:D,className:"relative w-full sm:w-96",children:[e.jsx("input",{type:"search",name:"search",defaultValue:c.get("search")||"",placeholder:"Search users...",className:"w-full pl-10 pr-4 py-2 border border-zinc-300 rounded-lg focus:ring-2 focus:ring-zinc-900 focus:border-transparent"}),e.jsx("svg",{className:"absolute left-3 top-2.5 h-5 w-5 text-zinc-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-600 font-medium",children:[e.jsx("input",{type:"checkbox",checked:j,onChange:s=>O(s.target.checked),className:"rounded border-zinc-300 text-zinc-900 focus:ring-zinc-900"}),"Group by Tenant"]})})]}),a.size>0&&e.jsxs("div",{className:"fixed bottom-6 left-1/2 -translate-x-1/2 bg-zinc-900 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-6 z-50",children:[e.jsxs("span",{className:"font-medium",children:[a.size," users selected"]}),e.jsx("div",{className:"h-4 w-px bg-zinc-700"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>C("set_system_admin",!0),className:"hover:text-zinc-300 text-sm font-medium",children:"Promote to Admin"}),e.jsx("button",{onClick:()=>C("set_system_admin",!1),className:"hover:text-zinc-300 text-sm font-medium",children:"Demote"})]})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-zinc-200 overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4 p-4 border-b border-zinc-100 bg-zinc-50 text-xs font-medium text-zinc-500 uppercase tracking-wider items-center",children:[e.jsx("div",{className:"col-span-1 flex items-center justify-center",children:e.jsx("input",{type:"checkbox",onChange:L,checked:a.size===h.length&&h.length>0,className:"rounded border-zinc-300"})}),e.jsxs("div",{className:"col-span-3 flex items-center gap-1 cursor-pointer hover:text-zinc-700",onClick:()=>{const t=c.get("sort")==="name_asc"?"name_desc":"name_asc";f(n=>(n.set("sort",t),n))},children:["User ",c.get("sort")?.includes("name")&&(c.get("sort")?.includes("desc")?"↓":"↑")]}),e.jsx("div",{className:"col-span-3",children:"Email"}),e.jsx("div",{className:"col-span-2",children:"Role"}),e.jsxs("div",{className:"col-span-2 flex items-center gap-1 cursor-pointer hover:text-zinc-700",onClick:()=>{const t=c.get("sort")==="joined_asc"?"joined_desc":"joined_asc";f(n=>(n.set("sort",t),n))},children:["Joined ",c.get("sort")?.includes("joined")&&(c.get("sort")?.includes("desc")?"↓":"↑")]}),e.jsx("div",{className:"col-span-1 text-right",children:"Actions"})]}),j&&k?Object.entries(k).map(([s,t])=>e.jsxs("div",{className:"border-b border-zinc-100 last:border-0",children:[e.jsxs("div",{className:"p-3 bg-zinc-50/50 flex items-center gap-2 cursor-pointer hover:bg-zinc-100 transition-colors",onClick:()=>T(s),children:[e.jsx("div",{className:"w-4 h-4 flex items-center justify-center text-zinc-400",children:y.has(s)?"▼":"▶"}),e.jsx("span",{className:"font-semibold text-zinc-700 text-sm",children:t.tenant.name}),e.jsx("span",{className:"text-xs text-zinc-400 bg-white border border-zinc-200 px-1.5 py-0.5 rounded-full",children:t.users.length})]}),y.has(s)&&e.jsx("div",{children:t.users.map(n=>e.jsx(A,{user:n,selected:a.has(n.id),toggle:()=>S(n.id),contextRole:n.contextRole,showCheckbox:!1},`${n.id}-${s}`))})]},s)):h.map(s=>e.jsx(A,{user:s,selected:a.has(s.id),toggle:()=>S(s.id),showCheckbox:!0,onImpersonate:()=>R(s.id),onDelete:()=>P(s)},s.id)),h.length===0&&e.jsx("div",{className:"p-8 text-center text-zinc-500",children:"No users found matching your search."})]}),e.jsx(H,{isOpen:E,onClose:()=>N(!1),title:"Add New User",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"First Name"}),e.jsx("input",{className:"w-full border border-zinc-300 rounded-md p-2 text-sm",value:i.firstName,onChange:s=>p({...i,firstName:s.target.value}),placeholder:"Jane"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Last Name"}),e.jsx("input",{className:"w-full border border-zinc-300 rounded-md p-2 text-sm",value:i.lastName,onChange:s=>p({...i,lastName:s.target.value}),placeholder:"Doe"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Email Address"}),e.jsx("input",{className:"w-full border border-zinc-300 rounded-md p-2 text-sm",type:"email",value:i.email,onChange:s=>p({...i,email:s.target.value}),placeholder:"jane@example.com"})]}),e.jsx("div",{className:"pt-2",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-700",children:[e.jsx("input",{type:"checkbox",checked:i.isSystemAdmin,onChange:s=>p({...i,isSystemAdmin:s.target.checked}),className:"rounded border-zinc-300"}),"System Administrator (Main Platform Access)"]})}),e.jsxs("div",{className:"relative pt-4 before:content-['OR'] before:absolute before:top-2 before:left-1/2 before:-translate-x-1/2 before:bg-white before:px-2 before:text-xs before:text-zinc-400 border-t border-zinc-200",children:[e.jsx("h4",{className:"text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3 mt-2",children:"Assign to Studio (Optional)"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-zinc-500 mb-1",children:"Studio"}),e.jsxs("select",{className:"w-full border border-zinc-300 rounded-md p-2 text-sm",value:i.initialTenantId,onChange:s=>p({...i,initialTenantId:s.target.value}),children:[e.jsx("option",{value:"",children:"-- None --"}),u?.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-zinc-500 mb-1",children:"Role"}),e.jsxs("select",{className:"w-full border border-zinc-300 rounded-md p-2 text-sm bg-zinc-50",value:i.initialRole,onChange:s=>p({...i,initialRole:s.target.value}),disabled:!i.initialTenantId,children:[e.jsx("option",{value:"student",children:"Student"}),e.jsx("option",{value:"instructor",children:"Instructor"}),e.jsx("option",{value:"owner",children:"Owner"})]})]})]})]}),e.jsxs("div",{className:"pt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>N(!1),className:"px-3 py-2 text-zinc-600 hover:bg-zinc-100 rounded text-sm",children:"Cancel"}),e.jsx("button",{onClick:_,disabled:!i.email||!i.firstName,className:"px-3 py-2 bg-zinc-900 text-white hover:bg-zinc-800 rounded text-sm disabled:opacity-50",children:"Create User"})]})]})}),e.jsx(V,{isOpen:m.isOpen&&m.type==="success",onClose:()=>x({...m,isOpen:!1}),onConfirm:()=>x({...m,isOpen:!1}),title:"Success",message:m.message,confirmText:"OK",cancelText:"Close"}),e.jsx(q,{isOpen:m.isOpen&&m.type==="error",onClose:()=>x({...m,isOpen:!1}),title:"Error",message:m.message})]})});function Y({date:r}){const[o,u]=d.useState(null);return d.useEffect(()=>{if(!r){u("Never");return}u(new Date(r).toLocaleString())},[r]),o?e.jsx("span",{children:o}):e.jsx("span",{className:"text-zinc-300 animate-pulse",children:"..."})}function Q({date:r}){const[o,u]=d.useState(null);return d.useEffect(()=>{u(new Date(r).toLocaleDateString())},[r]),o?e.jsx("span",{children:o}):e.jsx("span",{className:"text-zinc-300",children:"..."})}function A({user:r,selected:o,toggle:u,showCheckbox:z,contextRole:c,onImpersonate:f,onDelete:g}){let a=`${r.profile?.firstName||""} ${r.profile?.lastName||""}`.trim();return r.email==="slichti@gmail.com"&&a==="System Admin"&&(a="Steven Lichti"),a||(a=r.email),e.jsxs("div",{className:`grid grid-cols-12 gap-4 p-4 border-b border-zinc-100 items-center hover:bg-zinc-50 transition-colors ${o?"bg-blue-50/50":""}`,children:[e.jsx("div",{className:"col-span-1 flex justify-center",children:z?e.jsx("input",{type:"checkbox",className:"rounded border-zinc-300",checked:o,onChange:u}):null}),e.jsxs("div",{className:"col-span-3 font-medium text-zinc-900 flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-zinc-200 flex items-center justify-center text-xs font-bold text-zinc-600 overflow-hidden shrink-0",children:r.profile?.portraitUrl?e.jsx("img",{src:r.profile.portraitUrl,alt:"",className:"w-full h-full object-cover"}):a[0]||"U"}),e.jsxs("div",{className:"truncate min-w-0",children:[e.jsx("div",{className:"truncate",children:a}),c&&e.jsx("div",{className:"text-xs text-zinc-400 capitalize",children:c})]})]}),e.jsx("div",{className:"col-span-3 text-zinc-600 text-sm truncate",title:r.email,children:r.email}),e.jsx("div",{className:"col-span-2",children:r.isSystemAdmin?e.jsx("span",{className:"bg-purple-100 text-purple-800 px-2 py-0.5 rounded text-xs font-bold",children:"Admin"}):e.jsx("span",{className:"text-zinc-400 text-xs",children:"User"})}),e.jsxs("div",{className:"col-span-2 text-zinc-400 text-xs flex flex-col gap-0.5",children:[e.jsx("span",{children:r.lastActiveAt?e.jsx(Y,{date:r.lastActiveAt}):"Never"}),e.jsxs("span",{className:"text-zinc-300 flex gap-1",children:["Joined ",e.jsx(Q,{date:r.createdAt})]})]}),e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:"flex gap-3 justify-end items-center",children:[f&&!r.isSystemAdmin&&e.jsx("button",{onClick:f,className:"text-zinc-500 hover:text-zinc-900 text-sm font-medium flex items-center gap-1",title:"Login As",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"12",cy:"7",r:"4"})]})}),g&&!r.isSystemAdmin&&e.jsx("button",{onClick:g,className:"text-red-400 hover:text-red-700 text-sm font-medium flex items-center gap-1",title:"Delete User",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),e.jsx(W,{to:`/admin/users/${r.id}`,className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"Edit"})]})})]})}export{ae as default};
