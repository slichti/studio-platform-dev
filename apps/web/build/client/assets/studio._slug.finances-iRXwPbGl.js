import{w as L,e as B}from"./chunk-JMJ3UQ3L-BFmd18Yu.js";import{j as e}from"./vendor-puck-DM_I7lvc.js";import{a as d}from"./api-D1U4i9fn.js";import{a as n}from"./vendor-livekit-D3VpklN2.js";import{u as Y}from"./chunk-OT5FTIRN-BoMpxN7p.js";import"./index-DYRzKbRc.js";import"./index-7UaQKl4K.js";const W=L(function(){const{tenant:l,member:U,roles:S}=B(),o=S.includes("owner");if(!o)return e.jsx("div",{className:"p-8 text-center text-zinc-500 dark:text-zinc-400",children:"You do not have permission to view this page."});const R=()=>{const t="https://studio-platform-api.slichti.workers.dev";window.location.href=`${t}/studios/stripe/connect?tenantId=${l.id}`},{getToken:c}=Y(),[x,C]=n.useState(null),[f,$]=n.useState([]),[h,A]=n.useState(null);n.useEffect(()=>{if(!l.stripeAccountId||!o)return;(async()=>{const i=await c(),r="https://studio-platform-api.slichti.workers.dev";d(`${r}/commerce/stats`,i).then(s=>{s&&C(s)}),d(`${r}/commerce/transactions`,i).then(s=>{s&&s.transactions&&$(s.transactions)}),d(`${r}/commerce/balance`,i).then(s=>{s&&!s.error&&A(s)})})()},[l.id,o,c]);const[m,b]=n.useState("overview"),[u,z]=n.useState([]),[g,j]=n.useState(null);n.useEffect(()=>{m==="failed"&&o&&(async()=>{const i=await c(),s=await d("https://studio-platform-api.slichti.workers.dev/failed-payments",i);s?.payments&&z(s.payments)})()},[m,o,c]);const F=async t=>{if(confirm("Attempt to charge the customer's payment method now?")){j(t);try{const i=await c(),s=await d(`https://studio-platform-api.slichti.workers.dev/failed-payments/${t}/retry`,i,{method:"POST"});s.success?(alert(`Payment successful! (Status: ${s.status})`),z(I=>I.filter(M=>M.id!==t))):alert(s.error||"Retry failed")}catch{alert("Error processing retry")}finally{j(null)}}},[a,P]=n.useState(null),[D,p]=n.useState(!1),[N,y]=n.useState(""),[k,T]=n.useState(""),[v,w]=n.useState(!1),O=t=>{P(t),y((t.amount/100).toFixed(2)),p(!0)},E=async()=>{if(!a)return;w(!0);const t=await c();let i="pos";a.description?.includes("Pack")&&(i="pack"),a.description?.includes("Membership")&&(i="membership");const r=await d("https://studio-platform-api.slichti.workers.dev/refunds",t,{method:"POST",body:JSON.stringify({amount:Math.round(parseFloat(N)*100),reason:k,referenceId:a.id,type:a.type||i})});w(!1),r&&!r.error?(alert("Refund processed successfully"),p(!1)):alert(r?.error||"Refund failed")};return e.jsxs("div",{className:"max-w-4xl text-zinc-900 dark:text-zinc-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Finances"}),e.jsxs("div",{className:"flex bg-zinc-100 dark:bg-zinc-800 p-1 rounded-lg",children:[e.jsx("button",{onClick:()=>b("overview"),className:`px-4 py-1.5 text-sm font-medium rounded-md transition ${m==="overview"?"bg-white dark:bg-black shadow-sm text-zinc-900 dark:text-zinc-100":"text-zinc-500 hover:text-zinc-700"}`,children:"Overview"}),e.jsxs("button",{onClick:()=>b("failed"),className:`px-4 py-1.5 text-sm font-medium rounded-md transition flex items-center gap-2 ${m==="failed"?"bg-white dark:bg-black shadow-sm text-zinc-900 dark:text-zinc-100":"text-zinc-500 hover:text-zinc-700"}`,children:["Failed Payments",u.length>0&&e.jsx("span",{className:"w-5 h-5 flex items-center justify-center bg-red-100 text-red-600 text-xs rounded-full",children:u.length})]})]})]}),D&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 rounded-xl shadow-xl border border-zinc-200 dark:border-zinc-800 w-full max-w-md p-6 animate-in fade-in zoom-in duration-200",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Process Refund"}),e.jsxs("p",{className:"text-sm text-zinc-500 mb-6",children:["Refund for ",a?.description," on ",new Date(a?.date).toLocaleDateString()]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Amount ($)"}),e.jsx("input",{type:"number",value:N,onChange:t=>y(t.target.value),className:"w-full bg-zinc-50 dark:bg-zinc-800 border-none rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-200 dark:focus:ring-zinc-700"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Reason"}),e.jsx("textarea",{value:k,onChange:t=>T(t.target.value),placeholder:"Customer requested...",className:"w-full bg-zinc-50 dark:bg-zinc-800 border-none rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-200 dark:focus:ring-zinc-700"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6 justify-end",children:[e.jsx("button",{onClick:()=>p(!1),className:"px-4 py-2 text-zinc-600 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-md",children:"Cancel"}),e.jsx("button",{onClick:E,disabled:v,className:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50",children:v?"Processing...":"Confirm Refund"})]})]})}),m==="failed"?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/50",children:[e.jsx("h3",{className:"font-semibold",children:"Failed Subscription Payments"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Subscriptions currently suspended due to payment failure."})]}),u.length===0?e.jsx("div",{className:"p-12 text-center text-zinc-500",children:e.jsx("p",{children:"No failed payments found. All subscriptions are healthy."})}):e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-zinc-200 dark:border-zinc-800",children:[e.jsx("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Customer"}),e.jsx("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Plan"}),e.jsx("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Status"}),e.jsx("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Date"}),e.jsx("th",{className:"text-right px-4 py-3 font-medium text-zinc-500",children:"Action"})]})}),e.jsx("tbody",{children:u.map(t=>e.jsxs("tr",{className:"border-b last:border-0 border-zinc-200 dark:border-zinc-800",children:[e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-medium text-zinc-900 dark:text-zinc-100",children:t.member?.user?.name||"Unknown"}),e.jsx("div",{className:"text-xs text-zinc-500",children:t.member?.user?.email})]}),e.jsx("td",{className:"px-4 py-3 text-zinc-600",children:t.planId}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${t.dunningState==="failed"?"bg-red-100 text-red-800":"bg-amber-100 text-amber-800"}`,children:t.dunningState?.toUpperCase()})}),e.jsx("td",{className:"px-4 py-3 text-zinc-500",children:t.lastDunningAt?new Date(t.lastDunningAt).toLocaleDateString():"-"}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>F(t.id),disabled:g===t.id,className:"text-xs bg-zinc-900 text-white px-3 py-1.5 rounded hover:bg-zinc-800 disabled:opacity-50",children:g===t.id?"Retrying...":"Retry Payment"})})]},t.id))})]})]})}):l.stripeAccountId?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-800 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-green-100 dark:bg-green-800 flex items-center justify-center text-green-600 dark:text-green-300",children:"âœ“"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-green-800 dark:text-green-300",children:"Stripe Connected"}),e.jsx("p",{className:"text-sm text-green-600 dark:text-green-400",children:"Your account is ready to process payments."})]})]}),e.jsx("div",{className:"text-sm font-mono text-zinc-500 dark:text-zinc-400",children:l.stripeAccountId})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-lg shadow-sm",children:[e.jsx("div",{className:"text-sm font-medium mb-1 text-zinc-500 dark:text-zinc-400",children:"Total Revenue"}),e.jsxs("div",{className:"text-3xl font-bold",children:["$",x?(x.totalRevenue/100).toFixed(2):"0.00"]}),e.jsx("div",{className:"text-xs mt-2 text-zinc-500 dark:text-zinc-400",children:"Est. All Time"})]}),e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-lg shadow-sm",children:[e.jsx("div",{className:"text-sm font-medium mb-1 text-zinc-500 dark:text-zinc-400",children:"Monthly Recurring"}),e.jsxs("div",{className:"text-3xl font-bold",children:["$",x?(x.mrr/100).toFixed(2):"0.00"]}),e.jsxs("div",{className:"text-xs mt-2 text-zinc-500 dark:text-zinc-400",children:["Active Subs: ",x?.activeSubscriptions||0]})]}),e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-lg shadow-sm",children:[e.jsx("div",{className:"text-sm font-medium mb-1 text-zinc-500 dark:text-zinc-400",children:"Stripe Balance"}),e.jsxs("div",{className:"text-3xl font-bold",children:["$",h?(h.available/100).toFixed(2):"0.00"]}),e.jsxs("div",{className:"text-xs mt-2 text-zinc-500 dark:text-zinc-400",children:["Pending: $",h?(h.pending/100).toFixed(2):"0.00"]})]})]}),e.jsxs("div",{className:"p-4 rounded-lg bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800",children:[e.jsx("h3",{className:"font-semibold mb-4 text-zinc-900 dark:text-zinc-100",children:"Transaction History"}),f.length===0?e.jsx("p",{className:"text-sm text-zinc-500 dark:text-zinc-400",children:"No recent transactions."}):e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-zinc-200 dark:border-zinc-700",children:[e.jsx("th",{className:"text-left py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Date"}),e.jsx("th",{className:"text-left py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Description"}),e.jsx("th",{className:"text-left py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Customer"}),e.jsx("th",{className:"text-right py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Amount"}),e.jsx("th",{className:"text-right py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Actions"})]})}),e.jsx("tbody",{children:f.map(t=>e.jsxs("tr",{className:"border-b last:border-0 border-zinc-200 dark:border-zinc-700",children:[e.jsx("td",{className:"py-2 text-zinc-600 dark:text-zinc-400",children:new Date(t.date).toLocaleDateString()}),e.jsx("td",{className:"py-2 text-zinc-600 dark:text-zinc-400",children:t.description}),e.jsx("td",{className:"py-2 text-zinc-600 dark:text-zinc-400",children:t.customer}),e.jsxs("td",{className:"py-2 text-right text-zinc-900 dark:text-zinc-100",children:["$",(t.amount/100).toFixed(2)]}),e.jsx("td",{className:"py-2 text-right",children:e.jsx("button",{onClick:()=>O(t),className:"text-xs text-red-600 hover:text-red-700 hover:underline",children:"Refund"})})]},t.id))})]})]})]}):e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-8 rounded-lg shadow-sm text-center",children:[e.jsx("div",{className:"mb-4 text-4xl",children:"ðŸ’³"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Setup Payouts"}),e.jsx("p",{className:"mb-6 max-w-md mx-auto text-zinc-500 dark:text-zinc-400",children:"Connect with Stripe to start accepting payments for class packs and memberships. Funds will be deposited directly to your bank account."}),e.jsxs("button",{onClick:R,className:"bg-[#635BFF] text-white px-6 py-2.5 rounded-md font-medium hover:bg-[#534be0] transition-colors inline-flex items-center gap-2",children:[e.jsx("span",{children:"Connect with Stripe"}),e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 6v-2h14v16h-14v-2h-2v4h18v-20h-18v4h2zm-8 4h10v-3l6 5-6 5v-3h-10v-4z"})})]}),e.jsx("p",{className:"mt-4 text-xs text-zinc-400 dark:text-zinc-500",children:"You will be redirected to Stripe to verify your business information."})]})]})});export{W as default};
