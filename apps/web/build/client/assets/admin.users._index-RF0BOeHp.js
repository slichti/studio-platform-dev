import{w as B,u as G,a as I,f as F,b as J,F as W,L as H}from"./chunk-JMJ3UQ3L-BFmd18Yu.js";import{j as e}from"./vendor-puck-aUaaDwmz.js";import{a as w}from"./api-D1U4i9fn.js";import{a as m}from"./vendor-livekit-D3VpklN2.js";import{M as V}from"./Modal-RrMUvIY-.js";import{C as q,E as Y}from"./Dialogs-C3BiSLFk.js";import{u as K}from"./chunk-OT5FTIRN-BoMpxN7p.js";import"./index-DYRzKbRc.js";import"./index-7UaQKl4K.js";const oe=B(function(){const{users:l,tenants:p,error:y}=G(),[o,b]=I(),g=F();J();const[c,d]=m.useState(new Set),[z,U]=m.useState(!1),[v,E]=m.useState(new Set),[x,h]=m.useState({isOpen:!1,type:"success",message:""}),[D,j]=m.useState(!1),[i,f]=m.useState({firstName:"",lastName:"",email:"",isPlatformAdmin:!1,initialTenantId:"",initialRole:"student"}),u=Array.isArray(l)?l:[],S=m.useMemo(()=>{if(!z)return null;const t={};return u.forEach(s=>{s.memberships&&s.memberships.length>0?s.memberships.forEach(r=>{const a=r.tenant.id;t[a]||(t[a]={tenant:r.tenant,users:[]}),t[a].users.push({...s,contextRole:r.role})}):(t.unassigned||(t.unassigned={tenant:{id:"unassigned",name:"Unassigned / Global"},users:[]}),t.unassigned.users.push(s))}),t},[u,z]),L=t=>{t.preventDefault();const r=new FormData(t.currentTarget).get("search");b(a=>(r?a.set("search",r):a.delete("search"),a))},T=()=>{c.size===u.length?d(new Set):d(new Set(u.map(t=>t.id)))},C=t=>{const s=new Set(c);s.has(t)?s.delete(t):s.add(t),d(s)},P=t=>{const s=new Set(v);s.has(t)?s.delete(t):s.add(t),E(s)},{getToken:k,userId:A}=K(),N=async(t,s)=>{if(c.size!==0)try{const r=await k(),a=await w("/admin/users/bulk",r,{method:"PATCH",body:JSON.stringify({userIds:Array.from(c),action:t,value:s})});if(a.error)throw new Error(a.error);h({isOpen:!0,type:"success",message:`Successfully updated ${c.size} users.`}),d(new Set),g(o)}catch(r){h({isOpen:!0,type:"error",message:r.message})}},_=async()=>{if(!(!i.email||!i.firstName||!i.lastName))try{const t=await k(),s=await w("/admin/users",t,{method:"POST",body:JSON.stringify(i)});if(s.error)throw new Error(s.error);h({isOpen:!0,type:"success",message:"User created successfully."}),j(!1),f({firstName:"",lastName:"",email:"",isPlatformAdmin:!1,initialTenantId:"",initialRole:"student"}),g(o)}catch(t){h({isOpen:!0,type:"error",message:t.message})}},R=async t=>{if(confirm("Are you sure you want to sign in as this user?"))try{const s=await k(),r=await w("/admin/impersonate",s,{method:"POST",body:JSON.stringify({targetUserId:t})});if(r.error)throw new Error(r.error);if(r.token){document.cookie=`__impersonate_token=${r.token}; path=/; max-age=3600; samesite=lax; secure`;const a=u.find($=>$.id===t);a&&a.memberships&&a.memberships.length>0?window.location.href=`/studio/${a.memberships[0].tenant.slug}`:window.location.href="/dashboard"}}catch(s){h({isOpen:!0,type:"error",message:s.message})}},M=async t=>{if(confirm(`Are you sure you want to PERMANENTLY delete user ${t.email}? This cannot be undone.`))try{const s=await k(),r=await w(`/admin/users/${t.id}`,s,{method:"DELETE"});if(r.error)throw new Error(r.error);g(o)}catch(s){h({isOpen:!0,type:"error",message:s.message})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-zinc-900 dark:text-zinc-100",children:"Global User Directory"}),e.jsx("p",{className:"text-zinc-500 dark:text-zinc-400",children:"Manage all users across the platform."})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>j(!0),className:"bg-zinc-900 text-white px-4 py-2 rounded-lg hover:bg-zinc-800 font-medium text-sm flex items-center gap-2",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"Add User"]})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-between bg-white dark:bg-zinc-900 p-4 rounded-lg border border-zinc-200 dark:border-zinc-800 shadow-sm",children:[e.jsxs(W,{onSubmit:L,className:"relative w-full sm:w-96",children:[e.jsx("input",{type:"search",name:"search",defaultValue:o.get("search")||"",placeholder:"Search users...",className:"w-full pl-10 pr-4 py-2 border border-zinc-300 dark:border-zinc-700 rounded-lg focus:ring-2 focus:ring-zinc-900 dark:focus:ring-zinc-100 focus:border-transparent bg-white dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100"}),e.jsx("svg",{className:"absolute left-3 top-2.5 h-5 w-5 text-zinc-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-600 dark:text-zinc-300 font-medium",children:[e.jsx("input",{type:"checkbox",checked:z,onChange:t=>U(t.target.checked),className:"rounded border-zinc-300 dark:border-zinc-600 text-zinc-900 focus:ring-zinc-900 dark:bg-zinc-700"}),"Group by Tenant"]})})]}),c.size>0&&e.jsxs("div",{className:"fixed bottom-6 left-1/2 -translate-x-1/2 bg-zinc-900 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-6 z-50",children:[e.jsxs("span",{className:"font-medium",children:[c.size," users selected"]}),e.jsx("div",{className:"h-4 w-px bg-zinc-700"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>N("set_role","owner"),className:"hover:text-zinc-300 text-sm font-medium",children:"Make Owner"}),e.jsx("button",{onClick:()=>N("set_role","admin"),className:"hover:text-zinc-300 text-sm font-medium",children:"Make Admin"}),e.jsx("button",{onClick:()=>N("set_role","user"),className:"hover:text-zinc-300 text-sm font-medium",children:"Demote"}),e.jsx("div",{className:"w-px h-4 bg-zinc-700 mx-2"}),e.jsx("button",{onClick:()=>{confirm(`Are you sure you want to PERMANENTLY delete ${c.size} users?`)&&N("delete",!0)},className:"text-red-400 hover:text-red-300 text-sm font-medium",children:"Delete Selected"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4 p-4 border-b border-zinc-100 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/50 text-xs font-medium text-zinc-500 dark:text-zinc-400 uppercase tracking-wider items-center",children:[e.jsx("div",{className:"col-span-1 flex items-center justify-center",children:e.jsx("input",{type:"checkbox",onChange:T,checked:c.size===u.length&&u.length>0,className:"rounded border-zinc-300 dark:border-zinc-600 dark:bg-zinc-800"})}),e.jsxs("div",{className:"col-span-3 flex items-center gap-1 cursor-pointer hover:text-zinc-700 dark:hover:text-zinc-300",onClick:()=>{const s=o.get("sort")==="name_asc"?"name_desc":"name_asc";b(r=>(r.set("sort",s),r))},children:["User ",o.get("sort")?.includes("name")&&(o.get("sort")?.includes("desc")?"↓":"↑")]}),e.jsx("div",{className:"col-span-3",children:"Email"}),e.jsx("div",{className:"col-span-2",children:"Role"}),e.jsxs("div",{className:"col-span-2 flex items-center gap-1 cursor-pointer hover:text-zinc-700 dark:hover:text-zinc-300",onClick:()=>{const s=o.get("sort")==="joined_asc"?"joined_desc":"joined_asc";b(r=>(r.set("sort",s),r))},children:["Joined ",o.get("sort")?.includes("joined")&&(o.get("sort")?.includes("desc")?"↓":"↑")]}),e.jsx("div",{className:"col-span-1 text-right",children:"Actions"})]}),z&&S?Object.entries(S).map(([t,s])=>e.jsxs("div",{className:"border-b border-zinc-100 dark:border-zinc-800 last:border-0",children:[e.jsxs("div",{className:"p-3 bg-zinc-50/50 dark:bg-zinc-900/50 flex items-center gap-2 cursor-pointer hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors",onClick:()=>P(t),children:[e.jsx("div",{className:"w-4 h-4 flex items-center justify-center text-zinc-400",children:v.has(t)?"▼":"▶"}),e.jsx("span",{className:"font-semibold text-zinc-700 dark:text-zinc-300 text-sm",children:s.tenant.name}),e.jsx("span",{className:"text-xs text-zinc-400 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 px-1.5 py-0.5 rounded-full",children:s.users.length})]}),v.has(t)&&e.jsx("div",{children:s.users.map(r=>e.jsx(O,{user:r,selected:c.has(r.id),toggle:()=>C(r.id),contextRole:r.contextRole,currentUserId:A,showCheckbox:!1},`${r.id}-${t}`))})]},t)):u.map(t=>e.jsx(O,{user:t,selected:c.has(t.id),toggle:()=>C(t.id),showCheckbox:!0,currentUserId:A,onImpersonate:()=>R(t.id),onDelete:()=>M(t)},t.id)),u.length===0&&e.jsx("div",{className:"p-8 text-center text-zinc-500",children:"No users found matching your search."})]}),e.jsx(V,{isOpen:D,onClose:()=>j(!1),title:"Add New User",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1",children:"First Name"}),e.jsx("input",{className:"w-full border border-zinc-300 dark:border-zinc-700 rounded-md p-2 text-sm bg-white dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100",value:i.firstName,onChange:t=>f({...i,firstName:t.target.value}),placeholder:"Jane"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1",children:"Last Name"}),e.jsx("input",{className:"w-full border border-zinc-300 dark:border-zinc-700 rounded-md p-2 text-sm bg-white dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100",value:i.lastName,onChange:t=>f({...i,lastName:t.target.value}),placeholder:"Doe"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1",children:"Email Address"}),e.jsx("input",{className:"w-full border border-zinc-300 dark:border-zinc-700 rounded-md p-2 text-sm bg-white dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100",type:"email",value:i.email,onChange:t=>f({...i,email:t.target.value}),placeholder:"jane@example.com"})]}),e.jsx("div",{className:"pt-2",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-700 dark:text-zinc-300",children:[e.jsx("input",{type:"checkbox",checked:i.isPlatformAdmin,onChange:t=>f({...i,isPlatformAdmin:t.target.checked}),className:"rounded border-zinc-300"}),"Platform Administrator (Main Platform Access)"]})}),e.jsxs("div",{className:"relative pt-4 before:content-['OR'] before:absolute before:top-2 before:left-1/2 before:-translate-x-1/2 before:bg-white dark:before:bg-zinc-900 before:px-2 before:text-xs before:text-zinc-400 border-t border-zinc-200 dark:border-zinc-800",children:[e.jsx("h4",{className:"text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3 mt-2",children:"Assign to Studio (Optional)"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-zinc-500 dark:text-zinc-400 mb-1",children:"Studio"}),e.jsxs("select",{className:"w-full border border-zinc-300 dark:border-zinc-700 rounded-md p-2 text-sm bg-white dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100",value:i.initialTenantId,onChange:t=>f({...i,initialTenantId:t.target.value}),children:[e.jsx("option",{value:"",children:"-- None --"}),p?.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-zinc-500 dark:text-zinc-400 mb-1",children:"Role"}),e.jsxs("select",{className:"w-full border border-zinc-300 dark:border-zinc-700 rounded-md p-2 text-sm bg-zinc-50 dark:bg-zinc-800 text-zinc-900 dark:text-zinc-100",value:i.initialRole,onChange:t=>f({...i,initialRole:t.target.value}),disabled:!i.initialTenantId,children:[e.jsx("option",{value:"student",children:"Student"}),e.jsx("option",{value:"instructor",children:"Instructor"}),e.jsx("option",{value:"owner",children:"Owner"})]})]})]})]}),e.jsxs("div",{className:"pt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>j(!1),className:"px-3 py-2 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded text-sm",children:"Cancel"}),e.jsx("button",{onClick:_,disabled:!i.email||!i.firstName,className:"px-3 py-2 bg-zinc-900 text-white hover:bg-zinc-800 rounded text-sm disabled:opacity-50",children:"Create User"})]})]})}),e.jsx(q,{isOpen:x.isOpen&&x.type==="success",onClose:()=>h({...x,isOpen:!1}),onConfirm:()=>h({...x,isOpen:!1}),title:"Success",message:x.message,confirmText:"OK",cancelText:"Close"}),e.jsx(Y,{isOpen:x.isOpen&&x.type==="error",onClose:()=>h({...x,isOpen:!1}),title:"Error",message:x.message})]})});function Q({date:n}){const[l,p]=m.useState(null);return m.useEffect(()=>{if(!n){p("Never");return}p(new Date(n).toLocaleString())},[n]),l?e.jsx("span",{children:l}):e.jsx("span",{className:"text-zinc-300 animate-pulse",children:"..."})}function X({date:n}){const[l,p]=m.useState(null);return m.useEffect(()=>{p(new Date(n).toLocaleDateString())},[n]),l?e.jsx("span",{children:l}):e.jsx("span",{className:"text-zinc-300",children:"..."})}function O({user:n,selected:l,toggle:p,showCheckbox:y,currentUserId:o,contextRole:b,onImpersonate:g,onDelete:c}){let d=`${n.profile?.firstName||""} ${n.profile?.lastName||""}`.trim();return n.email==="slichti@gmail.com"&&d==="System Admin"&&(d="Steven Lichti"),d||(d=n.email),e.jsxs("div",{className:`grid grid-cols-12 gap-4 p-4 border-b border-zinc-100 dark:border-zinc-800 items-center hover:bg-zinc-50 dark:hover:bg-zinc-800/30 transition-colors ${l?"bg-blue-50/50 dark:bg-blue-900/10":""}`,children:[e.jsx("div",{className:"col-span-1 flex justify-center",children:y?e.jsx("input",{type:"checkbox",className:"rounded border-zinc-300 dark:border-zinc-700 dark:bg-zinc-800",checked:l,onChange:p}):null}),e.jsxs("div",{className:"col-span-3 font-medium text-zinc-900 dark:text-zinc-100 flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-zinc-200 dark:bg-zinc-700 flex items-center justify-center text-xs font-bold text-zinc-600 dark:text-zinc-300 overflow-hidden shrink-0",children:n.profile?.portraitUrl?e.jsx("img",{src:n.profile.portraitUrl,alt:"",className:"w-full h-full object-cover"}):d[0]||"U"}),e.jsxs("div",{className:"truncate min-w-0",children:[e.jsx("div",{className:"truncate",children:d}),b&&e.jsx("div",{className:"text-xs text-zinc-400 capitalize",children:b})]})]}),e.jsx("div",{className:"col-span-3 text-zinc-600 dark:text-zinc-400 text-sm truncate",title:n.email,children:n.email}),e.jsx("div",{className:"col-span-2",children:n.role==="owner"?e.jsx("span",{className:"bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300 px-2 py-0.5 rounded text-xs font-bold border border-amber-200 dark:border-amber-800",children:"Owner"}):n.role==="admin"||n.isPlatformAdmin===!0?e.jsx("span",{className:"bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-300 px-2 py-0.5 rounded text-xs font-bold",children:"Admin"}):e.jsx("span",{className:"text-zinc-400 dark:text-zinc-500 text-xs",children:"User"})}),e.jsxs("div",{className:"col-span-2 text-zinc-400 dark:text-zinc-500 text-xs flex flex-col gap-0.5",children:[e.jsx("span",{children:n.lastActiveAt?e.jsx(Q,{date:n.lastActiveAt}):"Never"}),e.jsxs("span",{className:"text-zinc-300 dark:text-zinc-600 flex gap-1",children:["Joined ",e.jsx(X,{date:n.createdAt})]})]}),e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:"flex gap-3 justify-end items-center",children:[g&&!n.isPlatformAdmin&&e.jsx("button",{onClick:g,className:"text-zinc-500 hover:text-zinc-900 text-sm font-medium flex items-center gap-1",title:"Login As",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"12",cy:"7",r:"4"})]})}),c&&n.id!==o&&e.jsx("button",{onClick:c,className:"text-red-400 hover:text-red-700 text-sm font-medium flex items-center gap-1",title:"Delete User",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),e.jsx(H,{to:`/admin/users/${n.id}`,className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"Edit"})]})})]})}export{oe as default};
