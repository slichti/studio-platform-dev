import{p as q,q as W,W as H,a as o,j as e,aO as X,X as B}from"./vendor-react-D59Q0YKK.js";import{C as F}from"./ChatWindow-ByQfC7U1.js";import"./vendor-puck-RN2Ey-av.js";import"./vendor-charts-Dp-zC2wb.js";const Q=q(function(){const{apiUrl:d,tenant:n}=W(),{slug:r}=H(),[T,j]=o.useState("welcome"),[m,S]=o.useState(null),[v,N]=o.useState(!1),x=(()=>{if(!n?.chatConfig?.schedule)return!0;const{timezone:t,schedule:a}=n.chatConfig;try{const s=new Date,i=new Intl.DateTimeFormat("en-US",{timeZone:t||"UTC",weekday:"short",hour:"numeric",minute:"numeric",hour12:!1}).formatToParts(s),y=i.find(u=>u.type==="weekday")?.value,l=parseInt(i.find(u=>u.type==="hour")?.value||"0"),g=parseInt(i.find(u=>u.type==="minute")?.value||"0"),c=l*60+g;if(!y)return!0;const p=a[y];if(!p||!Array.isArray(p)||p.length!==2)return!1;const[P,I]=p,[_,M]=P.split(":").map(Number),[A,D]=I.split(":").map(Number),J=_*60+M,U=A*60+D;return c>=J&&c<U}catch(s){return console.error("Timezone Check Error",s),!0}})(),[b,k]=o.useState(""),[w,$]=o.useState(""),[h,O]=o.useState(""),[C,R]=o.useState(null);o.useEffect(()=>{const t=localStorage.getItem(`chat_session_${r}`);if(t)try{const a=JSON.parse(t);S(a),j("chat")}catch{localStorage.removeItem(`chat_session_${r}`)}},[r]);const E=async t=>{t.preventDefault(),N(!0);try{const s=await(await fetch(`${d}/guest/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:b,email:w})})).json();if(s.error)throw new Error(s.error);const f=s.token,i=s.user,l=await(await fetch(`${d}/chat/rooms`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`,"X-Tenant-Slug":r||""},body:JSON.stringify({type:"support",name:`Support: ${b}`,customer_email:w,metadata:{source:"widget",initialMessage:h},priority:"normal",routedRole:C||void 0})})).json();if(l.error)throw new Error(l.error);const g=l.id;h.trim()&&await fetch(`${d}/chat/rooms/${g}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`,"X-Tenant-Slug":r||""},body:JSON.stringify({content:h})});const c={token:f,roomId:g,user:i};S(c),localStorage.setItem(`chat_session_${r}`,JSON.stringify(c)),j("chat")}catch(a){alert("Failed to start chat: "+a.message)}finally{N(!1)}},z=()=>{window.parent.postMessage({type:"studio-chat-close"},"*")};return T==="welcome"?e.jsxs("div",{className:"h-screen w-screen bg-white flex flex-col font-sans",children:[e.jsx("div",{className:"bg-blue-600 p-4 text-white flex justify-between items-center shadow-md",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{size:20}),e.jsx("h1",{className:"font-semibold",children:"Support Chat"})]})}),e.jsxs("div",{className:"flex-1 p-6 flex flex-col justify-center",children:[e.jsx("p",{className:"text-zinc-600 mb-6 text-center",children:x?"Welcome! Please fill in your details to start a support chat with us.":`We are currently offline. Please leave a message and we'll get back to you at ${n?.chatConfig?.offlineEmail||"email"}.`}),e.jsxs("form",{onSubmit:E,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Name"}),e.jsx("input",{required:!0,className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",placeholder:"Your Name",value:b,onChange:t=>k(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Email"}),e.jsx("input",{required:!0,type:"email",className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",placeholder:"you@example.com",value:w,onChange:t=>$(t.target.value)})]}),n?.settings?.chatConfig&&Array.isArray(n.settings.chatConfig)&&n.settings.chatConfig.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Topic"}),e.jsxs("select",{className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",value:C||"",onChange:t=>R(t.target.value||null),children:[e.jsx("option",{value:"",children:"Select a topic..."}),n.settings.chatConfig.map(t=>e.jsx("option",{value:t.routeToRole||"",children:t.label},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Message"}),e.jsx("textarea",{required:!0,rows:3,className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",placeholder:"How can we help?",value:h,onChange:t=>O(t.target.value)})]}),e.jsx("button",{type:"submit",disabled:v,className:`w-full text-white font-semibold py-3 rounded-lg shadow-sm disabled:opacity-50 ${x?"bg-blue-600 hover:bg-blue-700":"bg-zinc-800 hover:bg-zinc-900"}`,children:v?"Sending...":x?"Start Chat":"Send Message"})]})]}),e.jsx("div",{className:"p-4 text-center text-xs text-zinc-400 border-t border-zinc-100",children:"Powered by Studio Platform"})]}):m?e.jsx("div",{className:"h-screen w-screen bg-white",children:e.jsxs("div",{className:"h-full flex flex-col relative",children:[e.jsx("div",{className:"absolute top-0 right-0 z-50 p-2 hidden",children:e.jsx("button",{onClick:z,children:e.jsx(B,{})})}),e.jsx(F,{roomId:m.roomId,token:m.token,currentUser:m.user,wsUrl:d,onClose:z})]})}):null});export{Q as default};
