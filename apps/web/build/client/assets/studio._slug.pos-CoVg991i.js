import{w as je,f as ye}from"./chunk-JMJ3UQ3L-Dw7tS_gO.js";import{j as e}from"./vendor-puck-By1A5E5K.js";import{a as r}from"./vendor-sentry-BD1MTpLq.js";import{a as m}from"./api-OnQO3erh.js";import{c as ve}from"./createLucideIcon-DgXJrNmH.js";import{P as Q}from"./plus-BBRn-p3b.js";import{S as Ne}from"./square-pen-DpcRMrVj.js";import{A as we}from"./archive-D-1vvCVw.js";import{X as U}from"./x-6mvJS0UK.js";import{U as ze}from"./user-B9JVtPOG.js";import{S as ne}from"./search-S3VI0n0n.js";import{T as Se}from"./trash-2-DU-4PZMS.js";import{S as Ce}from"./shopping-cart-eqO11M5U.js";import{C as ke}from"./credit-card-BC1Ru1Ky.js";import{L as Pe}from"./loader-circle-CaGZsKjo.js";const Te=[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]],L=ve("wifi",Te);var J="https://js.stripe.com/terminal/v1",Re=function(){var n=document.createElement("script");n.src=J;var i=document.head||document.body;if(!i)throw new Error("Expected document.body not to be null. Terminal requires a <body> element.");return i.appendChild(n),n},E=null,Ee=function(){return E!==null||(E=new Promise(function(n,i){if(typeof window>"u"){n(null);return}if(window.StripeTerminal){n(window.StripeTerminal);return}var u=document.querySelector('script[src="'.concat(J,'"], script[src="').concat(J,'/"]'))||Re();u.addEventListener("load",function(){window.StripeTerminal?n(window.StripeTerminal):i(new Error("StripeTerminal not available"))}),u.addEventListener("error",function(){i(new Error("Failed to load StripeTerminal"))})})),E},ie=Promise.resolve().then(Ee),ae=!1;ie.catch(function(d){ae||console.warn(d)});var Oe=function(){return ae=!0,ie};const He=je(function(){const{tenant:n,token:i,features:u}=ye()||{},[p,f]=r.useState([]),[a,o]=r.useState([]),[j,O]=r.useState(!0),[h,b]=r.useState(!1),[y,ce]=r.useState(null),[v,N]=r.useState("disconnected"),[V,le]=r.useState([]),[_,W]=r.useState(null),[oe,S]=r.useState(!1),[de,C]=r.useState(!1),[G,B]=r.useState(null),[ue,X]=r.useState(0),[l,k]=r.useState(null),[H,$]=r.useState(!1),[w,K]=r.useState(""),[me,Y]=r.useState([]),[xe,Z]=r.useState(!1),[pe,F]=r.useState(!1),[z,A]=r.useState(""),[ee,P]=r.useState(0),[te,T]=r.useState(""),[g,R]=r.useState(null);r.useEffect(()=>{fe()},[ue,n]);const fe=async()=>{try{const t=await m("/pos/products",i);t.products&&f(t.products.filter(s=>s.isActive))}catch(t){console.error(t)}finally{O(!1)}};r.useEffect(()=>{if(!n)return;(async()=>{const s=await Oe();if(!s)return;const x=s.create({onFetchConnectionToken:async()=>{const c=await m("/pos/connection-token",i,{method:"POST"});if(c.error)throw new Error(c.error);return c.secret},onUnexpectedReaderDisconnect:()=>{N("disconnected"),W(null)}});ce(x)})()},[n]);const he=async t=>{N("connecting");try{const s=await y.connectReader(t);s.reader?(W(s.reader),N("connected"),S(!1)):(console.error("Connect failed",s.error),N("disconnected"))}catch(s){console.error("Connect error",s),N("disconnected")}},be=t=>{o(s=>s.find(c=>c.productId===t.id)?s.map(c=>c.productId===t.id?{...c,quantity:c.quantity+1}:c):[...s,{productId:t.id,name:t.name,price:t.price,quantity:1}])},ge=t=>{o(s=>s.filter(x=>x.productId!==t))},M=a.reduce((t,s)=>t+s.price*s.quantity,0),se=Math.max(0,M-ee),re=async()=>{if(z){b(!0),T("");try{const t=await m("/pos/validate-coupon",i,{method:"POST",body:JSON.stringify({code:z,cartTotal:M})});t.valid?(P(t.discountAmount),R({code:z,id:t.couponId}),T("")):(T(t.error||"Invalid coupon"),P(0),R(null))}catch(t){T(t.message)}finally{b(!1)}}};r.useEffect(()=>{a.length===0?(P(0),R(null),A("")):g&&re()},[a.length]);const q=async t=>{if(a.length!==0){b(!0);try{if(t==="terminal"){if(v!=="connected"||!_){alert("Please connect a reader first."),b(!1),S(!0);return}const s=await m("/pos/process-payment",i,{method:"POST",body:JSON.stringify({items:a,customerId:l?.stripeCustomerId})});if(s.error)throw new Error(s.error);const x=s.clientSecret,c=await y.collectPaymentMethod(x);if(c.error)throw new Error(c.error.message);const D=await y.processPayment(c.paymentIntent);if(D.error)throw new Error(D.error.message);await I("card",D.paymentIntent.id,l?.id)}else t==="card"?await I("card","manual_entry",l?.id):await I("cash",null,l?.id);o([]),k(null),alert("Order Completed!"),X(s=>s+1)}catch(s){console.error(s),alert(`Checkout Failed: ${s.message}`)}finally{b(!1)}}},I=async(t,s,x)=>{await m("/pos/orders",i,{method:"POST",body:JSON.stringify({items:a,memberId:x||null,paymentMethod:t,totalAmount:se,couponCode:g?.code})})};return r.useEffect(()=>{if(!w||w.length<2){Y([]);return}const t=setTimeout(async()=>{Z(!0);try{const s=await m(`/pos/customers?query=${w}`,i);Y(s.customers||[])}catch(s){console.error(s)}finally{Z(!1)}},500);return()=>clearTimeout(t)},[w]),e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"flex-1 p-6 overflow-y-auto bg-zinc-50 dark:bg-zinc-950",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-zinc-900 dark:text-zinc-100",children:"POS & Retail"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Manage inventory and process sales."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>S(!0),className:`flex items-center gap-2 px-3 py-2 rounded-lg border text-sm transition-colors ${v==="connected"?"bg-green-50 text-green-700 border-green-200":"bg-white text-zinc-700 border-zinc-200"}`,children:[e.jsx(L,{size:16}),v==="connected"?_?.label||"Reader Connected":"Connect Reader"]}),e.jsxs("button",{onClick:()=>{B(null),C(!0)},className:"flex items-center gap-2 px-3 py-2 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 rounded-lg text-sm hover:opacity-90",children:[e.jsx(Q,{size:16})," Add Product"]})]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:p.map(t=>e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 flex flex-col gap-3 shadow-sm hover:shadow-md transition-shadow group relative",children:[e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1",children:e.jsx("button",{onClick:()=>{B(t),C(!0)},className:"p-1.5 bg-zinc-100 rounded text-zinc-600 hover:text-blue-600",children:e.jsx(Ne,{size:14})})}),e.jsx("div",{className:"aspect-square bg-zinc-100 dark:bg-zinc-800 rounded-lg flex items-center justify-center text-zinc-300",children:t.imageUrl?e.jsx("img",{src:t.imageUrl,className:"w-full h-full object-cover rounded-lg"}):e.jsx(we,{size:32})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-medium text-zinc-900 dark:text-zinc-100 truncate",children:t.name}),e.jsxs("span",{className:"text-xs font-bold bg-zinc-100 dark:bg-zinc-800 px-1.5 py-0.5 rounded text-zinc-600",children:["$",(t.price/100).toFixed(2)]})]}),e.jsx("p",{className:"text-xs text-zinc-500 truncate",children:t.category||"General"})]}),e.jsxs("div",{className:"mt-auto pt-2 flex items-center justify-between",children:[e.jsxs("span",{className:`text-xs ${t.stockQuantity>0?"text-green-600":"text-red-500"} font-medium`,children:[t.stockQuantity," in stock"]}),e.jsx("button",{onClick:()=>be(t),disabled:t.stockQuantity<=0,className:"p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(Q,{size:16})})]})]},t.id))})]}),e.jsxs("div",{className:"w-96 bg-white dark:bg-zinc-900 border-l border-zinc-200 dark:border-zinc-800 flex flex-col z-10 shadow-xl",children:[e.jsx("div",{className:"p-4 border-b border-zinc-100 dark:border-zinc-800",children:l?e.jsxs("div",{className:"flex justify-between items-center bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-200 text-blue-700 flex items-center justify-center text-xs font-bold",children:l.profile?.firstName?.[0]||l.name?.[0]||"C"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-blue-900 dark:text-blue-100",children:l.profile?`${l.profile.firstName} ${l.profile.lastName}`:l.name}),e.jsx("div",{className:"text-[10px] text-blue-600 dark:text-blue-300 truncate w-32",children:l.email})]})]}),e.jsx("button",{onClick:()=>k(null),className:"text-blue-400 hover:text-blue-600",children:e.jsx(U,{size:14})})]}):e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>$(!H),className:"w-full flex items-center justify-between px-3 py-2 bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg text-sm text-zinc-500 hover:border-blue-400 transition-colors",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(ze,{size:14})," Add Customer to Sale"]}),e.jsx(Q,{size:14})]}),H&&e.jsxs("div",{className:"absolute top-12 left-0 right-0 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg shadow-lg p-2 z-20",children:[e.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 bg-zinc-50 rounded border border-zinc-100 mb-2",children:[e.jsx(ne,{size:14,className:"text-zinc-400"}),e.jsx("input",{autoFocus:!0,className:"bg-transparent text-sm w-full outline-none",placeholder:"Search name or email...",value:w,onChange:t=>K(t.target.value)})]}),e.jsxs("div",{className:"max-h-48 overflow-y-auto space-y-1",children:[xe&&e.jsx("div",{className:"text-xs text-center p-2 text-zinc-400",children:"Searching..."}),me.map(t=>e.jsxs("button",{onClick:()=>{k(t),$(!1),K("")},className:"w-full text-left p-2 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded text-sm group",children:[e.jsx("div",{className:"font-medium",children:t.profile?`${t.profile.firstName} ${t.profile.lastName}`:t.name}),e.jsx("div",{className:"text-xs text-zinc-500",children:t.email}),t.isStripeGuest&&e.jsx("span",{className:"text-[10px] bg-indigo-50 text-indigo-600 px-1 rounded ml-auto",children:"Stripe"})]},t.id||t.stripeCustomerId)),e.jsx("button",{onClick:()=>{F(!0),$(!1)},className:"w-full text-left p-2 border-t border-zinc-100 text-blue-600 text-xs font-medium hover:bg-blue-50 rounded mt-1",children:"+ Create New Customer"})]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[a.map((t,s)=>e.jsxs("div",{className:"flex justify-between items-center group",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900 dark:text-zinc-100",children:t.name}),e.jsxs("div",{className:"text-xs text-zinc-500",children:["$",(t.price/100).toFixed(2)," x ",t.quantity]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"font-medium text-sm",children:["$",(t.price*t.quantity/100).toFixed(2)]}),e.jsx("button",{onClick:()=>ge(t.productId),className:"text-zinc-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(Se,{size:14})})]})]},s)),a.length===0&&e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-zinc-400 space-y-2 opacity-50",children:[e.jsx(Ce,{size:32}),e.jsx("span",{className:"text-sm",children:"Cart is empty"})]})]}),e.jsxs("div",{className:"p-4 border-t border-zinc-200 dark:border-zinc-800 bg-zinc-50/50 space-y-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{className:"flex-1 px-3 py-2 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg text-sm uppercase font-mono",placeholder:"PROMO CODE",value:z,onChange:t=>A(t.target.value.toUpperCase()),disabled:!!g}),g?e.jsx("button",{onClick:()=>{R(null),P(0),A("")},className:"px-3 py-2 bg-red-100 text-red-600 rounded-lg text-sm font-medium hover:bg-red-200",children:"Remove"}):e.jsx("button",{onClick:re,disabled:!z||a.length===0,className:"px-3 py-2 bg-zinc-900 dark:bg-zinc-700 text-white rounded-lg text-sm font-medium hover:opacity-90 disabled:opacity-50",children:"Apply"})]}),te&&e.jsx("div",{className:"text-xs text-red-500 font-medium",children:te}),g&&e.jsxs("div",{className:"text-xs text-green-600 font-medium flex justify-between",children:[e.jsxs("span",{children:["Coupon applied: ",g.code]})," ",e.jsxs("span",{children:["-$",(ee/100).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm text-zinc-500",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["$",(M/100).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between items-center text-lg font-bold text-zinc-900 dark:text-zinc-100",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["$",(se/100).toFixed(2)]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("button",{disabled:h||a.length===0,onClick:()=>q("card"),className:"bg-white border border-zinc-200 text-zinc-700 py-3 rounded-lg font-medium hover:bg-zinc-50 flex items-center justify-center gap-2 disabled:opacity-50",children:[e.jsx(ke,{size:16})," Manual Card"]}),e.jsx("button",{disabled:h||a.length===0,onClick:()=>q("cash"),className:"bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 disabled:opacity-50",children:"Cash"})]}),e.jsxs("button",{disabled:h||a.length===0,onClick:()=>q("terminal"),className:`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition-all ${v==="connected"?"bg-blue-600 hover:bg-blue-700 text-white shadow-blue-200 dark:shadow-blue-900/20":"bg-zinc-200 text-zinc-500 cursor-not-allowed"}`,children:[h?e.jsx(Pe,{className:"animate-spin"}):e.jsx(L,{size:20}),v==="connected"?"Charge Application":"Connect Reader to Charge"]})]})]}),de&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden p-6 space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-bold",children:G?"Edit Product":"New Product"}),e.jsx("button",{onClick:()=>C(!1),children:e.jsx(U,{size:20})})]}),e.jsx($e,{token:i,product:G,onSuccess:()=>{C(!1),X(t=>t+1)}})]})}),oe&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 w-full max-w-lg rounded-2xl shadow-2xl p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h2",{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(L,{})," Connect Reader"]}),e.jsx("button",{onClick:()=>S(!1),children:e.jsx(U,{size:20})})]}),e.jsx("div",{className:"flex flex-col gap-4 min-h-[200px]",children:V.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center space-y-4 text-center",children:[e.jsx("div",{className:"p-4 bg-zinc-100 rounded-full",children:e.jsx(ne,{size:24,className:"text-zinc-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"No Readers Found"}),e.jsx("p",{className:"text-sm text-zinc-500 max-w-xs mx-auto mt-1",children:"Make sure your WisePOS E or Verifone P630 is on, connected to WiFi, and registered in your Stripe Dashboard > Terminal."})]}),e.jsx("button",{onClick:async()=>{if(b(!0),y){const t=await y.discoverReaders({discoveryMethod:"internet",simulated:!1}).catch(s=>({error:s}));t&&t.discoveredReaders?le(t.discoveredReaders):t&&t.error&&console.error(t.error),!t||t.discoveredReaders}b(!1)},disabled:h,className:"px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium disabled:opacity-50",children:h?"Scanning...":"Scan for Readers"})]}):e.jsx("div",{className:"space-y-2",children:V.map((t,s)=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-zinc-50",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.label||t.serialNumber}),e.jsxs("div",{className:"text-xs text-zinc-500",children:[t.deviceType," â€¢ ",t.status]})]}),e.jsx("button",{onClick:()=>he(t),className:"px-3 py-1.5 bg-zinc-900 text-white rounded text-sm font-medium",children:"Connect"})]},s))})})]})}),pe&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 w-full max-w-md rounded-2xl shadow-2xl p-6",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"Create New Customer"}),e.jsx(Fe,{token:i,onSuccess:t=>{k(t),F(!1)},onCancel:()=>F(!1)})]})})]})});function $e({token:d,product:n,onSuccess:i}){const[u,p]=r.useState(!1);return e.jsxs("form",{className:"space-y-4",onSubmit:async f=>{f.preventDefault(),p(!0);const a=new FormData(f.currentTarget),o=Object.fromEntries(a);o.price=(parseFloat(o.price)*100).toString();const j={...o,price:Math.round(parseFloat(o.price)*100),stockQuantity:parseInt(o.stockQuantity),isActive:!0},O=n?`/pos/products/${n.id}`:"/pos/products";await m(O,d,{method:n?"PUT":"POST",body:JSON.stringify(j)}),p(!1),i()},children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Product Name"}),e.jsx("input",{name:"name",defaultValue:n?.name,required:!0,className:"w-full input-field border border-zinc-200 rounded p-2"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Price ($)"}),e.jsx("input",{name:"price",type:"number",step:"0.01",defaultValue:n?n.price/100:"",required:!0,className:"w-full input-field border border-zinc-200 rounded p-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Stock"}),e.jsx("input",{name:"stockQuantity",type:"number",defaultValue:n?.stockQuantity,required:!0,className:"w-full input-field border border-zinc-200 rounded p-2"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Description"}),e.jsx("textarea",{name:"description",defaultValue:n?.description,className:"w-full input-field h-20 border border-zinc-200 rounded p-2"})]}),n&&e.jsxs("div",{className:"flex justify-between items-center text-xs text-zinc-500",children:[e.jsx("span",{children:"Active product"}),e.jsx("button",{type:"button",onClick:async()=>{confirm("Archive this product?")&&(await m(`/pos/products/${n.id}/archive`,d,{method:"POST"}),i())},className:"text-red-500 hover:underline",children:"Archive Product"})]}),e.jsx("button",{disabled:u,type:"submit",className:"w-full bg-zinc-900 text-white rounded p-2 hover:bg-zinc-800",children:u?"Saving...":"Save Product"})]})}function Fe({token:d,onSuccess:n,onCancel:i}){const[u,p]=r.useState(!1);return e.jsxs("form",{className:"space-y-4",onSubmit:async f=>{f.preventDefault(),p(!0);const a=new FormData(f.currentTarget),o=Object.fromEntries(a),j=await m("/pos/customers",d,{method:"POST",body:JSON.stringify(o)});p(!1),j.customer&&n(j.customer)},children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Customer Name"}),e.jsx("input",{name:"name",required:!0,className:"w-full input-field border border-zinc-200 rounded p-2",placeholder:"Jane Doe"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Email"}),e.jsx("input",{name:"email",type:"email",required:!0,className:"w-full input-field border border-zinc-200 rounded p-2",placeholder:"jane@example.com"})]}),e.jsxs("div",{className:"flex gap-2 justify-end pt-2",children:[e.jsx("button",{type:"button",onClick:i,className:"px-4 py-2 border rounded-lg text-sm",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:u,className:"px-4 py-2 bg-blue-600 text-white rounded-lg text-sm",children:u?"Creating...":"Create Customer"})]})]})}export{He as default};
