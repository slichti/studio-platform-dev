import{w as re,u as ie,a as ae,f as oe,F as le,L as ce}from"./chunk-JZWAC4HX-Cg_gv2PJ.js";import{j as e}from"./vendor-puck-D_CB0wXL.js";import{a as A}from"./api-ChCisjdG.js";import{a as l}from"./vendor-sentry-DugYw-Ne.js";import{B as b}from"./button-CCL9t_KM.js";import{I as D,L as N}from"./label-FRIcWNYx.js";import{S as B}from"./select-Cy5Lcs6x.js";import{D as T,a as L,b as _,c as P,d as $,e as I}from"./dialog-B0FHXBPK.js";import{C as G}from"./ConfirmDialog-CNYLpd2V.js";import{u as de}from"./chunk-OT5FTIRN-BVuv9f9K.js";import"./chevron-down-vKXUNxJK.js";import"./createLucideIcon-BOpDDQ2B.js";import"./dialog-D_UahLgr.js";import"./portal-B9V3iLbl.js";import"./vendor-charts-BaZHU4KA.js";import"./x-Bbpoc0N5.js";import"./index-BNXeXtNe.js";const Ue=re(function(){const{users:d,tenants:u}=ie(),[c,v]=ae(),j=oe(),[a,p]=l.useState(new Set),[m,J]=l.useState(!1),[U,H]=l.useState(new Set),[f,h]=l.useState({isOpen:!1,type:"success",message:""}),[W,w]=l.useState(!1),[i,g]=l.useState({firstName:"",lastName:"",email:"",isPlatformAdmin:!1,initialTenantId:"",initialRole:"student"}),[k,y]=l.useState(null),[z,E]=l.useState(null),[Y,O]=l.useState(!1),x=Array.isArray(d)?d:[],R=l.useMemo(()=>{if(!m)return null;const s={};return s.platform_admins={tenant:{id:"platform_admins",name:"Platform Administrators"},users:[]},x.forEach(t=>{t.isPlatformAdmin&&s.platform_admins.users.push(t),t.memberships&&t.memberships.length>0?t.memberships.forEach(n=>{const o=n.tenant.id;s[o]||(s[o]={tenant:n.tenant,users:[]});const ne=n.roles?.[0]?.role||n.role||"member";s[o].users.push({...t,contextRole:ne})}):(s.unassigned||(s.unassigned={tenant:{id:"unassigned",name:"Unassigned / Global"},users:[]}),s.unassigned.users.push(t))}),s.platform_admins.users.length===0&&delete s.platform_admins,s},[x,m]),q=s=>{s.preventDefault();const n=new FormData(s.currentTarget).get("search");v(o=>(n?o.set("search",n):o.delete("search"),o))},Z=()=>{a.size===x.length?p(new Set):p(new Set(x.map(s=>s.id)))},M=s=>{const t=new Set(a);t.has(s)?t.delete(s):t.add(s),p(t)},K=s=>{const t=new Set(U);t.has(s)?t.delete(s):t.add(s),H(t)},{getToken:C,userId:F}=de(),S=async(s,t)=>{if(a.size!==0)try{const n=await C(),o=await A("/admin/users/bulk",n,{method:"PATCH",body:JSON.stringify({userIds:Array.from(a),action:s,value:t})});if(o.error)throw new Error(o.error);h({isOpen:!0,type:"success",title:"Start Execution",message:`Successfully updated ${a.size} users.`}),p(new Set),j(c)}catch(n){const o=n instanceof Error?n.message:"An error occurred";h({isOpen:!0,type:"error",title:"Error",message:o})}},Q=async()=>{if(!(!i.email||!i.firstName||!i.lastName))try{const s=await C(),t=await A("/admin/users",s,{method:"POST",body:JSON.stringify(i)});if(t.error)throw new Error(t.error);h({isOpen:!0,type:"success",title:"User Created",message:"User created successfully."}),w(!1),g({firstName:"",lastName:"",email:"",isPlatformAdmin:!1,initialTenantId:"",initialRole:"student"}),j(c)}catch(s){const t=s instanceof Error?s.message:"An error occurred";h({isOpen:!0,type:"error",title:"Creation Failed",message:t})}},X=async()=>{if(k)try{const s=await C(),t=await A("/admin/impersonate",s,{method:"POST",body:JSON.stringify({targetUserId:k})});if(t.error)throw new Error(t.error);if(t.token){document.cookie=`__impersonate_token=${t.token}; path=/; max-age=3600; samesite=lax; secure`;const n=x.find(o=>o.id===k);n&&n.memberships&&n.memberships.length>0?window.location.href=`/studio/${n.memberships[0].tenant.slug}`:window.location.href="/dashboard"}}catch(s){const t=s instanceof Error?s.message:"An error occurred";h({isOpen:!0,type:"error",title:"Impersonation Failed",message:t})}finally{y(null)}},ee=s=>{y(s)},se=s=>{E(s)},te=async()=>{if(z)try{const s=await C(),t=await A(`/admin/users/${z.id}`,s,{method:"DELETE"});if(t.error)throw new Error(t.error);j(c),h({isOpen:!0,type:"success",title:"User Deleted",message:`User ${z.email} has been deleted.`})}catch(s){const t=s instanceof Error?s.message:"An error occurred";h({isOpen:!0,type:"error",title:"Deletion Failed",message:t})}finally{E(null)}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-zinc-900 dark:text-zinc-100",children:"Global User Directory"}),e.jsx("p",{className:"text-zinc-500 dark:text-zinc-400",children:"Manage all users across the platform."})]}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(b,{onClick:()=>w(!0),className:"flex items-center gap-2",children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"Add User"]})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-between bg-white dark:bg-zinc-900 p-4 rounded-lg border border-zinc-200 dark:border-zinc-800 shadow-sm",children:[e.jsxs(le,{onSubmit:q,className:"relative w-full sm:w-96",children:[e.jsx(D,{type:"search",name:"search",defaultValue:c.get("search")||"",placeholder:"Search users...",className:"pl-10"}),e.jsx("svg",{className:"absolute left-3 top-2.5 h-5 w-5 text-zinc-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-600 dark:text-zinc-300 font-medium cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:m,onChange:s=>J(s.target.checked),className:"rounded border-zinc-300 dark:border-zinc-600 text-zinc-900 focus:ring-zinc-900 dark:bg-zinc-700 h-4 w-4"}),"Group by Tenant"]})})]}),a.size>0&&e.jsxs("div",{className:"fixed bottom-6 left-1/2 -translate-x-1/2 bg-zinc-900 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-6 z-50 animate-in slide-in-from-bottom-4",children:[e.jsxs("span",{className:"font-medium",children:[a.size," users selected"]}),e.jsx("div",{className:"h-4 w-px bg-zinc-700"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>S("set_role","owner"),className:"hover:text-zinc-300 text-sm font-medium transition-colors",children:"Make Owner"}),e.jsx("button",{onClick:()=>S("set_role","admin"),className:"hover:text-zinc-300 text-sm font-medium transition-colors",children:"Make Admin"}),e.jsx("button",{onClick:()=>S("set_role","user"),className:"hover:text-zinc-300 text-sm font-medium transition-colors",children:"Demote"}),e.jsx("div",{className:"w-px h-4 bg-zinc-700 mx-2"}),e.jsx("button",{onClick:()=>O(!0),className:"text-red-400 hover:text-red-300 text-sm font-medium transition-colors",children:"Delete Selected"})]})]}),e.jsxs("div",{className:"bg-white dark:bg-zinc-900 rounded-lg border border-zinc-200 dark:border-zinc-800 overflow-hidden shadow-sm",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4 p-4 border-b border-zinc-100 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/50 text-xs font-medium text-zinc-500 dark:text-zinc-400 uppercase tracking-wider items-center",children:[e.jsx("div",{className:"col-span-1 flex items-center justify-center",children:e.jsx("input",{type:"checkbox",onChange:Z,checked:a.size===x.length&&x.length>0,className:"rounded border-zinc-300 dark:border-zinc-600 dark:bg-zinc-800 h-4 w-4"})}),e.jsxs("div",{className:"col-span-3 flex items-center gap-1 cursor-pointer hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors",onClick:()=>{const t=c.get("sort")==="name_asc"?"name_desc":"name_asc";v(n=>(n.set("sort",t),n))},children:["User ",c.get("sort")?.includes("name")&&(c.get("sort")?.includes("desc")?"↓":"↑")]}),e.jsx("div",{className:"col-span-3",children:"Email"}),e.jsx("div",{className:"col-span-2",children:"Role"}),e.jsxs("div",{className:"col-span-2 flex items-center gap-1 cursor-pointer hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors",onClick:()=>{const t=c.get("sort")==="joined_asc"?"joined_desc":"joined_asc";v(n=>(n.set("sort",t),n))},children:["Joined ",c.get("sort")?.includes("joined")&&(c.get("sort")?.includes("desc")?"↓":"↑")]}),e.jsx("div",{className:"col-span-1",children:"MFA"}),e.jsx("div",{className:"col-span-1 text-right",children:"Actions"})]}),m&&R?Object.entries(R).map(([s,t])=>e.jsxs("div",{className:"border-b border-zinc-100 dark:border-zinc-800 last:border-0",children:[e.jsxs("div",{className:"p-3 bg-zinc-50/50 dark:bg-zinc-900/50 flex items-center gap-2 cursor-pointer hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors",onClick:()=>K(s),children:[e.jsx("div",{className:"w-4 h-4 flex items-center justify-center text-zinc-400",children:U.has(s)?"▼":"▶"}),e.jsx("span",{className:"font-semibold text-zinc-700 dark:text-zinc-300 text-sm",children:t.tenant.name}),e.jsx("span",{className:"text-xs text-zinc-400 bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 px-1.5 py-0.5 rounded-full",children:t.users.length})]}),U.has(s)&&e.jsx("div",{children:t.users.map(n=>e.jsx(V,{user:n,selected:a.has(n.id),toggle:()=>M(n.id),contextRole:n.contextRole,currentUserId:F,showCheckbox:!0},`${n.id}-${s}`))})]},s)):x.map(s=>e.jsx(V,{user:s,selected:a.has(s.id),toggle:()=>M(s.id),showCheckbox:!0,currentUserId:F,onImpersonate:()=>ee(s.id),onDelete:()=>se(s)},s.id)),x.length===0&&e.jsx("div",{className:"p-8 text-center text-zinc-500",children:"No users found matching your search."})]}),e.jsx(T,{open:W,onOpenChange:w,children:e.jsxs(L,{children:[e.jsxs(_,{children:[e.jsx(P,{children:"Add New User"}),e.jsx($,{children:"Create a new user profile manually."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{children:"First Name"}),e.jsx(D,{value:i.firstName,onChange:s=>g({...i,firstName:s.target.value}),placeholder:"Jane"})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Last Name"}),e.jsx(D,{value:i.lastName,onChange:s=>g({...i,lastName:s.target.value}),placeholder:"Doe"})]})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Email Address"}),e.jsx(D,{type:"email",value:i.email,onChange:s=>g({...i,email:s.target.value}),placeholder:"jane@example.com"})]}),e.jsx("div",{className:"pt-2",children:e.jsxs("label",{className:"flex items-center gap-2 text-sm text-zinc-700 dark:text-zinc-300 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:i.isPlatformAdmin,onChange:s=>g({...i,isPlatformAdmin:s.target.checked}),className:"rounded border-zinc-300"}),"Platform Administrator (Main Platform Access)"]})}),e.jsxs("div",{className:"relative pt-4 before:content-['OR'] before:absolute before:top-2 before:left-1/2 before:-translate-x-1/2 before:bg-white dark:before:bg-zinc-900 before:px-2 before:text-xs before:text-zinc-400 border-t border-zinc-200 dark:border-zinc-800",children:[e.jsx("h4",{className:"text-xs font-semibold text-zinc-500 uppercase tracking-wider mb-3 mt-2",children:"Assign to Studio (Optional)"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx(N,{className:"text-xs text-zinc-500 dark:text-zinc-400 mb-1",children:"Studio"}),e.jsxs(B,{value:i.initialTenantId,onChange:s=>g({...i,initialTenantId:s.target.value}),children:[e.jsx("option",{value:"",children:"-- None --"}),u?.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx(N,{className:"text-xs text-zinc-500 dark:text-zinc-400 mb-1",children:"Role"}),e.jsxs(B,{value:i.initialRole,onChange:s=>g({...i,initialRole:s.target.value}),disabled:!i.initialTenantId,children:[e.jsx("option",{value:"student",children:"Student"}),e.jsx("option",{value:"instructor",children:"Instructor"}),e.jsx("option",{value:"admin",children:"Admin"}),e.jsx("option",{value:"owner",children:"Owner"})]})]})]})]})]}),e.jsxs(I,{children:[e.jsx(b,{variant:"outline",onClick:()=>w(!1),children:"Cancel"}),e.jsx(b,{onClick:Q,disabled:!i.email||!i.firstName,children:"Create User"})]})]})}),e.jsx(T,{open:f.isOpen,onOpenChange:s=>h({...f,isOpen:s}),children:e.jsxs(L,{children:[e.jsx(_,{children:e.jsx(P,{className:f.type==="error"?"text-red-500":"text-green-500",children:f.title||(f.type==="error"?"Error":"Success")})}),e.jsx("div",{className:"py-4 text-zinc-600 dark:text-zinc-300",children:f.message}),e.jsx(I,{children:e.jsx(b,{onClick:()=>h({...f,isOpen:!1}),children:"Close"})})]})}),e.jsx(G,{open:!!z,onOpenChange:s=>!s&&E(null),onConfirm:te,title:"Delete User",description:e.jsxs(e.Fragment,{children:["Are you sure you want to PERMANENTLY delete user ",e.jsx("strong",{children:z?.email}),"? This cannot be undone."]}),confirmText:"Delete",variant:"destructive"}),e.jsx(G,{open:Y,onOpenChange:O,onConfirm:()=>{S("delete",!0),O(!1)},title:"Delete Multiple Users",description:`Are you sure you want to PERMANENTLY delete ${a.size} users? This action cannot be undone.`,confirmText:"Delete Users",variant:"destructive"}),e.jsx(T,{open:!!k,onOpenChange:s=>!s&&y(null),children:e.jsxs(L,{children:[e.jsxs(_,{children:[e.jsx(P,{children:"Confirm Impersonation"}),e.jsx($,{children:"You are about to sign in as another user. This action will be logged."})]}),e.jsxs("div",{className:"py-4 text-zinc-600 dark:text-zinc-300",children:[e.jsxs("p",{children:["Are you sure you want to sign in as ",e.jsx("strong",{children:x.find(s=>s.id===k)?.email}),"?"]}),e.jsx("p",{className:"mt-2 text-xs text-zinc-500",children:"You will need to log out to return to your admin account."})]}),e.jsxs(I,{children:[e.jsx(b,{variant:"outline",onClick:()=>y(null),children:"Cancel"}),e.jsx(b,{onClick:X,children:"Sign In as User"})]})]})})]})});function me({date:r}){const[d,u]=l.useState(null);return l.useEffect(()=>{if(!r){u("Never");return}u(new Date(r).toLocaleString())},[r]),d?e.jsx("span",{children:d}):e.jsx("span",{className:"text-zinc-300 animate-pulse",children:"..."})}function xe({date:r}){const[d,u]=l.useState(null);return l.useEffect(()=>{u(new Date(r).toLocaleDateString())},[r]),d?e.jsx("span",{children:d}):e.jsx("span",{className:"text-zinc-300",children:"..."})}function V({user:r,selected:d,toggle:u,showCheckbox:c,currentUserId:v,contextRole:j,onImpersonate:a,onDelete:p}){let m=`${r.profile?.firstName||""} ${r.profile?.lastName||""}`.trim();return r.email==="slichti@gmail.com"&&m==="System Admin"&&(m="Steven Lichti"),m||(m=r.email),e.jsxs("div",{className:`grid grid-cols-12 gap-4 p-4 border-b border-zinc-100 dark:border-zinc-800 items-center hover:bg-zinc-50 dark:hover:bg-zinc-800/30 transition-colors ${d?"bg-blue-50/50 dark:bg-blue-900/10":""}`,children:[e.jsx("div",{className:"col-span-1 flex justify-center",children:c?e.jsx("input",{type:"checkbox",className:"rounded border-zinc-300 dark:border-zinc-700 dark:bg-zinc-800 h-4 w-4",checked:d,onChange:u}):null}),e.jsxs("div",{className:"col-span-3 font-medium text-zinc-900 dark:text-zinc-100 flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-zinc-200 dark:bg-zinc-700 flex items-center justify-center text-xs font-bold text-zinc-600 dark:text-zinc-300 overflow-hidden shrink-0",children:r.profile?.portraitUrl?e.jsx("img",{src:r.profile.portraitUrl,alt:"",className:"w-full h-full object-cover"}):m[0]||"U"}),e.jsxs("div",{className:"truncate min-w-0",children:[e.jsx("div",{className:"truncate",children:m}),j&&e.jsx("div",{className:"text-xs text-zinc-400 capitalize",children:j})]})]}),e.jsx("div",{className:"col-span-3 text-zinc-600 dark:text-zinc-400 text-sm truncate",title:r.email,children:r.email}),e.jsx("div",{className:"col-span-2",children:r.role==="owner"?e.jsx("span",{className:"bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300 px-2 py-0.5 rounded text-xs font-bold border border-amber-200 dark:border-amber-800",children:"Owner"}):r.role==="admin"||r.isPlatformAdmin===!0?e.jsx("span",{className:"bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-300 px-2 py-0.5 rounded text-xs font-bold",children:"Admin"}):e.jsx("span",{className:"text-zinc-400 dark:text-zinc-500 text-xs",children:"User"})}),e.jsxs("div",{className:"col-span-2 text-zinc-400 dark:text-zinc-500 text-xs flex flex-col gap-0.5",children:[e.jsx("span",{children:r.lastActiveAt?e.jsx(me,{date:r.lastActiveAt}):"Never"}),e.jsxs("span",{className:"text-zinc-300 dark:text-zinc-600 flex gap-1",children:["Joined ",e.jsx(xe,{date:r.createdAt})]})]}),e.jsx("div",{className:"col-span-1 flex items-center",children:r.mfaEnabled?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20 dark:bg-green-400/10 dark:text-green-400 dark:ring-green-400/20",title:"MFA Enabled",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 16 16",fill:"currentColor",className:"w-3 h-3",children:e.jsx("path",{fillRule:"evenodd",d:"M8 1a3.5 3.5 0 0 0-3.5 3.5V7A1.5 1.5 0 0 0 3 8.5v5A1.5 1.5 0 0 0 4.5 15h7a1.5 1.5 0 0 0 1.5-1.5v-5A1.5 1.5 0 0 0 11.5 7V4.5A3.5 3.5 0 0 0 8 1Zm2 6V4.5a2 2 0 1 0-4 0V7h4Z",clipRule:"evenodd"})}),"MFA"]}):e.jsx("span",{className:"inline-flex items-center gap-1 rounded-full bg-zinc-50 px-2 py-1 text-xs font-medium text-zinc-600 ring-1 ring-inset ring-zinc-500/10 dark:bg-zinc-400/10 dark:text-zinc-400 dark:ring-zinc-400/20 opacity-50",children:"None"})}),e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:"flex gap-3 justify-end items-center",children:[a&&!r.isPlatformAdmin&&e.jsx("button",{onClick:a,className:"text-zinc-500 hover:text-zinc-900 text-sm font-medium flex items-center gap-1",title:"Login As",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"}),e.jsx("circle",{cx:"12",cy:"7",r:"4"})]})}),p&&r.id!==v&&e.jsx("button",{onClick:p,className:"text-red-400 hover:text-red-700 text-sm font-medium flex items-center gap-1",title:"Delete User",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),e.jsx(ce,{to:`/admin/users/${r.id}`,className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:"Edit"})]})})]})}export{Ue as default};
