import{r as f,w as Lu,d as Nu}from"./chunk-JMJ3UQ3L-OilvkdUQ.js";import{j as Jn}from"./jsx-runtime-u17CrQMm.js";import{a as Uu}from"./api-D1U4i9fn.js";import{u as Fu}from"./chunk-OT5FTIRN-D5dr37rt.js";import"./index-WmvJLO_A.js";import"./index-B3-eZQPY.js";var eo={};function ju(n,e){return e.forEach(function(t){t&&typeof t!="string"&&!Array.isArray(t)&&Object.keys(t).forEach(function(i){if(i!=="default"&&!(i in n)){var r=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(n,i,r.get?r:{enumerable:!0,get:function(){return t[i]}})}})}),Object.freeze(n)}var Bu=Object.defineProperty,Vu=(n,e,t)=>e in n?Bu(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,to=(n,e,t)=>Vu(n,typeof e!="symbol"?e+"":e,t);class ke{constructor(){to(this,"_locking"),to(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let e;const t=new Promise(r=>e=()=>{this._locks-=1,r()}),i=this._locking.then(()=>e);return this._locking=this._locking.then(()=>t),i}}function ne(n,e){if(!n)throw new Error(e)}const qu=34028234663852886e22,Wu=-34028234663852886e22,Hu=4294967295,Ku=2147483647,zu=-2147483648;function ni(n){if(typeof n!="number")throw new Error("invalid int 32: "+typeof n);if(!Number.isInteger(n)||n>Ku||n<zu)throw new Error("invalid int 32: "+n)}function _r(n){if(typeof n!="number")throw new Error("invalid uint 32: "+typeof n);if(!Number.isInteger(n)||n>Hu||n<0)throw new Error("invalid uint 32: "+n)}function Ba(n){if(typeof n!="number")throw new Error("invalid float 32: "+typeof n);if(Number.isFinite(n)&&(n>qu||n<Wu))throw new Error("invalid float 32: "+n)}const Va=Symbol("@bufbuild/protobuf/enum-type");function Gu(n){const e=n[Va];return ne(e,"missing enum type on enum object"),e}function qa(n,e,t,i){n[Va]=Wa(e,t.map(r=>({no:r.no,name:r.name,localName:n[r.no]})))}function Wa(n,e,t){const i=Object.create(null),r=Object.create(null),s=[];for(const a of e){const o=Ha(a);s.push(o),i[a.name]=o,r[a.no]=o}return{typeName:n,values:s,findName(a){return i[a]},findNumber(a){return r[a]}}}function Ju(n,e,t){const i={};for(const r of e){const s=Ha(r);i[s.localName]=s.no,i[s.no]=s.localName}return qa(i,n,e),i}function Ha(n){return"localName"in n?n:Object.assign(Object.assign({},n),{localName:n.name})}class ls{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const i=this.getType(),r=i.runtime.bin,s=r.makeReadOptions(t);return r.readMessage(this,s.readerFactory(e),e.byteLength,s),this}fromJson(e,t){const i=this.getType(),r=i.runtime.json,s=r.makeReadOptions(t);return r.readMessage(i,e,s,this),this}fromJsonString(e,t){let i;try{i=JSON.parse(e)}catch(r){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(r instanceof Error?r.message:String(r)))}return this.fromJson(i,t)}toBinary(e){const t=this.getType(),i=t.runtime.bin,r=i.makeWriteOptions(e),s=r.writerFactory();return i.writeMessage(this,s,r),s.finish()}toJson(e){const t=this.getType(),i=t.runtime.json,r=i.makeWriteOptions(e);return i.writeMessage(this,r)}toJsonString(e){var t;const i=this.toJson(e);return JSON.stringify(i,null,(t=e?.prettySpaces)!==null&&t!==void 0?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function $u(n,e,t,i){var r;const s=(r=i?.localName)!==null&&r!==void 0?r:e.substring(e.lastIndexOf(".")+1),a={[s]:function(o){n.util.initFields(this),n.util.initPartial(o,this)}}[s];return Object.setPrototypeOf(a.prototype,new ls),Object.assign(a,{runtime:n,typeName:e,fields:n.util.newFieldList(t),fromBinary(o,c){return new a().fromBinary(o,c)},fromJson(o,c){return new a().fromJson(o,c)},fromJsonString(o,c){return new a().fromJsonString(o,c)},equals(o,c){return n.util.equals(a,o,c)}}),a}function Qu(){let n=0,e=0;for(let i=0;i<28;i+=7){let r=this.buf[this.pos++];if(n|=(r&127)<<i,(r&128)==0)return this.assertBounds(),[n,e]}let t=this.buf[this.pos++];if(n|=(t&15)<<28,e=(t&112)>>4,(t&128)==0)return this.assertBounds(),[n,e];for(let i=3;i<=31;i+=7){let r=this.buf[this.pos++];if(e|=(r&127)<<i,(r&128)==0)return this.assertBounds(),[n,e]}throw new Error("invalid varint")}function ir(n,e,t){for(let s=0;s<28;s=s+7){const a=n>>>s,o=!(!(a>>>7)&&e==0),c=(o?a|128:a)&255;if(t.push(c),!o)return}const i=n>>>28&15|(e&7)<<4,r=e>>3!=0;if(t.push((r?i|128:i)&255),!!r){for(let s=3;s<31;s=s+7){const a=e>>>s,o=!!(a>>>7),c=(o?a|128:a)&255;if(t.push(c),!o)return}t.push(e>>>31&1)}}const ii=4294967296;function no(n){const e=n[0]==="-";e&&(n=n.slice(1));const t=1e6;let i=0,r=0;function s(a,o){const c=Number(n.slice(a,o));r*=t,i=i*t+c,i>=ii&&(r=r+(i/ii|0),i=i%ii)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),e?za(i,r):us(i,r)}function Yu(n,e){let t=us(n,e);const i=t.hi&2147483648;i&&(t=za(t.lo,t.hi));const r=Ka(t.lo,t.hi);return i?"-"+r:r}function Ka(n,e){if({lo:n,hi:e}=Xu(n,e),e<=2097151)return String(ii*e+n);const t=n&16777215,i=(n>>>24|e<<8)&16777215,r=e>>16&65535;let s=t+i*6777216+r*6710656,a=i+r*8147497,o=r*2;const c=1e7;return s>=c&&(a+=Math.floor(s/c),s%=c),a>=c&&(o+=Math.floor(a/c),a%=c),o.toString()+io(a)+io(s)}function Xu(n,e){return{lo:n>>>0,hi:e>>>0}}function us(n,e){return{lo:n|0,hi:e|0}}function za(n,e){return e=~e,n?n=~n+1:e+=1,us(n,e)}const io=n=>{const e=String(n);return"0000000".slice(e.length)+e};function ro(n,e){if(n>=0){for(;n>127;)e.push(n&127|128),n=n>>>7;e.push(n)}else{for(let t=0;t<9;t++)e.push(n&127|128),n=n>>7;e.push(1)}}function Zu(){let n=this.buf[this.pos++],e=n&127;if((n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<7,(n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<14,(n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<21,(n&128)==0)return this.assertBounds(),e;n=this.buf[this.pos++],e|=(n&15)<<28;for(let t=5;(n&128)!==0&&t<10;t++)n=this.buf[this.pos++];if((n&128)!=0)throw new Error("invalid varint");return this.assertBounds(),e>>>0}function ed(){const n=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof n.getBigInt64=="function"&&typeof n.getBigUint64=="function"&&typeof n.setBigInt64=="function"&&typeof n.setBigUint64=="function"&&(typeof process!="object"||typeof eo!="object"||eo.BUF_BIGINT_DISABLE!=="1")){const r=BigInt("-9223372036854775808"),s=BigInt("9223372036854775807"),a=BigInt("0"),o=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>s||l<r)throw new Error("int64 invalid: ".concat(c));return l},uParse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>o||l<a)throw new Error("uint64 invalid: ".concat(c));return l},enc(c){return n.setBigInt64(0,this.parse(c),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},uEnc(c){return n.setBigInt64(0,this.uParse(c),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},dec(c,l){return n.setInt32(0,c,!0),n.setInt32(4,l,!0),n.getBigInt64(0,!0)},uDec(c,l){return n.setInt32(0,c,!0),n.setInt32(4,l,!0),n.getBigUint64(0,!0)}}}const t=r=>ne(/^-?[0-9]+$/.test(r),"int64 invalid: ".concat(r)),i=r=>ne(/^[0-9]+$/.test(r),"uint64 invalid: ".concat(r));return{zero:"0",supported:!1,parse(r){return typeof r!="string"&&(r=r.toString()),t(r),r},uParse(r){return typeof r!="string"&&(r=r.toString()),i(r),r},enc(r){return typeof r!="string"&&(r=r.toString()),t(r),no(r)},uEnc(r){return typeof r!="string"&&(r=r.toString()),i(r),no(r)},dec(r,s){return Yu(r,s)},uDec(r,s){return Ka(r,s)}}}const Z=ed();var A;(function(n){n[n.DOUBLE=1]="DOUBLE",n[n.FLOAT=2]="FLOAT",n[n.INT64=3]="INT64",n[n.UINT64=4]="UINT64",n[n.INT32=5]="INT32",n[n.FIXED64=6]="FIXED64",n[n.FIXED32=7]="FIXED32",n[n.BOOL=8]="BOOL",n[n.STRING=9]="STRING",n[n.BYTES=12]="BYTES",n[n.UINT32=13]="UINT32",n[n.SFIXED32=15]="SFIXED32",n[n.SFIXED64=16]="SFIXED64",n[n.SINT32=17]="SINT32",n[n.SINT64=18]="SINT64"})(A||(A={}));var It;(function(n){n[n.BIGINT=0]="BIGINT",n[n.STRING=1]="STRING"})(It||(It={}));function yt(n,e,t){if(e===t)return!0;if(n==A.BYTES){if(!(e instanceof Uint8Array)||!(t instanceof Uint8Array)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}switch(n){case A.UINT64:case A.FIXED64:case A.INT64:case A.SFIXED64:case A.SINT64:return e==t}return!1}function un(n,e){switch(n){case A.BOOL:return!1;case A.UINT64:case A.FIXED64:case A.INT64:case A.SFIXED64:case A.SINT64:return e==0?Z.zero:"0";case A.DOUBLE:case A.FLOAT:return 0;case A.BYTES:return new Uint8Array(0);case A.STRING:return"";default:return 0}}function Ga(n,e){switch(n){case A.BOOL:return e===!1;case A.STRING:return e==="";case A.BYTES:return e instanceof Uint8Array&&!e.byteLength;default:return e==0}}var se;(function(n){n[n.Varint=0]="Varint",n[n.Bit64=1]="Bit64",n[n.LengthDelimited=2]="LengthDelimited",n[n.StartGroup=3]="StartGroup",n[n.EndGroup=4]="EndGroup",n[n.Bit32=5]="Bit32"})(se||(se={}));class td{constructor(e){this.stack=[],this.textEncoder=e??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let r=0;r<this.chunks.length;r++)e+=this.chunks[r].length;let t=new Uint8Array(e),i=0;for(let r=0;r<this.chunks.length;r++)t.set(this.chunks[r],i),i+=this.chunks[r].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(_r(e);e>127;)this.buf.push(e&127|128),e=e>>>7;return this.buf.push(e),this}int32(e){return ni(e),ro(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){Ba(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){_r(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){ni(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return ni(e),e=(e<<1^e>>31)>>>0,ro(e,this.buf),this}sfixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),r=Z.enc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),r=Z.uEnc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(t)}int64(e){let t=Z.enc(e);return ir(t.lo,t.hi,this.buf),this}sint64(e){let t=Z.enc(e),i=t.hi>>31,r=t.lo<<1^i,s=(t.hi<<1|t.lo>>>31)^i;return ir(r,s,this.buf),this}uint64(e){let t=Z.uEnc(e);return ir(t.lo,t.hi,this.buf),this}}class nd{constructor(e,t){this.varint64=Qu,this.uint32=Zu,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=t??new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,i=e&7;if(t<=0||i<0||i>5)throw new Error("illegal tag: field no "+t+" wire type "+i);return[t,i]}skip(e,t){let i=this.pos;switch(e){case se.Varint:for(;this.buf[this.pos++]&128;);break;case se.Bit64:this.pos+=4;case se.Bit32:this.pos+=4;break;case se.LengthDelimited:let r=this.uint32();this.pos+=r;break;case se.StartGroup:for(;;){const[s,a]=this.tag();if(a===se.EndGroup){if(t!==void 0&&s!==t)throw new Error("invalid end group tag");break}this.skip(a,s)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(i,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return Z.dec(...this.varint64())}uint64(){return Z.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),i=-(e&1);return e=(e>>>1|(t&1)<<31)^i,t=t>>>1^i,Z.dec(e,t)}bool(){let[e,t]=this.varint64();return e!==0||t!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return Z.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return Z.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function id(n,e,t,i){let r;return{typeName:e,extendee:t,get field(){if(!r){const s=typeof i=="function"?i():i;s.name=e.split(".").pop(),s.jsonName="[".concat(e,"]"),r=n.util.newFieldList([s]).list()[0]}return r},runtime:n}}function Ja(n){const e=n.field.localName,t=Object.create(null);return t[e]=rd(n),[t,()=>t[e]]}function rd(n){const e=n.field;if(e.repeated)return[];if(e.default!==void 0)return e.default;switch(e.kind){case"enum":return e.T.values[0].no;case"scalar":return un(e.T,e.L);case"message":const t=e.T,i=new t;return t.fieldWrapper?t.fieldWrapper.unwrapField(i):i;case"map":throw"map fields are not allowed to be extensions"}}function sd(n,e){if(!e.repeated&&(e.kind=="enum"||e.kind=="scalar")){for(let t=n.length-1;t>=0;--t)if(n[t].no==e.no)return[n[t]];return[]}return n.filter(t=>t.no===e.no)}let ct="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),Ni=[];for(let n=0;n<ct.length;n++)Ni[ct[n].charCodeAt(0)]=n;Ni[45]=ct.indexOf("+");Ni[95]=ct.indexOf("/");const $a={dec(n){let e=n.length*3/4;n[n.length-2]=="="?e-=2:n[n.length-1]=="="&&(e-=1);let t=new Uint8Array(e),i=0,r=0,s,a=0;for(let o=0;o<n.length;o++){if(s=Ni[n.charCodeAt(o)],s===void 0)switch(n[o]){case"=":r=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(r){case 0:a=s,r=1;break;case 1:t[i++]=a<<2|(s&48)>>4,a=s,r=2;break;case 2:t[i++]=(a&15)<<4|(s&60)>>2,a=s,r=3;break;case 3:t[i++]=(a&3)<<6|s,r=0;break}}if(r==1)throw Error("invalid base64 string.");return t.subarray(0,i)},enc(n){let e="",t=0,i,r=0;for(let s=0;s<n.length;s++)switch(i=n[s],t){case 0:e+=ct[i>>2],r=(i&3)<<4,t=1;break;case 1:e+=ct[r|i>>4],r=(i&15)<<2,t=2;break;case 2:e+=ct[r|i>>6],e+=ct[i&63],t=0;break}return t&&(e+=ct[r],e+="=",t==1&&(e+="=")),e}};function od(n,e,t){Ya(e,n);const i=e.runtime.bin.makeReadOptions(t),r=sd(n.getType().runtime.bin.listUnknownFields(n),e.field),[s,a]=Ja(e);for(const o of r)e.runtime.bin.readField(s,i.readerFactory(o.data),e.field,o.wireType,i);return a()}function ad(n,e,t,i){Ya(e,n);const r=e.runtime.bin.makeReadOptions(i),s=e.runtime.bin.makeWriteOptions(i);if(Qa(n,e)){const l=n.getType().runtime.bin.listUnknownFields(n).filter(u=>u.no!=e.field.no);n.getType().runtime.bin.discardUnknownFields(n);for(const u of l)n.getType().runtime.bin.onUnknownField(n,u.no,u.wireType,u.data)}const a=s.writerFactory();let o=e.field;!o.opt&&!o.repeated&&(o.kind=="enum"||o.kind=="scalar")&&(o=Object.assign(Object.assign({},e.field),{opt:!0})),e.runtime.bin.writeField(o,t,a,s);const c=r.readerFactory(a.finish());for(;c.pos<c.len;){const[l,u]=c.tag(),d=c.skip(u,l);n.getType().runtime.bin.onUnknownField(n,l,u,d)}}function Qa(n,e){const t=n.getType();return e.extendee.typeName===t.typeName&&!!t.runtime.bin.listUnknownFields(n).find(i=>i.no==e.field.no)}function Ya(n,e){ne(n.extendee.typeName==e.getType().typeName,"extension ".concat(n.typeName," can only be applied to message ").concat(n.extendee.typeName))}function Xa(n,e){const t=n.localName;if(n.repeated)return e[t].length>0;if(n.oneof)return e[n.oneof.localName].case===t;switch(n.kind){case"enum":case"scalar":return n.opt||n.req?e[t]!==void 0:n.kind=="enum"?e[t]!==n.T.values[0].no:!Ga(n.T,e[t]);case"message":return e[t]!==void 0;case"map":return Object.keys(e[t]).length>0}}function so(n,e){const t=n.localName,i=!n.opt&&!n.req;if(n.repeated)e[t]=[];else if(n.oneof)e[n.oneof.localName]={case:void 0};else switch(n.kind){case"map":e[t]={};break;case"enum":e[t]=i?n.T.values[0].no:void 0;break;case"scalar":e[t]=i?un(n.T,n.L):void 0;break;case"message":e[t]=void 0;break}}function lt(n,e){if(n===null||typeof n!="object"||!Object.getOwnPropertyNames(ls.prototype).every(i=>i in n&&typeof n[i]=="function"))return!1;const t=n.getType();return t===null||typeof t!="function"||!("typeName"in t)||typeof t.typeName!="string"?!1:e===void 0?!0:t.typeName==e.typeName}function Za(n,e){return lt(e)||!n.fieldWrapper?e:n.fieldWrapper.wrapField(e)}A.DOUBLE,A.FLOAT,A.INT64,A.UINT64,A.INT32,A.UINT32,A.BOOL,A.STRING,A.BYTES;const oo={ignoreUnknownFields:!1},ao={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function cd(n){return n?Object.assign(Object.assign({},oo),n):oo}function ld(n){return n?Object.assign(Object.assign({},ao),n):ao}const gi=Symbol(),ri=Symbol();function ud(){return{makeReadOptions:cd,makeWriteOptions:ld,readMessage(n,e,t,i){if(e==null||Array.isArray(e)||typeof e!="object")throw new Error("cannot decode message ".concat(n.typeName," from JSON: ").concat(Ye(e)));i=i??new n;const r=new Map,s=t.typeRegistry;for(const[a,o]of Object.entries(e)){const c=n.fields.findJsonName(a);if(c){if(c.oneof){if(o===null&&c.kind=="scalar")continue;const l=r.get(c.oneof);if(l!==void 0)throw new Error("cannot decode message ".concat(n.typeName,' from JSON: multiple keys for oneof "').concat(c.oneof.name,'" present: "').concat(l,'", "').concat(a,'"'));r.set(c.oneof,a)}co(i,o,c,t,n)}else{let l=!1;if(s?.findExtension&&a.startsWith("[")&&a.endsWith("]")){const u=s.findExtension(a.substring(1,a.length-1));if(u&&u.extendee.typeName==n.typeName){l=!0;const[d,h]=Ja(u);co(d,o,u.field,t,u),ad(i,u,h(),t)}}if(!l&&!t.ignoreUnknownFields)throw new Error("cannot decode message ".concat(n.typeName,' from JSON: key "').concat(a,'" is unknown'))}}return i},writeMessage(n,e){const t=n.getType(),i={};let r;try{for(r of t.fields.byNumber()){if(!Xa(r,n)){if(r.req)throw"required field not set";if(!e.emitDefaultValues||!hd(r))continue}const a=r.oneof?n[r.oneof.localName].value:n[r.localName],o=lo(r,a,e);o!==void 0&&(i[e.useProtoFieldName?r.name:r.jsonName]=o)}const s=e.typeRegistry;if(s?.findExtensionFor)for(const a of t.runtime.bin.listUnknownFields(n)){const o=s.findExtensionFor(t.typeName,a.no);if(o&&Qa(n,o)){const c=od(n,o,e),l=lo(o.field,c,e);l!==void 0&&(i[o.field.jsonName]=l)}}}catch(s){const a=r?"cannot encode field ".concat(t.typeName,".").concat(r.name," to JSON"):"cannot encode message ".concat(t.typeName," to JSON"),o=s instanceof Error?s.message:String(s);throw new Error(a+(o.length>0?": ".concat(o):""))}return i},readScalar(n,e,t){return In(n,e,t??It.BIGINT,!0)},writeScalar(n,e,t){if(e!==void 0&&(t||Ga(n,e)))return si(n,e)},debug:Ye}}function Ye(n){if(n===null)return"null";switch(typeof n){case"object":return Array.isArray(n)?"array":"object";case"string":return n.length>100?"string":'"'.concat(n.split('"').join('\\"'),'"');default:return String(n)}}function co(n,e,t,i,r){let s=t.localName;if(t.repeated){if(ne(t.kind!="map"),e===null)return;if(!Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Ye(e)));const a=n[s];for(const o of e){if(o===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Ye(o)));switch(t.kind){case"message":a.push(t.T.fromJson(o,i));break;case"enum":const c=rr(t.T,o,i.ignoreUnknownFields,!0);c!==ri&&a.push(c);break;case"scalar":try{a.push(In(t.T,o,t.L,!0))}catch(l){let u="cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Ye(o));throw l instanceof Error&&l.message.length>0&&(u+=": ".concat(l.message)),new Error(u)}break}}}else if(t.kind=="map"){if(e===null)return;if(typeof e!="object"||Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Ye(e)));const a=n[s];for(const[o,c]of Object.entries(e)){if(c===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: map value null"));let l;try{l=dd(t.K,o)}catch(u){let d="cannot decode map key for field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Ye(e));throw u instanceof Error&&u.message.length>0&&(d+=": ".concat(u.message)),new Error(d)}switch(t.V.kind){case"message":a[l]=t.V.T.fromJson(c,i);break;case"enum":const u=rr(t.V.T,c,i.ignoreUnknownFields,!0);u!==ri&&(a[l]=u);break;case"scalar":try{a[l]=In(t.V.T,c,It.BIGINT,!0)}catch(d){let h="cannot decode map value for field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Ye(e));throw d instanceof Error&&d.message.length>0&&(h+=": ".concat(d.message)),new Error(h)}break}}}else switch(t.oneof&&(n=n[t.oneof.localName]={case:s},s="value"),t.kind){case"message":const a=t.T;if(e===null&&a.typeName!="google.protobuf.Value")return;let o=n[s];lt(o)?o.fromJson(e,i):(n[s]=o=a.fromJson(e,i),a.fieldWrapper&&!t.oneof&&(n[s]=a.fieldWrapper.unwrapField(o)));break;case"enum":const c=rr(t.T,e,i.ignoreUnknownFields,!1);switch(c){case gi:so(t,n);break;case ri:break;default:n[s]=c;break}break;case"scalar":try{const l=In(t.T,e,t.L,!1);switch(l){case gi:so(t,n);break;default:n[s]=l;break}}catch(l){let u="cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(Ye(e));throw l instanceof Error&&l.message.length>0&&(u+=": ".concat(l.message)),new Error(u)}break}}function dd(n,e){if(n===A.BOOL)switch(e){case"true":e=!0;break;case"false":e=!1;break}return In(n,e,It.BIGINT,!0).toString()}function In(n,e,t,i){if(e===null)return i?un(n,t):gi;switch(n){case A.DOUBLE:case A.FLOAT:if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""||typeof e=="string"&&e.trim().length!==e.length||typeof e!="string"&&typeof e!="number")break;const r=Number(e);if(Number.isNaN(r)||!Number.isFinite(r))break;return n==A.FLOAT&&Ba(r),r;case A.INT32:case A.FIXED32:case A.SFIXED32:case A.SINT32:case A.UINT32:let s;if(typeof e=="number"?s=e:typeof e=="string"&&e.length>0&&e.trim().length===e.length&&(s=Number(e)),s===void 0)break;return n==A.UINT32||n==A.FIXED32?_r(s):ni(s),s;case A.INT64:case A.SFIXED64:case A.SINT64:if(typeof e!="number"&&typeof e!="string")break;const a=Z.parse(e);return t?a.toString():a;case A.FIXED64:case A.UINT64:if(typeof e!="number"&&typeof e!="string")break;const o=Z.uParse(e);return t?o.toString():o;case A.BOOL:if(typeof e!="boolean")break;return e;case A.STRING:if(typeof e!="string")break;try{encodeURIComponent(e)}catch{throw new Error("invalid UTF8")}return e;case A.BYTES:if(e==="")return new Uint8Array(0);if(typeof e!="string")break;return $a.dec(e)}throw new Error}function rr(n,e,t,i){if(e===null)return n.typeName=="google.protobuf.NullValue"?0:i?n.values[0].no:gi;switch(typeof e){case"number":if(Number.isInteger(e))return e;break;case"string":const r=n.findName(e);if(r!==void 0)return r.no;if(t)return ri;break}throw new Error("cannot decode enum ".concat(n.typeName," from JSON: ").concat(Ye(e)))}function hd(n){return n.repeated||n.kind=="map"?!0:!(n.oneof||n.kind=="message"||n.opt||n.req)}function lo(n,e,t){if(n.kind=="map"){ne(typeof e=="object"&&e!=null);const i={},r=Object.entries(e);switch(n.V.kind){case"scalar":for(const[a,o]of r)i[a.toString()]=si(n.V.T,o);break;case"message":for(const[a,o]of r)i[a.toString()]=o.toJson(t);break;case"enum":const s=n.V.T;for(const[a,o]of r)i[a.toString()]=sr(s,o,t.enumAsInteger);break}return t.emitDefaultValues||r.length>0?i:void 0}if(n.repeated){ne(Array.isArray(e));const i=[];switch(n.kind){case"scalar":for(let r=0;r<e.length;r++)i.push(si(n.T,e[r]));break;case"enum":for(let r=0;r<e.length;r++)i.push(sr(n.T,e[r],t.enumAsInteger));break;case"message":for(let r=0;r<e.length;r++)i.push(e[r].toJson(t));break}return t.emitDefaultValues||i.length>0?i:void 0}switch(n.kind){case"scalar":return si(n.T,e);case"enum":return sr(n.T,e,t.enumAsInteger);case"message":return Za(n.T,e).toJson(t)}}function sr(n,e,t){var i;if(ne(typeof e=="number"),n.typeName=="google.protobuf.NullValue")return null;if(t)return e;const r=n.findNumber(e);return(i=r?.name)!==null&&i!==void 0?i:e}function si(n,e){switch(n){case A.INT32:case A.SFIXED32:case A.SINT32:case A.FIXED32:case A.UINT32:return ne(typeof e=="number"),e;case A.FLOAT:case A.DOUBLE:return ne(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e;case A.STRING:return ne(typeof e=="string"),e;case A.BOOL:return ne(typeof e=="boolean"),e;case A.UINT64:case A.FIXED64:case A.INT64:case A.SFIXED64:case A.SINT64:return ne(typeof e=="bigint"||typeof e=="string"||typeof e=="number"),e.toString();case A.BYTES:return ne(e instanceof Uint8Array),$a.enc(e)}}const $t=Symbol("@bufbuild/protobuf/unknown-fields"),uo={readUnknownFields:!0,readerFactory:n=>new nd(n)},ho={writeUnknownFields:!0,writerFactory:()=>new td};function fd(n){return n?Object.assign(Object.assign({},uo),n):uo}function pd(n){return n?Object.assign(Object.assign({},ho),n):ho}function md(){return{makeReadOptions:fd,makeWriteOptions:pd,listUnknownFields(n){var e;return(e=n[$t])!==null&&e!==void 0?e:[]},discardUnknownFields(n){delete n[$t]},writeUnknownFields(n,e){const i=n[$t];if(i)for(const r of i)e.tag(r.no,r.wireType).raw(r.data)},onUnknownField(n,e,t,i){const r=n;Array.isArray(r[$t])||(r[$t]=[]),r[$t].push({no:e,wireType:t,data:i})},readMessage(n,e,t,i,r){const s=n.getType(),a=r?e.len:e.pos+t;let o,c;for(;e.pos<a&&([o,c]=e.tag(),!(r===!0&&c==se.EndGroup));){const l=s.fields.find(o);if(!l){const u=e.skip(c,o);i.readUnknownFields&&this.onUnknownField(n,o,c,u);continue}fo(n,e,l,c,i)}if(r&&(c!=se.EndGroup||o!==t))throw new Error("invalid end group tag")},readField:fo,writeMessage(n,e,t){const i=n.getType();for(const r of i.fields.byNumber()){if(!Xa(r,n)){if(r.req)throw new Error("cannot encode field ".concat(i.typeName,".").concat(r.name," to binary: required field not set"));continue}const s=r.oneof?n[r.oneof.localName].value:n[r.localName];po(r,s,e,t)}return t.writeUnknownFields&&this.writeUnknownFields(n,e),e},writeField(n,e,t,i){e!==void 0&&po(n,e,t,i)}}}function fo(n,e,t,i,r){let{repeated:s,localName:a}=t;switch(t.oneof&&(n=n[t.oneof.localName],n.case!=a&&delete n.value,n.case=a,a="value"),t.kind){case"scalar":case"enum":const o=t.kind=="enum"?A.INT32:t.T;let c=vi;if(t.kind=="scalar"&&t.L>0&&(c=vd),s){let h=n[a];if(i==se.LengthDelimited&&o!=A.STRING&&o!=A.BYTES){let b=e.uint32()+e.pos;for(;e.pos<b;)h.push(c(e,o))}else h.push(c(e,o))}else n[a]=c(e,o);break;case"message":const l=t.T;s?n[a].push(oi(e,new l,r,t)):lt(n[a])?oi(e,n[a],r,t):(n[a]=oi(e,new l,r,t),l.fieldWrapper&&!t.oneof&&!t.repeated&&(n[a]=l.fieldWrapper.unwrapField(n[a])));break;case"map":let[u,d]=gd(t,e,r);n[a][u]=d;break}}function oi(n,e,t,i){const r=e.getType().runtime.bin,s=i?.delimited;return r.readMessage(e,n,s?i.no:n.uint32(),t,s),e}function gd(n,e,t){const i=e.uint32(),r=e.pos+i;let s,a;for(;e.pos<r;){const[o]=e.tag();switch(o){case 1:s=vi(e,n.K);break;case 2:switch(n.V.kind){case"scalar":a=vi(e,n.V.T);break;case"enum":a=e.int32();break;case"message":a=oi(e,new n.V.T,t,void 0);break}break}}if(s===void 0&&(s=un(n.K,It.BIGINT)),typeof s!="string"&&typeof s!="number"&&(s=s.toString()),a===void 0)switch(n.V.kind){case"scalar":a=un(n.V.T,It.BIGINT);break;case"enum":a=n.V.T.values[0].no;break;case"message":a=new n.V.T;break}return[s,a]}function vd(n,e){const t=vi(n,e);return typeof t=="bigint"?t.toString():t}function vi(n,e){switch(e){case A.STRING:return n.string();case A.BOOL:return n.bool();case A.DOUBLE:return n.double();case A.FLOAT:return n.float();case A.INT32:return n.int32();case A.INT64:return n.int64();case A.UINT64:return n.uint64();case A.FIXED64:return n.fixed64();case A.BYTES:return n.bytes();case A.FIXED32:return n.fixed32();case A.SFIXED32:return n.sfixed32();case A.SFIXED64:return n.sfixed64();case A.SINT64:return n.sint64();case A.UINT32:return n.uint32();case A.SINT32:return n.sint32()}}function po(n,e,t,i){ne(e!==void 0);const r=n.repeated;switch(n.kind){case"scalar":case"enum":let s=n.kind=="enum"?A.INT32:n.T;if(r)if(ne(Array.isArray(e)),n.packed)yd(t,s,n.no,e);else for(const a of e)xn(t,s,n.no,a);else xn(t,s,n.no,e);break;case"message":if(r){ne(Array.isArray(e));for(const a of e)mo(t,i,n,a)}else mo(t,i,n,e);break;case"map":ne(typeof e=="object"&&e!=null);for(const[a,o]of Object.entries(e))bd(t,i,n,a,o);break}}function bd(n,e,t,i,r){n.tag(t.no,se.LengthDelimited),n.fork();let s=i;switch(t.K){case A.INT32:case A.FIXED32:case A.UINT32:case A.SFIXED32:case A.SINT32:s=Number.parseInt(i);break;case A.BOOL:ne(i=="true"||i=="false"),s=i=="true";break}switch(xn(n,t.K,1,s),t.V.kind){case"scalar":xn(n,t.V.T,2,r);break;case"enum":xn(n,A.INT32,2,r);break;case"message":ne(r!==void 0),n.tag(2,se.LengthDelimited).bytes(r.toBinary(e));break}n.join()}function mo(n,e,t,i){const r=Za(t.T,i);t.delimited?n.tag(t.no,se.StartGroup).raw(r.toBinary(e)).tag(t.no,se.EndGroup):n.tag(t.no,se.LengthDelimited).bytes(r.toBinary(e))}function xn(n,e,t,i){ne(i!==void 0);let[r,s]=ec(e);n.tag(t,r)[s](i)}function yd(n,e,t,i){if(!i.length)return;n.tag(t,se.LengthDelimited).fork();let[,r]=ec(e);for(let s=0;s<i.length;s++)n[r](i[s]);n.join()}function ec(n){let e=se.Varint;switch(n){case A.BYTES:case A.STRING:e=se.LengthDelimited;break;case A.DOUBLE:case A.FIXED64:case A.SFIXED64:e=se.Bit64;break;case A.FIXED32:case A.SFIXED32:case A.FLOAT:e=se.Bit32;break}const t=A[n].toLowerCase();return[e,t]}function kd(){return{setEnumType:qa,initPartial(n,e){if(n===void 0)return;const t=e.getType();for(const i of t.fields.byMember()){const r=i.localName,s=e,a=n;if(a[r]!=null)switch(i.kind){case"oneof":const o=a[r].case;if(o===void 0)continue;const c=i.findField(o);let l=a[r].value;c&&c.kind=="message"&&!lt(l,c.T)?l=new c.T(l):c&&c.kind==="scalar"&&c.T===A.BYTES&&(l=yn(l)),s[r]={case:o,value:l};break;case"scalar":case"enum":let u=a[r];i.T===A.BYTES&&(u=i.repeated?u.map(yn):yn(u)),s[r]=u;break;case"map":switch(i.V.kind){case"scalar":case"enum":if(i.V.T===A.BYTES)for(const[p,b]of Object.entries(a[r]))s[r][p]=yn(b);else Object.assign(s[r],a[r]);break;case"message":const h=i.V.T;for(const p of Object.keys(a[r])){let b=a[r][p];h.fieldWrapper||(b=new h(b)),s[r][p]=b}break}break;case"message":const d=i.T;if(i.repeated)s[r]=a[r].map(h=>lt(h,d)?h:new d(h));else{const h=a[r];d.fieldWrapper?d.typeName==="google.protobuf.BytesValue"?s[r]=yn(h):s[r]=h:s[r]=lt(h,d)?h:new d(h)}break}}},equals(n,e,t){return e===t?!0:!e||!t?!1:n.fields.byMember().every(i=>{const r=e[i.localName],s=t[i.localName];if(i.repeated){if(r.length!==s.length)return!1;switch(i.kind){case"message":return r.every((a,o)=>i.T.equals(a,s[o]));case"scalar":return r.every((a,o)=>yt(i.T,a,s[o]));case"enum":return r.every((a,o)=>yt(A.INT32,a,s[o]))}throw new Error("repeated cannot contain ".concat(i.kind))}switch(i.kind){case"message":let a=r,o=s;return i.T.fieldWrapper&&(a!==void 0&&!lt(a)&&(a=i.T.fieldWrapper.wrapField(a)),o!==void 0&&!lt(o)&&(o=i.T.fieldWrapper.wrapField(o))),i.T.equals(a,o);case"enum":return yt(A.INT32,r,s);case"scalar":return yt(i.T,r,s);case"oneof":if(r.case!==s.case)return!1;const c=i.findField(r.case);if(c===void 0)return!0;switch(c.kind){case"message":return c.T.equals(r.value,s.value);case"enum":return yt(A.INT32,r.value,s.value);case"scalar":return yt(c.T,r.value,s.value)}throw new Error("oneof cannot contain ".concat(c.kind));case"map":const l=Object.keys(r).concat(Object.keys(s));switch(i.V.kind){case"message":const u=i.V.T;return l.every(h=>u.equals(r[h],s[h]));case"enum":return l.every(h=>yt(A.INT32,r[h],s[h]));case"scalar":const d=i.V.T;return l.every(h=>yt(d,r[h],s[h]))}break}})},clone(n){const e=n.getType(),t=new e,i=t;for(const r of e.fields.byMember()){const s=n[r.localName];let a;if(r.repeated)a=s.map($n);else if(r.kind=="map"){a=i[r.localName];for(const[o,c]of Object.entries(s))a[o]=$n(c)}else r.kind=="oneof"?a=r.findField(s.case)?{case:s.case,value:$n(s.value)}:{case:void 0}:a=$n(s);i[r.localName]=a}for(const r of e.runtime.bin.listUnknownFields(n))e.runtime.bin.onUnknownField(i,r.no,r.wireType,r.data);return t}}}function $n(n){if(n===void 0)return n;if(lt(n))return n.clone();if(n instanceof Uint8Array){const e=new Uint8Array(n.byteLength);return e.set(n),e}return n}function yn(n){return n instanceof Uint8Array?n:new Uint8Array(n)}function Sd(n,e,t){return{syntax:n,json:ud(),bin:md(),util:Object.assign(Object.assign({},kd()),{newFieldList:e,initFields:t}),makeMessageType(i,r,s){return $u(this,i,r,s)},makeEnum:Ju,makeEnumType:Wa,getEnumType:Gu,makeExtension(i,r,s){return id(this,i,r,s)}}}class Td{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const t={};for(const i of this.list())t[i.jsonName]=t[i.name]=i;this.jsonNames=t}return this.jsonNames[e]}find(e){if(!this.numbers){const t={};for(const i of this.list())t[i.no]=i;this.numbers=t}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const i of this.list())i.oneof?i.oneof!==t&&(t=i.oneof,e.push(t)):e.push(i)}return this.members}}function tc(n,e){const t=nc(n);return e?t:_d(Rd(t))}function Cd(n){return tc(n,!1)}const Ed=nc;function nc(n){let e=!1;const t=[];for(let i=0;i<n.length;i++){let r=n.charAt(i);switch(r){case"_":e=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.push(r),e=!1;break;default:e&&(e=!1,r=r.toUpperCase()),t.push(r);break}}return t.join("")}const wd=new Set(["constructor","toString","toJSON","valueOf"]),Pd=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),ic=n=>"".concat(n,"$"),Rd=n=>Pd.has(n)?ic(n):n,_d=n=>wd.has(n)?ic(n):n;class Id{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=Cd(e)}addField(e){ne(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let t=0;t<this.fields.length;t++)this._lookup[this.fields[t].localName]=this.fields[t]}return this._lookup[e]}}function xd(n,e){var t,i,r,s,a,o;const c=[];let l;for(const u of typeof n=="function"?n():n){const d=u;if(d.localName=tc(u.name,u.oneof!==void 0),d.jsonName=(t=u.jsonName)!==null&&t!==void 0?t:Ed(u.name),d.repeated=(i=u.repeated)!==null&&i!==void 0?i:!1,u.kind=="scalar"&&(d.L=(r=u.L)!==null&&r!==void 0?r:It.BIGINT),d.delimited=(s=u.delimited)!==null&&s!==void 0?s:!1,d.req=(a=u.req)!==null&&a!==void 0?a:!1,d.opt=(o=u.opt)!==null&&o!==void 0?o:!1,u.packed===void 0&&(d.packed=u.kind=="enum"||u.kind=="scalar"&&u.T!=A.BYTES&&u.T!=A.STRING),u.oneof!==void 0){const h=typeof u.oneof=="string"?u.oneof:u.oneof.name;(!l||l.name!=h)&&(l=new Id(h)),d.oneof=l,l.addField(d)}c.push(d)}return c}const w=Sd("proto3",n=>new Td(n,e=>xd(e)),n=>{for(const e of n.getType().fields.byMember()){if(e.opt)continue;const t=e.localName,i=n;if(e.repeated){i[t]=[];continue}switch(e.kind){case"oneof":i[t]={case:void 0};break;case"enum":i[t]=0;break;case"map":i[t]={};break;case"scalar":i[t]=un(e.T,e.L);break}}});class we extends ls{constructor(e){super(),this.seconds=Z.zero,this.nanos=0,w.util.initPartial(e,this)}fromJson(e,t){if(typeof e!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(w.json.debug(e)));const i=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!i)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const r=Date.parse(i[1]+"-"+i[2]+"-"+i[3]+"T"+i[4]+":"+i[5]+":"+i[6]+(i[8]?i[8]:"Z"));if(Number.isNaN(r))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(r<Date.parse("0001-01-01T00:00:00Z")||r>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=Z.parse(r/1e3),this.nanos=0,i[7]&&(this.nanos=parseInt("1"+i[7]+"0".repeat(9-i[7].length))-1e9),this}toJson(e){const t=Number(this.seconds)*1e3;if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let i="Z";if(this.nanos>0){const r=(this.nanos+1e9).toString().substring(1);r.substring(3)==="000000"?i="."+r.substring(0,3)+"Z":r.substring(6)==="000"?i="."+r.substring(0,6)+"Z":i="."+r+"Z"}return new Date(t).toISOString().replace(".000Z",i)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return we.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new we({seconds:Z.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return new we().fromBinary(e,t)}static fromJson(e,t){return new we().fromJson(e,t)}static fromJsonString(e,t){return new we().fromJsonString(e,t)}static equals(e,t){return w.util.equals(we,e,t)}}we.runtime=w;we.typeName="google.protobuf.Timestamp";we.fields=w.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const Od=w.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:we},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:Md,repeated:!0},{no:5,name:"events",kind:"message",T:Ad,repeated:!0}]),Md=w.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:Dd,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),Dd=w.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:we},{no:3,name:"value",kind:"scalar",T:2}]),Ad=w.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:we},{no:7,name:"normalized_end_timestamp",kind:"message",T:we,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),rc=w.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),Ue=w.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),oe=w.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),ds=w.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),Rn=w.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),Dn=w.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),Ve=w.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]),Nt=w.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),Ld=w.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),he=w.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),Ui=w.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:bi,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:vc}]),bi=w.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),Nd=w.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:w.getEnumType(oe),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),Bt=w.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:w.getEnumType(en)},{no:4,name:"tracks",kind:"message",T:Yt,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:Nd},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:w.getEnumType(An)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:w.getEnumType(Ve)},{no:18,name:"kind_details",kind:"enum",T:w.getEnumType(Ud),repeated:!0}]),en=w.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),An=w.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"},{no:7,name:"CONNECTOR"}]),Ud=w.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),le=w.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),Fd=w.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:wt,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:w.getEnumType(sc)},{no:6,name:"sdp_cid",kind:"scalar",T:9}]),Yt=w.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:w.getEnumType(Ue)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:w.getEnumType(oe)},{no:10,name:"layers",kind:"message",T:wt,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:Fd,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:w.getEnumType(le)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:vc},{no:19,name:"audio_features",kind:"enum",T:w.getEnumType(he),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:w.getEnumType(rc)}]),wt=w.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:w.getEnumType(ds)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}]),sc=w.makeEnum("livekit.VideoLayer.Mode",[{no:0,name:"MODE_UNUSED"},{no:1,name:"ONE_SPATIAL_LAYER_PER_STREAM"},{no:2,name:"MULTIPLE_SPATIAL_LAYERS_PER_STREAM"},{no:3,name:"ONE_SPATIAL_LAYER_PER_STREAM_INCOMPLETE_RTCP_SR"}]),ye=w.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:w.getEnumType(q)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:hs,oneof:"value"},{no:3,name:"speaker",kind:"message",T:jd,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:lc,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Bd,oneof:"value"},{no:8,name:"metrics",kind:"message",T:Od,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:yi,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:fs,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:ps,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:ms,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:ki,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:Si,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:Ti,oneof:"value"},{no:18,name:"encrypted_packet",kind:"message",T:oc,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}]),q=w.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),oc=w.makeMessageType("livekit.EncryptedPacket",()=>[{no:1,name:"encryption_type",kind:"enum",T:w.getEnumType(le)},{no:2,name:"iv",kind:"scalar",T:12},{no:3,name:"key_index",kind:"scalar",T:13},{no:4,name:"encrypted_value",kind:"scalar",T:12}]),ac=w.makeMessageType("livekit.EncryptedPacketPayload",()=>[{no:1,name:"user",kind:"message",T:hs,oneof:"value"},{no:3,name:"chat_message",kind:"message",T:yi,oneof:"value"},{no:4,name:"rpc_request",kind:"message",T:fs,oneof:"value"},{no:5,name:"rpc_ack",kind:"message",T:ps,oneof:"value"},{no:6,name:"rpc_response",kind:"message",T:ms,oneof:"value"},{no:7,name:"stream_header",kind:"message",T:ki,oneof:"value"},{no:8,name:"stream_chunk",kind:"message",T:Si,oneof:"value"},{no:9,name:"stream_trailer",kind:"message",T:Ti,oneof:"value"}]),jd=w.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:cc,repeated:!0}]),cc=w.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),hs=w.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),lc=w.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),Bd=w.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:Vd,repeated:!0}]),Vd=w.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),yi=w.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),fs=w.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),ps=w.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),ms=w.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:uc,oneof:"value"}]),uc=w.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),dc=w.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),hc=w.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:w.getEnumType(fc)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),fc=w.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),pc=w.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:w.getEnumType(mc)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),mc=w.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]),gc=w.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:go},{no:2,name:"screen",kind:"message",T:go},{no:3,name:"resume_connection",kind:"enum",T:w.getEnumType(Dn)},{no:4,name:"disabled_codecs",kind:"message",T:qd},{no:5,name:"force_relay",kind:"enum",T:w.getEnumType(Dn)}]),go=w.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:w.getEnumType(Dn)}]),qd=w.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:bi,repeated:!0},{no:2,name:"publish",kind:"message",T:bi,repeated:!0}]),vc=w.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),Ir=w.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),bc=w.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:w.getEnumType(Ir)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),yc=w.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),ki=w.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:w.getEnumType(le)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:bc,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:yc,oneof:"content_header"}],{localName:"DataStream_Header"}),Si=w.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),Ti=w.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),Wd=w.makeMessageType("livekit.SubscribedAudioCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"enabled",kind:"scalar",T:8}]),Fe=w.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),xr=w.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),Hd=w.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),Kd=w.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:xt,oneof:"message"},{no:2,name:"answer",kind:"message",T:xt,oneof:"message"},{no:3,name:"trickle",kind:"message",T:Fi,oneof:"message"},{no:4,name:"add_track",kind:"message",T:Ln,oneof:"message"},{no:5,name:"mute",kind:"message",T:ji,oneof:"message"},{no:6,name:"subscription",kind:"message",T:Bi,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:kc,oneof:"message"},{no:8,name:"leave",kind:"message",T:Vi,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:Tc,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:wc,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:ks,oneof:"message"},{no:13,name:"simulate",kind:"message",T:Qe,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:bs,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:_c,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:vs,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:Sc,oneof:"message"}]),vo=w.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:zd,oneof:"message"},{no:2,name:"answer",kind:"message",T:xt,oneof:"message"},{no:3,name:"offer",kind:"message",T:xt,oneof:"message"},{no:4,name:"trickle",kind:"message",T:Fi,oneof:"message"},{no:5,name:"update",kind:"message",T:$d,oneof:"message"},{no:6,name:"track_published",kind:"message",T:gs,oneof:"message"},{no:8,name:"leave",kind:"message",T:Vi,oneof:"message"},{no:9,name:"mute",kind:"message",T:ji,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:Qd,oneof:"message"},{no:11,name:"room_update",kind:"message",T:Yd,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:Zd,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:th,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:ih,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:sh,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:Jd,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:Gd,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:ah,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:uh,oneof:"message"},{no:22,name:"request_response",kind:"message",T:dh,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:hh,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:oh,oneof:"message"},{no:25,name:"media_sections_requirement",kind:"message",T:gh,oneof:"message"},{no:26,name:"subscribed_audio_codec_update",kind:"message",T:rh,oneof:"message"}]),Or=w.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:wt,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:w.getEnumType(sc)}]),Ln=w.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:w.getEnumType(Ue)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:w.getEnumType(oe)},{no:9,name:"layers",kind:"message",T:wt,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:Or,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:w.getEnumType(le)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:w.getEnumType(rc)},{no:17,name:"audio_features",kind:"enum",T:w.getEnumType(he),repeated:!0}]),Fi=w.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:w.getEnumType(Fe)},{no:3,name:"final",kind:"scalar",T:8}]),ji=w.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),zd=w.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:Ui},{no:2,name:"participant",kind:"message",T:Bt},{no:3,name:"other_participants",kind:"message",T:Bt,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:Cc,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:gc},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:hc},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:bi,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),Gd=w.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:Cc,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:gc},{no:3,name:"server_info",kind:"message",T:hc},{no:4,name:"last_message_seq",kind:"scalar",T:13}]),gs=w.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:Yt}]),Jd=w.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),xt=w.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13},{no:4,name:"mid_to_track_id",kind:"map",K:9,V:{kind:"scalar",T:9}}]),$d=w.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:Bt,repeated:!0}]),Bi=w.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:dc,repeated:!0}]),kc=w.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:w.getEnumType(ds)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),vs=w.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:w.getEnumType(he),repeated:!0}]),Sc=w.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),Vi=w.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:w.getEnumType(Ve)},{no:3,name:"action",kind:"enum",T:w.getEnumType(tn)},{no:4,name:"regions",kind:"message",T:ch}]),tn=w.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),Tc=w.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:wt,repeated:!0}]),bs=w.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),Cc=w.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),Qd=w.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:cc,repeated:!0}]),Yd=w.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:Ui}]),Xd=w.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:w.getEnumType(Rn)},{no:3,name:"score",kind:"scalar",T:2}]),Zd=w.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:Xd,repeated:!0}]),eh=w.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:w.getEnumType(xr)}]),th=w.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:eh,repeated:!0}]),ys=w.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:w.getEnumType(ds)},{no:2,name:"enabled",kind:"scalar",T:8}]),nh=w.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:ys,repeated:!0}]),ih=w.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:ys,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:nh,repeated:!0}]),rh=w.makeMessageType("livekit.SubscribedAudioCodecUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_audio_codecs",kind:"message",T:Wd,repeated:!0}]),Ec=w.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),wc=w.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:Ec,repeated:!0}]),sh=w.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),oh=w.makeMessageType("livekit.RoomMovedResponse",()=>[{no:1,name:"room",kind:"message",T:Ui},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:Bt},{no:4,name:"other_participants",kind:"message",T:Bt,repeated:!0}]),ks=w.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:xt},{no:2,name:"subscription",kind:"message",T:Bi},{no:3,name:"publish_tracks",kind:"message",T:gs,repeated:!0},{no:4,name:"data_channels",kind:"message",T:Rc,repeated:!0},{no:5,name:"offer",kind:"message",T:xt},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0},{no:7,name:"datachannel_receive_states",kind:"message",T:Pc,repeated:!0}]),Pc=w.makeMessageType("livekit.DataChannelReceiveState",()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}]),Rc=w.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:w.getEnumType(Fe)}]),Qe=w.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:w.getEnumType(Hd),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),_c=w.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),ah=w.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),ch=w.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:lh,repeated:!0}]),lh=w.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),uh=w.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:w.getEnumType(Ld)}]),dh=w.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:w.getEnumType(Ss)},{no:3,name:"message",kind:"scalar",T:9},{no:4,name:"trickle",kind:"message",T:Fi,oneof:"request"},{no:5,name:"add_track",kind:"message",T:Ln,oneof:"request"},{no:6,name:"mute",kind:"message",T:ji,oneof:"request"},{no:7,name:"update_metadata",kind:"message",T:bs,oneof:"request"},{no:8,name:"update_audio_track",kind:"message",T:vs,oneof:"request"},{no:9,name:"update_video_track",kind:"message",T:Sc,oneof:"request"}]),Ss=w.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"},{no:4,name:"QUEUED"},{no:5,name:"UNSUPPORTED_TYPE"},{no:6,name:"UNCLASSIFIED_ERROR"}]),hh=w.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),Ic=w.makeMessageType("livekit.ConnectionSettings",()=>[{no:1,name:"auto_subscribe",kind:"scalar",T:8},{no:2,name:"adaptive_stream",kind:"scalar",T:8},{no:3,name:"subscriber_allow_pause",kind:"scalar",T:8,opt:!0},{no:4,name:"disable_ice_lite",kind:"scalar",T:8}]),fh=w.makeMessageType("livekit.JoinRequest",()=>[{no:1,name:"client_info",kind:"message",T:pc},{no:2,name:"connection_settings",kind:"message",T:Ic},{no:3,name:"metadata",kind:"scalar",T:9},{no:4,name:"participant_attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"add_track_requests",kind:"message",T:Ln,repeated:!0},{no:6,name:"publisher_offer",kind:"message",T:xt},{no:7,name:"reconnect",kind:"scalar",T:8},{no:8,name:"reconnect_reason",kind:"enum",T:w.getEnumType(Nt)},{no:9,name:"participant_sid",kind:"scalar",T:9},{no:10,name:"sync_state",kind:"message",T:ks}]),ph=w.makeMessageType("livekit.WrappedJoinRequest",()=>[{no:1,name:"compression",kind:"enum",T:w.getEnumType(mh)},{no:2,name:"join_request",kind:"scalar",T:12}]),mh=w.makeEnum("livekit.WrappedJoinRequest.Compression",[{no:0,name:"NONE"},{no:1,name:"GZIP"}]),gh=w.makeMessageType("livekit.MediaSectionsRequirement",()=>[{no:1,name:"num_audios",kind:"scalar",T:13},{no:2,name:"num_videos",kind:"scalar",T:13}]);function vh(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ai={exports:{}},bh=ai.exports,bo;function yh(){return bo||(bo=1,(function(n){(function(e,t){n.exports?n.exports=t():e.log=t()})(bh,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},a=null;function o(m,T){var S=m[T];if(typeof S.bind=="function")return S.bind(m);try{return Function.prototype.bind.call(S,m)}catch{return function(){return Function.prototype.apply.apply(S,[m,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&i?c:console[m]!==void 0?o(console,m):console.log!==void 0?o(console,"log"):e}function u(){for(var m=this.getLevel(),T=0;T<r.length;T++){var S=r[T];this[S]=T<m?e:this.methodFactory(S,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==t&&(u.call(this),this[m].apply(this,arguments))}}function h(m,T,S){return l(m)||d.apply(this,arguments)}function p(m,T){var S=this,P,M,v,g="loglevel";typeof m=="string"?g+=":"+m:typeof m=="symbol"&&(g=void 0);function y(D){var U=(r[D]||"silent").toUpperCase();if(!(typeof window===t||!g)){try{window.localStorage[g]=U;return}catch{}try{window.document.cookie=encodeURIComponent(g)+"="+U+";"}catch{}}}function C(){var D;if(!(typeof window===t||!g)){try{D=window.localStorage[g]}catch{}if(typeof D===t)try{var U=window.document.cookie,V=encodeURIComponent(g),G=U.indexOf(V+"=");G!==-1&&(D=/^([^;]+)/.exec(U.slice(G+V.length+1))[1])}catch{}return S.levels[D]===void 0&&(D=void 0),D}}function x(){if(!(typeof window===t||!g)){try{window.localStorage.removeItem(g)}catch{}try{window.document.cookie=encodeURIComponent(g)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function R(D){var U=D;if(typeof U=="string"&&S.levels[U.toUpperCase()]!==void 0&&(U=S.levels[U.toUpperCase()]),typeof U=="number"&&U>=0&&U<=S.levels.SILENT)return U;throw new TypeError("log.setLevel() called with invalid level: "+D)}S.name=m,S.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},S.methodFactory=T||h,S.getLevel=function(){return v??M??P},S.setLevel=function(D,U){return v=R(D),U!==!1&&y(v),u.call(S)},S.setDefaultLevel=function(D){M=R(D),C()||S.setLevel(D,!1)},S.resetLevel=function(){v=null,x(),u.call(S)},S.enableAll=function(D){S.setLevel(S.levels.TRACE,D)},S.disableAll=function(D){S.setLevel(S.levels.SILENT,D)},S.rebuild=function(){if(a!==S&&(P=R(a.getLevel())),u.call(S),a===S)for(var D in s)s[D].rebuild()},P=R(a?a.getLevel():"WARN");var I=C();I!=null&&(v=R(I)),u.call(S)}a=new p,a.getLogger=function(T){if(typeof T!="symbol"&&typeof T!="string"||T==="")throw new TypeError("You must supply a name when creating a logger.");var S=s[T];return S||(S=s[T]=new p(T,a.methodFactory)),S};var b=typeof window!==t?window.log:void 0;return a.noConflict=function(){return typeof window!==t&&window.log===a&&(window.log=b),a},a.getLoggers=function(){return s},a.default=a,a})})(ai)),ai.exports}var qi=yh(),Mr;(function(n){n[n.trace=0]="trace",n[n.debug=1]="debug",n[n.info=2]="info",n[n.warn=3]="warn",n[n.error=4]="error",n[n.silent=5]="silent"})(Mr||(Mr={}));var qe;(function(n){n.Default="livekit",n.Room="livekit-room",n.TokenSource="livekit-token-source",n.Participant="livekit-participant",n.Track="livekit-track",n.Publication="livekit-track-publication",n.Engine="livekit-engine",n.Signal="livekit-signal",n.PCManager="livekit-pc-manager",n.PCTransport="livekit-pc-transport",n.E2EE="lk-e2ee"})(qe||(qe={}));let j=qi.getLogger("livekit");Object.values(qe).map(n=>qi.getLogger(n));j.setDefaultLevel(Mr.info);function ht(n){const e=qi.getLogger(n);return e.setDefaultLevel(j.getLevel()),e}const kh=qi.getLogger("lk-e2ee"),kn=7e3,Sh=[0,300,4*300,9*300,16*300,kn,kn,kn,kn,kn];class Th{constructor(e){this._retryDelays=e!==void 0?[...e]:Sh}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+Math.random()*1e3}}function Ch(n,e){var t={};for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(n);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(n,i[r])&&(t[i[r]]=n[i[r]]);return t}function k(n,e,t,i){function r(s){return s instanceof t?s:new t(function(a){a(s)})}return new(t||(t=Promise))(function(s,a){function o(u){try{l(i.next(u))}catch(d){a(d)}}function c(u){try{l(i.throw(u))}catch(d){a(d)}}function l(u){u.done?s(u.value):r(u.value).then(o,c)}l((i=i.apply(n,e||[])).next())})}function yo(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function ut(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof yo=="function"?yo(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(a){return new Promise(function(o,c){a=n[s](a),r(o,c,a.done,a.value)})}}function r(s,a,o,c){Promise.resolve(c).then(function(l){s({value:l,done:o})},a)}}var Qn={exports:{}},ko;function Eh(){if(ko)return Qn.exports;ko=1;var n=typeof Reflect=="object"?Reflect:null,e=n&&typeof n.apply=="function"?n.apply:function(g,y,C){return Function.prototype.apply.call(g,y,C)},t;n&&typeof n.ownKeys=="function"?t=n.ownKeys:Object.getOwnPropertySymbols?t=function(g){return Object.getOwnPropertyNames(g).concat(Object.getOwnPropertySymbols(g))}:t=function(g){return Object.getOwnPropertyNames(g)};function i(v){console&&console.warn&&console.warn(v)}var r=Number.isNaN||function(g){return g!==g};function s(){s.init.call(this)}Qn.exports=s,Qn.exports.once=S,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var a=10;function o(v){if(typeof v!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof v)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(v){if(typeof v!="number"||v<0||r(v))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+v+".");a=v}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(g){if(typeof g!="number"||g<0||r(g))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+g+".");return this._maxListeners=g,this};function c(v){return v._maxListeners===void 0?s.defaultMaxListeners:v._maxListeners}s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(g){for(var y=[],C=1;C<arguments.length;C++)y.push(arguments[C]);var x=g==="error",R=this._events;if(R!==void 0)x=x&&R.error===void 0;else if(!x)return!1;if(x){var I;if(y.length>0&&(I=y[0]),I instanceof Error)throw I;var D=new Error("Unhandled error."+(I?" ("+I.message+")":""));throw D.context=I,D}var U=R[g];if(U===void 0)return!1;if(typeof U=="function")e(U,this,y);else for(var V=U.length,G=b(U,V),C=0;C<V;++C)e(G[C],this,y);return!0};function l(v,g,y,C){var x,R,I;if(o(y),R=v._events,R===void 0?(R=v._events=Object.create(null),v._eventsCount=0):(R.newListener!==void 0&&(v.emit("newListener",g,y.listener?y.listener:y),R=v._events),I=R[g]),I===void 0)I=R[g]=y,++v._eventsCount;else if(typeof I=="function"?I=R[g]=C?[y,I]:[I,y]:C?I.unshift(y):I.push(y),x=c(v),x>0&&I.length>x&&!I.warned){I.warned=!0;var D=new Error("Possible EventEmitter memory leak detected. "+I.length+" "+String(g)+" listeners added. Use emitter.setMaxListeners() to increase limit");D.name="MaxListenersExceededWarning",D.emitter=v,D.type=g,D.count=I.length,i(D)}return v}s.prototype.addListener=function(g,y){return l(this,g,y,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(g,y){return l(this,g,y,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(v,g,y){var C={fired:!1,wrapFn:void 0,target:v,type:g,listener:y},x=u.bind(C);return x.listener=y,C.wrapFn=x,x}s.prototype.once=function(g,y){return o(y),this.on(g,d(this,g,y)),this},s.prototype.prependOnceListener=function(g,y){return o(y),this.prependListener(g,d(this,g,y)),this},s.prototype.removeListener=function(g,y){var C,x,R,I,D;if(o(y),x=this._events,x===void 0)return this;if(C=x[g],C===void 0)return this;if(C===y||C.listener===y)--this._eventsCount===0?this._events=Object.create(null):(delete x[g],x.removeListener&&this.emit("removeListener",g,C.listener||y));else if(typeof C!="function"){for(R=-1,I=C.length-1;I>=0;I--)if(C[I]===y||C[I].listener===y){D=C[I].listener,R=I;break}if(R<0)return this;R===0?C.shift():m(C,R),C.length===1&&(x[g]=C[0]),x.removeListener!==void 0&&this.emit("removeListener",g,D||y)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(g){var y,C,x;if(C=this._events,C===void 0)return this;if(C.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):C[g]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete C[g]),this;if(arguments.length===0){var R=Object.keys(C),I;for(x=0;x<R.length;++x)I=R[x],I!=="removeListener"&&this.removeAllListeners(I);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(y=C[g],typeof y=="function")this.removeListener(g,y);else if(y!==void 0)for(x=y.length-1;x>=0;x--)this.removeListener(g,y[x]);return this};function h(v,g,y){var C=v._events;if(C===void 0)return[];var x=C[g];return x===void 0?[]:typeof x=="function"?y?[x.listener||x]:[x]:y?T(x):b(x,x.length)}s.prototype.listeners=function(g){return h(this,g,!0)},s.prototype.rawListeners=function(g){return h(this,g,!1)},s.listenerCount=function(v,g){return typeof v.listenerCount=="function"?v.listenerCount(g):p.call(v,g)},s.prototype.listenerCount=p;function p(v){var g=this._events;if(g!==void 0){var y=g[v];if(typeof y=="function")return 1;if(y!==void 0)return y.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function b(v,g){for(var y=new Array(g),C=0;C<g;++C)y[C]=v[C];return y}function m(v,g){for(;g+1<v.length;g++)v[g]=v[g+1];v.pop()}function T(v){for(var g=new Array(v.length),y=0;y<g.length;++y)g[y]=v[y].listener||v[y];return g}function S(v,g){return new Promise(function(y,C){function x(I){v.removeListener(g,R),C(I)}function R(){typeof v.removeListener=="function"&&v.removeListener("error",x),y([].slice.call(arguments))}M(v,g,R,{once:!0}),g!=="error"&&P(v,x,{once:!0})})}function P(v,g,y){typeof v.on=="function"&&M(v,"error",g,y)}function M(v,g,y,C){if(typeof v.on=="function")C.once?v.once(g,y):v.on(g,y);else if(typeof v.addEventListener=="function")v.addEventListener(g,function x(R){C.once&&v.removeEventListener(g,x),y(R)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof v)}return Qn.exports}var nt=Eh();let xc=!0,Oc=!0;function _n(n,e,t){const i=n.match(e);return i&&i.length>=t&&parseFloat(i[t],10)}function zt(n,e,t){if(!n.RTCPeerConnection)return;const i=n.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(a,o){if(a!==e)return r.apply(this,arguments);const c=l=>{const u=t(l);u&&(o.handleEvent?o.handleEvent(u):o(u))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(o,c),r.apply(this,[a,c])};const s=i.removeEventListener;i.removeEventListener=function(a,o){if(a!==e||!this._eventMap||!this._eventMap[e])return s.apply(this,arguments);if(!this._eventMap[e].has(o))return s.apply(this,arguments);const c=this._eventMap[e].get(o);return this._eventMap[e].delete(o),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[a,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(a){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),a&&this.addEventListener(e,this["_on"+e]=a)},enumerable:!0,configurable:!0})}function wh(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(xc=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function Ph(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(Oc=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function Mc(){if(typeof window=="object"){if(xc)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Ts(n,e){Oc&&console.warn(n+" is deprecated, please use "+e+" instead.")}function Rh(n){const e={browser:null,version:null};if(typeof n>"u"||!n.navigator||!n.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:t}=n;if(t.userAgentData&&t.userAgentData.brands){const i=t.userAgentData.brands.find(r=>r.brand==="Chromium");if(i)return{browser:"chrome",version:parseInt(i.version,10)}}if(t.mozGetUserMedia)e.browser="firefox",e.version=parseInt(_n(t.userAgent,/Firefox\/(\d+)\./,1));else if(t.webkitGetUserMedia||n.isSecureContext===!1&&n.webkitRTCPeerConnection)e.browser="chrome",e.version=parseInt(_n(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else if(n.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))e.browser="safari",e.version=parseInt(_n(t.userAgent,/AppleWebKit\/(\d+)\./,1)),e.supportsUnifiedPlan=n.RTCRtpTransceiver&&"currentDirection"in n.RTCRtpTransceiver.prototype,e._safariVersion=_n(t.userAgent,/Version\/(\d+(\.?\d+))/,1);else return e.browser="Not a supported browser.",e;return e}function So(n){return Object.prototype.toString.call(n)==="[object Object]"}function Dc(n){return So(n)?Object.keys(n).reduce(function(e,t){const i=So(n[t]),r=i?Dc(n[t]):n[t],s=i&&!Object.keys(r).length;return r===void 0||s?e:Object.assign(e,{[t]:r})},{}):n}function Dr(n,e,t){!e||t.has(e.id)||(t.set(e.id,e),Object.keys(e).forEach(i=>{i.endsWith("Id")?Dr(n,n.get(e[i]),t):i.endsWith("Ids")&&e[i].forEach(r=>{Dr(n,n.get(r),t)})}))}function To(n,e,t){const i=t?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const s=[];return n.forEach(a=>{a.type==="track"&&a.trackIdentifier===e.id&&s.push(a)}),s.forEach(a=>{n.forEach(o=>{o.type===i&&o.trackId===a.id&&Dr(n,o,r)})}),r}const Co=Mc;function Ac(n,e){const t=n&&n.navigator;if(!t.mediaDevices)return;const i=function(o){if(typeof o!="object"||o.mandatory||o.optional)return o;const c={};return Object.keys(o).forEach(l=>{if(l==="require"||l==="advanced"||l==="mediaSource")return;const u=typeof o[l]=="object"?o[l]:{ideal:o[l]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const d=function(h,p){return h?h+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(u.ideal!==void 0){c.optional=c.optional||[];let h={};typeof u.ideal=="number"?(h[d("min",l)]=u.ideal,c.optional.push(h),h={},h[d("max",l)]=u.ideal,c.optional.push(h)):(h[d("",l)]=u.ideal,c.optional.push(h))}u.exact!==void 0&&typeof u.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[d("",l)]=u.exact):["min","max"].forEach(h=>{u[h]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[d(h,l)]=u[h])})}),o.advanced&&(c.optional=(c.optional||[]).concat(o.advanced)),c},r=function(o,c){if(e.version>=61)return c(o);if(o=JSON.parse(JSON.stringify(o)),o&&typeof o.audio=="object"){const l=function(u,d,h){d in u&&!(h in u)&&(u[h]=u[d],delete u[d])};o=JSON.parse(JSON.stringify(o)),l(o.audio,"autoGainControl","googAutoGainControl"),l(o.audio,"noiseSuppression","googNoiseSuppression"),o.audio=i(o.audio)}if(o&&typeof o.video=="object"){let l=o.video.facingMode;l=l&&(typeof l=="object"?l:{ideal:l});const u=e.version<66;if(l&&(l.exact==="user"||l.exact==="environment"||l.ideal==="user"||l.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!u)){delete o.video.facingMode;let d;if(l.exact==="environment"||l.ideal==="environment"?d=["back","rear"]:(l.exact==="user"||l.ideal==="user")&&(d=["front"]),d)return t.mediaDevices.enumerateDevices().then(h=>{h=h.filter(b=>b.kind==="videoinput");let p=h.find(b=>d.some(m=>b.label.toLowerCase().includes(m)));return!p&&h.length&&d.includes("back")&&(p=h[h.length-1]),p&&(o.video.deviceId=l.exact?{exact:p.deviceId}:{ideal:p.deviceId}),o.video=i(o.video),Co("chrome: "+JSON.stringify(o)),c(o)})}o.video=i(o.video)}return Co("chrome: "+JSON.stringify(o)),c(o)},s=function(o){return e.version>=64?o:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[o.name]||o.name,message:o.message,constraint:o.constraint||o.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},a=function(o,c,l){r(o,u=>{t.webkitGetUserMedia(u,c,d=>{l&&l(s(d))})})};if(t.getUserMedia=a.bind(t),t.mediaDevices.getUserMedia){const o=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(c){return r(c,l=>o(l).then(u=>{if(l.audio&&!u.getAudioTracks().length||l.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(d=>{d.stop()}),new DOMException("","NotFoundError");return u},u=>Promise.reject(s(u))))}}}function Lc(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function Nc(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",r=>{let s;n.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(o=>o.track&&o.track.id===r.track.id):s={track:r.track};const a=new Event("track");a.track=r.track,a.receiver=s,a.transceiver={receiver:s},a.streams=[i.stream],this.dispatchEvent(a)}),i.stream.getTracks().forEach(r=>{let s;n.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(o=>o.track&&o.track.id===r.id):s={track:r};const a=new Event("track");a.track=r,a.receiver=s,a.transceiver={receiver:s},a.streams=[i.stream],this.dispatchEvent(a)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else zt(n,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function Uc(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){const e=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(o,c){let l=r.apply(this,arguments);return l||(l=e(this,o),this._senders.push(l)),l};const s=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(o){s.apply(this,arguments);const c=this._senders.indexOf(o);c!==-1&&this._senders.splice(c,1)}}const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(s){this._senders=this._senders||[],t.apply(this,[s]),s.getTracks().forEach(a=>{this._senders.push(e(this,a))})};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(s){this._senders=this._senders||[],i.apply(this,[s]),s.getTracks().forEach(a=>{const o=this._senders.find(c=>c.track===a);o&&this._senders.splice(this._senders.indexOf(o),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){const e=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Fc(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){const t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){const s=t.apply(this,[]);return s.forEach(a=>a._pc=this),s});const i=n.RTCPeerConnection.prototype.addTrack;i&&(n.RTCPeerConnection.prototype.addTrack=function(){const s=i.apply(this,arguments);return s._pc=this,s}),n.RTCRtpSender.prototype.getStats=function(){const s=this;return this._pc.getStats().then(a=>To(a,s.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){const t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){const r=t.apply(this,[]);return r.forEach(s=>s._pc=this),r}),zt(n,"track",i=>(i.receiver._pc=i.srcElement,i)),n.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(s=>To(s,r.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype&&"getStats"in n.RTCRtpReceiver.prototype))return;const e=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){const i=arguments[0];let r,s,a;return this.getSenders().forEach(o=>{o.track===i&&(r?a=!0:r=o)}),this.getReceivers().forEach(o=>(o.track===i&&(s?a=!0:s=o),o.track===i)),a||r&&s?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():s?s.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function jc(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(a=>this._shimmedLocalStreams[a][0])};const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(a,o){if(!o)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=e.apply(this,arguments);return this._shimmedLocalStreams[o.id]?this._shimmedLocalStreams[o.id].indexOf(c)===-1&&this._shimmedLocalStreams[o.id].push(c):this._shimmedLocalStreams[o.id]=[o,c],c};const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(a){this._shimmedLocalStreams=this._shimmedLocalStreams||{},a.getTracks().forEach(l=>{if(this.getSenders().find(d=>d.track===l))throw new DOMException("Track already exists.","InvalidAccessError")});const o=this.getSenders();t.apply(this,arguments);const c=this.getSenders().filter(l=>o.indexOf(l)===-1);this._shimmedLocalStreams[a.id]=[a].concat(c)};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[a.id],i.apply(this,arguments)};const r=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},a&&Object.keys(this._shimmedLocalStreams).forEach(o=>{const c=this._shimmedLocalStreams[o].indexOf(a);c!==-1&&this._shimmedLocalStreams[o].splice(c,1),this._shimmedLocalStreams[o].length===1&&delete this._shimmedLocalStreams[o]}),r.apply(this,arguments)}}function Bc(n,e){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&e.version>=65)return jc(n);const t=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){const u=t.apply(this);return this._reverseStreams=this._reverseStreams||{},u.map(d=>this._reverseStreams[d.id])};const i=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(u){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},u.getTracks().forEach(d=>{if(this.getSenders().find(p=>p.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[u.id]){const d=new n.MediaStream(u.getTracks());this._streams[u.id]=d,this._reverseStreams[d.id]=u,u=d}i.apply(this,[u])};const r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(u){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[u.id]||u]),delete this._reverseStreams[this._streams[u.id]?this._streams[u.id].id:u.id],delete this._streams[u.id]},n.RTCPeerConnection.prototype.addTrack=function(u,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(m=>m===u))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(m=>m.track===u))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const b=this._streams[d.id];if(b)b.addTrack(u),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const m=new n.MediaStream([u]);this._streams[d.id]=m,this._reverseStreams[m.id]=d,this.addStream(m)}return this.getSenders().find(m=>m.track===u)};function s(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(h=>{const p=l._reverseStreams[h],b=l._streams[p.id];d=d.replace(new RegExp(b.id,"g"),p.id)}),new RTCSessionDescription({type:u.type,sdp:d})}function a(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(h=>{const p=l._reverseStreams[h],b=l._streams[p.id];d=d.replace(new RegExp(p.id,"g"),b.id)}),new RTCSessionDescription({type:u.type,sdp:d})}["createOffer","createAnswer"].forEach(function(l){const u=n.RTCPeerConnection.prototype[l],d={[l](){const h=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[b=>{const m=s(this,b);h[0].apply(null,[m])},b=>{h[1]&&h[1].apply(null,b)},arguments[2]]):u.apply(this,arguments).then(b=>s(this,b))}};n.RTCPeerConnection.prototype[l]=d[l]});const o=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?o.apply(this,arguments):(arguments[0]=a(this,arguments[0]),o.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){const l=c.get.apply(this);return l.type===""?l:s(this,l)}}),n.RTCPeerConnection.prototype.removeTrack=function(u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!u._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(u._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let h;Object.keys(this._streams).forEach(p=>{this._streams[p].getTracks().find(m=>u.track===m)&&(h=this._streams[p])}),h&&(h.getTracks().length===1?this.removeStream(this._reverseStreams[h.id]):h.removeTrack(u.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Ar(n,e){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const i=n.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new(t==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};n.RTCPeerConnection.prototype[t]=r[t]})}function Vc(n,e){zt(n,"negotiationneeded",t=>{const i=t.target;if(!((e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")&&i.signalingState!=="stable"))return t})}var Eo=Object.freeze({__proto__:null,fixNegotiationNeeded:Vc,shimAddTrackRemoveTrack:Bc,shimAddTrackRemoveTrackWithNative:jc,shimGetSendersWithDtmf:Uc,shimGetUserMedia:Ac,shimMediaStream:Lc,shimOnTrack:Nc,shimPeerConnection:Ar,shimSenderReceiverGetStats:Fc});function qc(n,e){const t=n&&n.navigator,i=n&&n.MediaStreamTrack;if(t.getUserMedia=function(r,s,a){Ts("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(r).then(s,a)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){const r=function(a,o,c){o in a&&!(c in a)&&(a[c]=a[o],delete a[o])},s=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(a){return typeof a=="object"&&typeof a.audio=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a.audio,"autoGainControl","mozAutoGainControl"),r(a.audio,"noiseSuppression","mozNoiseSuppression")),s(a)},i&&i.prototype.getSettings){const a=i.prototype.getSettings;i.prototype.getSettings=function(){const o=a.apply(this,arguments);return r(o,"mozAutoGainControl","autoGainControl"),r(o,"mozNoiseSuppression","noiseSuppression"),o}}if(i&&i.prototype.applyConstraints){const a=i.prototype.applyConstraints;i.prototype.applyConstraints=function(o){return this.kind==="audio"&&typeof o=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o,"autoGainControl","mozAutoGainControl"),r(o,"noiseSuppression","mozNoiseSuppression")),a.apply(this,[o])}}}}function _h(n,e){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return i.video===!0?i.video={mediaSource:e}:i.video.mediaSource=e,n.navigator.mediaDevices.getUserMedia(i)})}function Wc(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Lr(n,e){if(typeof n!="object"||!(n.RTCPeerConnection||n.mozRTCPeerConnection))return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const s=n.RTCPeerConnection.prototype[r],a={[r](){return arguments[0]=new(r==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};n.RTCPeerConnection.prototype[r]=a[r]});const t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[s,a,o]=arguments;return i.apply(this,[s||null]).then(c=>{if(e.version<53&&!a)try{c.forEach(l=>{l.type=t[l.type]||l.type})}catch(l){if(l.name!=="TypeError")throw l;c.forEach((u,d)=>{c.set(d,Object.assign({},u,{type:t[u.type]||u.type}))})}return c}).then(a,o)}}function Hc(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;const e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(s=>s._pc=this),r});const t=n.RTCPeerConnection.prototype.addTrack;t&&(n.RTCPeerConnection.prototype.addTrack=function(){const r=t.apply(this,arguments);return r._pc=this,r}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Kc(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;const e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i}),zt(n,"track",t=>(t.receiver._pc=t.srcElement,t)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function zc(n){!n.RTCPeerConnection||"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){Ts("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&t.getTracks().includes(i.track)&&this.removeTrack(i)})})}function Gc(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function Jc(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.addTransceiver;e&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const r=i.length>0;r&&i.forEach(a=>{if("rid"in a&&!/^[a-z0-9]{0,16}$/i.test(a.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in a&&!(parseFloat(a.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in a&&!(parseFloat(a.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const s=e.apply(this,arguments);if(r){const{sender:a}=s,o=a.getParameters();(!("encodings"in o)||o.encodings.length===1&&Object.keys(o.encodings[0]).length===0)&&(o.encodings=i,a.sendEncodings=i,this.setParametersPromises.push(a.setParameters(o).then(()=>{delete a.sendEncodings}).catch(()=>{delete a.sendEncodings})))}return s})}function $c(n){if(!(typeof n=="object"&&n.RTCRtpSender))return;const e=n.RTCRtpSender.prototype.getParameters;e&&(n.RTCRtpSender.prototype.getParameters=function(){const i=e.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function Qc(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function Yc(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var wo=Object.freeze({__proto__:null,shimAddTransceiver:Jc,shimCreateAnswer:Yc,shimCreateOffer:Qc,shimGetDisplayMedia:_h,shimGetParameters:$c,shimGetUserMedia:qc,shimOnTrack:Wc,shimPeerConnection:Lr,shimRTCDataChannel:Gc,shimReceiverGetStats:Kc,shimRemoveStream:zc,shimSenderGetStats:Hc});function Xc(n){if(!(typeof n!="object"||!n.RTCPeerConnection)){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(r=>e.call(this,r,i)),i.getVideoTracks().forEach(r=>e.call(this,r,i))},n.RTCPeerConnection.prototype.addTrack=function(i){for(var r=arguments.length,s=new Array(r>1?r-1:0),a=1;a<r;a++)s[a-1]=arguments[a];return s&&s.forEach(o=>{this._localStreams?this._localStreams.includes(o)||this._localStreams.push(o):this._localStreams=[o]}),e.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(t);if(i===-1)return;this._localStreams.splice(i,1);const r=t.getTracks();this.getSenders().forEach(s=>{r.includes(s.track)&&this.removeTrack(s)})})}}function Zc(n){if(!(typeof n!="object"||!n.RTCPeerConnection)&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(s=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(s)>=0)return;i._remoteStreams.push(s);const a=new Event("addstream");a.stream=s,i.dispatchEvent(a)})}),e.apply(i,arguments)}}}function el(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const e=n.RTCPeerConnection.prototype,t=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,s=e.setRemoteDescription,a=e.addIceCandidate;e.createOffer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],h=t.apply(this,[d]);return u?(h.then(l,u),Promise.resolve()):h},e.createAnswer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],h=i.apply(this,[d]);return u?(h.then(l,u),Promise.resolve()):h};let o=function(c,l,u){const d=r.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d};e.setLocalDescription=o,o=function(c,l,u){const d=s.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.setRemoteDescription=o,o=function(c,l,u){const d=a.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.addIceCandidate=o}function tl(n){const e=n&&n.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,i=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=r=>i(nl(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(i,r,s){e.mediaDevices.getUserMedia(i).then(r,s)}).bind(e))}function nl(n){return n&&n.video!==void 0?Object.assign({},n,{video:Dc(n.video)}):n}function il(n){if(!n.RTCPeerConnection)return;const e=n.RTCPeerConnection;n.RTCPeerConnection=function(i,r){if(i&&i.iceServers){const s=[];for(let a=0;a<i.iceServers.length;a++){let o=i.iceServers[a];o.urls===void 0&&o.url?(Ts("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,s.push(o)):s.push(i.iceServers[a])}i.iceServers=s}return new e(i,r)},n.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}function rl(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function sl(n){const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(i){if(i){typeof i.offerToReceiveAudio<"u"&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const r=this.getTransceivers().find(a=>a.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof i.offerToReceiveVideo<"u"&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const s=this.getTransceivers().find(a=>a.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&s?s.direction==="sendrecv"?s.setDirection?s.setDirection("sendonly"):s.direction="sendonly":s.direction==="recvonly"&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive"):i.offerToReceiveVideo===!0&&!s&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function ol(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}var Po=Object.freeze({__proto__:null,shimAudioContext:ol,shimCallbacksAPI:el,shimConstraints:nl,shimCreateOfferLegacy:sl,shimGetUserMedia:tl,shimLocalStreamsAPI:Xc,shimRTCIceServerUrls:il,shimRemoteStreamsAPI:Zc,shimTrackEventTransceiver:rl}),or={exports:{}},Ro;function Ih(){return Ro||(Ro=1,(function(n){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(i=>i.trim())},e.splitSections=function(t){return t.split(`
m=`).map((r,s)=>(s>0?"m="+r:r).trim()+`\r
`)},e.getDescription=function(t){const i=e.splitSections(t);return i&&i[0]},e.getMediaSections=function(t){const i=e.splitSections(t);return i.shift(),i},e.matchPrefix=function(t,i){return e.splitLines(t).filter(r=>r.indexOf(i)===0)},e.parseCandidate=function(t){let i;t.indexOf("a=candidate:")===0?i=t.substring(12).split(" "):i=t.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let s=8;s<i.length;s+=2)switch(i[s]){case"raddr":r.relatedAddress=i[s+1];break;case"rport":r.relatedPort=parseInt(i[s+1],10);break;case"tcptype":r.tcpType=i[s+1];break;case"ufrag":r.ufrag=i[s+1],r.usernameFragment=i[s+1];break;default:r[i[s]]===void 0&&(r[i[s]]=i[s+1]);break}return r},e.writeCandidate=function(t){const i=[];i.push(t.foundation);const r=t.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(t.protocol.toUpperCase()),i.push(t.priority),i.push(t.address||t.ip),i.push(t.port);const s=t.type;return i.push("typ"),i.push(s),s!=="host"&&t.relatedAddress&&t.relatedPort&&(i.push("raddr"),i.push(t.relatedAddress),i.push("rport"),i.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(i.push("ufrag"),i.push(t.usernameFragment||t.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let i=t.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(t){let i=t.payloadType;t.preferredPayloadType!==void 0&&(i=t.preferredPayloadType);const r=t.channels||t.numChannels||1;return"a=rtpmap:"+i+" "+t.name+"/"+t.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(t){const i=t.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){const i={};let r;const s=t.substring(t.indexOf(" ")+1).split(";");for(let a=0;a<s.length;a++)r=s[a].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(t){let i="",r=t.payloadType;if(t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const s=[];Object.keys(t.parameters).forEach(a=>{t.parameters[a]!==void 0?s.push(a+"="+t.parameters[a]):s.push(a)}),i+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return i},e.parseRtcpFb=function(t){const i=t.substring(t.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(t){let i="",r=t.payloadType;return t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(s=>{i+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),i},e.parseSsrcMedia=function(t){const i=t.indexOf(" "),r={ssrc:parseInt(t.substring(7,i),10)},s=t.indexOf(":",i);return s>-1?(r.attribute=t.substring(i+1,s),r.value=t.substring(s+1)):r.attribute=t.substring(i+1),r},e.parseSsrcGroup=function(t){const i=t.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},e.getMid=function(t){const i=e.matchPrefix(t,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(t){const i=t.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(t,i){return{role:"auto",fingerprints:e.matchPrefix(t+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,i){let r="a=setup:"+i+`\r
`;return t.fingerprints.forEach(s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),r},e.parseCryptoLine=function(t){const i=t.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;const i=t.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,i){return e.matchPrefix(t+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,i){const r=e.matchPrefix(t+i,"a=ice-ufrag:")[0],s=e.matchPrefix(t+i,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},e.writeIceParameters=function(t){let i="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(t){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},s=e.splitLines(t)[0].split(" ");i.profile=s[2];for(let o=3;o<s.length;o++){const c=s[o],l=e.matchPrefix(t,"a=rtpmap:"+c+" ")[0];if(l){const u=e.parseRtpMap(l),d=e.matchPrefix(t,"a=fmtp:"+c+" ");switch(u.parameters=d.length?e.parseFmtp(d[0]):{},u.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+c+" ").map(e.parseRtcpFb),i.codecs.push(u),u.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(u.name.toUpperCase());break}}}e.matchPrefix(t,"a=extmap:").forEach(o=>{i.headerExtensions.push(e.parseExtmap(o))});const a=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach(o=>{a.forEach(c=>{o.rtcpFeedback.find(u=>u.type===c.type&&u.parameter===c.parameter)||o.rtcpFeedback.push(c)})}),i},e.writeRtpDescription=function(t,i){let r="";r+="m="+t+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(a=>a.preferredPayloadType!==void 0?a.preferredPayloadType:a.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(a=>{r+=e.writeRtpMap(a),r+=e.writeFmtp(a),r+=e.writeRtcpFb(a)});let s=0;return i.codecs.forEach(a=>{a.maxptime>s&&(s=a.maxptime)}),s>0&&(r+="a=maxptime:"+s+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(a=>{r+=e.writeExtmap(a)}),r},e.parseRtpEncodingParameters=function(t){const i=[],r=e.parseRtpParameters(t),s=r.fecMechanisms.indexOf("RED")!==-1,a=r.fecMechanisms.indexOf("ULPFEC")!==-1,o=e.matchPrefix(t,"a=ssrc:").map(h=>e.parseSsrcMedia(h)).filter(h=>h.attribute==="cname"),c=o.length>0&&o[0].ssrc;let l;const u=e.matchPrefix(t,"a=ssrc-group:FID").map(h=>h.substring(17).split(" ").map(b=>parseInt(b,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(l=u[0][1]),r.codecs.forEach(h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let p={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&l&&(p.rtx={ssrc:l}),i.push(p),s&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:a?"red+ulpfec":"red"},i.push(p))}}),i.length===0&&c&&i.push({ssrc:c});let d=e.matchPrefix(t,"b=");return d.length&&(d[0].indexOf("b=TIAS:")===0?d=parseInt(d[0].substring(7),10):d[0].indexOf("b=AS:")===0?d=parseInt(d[0].substring(5),10)*1e3*.95-2e3*8:d=void 0,i.forEach(h=>{h.maxBitrate=d})),i},e.parseRtcpParameters=function(t){const i={},r=e.matchPrefix(t,"a=ssrc:").map(o=>e.parseSsrcMedia(o)).filter(o=>o.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const s=e.matchPrefix(t,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=s.length===0;const a=e.matchPrefix(t,"a=rtcp-mux");return i.mux=a.length>0,i},e.writeRtcpParameters=function(t){let i="";return t.reducedSize&&(i+=`a=rtcp-rsize\r
`),t.mux&&(i+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(i+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),i},e.parseMsid=function(t){let i;const r=e.matchPrefix(t,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=e.matchPrefix(t,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="msid");if(s.length>0)return i=s[0].value.split(" "),{stream:i[0],track:i[1]}},e.parseSctpDescription=function(t){const i=e.parseMLine(t),r=e.matchPrefix(t,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const a=e.matchPrefix(t,"a=sctp-port:");if(a.length>0)return{port:parseInt(a[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const o=e.matchPrefix(t,"a=sctpmap:");if(o.length>0){const c=o[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},e.writeSctpDescription=function(t,i){let r=[];return t.protocol!=="DTLS/SCTP"?r=["m="+t.kind+" 9 "+t.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:r=["m="+t.kind+" 9 "+t.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,i,r){let s;const a=i!==void 0?i:2;return t?s=t:s=e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+a+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,i){const r=e.splitLines(t);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){const r=e.splitLines(t)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},e.parseOLine=function(t){const r=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;const i=e.splitLines(t);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},n.exports=e})(or)),or.exports}var al=Ih(),nn=vh(al),xh=ju({__proto__:null,default:nn},[al]);function ci(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;const e=n.RTCIceCandidate;n.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&(i=JSON.parse(JSON.stringify(i)),i.candidate=i.candidate.substring(2)),i.candidate&&i.candidate.length){const r=new e(i),s=nn.parseCandidate(i.candidate);for(const a in s)a in r||Object.defineProperty(r,a,{value:s[a]});return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new e(i)},n.RTCIceCandidate.prototype=e.prototype,zt(n,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new n.RTCIceCandidate(t.candidate),writable:"false"}),t))}function Nr(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||zt(n,"icecandidate",e=>{if(e.candidate){const t=nn.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function li(n,e){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const t=function(o){if(!o||!o.sdp)return!1;const c=nn.splitSections(o.sdp);return c.shift(),c.some(l=>{const u=nn.parseMLine(l);return u&&u.kind==="application"&&u.protocol.indexOf("SCTP")!==-1})},i=function(o){const c=o.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const l=parseInt(c[1],10);return l!==l?-1:l},r=function(o){let c=65536;return e.browser==="firefox"&&(e.version<57?o===-1?c=16384:c=2147483637:e.version<60?c=e.version===57?65535:65536:c=2147483637),c},s=function(o,c){let l=65536;e.browser==="firefox"&&e.version===57&&(l=65535);const u=nn.matchPrefix(o.sdp,"a=max-message-size:");return u.length>0?l=parseInt(u[0].substring(19),10):e.browser==="firefox"&&c!==-1&&(l=2147483637),l},a=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){const c=i(arguments[0]),l=r(c),u=s(arguments[0],c);let d;l===0&&u===0?d=Number.POSITIVE_INFINITY:l===0||u===0?d=Math.max(l,u):d=Math.min(l,u);const h={};Object.defineProperty(h,"maxMessageSize",{get(){return d}}),this._sctp=h}return a.apply(this,arguments)}}function ui(n){if(!(n.RTCPeerConnection&&"createDataChannel"in n.RTCPeerConnection.prototype))return;function e(i,r){const s=i.send;i.send=function(){const o=arguments[0],c=o.length||o.size||o.byteLength;if(i.readyState==="open"&&r.sctp&&c>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(i,arguments)}}const t=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){const r=t.apply(this,arguments);return e(r,this),r},zt(n,"datachannel",i=>(e(i.channel,i.target),i))}function Ur(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;const e=n.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{const i=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const a=new Event("connectionstatechange",r);s.dispatchEvent(a)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function Fr(n,e){if(!n.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e._safariVersion>=13.1)return;const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const s=r.sdp.split(`
`).filter(a=>a.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&r instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:r.type,sdp:s}):r.sdp=s}return t.apply(this,arguments)}}function di(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.addIceCandidate;!t||t.length===0||(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function hi(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.setLocalDescription;!t||t.length===0||(n.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return t.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?t.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(a=>t.apply(this,[a]))})}var Oh=Object.freeze({__proto__:null,removeExtmapAllowMixed:Fr,shimAddIceCandidateNullOrEmpty:di,shimConnectionState:Ur,shimMaxMessageSize:li,shimParameterlessSetLocalDescription:hi,shimRTCIceCandidate:ci,shimRTCIceCandidateRelayProtocol:Nr,shimSendThrowTypeError:ui});function Mh(){let{window:n}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const t=Mc,i=Rh(n),r={browserDetails:i,commonShim:Oh,extractVersion:_n,disableLog:wh,disableWarnings:Ph,sdp:xh};switch(i.browser){case"chrome":if(!Eo||!Ar||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),r;if(i.version===null)return t("Chrome shim can not determine version, not shimming."),r;t("adapter.js shimming chrome."),r.browserShim=Eo,di(n,i),hi(n),Ac(n,i),Lc(n),Ar(n,i),Nc(n),Bc(n,i),Uc(n),Fc(n),Vc(n,i),ci(n),Nr(n),Ur(n),li(n,i),ui(n),Fr(n,i);break;case"firefox":if(!wo||!Lr||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),r;t("adapter.js shimming firefox."),r.browserShim=wo,di(n,i),hi(n),qc(n,i),Lr(n,i),Wc(n),zc(n),Hc(n),Kc(n),Gc(n),Jc(n),$c(n),Qc(n),Yc(n),ci(n),Ur(n),li(n,i),ui(n);break;case"safari":if(!Po||!e.shimSafari)return t("Safari shim is not included in this adapter release."),r;t("adapter.js shimming safari."),r.browserShim=Po,di(n,i),hi(n),il(n),sl(n),el(n),Xc(n),Zc(n),rl(n),tl(n),ol(n),ci(n),Nr(n),li(n,i),ui(n),Fr(n,i);break;default:t("Unsupported browser!");break}return r}Mh({window:typeof window>"u"?void 0:window});class Pe extends Promise{constructor(e){super(e)}catch(e){return super.catch(e)}static reject(e){return super.reject(e)}static all(e){return super.all(e)}static race(e){return super.race(e)}}const Dh=/version\/(\d+(\.?_?\d+)+)/i;let ar;function Se(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const t=navigator.userAgent.toLowerCase();if(ar===void 0||e){const i=Ah.find(r=>{let{test:s}=r;return s.test(t)});ar=i?.describe(t)}return ar}const Ah=[{test:/firefox|iceweasel|fxios/i,describe(n){return{name:"Firefox",version:fi(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:cr(n)}}},{test:/chrom|crios|crmo/i,describe(n){return{name:"Chrome",version:fi(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("crios")?"iOS":void 0,osVersion:cr(n)}}},{test:/safari|applewebkit/i,describe(n){return{name:"Safari",version:fi(Dh,n),os:n.includes("mobile/")?"iOS":"macOS",osVersion:cr(n)}}}];function fi(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const i=e.match(n);return i&&i.length>=t&&i[t]||""}function cr(n){return n.includes("mac os")?fi(/\(.+?(\d+_\d+(:?_\d+)?)/,n,1).replace(/_/g,"."):void 0}var Lh="2.17.0";const Nh=Lh,Uh=16;class it extends Error{constructor(e,t){super(t||"an error has occured"),this.name="LiveKitError",this.code=e}}var Y;(function(n){n[n.NotAllowed=0]="NotAllowed",n[n.ServerUnreachable=1]="ServerUnreachable",n[n.InternalError=2]="InternalError",n[n.Cancelled=3]="Cancelled",n[n.LeaveRequest=4]="LeaveRequest",n[n.Timeout=5]="Timeout",n[n.WebSocket=6]="WebSocket",n[n.ServiceNotFound=7]="ServiceNotFound"})(Y||(Y={}));class F extends it{constructor(e,t,i,r){super(1,e),this.name="ConnectionError",this.status=i,this.reason=t,this.context=r,this.reasonName=Y[t]}static notAllowed(e,t,i){return new F(e,Y.NotAllowed,t,i)}static timeout(e){return new F(e,Y.Timeout)}static leaveRequest(e,t){return new F(e,Y.LeaveRequest,void 0,t)}static internal(e,t){return new F(e,Y.InternalError,void 0,t)}static cancelled(e){return new F(e,Y.Cancelled)}static serverUnreachable(e,t){return new F(e,Y.ServerUnreachable,t)}static websocket(e,t,i){return new F(e,Y.WebSocket,t,i)}static serviceNotFound(e,t){return new F(e,Y.ServiceNotFound,void 0,t)}}class Cs extends it{constructor(e){super(21,e??"device is unsupported"),this.name="DeviceUnsupportedError"}}class dt extends it{constructor(e){super(20,e??"track is invalid"),this.name="TrackInvalidError"}}class Fh extends it{constructor(e){super(10,e??"unsupported server"),this.name="UnsupportedServer"}}class re extends it{constructor(e){super(12,e??"unexpected connection state"),this.name="UnexpectedConnectionState"}}class rn extends it{constructor(e){super(13,e??"unable to negotiate"),this.name="NegotiationError"}}class _o extends it{constructor(e,t){super(15,e),this.name="PublishTrackError",this.status=t}}class Io extends it{constructor(e,t){super(15,e),this.name="SignalRequestError",this.reason=t,this.reasonName=typeof t=="string"?t:Ss[t]}}var be;(function(n){n[n.AlreadyOpened=0]="AlreadyOpened",n[n.AbnormalEnd=1]="AbnormalEnd",n[n.DecodeFailed=2]="DecodeFailed",n[n.LengthExceeded=3]="LengthExceeded",n[n.Incomplete=4]="Incomplete",n[n.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered",n[n.EncryptionTypeMismatch=8]="EncryptionTypeMismatch"})(be||(be={}));class De extends it{constructor(e,t){super(16,e),this.name="DataStreamError",this.reason=t,this.reasonName=be[t]}}class Qt extends it{constructor(e){super(18,e),this.name="SignalReconnectError"}}var Nn;(function(n){n.PermissionDenied="PermissionDenied",n.NotFound="NotFound",n.DeviceInUse="DeviceInUse",n.Other="Other"})(Nn||(Nn={}));(function(n){function e(t){if(t&&"name"in t)return t.name==="NotFoundError"||t.name==="DevicesNotFoundError"?n.NotFound:t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?n.PermissionDenied:t.name==="NotReadableError"||t.name==="TrackStartError"?n.DeviceInUse:n.Other}n.getFailure=e})(Nn||(Nn={}));class me{}me.setTimeout=function(){return setTimeout(...arguments)};me.setInterval=function(){return setInterval(...arguments)};me.clearTimeout=function(){return clearTimeout(...arguments)};me.clearInterval=function(){return clearInterval(...arguments)};var _;(function(n){n.Connected="connected",n.Reconnecting="reconnecting",n.SignalReconnecting="signalReconnecting",n.Reconnected="reconnected",n.Disconnected="disconnected",n.ConnectionStateChanged="connectionStateChanged",n.Moved="moved",n.MediaDevicesChanged="mediaDevicesChanged",n.ParticipantConnected="participantConnected",n.ParticipantDisconnected="participantDisconnected",n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalAudioSilenceDetected="localAudioSilenceDetected",n.ActiveSpeakersChanged="activeSpeakersChanged",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.ParticipantAttributesChanged="participantAttributesChanged",n.ParticipantActive="participantActive",n.RoomMetadataChanged="roomMetadataChanged",n.DataReceived="dataReceived",n.SipDTMFReceived="sipDTMFReceived",n.TranscriptionReceived="transcriptionReceived",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.AudioPlaybackStatusChanged="audioPlaybackChanged",n.VideoPlaybackStatusChanged="videoPlaybackChanged",n.MediaDevicesError="mediaDevicesError",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.SignalConnected="signalConnected",n.RecordingStatusChanged="recordingStatusChanged",n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ActiveDeviceChanged="activeDeviceChanged",n.ChatMessage="chatMessage",n.LocalTrackSubscribed="localTrackSubscribed",n.MetricsReceived="metricsReceived"})(_||(_={}));var O;(function(n){n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalTrackCpuConstrained="localTrackCpuConstrained",n.LocalSenderCreated="localSenderCreated",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.DataReceived="dataReceived",n.SipDTMFReceived="sipDTMFReceived",n.TranscriptionReceived="transcriptionReceived",n.IsSpeakingChanged="isSpeakingChanged",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.TrackCpuConstrained="trackCpuConstrained",n.MediaDevicesError="mediaDevicesError",n.AudioStreamAcquired="audioStreamAcquired",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.PCTrackAdded="pcTrackAdded",n.AttributesChanged="attributesChanged",n.LocalTrackSubscribed="localTrackSubscribed",n.ChatMessage="chatMessage",n.Active="active"})(O||(O={}));var N;(function(n){n.TransportsCreated="transportsCreated",n.Connected="connected",n.Disconnected="disconnected",n.Resuming="resuming",n.Resumed="resumed",n.Restarting="restarting",n.Restarted="restarted",n.SignalResumed="signalResumed",n.SignalRestarted="signalRestarted",n.Closing="closing",n.MediaTrackAdded="mediaTrackAdded",n.ActiveSpeakersUpdate="activeSpeakersUpdate",n.DataPacketReceived="dataPacketReceived",n.RTPVideoMapUpdate="rtpVideoMapUpdate",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ParticipantUpdate="participantUpdate",n.RoomUpdate="roomUpdate",n.SpeakersChanged="speakersChanged",n.StreamStateChanged="streamStateChanged",n.ConnectionQualityUpdate="connectionQualityUpdate",n.SubscriptionError="subscriptionError",n.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",n.RemoteMute="remoteMute",n.SubscribedQualityUpdate="subscribedQualityUpdate",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalTrackSubscribed="localTrackSubscribed",n.Offline="offline",n.SignalRequestResponse="signalRequestResponse",n.SignalConnected="signalConnected",n.RoomMoved="roomMoved"})(N||(N={}));var L;(function(n){n.Message="message",n.Muted="muted",n.Unmuted="unmuted",n.Restarted="restarted",n.Ended="ended",n.Subscribed="subscribed",n.Unsubscribed="unsubscribed",n.CpuConstrained="cpuConstrained",n.UpdateSettings="updateSettings",n.UpdateSubscription="updateSubscription",n.AudioPlaybackStarted="audioPlaybackStarted",n.AudioPlaybackFailed="audioPlaybackFailed",n.AudioSilenceDetected="audioSilenceDetected",n.VisibilityChanged="visibilityChanged",n.VideoDimensionsChanged="videoDimensionsChanged",n.VideoPlaybackStarted="videoPlaybackStarted",n.VideoPlaybackFailed="videoPlaybackFailed",n.ElementAttached="elementAttached",n.ElementDetached="elementDetached",n.UpstreamPaused="upstreamPaused",n.UpstreamResumed="upstreamResumed",n.SubscriptionPermissionChanged="subscriptionPermissionChanged",n.SubscriptionStatusChanged="subscriptionStatusChanged",n.SubscriptionFailed="subscriptionFailed",n.TrackProcessorUpdate="trackProcessorUpdate",n.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",n.TranscriptionReceived="transcriptionReceived",n.TimeSyncUpdate="timeSyncUpdate",n.PreConnectBufferFlushed="preConnectBufferFlushed"})(L||(L={}));function jh(n){return typeof n>"u"?n:typeof structuredClone=="function"?typeof n=="object"&&n!==null?structuredClone(Object.assign({},n)):structuredClone(n):JSON.parse(JSON.stringify(n))}class J{constructor(e,t,i,r,s){if(typeof e=="object")this.width=e.width,this.height=e.height,this.aspectRatio=e.aspectRatio,this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority};else if(t!==void 0&&i!==void 0)this.width=e,this.height=t,this.aspectRatio=e/t,this.encoding={maxBitrate:i,maxFramerate:r,priority:s};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const Bh=["vp8","h264"],Vh=["vp8","h264","vp9","av1","h265"];function qh(n){return!!Bh.find(e=>e===n)}const Wh=qh;var xo;(function(n){n[n.PREFER_REGRESSION=0]="PREFER_REGRESSION",n[n.SIMULCAST=1]="SIMULCAST",n[n.REGRESSION=2]="REGRESSION"})(xo||(xo={}));var jr;(function(n){n.telephone={maxBitrate:12e3},n.speech={maxBitrate:24e3},n.music={maxBitrate:48e3},n.musicStereo={maxBitrate:64e3},n.musicHighQuality={maxBitrate:96e3},n.musicHighQualityStereo={maxBitrate:128e3}})(jr||(jr={}));const Un={h90:new J(160,90,9e4,20),h180:new J(320,180,16e4,20),h216:new J(384,216,18e4,20),h360:new J(640,360,45e4,20),h540:new J(960,540,8e5,25),h720:new J(1280,720,17e5,30),h1080:new J(1920,1080,3e6,30),h1440:new J(2560,1440,5e6,30),h2160:new J(3840,2160,8e6,30)},Br={h120:new J(160,120,7e4,20),h180:new J(240,180,125e3,20),h240:new J(320,240,14e4,20),h360:new J(480,360,33e4,20),h480:new J(640,480,5e5,20),h540:new J(720,540,6e5,25),h720:new J(960,720,13e5,30),h1080:new J(1440,1080,23e5,30),h1440:new J(1920,1440,38e5,30)},Es={h360fps3:new J(640,360,2e5,3,"medium"),h360fps15:new J(640,360,4e5,15,"medium"),h720fps5:new J(1280,720,8e5,5,"medium"),h720fps15:new J(1280,720,15e5,15,"medium"),h720fps30:new J(1280,720,2e6,30,"medium"),h1080fps15:new J(1920,1080,25e5,15,"medium"),h1080fps30:new J(1920,1080,5e6,30,"medium"),original:new J(0,0,7e6,30,"medium")};function cl(n,e,t){var i,r,s,a;const{optionsWithoutProcessor:o,audioProcessor:c,videoProcessor:l}=dl(n??{}),u=e?.processor,d=t?.processor,h=o??{};return h.audio===!0&&(h.audio={}),h.video===!0&&(h.video={}),h.audio&&(Vr(h.audio,e),(i=(s=h.audio).deviceId)!==null&&i!==void 0||(s.deviceId={ideal:"default"}),(c||u)&&(h.audio.processor=c??u)),h.video&&(Vr(h.video,t),(r=(a=h.video).deviceId)!==null&&r!==void 0||(a.deviceId={ideal:"default"}),(l||d)&&(h.video.processor=l??d)),h}function Vr(n,e){return Object.keys(e).forEach(t=>{n[t]===void 0&&(n[t]=e[t])}),n}function ws(n){var e,t,i,r;const s={};if(n.video)if(typeof n.video=="object"){const a={},o=a,c=n.video;Object.keys(c).forEach(l=>{switch(l){case"resolution":Vr(o,c.resolution);break;default:o[l]=c[l]}}),s.video=a,(e=(i=s.video).deviceId)!==null&&e!==void 0||(i.deviceId={ideal:"default"})}else s.video=n.video?{deviceId:{ideal:"default"}}:!1;else s.video=!1;return n.audio?typeof n.audio=="object"?(s.audio=n.audio,(t=(r=s.audio).deviceId)!==null&&t!==void 0||(r.deviceId={ideal:"default"})):s.audio={deviceId:{ideal:"default"}}:s.audio=!1,s}function ll(n){return k(this,arguments,void 0,function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return(function*(){const i=ul();if(i){const r=i.createAnalyser();r.fftSize=2048;const s=r.frequencyBinCount,a=new Uint8Array(s);i.createMediaStreamSource(new MediaStream([e.mediaStreamTrack])).connect(r),yield ge(t),r.getByteTimeDomainData(a);const c=a.some(l=>l!==128&&l!==0);return i.close(),!c}return!1})()})}function ul(){var n;const e=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(e){const t=new e({latencyHint:"interactive"});if(t.state==="suspended"&&typeof window<"u"&&(!((n=window.document)===null||n===void 0)&&n.body)){const i=()=>k(this,void 0,void 0,function*(){var r;try{t.state==="suspended"&&(yield t.resume())}catch(s){console.warn("Error trying to auto-resume audio context",s)}finally{(r=window.document.body)===null||r===void 0||r.removeEventListener("click",i)}});t.addEventListener("statechange",()=>{var r;t.state==="closed"&&((r=window.document.body)===null||r===void 0||r.removeEventListener("click",i))}),window.document.body.addEventListener("click",i)}return t}}function Hh(n){return n==="audioinput"?E.Source.Microphone:n==="videoinput"?E.Source.Camera:E.Source.Unknown}function qr(n){return n===E.Source.Microphone?"audioinput":n===E.Source.Camera?"videoinput":void 0}function Kh(n){var e,t;let i=(e=n.video)!==null&&e!==void 0?e:!0;return n.resolution&&n.resolution.width>0&&n.resolution.height>0&&(i=typeof i=="boolean"?{}:i,qt()?i=Object.assign(Object.assign({},i),{width:{max:n.resolution.width},height:{max:n.resolution.height},frameRate:n.resolution.frameRate}):i=Object.assign(Object.assign({},i),{width:{ideal:n.resolution.width},height:{ideal:n.resolution.height},frameRate:n.resolution.frameRate})),{audio:(t=n.audio)!==null&&t!==void 0?t:!1,video:i,controller:n.controller,selfBrowserSurface:n.selfBrowserSurface,surfaceSwitching:n.surfaceSwitching,systemAudio:n.systemAudio,preferCurrentTab:n.preferCurrentTab}}function On(n){return n.split("/")[1].toLowerCase()}function zh(n){const e=[];return n.forEach(t=>{t.track!==void 0&&e.push(new gs({cid:t.track.mediaStreamID,track:t.trackInfo}))}),e}function W(n){return"mediaStreamTrack"in n?{trackID:n.sid,source:n.source,muted:n.isMuted,enabled:n.mediaStreamTrack.enabled,kind:n.kind,streamID:n.mediaStreamID,streamTrackID:n.mediaStreamTrack.id}:{trackID:n.trackSid,enabled:n.isEnabled,muted:n.isMuted,trackInfo:Object.assign({mimeType:n.mimeType,name:n.trackName,encrypted:n.isEncrypted,kind:n.kind,source:n.source},n.track?W(n.track):{})}}function Gh(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function Jh(n,e){var t;n===void 0&&(n={}),e===void 0&&(e={});const i=[...Object.keys(e),...Object.keys(n)],r={};for(const s of i)n[s]!==e[s]&&(r[s]=(t=e[s])!==null&&t!==void 0?t:"");return r}function dl(n){const e=Object.assign({},n);let t,i;return typeof e.audio=="object"&&e.audio.processor&&(t=e.audio.processor,e.audio=Object.assign(Object.assign({},e.audio),{processor:void 0})),typeof e.video=="object"&&e.video.processor&&(i=e.video.processor,e.video=Object.assign(Object.assign({},e.video),{processor:void 0})),{audioProcessor:t,videoProcessor:i,optionsWithoutProcessor:jh(e)}}function $h(n){switch(n){case oe.CAMERA:return E.Source.Camera;case oe.MICROPHONE:return E.Source.Microphone;case oe.SCREEN_SHARE:return E.Source.ScreenShare;case oe.SCREEN_SHARE_AUDIO:return E.Source.ScreenShareAudio;default:return E.Source.Unknown}}function Oo(n,e){return n.width*n.height<e.width*e.height}function Qh(n,e){var t;return(t=n.layers)===null||t===void 0?void 0:t.find(i=>i.quality===e)}const Yh=5e3,Sn=[];var xe;(function(n){n[n.LOW=0]="LOW",n[n.MEDIUM=1]="MEDIUM",n[n.HIGH=2]="HIGH"})(xe||(xe={}));class E extends nt.EventEmitter{get streamState(){return this._streamState}setStreamState(e){this._streamState=e}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var r;super(),this.attachedElements=[],this.isMuted=!1,this._streamState=E.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=j,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),Yh):this.handleAppVisibilityChanged()},this.log=ht((r=i.loggerName)!==null&&r!==void 0?r:qe.Track),this.loggerContextCb=i.loggerContextCb,this.setMaxListeners(100),this.kind=t,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=E.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),W(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===E.Kind.Video&&(t="video"),this.attachedElements.length===0&&this.kind===E.Kind.Video&&this.addAppVisibilityListener(),e||(t==="audio"&&(Sn.forEach(s=>{s.parentElement===null&&!e&&(e=s)}),e&&Sn.splice(Sn.indexOf(e),1)),e||(e=document.createElement(t))),this.attachedElements.includes(e)||this.attachedElements.push(e),Xt(this.mediaStreamTrack,e);const i=e.srcObject.getTracks(),r=i.some(s=>s.kind==="audio");return e.play().then(()=>{this.emit(r?L.AudioPlaybackStarted:L.VideoPlaybackStarted)}).catch(s=>{s.name==="NotAllowedError"?this.emit(r?L.AudioPlaybackFailed:L.VideoPlaybackFailed,s):s.name==="AbortError"?j.debug("".concat(r?"audio":"video"," playback aborted, likely due to new play request")):j.warn("could not playback ".concat(r?"audio":"video"),s),r&&e&&i.some(a=>a.kind==="video")&&s.name==="NotAllowedError"&&(e.muted=!0,e.play().catch(()=>{}))}),this.emit(L.ElementAttached,e),e}detach(e){try{if(e){sn(this.mediaStreamTrack,e);const i=this.attachedElements.indexOf(e);return i>=0&&(this.attachedElements.splice(i,1),this.recycleElement(e),this.emit(L.ElementDetached,e)),e}const t=[];return this.attachedElements.forEach(i=>{sn(this.mediaStreamTrack,i),t.push(i),this.recycleElement(i),this.emit(L.ElementDetached,i)}),this.attachedElements=[],t}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=ht(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=!0;e.pause(),Sn.forEach(i=>{i.parentElement||(t=!1)}),t&&Sn.push(e)}}handleAppVisibilityChanged(){return k(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===E.Kind.Video&&setTimeout(()=>this.attachedElements.forEach(e=>e.play().catch(()=>{})),0)})}addAppVisibilityListener(){Re()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){Re()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function Xt(n,e){let t;e.srcObject instanceof MediaStream?t=e.srcObject:t=new MediaStream;let i;n.kind==="audio"?i=t.getAudioTracks():i=t.getVideoTracks(),i.includes(n)||(i.forEach(r=>{t.removeTrack(r)}),t.addTrack(n)),(!qt()||!(e instanceof HTMLVideoElement))&&(e.autoplay=!0),e.muted=t.getAudioTracks().length===0,e instanceof HTMLVideoElement&&(e.playsInline=!0),e.srcObject!==t&&(e.srcObject=t,(qt()||Vt())&&e instanceof HTMLVideoElement&&setTimeout(()=>{e.srcObject=t,e.play().catch(()=>{})},0))}function sn(n,e){if(e.srcObject instanceof MediaStream){const t=e.srcObject;t.removeTrack(n),t.getTracks().length>0?e.srcObject=t:e.srcObject=null}}(function(n){let e;(function(l){l.Audio="audio",l.Video="video",l.Unknown="unknown"})(e=n.Kind||(n.Kind={}));let t;(function(l){l.Camera="camera",l.Microphone="microphone",l.ScreenShare="screen_share",l.ScreenShareAudio="screen_share_audio",l.Unknown="unknown"})(t=n.Source||(n.Source={}));let i;(function(l){l.Active="active",l.Paused="paused",l.Unknown="unknown"})(i=n.StreamState||(n.StreamState={}));function r(l){switch(l){case e.Audio:return Ue.AUDIO;case e.Video:return Ue.VIDEO;default:return Ue.DATA}}n.kindToProto=r;function s(l){switch(l){case Ue.AUDIO:return e.Audio;case Ue.VIDEO:return e.Video;default:return e.Unknown}}n.kindFromProto=s;function a(l){switch(l){case t.Camera:return oe.CAMERA;case t.Microphone:return oe.MICROPHONE;case t.ScreenShare:return oe.SCREEN_SHARE;case t.ScreenShareAudio:return oe.SCREEN_SHARE_AUDIO;default:return oe.UNKNOWN}}n.sourceToProto=a;function o(l){switch(l){case oe.CAMERA:return t.Camera;case oe.MICROPHONE:return t.Microphone;case oe.SCREEN_SHARE:return t.ScreenShare;case oe.SCREEN_SHARE_AUDIO:return t.ScreenShareAudio;default:return t.Unknown}}n.sourceFromProto=o;function c(l){switch(l){case xr.ACTIVE:return i.Active;case xr.PAUSED:return i.Paused;default:return i.Unknown}}n.streamStateFromProto=c})(E||(E={}));const Xh="|",Mo="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function Zh(n){const e=n.split(Xh);return e.length>1?[e[0],n.substr(e[0].length+1)]:[n,""]}function ge(n){return new Pe(e=>me.setTimeout(e,n))}function Wr(){return"addTransceiver"in RTCPeerConnection.prototype}function Hr(){return"addTrack"in RTCPeerConnection.prototype}function ef(){if(!("getCapabilities"in RTCRtpSender)||qt()||Vt())return!1;const n=RTCRtpSender.getCapabilities("video");let e=!1;if(n){for(const t of n.codecs)if(t.mimeType.toLowerCase()==="video/av1"){e=!0;break}}return e}function tf(){if(!("getCapabilities"in RTCRtpSender)||Vt())return!1;if(qt()){const t=Se();if(t?.version&&We(t.version,"16")<0||t?.os==="iOS"&&t?.osVersion&&We(t.osVersion,"16")<0)return!1}const n=RTCRtpSender.getCapabilities("video");let e=!1;if(n){for(const t of n.codecs)if(t.mimeType.toLowerCase()==="video/vp9"){e=!0;break}}return e}function je(n){return n==="av1"||n==="vp9"}function Kr(n){return!document||Fn()?!1:(n||(n=document.createElement("audio")),"setSinkId"in n)}function nf(){return typeof RTCPeerConnection>"u"?!1:Wr()||Hr()}function Vt(){var n;return((n=Se())===null||n===void 0?void 0:n.name)==="Firefox"}function Do(){const n=Se();return!!n&&n.name==="Chrome"&&n.os!=="iOS"}function qt(){var n;return((n=Se())===null||n===void 0?void 0:n.name)==="Safari"}function Fn(){const n=Se();return n?.name==="Safari"||n?.os==="iOS"}function rf(){const n=Se();return n?.name==="Safari"&&n.version.startsWith("17.")||n?.os==="iOS"&&!!n?.osVersion&&We(n.osVersion,"17")>=0}function sf(n){return n||(n=Se()),n?.name==="Safari"&&We(n.version,"18.3")>0||n?.os==="iOS"&&!!n?.osVersion&&We(n.osVersion,"18.3")>0}function hl(){var n,e;return Re()?(e=(n=navigator.userAgentData)===null||n===void 0?void 0:n.mobile)!==null&&e!==void 0?e:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function of(){const n=Se(),e="17.2";if(n)return n.name!=="Safari"&&n.os!=="iOS"||n.os==="iOS"&&n.osVersion&&We(n.osVersion,e)>=0?!0:n.name==="Safari"&&We(n.version,e)>=0}function Re(){return typeof document<"u"}function et(){return navigator.product=="ReactNative"}function dn(n){return n.hostname.endsWith(".livekit.cloud")||n.hostname.endsWith(".livekit.run")}function lr(n){return dn(n)?n.hostname.split(".")[0]:null}function fl(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function pl(){if(!et())return;let n=fl();if(n)return n.platform}function Ao(){if(Re())return window.devicePixelRatio;if(et()){let n=fl();if(n)return n.devicePixelRatio}return 1}function We(n,e){const t=n.split("."),i=e.split("."),r=Math.min(t.length,i.length);for(let s=0;s<r;++s){const a=parseInt(t[s],10),o=parseInt(i[s],10);if(a>o)return 1;if(a<o)return-1;if(s===r-1&&a===o)return 0}return n===""&&e!==""?-1:e===""?1:t.length==i.length?0:t.length<i.length?-1:1}function af(n){for(const e of n)e.target.handleResize(e)}function cf(n){for(const e of n)e.target.handleVisibilityChanged(e)}let ur=null;const Lo=()=>(ur||(ur=new ResizeObserver(af)),ur);let dr=null;const No=()=>(dr||(dr=new IntersectionObserver(cf,{root:null,rootMargin:"0px"})),dr);function lf(){var n;const e=new pc({sdk:mc.JS,protocol:Uh,version:Nh});return et()&&(e.os=(n=pl())!==null&&n!==void 0?n:""),e}function Uo(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const r=document.createElement("canvas");r.width=n,r.height=e;const s=r.getContext("2d");s?.fillRect(0,0,r.width,r.height),i&&s&&(s.beginPath(),s.arc(n/2,e/2,50,0,Math.PI*2,!0),s.closePath(),s.fillStyle="grey",s.fill());const a=r.captureStream(),[o]=a.getTracks();if(!o)throw Error("Could not get empty media stream video track");return o.enabled=t,o}let Tn;function hr(){if(!Tn){const n=new AudioContext,e=n.createOscillator(),t=n.createGain();t.gain.setValueAtTime(0,0);const i=n.createMediaStreamDestination();if(e.connect(t),t.connect(i),e.start(),[Tn]=i.stream.getAudioTracks(),!Tn)throw Error("Could not get empty media stream audio track");Tn.enabled=!1}return Tn.clone()}class Ae{get isResolved(){return this._isResolved}constructor(e,t){this._isResolved=!1,this.onFinally=t,this.promise=new Promise((i,r)=>k(this,void 0,void 0,function*(){this.resolve=i,this.reject=r,e&&(yield e(i,r))})).finally(()=>{var i;this._isResolved=!0,(i=this.onFinally)===null||i===void 0||i.call(this)})}}function uf(n){return Vh.includes(n)}function Pt(n){if(typeof n=="string"||typeof n=="number")return n;if(Array.isArray(n))return n[0];if(n.exact!==void 0)return Array.isArray(n.exact)?n.exact[0]:n.exact;if(n.ideal!==void 0)return Array.isArray(n.ideal)?n.ideal[0]:n.ideal;throw Error("could not unwrap constraint")}function df(n){return n.startsWith("http")?n.replace(/^(http)/,"ws"):n}function jn(n){return n.startsWith("ws")?n.replace(/^(ws)/,"http"):n}function hf(n,e){return n.segments.map(t=>{let{id:i,text:r,language:s,startTime:a,endTime:o,final:c}=t;var l;const u=(l=e.get(i))!==null&&l!==void 0?l:Date.now(),d=Date.now();return c?e.delete(i):e.set(i,u),{id:i,text:r,startTime:Number.parseInt(a.toString()),endTime:Number.parseInt(o.toString()),final:c,language:s,firstReceivedTime:u,lastReceivedTime:d}})}function ff(n){const{id:e,timestamp:t,message:i,editTimestamp:r}=n;return{id:e,timestamp:Number.parseInt(t.toString()),editTimestamp:r?Number.parseInt(r.toString()):void 0,message:i}}function Fo(n){switch(n.reason){case Y.LeaveRequest:return n.context;case Y.Cancelled:return Ve.CLIENT_INITIATED;case Y.NotAllowed:return Ve.USER_REJECTED;case Y.ServerUnreachable:return Ve.JOIN_FAILURE;default:return Ve.UNKNOWN_REASON}}function pi(n){return n!==void 0?Number(n):void 0}function Ut(n){return n!==void 0?BigInt(n):void 0}function Ft(n){return!!n&&!(n instanceof MediaStreamTrack)&&n.isLocal}function Xe(n){return!!n&&n.kind==E.Kind.Audio}function Mt(n){return!!n&&n.kind==E.Kind.Video}function kt(n){return Ft(n)&&Mt(n)}function ot(n){return Ft(n)&&Xe(n)}function zr(n){return!!n&&!n.isLocal}function pf(n){return!!n&&!n.isLocal}function fr(n){return zr(n)&&Mt(n)}function mf(n){return n.isLocal}function gf(n,e){const t=[];let i=new TextEncoder().encode(n);for(;i.length>e;){let r=e;for(;r>0;){const s=i[r];if(s!==void 0&&(s&192)!==128)break;r--}t.push(i.slice(0,r)),i=i.slice(r)}return i.length>0&&t.push(i),t}function vf(n){var e;const t=n.get("Cache-Control");if(t){const i=(e=t.match(/(?:^|[,\s])max-age=(\d+)/))===null||e===void 0?void 0:e[1];if(i)return parseInt(i,10)}}function bf(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;const i=yf(n,e);return t?i:Ps(i,"v1")}function yf(n,e){const t=new URL(df(n));return e.forEach((i,r)=>{t.searchParams.set(r,i)}),Ps(t,"rtc")}function kf(n){const e=new URL(jn(n));return Ps(e,"validate")}function ml(n){return n.endsWith("/")?n:"".concat(n,"/")}function Ps(n,e){return n.pathname="".concat(ml(n.pathname)).concat(e),n}function jo(n){if(typeof n=="string")return vo.fromJson(JSON.parse(n),{ignoreUnknownFields:!0});if(n instanceof ArrayBuffer)return vo.fromBinary(new Uint8Array(n));throw new Error("could not decode websocket message: ".concat(typeof n))}function Sf(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"Unknown reason";if(!(n instanceof AbortSignal))return e;const t=n.reason;switch(typeof t){case"string":return t;case"object":return t instanceof Error?t.message:e;default:return"toString"in t?t.toString():e}}const Tf=10,Cn="lk_e2ee",Cf="LKFrameEncryptionKey",Ef={sharedKey:!1,ratchetSalt:Cf,ratchetWindowSize:8,failureTolerance:Tf,keyringSize:16};var Rt;(function(n){n.SetKey="setKey",n.RatchetRequest="ratchetRequest",n.KeyRatcheted="keyRatcheted"})(Rt||(Rt={}));var Bo;(function(n){n.KeyRatcheted="keyRatcheted"})(Bo||(Bo={}));var Ct;(function(n){n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError"})(Ct||(Ct={}));var Vo;(function(n){n.Error="cryptorError"})(Vo||(Vo={}));function wf(){return Pf()||Gr()}function Gr(){return typeof window.RTCRtpScriptTransform<"u"}function Pf(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}function Rf(n){var e,t,i,r,s;if(((e=n.value)===null||e===void 0?void 0:e.case)!=="sipDtmf"&&((t=n.value)===null||t===void 0?void 0:t.case)!=="metrics"&&((i=n.value)===null||i===void 0?void 0:i.case)!=="speaker"&&((r=n.value)===null||r===void 0?void 0:r.case)!=="transcription"&&((s=n.value)===null||s===void 0?void 0:s.case)!=="encryptedPacket")return new ac({value:n.value})}class ky extends nt.EventEmitter{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(t,i,r)=>{j.debug("key ratcheted event received",{ratchetResult:t,participantId:i,keyIndex:r})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},Ef),e),this.on(Rt.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey(e,t,i){const r={key:e,participantIdentity:t,keyIndex:i};if(!this.options.sharedKey&&!t)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(t??"shared","-").concat(i??0),r),this.emit(Rt.SetKey,r)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(e,t){this.emit(Rt.RatchetRequest,e,t)}}var qo;(function(n){n[n.InvalidKey=0]="InvalidKey",n[n.MissingKey=1]="MissingKey",n[n.InternalError=2]="InternalError"})(qo||(qo={}));class _f extends nt.EventEmitter{constructor(e,t){super(),this.decryptDataRequests=new Map,this.encryptDataRequests=new Map,this.onWorkerMessage=i=>{var r,s;const{kind:a,data:o}=i.data;switch(a){case"error":if(j.error(o.error.message),o.uuid){const u=this.decryptDataRequests.get(o.uuid);if(u?.reject){u.reject(o.error);break}const d=this.encryptDataRequests.get(o.uuid);if(d?.reject){d.reject(o.error);break}}this.emit(Ct.EncryptionError,o.error,o.participantIdentity);break;case"initAck":o.enabled&&this.keyProvider.getKeys().forEach(u=>{this.postKey(u)});break;case"enable":if(o.enabled&&this.keyProvider.getKeys().forEach(u=>{this.postKey(u)}),this.encryptionEnabled!==o.enabled&&o.participantIdentity===((r=this.room)===null||r===void 0?void 0:r.localParticipant.identity))this.emit(Ct.ParticipantEncryptionStatusChanged,o.enabled,this.room.localParticipant),this.encryptionEnabled=o.enabled;else if(o.participantIdentity){const u=(s=this.room)===null||s===void 0?void 0:s.getParticipantByIdentity(o.participantIdentity);if(!u)throw TypeError("couldn't set encryption status, participant not found".concat(o.participantIdentity));this.emit(Ct.ParticipantEncryptionStatusChanged,o.enabled,u)}break;case"ratchetKey":this.keyProvider.emit(Rt.KeyRatcheted,o.ratchetResult,o.participantIdentity,o.keyIndex);break;case"decryptDataResponse":const c=this.decryptDataRequests.get(o.uuid);c?.resolve&&c.resolve(o);break;case"encryptDataResponse":const l=this.encryptDataRequests.get(o.uuid);l?.resolve&&l.resolve(o);break}},this.onWorkerError=i=>{j.error("e2ee worker encountered an error:",{error:i.error}),this.emit(Ct.EncryptionError,i.error,void 0)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1,this.dataChannelEncryptionEnabled=t}get isEnabled(){return this.encryptionEnabled}get isDataChannelEncryptionEnabled(){return this.isEnabled&&this.dataChannelEncryptionEnabled}setup(e){if(!wf())throw new Cs("tried to setup end-to-end encryption on an unsupported browser");if(j.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:kh.getLevel()}};this.worker&&(j.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(t))}}setParticipantCryptorEnabled(e,t){j.debug("set e2ee to ".concat(e," for participant ").concat(t)),this.postEnable(e,t)}setSifTrailer(e){!e||e.length===0?j.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer(e)}setupEngine(e){e.on(N.RTPVideoMapUpdate,t=>{this.postRTPMap(t)})}setupEventListeners(e,t){e.on(_.TrackPublished,(i,r)=>this.setParticipantCryptorEnabled(i.trackInfo.encryption!==le.NONE,r.identity)),e.on(_.ConnectionStateChanged,i=>{i===K.Connected&&e.remoteParticipants.forEach(r=>{r.trackPublications.forEach(s=>{this.setParticipantCryptorEnabled(s.trackInfo.encryption!==le.NONE,r.identity)})})}).on(_.TrackUnsubscribed,(i,r,s)=>{var a;const o={kind:"removeTransform",data:{participantIdentity:s.identity,trackId:i.mediaStreamID}};(a=this.worker)===null||a===void 0||a.postMessage(o)}).on(_.TrackSubscribed,(i,r,s)=>{this.setupE2EEReceiver(i,s.identity,r.trackInfo)}).on(_.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");t.getKeys().forEach(i=>{this.postKey(i)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),e.localParticipant.on(O.LocalSenderCreated,(i,r)=>k(this,void 0,void 0,function*(){this.setupE2EESender(r,i)})),e.localParticipant.on(O.LocalTrackPublished,i=>{if(!Mt(i.track)||!Fn())return;const r={kind:"updateCodec",data:{trackId:i.track.mediaStreamID,codec:On(i.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(r)}),t.on(Rt.SetKey,i=>this.postKey(i)).on(Rt.RatchetRequest,(i,r)=>this.postRatchetRequest(i,r))}encryptData(e){return k(this,void 0,void 0,function*(){if(!this.worker)throw Error("could not encrypt data, worker is missing");const t=crypto.randomUUID(),i={kind:"encryptDataRequest",data:{uuid:t,payload:e,participantIdentity:this.room.localParticipant.identity}},r=new Ae;return r.onFinally=()=>{this.encryptDataRequests.delete(t)},this.encryptDataRequests.set(t,r),this.worker.postMessage(i),r.promise})}handleEncryptedData(e,t,i,r){if(!this.worker)throw Error("could not handle encrypted data, worker is missing");const s=crypto.randomUUID(),a={kind:"decryptDataRequest",data:{uuid:s,payload:e,iv:t,participantIdentity:i,keyIndex:r}},o=new Ae;return o.onFinally=()=>{this.decryptDataRequests.delete(s)},this.decryptDataRequests.set(s,o),this.worker.postMessage(a),o.promise}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const i={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(i)}postKey(e){let{key:t,participantIdentity:i,keyIndex:r}=e;var s;if(!this.worker)throw Error("could not set key, worker is missing");const a={kind:"setKey",data:{participantIdentity:i,isPublisher:i===((s=this.room)===null||s===void 0?void 0:s.localParticipant.identity),key:t,keyIndex:r}};this.worker.postMessage(a)}postEnable(e,t){if(this.worker){const i={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(i)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((t=this.room)===null||t===void 0)&&t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const i={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(i)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,i){if(e.receiver){if(!i?.mimeType||i.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,e.kind==="video"?On(i.mimeType):void 0)}}setupE2EESender(e,t){if(!Ft(e)||!t){t||j.warn("early return because sender is not ready");return}this.handleSender(t,e.mediaStreamID,void 0)}handleReceiver(e,t,i,r){return k(this,void 0,void 0,function*(){if(this.worker){if(Gr()&&!Do()){const s={kind:"decode",participantIdentity:i,trackId:t,codec:r};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{if(Cn in e&&r){const c={kind:"updateCodec",data:{trackId:t,codec:r,participantIdentity:i}};this.worker.postMessage(c);return}let s=e.writableStream,a=e.readableStream;if(!s||!a){const c=e.createEncodedStreams();e.writableStream=c.writable,s=c.writable,e.readableStream=c.readable,a=c.readable}const o={kind:"decode",data:{readableStream:a,writableStream:s,trackId:t,codec:r,participantIdentity:i,isReuse:Cn in e}};this.worker.postMessage(o,[a,s])}e[Cn]=!0}})}handleSender(e,t,i){var r;if(!(Cn in e||!this.worker)){if(!(!((r=this.room)===null||r===void 0)&&r.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(Gr()&&!Do()){j.info("initialize script transform");const s={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:i};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{j.info("initialize encoded streams");const s=e.createEncodedStreams(),a={kind:"encode",data:{readableStream:s.readable,writableStream:s.writable,codec:i,trackId:t,participantIdentity:this.room.localParticipant.identity,isReuse:!1}};this.worker.postMessage(a,[s.readable,s.writable])}e[Cn]=!0}}}const If=500,xf=15e3;class on{constructor(){this.failedConnectionAttempts=new Map,this.backOffPromises=new Map}static getInstance(){return this._instance||(this._instance=new on),this._instance}addFailedConnectionAttempt(e){var t;const i=new URL(e),r=lr(i);if(!r)return;let s=(t=this.failedConnectionAttempts.get(r))!==null&&t!==void 0?t:0;this.failedConnectionAttempts.set(r,s+1),this.backOffPromises.set(r,ge(Math.min(If*Math.pow(2,s),xf)))}getBackOffPromise(e){const t=new URL(e),i=t&&lr(t);return i&&this.backOffPromises.get(i)||Promise.resolve()}resetFailedConnectionAttempts(e){const t=new URL(e),i=t&&lr(t);i&&(this.failedConnectionAttempts.set(i,0),this.backOffPromises.set(i,Promise.resolve()))}resetAll(){this.backOffPromises.clear(),this.failedConnectionAttempts.clear()}}on._instance=null;const pr="default";class fe{constructor(){this._previousDevices=[]}static getInstance(){return this.instance===void 0&&(this.instance=new fe),this.instance}get previousDevices(){return this._previousDevices}getDevices(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var s;if(((s=fe.userMediaPromiseMap)===null||s===void 0?void 0:s.size)>0){j.debug("awaiting getUserMedia promise");try{t?yield fe.userMediaPromiseMap.get(t):yield Promise.all(fe.userMediaPromiseMap.values())}catch{j.warn("error waiting for media permissons")}}let a=yield navigator.mediaDevices.enumerateDevices();if(r&&!(qt()&&i.hasDeviceInUse(t))&&(a.filter(c=>c.kind===t).length===0||a.some(c=>{const l=c.label==="",u=t?c.kind===t:!0;return l&&u}))){const c={video:t!=="audioinput"&&t!=="audiooutput",audio:t!=="videoinput"&&{deviceId:{ideal:"default"}}},l=yield navigator.mediaDevices.getUserMedia(c);a=yield navigator.mediaDevices.enumerateDevices(),l.getTracks().forEach(u=>{u.stop()})}return i._previousDevices=a,t&&(a=a.filter(o=>o.kind===t)),a})()})}normalizeDeviceId(e,t,i){return k(this,void 0,void 0,function*(){if(t!==pr)return t;const r=yield this.getDevices(e),s=r.find(o=>o.deviceId===pr);if(!s){j.warn("could not reliably determine default device");return}const a=r.find(o=>o.deviceId!==pr&&o.groupId===(i??s.groupId));if(!a){j.warn("could not reliably determine default device");return}return a?.deviceId})}hasDeviceInUse(e){return e?fe.userMediaPromiseMap.has(e):fe.userMediaPromiseMap.size>0}}fe.mediaDeviceKinds=["audioinput","audiooutput","videoinput"];fe.userMediaPromiseMap=new Map;var Mn;(function(n){n[n.WAITING=0]="WAITING",n[n.RUNNING=1]="RUNNING",n[n.COMPLETED=2]="COMPLETED"})(Mn||(Mn={}));class Of{constructor(){this.pendingTasks=new Map,this.taskMutex=new ke,this.nextTaskIndex=0}run(e){return k(this,void 0,void 0,function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:Mn.WAITING};this.pendingTasks.set(t.id,t);const i=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=Mn.RUNNING,yield e()}finally{t.status=Mn.COMPLETED,this.pendingTasks.delete(t.id),i()}})}flush(){return k(this,void 0,void 0,function*(){return this.run(()=>k(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}class Mf{get readyState(){return this.ws.readyState}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i,r;if(!((i=t.signal)===null||i===void 0)&&i.aborted)throw new DOMException("This operation was aborted","AbortError");this.url=e;const s=new WebSocket(e,(r=t.protocols)!==null&&r!==void 0?r:[]);s.binaryType="arraybuffer",this.ws=s;const a=function(){let{closeCode:o,reason:c}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return s.close(o,c)};this.opened=new Pe((o,c)=>{const l=()=>{c(F.websocket("Encountered websocket error during connection establishment"))};s.onopen=()=>{o({readable:new ReadableStream({start(u){s.onmessage=d=>{let{data:h}=d;return u.enqueue(h)},s.onerror=d=>u.error(d)},cancel:a}),writable:new WritableStream({write(u){s.send(u)},abort(){s.close()},close:a}),protocol:s.protocol,extensions:s.extensions}),s.removeEventListener("error",l)},s.addEventListener("error",l)}),this.closed=new Pe((o,c)=>{const l=()=>k(this,void 0,void 0,function*(){const u=new Pe(h=>{s.readyState!==WebSocket.CLOSED&&s.addEventListener("close",p=>{h(p)},{once:!0})}),d=yield Pe.race([ge(250),u]);d?o(d):c(F.websocket("Encountered unspecified websocket error without a timely close event"))});s.onclose=u=>{let{code:d,reason:h}=u;o({closeCode:d,reason:h}),s.removeEventListener("error",l)},s.addEventListener("error",l)}),t.signal&&(t.signal.onabort=()=>s.close()),this.close=a}}const Df=["syncState","trickle","offer","answer","simulate","leave"];function Af(n){const e=Df.indexOf(n.case)>=0;return j.trace("request allowed to bypass queue:",{canPass:e,req:n}),e}var Q;(function(n){n[n.CONNECTING=0]="CONNECTING",n[n.CONNECTED=1]="CONNECTED",n[n.RECONNECTING=2]="RECONNECTING",n[n.DISCONNECTING=3]="DISCONNECTING",n[n.DISCONNECTED=4]="DISCONNECTED"})(Q||(Q={}));const Lf=250;class Rs{get currentState(){return this.state}get isDisconnected(){return this.state===Q.DISCONNECTING||this.state===Q.DISCONNECTED}get isEstablishingConnection(){return this.state===Q.CONNECTING||this.state===Q.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;this.rtt=0,this.state=Q.DISCONNECTED,this.log=j,this._requestId=0,this.useV0SignalPath=!1,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0,this.onMediaSectionsRequirement=void 0},this.log=ht((i=t.loggerName)!==null&&i!==void 0?i:qe.Signal),this.loggerContextCb=t.loggerContextCb,this.useJSON=e,this.requestQueue=new Of,this.queuedRequests=[],this.closingLock=new ke,this.connectionLock=new ke,this.state=Q.DISCONNECTED}get logContext(){var e,t;return(t=(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:{}}join(e,t,i,r){return k(this,arguments,void 0,function(s,a,o,c){var l=this;let u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;return(function*(){return l.state=Q.CONNECTING,l.options=o,yield l.connect(s,a,o,c,u)})()})}reconnect(e,t,i,r){return k(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=Q.RECONNECTING,this.clearPingInterval(),yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:i,reconnectReason:r}),void 0,this.useV0SignalPath)})}connect(e,t,i,r){return k(this,arguments,void 0,function(s,a,o,c){var l=this;let u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;return(function*(){const d=yield l.connectionLock.lock();l.connectOptions=o,l.useV0SignalPath=u;const h=lf(),p=u?Nf(a,h,o):Uf(a,h,o),b=bf(s,p,u).toString(),m=kf(b).toString();return new Promise((T,S)=>k(l,void 0,void 0,function*(){var P,M;try{let v=!1;const g=I=>k(this,void 0,void 0,function*(){if(v)return;v=!0;const D=I instanceof Event?I.currentTarget:I,U=Sf(D,"Abort handler called");this.streamWriter&&!this.isDisconnected?this.sendLeave().then(()=>this.close(U)).catch(V=>{this.log.error(V),this.close()}):this.close(),y(),S(F.cancelled(U))});c?.addEventListener("abort",g);const y=()=>{clearTimeout(C),c?.removeEventListener("abort",g)},C=setTimeout(()=>{g(F.timeout("room connection has timed out (signal)"))},o.websocketTimeout),x=(I,D)=>{this.handleSignalConnected(I,C,D)},R=new URL(b);R.searchParams.has("access_token")&&R.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(R),Object.assign({reconnect:o.reconnect,reconnectReason:o.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new Mf(b);try{this.ws.closed.then($=>{var ee;this.isEstablishingConnection&&S(F.internal("Websocket got closed during a (re)connection attempt: ".concat($.reason))),$.closeCode!==1e3&&(this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:$.reason,code:$.closeCode,wasClean:$.closeCode===1e3,state:this.state})),this.state===Q.CONNECTED&&this.handleOnClose((ee=$.reason)!==null&&ee!==void 0?ee:"Unexpected WS error"))}).catch($=>{this.isEstablishingConnection&&S(F.internal("Websocket error during a (re)connection attempt: ".concat($)))});const I=yield this.ws.opened.catch($=>k(this,void 0,void 0,function*(){if(this.state!==Q.CONNECTED){this.state=Q.DISCONNECTED,clearTimeout(C);const ee=yield this.handleConnectionError($,m);S(ee);return}this.handleWSError($),S($)}));if(clearTimeout(C),!I)return;const D=I.readable.getReader();this.streamWriter=I.writable.getWriter();const U=yield D.read();if(D.releaseLock(),!U.value)throw F.internal("no message received as first message");const V=jo(U.value),G=this.validateFirstMessage(V,(P=o.reconnect)!==null&&P!==void 0?P:!1);if(!G.isValid){S(G.error);return}((M=V.message)===null||M===void 0?void 0:M.case)==="join"&&(this.pingTimeoutDuration=V.message.value.pingTimeout,this.pingIntervalDuration=V.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})));const Ce=G.shouldProcessFirstMessage?V:void 0;x(I,Ce),T(G.response)}catch(I){S(I)}finally{y()}}finally{d()}}))})()})}startReadingLoop(e,t){return k(this,void 0,void 0,function*(){for(t&&this.handleSignalResponse(t);;){this.signalLatency&&(yield ge(this.signalLatency));const{done:i,value:r}=yield e.read();if(i)break;const s=jo(r);this.handleSignalResponse(s)}})}close(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"Close method called on signal client";return(function*(){if([Q.DISCONNECTING||Q.DISCONNECTED].includes(e.state)){e.log.debug("ignoring signal close as it's already in disconnecting state");return}const r=yield e.closingLock.lock();try{if(e.clearPingInterval(),t&&(e.state=Q.DISCONNECTING),e.ws){e.ws.close({closeCode:1e3,reason:i});const s=e.ws.closed;e.ws=void 0,e.streamWriter=void 0,yield Promise.race([s,ge(Lf)])}}catch(s){e.log.debug("websocket error while closing",Object.assign(Object.assign({},e.logContext),{error:s}))}finally{t&&(e.state=Q.DISCONNECTED),r()}})()})}sendOffer(e,t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:Zt(e,t)})}sendAnswer(e,t){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:Zt(e,t)})}sendIceCandidate(e,t){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new Fi({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new ji({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return k(this,arguments,void 0,function(i,r){var s=this;let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return(function*(){const o=s.getNextRequestId();return yield s.sendRequest({case:"updateMetadata",value:new bs({requestId:o,metadata:i,name:r,attributes:a})}),o})()})}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new Tc({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new wc({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:Z.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new _c({timestamp:Z.parse(Date.now()),rtt:Z.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,t){return this.sendRequest({case:"updateAudioTrack",value:new vs({trackSid:e,features:t})})}sendLeave(){return this.sendRequest({case:"leave",value:new Vi({reason:Ve.CLIENT_INITIATED,action:tn.DISCONNECT})})}sendRequest(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return(function*(){if(!r&&!Af(t)&&i.state===Q.RECONNECTING){i.queuedRequests.push(()=>k(i,void 0,void 0,function*(){yield this.sendRequest(t,!0)}));return}if(r||(yield i.requestQueue.flush()),i.signalLatency&&(yield ge(i.signalLatency)),i.isDisconnected){i.log.debug("skipping signal request (type: ".concat(t.case,") - SignalClient disconnected"));return}if(!i.streamWriter){i.log.error("cannot send signal request before connected, type: ".concat(t?.case),i.logContext);return}const a=new Kd({message:t});try{i.useJSON?yield i.streamWriter.write(a.toJsonString()):yield i.streamWriter.write(a.toBinary())}catch(o){i.log.error("error sending signal message",Object.assign(Object.assign({},i.logContext),{error:o}))}})()})}handleSignalResponse(e){var t,i;const r=e.message;if(r==null){this.log.debug("received unsupported message",this.logContext);return}let s=!1;if(r.case==="answer"){const a=Wo(r.value);this.onAnswer&&this.onAnswer(a,r.value.id,r.value.midToTrackId)}else if(r.case==="offer"){const a=Wo(r.value);this.onOffer&&this.onOffer(a,r.value.id,r.value.midToTrackId)}else if(r.case==="trickle"){const a=JSON.parse(r.value.candidateInit);this.onTrickle&&this.onTrickle(a,r.value.target)}else r.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((t=r.value.participants)!==null&&t!==void 0?t:[]):r.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(r.value):r.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((i=r.value.speakers)!==null&&i!==void 0?i:[]):r.case==="leave"?this.onLeave&&this.onLeave(r.value):r.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(r.value.sid,r.value.muted):r.case==="roomUpdate"?this.onRoomUpdate&&r.value.room&&this.onRoomUpdate(r.value.room):r.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(r.value):r.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(r.value):r.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(r.value):r.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(r.value):r.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(r.value):r.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(r.value):r.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(r.value):r.case==="pong"||(r.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(r.value.lastPingTimestamp.toString()),this.resetPingTimeout(),s=!0):r.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(r.value):r.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(r.value.trackSid):r.case==="roomMoved"?(this.onTokenRefresh&&this.onTokenRefresh(r.value.token),this.onRoomMoved&&this.onRoomMoved(r.value)):r.case==="mediaSectionsRequirement"?this.onMediaSectionsRequirement&&this.onMediaSectionsRequirement(r.value):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:r.case})));s||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return k(this,void 0,void 0,function*(){if(this.state===Q.DISCONNECTED)return;const t=this.onClose;yield this.close(void 0,e),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),t&&t(e)})}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=me.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&me.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=me.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&me.clearInterval(this.pingInterval)}handleSignalConnected(e,t,i){this.state=Q.CONNECTED,clearTimeout(t),this.startPingInterval(),this.startReadingLoop(e.readable.getReader(),i)}validateFirstMessage(e,t){var i,r,s,a,o;return((i=e.message)===null||i===void 0?void 0:i.case)==="join"?{isValid:!0,response:e.message.value}:this.state===Q.RECONNECTING&&((r=e.message)===null||r===void 0?void 0:r.case)!=="leave"?((s=e.message)===null||s===void 0?void 0:s.case)==="reconnect"?{isValid:!0,response:e.message.value}:(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),{isValid:!0,response:void 0,shouldProcessFirstMessage:!0}):this.isEstablishingConnection&&((a=e.message)===null||a===void 0?void 0:a.case)==="leave"?{isValid:!1,error:F.leaveRequest("Received leave request while trying to (re)connect",e.message.value.reason)}:t?{isValid:!1,error:F.internal("Unexpected first message")}:{isValid:!1,error:F.internal("did not receive join response, got ".concat((o=e.message)===null||o===void 0?void 0:o.case," instead"))}}handleConnectionError(e,t){return k(this,void 0,void 0,function*(){try{const i=yield fetch(t);switch(i.status){case 404:return F.serviceNotFound("v1 RTC path not found. Consider upgrading your LiveKit server version","v0-rtc");case 401:case 403:const r=yield i.text();return F.notAllowed(r,i.status);default:break}return e instanceof F?e:F.internal("Encountered unknown websocket error during connection: ".concat(e),{status:i.status,statusText:i.statusText})}catch(i){return i instanceof F?i:F.serverUnreachable(i instanceof Error?i.message:"server was not reachable")}})}}function Wo(n){const e={type:"offer",sdp:n.sdp};switch(n.type){case"answer":case"offer":case"pranswer":case"rollback":e.type=n.type;break}return e}function Zt(n,e){return new xt({sdp:n.sdp,type:n.type,id:e})}function Nf(n,e,t){var i;const r=new URLSearchParams;return r.set("access_token",n),t.reconnect&&(r.set("reconnect","1"),t.sid&&r.set("sid",t.sid)),r.set("auto_subscribe",t.autoSubscribe?"1":"0"),r.set("sdk",et()?"reactnative":"js"),r.set("version",e.version),r.set("protocol",e.protocol.toString()),e.deviceModel&&r.set("device_model",e.deviceModel),e.os&&r.set("os",e.os),e.osVersion&&r.set("os_version",e.osVersion),e.browser&&r.set("browser",e.browser),e.browserVersion&&r.set("browser_version",e.browserVersion),t.adaptiveStream&&r.set("adaptive_stream","1"),t.reconnectReason&&r.set("reconnect_reason",t.reconnectReason.toString()),!((i=navigator.connection)===null||i===void 0)&&i.type&&r.set("network",navigator.connection.type),r}function Uf(n,e,t){const i=new URLSearchParams;i.set("access_token",n);const r=new fh({clientInfo:e,connectionSettings:new Ic({autoSubscribe:!!t.autoSubscribe,adaptiveStream:!!t.adaptiveStream}),reconnect:!!t.reconnect,participantSid:t.sid?t.sid:void 0});t.reconnectReason&&(r.reconnectReason=t.reconnectReason);const s=new ph({joinRequest:r.toBinary()});return i.set("join_request",btoa(new TextDecoder("utf-8").decode(s.toBinary()))),i}class Ho{constructor(){this.buffer=[],this._totalSize=0}push(e){this.buffer.push(e),this._totalSize+=e.data.byteLength}pop(){const e=this.buffer.shift();return e&&(this._totalSize-=e.data.byteLength),e}getAll(){return this.buffer.slice()}popToSequence(e){for(;this.buffer.length>0&&this.buffer[0].sequence<=e;)this.pop()}alignBufferedAmount(e){for(;this.buffer.length>0;){const t=this.buffer[0];if(this._totalSize-t.data.byteLength<=e)break;this.pop()}}get length(){return this.buffer.length}}class Ff{constructor(e){this._map=new Map,this._lastCleanup=0,this.ttl=e}set(e,t){const i=Date.now();i-this._lastCleanup>this.ttl/2&&this.cleanup();const r=i+this.ttl;return this._map.set(e,{value:t,expiresAt:r}),this}get(e){const t=this._map.get(e);if(t){if(t.expiresAt<Date.now()){this._map.delete(e);return}return t.value}}has(e){const t=this._map.get(e);return t?t.expiresAt<Date.now()?(this._map.delete(e),!1):!0:!1}delete(e){return this._map.delete(e)}clear(){this._map.clear()}cleanup(){const e=Date.now();for(const[t,i]of this._map.entries())i.expiresAt<e&&this._map.delete(t);this._lastCleanup=e}get size(){return this.cleanup(),this._map.size}forEach(e){this.cleanup();for(const[t,i]of this._map.entries())i.expiresAt>=Date.now()&&e(i.value,t,this.asValueMap())}map(e){this.cleanup();const t=[],i=this.asValueMap();for(const[r,s]of i.entries())t.push(e(s,r,i));return t}asValueMap(){const e=new Map;for(const[t,i]of this._map.entries())i.expiresAt>=Date.now()&&e.set(t,i.value);return e}}var Le={},mr={},gr={exports:{}},Ko;function _s(){if(Ko)return gr.exports;Ko=1;var n=gr.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(n).forEach(function(e){var t=n[e];t.forEach(function(i){i.reg||(i.reg=/(.*)/),i.format||(i.format="%s")})}),gr.exports}var zo;function jf(){return zo||(zo=1,(function(n){var e=function(o){return String(Number(o))===o?Number(o):o},t=function(o,c,l,u){if(u&&!l)c[u]=e(o[1]);else for(var d=0;d<l.length;d+=1)o[d+1]!=null&&(c[l[d]]=e(o[d+1]))},i=function(o,c,l){var u=o.name&&o.names;o.push&&!c[o.push]?c[o.push]=[]:u&&!c[o.name]&&(c[o.name]={});var d=o.push?{}:u?c[o.name]:c;t(l.match(o.reg),d,o.names,o.name),o.push&&c[o.push].push(d)},r=_s(),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);n.parse=function(o){var c={},l=[],u=c;return o.split(/(\r\n|\r|\n)/).filter(s).forEach(function(d){var h=d[0],p=d.slice(2);h==="m"&&(l.push({rtp:[],fmtp:[]}),u=l[l.length-1]);for(var b=0;b<(r[h]||[]).length;b+=1){var m=r[h][b];if(m.reg.test(p))return i(m,u,p)}}),c.media=l,c};var a=function(o,c){var l=c.split(/=(.+)/,2);return l.length===2?o[l[0]]=e(l[1]):l.length===1&&c.length>1&&(o[l[0]]=void 0),o};n.parseParams=function(o){return o.split(/;\s?/).reduce(a,{})},n.parseFmtpConfig=n.parseParams,n.parsePayloads=function(o){return o.toString().split(" ").map(Number)},n.parseRemoteCandidates=function(o){for(var c=[],l=o.split(" ").map(e),u=0;u<l.length;u+=3)c.push({component:l[u],ip:l[u+1],port:l[u+2]});return c},n.parseImageAttributes=function(o){return o.split(" ").map(function(c){return c.substring(1,c.length-1).split(",").reduce(a,{})})},n.parseSimulcastStreamList=function(o){return o.split(";").map(function(c){return c.split(",").map(function(l){var u,d=!1;return l[0]!=="~"?u=e(l):(u=e(l.substring(1,l.length)),d=!0),{scid:u,paused:d}})})}})(mr)),mr}var vr,Go;function Bf(){if(Go)return vr;Go=1;var n=_s(),e=/%[sdv%]/g,t=function(a){var o=1,c=arguments,l=c.length;return a.replace(e,function(u){if(o>=l)return u;var d=c[o];switch(o+=1,u){case"%%":return"%";case"%s":return String(d);case"%d":return Number(d);case"%v":return""}})},i=function(a,o,c){var l=o.format instanceof Function?o.format(o.push?c:c[o.name]):o.format,u=[a+"="+l];if(o.names)for(var d=0;d<o.names.length;d+=1){var h=o.names[d];o.name?u.push(c[o.name][h]):u.push(c[o.names[d]])}else u.push(c[o.name]);return t.apply(null,u)},r=["v","o","s","i","u","e","p","c","b","t","r","z","a"],s=["i","c","b","a"];return vr=function(a,o){o=o||{},a.version==null&&(a.version=0),a.name==null&&(a.name=" "),a.media.forEach(function(d){d.payloads==null&&(d.payloads="")});var c=o.outerOrder||r,l=o.innerOrder||s,u=[];return c.forEach(function(d){n[d].forEach(function(h){h.name in a&&a[h.name]!=null?u.push(i(d,h,a)):h.push in a&&a[h.push]!=null&&a[h.push].forEach(function(p){u.push(i(d,h,p))})})}),a.media.forEach(function(d){u.push(i("m",n.m[0],d)),l.forEach(function(h){n[h].forEach(function(p){p.name in d&&d[p.name]!=null?u.push(i(h,p,d)):p.push in d&&d[p.push]!=null&&d[p.push].forEach(function(b){u.push(i(h,p,b))})})})}),u.join(`\r
`)+`\r
`},vr}var Jo;function Vf(){if(Jo)return Le;Jo=1;var n=jf(),e=Bf(),t=_s();return Le.grammar=t,Le.write=e,Le.parse=n.parse,Le.parseParams=n.parseParams,Le.parseFmtpConfig=n.parseFmtpConfig,Le.parsePayloads=n.parsePayloads,Le.parseRemoteCandidates=n.parseRemoteCandidates,Le.parseImageAttributes=n.parseImageAttributes,Le.parseSimulcastStreamList=n.parseSimulcastStreamList,Le}var St=Vf();function Is(n,e,t){var i,r,s;e===void 0&&(e=50),t===void 0&&(t={});var a=(i=t.isImmediate)!=null&&i,o=(r=t.callback)!=null&&r,c=t.maxWait,l=Date.now(),u=[];function d(){if(c!==void 0){var p=Date.now()-l;if(p+e>=c)return c-p}return e}var h=function(){var p=[].slice.call(arguments),b=this;return new Promise(function(m,T){var S=a&&s===void 0;if(s!==void 0&&clearTimeout(s),s=setTimeout(function(){if(s=void 0,l=Date.now(),!a){var M=n.apply(b,p);o&&o(M),u.forEach(function(v){return(0,v.resolve)(M)}),u=[]}},d()),S){var P=n.apply(b,p);return o&&o(P),m(P)}u.push({resolve:m,reject:T})})};return h.cancel=function(p){s!==void 0&&clearTimeout(s),u.forEach(function(b){return(0,b.reject)(p)}),u=[]},h}const qf=.7,Wf=20,an={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class $o extends nt.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;super(),this.log=j,this.ddExtID=0,this.latestOfferId=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=Is(r=>k(this,void 0,void 0,function*(){this.emit(an.NegotiationStarted);try{yield this.createAndSendOffer()}catch(s){if(r)r(s);else throw s}}),Wf),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=ht((i=t.loggerName)!==null&&i!==void 0?i:qe.PCTransport),this.loggerOptions=t,this.config=e,this._pc=this.createPC(),this.offerLock=new ke}createPC(){const e=new RTCPeerConnection(this.config);return e.onicecandidate=t=>{var i;t.candidate&&((i=this.onIceCandidate)===null||i===void 0||i.call(this,t.candidate))},e.onicecandidateerror=t=>{var i;(i=this.onIceCandidateError)===null||i===void 0||i.call(this,t)},e.oniceconnectionstatechange=()=>{var t;(t=this.onIceConnectionStateChange)===null||t===void 0||t.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var t;(t=this.onSignalingStatechange)===null||t===void 0||t.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,e.connectionState)},e.ondatachannel=t=>{var i;(i=this.onDataChannel)===null||i===void 0||i.call(this,t)},e.ontrack=t=>{var i;(i=this.onTrack)===null||i===void 0||i.call(this,t)},e}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(e){return k(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)})}setRemoteDescription(e,t){return k(this,void 0,void 0,function*(){var i;if(e.type==="answer"&&this.latestOfferId>0&&t>0&&t!==this.latestOfferId)return this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:t,latestOfferId:this.latestOfferId})),!1;let r;if(e.type==="offer"){let{stereoMids:s,nackMids:a}=Hf(e);this.remoteStereoMids=s,this.remoteNackMids=a}else if(e.type==="answer"){const s=St.parse((i=e.sdp)!==null&&i!==void 0?i:"");s.media.forEach(a=>{const o=xs(a.mid);a.type==="audio"&&this.trackBitrates.some(c=>{if(!c.transceiver||o!=c.transceiver.mid)return!1;let l=0;if(a.rtp.some(d=>d.codec.toUpperCase()===c.codec.toUpperCase()?(l=d.payload,!0):!1),l===0)return!0;let u=!1;for(const d of a.fmtp)if(d.payload===l){d.config=d.config.split(";").filter(h=>!h.includes("maxaveragebitrate")).join(";"),c.maxbr>0&&(d.config+=";maxaveragebitrate=".concat(c.maxbr*1e3)),u=!0;break}return u||c.maxbr>0&&a.fmtp.push({payload:l,config:"maxaveragebitrate=".concat(c.maxbr*1e3)}),!0})}),r=St.write(s)}return yield this.setMungedSDP(e,r,!0),this.pendingCandidates.forEach(s=>{this.pc.addIceCandidate(s)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):e.type==="answer"&&(this.emit(an.NegotiationComplete),e.sdp&&St.parse(e.sdp).media.forEach(a=>{a.type==="video"&&this.emit(an.RTPVideoPayloadTypes,a.rtp)})),!0})}createAndSendOffer(e){return k(this,void 0,void 0,function*(){var t;const i=yield this.offerLock.lock();try{if(this.onOffer===void 0)return;if(e?.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const o=this._pc.remoteDescription;if(e?.iceRestart&&o)yield this._pc.setRemoteDescription(o);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const r=this.latestOfferId+1;this.latestOfferId=r;const s=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:s.sdp},this.logContext));const a=St.parse((t=s.sdp)!==null&&t!==void 0?t:"");if(a.media.forEach(o=>{Yo(o),o.type==="audio"?Qo(o,["all"],[]):o.type==="video"&&this.trackBitrates.some(c=>{if(!o.msid||!c.cid||!o.msid.includes(c.cid))return!1;let l=0;if(o.rtp.some(d=>d.codec.toUpperCase()===c.codec.toUpperCase()?(l=d.payload,!0):!1),l===0||(je(c.codec)&&!qt()&&this.ensureVideoDDExtensionForSVC(o,a),!je(c.codec)))return!0;const u=Math.round(c.maxbr*qf);for(const d of o.fmtp)if(d.payload===l){d.config.includes("x-google-start-bitrate")||(d.config+=";x-google-start-bitrate=".concat(u));break}return!0})}),this.latestOfferId>r){this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:r}));return}yield this.setMungedSDP(s,St.write(a)),this.onOffer(s,this.latestOfferId)}finally{i()}})}createAndSetAnswer(){return k(this,void 0,void 0,function*(){var e;const t=yield this.pc.createAnswer(),i=St.parse((e=t.sdp)!==null&&e!==void 0?e:"");return i.media.forEach(r=>{Yo(r),r.type==="audio"&&Qo(r,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(t,St.write(i)),t})}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTransceiverOfKind(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new re("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new re("PC closed, cannot configure");return(t=this._pc)===null||t===void 0?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!(!((e=this._pc)===null||e===void 0)&&e.removeTrack)}removeTrack(e){var t;return(t=this._pc)===null||t===void 0?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.connectionState)!==null&&t!==void 0?t:"closed"}getICEConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.iceConnectionState)!==null&&t!==void 0?t:"closed"}getSignallingState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.signalingState)!==null&&t!==void 0?t:"closed"}getTransceivers(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getTransceivers())!==null&&t!==void 0?t:[]}getSenders(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getSenders())!==null&&t!==void 0?t:[]}getLocalDescription(){var e;return(e=this._pc)===null||e===void 0?void 0:e.localDescription}getRemoteDescription(){var e;return(e=this.pc)===null||e===void 0?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return k(this,void 0,void 0,function*(){var e;if(!this._pc)return;let t="";const i=new Map,r=new Map;if((yield this._pc.getStats()).forEach(o=>{switch(o.type){case"transport":t=o.selectedCandidatePairId;break;case"candidate-pair":t===""&&o.selected&&(t=o.id),i.set(o.id,o);break;case"remote-candidate":r.set(o.id,"".concat(o.address,":").concat(o.port));break}}),t==="")return;const a=(e=i.get(t))===null||e===void 0?void 0:e.remoteCandidateId;if(a!==void 0)return r.get(a)})}setMungedSDP(e,t,i){return k(this,void 0,void 0,function*(){if(t){const r=e.sdp;e.sdp=t;try{this.log.debug("setting munged ".concat(i?"remote":"local"," description"),this.logContext),i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e);return}catch(s){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:s,sdp:t})),e.sdp=r}}try{i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(r){let s="unknown error";r instanceof Error?s=r.message:typeof r=="string"&&(s=r);const a={error:s,sdp:e.sdp};throw!i&&this.pc.remoteDescription&&(a.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:a})),new rn(s)}})}ensureVideoDDExtensionForSVC(e,t){var i,r;if(!((i=e.ext)===null||i===void 0?void 0:i.some(a=>a.uri===Mo))){if(this.ddExtID===0){let a=0;t.media.forEach(o=>{var c;o.type==="video"&&((c=o.ext)===null||c===void 0||c.forEach(l=>{l.value>a&&(a=l.value)}))}),this.ddExtID=a+1}(r=e.ext)===null||r===void 0||r.push({value:this.ddExtID,uri:Mo})}}}function Qo(n,e,t){const i=xs(n.mid);let r=0;n.rtp.some(s=>s.codec==="opus"?(r=s.payload,!0):!1),r>0&&(n.rtcpFb||(n.rtcpFb=[]),t.includes(i)&&!n.rtcpFb.some(s=>s.payload===r&&s.type==="nack")&&n.rtcpFb.push({payload:r,type:"nack"}),(e.includes(i)||e.length===1&&e[0]==="all")&&n.fmtp.some(s=>s.payload===r?(s.config.includes("stereo=1")||(s.config+=";stereo=1"),!0):!1))}function Hf(n){var e;const t=[],i=[],r=St.parse((e=n.sdp)!==null&&e!==void 0?e:"");let s=0;return r.media.forEach(a=>{var o;const c=xs(a.mid);a.type==="audio"&&(a.rtp.some(l=>l.codec==="opus"?(s=l.payload,!0):!1),!((o=a.rtcpFb)===null||o===void 0)&&o.some(l=>l.payload===s&&l.type==="nack")&&i.push(c),a.fmtp.some(l=>l.payload===s?(l.config.includes("sprop-stereo=1")&&t.push(c),!0):!1))}),{stereoMids:t,nackMids:i}}function Yo(n){if(n.connection){const e=n.connection.ip.indexOf(":")>=0;(n.connection.version===4&&e||n.connection.version===6&&!e)&&(n.connection.ip="0.0.0.0",n.connection.version=4)}}function xs(n){return typeof n=="number"?n.toFixed(0):n}const Jr="vp8",Kf={audioPreset:jr.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:Es.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:Jr,backupCodec:!0,preConnectBuffer:!1},gl={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},vl={deviceId:{ideal:"default"},resolution:Un.h720.resolution},zf={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new Th,disconnectOnPageLeave:!0,webAudioMix:!1,singlePeerConnection:!0},Os={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var te;(function(n){n[n.NEW=0]="NEW",n[n.CONNECTING=1]="CONNECTING",n[n.CONNECTED=2]="CONNECTED",n[n.FAILED=3]="FAILED",n[n.CLOSING=4]="CLOSING",n[n.CLOSED=5]="CLOSED"})(te||(te={}));class Gf{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}get mode(){return this._mode}constructor(e,t,i){var r;this.peerConnectionTimeout=Os.peerConnectionTimeout,this.log=j,this.updateState=()=>{var s,a;const o=this.state,c=this.requiredTransports.map(l=>l.getConnectionState());c.every(l=>l==="connected")?this.state=te.CONNECTED:c.some(l=>l==="failed")?this.state=te.FAILED:c.some(l=>l==="connecting")?this.state=te.CONNECTING:c.every(l=>l==="closed")?this.state=te.CLOSED:c.some(l=>l==="closed")?this.state=te.CLOSING:c.every(l=>l==="new")&&(this.state=te.NEW),o!==this.state&&(this.log.debug("pc state change: from ".concat(te[o]," to ").concat(te[this.state]),this.logContext),(s=this.onStateChange)===null||s===void 0||s.call(this,this.state,this.publisher.getConnectionState(),(a=this.subscriber)===null||a===void 0?void 0:a.getConnectionState()))},this.log=ht((r=i.loggerName)!==null&&r!==void 0?r:qe.PCManager),this.loggerOptions=i,this.isPublisherConnectionRequired=t!=="subscriber-primary",this.isSubscriberConnectionRequired=t==="subscriber-primary",this.publisher=new $o(e,i),this._mode=t,t!=="publisher-only"&&(this.subscriber=new $o(e,i),this.subscriber.onConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.subscriber.onIceCandidate=s=>{var a;(a=this.onIceCandidate)===null||a===void 0||a.call(this,s,Fe.SUBSCRIBER)},this.subscriber.onDataChannel=s=>{var a;(a=this.onDataChannel)===null||a===void 0||a.call(this,s)},this.subscriber.onTrack=s=>{var a;(a=this.onTrack)===null||a===void 0||a.call(this,s)}),this.publisher.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=s=>{var a;(a=this.onIceCandidate)===null||a===void 0||a.call(this,s,Fe.PUBLISHER)},this.publisher.onTrack=s=>{var a;(a=this.onTrack)===null||a===void 0||a.call(this,s)},this.publisher.onOffer=(s,a)=>{var o;(o=this.onPublisherOffer)===null||o===void 0||o.call(this,s,a)},this.state=te.NEW,this.connectionLock=new ke,this.remoteOfferLock=new ke}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}requirePublisher(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e,t){return this.publisher.setRemoteDescription(e,t)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return k(this,void 0,void 0,function*(){var e;if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const t=this.publisher;for(const i of t.getSenders())try{t.canRemoveTrack()&&t.removeTrack(i)}catch(r){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:r}))}}yield Promise.all([this.publisher.close(),(e=this.subscriber)===null||e===void 0?void 0:e.close()]),this.updateState()})}triggerIceRestart(){return k(this,void 0,void 0,function*(){this.subscriber&&(this.subscriber.restartingIce=!0),this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(e,t){return k(this,void 0,void 0,function*(){var i;t===Fe.PUBLISHER?yield this.publisher.addIceCandidate(e):yield(i=this.subscriber)===null||i===void 0?void 0:i.addIceCandidate(e)})}createSubscriberAnswerFromOffer(e,t){return k(this,void 0,void 0,function*(){var i,r,s;this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:(i=this.subscriber)===null||i===void 0?void 0:i.getSignallingState().toString()}));const a=yield this.remoteOfferLock.lock();try{return(yield(r=this.subscriber)===null||r===void 0?void 0:r.setRemoteDescription(e,t))?yield(s=this.subscriber)===null||s===void 0?void 0:s.createAndSetAnswer():void 0}finally{a()}})}updateConfiguration(e,t){var i;this.publisher.setConfiguration(e),(i=this.subscriber)===null||i===void 0||i.setConfiguration(e),t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){return k(this,void 0,void 0,function*(){var i;const r=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((i=this.requiredTransports)===null||i===void 0?void 0:i.map(s=>this.ensureTransportConnected(s,e,t)))}finally{r()}})}negotiate(e){return k(this,void 0,void 0,function*(){return new Pe((t,i)=>k(this,void 0,void 0,function*(){const r=setTimeout(()=>{i(new rn("negotiation timed out"))},this.peerConnectionTimeout),s=()=>{clearTimeout(r),i(new rn("negotiation aborted"))};e.signal.addEventListener("abort",s),this.publisher.once(an.NegotiationStarted,()=>{e.signal.aborted||this.publisher.once(an.NegotiationComplete,()=>{clearTimeout(r),t()})}),yield this.publisher.negotiate(a=>{clearTimeout(r),a instanceof Error?i(a):i(new Error(String(a)))})}))})}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTransceiverOfKind(e,t){return this.publisher.addTransceiverOfKind(e,t)}getMidForReceiver(e){const i=(this.subscriber?this.subscriber.getTransceivers():this.publisher.getTransceivers()).find(r=>r.receiver===e);return i?.mid}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===Fe.PUBLISHER?this.publisher.getConnectedAddress():e===Fe.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&this.subscriber&&e.push(this.subscriber),e}ensureTransportConnected(e,t){return k(this,arguments,void 0,function(i,r){var s=this;let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return(function*(){if(i.getConnectionState()!=="connected")return new Promise((c,l)=>k(s,void 0,void 0,function*(){const u=()=>{this.log.warn("abort transport connection",this.logContext),me.clearTimeout(d),l(F.cancelled("room connection has been cancelled"))};r?.signal.aborted&&u(),r?.signal.addEventListener("abort",u);const d=me.setTimeout(()=>{r?.signal.removeEventListener("abort",u),l(F.internal("could not establish pc connection"))},a);for(;this.state!==te.CONNECTED;)if(yield ge(50),r?.signal.aborted){l(F.cancelled("room connection has been cancelled"));return}me.clearTimeout(d),r?.signal.removeEventListener("abort",u),c()}))})()})}}const bl=5e3,Jf=3e4;class z{static fetchRegionSettings(e,t,i){return k(this,void 0,void 0,function*(){const r=yield z.fetchLock.lock();try{const s=yield fetch("".concat($f(e),"/regions"),{headers:{authorization:"Bearer ".concat(t)},signal:i});if(s.ok){const a=vf(s.headers),o=a?a*1e3:bl;return{regionSettings:yield s.json(),updatedAtInMs:Date.now(),maxAgeInMs:o}}else throw s.status===401?F.notAllowed("Could not fetch region settings: ".concat(s.statusText),s.status):F.internal("Could not fetch region settings: ".concat(s.statusText))}catch(s){throw s instanceof F?s:i?.aborted?F.cancelled("Region fetching was aborted"):F.serverUnreachable("Could not fetch region settings, ".concat(s instanceof Error?"".concat(s.name,": ").concat(s.message):s))}finally{r()}})}static scheduleRefetch(e,t,i){return k(this,void 0,void 0,function*(){const r=z.settingsTimeouts.get(e.hostname);clearTimeout(r),z.settingsTimeouts.set(e.hostname,setTimeout(()=>k(this,void 0,void 0,function*(){try{const s=yield z.fetchRegionSettings(e,t);z.updateCachedRegionSettings(e,t,s)}catch(s){if(s instanceof F&&s.reason===Y.NotAllowed){j.debug("token is not valid, cancelling auto region refresh");return}j.debug("auto refetching of region settings failed",{error:s}),z.scheduleRefetch(e,t,i)}}),i))})}static updateCachedRegionSettings(e,t,i){z.cache.set(e.hostname,i),z.scheduleRefetch(e,t,i.maxAgeInMs)}static stopRefetch(e){const t=z.settingsTimeouts.get(e);t&&(clearTimeout(t),z.settingsTimeouts.delete(e))}static scheduleCleanup(e){let t=z.connectionTrackers.get(e);t&&(t.cleanupTimeout&&clearTimeout(t.cleanupTimeout),t.cleanupTimeout=setTimeout(()=>{const i=z.connectionTrackers.get(e);i&&i.connectionCount===0&&(j.debug("stopping region refetch after disconnect delay",{hostname:e}),z.stopRefetch(e)),i&&(i.cleanupTimeout=void 0)},Jf))}static cancelCleanup(e){const t=z.connectionTrackers.get(e);t?.cleanupTimeout&&(clearTimeout(t.cleanupTimeout),t.cleanupTimeout=void 0)}notifyConnected(){const e=this.serverUrl.hostname;let t=z.connectionTrackers.get(e);t||(t={connectionCount:0},z.connectionTrackers.set(e,t)),t.connectionCount++,z.cancelCleanup(e)}notifyDisconnected(){const e=this.serverUrl.hostname,t=z.connectionTrackers.get(e);t&&(t.connectionCount=Math.max(0,t.connectionCount-1),t.connectionCount===0&&z.scheduleCleanup(e))}constructor(e,t){this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=t}updateToken(e){this.token=e}isCloud(){return dn(this.serverUrl)}getServerUrl(){return this.serverUrl}fetchRegionSettings(e){return k(this,void 0,void 0,function*(){return z.fetchRegionSettings(this.serverUrl,this.token,e)})}getNextBestRegionUrl(e){return k(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");let t=z.cache.get(this.serverUrl.hostname);(!t||Date.now()-t.updatedAtInMs>t.maxAgeInMs)&&(t=yield this.fetchRegionSettings(e),z.updateCachedRegionSettings(this.serverUrl,this.token,t));const i=t.regionSettings.regions.filter(r=>!this.attemptedRegions.find(s=>s.url===r.url));if(i.length>0){const r=i[0];return this.attemptedRegions.push(r),j.debug("next region: ".concat(r.region)),r.url}else return null})}resetAttempts(){this.attemptedRegions=[]}setServerReportedRegions(e){z.updateCachedRegionSettings(this.serverUrl,this.token,e)}}z.cache=new Map;z.settingsTimeouts=new Map;z.connectionTrackers=new Map;z.fetchLock=new ke;function $f(n){return"".concat(n.protocol.replace("ws","http"),"//").concat(n.host,"/settings")}class ie extends Error{constructor(e,t,i){super(t),this.code=e,this.message=Xo(t,ie.MAX_MESSAGE_BYTES),this.data=i?Xo(i,ie.MAX_DATA_BYTES):void 0}static fromProto(e){return new ie(e.code,e.message,e.data)}toProto(){return new uc({code:this.code,message:this.message,data:this.data})}static builtIn(e,t){return new ie(ie.ErrorCode[e],ie.ErrorMessage[e],t)}}ie.MAX_MESSAGE_BYTES=256;ie.MAX_DATA_BYTES=15360;ie.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404};ie.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const yl=15360;function Ms(n){return new TextEncoder().encode(n).length}function Xo(n,e){if(Ms(n)<=e)return n;let t=0,i=n.length;const r=new TextEncoder;for(;t<i;){const s=Math.floor((t+i+1)/2);r.encode(n.slice(0,s)).length<=e?t=s:i=s-1}return n.slice(0,t)}const Ds=2e3;function Wi(n,e){if(!e)return 0;let t,i;return"bytesReceived"in n?(t=n.bytesReceived,i=e.bytesReceived):"bytesSent"in n&&(t=n.bytesSent,i=e.bytesSent),t===void 0||i===void 0||n.timestamp===void 0||e.timestamp===void 0?0:(t-i)*8*1e3/(n.timestamp-e.timestamp)}const As=typeof MediaRecorder<"u";class Qf{constructor(){throw new Error("MediaRecorder is not available in this environment")}}const Yf=As?MediaRecorder:Qf;class Xf extends Yf{constructor(e,t){if(!As)throw new Error("MediaRecorder is not available in this environment");super(new MediaStream([e.mediaStreamTrack]),t);let i,r;const s=()=>r===void 0,a=()=>{this.removeEventListener("dataavailable",i),this.removeEventListener("stop",a),this.removeEventListener("error",o),r?.close(),r=void 0},o=c=>{r?.error(c),this.removeEventListener("dataavailable",i),this.removeEventListener("stop",a),this.removeEventListener("error",o),r=void 0};this.byteStream=new ReadableStream({start:c=>{r=c,i=l=>k(this,void 0,void 0,function*(){let u;if(l.data.arrayBuffer){const d=yield l.data.arrayBuffer();u=new Uint8Array(d)}else if(l.data.byteArray)u=l.data.byteArray;else throw new Error("no data available!");s()||c.enqueue(u)}),this.addEventListener("dataavailable",i)},cancel:()=>{a()}}),this.addEventListener("stop",a),this.addEventListener("error",o)}}function Zf(){return As}const ep=1e3,tp=1e4;class kl extends E{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor(e,t,i){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,s=arguments.length>4?arguments[4]:void 0;super(e,t,s),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=Is(()=>k(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>k(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(L.Ended,this)},this.reacquireTrack=!1,this.providedByUser=r,this.muteLock=new ke,this.pauseUpstreamLock=new ke,this.trackChangeLock=new ke,this.trackChangeLock.lock().then(a=>k(this,void 0,void 0,function*(){try{yield this.setMediaStreamTrack(e,!0)}finally{a()}})),this._constraints=e.getConstraints(),i&&(this._constraints=i)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==E.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();if(e&&t)return{width:e,height:t}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return(t=(e=this.processor)===null||e===void 0?void 0:e.processedTrack)!==null&&t!==void 0?t:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(e,t){return k(this,void 0,void 0,function*(){var i;if(e===this._mediaStreamTrack&&!t)return;this._mediaStreamTrack&&(this.attachedElements.forEach(s=>{sn(this._mediaStreamTrack,s)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints());let r;if(this.processor&&e){if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(Xt(e,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),r=this.processor.processedTrack}this.sender&&((i=this.sender.transport)===null||i===void 0?void 0:i.state)!=="closed"&&(yield this.sender.replaceTrack(r??e)),!this.providedByUser&&this._mediaStreamTrack!==e&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(s=>{Xt(r??e,s)}))})}waitForDimensions(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ep;return(function*(){var i;if(e.kind===E.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((i=Se())===null||i===void 0?void 0:i.os)==="iOS"&&(yield ge(10));const r=Date.now();for(;Date.now()-r<t;){const s=e.dimensions;if(s)return s;yield ge(50)}throw new dt("unable to get track dimensions after timeout")})()})}setDeviceId(e){return k(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===Pt(e)||(this._constraints.deviceId=e,this.isMuted)?!0:(yield this.restartTrack(),Pt(e)===this._mediaStreamTrack.getSettings().deviceId)})}getDeviceId(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){if(e.source===E.Source.ScreenShare)return;const{deviceId:i,groupId:r}=e._mediaStreamTrack.getSettings(),s=e.kind===E.Kind.Audio?"audioinput":"videoinput";return t?fe.getInstance().normalizeDeviceId(s,i,r):i})()})}mute(){return k(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return k(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(e,t){return k(this,void 0,void 0,function*(){const i=yield this.trackChangeLock.lock();try{if(!this.sender)throw new dt("unable to replace an unpublished track");let r,s;return typeof t=="boolean"?r=t:t!==void 0&&(r=t.userProvidedTrack,s=t.stopProcessor),this.providedByUser=r??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),s&&this.processor&&(yield this.internalStopProcessor()),this}finally{i()}})}restart(e){return k(this,void 0,void 0,function*(){this.manuallyStopped=!1;const t=yield this.trackChangeLock.lock();try{e||(e=this._constraints);const{deviceId:i,facingMode:r}=e,s=Ch(e,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const a={audio:!1,video:!1};this.kind===E.Kind.Video?a.video=i||r?{deviceId:i,facingMode:r}:!0:a.audio=i?Object.assign({deviceId:i},s):!0,this.attachedElements.forEach(l=>{sn(this.mediaStreamTrack,l)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const c=(yield navigator.mediaDevices.getUserMedia(a)).getTracks()[0];return this.kind===E.Kind.Video&&(yield c.applyConstraints(s)),c.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(c),this._constraints=e,this.emit(L.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{t()}})}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),!(this.isMuted===e&&this._mediaStreamTrack.enabled!==e)&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?L.Muted:L.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return k(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),hl()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var e;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),(e=this.processor)===null||e===void 0||e.destroy(),this.processor=void 0}pauseUpstream(){return k(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(L.UpstreamPaused,this);const i=Se();if(i?.name==="Safari"&&We(i.version,"12.0")<0)throw new Cs("pauseUpstream is not supported on Safari < 12.");((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{t()}})}resumeUpstream(){return k(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(L.UpstreamResumed,this),((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{t()}})}getRTCStatsReport(){return k(this,void 0,void 0,function*(){var e;return!((e=this.sender)===null||e===void 0)&&e.getStats?yield this.sender.getStats():void 0})}setProcessor(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var s;const a=yield i.trackChangeLock.lock();try{i.log.debug("setting up processor",i.logContext);const o=document.createElement(i.kind),c={kind:i.kind,track:i._mediaStreamTrack,element:o,audioContext:i.audioContext};if(yield t.init(c),i.log.debug("processor initialized",i.logContext),i.processor&&(yield i.internalStopProcessor()),i.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(Xt(i._mediaStreamTrack,o),o.muted=!0,o.play().catch(l=>{l instanceof DOMException&&l.name==="AbortError"?(i.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},i.logContext),{error:l})),setTimeout(()=>{o.play().catch(u=>{i.log.error("failed to play processor element",Object.assign(Object.assign({},i.logContext),{err:u}))})},100)):i.log.error("failed to play processor element",Object.assign(Object.assign({},i.logContext),{error:l}))}),i.processor=t,i.processorElement=o,i.processor.processedTrack){for(const l of i.attachedElements)l!==i.processorElement&&r&&(sn(i._mediaStreamTrack,l),Xt(i.processor.processedTrack,l));yield(s=i.sender)===null||s===void 0?void 0:s.replaceTrack(i.processor.processedTrack)}i.emit(L.TrackProcessorUpdate,i.processor)}finally{a()}})()})}getProcessor(){return this.processor}stopProcessor(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){const i=yield e.trackChangeLock.lock();try{yield e.internalStopProcessor(t)}finally{i()}})()})}internalStopProcessor(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var i,r;e.processor&&(e.log.debug("stopping processor",e.logContext),(i=e.processor.processedTrack)===null||i===void 0||i.stop(),yield e.processor.destroy(),e.processor=void 0,t||((r=e.processorElement)===null||r===void 0||r.remove(),e.processorElement=void 0),yield e._mediaStreamTrack.applyConstraints(e._constraints),yield e.setMediaStreamTrack(e._mediaStreamTrack,!0),e.emit(L.TrackProcessorUpdate))})()})}startPreConnectBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;if(!Zf()){this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext);return}if(this.localTrackRecorder){this.log.warn("preconnect buffer already started");return}else{let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="video/mp4"),this.localTrackRecorder=new Xf(this,{mimeType:t})}this.localTrackRecorder.start(e),this.autoStopPreConnectBuffer=setTimeout(()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()},tp)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.byteStream}getPreConnectBufferMimeType(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.mimeType}}class Ci extends kl{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;super(e,E.Kind.Audio,t,i,s),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>k(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let a;try{a=yield this.getSenderStats()}catch(o){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:o}));return}a&&this.prevStats&&(this._currentBitrate=Wi(a,this.prevStats)),this.prevStats=a}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(L.AudioTrackFeatureUpdate,this,he.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(L.AudioTrackFeatureUpdate,this,he.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=r,this.checkForSilence()}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return k(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===E.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return k(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const i=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==Pt(this._constraints.deviceId);return this.source===E.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||i)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}})}restartTrack(e){return k(this,void 0,void 0,function*(){let t;if(e){const i=ws({audio:e});typeof i.audio!="boolean"&&(t=i.audio)}yield this.restart(t)})}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return k(this,void 0,void 0,function*(){const i=yield t.restart.call(this,e);return this.checkForSilence(),i})}startMonitor(){Re()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},Ds)))}setProcessor(e){return k(this,void 0,void 0,function*(){var t;const i=yield this.trackChangeLock.lock();try{if(!et()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());const r={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(r),this.processor=e,this.processor.processedTrack&&(yield(t=this.sender)===null||t===void 0?void 0:t.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(L.TrackProcessorUpdate,this.processor)}finally{i()}})}setAudioContext(e){this.audioContext=e}getSenderStats(){return k(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return;const t=yield this.sender.getStats();let i;return t.forEach(r=>{r.type==="outbound-rtp"&&(i={type:"audio",streamId:r.id,packetsSent:r.packetsSent,packetsLost:r.packetsLost,bytesSent:r.bytesSent,timestamp:r.timestamp,roundTripTime:r.roundTripTime,jitter:r.jitter})}),i})}checkForSilence(){return k(this,void 0,void 0,function*(){const e=yield ll(this);return e&&(this.isMuted||this.log.debug("silence detected on local audio track",this.logContext),this.emit(L.AudioSilenceDetected)),e})}}function np(n,e,t){switch(n.kind){case"audio":return new Ci(n,e,!1,void 0,t);case"video":return new Ei(n,e,!1,t);default:throw new dt("unsupported track type: ".concat(n.kind))}}const ip=Object.values(Un),rp=Object.values(Br),sp=Object.values(Es),op=[Un.h180,Un.h360],ap=[Br.h180,Br.h360],cp=n=>[{scaleResolutionDownBy:2,fps:n.encoding.maxFramerate}].map(t=>{var i,r;return new J(Math.floor(n.width/t.scaleResolutionDownBy),Math.floor(n.height/t.scaleResolutionDownBy),Math.max(15e4,Math.floor(n.encoding.maxBitrate/(Math.pow(t.scaleResolutionDownBy,2)*(((i=n.encoding.maxFramerate)!==null&&i!==void 0?i:30)/((r=t.fps)!==null&&r!==void 0?r:30))))),t.fps,n.encoding.priority)}),$r=["q","h","f"];function Qr(n,e,t,i){var r,s;let a=i?.videoEncoding;n&&(a=i?.screenShareEncoding);const o=i?.simulcast,c=i?.scalabilityMode,l=i?.videoCodec;if(!a&&!o&&!c||!e||!t)return[{}];a||(a=up(n,e,t,l),j.debug("using video encoding",a));const u=a.maxFramerate,d=new J(e,t,a.maxBitrate,a.maxFramerate,a.priority);if(c&&je(l)){const b=new Sl(c),m=[];if(b.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(c));const T=Se();if(Fn()||et()||T?.name==="Chrome"&&We(T?.version,"113")<0){const S=b.suffix=="h"?2:3,P=sf(T);for(let M=0;M<b.spatial;M+=1)m.push({rid:$r[2-M],maxBitrate:a.maxBitrate/Math.pow(S,M),maxFramerate:d.encoding.maxFramerate,scaleResolutionDownBy:P?Math.pow(2,M):void 0});m[0].scalabilityMode=c}else m.push({maxBitrate:a.maxBitrate,maxFramerate:d.encoding.maxFramerate,scalabilityMode:c});return d.encoding.priority&&(m[0].priority=d.encoding.priority,m[0].networkPriority=d.encoding.priority),j.debug("using svc encoding",{encodings:m}),m}if(!o)return[a];let h=[];n?h=(r=ea(i?.screenShareSimulcastLayers))!==null&&r!==void 0?r:Zo(n,d):h=(s=ea(i?.videoSimulcastLayers))!==null&&s!==void 0?s:Zo(n,d);let p;if(h.length>0){const b=h[0];h.length>1&&([,p]=h);const m=Math.max(e,t);if(m>=960&&p)return br(e,t,[b,p,d],u);if(m>=480)return br(e,t,[b,d],u)}return br(e,t,[d])}function lp(n,e,t){var i,r,s,a;if(!t.backupCodec||t.backupCodec===!0||t.backupCodec.codec===t.videoCodec)return;e!==t.backupCodec.codec&&j.warn("requested a different codec than specified as backup",{serverRequested:e,backup:t.backupCodec.codec}),t.videoCodec=e,t.videoEncoding=t.backupCodec.encoding;const o=n.mediaStreamTrack.getSettings(),c=(i=o.width)!==null&&i!==void 0?i:(r=n.dimensions)===null||r===void 0?void 0:r.width,l=(s=o.height)!==null&&s!==void 0?s:(a=n.dimensions)===null||a===void 0?void 0:a.height;return n.source===E.Source.ScreenShare&&t.simulcast&&(t.simulcast=!1),Qr(n.source===E.Source.ScreenShare,c,l,t)}function up(n,e,t,i){const r=dp(n,e,t);let{encoding:s}=r[0];const a=Math.max(e,t);for(let o=0;o<r.length;o+=1){const c=r[o];if(s=c.encoding,c.width>=a)break}if(i)switch(i){case"av1":case"h265":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.7;break;case"vp9":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.85;break}return s}function dp(n,e,t){if(n)return sp;const i=e>t?e/t:t/e;return Math.abs(i-16/9)<Math.abs(i-4/3)?ip:rp}function Zo(n,e){if(n)return cp(e);const{width:t,height:i}=e,r=t>i?t/i:i/t;return Math.abs(r-16/9)<Math.abs(r-4/3)?op:ap}function br(n,e,t,i){const r=[];if(t.forEach((s,a)=>{if(a>=$r.length)return;const o=Math.min(n,e),l={rid:$r[a],scaleResolutionDownBy:Math.max(1,o/Math.min(s.width,s.height)),maxBitrate:s.encoding.maxBitrate},u=i&&s.encoding.maxFramerate?Math.min(i,s.encoding.maxFramerate):s.encoding.maxFramerate;u&&(l.maxFramerate=u);const d=Vt()||a===0;s.encoding.priority&&d&&(l.priority=s.encoding.priority,l.networkPriority=s.encoding.priority),r.push(l)}),et()&&pl()==="ios"){let s;r.forEach(o=>{s?o.maxFramerate&&o.maxFramerate>s&&(s=o.maxFramerate):s=o.maxFramerate});let a=!0;r.forEach(o=>{var c;o.maxFramerate!=s&&(a&&(a=!1,j.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),j.info('Setting framerate of encoding "'.concat((c=o.rid)!==null&&c!==void 0?c:"",'" to ').concat(s)),o.maxFramerate=s)})}return r}function ea(n){if(n)return n.sort((e,t)=>{const{encoding:i}=e,{encoding:r}=t;return i.maxBitrate>r.maxBitrate?1:i.maxBitrate<r.maxBitrate?-1:i.maxBitrate===r.maxBitrate&&i.maxFramerate&&r.maxFramerate?i.maxFramerate>r.maxFramerate?1:-1:0})}class Sl{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");if(this.spatial=parseInt(t[1]),this.temporal=parseInt(t[2]),t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat((e=this.suffix)!==null&&e!==void 0?e:"")}}function hp(n){return n.source===E.Source.ScreenShare||n.constraints.height&&Pt(n.constraints.height)>=1080?"maintain-resolution":"balanced"}const fp=5e3;class Ei extends kl{get sender(){return this._sender}set sender(e){this._sender=e,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0;super(e,E.Kind.Video,t,i,r),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.isCpuConstrained=!1,this.optimizeForPerformance=!1,this.monitorSender=()=>k(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let s;try{s=yield this.getSenderStats()}catch(c){this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:c}));return}const a=new Map(s.map(c=>[c.rid,c])),o=s.some(c=>c.qualityLimitationReason==="cpu");if(o!==this.isCpuConstrained&&(this.isCpuConstrained=o,this.isCpuConstrained&&this.emit(L.CpuConstrained)),this.prevStats){let c=0;a.forEach((l,u)=>{var d;const h=(d=this.prevStats)===null||d===void 0?void 0:d.get(u);c+=Wi(l,h)}),this._currentBitrate=c}this.prevStats=a}),this.senderLock=new ke}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;if(this.signalClient=e,!Re())return;const i=(t=this.sender)===null||t===void 0?void 0:t.getParameters();i&&(this.encodings=i.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},Ds))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(e=>{e.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return k(this,void 0,void 0,function*(){var t,i,r,s,a;yield e.pauseUpstream.call(this);try{for(var o=!0,c=ut(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;o=!0)s=l.value,o=!1,yield(a=s.sender)===null||a===void 0?void 0:a.replaceTrack(null)}catch(u){i={error:u}}finally{try{!o&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return k(this,void 0,void 0,function*(){var t,i,r,s,a;yield e.resumeUpstream.call(this);try{for(var o=!0,c=ut(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;o=!0){s=l.value,o=!1;const u=s;yield(a=u.sender)===null||a===void 0?void 0:a.replaceTrack(u.mediaStreamTrack)}}catch(u){i={error:u}}finally{try{!o&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return k(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===E.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return k(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.source===E.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{t()}})}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){return k(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return[];const t=[],i=yield this.sender.getStats();return i.forEach(r=>{var s;if(r.type==="outbound-rtp"){const a={type:"video",streamId:r.id,frameHeight:r.frameHeight,frameWidth:r.frameWidth,framesPerSecond:r.framesPerSecond,framesSent:r.framesSent,firCount:r.firCount,pliCount:r.pliCount,nackCount:r.nackCount,packetsSent:r.packetsSent,bytesSent:r.bytesSent,qualityLimitationReason:r.qualityLimitationReason,qualityLimitationDurations:r.qualityLimitationDurations,qualityLimitationResolutionChanges:r.qualityLimitationResolutionChanges,rid:(s=r.rid)!==null&&s!==void 0?s:r.id,retransmittedPacketsSent:r.retransmittedPacketsSent,targetBitrate:r.targetBitrate,timestamp:r.timestamp},o=i.get(r.remoteId);o&&(a.jitter=o.jitter,a.packetsLost=o.packetsLost,a.roundTripTime=o.roundTripTime),t.push(a)}}),t.sort((r,s)=>{var a,o;return((a=s.frameWidth)!==null&&a!==void 0?a:0)-((o=r.frameWidth)!==null&&o!==void 0?o:0)}),t})}setPublishingQuality(e){const t=[];for(let i=xe.LOW;i<=xe.HIGH;i+=1)t.push(new ys({quality:i,enabled:i<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers(je(this.codec),t)}restartTrack(e){return k(this,void 0,void 0,function*(){var t,i,r,s,a;let o;if(e){const d=ws({video:e});typeof d.video!="boolean"&&(o=d.video)}yield this.restart(o),this.isCpuConstrained=!1;try{for(var c=!0,l=ut(this.simulcastCodecs.values()),u;u=yield l.next(),t=u.done,!t;c=!0){s=u.value,c=!1;const d=s;d.sender&&((a=d.sender.transport)===null||a===void 0?void 0:a.state)!=="closed"&&(d.mediaStreamTrack=this.mediaStreamTrack.clone(),yield d.sender.replaceTrack(d.mediaStreamTrack))}}catch(d){i={error:d}}finally{try{!c&&!t&&(r=l.return)&&(yield r.call(l))}finally{if(i)throw i.error}}})}setProcessor(e){const t=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return k(this,arguments,void 0,function(i){var r=this;let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var a,o,c,l,u,d;if(yield t.setProcessor.call(r,i,s),!((u=r.processor)===null||u===void 0)&&u.processedTrack)try{for(var h=!0,p=ut(r.simulcastCodecs.values()),b;b=yield p.next(),a=b.done,!a;h=!0)l=b.value,h=!1,yield(d=l.sender)===null||d===void 0?void 0:d.replaceTrack(r.processor.processedTrack)}catch(m){o={error:m}}finally{try{!h&&!a&&(c=p.return)&&(yield c.call(p))}finally{if(o)throw o.error}}})()})}setDegradationPreference(e){return k(this,void 0,void 0,function*(){if(this.degradationPreference=e,this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const t=this.sender.getParameters();t.degradationPreference=e,this.sender.setParameters(t)}catch(t){this.log.warn("failed to set degradationPreference",Object.assign({error:t},this.logContext))}})}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e)){this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);return}const i={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};return this.simulcastCodecs.set(e,i),i}setSimulcastTrackSender(e,t){const i=this.simulcastCodecs.get(e);i&&(i.sender=t,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},fp))}setPublishingCodecs(e){return k(this,void 0,void 0,function*(){var t,i,r,s,a,o,c;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers(je(e[0].codec),e[0].qualities),[];this.subscribedCodecs=e;const l=[];try{for(t=!0,i=ut(e);r=yield i.next(),s=r.done,!s;t=!0){c=r.value,t=!1;const u=c;if(!this.codec||this.codec===u.codec)yield this.setPublishingLayers(je(u.codec),u.qualities);else{const d=this.simulcastCodecs.get(u.codec);if(this.log.debug("try setPublishingCodec for ".concat(u.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:d})),!d||!d.sender){for(const h of u.qualities)if(h.enabled){l.push(u.codec);break}}else d.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(u.codec),this.logContext),yield ta(d.sender,d.encodings,u.qualities,this.senderLock,je(u.codec),this.log,this.logContext))}}}catch(u){a={error:u}}finally{try{!t&&!s&&(o=i.return)&&(yield o.call(i))}finally{if(a)throw a.error}}return l})}setPublishingLayers(e,t){return k(this,void 0,void 0,function*(){if(this.optimizeForPerformance){this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:t}));return}this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t})),!(!this.sender||!this.encodings)&&(yield ta(this.sender,this.encodings,t,this.senderLock,e,this.log,this.logContext))})}prioritizePerformance(){return k(this,void 0,void 0,function*(){if(!this.sender)throw new Error("sender not found");const e=yield this.senderLock.lock();try{this.optimizeForPerformance=!0;const t=this.sender.getParameters();t.encodings=t.encodings.map((i,r)=>{var s;return Object.assign(Object.assign({},i),{active:r===0,scaleResolutionDownBy:Math.max(1,Math.ceil(((s=this.mediaStreamTrack.getSettings().height)!==null&&s!==void 0?s:360)/360)),scalabilityMode:r===0&&je(this.codec)?"L1T3":void 0,maxFramerate:r===0?15:0,maxBitrate:r===0?i.maxBitrate:0})}),this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:t.encodings})),this.encodings=t.encodings,yield this.sender.setParameters(t)}catch(t){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:t})),this.optimizeForPerformance=!1}finally{e()}})}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return k(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),hl()&&this.isInBackground&&this.source===E.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function ta(n,e,t,i,r,s,a){return k(this,void 0,void 0,function*(){const o=yield i.lock();s.debug("setPublishingLayersForSender",Object.assign(Object.assign({},a),{sender:n,qualities:t,senderEncodings:e}));try{const c=n.getParameters(),{encodings:l}=c;if(!l)return;if(l.length!==e.length){s.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},a),{encodings:l,senderEncodings:e}));return}let u=!1;!1&&l[0].scalabilityMode||(r&&t.some(p=>p.enabled)&&t.forEach(p=>p.enabled=!0),l.forEach((h,p)=>{var b;let m=(b=h.rid)!==null&&b!==void 0?b:"";m===""&&(m="q");const T=Tl(m),S=t.find(P=>P.quality===T);S&&h.active!==S.enabled&&(u=!0,h.active=S.enabled,s.debug("setting layer ".concat(S.quality," to ").concat(h.active?"enabled":"disabled"),a),Vt()&&(S.enabled?(h.scaleResolutionDownBy=e[p].scaleResolutionDownBy,h.maxBitrate=e[p].maxBitrate,h.maxFrameRate=e[p].maxFrameRate):(h.scaleResolutionDownBy=4,h.maxBitrate=10,h.maxFrameRate=2)))})),u&&(c.encodings=l,s.debug("setting encodings",Object.assign(Object.assign({},a),{encodings:c.encodings})),yield n.setParameters(c))}finally{o()}})}function Tl(n){switch(n){case"f":return xe.HIGH;case"h":return xe.MEDIUM;case"q":return xe.LOW;default:return xe.HIGH}}function na(n,e,t,i){if(!t)return[new wt({quality:xe.HIGH,width:n,height:e,bitrate:0,ssrc:0})];if(i){const r=t[0].scalabilityMode,s=new Sl(r),a=[],o=s.suffix=="h"?1.5:2,c=s.suffix=="h"?2:3;for(let l=0;l<s.spatial;l+=1)a.push(new wt({quality:Math.min(xe.HIGH,s.spatial-1)-l,width:Math.ceil(n/Math.pow(o,l)),height:Math.ceil(e/Math.pow(o,l)),bitrate:t[0].maxBitrate?Math.ceil(t[0].maxBitrate/Math.pow(c,l)):0,ssrc:0}));return a}return t.map(r=>{var s,a,o;const c=(s=r.scaleResolutionDownBy)!==null&&s!==void 0?s:1;let l=Tl((a=r.rid)!==null&&a!==void 0?a:"");return new wt({quality:l,width:Math.ceil(n/c),height:Math.ceil(e/c),bitrate:(o=r.maxBitrate)!==null&&o!==void 0?o:0,ssrc:0})})}const ia="_lossy",ra="_reliable",pp=2*1e3,yr="leave-reconnect",mp=3e4,gp=8*1024,vp=256*1024;var Me;(function(n){n[n.New=0]="New",n[n.Connected=1]="Connected",n[n.Disconnected=2]="Disconnected",n[n.Reconnecting=3]="Reconnecting",n[n.Closed=4]="Closed"})(Me||(Me={}));class bp extends nt.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var t;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=Os.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.latestRemoteOfferId=0,this.subscriberPrimary=!1,this.pcState=Me.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=j,this.reliableDataSequence=1,this.reliableMessageBuffer=new Ho,this.reliableReceivedState=new Ff(mp),this.lossyDataStatCurrentBytes=0,this.lossyDataStatByterate=0,this.lossyDataDropCount=0,this.midToTrackId={},this.isWaitingForNetworkReconnect=!1,this.handleDataChannel=i=>k(this,[i],void 0,function(r){var s=this;let{channel:a}=r;return(function*(){if(a){if(a.label===ra)s.reliableDCSub=a;else if(a.label===ia)s.lossyDCSub=a;else return;s.log.debug("on data channel ".concat(a.id,", ").concat(a.label),s.logContext),a.onmessage=s.handleDataMessage}})()}),this.handleDataMessage=i=>k(this,void 0,void 0,function*(){var r,s,a,o,c;const l=yield this.dataProcessLock.lock();try{let u;if(i.data instanceof ArrayBuffer)u=i.data;else if(i.data instanceof Blob)u=yield i.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:i.data}));return}const d=ye.fromBinary(new Uint8Array(u));if(d.sequence>0&&d.participantSid!==""){const h=this.reliableReceivedState.get(d.participantSid);if(h&&d.sequence<=h)return;this.reliableReceivedState.set(d.participantSid,d.sequence)}if(((r=d.value)===null||r===void 0?void 0:r.case)==="speaker")this.emit(N.ActiveSpeakersUpdate,d.value.value.speakers);else if(((s=d.value)===null||s===void 0?void 0:s.case)==="encryptedPacket"){if(!this.e2eeManager){this.log.error("Received encrypted packet but E2EE not set up",this.logContext);return}const h=yield(a=this.e2eeManager)===null||a===void 0?void 0:a.handleEncryptedData(d.value.value.encryptedValue,d.value.value.iv,d.participantIdentity,d.value.value.keyIndex),p=ac.fromBinary(h.payload),b=new ye({value:p.value,participantIdentity:d.participantIdentity,participantSid:d.participantSid});((o=b.value)===null||o===void 0?void 0:o.case)==="user"&&sa(b,b.value.value),this.emit(N.DataPacketReceived,b,d.value.value.encryptionType)}else((c=d.value)===null||c===void 0?void 0:c.case)==="user"&&sa(d,d.value.value),this.emit(N.DataPacketReceived,d,le.NONE)}finally{l()}}),this.handleDataError=i=>{const s=i.currentTarget.maxRetransmits===0?"lossy":"reliable";if(i instanceof ErrorEvent&&i.error){const{error:a}=i.error;this.log.error("DataChannel error on ".concat(s,": ").concat(i.message),Object.assign(Object.assign({},this.logContext),{error:a}))}else this.log.error("Unknown DataChannel error on ".concat(s),Object.assign(Object.assign({},this.logContext),{event:i}))},this.handleBufferedAmountLow=i=>{const s=i.currentTarget.maxRetransmits===0?q.LOSSY:q.RELIABLE;this.updateAndEmitDCBufferStatus(s)},this.handleDisconnect=(i,r)=>{if(this._isClosed)return;this.log.warn("".concat(i," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const s=c=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(c,"ms. giving up"),this.logContext),this.emit(N.Disconnected),this.close()},a=Date.now()-this.reconnectStart;let o=this.getNextRetryDelay({elapsedMs:a,retryCount:this.reconnectAttempts});if(o===null){s(a);return}i===yr&&(o=0),this.log.debug("reconnecting in ".concat(o,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=me.setTimeout(()=>this.attemptReconnect(r).finally(()=>this.reconnectTimeout=void 0),o)},this.waitForRestarted=()=>new Promise((i,r)=>{this.pcState===Me.Connected&&i();const s=()=>{this.off(N.Disconnected,a),i()},a=()=>{this.off(N.Restarted,s),r()};this.once(N.Restarted,s),this.once(N.Disconnected,a)}),this.updateAndEmitDCBufferStatus=i=>{if(i===q.RELIABLE){const s=this.dataChannelForKind(i);s&&this.reliableMessageBuffer.alignBufferedAmount(s.bufferedAmount)}const r=this.isBufferStatusLow(i);typeof r<"u"&&r!==this.dcBufferStatus.get(i)&&(this.dcBufferStatus.set(i,r),this.emit(N.DCBufferStatusChanged,r,i))},this.isBufferStatusLow=i=>{const r=this.dataChannelForKind(i);if(r)return r.bufferedAmount<=r.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>k(this,void 0,void 0,function*(){!this.url||!(yield fetch(jn(this.url),{method:"HEAD"}).then(r=>r.ok).catch(()=>!1))||(this.log.info("detected network reconnected"),(this.client.currentState===Q.RECONNECTING||this.isWaitingForNetworkReconnect&&this.client.currentState===Q.CONNECTED)&&(this.clearReconnectTimeout(),this.attemptReconnect(Nt.RR_SIGNAL_DISCONNECTED),this.isWaitingForNetworkReconnect=!1))}),this.handleBrowserOffline=()=>k(this,void 0,void 0,function*(){if(this.url)try{yield Promise.race([fetch(jn(this.url),{method:"HEAD"}),ge(4e3).then(()=>Promise.reject())])}catch{window.navigator.onLine===!1&&(this.log.info("detected network interruption"),this.isWaitingForNetworkReconnect=!0)}}),this.log=ht((t=e.loggerName)!==null&&t!==void 0?t:qe.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new Rs(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.closingLock=new ke,this.dataProcessLock=new ke,this.dcBufferStatus=new Map([[q.LOSSY,!0],[q.RELIABLE,!0]]),this.client.onParticipantUpdate=i=>this.emit(N.ParticipantUpdate,i),this.client.onConnectionQuality=i=>this.emit(N.ConnectionQualityUpdate,i),this.client.onRoomUpdate=i=>this.emit(N.RoomUpdate,i),this.client.onSubscriptionError=i=>this.emit(N.SubscriptionError,i),this.client.onSubscriptionPermissionUpdate=i=>this.emit(N.SubscriptionPermissionUpdate,i),this.client.onSpeakersChanged=i=>this.emit(N.SpeakersChanged,i),this.client.onStreamStateUpdate=i=>this.emit(N.StreamStateChanged,i),this.client.onRequestResponse=i=>this.emit(N.SignalRequestResponse,i)}get logContext(){var e,t,i,r,s,a;return{room:(t=(e=this.latestJoinResponse)===null||e===void 0?void 0:e.room)===null||t===void 0?void 0:t.name,roomID:(r=(i=this.latestJoinResponse)===null||i===void 0?void 0:i.room)===null||r===void 0?void 0:r.sid,participant:(a=(s=this.latestJoinResponse)===null||s===void 0?void 0:s.participant)===null||a===void 0?void 0:a.identity,pID:this.participantSid}}join(e,t,i,r){return k(this,arguments,void 0,function(s,a,o,c){var l=this;let u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;return(function*(){l.url=s,l.token=a,l.signalOpts=o,l.maxJoinAttempts=o.maxRetries;try{l.joinAttempts+=1,l.setupSignalClientCallbacks();const d=yield l.client.join(s,a,o,c,u);return l._isClosed=!1,l.latestJoinResponse=d,l.subscriberPrimary=d.subscriberPrimary,l.pcManager||(yield l.configure(d,!u)),(!l.subscriberPrimary||d.fastPublish)&&l.negotiate().catch(h=>{j.error(h,l.logContext)}),l.registerOnLineListener(),l.clientConfiguration=d.clientConfiguration,l.emit(N.SignalConnected,d),d}catch(d){if(d instanceof F){if(d.reason===Y.ServerUnreachable){if(l.log.warn("Couldn't connect to server, attempt ".concat(l.joinAttempts," of ").concat(l.maxJoinAttempts),l.logContext),l.joinAttempts<l.maxJoinAttempts)return l.join(s,a,o,c,u)}else if(d.reason===Y.ServiceNotFound)return l.log.warn("Initial connection failed: ".concat(d.message,"  Retrying")),l.join(s,a,o,c,!0)}throw d}})()})}close(){return k(this,void 0,void 0,function*(){const e=yield this.closingLock.lock();if(this.isClosed){e();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(N.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),this.cleanupLossyDataStats(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}})}cleanupPeerConnections(){return k(this,void 0,void 0,function*(){var e;yield(e=this.pcManager)===null||e===void 0?void 0:e.close(),this.pcManager=void 0;const t=i=>{i&&(i.close(),i.onbufferedamountlow=null,i.onclose=null,i.onclosing=null,i.onerror=null,i.onmessage=null,i.onopen=null)};t(this.lossyDC),t(this.lossyDCSub),t(this.reliableDC),t(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0,this.reliableMessageBuffer=new Ho,this.reliableDataSequence=1,this.reliableReceivedState.clear()})}cleanupLossyDataStats(){this.lossyDataStatByterate=0,this.lossyDataStatCurrentBytes=0,this.lossyDataStatInterval&&(clearInterval(this.lossyDataStatInterval),this.lossyDataStatInterval=void 0),this.lossyDataDropCount=0}cleanupClient(){return k(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new dt("a track with the same ID has already been published");return new Promise((t,i)=>{const r=setTimeout(()=>{delete this.pendingTrackResolvers[e.cid],i(F.timeout("publication of local track timed out, no response from server"))},1e4);this.pendingTrackResolvers[e.cid]={resolve:s=>{clearTimeout(r),t(s)},reject:()=>{clearTimeout(r),i(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)})}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(t){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:t}))}return!1}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return(e=this.reliableDCSub)===null||e===void 0?void 0:e.readyState}getConnectedServerAddress(){return k(this,void 0,void 0,function*(){var e;return(e=this.pcManager)===null||e===void 0?void 0:e.getConnectedAddress()})}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e,t){return k(this,void 0,void 0,function*(){var i,r;if(this.pcManager&&this.pcManager.currentState!==te.NEW)return;this.participantSid=(i=e.participant)===null||i===void 0?void 0:i.sid;const s=this.makeRTCConfiguration(e);this.pcManager=new Gf(s,t?"publisher-only":e.subscriberPrimary?"subscriber-primary":"publisher-primary",this.loggerOptions),this.emit(N.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(a,o)=>{this.client.sendIceCandidate(a,o)},this.pcManager.onPublisherOffer=(a,o)=>{this.client.sendOffer(a,o)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(a,o,c)=>k(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(a),this.logContext),["closed","disconnected","failed"].includes(o)&&(this.publisherConnectionPromise=void 0),a===te.CONNECTED){const d=this.pcState===Me.New;this.pcState=Me.Connected,d&&this.emit(N.Connected,e)}else a===te.FAILED&&(this.pcState===Me.Connected||this.pcState===Me.Reconnecting)&&(this.pcState=Me.Disconnected,this.handleDisconnect("peerconnection failed",c==="failed"?Nt.RR_SUBSCRIBER_FAILED:Nt.RR_PUBLISHER_FAILED));const l=this.client.isDisconnected||this.client.currentState===Q.RECONNECTING,u=[te.FAILED,te.CLOSING,te.CLOSED].includes(a);l&&u&&!this._isClosed&&this.emit(N.Offline)}),this.pcManager.onTrack=a=>{a.streams.length!==0&&this.emit(N.MediaTrackAdded,a.track,a.streams[0],a.receiver)},yp((r=e.serverInfo)===null||r===void 0?void 0:r.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=(e,t,i)=>k(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,midToTrackId:i})),this.midToTrackId=i,yield this.pcManager.setPublisherAnswer(e,t))}),this.client.onTrickle=(e,t)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t})),this.pcManager.addIceCandidate(e,t))},this.client.onOffer=(e,t,i)=>k(this,void 0,void 0,function*(){if(this.latestRemoteOfferId=t,!this.pcManager)return;this.midToTrackId=i;const r=yield this.pcManager.createSubscriberAnswerFromOffer(e,t);r&&this.client.sendAnswer(r,t)}),this.client.onLocalTrackPublished=e=>{var t;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:(t=e.track)===null||t===void 0?void 0:t.sid})),!this.pendingTrackResolvers[e.cid]){this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));return}const{resolve:i}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],i(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(N.LocalTrackUnpublished,e)},this.client.onLocalTrackSubscribed=e=>{this.emit(N.LocalTrackSubscribed,e)},this.client.onTokenRefresh=e=>{var t;this.token=e,(t=this.regionUrlProvider)===null||t===void 0||t.updateToken(e)},this.client.onRemoteMuteChanged=(e,t)=>{this.emit(N.RemoteMute,e,t)},this.client.onSubscribedQualityUpdate=e=>{this.emit(N.SubscribedQualityUpdate,e)},this.client.onRoomMoved=e=>{var t;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=e.room),this.emit(N.RoomMoved,e)},this.client.onMediaSectionsRequirement=e=>{var t,i;const r={direction:"recvonly"};for(let s=0;s<e.numAudios;s++)(t=this.pcManager)===null||t===void 0||t.addPublisherTransceiverOfKind("audio",r);for(let s=0;s<e.numVideos;s++)(i=this.pcManager)===null||i===void 0||i.addPublisherTransceiverOfKind("video",r);this.negotiate()},this.client.onClose=()=>{this.handleDisconnect("signal",Nt.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:e?.reason})),e.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions({updatedAtInMs:Date.now(),maxAgeInMs:bl,regionSettings:e.regions})),e.action){case tn.DISCONNECT:this.emit(N.Disconnected,e?.reason),this.close();break;case tn.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(yr);break;case tn.RESUME:this.handleDisconnect(yr)}}}makeRTCConfiguration(e){var t;const i=Object.assign({},this.rtcConfig);if(!((t=this.signalOpts)===null||t===void 0)&&t.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),i.encodedInsertableStreams=!0),e.iceServers&&!i.iceServers){const r=[];e.iceServers.forEach(s=>{const a={urls:s.urls};s.username&&(a.username=s.username),s.credential&&(a.credential=s.credential),r.push(a)}),i.iceServers=r}return e.clientConfiguration&&e.clientConfiguration.forceRelay===Dn.ENABLED&&(i.iceTransportPolicy="relay"),i.sdpSemantics="unified-plan",i.continualGatheringPolicy="gather_continually",i}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(ia,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(ra,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow,this.cleanupLossyDataStats(),this.lossyDataStatInterval=setInterval(()=>{this.lossyDataStatByterate=this.lossyDataStatCurrentBytes,this.lossyDataStatCurrentBytes=0;const e=this.dataChannelForKind(q.LOSSY);if(e){const t=this.lossyDataStatByterate/10;e.bufferedAmountLowThreshold=Math.min(Math.max(t,gp),vp)}},1e3))}createSender(e,t,i){return k(this,void 0,void 0,function*(){if(Wr())return yield this.createTransceiverRTCRtpSender(e,t,i);if(Hr())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(e.mediaStreamTrack);throw new re("Required webRTC APIs not supported on this device")})}createSimulcastSender(e,t,i,r){return k(this,void 0,void 0,function*(){if(Wr())return this.createSimulcastTransceiverSender(e,t,i,r);if(Hr())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new re("Cannot stream on this device")})}createTransceiverRTCRtpSender(e,t,i){return k(this,void 0,void 0,function*(){if(!this.pcManager)throw new re("publisher is closed");const r=[];e.mediaStream&&r.push(e.mediaStream),Mt(e)&&(e.codec=t.videoCodec);const s={direction:"sendonly",streams:r};return i&&(s.sendEncodings=i),(yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,s)).sender})}createSimulcastTransceiverSender(e,t,i,r){return k(this,void 0,void 0,function*(){if(!this.pcManager)throw new re("publisher is closed");const s={direction:"sendonly"};r&&(s.sendEncodings=r);const a=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,s);if(i.videoCodec)return e.setSimulcastTrackSender(i.videoCodec,a.sender),a.sender})}createRTCRtpSender(e){return k(this,void 0,void 0,function*(){if(!this.pcManager)throw new re("publisher is closed");return this.pcManager.addPublisherTrack(e)})}attemptReconnect(e){return k(this,void 0,void 0,function*(){var t,i,r;if(!this._isClosed){if(this.attemptingReconnect){j.warn("already attempting reconnect, returning early",this.logContext);return}(((t=this.clientConfiguration)===null||t===void 0?void 0:t.resumeConnection)===Dn.DISABLED||((r=(i=this.pcManager)===null||i===void 0?void 0:i.currentState)!==null&&r!==void 0?r:te.NEW)===te.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(s){this.reconnectAttempts+=1;let a=!0;s instanceof re?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:s})),a=!1):s instanceof Qt||(this.fullReconnectOnNext=!0),a?this.handleDisconnect("reconnect",Nt.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(N.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(t){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:t}))}return null}restartConnection(e){return k(this,void 0,void 0,function*(){var t,i,r;try{if(!this.url||!this.token)throw new re("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(N.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let s;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new Qt;s=yield this.join(e??this.url,this.token,this.signalOpts,void 0,!this.options.singlePeerConnection)}catch(a){throw a instanceof F&&a.reason===Y.NotAllowed?new re("could not reconnect, token might be expired"):new Qt}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(N.SignalRestarted,s),yield this.waitForPCReconnected(),this.client.currentState!==Q.CONNECTED)throw new Qt("Signal connection got severed during reconnect");(t=this.regionUrlProvider)===null||t===void 0||t.resetAttempts(),this.emit(N.Restarted)}catch(s){const a=yield(i=this.regionUrlProvider)===null||i===void 0?void 0:i.getNextBestRegionUrl();if(a){yield this.restartConnection(a);return}else throw(r=this.regionUrlProvider)===null||r===void 0||r.resetAttempts(),s}})}resumeConnection(e){return k(this,void 0,void 0,function*(){var t;if(!this.url||!this.token)throw new re("could not reconnect, url or token not saved");if(!this.pcManager)throw new re("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(N.Resuming);let i;try{this.setupSignalClientCallbacks(),i=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(r){let s="";throw r instanceof Error&&(s=r.message,this.log.error(r.message,Object.assign(Object.assign({},this.logContext),{error:r}))),r instanceof F&&r.reason===Y.NotAllowed?new re("could not reconnect, token might be expired"):r instanceof F&&r.reason===Y.LeaveRequest?r:new Qt(s)}if(this.emit(N.SignalResumed),i){const r=this.makeRTCConfiguration(i);this.pcManager.updateConfiguration(r),this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=i.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==Q.CONNECTED)throw new Qt("Signal connection got severed during reconnect");this.client.setReconnected(),((t=this.reliableDC)===null||t===void 0?void 0:t.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),i?.lastMessageSeq&&this.resendReliableMessagesForResume(i.lastMessageSeq),this.emit(N.Resumed)})}waitForPCInitialConnection(e,t){return k(this,void 0,void 0,function*(){if(!this.pcManager)throw new re("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)})}waitForPCReconnected(){return k(this,void 0,void 0,function*(){this.pcState=Me.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield ge(pp),!this.pcManager)throw new re("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=Me.Connected}catch(e){throw this.pcState=Me.Disconnected,F.internal("could not establish PC connection, ".concat(e.message))}})}publishRpcResponse(e,t,i,r){return k(this,void 0,void 0,function*(){const s=new ye({destinationIdentities:[e],kind:q.RELIABLE,value:{case:"rpcResponse",value:new ms({requestId:t,value:r?{case:"error",value:r.toProto()}:{case:"payload",value:i??""}})}});yield this.sendDataPacket(s,q.RELIABLE)})}publishRpcAck(e,t){return k(this,void 0,void 0,function*(){const i=new ye({destinationIdentities:[e],kind:q.RELIABLE,value:{case:"rpcAck",value:new ps({requestId:t})}});yield this.sendDataPacket(i,q.RELIABLE)})}sendDataPacket(e,t){return k(this,void 0,void 0,function*(){if(yield this.ensurePublisherConnected(t),this.e2eeManager&&this.e2eeManager.isDataChannelEncryptionEnabled){const s=Rf(e);if(s){const a=yield this.e2eeManager.encryptData(s.toBinary());e.value={case:"encryptedPacket",value:new oc({encryptedValue:a.payload,iv:a.iv,keyIndex:a.keyIndex})}}}t===q.RELIABLE&&(e.sequence=this.reliableDataSequence,this.reliableDataSequence+=1);const i=e.toBinary(),r=this.dataChannelForKind(t);if(r){if(t===q.RELIABLE)yield this.waitForBufferStatusLow(t),this.reliableMessageBuffer.push({data:i,sequence:e.sequence});else{if(!this.isBufferStatusLow(t)){this.lossyDataDropCount+=1,this.lossyDataDropCount%100===0&&this.log.warn("dropping lossy data channel messages, total dropped: ".concat(this.lossyDataDropCount),this.logContext);return}this.lossyDataStatCurrentBytes+=i.byteLength}if(this.attemptingReconnect)return;r.send(i)}this.updateAndEmitDCBufferStatus(t)})}resendReliableMessagesForResume(e){return k(this,void 0,void 0,function*(){yield this.ensurePublisherConnected(q.RELIABLE);const t=this.dataChannelForKind(q.RELIABLE);t&&(this.reliableMessageBuffer.popToSequence(e),this.reliableMessageBuffer.getAll().forEach(i=>{t.send(i.data)})),this.updateAndEmitDCBufferStatus(q.RELIABLE)})}waitForBufferStatusLow(e){return new Pe((t,i)=>k(this,void 0,void 0,function*(){if(this.isBufferStatusLow(e))t();else{const r=()=>i(new re("engine closed"));for(this.once(N.Closing,r);!this.dcBufferStatus.get(e);)yield ge(10);this.off(N.Closing,r),t()}}))}ensureDataTransportConnected(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return(function*(){var s;if(!i.pcManager)throw new re("PC manager is closed");const a=r?i.pcManager.subscriber:i.pcManager.publisher,o=r?"Subscriber":"Publisher";if(!a)throw F.internal("".concat(o," connection not set"));let c=!1;!r&&!i.dataChannelForKind(t,r)&&(i.createDataChannels(),c=!0),!c&&!r&&!i.pcManager.publisher.isICEConnected&&i.pcManager.publisher.getICEConnectionState()!=="checking"&&(c=!0),c&&i.negotiate().catch(d=>{j.error(d,i.logContext)});const l=i.dataChannelForKind(t,r);if(l?.readyState==="open")return;const u=new Date().getTime()+i.peerConnectionTimeout;for(;new Date().getTime()<u;){if(a.isICEConnected&&((s=i.dataChannelForKind(t,r))===null||s===void 0?void 0:s.readyState)==="open")return;yield ge(50)}throw F.internal("could not establish ".concat(o," connection, state: ").concat(a.getICEConnectionState()))})()})}ensurePublisherConnected(e){return k(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==te.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return k(this,void 0,void 0,function*(){return new Pe((e,t)=>k(this,void 0,void 0,function*(){if(!this.pcManager){t(new rn("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const i=new AbortController,r=()=>{i.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&t(new rn("cannot negotiate on closed engine")),this.on(N.Closing,r),this.pcManager.publisher.once(an.RTPVideoPayloadTypes,s=>{const a=new Map;s.forEach(o=>{const c=o.codec.toLowerCase();uf(c)&&a.set(o.payload,c)}),this.emit(N.RTPVideoMapUpdate,a)});try{yield this.pcManager.negotiate(i),e()}catch(s){s instanceof rn&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",Nt.RR_UNKNOWN),s instanceof Error?t(s):t(new Error(String(s)))}finally{this.off(N.Closing,r)}}))})}dataChannelForKind(e,t){if(t){if(e===q.LOSSY)return this.lossyDCSub;if(e===q.RELIABLE)return this.reliableDCSub}else{if(e===q.LOSSY)return this.lossyDC;if(e===q.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var i,r,s,a;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const o=this.pcManager.publisher.getLocalDescription(),c=this.pcManager.publisher.getRemoteDescription(),l=(i=this.pcManager.subscriber)===null||i===void 0?void 0:i.getRemoteDescription(),u=(r=this.pcManager.subscriber)===null||r===void 0?void 0:r.getLocalDescription(),d=(a=(s=this.signalOpts)===null||s===void 0?void 0:s.autoSubscribe)!==null&&a!==void 0?a:!0,h=new Array,p=new Array;e.forEach(b=>{b.isDesired!==d&&h.push(b.trackSid),b.isEnabled||p.push(b.trackSid)}),this.client.sendSyncState(new ks({answer:this.pcManager.mode==="publisher-only"?c?Zt({sdp:c.sdp,type:c.type}):void 0:u?Zt({sdp:u.sdp,type:u.type}):void 0,offer:this.pcManager.mode==="publisher-only"?o?Zt({sdp:o.sdp,type:o.type}):void 0:l?Zt({sdp:l.sdp,type:l.type}):void 0,subscription:new Bi({trackSids:h,subscribe:!d,participantTracks:[]}),publishTracks:zh(t),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:p,datachannelReceiveStates:this.reliableReceivedState.map((b,m)=>new Pc({publisherSid:m,lastSeq:b}))}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],t=(i,r)=>{i?.id!==void 0&&i.id!==null&&e.push(new Rc({label:i.label,id:i.id,target:r}))};return t(this.dataChannelForKind(q.LOSSY),Fe.PUBLISHER),t(this.dataChannelForKind(q.RELIABLE),Fe.PUBLISHER),t(this.dataChannelForKind(q.LOSSY,!0),Fe.SUBSCRIBER),t(this.dataChannelForKind(q.RELIABLE,!0),Fe.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&me.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){Re()&&(window.addEventListener("online",this.handleBrowserOnLine),window.addEventListener("offline",this.handleBrowserOffline))}deregisterOnLineListener(){Re()&&(window.removeEventListener("online",this.handleBrowserOnLine),window.removeEventListener("offline",this.handleBrowserOffline))}getTrackIdForReceiver(e){var t;const i=(t=this.pcManager)===null||t===void 0?void 0:t.getMidForReceiver(e);if(i){const r=Object.entries(this.midToTrackId).find(s=>{let[a]=s;return a===i});if(r)return r[1]}}}function yp(n){return n!==void 0&&n>13}function sa(n,e){const t=n.participantIdentity?n.participantIdentity:e.participantIdentity;n.participantIdentity=t,e.participantIdentity=t;const i=n.destinationIdentities.length!==0?n.destinationIdentities:e.destinationIdentities;n.destinationIdentities=i,e.destinationIdentities=i}class Cl{get info(){return this._info}validateBytesReceived(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!(typeof this.totalByteSize!="number"||this.totalByteSize===0)){if(e&&this.bytesReceived<this.totalByteSize)throw new De("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),be.Incomplete);if(this.bytesReceived>this.totalByteSize)throw new De("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),be.LengthExceeded)}}constructor(e,t,i,r){this.reader=t,this.totalByteSize=i,this._info=e,this.bytesReceived=0,this.outOfBandFailureRejectingFuture=r}}class kp extends Cl{handleChunkReceived(e){var t;this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const i=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0||t.call(this,i)}[Symbol.asyncIterator](){const e=this.reader.getReader();let t=new Ae,i=null,r=null;if(this.signal){const a=this.signal;r=()=>{var o;(o=t.reject)===null||o===void 0||o.call(t,a.reason)},a.addEventListener("abort",r),i=a}const s=()=>{e.releaseLock(),i&&r&&i.removeEventListener("abort",r),this.signal=void 0};return{next:()=>k(this,void 0,void 0,function*(){var a,o;try{const{done:c,value:l}=yield Promise.race([e.read(),t.promise,(o=(a=this.outOfBandFailureRejectingFuture)===null||a===void 0?void 0:a.promise)!==null&&o!==void 0?o:new Promise(()=>{})]);return c?(this.validateBytesReceived(!0),{done:!0,value:void 0}):(this.handleChunkReceived(l),{done:!1,value:l.content})}catch(c){throw s(),c}}),return(){return k(this,void 0,void 0,function*(){return s(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var i,r,s,a;let o=new Set;const c=t.signal?e.withAbortSignal(t.signal):e;try{for(var l=!0,u=ut(c),d;d=yield u.next(),i=d.done,!i;l=!0){a=d.value,l=!1;const h=a;o.add(h)}}catch(h){r={error:h}}finally{try{!l&&!i&&(s=u.return)&&(yield s.call(u))}finally{if(r)throw r.error}}return Array.from(o)})()})}}class Sp extends Cl{constructor(e,t,i,r){super(e,t,i,r),this.receivedChunks=new Map}handleChunkReceived(e){var t;const i=pi(e.chunkIndex),r=this.receivedChunks.get(i);if(r&&r.version>e.version)return;this.receivedChunks.set(i,e),this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const s=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0||t.call(this,s)}[Symbol.asyncIterator](){const e=this.reader.getReader(),t=new TextDecoder("utf-8",{fatal:!0});let i=new Ae,r=null,s=null;if(this.signal){const o=this.signal;s=()=>{var c;(c=i.reject)===null||c===void 0||c.call(i,o.reason)},o.addEventListener("abort",s),r=o}const a=()=>{e.releaseLock(),r&&s&&r.removeEventListener("abort",s),this.signal=void 0};return{next:()=>k(this,void 0,void 0,function*(){var o,c;try{const{done:l,value:u}=yield Promise.race([e.read(),i.promise,(c=(o=this.outOfBandFailureRejectingFuture)===null||o===void 0?void 0:o.promise)!==null&&c!==void 0?c:new Promise(()=>{})]);if(l)return this.validateBytesReceived(!0),{done:!0,value:void 0};{this.handleChunkReceived(u);let d;try{d=t.decode(u.content)}catch(h){throw new De("Cannot decode datastream chunk ".concat(u.chunkIndex," as text: ").concat(h),be.DecodeFailed)}return{done:!1,value:d}}}catch(l){throw a(),l}}),return(){return k(this,void 0,void 0,function*(){return a(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return k(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var i,r,s,a;let o="";const c=t.signal?e.withAbortSignal(t.signal):e;try{for(var l=!0,u=ut(c),d;d=yield u.next(),i=d.done,!i;l=!0)a=d.value,l=!1,o+=a}catch(h){r={error:h}}finally{try{!l&&!i&&(s=u.return)&&(yield s.call(u))}finally{if(r)throw r.error}}return o})()})}}class Tp{constructor(){this.log=j,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map}registerTextStreamHandler(e,t){if(this.textStreamHandlers.has(e))throw new De('A text stream handler for topic "'.concat(e,'" has already been set.'),be.HandlerAlreadyRegistered);this.textStreamHandlers.set(e,t)}unregisterTextStreamHandler(e){this.textStreamHandlers.delete(e)}registerByteStreamHandler(e,t){if(this.byteStreamHandlers.has(e))throw new De('A byte stream handler for topic "'.concat(e,'" has already been set.'),be.HandlerAlreadyRegistered);this.byteStreamHandlers.set(e,t)}unregisterByteStreamHandler(e){this.byteStreamHandlers.delete(e)}clearControllers(){this.byteStreamControllers.clear(),this.textStreamControllers.clear()}validateParticipantHasNoActiveDataStreams(e){var t,i,r,s;const a=Array.from(this.textStreamControllers.entries()).filter(c=>c[1].sendingParticipantIdentity===e),o=Array.from(this.byteStreamControllers.entries()).filter(c=>c[1].sendingParticipantIdentity===e);if(a.length>0||o.length>0){const c=new De("Participant ".concat(e," unexpectedly disconnected in the middle of sending data"),be.AbnormalEnd);for(const[l,u]of o)(i=(t=u.outOfBandFailureRejectingFuture).reject)===null||i===void 0||i.call(t,c),this.byteStreamControllers.delete(l);for(const[l,u]of a)(s=(r=u.outOfBandFailureRejectingFuture).reject)===null||s===void 0||s.call(r,c),this.textStreamControllers.delete(l)}}handleDataStreamPacket(e,t){return k(this,void 0,void 0,function*(){switch(e.value.case){case"streamHeader":return this.handleStreamHeader(e.value.value,e.participantIdentity,t);case"streamChunk":return this.handleStreamChunk(e.value.value,t);case"streamTrailer":return this.handleStreamTrailer(e.value.value,t);default:throw new Error('DataPacket of value "'.concat(e.value.case,'" is not data stream related!'))}})}handleStreamHeader(e,t,i){return k(this,void 0,void 0,function*(){var r;if(e.contentHeader.case==="byteHeader"){const s=this.byteStreamHandlers.get(e.topic);if(!s){this.log.debug("ignoring incoming byte stream due to no handler for topic",e.topic);return}let a;const o=new Ae;o.promise.catch(u=>{this.log.error(u)});const c={id:e.streamId,name:(r=e.contentHeader.value.name)!==null&&r!==void 0?r:"unknown",mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:pi(e.timestamp),attributes:e.attributes,encryptionType:i},l=new ReadableStream({start:u=>{if(a=u,this.textStreamControllers.has(e.streamId))throw new De("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),be.AlreadyOpened);this.byteStreamControllers.set(e.streamId,{info:c,controller:a,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:o})}});s(new kp(c,l,pi(e.totalLength),o),{identity:t})}else if(e.contentHeader.case==="textHeader"){const s=this.textStreamHandlers.get(e.topic);if(!s){this.log.debug("ignoring incoming text stream due to no handler for topic",e.topic);return}let a;const o=new Ae;o.promise.catch(u=>{this.log.error(u)});const c={id:e.streamId,mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Number(e.timestamp),attributes:e.attributes,encryptionType:i},l=new ReadableStream({start:u=>{if(a=u,this.textStreamControllers.has(e.streamId))throw new De("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),be.AlreadyOpened);this.textStreamControllers.set(e.streamId,{info:c,controller:a,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:o})}});s(new Sp(c,l,pi(e.totalLength),o),{identity:t})}})}handleStreamChunk(e,t){const i=this.byteStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?(i.controller.error(new De("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),be.EncryptionTypeMismatch)),this.byteStreamControllers.delete(e.streamId)):e.content.length>0&&i.controller.enqueue(e));const r=this.textStreamControllers.get(e.streamId);r&&(r.info.encryptionType!==t?(r.controller.error(new De("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(r.info.encryptionType),be.EncryptionTypeMismatch)),this.textStreamControllers.delete(e.streamId)):e.content.length>0&&r.controller.enqueue(e))}handleStreamTrailer(e,t){const i=this.textStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?i.controller.error(new De("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),be.EncryptionTypeMismatch)):(i.info.attributes=Object.assign(Object.assign({},i.info.attributes),e.attributes),i.controller.close(),this.textStreamControllers.delete(e.streamId)));const r=this.byteStreamControllers.get(e.streamId);r&&(r.info.encryptionType!==t?r.controller.error(new De("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(r.info.encryptionType),be.EncryptionTypeMismatch)):(r.info.attributes=Object.assign(Object.assign({},r.info.attributes),e.attributes),r.controller.close()),this.byteStreamControllers.delete(e.streamId))}}class El{constructor(e,t,i){this.writableStream=e,this.defaultWriter=e.getWriter(),this.onClose=i,this.info=t}write(e){return this.defaultWriter.write(e)}close(){return k(this,void 0,void 0,function*(){var e;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),(e=this.onClose)===null||e===void 0||e.call(this)})}}class Cp extends El{}class Ep extends El{}const oa=15e3;class wp{constructor(e,t){this.engine=e,this.log=t}setupEngine(e){this.engine=e}sendText(e,t){return k(this,void 0,void 0,function*(){var i;const r=crypto.randomUUID(),a=new TextEncoder().encode(e).byteLength,o=(i=t?.attachments)===null||i===void 0?void 0:i.map(()=>crypto.randomUUID()),c=new Array(o?o.length+1:1).fill(0),l=(d,h)=>{var p;c[h]=d;const b=c.reduce((m,T)=>m+T,0);(p=t?.onProgress)===null||p===void 0||p.call(t,b)},u=yield this.streamText({streamId:r,totalSize:a,destinationIdentities:t?.destinationIdentities,topic:t?.topic,attachedStreamIds:o,attributes:t?.attributes});return yield u.write(e),l(1,0),yield u.close(),t?.attachments&&o&&(yield Promise.all(t.attachments.map((d,h)=>k(this,void 0,void 0,function*(){return this._sendFile(o[h],d,{topic:t.topic,mimeType:d.type,onProgress:p=>{l(p,h+1)}})})))),u.info})}streamText(e){return k(this,void 0,void 0,function*(){var t,i,r;const s=(t=e?.streamId)!==null&&t!==void 0?t:crypto.randomUUID(),a={id:s,mimeType:"text/plain",timestamp:Date.now(),topic:(i=e?.topic)!==null&&i!==void 0?i:"",size:e?.totalSize,attributes:e?.attributes,encryptionType:!((r=this.engine.e2eeManager)===null||r===void 0)&&r.isDataChannelEncryptionEnabled?le.GCM:le.NONE},o=new ki({streamId:s,mimeType:a.mimeType,topic:a.topic,timestamp:Ut(a.timestamp),totalLength:Ut(e?.totalSize),attributes:a.attributes,contentHeader:{case:"textHeader",value:new bc({version:e?.version,attachedStreamIds:e?.attachedStreamIds,replyToStreamId:e?.replyToStreamId,operationType:e?.type==="update"?Ir.UPDATE:Ir.CREATE})}}),c=e?.destinationIdentities,l=new ye({destinationIdentities:c,value:{case:"streamHeader",value:o}});yield this.engine.sendDataPacket(l,q.RELIABLE);let u=0;const d=this.engine,h=new WritableStream({write(m){return k(this,void 0,void 0,function*(){for(const T of gf(m,oa)){const S=new Si({content:T,streamId:s,chunkIndex:Ut(u)}),P=new ye({destinationIdentities:c,value:{case:"streamChunk",value:S}});yield d.sendDataPacket(P,q.RELIABLE),u+=1}})},close(){return k(this,void 0,void 0,function*(){const m=new Ti({streamId:s}),T=new ye({destinationIdentities:c,value:{case:"streamTrailer",value:m}});yield d.sendDataPacket(T,q.RELIABLE)})},abort(m){console.log("Sink error:",m)}});let p=()=>k(this,void 0,void 0,function*(){yield b.close()});d.once(N.Closing,p);const b=new Cp(h,a,()=>this.engine.off(N.Closing,p));return b})}sendFile(e,t){return k(this,void 0,void 0,function*(){const i=crypto.randomUUID();return yield this._sendFile(i,e,t),{id:i}})}_sendFile(e,t,i){return k(this,void 0,void 0,function*(){var r;const s=yield this.streamBytes({streamId:e,totalSize:t.size,name:t.name,mimeType:(r=i?.mimeType)!==null&&r!==void 0?r:t.type,topic:i?.topic,destinationIdentities:i?.destinationIdentities}),a=t.stream().getReader();for(;;){const{done:o,value:c}=yield a.read();if(o)break;yield s.write(c)}return yield s.close(),s.info})}streamBytes(e){return k(this,void 0,void 0,function*(){var t,i,r,s,a,o;const c=(t=e?.streamId)!==null&&t!==void 0?t:crypto.randomUUID(),l=e?.destinationIdentities,u={id:c,mimeType:(i=e?.mimeType)!==null&&i!==void 0?i:"application/octet-stream",topic:(r=e?.topic)!==null&&r!==void 0?r:"",timestamp:Date.now(),attributes:e?.attributes,size:e?.totalSize,name:(s=e?.name)!==null&&s!==void 0?s:"unknown",encryptionType:!((a=this.engine.e2eeManager)===null||a===void 0)&&a.isDataChannelEncryptionEnabled?le.GCM:le.NONE},d=new ki({totalLength:Ut((o=u.size)!==null&&o!==void 0?o:0),mimeType:u.mimeType,streamId:c,topic:u.topic,timestamp:Ut(Date.now()),attributes:u.attributes,contentHeader:{case:"byteHeader",value:new yc({name:u.name})}}),h=new ye({destinationIdentities:l,value:{case:"streamHeader",value:d}});yield this.engine.sendDataPacket(h,q.RELIABLE);let p=0;const b=new ke,m=this.engine,T=this.log,S=new WritableStream({write(M){return k(this,void 0,void 0,function*(){const v=yield b.lock();let g=0;try{for(;g<M.byteLength;){const y=M.slice(g,g+oa),C=new ye({destinationIdentities:l,value:{case:"streamChunk",value:new Si({content:y,streamId:c,chunkIndex:Ut(p)})}});yield m.sendDataPacket(C,q.RELIABLE),p+=1,g+=y.byteLength}}finally{v()}})},close(){return k(this,void 0,void 0,function*(){const M=new Ti({streamId:c}),v=new ye({destinationIdentities:l,value:{case:"streamTrailer",value:M}});yield m.sendDataPacket(v,q.RELIABLE)})},abort(M){T.error("Sink error:",M)}});return new Ep(S,u)})}}class wl extends E{constructor(e,t,i,r,s){super(e,i,s),this.sid=t,this.receiver=r}get isLocal(){return!1}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?L.Muted:L.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const t=i=>{i.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",t),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(L.Ended,this))};e.addEventListener("removetrack",t)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return k(this,void 0,void 0,function*(){var e;return!((e=this.receiver)===null||e===void 0)&&e.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),Ds)),Gh()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var t;this.timeSyncHandle=requestAnimationFrame(()=>e());const i=(t=this.receiver)===null||t===void 0?void 0:t.getSynchronizationSources()[0];if(i){const{timestamp:r,rtpTimestamp:s}=i;s&&this.rtpTimestamp!==s&&(this.emit(L.TimeSyncUpdate,{timestamp:r,rtpTimestamp:s}),this.rtpTimestamp=s)}};e()}}class Pl extends wl{constructor(e,t,i,r,s,a){super(e,t,E.Kind.Audio,i,a),this.monitorReceiver=()=>k(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const o=yield this.getReceiverStats();o&&this.prevStats&&this.receiver&&(this._currentBitrate=Wi(o,this.prevStats)),this.prevStats=o}),this.audioContext=r,this.webAudioPluginNodes=[],s&&(this.sinkId=s.deviceId)}setVolume(e){var t;for(const i of this.attachedElements)this.audioContext?(t=this.gainNode)===null||t===void 0||t.gain.setTargetAtTime(e,0,.1):i.volume=e;et()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(et())return 1;let e=0;return this.attachedElements.forEach(t=>{t.volume>e&&(e=t.volume)}),e}setSinkId(e){return k(this,void 0,void 0,function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map(t=>{if(Kr(t))return t.setSinkId(e)}))})}attach(e){const t=this.attachedElements.length===0;return e?super.attach(e):e=super.attach(),this.sinkId&&Kr(e)&&e.setSinkId(this.sinkId).catch(i=>{this.log.error("Failed to set sink id on remote audio track",i,this.logContext)}),this.audioContext&&t&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let t;return e?(t=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(t=super.detach(),this.disconnectWebAudio()),t}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(t.srcObject);let i=this.sourceNode;this.webAudioPluginNodes.forEach(r=>{i.connect(r),i=r}),this.gainNode=e.createGain(),i.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),e.state!=="running"&&e.resume().then(()=>{e.state!=="running"&&this.emit(L.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(r=>{this.emit(L.AudioPlaybackFailed,r)})}disconnectWebAudio(){var e,t;(e=this.gainNode)===null||e===void 0||e.disconnect(),(t=this.sourceNode)===null||t===void 0||t.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return k(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t;return e.forEach(i=>{i.type==="inbound-rtp"&&(t={type:"audio",streamId:i.id,timestamp:i.timestamp,jitter:i.jitter,bytesReceived:i.bytesReceived,concealedSamples:i.concealedSamples,concealmentEvents:i.concealmentEvents,silentConcealedSamples:i.silentConcealedSamples,silentConcealmentEvents:i.silentConcealmentEvents,totalAudioEnergy:i.totalAudioEnergy,totalSamplesDuration:i.totalSamplesDuration})}),t})}}const kr=100;class Pp extends wl{constructor(e,t,i,r,s){super(e,t,E.Kind.Video,i,s),this.elementInfos=[],this.monitorReceiver=()=>k(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const a=yield this.getReceiverStats();a&&this.prevStats&&this.receiver&&(this._currentBitrate=Wi(a,this.prevStats)),this.prevStats=a}),this.debouncedHandleResize=Is(()=>{this.updateDimensions()},kr),this.adaptiveStreamSettings=r}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}setStreamState(e){super.setStreamState(e),this.log.debug("setStreamState",e),this.isAdaptiveStream&&e===E.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach(t=>{e?sn(this._mediaStreamTrack,t):Xt(this._mediaStreamTrack,t)})}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(t=>t.element===e)===void 0){const t=new Rp(e);this.observeElementInfo(t)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&this.elementInfos.find(t=>t===e)===void 0?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const t=this.elementInfos.filter(i=>i===e);for(const i of t)i.stopObserving();this.elementInfos=this.elementInfos.filter(i=>i!==e),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let t=[];if(e)return this.stopObservingElement(e),super.detach(e);t=super.detach();for(const i of t)this.stopObservingElement(i);return t}getDecoderImplementation(){var e;return(e=this.prevStats)===null||e===void 0?void 0:e.decoderImplementation}getReceiverStats(){return k(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t,i="",r=new Map;return e.forEach(s=>{s.type==="inbound-rtp"?(i=s.codecId,t={type:"video",streamId:s.id,framesDecoded:s.framesDecoded,framesDropped:s.framesDropped,framesReceived:s.framesReceived,packetsReceived:s.packetsReceived,packetsLost:s.packetsLost,frameWidth:s.frameWidth,frameHeight:s.frameHeight,pliCount:s.pliCount,firCount:s.firCount,nackCount:s.nackCount,jitter:s.jitter,timestamp:s.timestamp,bytesReceived:s.bytesReceived,decoderImplementation:s.decoderImplementation}):s.type==="codec"&&r.set(s.id,s)}),t&&i!==""&&r.get(i)&&(t.mimeType=r.get(i).mimeType),t})}stopObservingElement(e){const t=this.elementInfos.filter(i=>i.element===e);for(const i of t)this.stopObservingElementInfo(i)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return k(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(e){var t,i;const r=this.elementInfos.reduce((c,l)=>Math.max(c,l.visibilityChangedAt||0),0),s=!((i=(t=this.adaptiveStreamSettings)===null||t===void 0?void 0:t.pauseVideoInBackground)!==null&&i!==void 0)||i?this.isInBackground:!1,a=this.elementInfos.some(c=>c.pictureInPicture),o=this.elementInfos.some(c=>c.visible)&&!s||a;if(!(this.lastVisible===o&&!e)){if(!o&&Date.now()-r<kr){me.setTimeout(()=>{this.updateVisibility()},kr);return}this.lastVisible=o,this.emit(L.VisibilityChanged,o,this)}}updateDimensions(){var e,t;let i=0,r=0;const s=this.getPixelDensity();for(const a of this.elementInfos){const o=a.width()*s,c=a.height()*s;o+c>i+r&&(i=o,r=c)}((e=this.lastDimensions)===null||e===void 0?void 0:e.width)===i&&((t=this.lastDimensions)===null||t===void 0?void 0:t.height)===r||(this.lastDimensions={width:i,height:r},this.emit(L.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const t=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pixelDensity;return t==="screen"?Ao():t||(Ao()>2?2:1)}}class Rp{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=i=>{var r;const{target:s,isIntersecting:a}=i;s===this.element&&(this.isIntersecting=a,this.isPiP=En(this.element),this.visibilityChangedAt=Date.now(),(r=this.handleVisibilityChanged)===null||r===void 0||r.call(this))},this.onEnterPiP=()=>{var i,r,s;(r=(i=window.documentPictureInPicture)===null||i===void 0?void 0:i.window)===null||r===void 0||r.addEventListener("pagehide",this.onLeavePiP),this.isPiP=En(this.element),(s=this.handleVisibilityChanged)===null||s===void 0||s.call(this)},this.onLeavePiP=()=>{var i;this.isPiP=En(this.element),(i=this.handleVisibilityChanged)===null||i===void 0||i.call(this)},this.element=e,this.isIntersecting=t??Yr(e),this.isPiP=Re()&&En(e),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var e,t,i;this.isIntersecting=Yr(this.element),this.isPiP=En(this.element),this.element.handleResize=()=>{var r;(r=this.handleResize)===null||r===void 0||r.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,No().observe(this.element),Lo().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),(e=window.documentPictureInPicture)===null||e===void 0||e.addEventListener("enter",this.onEnterPiP),(i=(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window)===null||i===void 0||i.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var e,t,i,r,s;(e=No())===null||e===void 0||e.unobserve(this.element),(t=Lo())===null||t===void 0||t.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),(i=window.documentPictureInPicture)===null||i===void 0||i.removeEventListener("enter",this.onEnterPiP),(s=(r=window.documentPictureInPicture)===null||r===void 0?void 0:r.window)===null||s===void 0||s.removeEventListener("pagehide",this.onLeavePiP)}}function En(n){var e,t;return document.pictureInPictureElement===n?!0:!((e=window.documentPictureInPicture)===null||e===void 0)&&e.window?Yr(n,(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window):!1}function Yr(n,e){const t=e||window;let i=n.offsetTop,r=n.offsetLeft;const s=n.offsetWidth,a=n.offsetHeight,{hidden:o}=n,{display:c}=getComputedStyle(n);for(;n.offsetParent;)n=n.offsetParent,i+=n.offsetTop,r+=n.offsetLeft;return i<t.pageYOffset+t.innerHeight&&r<t.pageXOffset+t.innerWidth&&i+a>t.pageYOffset&&r+s>t.pageXOffset&&!o&&c!=="none"}class at extends nt.EventEmitter{constructor(e,t,i,r){var s;super(),this.metadataMuted=!1,this.encryption=le.NONE,this.log=j,this.handleMuted=()=>{this.emit(L.Muted)},this.handleUnmuted=()=>{this.emit(L.Unmuted)},this.log=ht((s=r?.loggerName)!==null&&s!==void 0?s:qe.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=t,this.trackName=i,this.source=E.Source.Unknown}setTrack(e){this.track&&(this.track.off(L.Muted,this.handleMuted),this.track.off(L.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(L.Muted,this.handleMuted),e.on(L.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),W(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==le.NONE}get audioTrack(){if(Xe(this.track))return this.track}get videoTrack(){if(Mt(this.track))return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=E.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===E.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}(function(n){(function(e){e.Desired="desired",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed"})(n.SubscriptionStatus||(n.SubscriptionStatus={})),(function(e){e.Allowed="allowed",e.NotAllowed="not_allowed"})(n.PermissionStatus||(n.PermissionStatus={}))})(at||(at={}));class wi extends at{get isUpstreamPaused(){var e;return(e=this.track)===null||e===void 0?void 0:e.isUpstreamPaused}constructor(e,t,i,r){super(e,t.sid,t.name,r),this.track=void 0,this.handleTrackEnded=()=>{this.emit(L.Ended)},this.handleCpuConstrained=()=>{this.track&&Mt(this.track)&&this.emit(L.CpuConstrained,this.track)},this.updateInfo(t),this.setTrack(i)}setTrack(e){this.track&&(this.track.off(L.Ended,this.handleTrackEnded),this.track.off(L.CpuConstrained,this.handleCpuConstrained)),super.setTrack(e),e&&(e.on(L.Ended,this.handleTrackEnded),e.on(L.CpuConstrained,this.handleCpuConstrained))}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return k(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.mute()})}unmute(){return k(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.unmute()})}pauseUpstream(){return k(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.pauseUpstream()})}resumeUpstream(){return k(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.resumeUpstream()})}getTrackFeatures(){var e;if(Xe(this.track)){const t=this.track.getSourceTrackSettings(),i=new Set;return t.autoGainControl&&i.add(he.TF_AUTO_GAIN_CONTROL),t.echoCancellation&&i.add(he.TF_ECHO_CANCELLATION),t.noiseSuppression&&i.add(he.TF_NOISE_SUPPRESSION),t.channelCount&&t.channelCount>1&&i.add(he.TF_STEREO),!((e=this.options)===null||e===void 0)&&e.dtx||i.add(he.TF_NO_DTX),this.track.enhancedNoiseCancellation&&i.add(he.TF_ENHANCED_NOISE_CANCELLATION),Array.from(i.values())}else return[]}}function Hi(n,e){return k(this,void 0,void 0,function*(){n??(n={});let t=!1;const{audioProcessor:i,videoProcessor:r,optionsWithoutProcessor:s}=dl(n);let a=s.audio,o=s.video;if(i&&typeof s.audio=="object"&&(s.audio.processor=i),r&&typeof s.video=="object"&&(s.video.processor=r),n.audio&&typeof s.audio=="object"&&typeof s.audio.deviceId=="string"){const d=s.audio.deviceId;s.audio.deviceId={exact:d},t=!0,a=Object.assign(Object.assign({},s.audio),{deviceId:{ideal:d}})}if(s.video&&typeof s.video=="object"&&typeof s.video.deviceId=="string"){const d=s.video.deviceId;s.video.deviceId={exact:d},t=!0,o=Object.assign(Object.assign({},s.video),{deviceId:{ideal:d}})}s.audio===!0?s.audio={deviceId:"default"}:typeof s.audio=="object"&&s.audio!==null&&(s.audio=Object.assign(Object.assign({},s.audio),{deviceId:s.audio.deviceId||"default"})),s.video===!0?s.video={deviceId:"default"}:typeof s.video=="object"&&!s.video.deviceId&&(s.video.deviceId="default");const c=cl(s,gl,vl),l=ws(c),u=navigator.mediaDevices.getUserMedia(l);s.audio&&(fe.userMediaPromiseMap.set("audioinput",u),u.catch(()=>fe.userMediaPromiseMap.delete("audioinput"))),s.video&&(fe.userMediaPromiseMap.set("videoinput",u),u.catch(()=>fe.userMediaPromiseMap.delete("videoinput")));try{const d=yield u;return yield Promise.all(d.getTracks().map(h=>k(this,void 0,void 0,function*(){const p=h.kind==="audio";let b=p?c.audio:c.video;(typeof b=="boolean"||!b)&&(b={});let m;const T=p?l.audio:l.video;typeof T!="boolean"&&(m=T);const S=h.getSettings().deviceId;m?.deviceId&&Pt(m.deviceId)!==S?m.deviceId=S:m||(m={deviceId:S});const P=np(h,m,e);return P.kind===E.Kind.Video?P.source=E.Source.Camera:P.kind===E.Kind.Audio&&(P.source=E.Source.Microphone),P.mediaStream=d,Xe(P)&&i?yield P.setProcessor(i):Mt(P)&&r&&(yield P.setProcessor(r)),P})))}catch(d){if(!t)throw d;return Hi(Object.assign(Object.assign({},n),{audio:a,video:o}),e)}})}function _p(n){return k(this,void 0,void 0,function*(){return(yield Hi({audio:!1,video:!0}))[0]})}function Ip(n){return k(this,void 0,void 0,function*(){return(yield Hi({audio:!0,video:!1}))[0]})}var Be;(function(n){n.Excellent="excellent",n.Good="good",n.Poor="poor",n.Lost="lost",n.Unknown="unknown"})(Be||(Be={}));function xp(n){switch(n){case Rn.EXCELLENT:return Be.Excellent;case Rn.GOOD:return Be.Good;case Rn.POOR:return Be.Poor;case Rn.LOST:return Be.Lost;default:return Be.Unknown}}class Rl extends nt.EventEmitter{get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions)===null||e===void 0?void 0:e.loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(e=>e.isEncrypted)}get isAgent(){var e;return((e=this.permissions)===null||e===void 0?void 0:e.agent)||this.kind===An.AGENT}get isActive(){var e;return((e=this.participantInfo)===null||e===void 0?void 0:e.state)===en.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,t,i,r,s,a){let o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:An.STANDARD;var c;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=Be.Unknown,this.log=j,this.log=ht((c=a?.loggerName)!==null&&c!==void 0?c:qe.Participant),this.loggerOptions=a,this.setMaxListeners(100),this.sid=e,this.identity=t,this.name=i,this.metadata=r,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=o,this._attributes=s??{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,t]of this.trackPublications)if(t.source===e)return t}getTrackPublicationByName(e){for(const[,t]of this.trackPublications)if(t.trackName===e)return t}waitUntilActive(){return this.isActive?Promise.resolve():this.activeFuture?this.activeFuture.promise:(this.activeFuture=new Ae,this.once(O.Active,()=>{var e,t;(t=(e=this.activeFuture)===null||e===void 0?void 0:e.resolve)===null||t===void 0||t.call(e),this.activeFuture=void 0}),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrackPublication(E.Source.Camera);return!(!((e=t?.isMuted)!==null&&e!==void 0)||e)}get isMicrophoneEnabled(){var e;const t=this.getTrackPublication(E.Source.Microphone);return!(!((e=t?.isMuted)!==null&&e!==void 0)||e)}get isScreenShareEnabled(){return!!this.getTrackPublication(E.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(e){var t;return this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version?!1:(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),this._setAttributes(e.attributes),e.state===en.ACTIVE&&((t=this.participantInfo)===null||t===void 0?void 0:t.state)!==en.ACTIVE&&this.emit(O.Active),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,!0)}_setMetadata(e){const t=this.metadata!==e,i=this.metadata;this.metadata=e,t&&this.emit(O.ParticipantMetadataChanged,i)}_setName(e){const t=this.name!==e;this.name=e,t&&this.emit(O.ParticipantNameChanged,e)}_setAttributes(e){const t=Jh(this.attributes,e);this._attributes=e,Object.keys(t).length>0&&this.emit(O.AttributesChanged,t)}setPermissions(e){var t,i,r,s,a,o;const c=this.permissions,l=e.canPublish!==((t=this.permissions)===null||t===void 0?void 0:t.canPublish)||e.canSubscribe!==((i=this.permissions)===null||i===void 0?void 0:i.canSubscribe)||e.canPublishData!==((r=this.permissions)===null||r===void 0?void 0:r.canPublishData)||e.hidden!==((s=this.permissions)===null||s===void 0?void 0:s.hidden)||e.recorder!==((a=this.permissions)===null||a===void 0?void 0:a.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some((u,d)=>{var h;return u!==((h=this.permissions)===null||h===void 0?void 0:h.canPublishSources[d])})||e.canSubscribeMetrics!==((o=this.permissions)===null||o===void 0?void 0:o.canSubscribeMetrics);return this.permissions=e,l&&this.emit(O.ParticipantPermissionsChanged,c),l}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(O.IsSpeakingChanged,e))}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=xp(e),t!==this._connectionQuality&&this.emit(O.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var e,t;this.activeFuture&&((t=(e=this.activeFuture).reject)===null||t===void 0||t.call(e,new Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext(e){this.audioContext=e,this.audioTrackPublications.forEach(t=>Xe(t.track)&&t.track.setAudioContext(e))}addTrackPublication(e){e.on(L.Muted,()=>{this.emit(O.TrackMuted,e)}),e.on(L.Unmuted,()=>{this.emit(O.TrackUnmuted,e)});const t=e;switch(t.track&&(t.track.sid=e.trackSid),this.trackPublications.set(e.trackSid,e),e.kind){case E.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case E.Kind.Video:this.videoTrackPublications.set(e.trackSid,e);break}}}function Op(n){var e,t,i;if(!n.participantSid&&!n.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new Ec({participantIdentity:(e=n.participantIdentity)!==null&&e!==void 0?e:"",participantSid:(t=n.participantSid)!==null&&t!==void 0?t:"",allTracks:(i=n.allowAll)!==null&&i!==void 0?i:!1,trackSids:n.allowedTrackSids||[]})}class Mp extends Rl{constructor(e,t,i,r,s,a){super(e,t,void 0,void 0,void 0,{loggerName:r.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=le.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Ae)},this.handleReconnected=()=>{var o,c;(c=(o=this.reconnectFuture)===null||o===void 0?void 0:o.resolve)===null||c===void 0||c.call(o),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleClosing=()=>{var o,c,l,u,d,h;this.reconnectFuture&&(this.reconnectFuture.promise.catch(p=>this.log.warn(p.message,this.logContext)),(c=(o=this.reconnectFuture)===null||o===void 0?void 0:o.reject)===null||c===void 0||c.call(o,new Error("Got disconnected during reconnection attempt")),this.reconnectFuture=void 0),this.signalConnectedFuture&&((u=(l=this.signalConnectedFuture).reject)===null||u===void 0||u.call(l,new Error("Got disconnected without signal connected")),this.signalConnectedFuture=void 0),(h=(d=this.activeAgentFuture)===null||d===void 0?void 0:d.reject)===null||h===void 0||h.call(d,new Error("Got disconnected without active agent present")),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=o=>{var c,l;o.participant&&this.updateInfo(o.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new Ae),(l=(c=this.signalConnectedFuture).resolve)===null||l===void 0||l.call(c)},this.handleSignalRequestResponse=o=>{const{requestId:c,reason:l,message:u}=o,d=this.pendingSignalRequests.get(c);d&&(l!==Ss.OK&&d.reject(new Io(u,l)),this.pendingSignalRequests.delete(c))},this.handleDataPacket=o=>{switch(o.value.case){case"rpcResponse":let c=o.value.value,l=null,u=null;c.value.case==="payload"?l=c.value.value:c.value.case==="error"&&(u=ie.fromProto(c.value.value)),this.handleIncomingRpcResponse(c.requestId,l,u);break;case"rpcAck":let d=o.value.value;this.handleIncomingRpcAck(d.requestId);break}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(o=>Op(o)))},this.onTrackUnmuted=o=>{this.onTrackMuted(o,o.isUpstreamPaused)},this.onTrackMuted=(o,c)=>{if(c===void 0&&(c=!0),!o.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),W(o)));return}this.engine.updateMuteStatus(o.sid,c)},this.onTrackUpstreamPaused=o=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),W(o))),this.onTrackMuted(o,!0)},this.onTrackUpstreamResumed=o=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),W(o))),this.onTrackMuted(o,o.isMuted)},this.onTrackFeatureUpdate=o=>{const c=this.audioTrackPublications.get(o.sid);if(!c){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(o.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(c.trackSid,c.getTrackFeatures())},this.onTrackCpuConstrained=(o,c)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),W(c))),this.emit(O.LocalTrackCpuConstrained,o,c)},this.handleSubscribedQualityUpdate=o=>k(this,void 0,void 0,function*(){var c,l,u,d,h;if(!(!((h=this.roomOptions)===null||h===void 0)&&h.dynacast))return;const p=this.videoTrackPublications.get(o.trackSid);if(!p){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:o.trackSid}));return}if(!p.videoTrack)return;const b=yield p.videoTrack.setPublishingCodecs(o.subscribedCodecs);try{for(var m=!0,T=ut(b),S;S=yield T.next(),c=S.done,!c;m=!0){d=S.value,m=!1;const P=d;Wh(P)&&(this.log.debug("publish ".concat(P," for ").concat(p.videoTrack.sid),Object.assign(Object.assign({},this.logContext),W(p))),yield this.publishAdditionalCodecForTrack(p.videoTrack,P,p.options))}}catch(P){l={error:P}}finally{try{!m&&!c&&(u=T.return)&&(yield u.call(T))}finally{if(l)throw l.error}}}),this.handleLocalTrackUnpublished=o=>{const c=this.trackPublications.get(o.trackSid);if(!c){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:o.trackSid}));return}this.unpublishTrack(c.track)},this.handleTrackEnded=o=>k(this,void 0,void 0,function*(){if(o.source===E.Source.ScreenShare||o.source===E.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),W(o))),this.unpublishTrack(o);else if(o.isUserProvided)yield o.mute();else if(ot(o)||kt(o))try{if(Re())try{const c=yield navigator?.permissions.query({name:o.source===E.Source.Camera?"camera":"microphone"});if(c&&c.state==="denied")throw this.log.warn("user has revoked access to ".concat(o.source),Object.assign(Object.assign({},this.logContext),W(o))),c.onchange=()=>{c.state!=="denied"&&(o.isMuted||o.restartTrack(),c.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}o.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),W(o))),ot(o)?yield o.restartTrack({deviceId:"default"}):yield o.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),W(o))),yield o.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=i,this.roomOptions=r,this.setupEngine(i),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=s,this.roomOutgoingDataStreamManager=a}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==le.NONE}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setupEngine(e){var t;this.engine=e,this.engine.on(N.RemoteMute,(i,r)=>{const s=this.trackPublications.get(i);!s||!s.track||(r?s.mute():s.unmute())}),!((t=this.signalConnectedFuture)===null||t===void 0)&&t.isResolved&&(this.signalConnectedFuture=void 0),this.engine.on(N.Connected,this.handleReconnected).on(N.SignalConnected,this.handleSignalConnected).on(N.SignalRestarted,this.handleReconnected).on(N.SignalResumed,this.handleReconnected).on(N.Restarting,this.handleReconnecting).on(N.Resuming,this.handleReconnecting).on(N.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(N.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(N.Closing,this.handleClosing).on(N.SignalRequestResponse,this.handleSignalRequestResponse).on(N.DataPacketReceived,this.handleDataPacket)}setMetadata(e){return k(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:e})})}setName(e){return k(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:e})})}setAttributes(e){return k(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:e})})}requestMetadataUpdate(e){return k(this,arguments,void 0,function(t){var i=this;let{metadata:r,name:s,attributes:a}=t;return(function*(){return new Pe((o,c)=>k(i,void 0,void 0,function*(){var l,u;try{let d=!1;const h=yield this.engine.client.sendUpdateLocalMetadata((l=r??this.metadata)!==null&&l!==void 0?l:"",(u=s??this.name)!==null&&u!==void 0?u:"",a),p=performance.now();for(this.pendingSignalRequests.set(h,{resolve:o,reject:b=>{c(b),d=!0},values:{name:s,metadata:r,attributes:a}});performance.now()-p<5e3&&!d;){if((!s||this.name===s)&&(!r||this.metadata===r)&&(!a||Object.entries(a).every(b=>{let[m,T]=b;return this.attributes[m]===T||T===""&&!this.attributes[m]}))){this.pendingSignalRequests.delete(h),o();return}yield ge(50)}c(new Io("Request to update local metadata timed out","TimeoutError"))}catch(d){d instanceof Error?c(d):c(new Error(String(d)))}}))})()})}setCameraEnabled(e,t,i){return this.setTrackEnabled(E.Source.Camera,e,t,i)}setMicrophoneEnabled(e,t,i){return this.setTrackEnabled(E.Source.Microphone,e,t,i)}setScreenShareEnabled(e,t,i){return this.setTrackEnabled(E.Source.ScreenShare,e,t,i)}setE2EEEnabled(e){return k(this,void 0,void 0,function*(){this.encryptionType=e?le.GCM:le.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(e,t,i,r){return k(this,void 0,void 0,function*(){var s,a;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t})),this.republishPromise&&(yield this.republishPromise);let o=this.getTrackPublication(e);if(t)if(o)yield o.unmute();else{let c;if(this.pendingPublishing.has(e)){const l=yield this.waitForPendingPublicationOfSource(e);return l||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e})),yield l?.unmute(),l}this.pendingPublishing.add(e);try{switch(e){case E.Source.Camera:c=yield this.createTracks({video:(s=i)!==null&&s!==void 0?s:!0});break;case E.Source.Microphone:c=yield this.createTracks({audio:(a=i)!==null&&a!==void 0?a:!0});break;case E.Source.ScreenShare:c=yield this.createScreenTracks(Object.assign({},i));break;default:throw new dt(e)}}catch(l){throw c?.forEach(u=>{u.stop()}),l instanceof Error&&this.emit(O.MediaDevicesError,l,qr(e)),this.pendingPublishing.delete(e),l}for(const l of c){const u=Object.assign(Object.assign({},this.roomOptions.publishDefaults),i);e===E.Source.Microphone&&Xe(l)&&u.preConnectBuffer&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),l.startPreConnectBuffer())}try{const l=[];for(const d of c)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),W(d))),l.push(this.publishTrack(d,r));[o]=yield Promise.all(l)}catch(l){throw c?.forEach(u=>{u.stop()}),l}finally{this.pendingPublishing.delete(e)}}else if(!o?.track&&this.pendingPublishing.has(e)&&(o=yield this.waitForPendingPublicationOfSource(e),o||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e}))),o&&o.track)if(e===E.Source.ScreenShare){o=yield this.unpublishTrack(o.track);const c=this.getTrackPublication(E.Source.ScreenShareAudio);c&&c.track&&this.unpublishTrack(c.track)}else yield o.mute();return o})}enableCameraAndMicrophone(){return k(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(E.Source.Camera)||this.pendingPublishing.has(E.Source.Microphone))){this.pendingPublishing.add(E.Source.Camera),this.pendingPublishing.add(E.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map(t=>this.publishTrack(t)))}finally{this.pendingPublishing.delete(E.Source.Camera),this.pendingPublishing.delete(E.Source.Microphone)}}})}createTracks(e){return k(this,void 0,void 0,function*(){var t,i;e??(e={});const r=cl(e,(t=this.roomOptions)===null||t===void 0?void 0:t.audioCaptureDefaults,(i=this.roomOptions)===null||i===void 0?void 0:i.videoCaptureDefaults);try{return(yield Hi(r,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext})).map(o=>(Xe(o)&&(this.microphoneError=void 0,o.setAudioContext(this.audioContext),o.source=E.Source.Microphone,this.emit(O.AudioStreamAcquired)),Mt(o)&&(this.cameraError=void 0,o.source=E.Source.Camera),o))}catch(s){throw s instanceof Error&&(e.audio&&(this.microphoneError=s),e.video&&(this.cameraError=s)),s}})}createScreenTracks(e){return k(this,void 0,void 0,function*(){if(e===void 0&&(e={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new Cs("getDisplayMedia not supported");e.resolution===void 0&&!rf()&&(e.resolution=Es.h1080fps30.resolution);const t=Kh(e),i=yield navigator.mediaDevices.getDisplayMedia(t),r=i.getVideoTracks();if(r.length===0)throw new dt("no video track found");const s=new Ei(r[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});s.source=E.Source.ScreenShare,e.contentHint&&(s.mediaStreamTrack.contentHint=e.contentHint);const a=[s];if(i.getAudioTracks().length>0){this.emit(O.AudioStreamAcquired);const o=new Ci(i.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});o.source=E.Source.ScreenShareAudio,a.push(o)}return a})}publishTrack(e,t){return k(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(e,t)})}publishOrRepublishTrack(e,t){return k(this,arguments,void 0,function(i,r){var s=this;let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return(function*(){var o,c,l,u;ot(i)&&i.setAudioContext(s.audioContext),yield(o=s.reconnectFuture)===null||o===void 0?void 0:o.promise,s.republishPromise&&!a&&(yield s.republishPromise),Ft(i)&&s.pendingPublishPromises.has(i)&&(yield s.pendingPublishPromises.get(i));let d;if(i instanceof MediaStreamTrack)d=i.getConstraints();else{d=i.constraints;let S;switch(i.source){case E.Source.Microphone:S="audioinput";break;case E.Source.Camera:S="videoinput"}S&&s.activeDeviceMap.has(S)&&(d=Object.assign(Object.assign({},d),{deviceId:s.activeDeviceMap.get(S)}))}if(i instanceof MediaStreamTrack)switch(i.kind){case"audio":i=new Ci(i,d,!0,s.audioContext,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;case"video":i=new Ei(i,d,!0,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;default:throw new dt("unsupported MediaStreamTrack kind ".concat(i.kind))}else i.updateLoggerOptions({loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});let h;if(s.trackPublications.forEach(S=>{S.track&&S.track===i&&(h=S)}),h)return s.log.warn("track has already been published, skipping",Object.assign(Object.assign({},s.logContext),W(h))),h;const p=Object.assign(Object.assign({},s.roomOptions.publishDefaults),r),b="channelCount"in i.mediaStreamTrack.getSettings()&&i.mediaStreamTrack.getSettings().channelCount===2||i.mediaStreamTrack.getConstraints().channelCount===2,m=(c=p.forceStereo)!==null&&c!==void 0?c:b;m&&(p.dtx===void 0&&s.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},s.logContext),W(i))),p.red===void 0&&s.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(l=p.dtx)!==null&&l!==void 0||(p.dtx=!1),(u=p.red)!==null&&u!==void 0||(p.red=!1)),!of()&&s.roomOptions.e2ee&&(s.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},s.logContext)),p.simulcast=!1),p.source&&(i.source=p.source);const T=new Promise((S,P)=>k(s,void 0,void 0,function*(){try{if(this.engine.client.currentState!==Q.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:W(i)}));let M=!1;const v=setTimeout(()=>{M=!0,i.stop(),P(new _o("publishing rejected as engine not connected within timeout",408))},15e3);if(yield this.waitUntilEngineConnected(),clearTimeout(v),M)return;const g=yield this.publish(i,p,m);S(g)}else try{const M=yield this.publish(i,p,m);S(M)}catch(M){P(M)}}catch(M){P(M)}}));s.pendingPublishPromises.set(i,T);try{return yield T}catch(S){throw S}finally{s.pendingPublishPromises.delete(i)}})()})}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new Ae),this.signalConnectedFuture.promise}hasPermissionsToPublish(e){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),W(e))),!1;const{canPublish:t,canPublishSources:i}=this.permissions;return t&&(i.length===0||i.map(r=>$h(r)).includes(e.source))?!0:(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),W(e))),!1)}publish(e,t,i){return k(this,void 0,void 0,function*(){var r,s,a,o,c,l,u,d,h,p;if(!this.hasPermissionsToPublish(e))throw new _o("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(R=>Ft(e)&&R.source===e.source)&&e.source!==E.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),W(e))),t.stopMicTrackOnMute&&Xe(e)&&(e.stopOnMute=!0),e.source===E.Source.ScreenShare&&Vt()&&(t.simulcast=!1),t.videoCodec==="av1"&&!ef()&&(t.videoCodec=void 0),t.videoCodec==="vp9"&&!tf()&&(t.videoCodec=void 0),t.videoCodec===void 0&&(t.videoCodec=Jr),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(R=>t.videoCodec===On(R.mime))||(t.videoCodec=On(this.enabledPublishVideoCodecs[0].mime)));const m=t.videoCodec;e.on(L.Muted,this.onTrackMuted),e.on(L.Unmuted,this.onTrackUnmuted),e.on(L.Ended,this.handleTrackEnded),e.on(L.UpstreamPaused,this.onTrackUpstreamPaused),e.on(L.UpstreamResumed,this.onTrackUpstreamResumed),e.on(L.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const T=[],S=!(!((r=t.dtx)!==null&&r!==void 0)||r),P=e.getSourceTrackSettings();P.autoGainControl&&T.push(he.TF_AUTO_GAIN_CONTROL),P.echoCancellation&&T.push(he.TF_ECHO_CANCELLATION),P.noiseSuppression&&T.push(he.TF_NOISE_SUPPRESSION),P.channelCount&&P.channelCount>1&&T.push(he.TF_STEREO),S&&T.push(he.TF_NO_DTX),ot(e)&&e.hasPreConnectBuffer&&T.push(he.TF_PRECONNECT_BUFFER);const M=new Ln({cid:e.mediaStreamTrack.id,name:t.name,type:E.kindToProto(e.kind),muted:e.isMuted,source:E.sourceToProto(e.source),disableDtx:S,encryption:this.encryptionType,stereo:i,disableRed:this.isE2EEEnabled||!(!((s=t.red)!==null&&s!==void 0)||s),stream:t?.stream,backupCodecPolicy:t?.backupCodecPolicy,audioFeatures:T});let v;if(e.kind===E.Kind.Video){let R={width:0,height:0};try{R=yield e.waitForDimensions()}catch{const D=(o=(a=this.roomOptions.videoCaptureDefaults)===null||a===void 0?void 0:a.resolution)!==null&&o!==void 0?o:Un.h720.resolution;R={width:D.width,height:D.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),W(e)),{dims:R}))}M.width=R.width,M.height=R.height,kt(e)&&(je(m)&&(e.source===E.Source.ScreenShare&&(t.scalabilityMode="L1T3","contentHint"in e.mediaStreamTrack&&(e.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),W(e))))),t.scalabilityMode=(c=t.scalabilityMode)!==null&&c!==void 0?c:"L3T3_KEY"),M.simulcastCodecs=[new Or({codec:m,cid:e.mediaStreamTrack.id})],t.backupCodec===!0&&(t.backupCodec={codec:Jr}),t.backupCodec&&m!==t.backupCodec.codec&&M.encryption===le.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),M.simulcastCodecs.push(new Or({codec:t.backupCodec.codec,cid:""})))),v=Qr(e.source===E.Source.ScreenShare,M.width,M.height,t),M.layers=na(M.width,M.height,v,je(t.videoCodec))}else e.kind===E.Kind.Audio&&(v=[{maxBitrate:(l=t.audioPreset)===null||l===void 0?void 0:l.maxBitrate,priority:(d=(u=t.audioPreset)===null||u===void 0?void 0:u.priority)!==null&&d!==void 0?d:"high",networkPriority:(p=(h=t.audioPreset)===null||h===void 0?void 0:h.priority)!==null&&p!==void 0?p:"high"}]);if(!this.engine||this.engine.isClosed)throw new re("cannot publish track when not connected");const g=()=>k(this,void 0,void 0,function*(){var R,I,D;if(!this.engine.pcManager)throw new re("pcManager is not ready");if(e.sender=yield this.engine.createSender(e,t,v),this.emit(O.LocalSenderCreated,e.sender,e),kt(e)&&((R=t.degradationPreference)!==null&&R!==void 0||(t.degradationPreference=hp(e)),e.setDegradationPreference(t.degradationPreference)),v)if(Vt()&&e.kind===E.Kind.Audio){let U;for(const V of this.engine.pcManager.publisher.getTransceivers())if(V.sender===e.sender){U=V;break}U&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:U,codec:"opus",maxbr:!((I=v[0])===null||I===void 0)&&I.maxBitrate?v[0].maxBitrate/1e3:0})}else e.codec&&je(e.codec)&&(!((D=v[0])===null||D===void 0)&&D.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:M.cid,codec:e.codec,maxbr:v[0].maxBitrate/1e3});yield this.engine.negotiate()});let y;const C=new Promise((R,I)=>k(this,void 0,void 0,function*(){var D;try{y=yield this.engine.addTrack(M),R(y)}catch(U){e.sender&&(!((D=this.engine.pcManager)===null||D===void 0)&&D.publisher)&&(this.engine.pcManager.publisher.removeTrack(e.sender),yield this.engine.negotiate().catch(V=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),W(e)),{error:V}))})),I(U)}}));if(this.enabledPublishVideoCodecs.length>0)y=(yield Promise.all([C,g()]))[0];else{y=yield C;let R;if(y.codecs.forEach(I=>{R===void 0&&(R=I.mimeType)}),R&&e.kind===E.Kind.Video){const I=On(R);I!==m&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),W(e)),{codec:I})),t.videoCodec=I,v=Qr(e.source===E.Source.ScreenShare,M.width,M.height,t))}yield g()}const x=new wi(e.kind,y,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(x.on(L.CpuConstrained,R=>this.onTrackCpuConstrained(R,x)),x.options=t,e.sid=y.sid,this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:v,trackInfo:y})),kt(e)?e.startMonitor(this.engine.client):ot(e)&&e.startMonitor(),this.addTrackPublication(x),this.emit(O.LocalTrackPublished,x),ot(e)&&y.audioFeatures.includes(he.TF_PRECONNECT_BUFFER)){const R=e.getPreConnectBuffer(),I=e.getPreConnectBufferMimeType();this.on(O.LocalTrackSubscribed,D=>{if(D.trackSid===y.sid){if(!e.hasPreConnectBuffer){this.log.warn("subscribe event came to late, buffer already closed",this.logContext);return}this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),W(e))),e.stopPreConnectBuffer()}}),R&&new Promise((U,V)=>k(this,void 0,void 0,function*(){var G,Ce,$,ee,ve,Ee;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),W(e)));const Jt=setTimeout(()=>{V(new Error("agent not active within 10 seconds"))},1e4),nr=yield this.waitUntilActiveAgentPresent();clearTimeout(Jt),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),W(e)));const Gn=yield this.streamBytes({name:"preconnect-buffer",mimeType:I,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[nr.identity],attributes:{trackId:x.trackSid,sampleRate:String((ve=P.sampleRate)!==null&&ve!==void 0?ve:"48000"),channels:String((Ee=P.channelCount)!==null&&Ee!==void 0?Ee:"1")}});try{for(var At=!0,Gt=ut(R),vt;vt=yield Gt.next(),G=vt.done,!G;At=!0){ee=vt.value,At=!1;const Lt=ee;yield Gn.write(Lt)}}catch(Lt){Ce={error:Lt}}finally{try{!At&&!G&&($=Gt.return)&&(yield $.call(Gt))}finally{if(Ce)throw Ce.error}}yield Gn.close(),U()}catch(Jt){V(Jt)}})).then(()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),W(e)))}).catch(U=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),W(e)),{error:U}))})}return x})}get isLocal(){return!0}publishAdditionalCodecForTrack(e,t,i){return k(this,void 0,void 0,function*(){var r;if(this.encryptionType!==le.NONE)return;let s;if(this.trackPublications.forEach(p=>{p.track&&p.track===e&&(s=p)}),!s)throw new dt("track is not published");if(!kt(e))throw new dt("track is not a video track");const a=Object.assign(Object.assign({},(r=this.roomOptions)===null||r===void 0?void 0:r.publishDefaults),i),o=lp(e,t,a);if(!o){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),W(e)));return}const c=e.addSimulcastTrack(t,o);if(!c)return;const l=new Ln({cid:c.mediaStreamTrack.id,type:E.kindToProto(e.kind),muted:e.isMuted,source:E.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:a.videoCodec,cid:c.mediaStreamTrack.id}]});if(l.layers=na(l.width,l.height,o),!this.engine||this.engine.isClosed)throw new re("cannot publish track when not connected");const u=()=>k(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(e,c,a,o),yield this.engine.negotiate()}),h=(yield Promise.all([this.engine.addTrack(l),u()]))[0];this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:o,trackInfo:h}))})}unpublishTrack(e,t){return k(this,void 0,void 0,function*(){var i,r;if(Ft(e)){const l=this.pendingPublishPromises.get(e);l&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),W(e))),yield l)}const s=this.getPublicationForTrack(e),a=s?W(s):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),a)),!s||!s.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),a));return}e=s.track,e.off(L.Muted,this.onTrackMuted),e.off(L.Unmuted,this.onTrackUnmuted),e.off(L.Ended,this.handleTrackEnded),e.off(L.UpstreamPaused,this.onTrackUpstreamPaused),e.off(L.UpstreamResumed,this.onTrackUpstreamResumed),e.off(L.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),t===void 0&&(t=(r=(i=this.roomOptions)===null||i===void 0?void 0:i.stopLocalTrackOnUnpublish)!==null&&r!==void 0?r:!0),t?e.stop():e.stopMonitor();let o=!1;const c=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<te.FAILED&&c)try{for(const l of this.engine.pcManager.publisher.getTransceivers())l.sender===c&&(l.direction="inactive",o=!0);if(this.engine.removeTrack(c)&&(o=!0),kt(e)){for(const[,l]of e.simulcastCodecs)l.sender&&(this.engine.removeTrack(l.sender)&&(o=!0),l.sender=void 0);e.simulcastCodecs.clear()}}catch(l){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),a),{error:l}))}switch(this.trackPublications.delete(s.trackSid),s.kind){case E.Kind.Audio:this.audioTrackPublications.delete(s.trackSid);break;case E.Kind.Video:this.videoTrackPublications.delete(s.trackSid);break}return this.emit(O.LocalTrackUnpublished,s),s.setTrack(void 0),o&&(yield this.engine.negotiate()),s})}unpublishTracks(e){return k(this,void 0,void 0,function*(){return(yield Promise.all(e.map(i=>this.unpublishTrack(i)))).filter(i=>!!i)})}republishAllTracks(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){i.republishPromise&&(yield i.republishPromise),i.republishPromise=new Pe((s,a)=>k(i,void 0,void 0,function*(){try{const o=[];this.trackPublications.forEach(c=>{c.track&&(t&&(c.options=Object.assign(Object.assign({},c.options),t)),o.push(c))}),yield Promise.all(o.map(c=>k(this,void 0,void 0,function*(){const l=c.track;yield this.unpublishTrack(l,!1),r&&!l.isMuted&&l.source!==E.Source.ScreenShare&&l.source!==E.Source.ScreenShareAudio&&(ot(l)||kt(l))&&!l.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:c.trackSid})),yield l.restartTrack()),yield this.publishOrRepublishTrack(l,c.options,!0)}))),s()}catch(o){o instanceof Error?a(o):a(new Error(String(o)))}finally{this.republishPromise=void 0}})),yield i.republishPromise})()})}publishData(e){return k(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return(function*(){const s=r.reliable?q.RELIABLE:q.LOSSY,a=r.destinationIdentities,o=r.topic;let c=new hs({participantIdentity:i.identity,payload:t,destinationIdentities:a,topic:o});const l=new ye({kind:s,value:{case:"user",value:c}});yield i.engine.sendDataPacket(l,s)})()})}publishDtmf(e,t){return k(this,void 0,void 0,function*(){const i=new ye({kind:q.RELIABLE,value:{case:"sipDtmf",value:new lc({code:e,digit:t})}});yield this.engine.sendDataPacket(i,q.RELIABLE)})}sendChatMessage(e,t){return k(this,void 0,void 0,function*(){const i={id:crypto.randomUUID(),message:e,timestamp:Date.now(),attachedFiles:t?.attachments},r=new ye({value:{case:"chatMessage",value:new yi(Object.assign(Object.assign({},i),{timestamp:Z.parse(i.timestamp)}))}});return yield this.engine.sendDataPacket(r,q.RELIABLE),this.emit(O.ChatMessage,i),i})}editChatMessage(e,t){return k(this,void 0,void 0,function*(){const i=Object.assign(Object.assign({},t),{message:e,editTimestamp:Date.now()}),r=new ye({value:{case:"chatMessage",value:new yi(Object.assign(Object.assign({},i),{timestamp:Z.parse(i.timestamp),editTimestamp:Z.parse(i.editTimestamp)}))}});return yield this.engine.sendDataPacket(r,q.RELIABLE),this.emit(O.ChatMessage,i),i})}sendText(e,t){return k(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendText(e,t)})}streamText(e){return k(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamText(e)})}sendFile(e,t){return k(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendFile(e,t)})}streamBytes(e){return k(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamBytes(e)})}performRpc(e){let{destinationIdentity:t,method:i,payload:r,responseTimeout:s=15e3}=e;const a=7e3,o=a+1e3;return new Pe((c,l)=>k(this,void 0,void 0,function*(){var u,d,h,p;if(Ms(r)>yl){l(ie.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(!((d=(u=this.engine.latestJoinResponse)===null||u===void 0?void 0:u.serverInfo)===null||d===void 0)&&d.version&&We((p=(h=this.engine.latestJoinResponse)===null||h===void 0?void 0:h.serverInfo)===null||p===void 0?void 0:p.version,"1.8.0")<0){l(ie.builtIn("UNSUPPORTED_SERVER"));return}const b=Math.max(s,o),m=crypto.randomUUID();yield this.publishRpcRequest(t,m,i,r,b);const T=setTimeout(()=>{this.pendingAcks.delete(m),l(ie.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(m),clearTimeout(S)},a);this.pendingAcks.set(m,{resolve:()=>{clearTimeout(T)},participantIdentity:t});const S=setTimeout(()=>{this.pendingResponses.delete(m),l(ie.builtIn("RESPONSE_TIMEOUT"))},s);this.pendingResponses.set(m,{resolve:(P,M)=>{clearTimeout(S),this.pendingAcks.has(m)&&(this.log.warn("RPC response received before ack",m),this.pendingAcks.delete(m),clearTimeout(T)),M?l(M):c(P??"")},participantIdentity:t})}))}registerRpcMethod(e,t){this.rpcHandlers.has(e)&&this.log.warn("you're overriding the RPC handler for method ".concat(e,", in the future this will throw an error")),this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setTrackSubscriptionPermissions(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=t,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(e){const t=this.pendingAcks.get(e);t?(t.resolve(),this.pendingAcks.delete(e)):console.error("Ack received for unexpected RPC request",e)}handleIncomingRpcResponse(e,t,i){const r=this.pendingResponses.get(e);r?(r.resolve(t,i),this.pendingResponses.delete(e)):console.error("Response received for unexpected RPC request",e)}publishRpcRequest(e,t,i,r,s){return k(this,void 0,void 0,function*(){const a=new ye({destinationIdentities:[e],kind:q.RELIABLE,value:{case:"rpcRequest",value:new fs({id:t,method:i,payload:r,responseTimeoutMs:s,version:1})}});yield this.engine.sendDataPacket(a,q.RELIABLE)})}handleParticipantDisconnected(e){for(const[t,{participantIdentity:i}]of this.pendingAcks)i===e&&this.pendingAcks.delete(t);for(const[t,{participantIdentity:i,resolve:r}]of this.pendingResponses)i===e&&(r(null,ie.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(t))}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter(t=>t.mime.split("/")[0].toLowerCase()==="video")}updateInfo(e){return super.updateInfo(e)?(e.tracks.forEach(t=>{var i,r;const s=this.trackPublications.get(t.sid);if(s){const a=s.isMuted||((r=(i=s.track)===null||i===void 0?void 0:i.isUpstreamPaused)!==null&&r!==void 0?r:!1);a!==t.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),W(s)),{mutedOnServer:a})),this.engine.client.sendMuteTrack(t.sid,a))}}),!0):!1}setActiveAgent(e){var t,i,r,s;this.firstActiveAgent=e,e&&!this.firstActiveAgent&&(this.firstActiveAgent=e),e?(i=(t=this.activeAgentFuture)===null||t===void 0?void 0:t.resolve)===null||i===void 0||i.call(t,e):(s=(r=this.activeAgentFuture)===null||r===void 0?void 0:r.reject)===null||s===void 0||s.call(r,new Error("Agent disconnected")),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new Ae),this.activeAgentFuture.promise)}getPublicationForTrack(e){let t;return this.trackPublications.forEach(i=>{const r=i.track;r&&(e instanceof MediaStreamTrack?(ot(r)||kt(r))&&r.mediaStreamTrack===e&&(t=i):e===r&&(t=i))}),t}waitForPendingPublicationOfSource(e){return k(this,void 0,void 0,function*(){const i=Date.now();for(;Date.now()<i+1e4;){const r=Array.from(this.pendingPublishPromises.entries()).find(s=>{let[a]=s;return a.source===e});if(r)return r[1];yield ge(20)}})}}class Pi extends at{constructor(e,t,i,r){super(e,t.sid,t.name,r),this.track=void 0,this.allowed=!0,this.requestedDisabled=void 0,this.visible=!0,this.handleEnded=s=>{this.setTrack(void 0),this.emit(L.Ended,s)},this.handleVisibilityChange=s=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(s),this.logContext),this.visible=s,this.emitTrackUpdate()},this.handleVideoDimensionsChange=s=>{this.log.debug("adaptivestream video dimensions ".concat(s.width,"x").concat(s.height),this.logContext),this.videoDimensionsAdaptiveStream=s,this.emitTrackUpdate()},this.subscribed=i,this.updateInfo(t)}setSubscribed(e){const t=this.subscriptionStatus,i=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const r=new Bi({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new dc({participantSid:"",trackSids:[this.trackSid]})]});this.emit(L.UpdateSubscription,r),this.emitSubscriptionUpdateIfChanged(t),this.emitPermissionUpdateIfChanged(i)}get subscriptionStatus(){return this.subscribed===!1?at.SubscriptionStatus.Unsubscribed:super.isSubscribed?at.SubscriptionStatus.Subscribed:at.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?at.PermissionStatus.Allowed:at.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return this.requestedDisabled!==void 0?!this.requestedDisabled:this.isAdaptiveStream?this.visible:!0}get isLocal(){return!1}setEnabled(e){!this.isManualOperationAllowed()||this.requestedDisabled===!e||(this.requestedDisabled=!e,this.emitTrackUpdate())}setVideoQuality(e){!this.isManualOperationAllowed()||this.requestedMaxQuality===e||(this.requestedMaxQuality=e,this.requestedVideoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var t,i;this.isManualOperationAllowed()&&(((t=this.requestedVideoDimensions)===null||t===void 0?void 0:t.width)===e.width&&((i=this.requestedVideoDimensions)===null||i===void 0?void 0:i.height)===e.height||(fr(this.track)&&(this.requestedVideoDimensions=e),this.requestedMaxQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&fr(this.track)&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){var e;return(e=this.requestedMaxQuality)!==null&&e!==void 0?e:xe.HIGH}setTrack(e){const t=this.subscriptionStatus,i=this.permissionStatus,r=this.track;r!==e&&(r&&(r.off(L.VideoDimensionsChanged,this.handleVideoDimensionsChange),r.off(L.VisibilityChanged,this.handleVisibilityChange),r.off(L.Ended,this.handleEnded),r.detach(),r.stopMonitor(),this.emit(L.Unsubscribed,r)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(L.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(L.VisibilityChanged,this.handleVisibilityChange),e.on(L.Ended,this.handleEnded),this.emit(L.Subscribed,e)),this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(t))}setAllowed(e){const t=this.subscriptionStatus,i=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(L.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?L.Muted:L.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(L.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(L.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return fr(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new kc({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===E.Kind.Video){let t=this.requestedVideoDimensions;if(this.videoDimensionsAdaptiveStream!==void 0)if(t)Oo(this.videoDimensionsAdaptiveStream,t)&&(this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream);else if(this.requestedMaxQuality!==void 0&&this.trackInfo){const i=Qh(this.trackInfo,this.requestedMaxQuality);i&&Oo(this.videoDimensionsAdaptiveStream,i)&&(this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream)}else this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream;t?(e.width=Math.ceil(t.width),e.height=Math.ceil(t.height)):this.requestedMaxQuality!==void 0?(this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality})),e.quality=this.requestedMaxQuality):(this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:xe.HIGH})),e.quality=xe.HIGH)}this.emit(L.UpdateSettings,e)}}class Ri extends Rl{static fromParticipantInfo(e,t,i){return new Ri(e,t.sid,t.identity,t.name,t.metadata,t.attributes,i,t.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,t,i,r,s,a,o){let c=arguments.length>7&&arguments[7]!==void 0?arguments[7]:An.STANDARD;super(t,i||"",r,s,a,o,c),this.signalClient=e,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(L.UpdateSettings,t=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),W(e)),{settings:t})),this.signalClient.sendUpdateTrackSettings(t)}),e.on(L.UpdateSubscription,t=>{t.participantTracks.forEach(i=>{i.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(t)}),e.on(L.SubscriptionPermissionChanged,t=>{this.emit(O.TrackSubscriptionPermissionChanged,e,t)}),e.on(L.SubscriptionStatusChanged,t=>{this.emit(O.TrackSubscriptionStatusChanged,e,t)}),e.on(L.Subscribed,t=>{this.emit(O.TrackSubscribed,t,e)}),e.on(L.Unsubscribed,t=>{this.emit(O.TrackUnsubscribed,t,e)}),e.on(L.SubscriptionFailed,t=>{this.emit(O.TrackSubscriptionFailed,e.trackSid,t)})}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:E.Source.Microphone;this.volumeMap.set(t,e);const i=this.getTrackPublication(t);i&&i.track&&i.track.setVolume(e)}getVolume(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:E.Source.Microphone;const t=this.getTrackPublication(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,i,r,s,a){let o=this.getTrackPublicationBySid(t);if(o||t.startsWith("TR")||this.trackPublications.forEach(u=>{!o&&e.kind===u.kind.toString()&&(o=u)}),!o){if(a===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t})),this.emit(O.TrackSubscriptionFailed,t);return}a===void 0&&(a=20),setTimeout(()=>{this.addSubscribedMediaTrack(e,t,i,r,s,a-1)},150);return}if(e.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),W(o))),this.emit(O.TrackSubscriptionFailed,t);return}const c=e.kind==="video";let l;return c?l=new Pp(e,t,r,s):l=new Pl(e,t,r,this.audioContext,this.audioOutput),l.source=o.source,l.isMuted=o.isMuted,l.setMediaStream(i),l.start(),o.setTrack(l),this.volumeMap.has(o.source)&&zr(l)&&Xe(l)&&l.setVolume(this.volumeMap.get(o.source)),o}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const t=new Map,i=new Map;return e.tracks.forEach(r=>{var s,a;let o=this.getTrackPublicationBySid(r.sid);if(o)o.updateInfo(r);else{const c=E.kindFromProto(r.type);if(!c)return;o=new Pi(c,r,(s=this.signalClient.connectOptions)===null||s===void 0?void 0:s.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(a=this.loggerOptions)===null||a===void 0?void 0:a.loggerName}),o.updateInfo(r),i.set(r.sid,o);const l=Array.from(this.trackPublications.values()).find(u=>u.source===o?.source);l&&o.source!==E.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(o.source),Object.assign(Object.assign({},this.logContext),{oldTrack:W(l),newTrack:W(o)})),this.addTrackPublication(o)}t.set(r.sid,o)}),this.trackPublications.forEach(r=>{t.has(r.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),W(r))),this.unpublishTrack(r.trackSid,!0))}),i.forEach(r=>{this.emit(O.TrackPublished,r)}),!0}unpublishTrack(e,t){const i=this.trackPublications.get(e);if(!i)return;const{track:r}=i;switch(r&&(r.stop(),i.setTrack(void 0)),this.trackPublications.delete(e),i.kind){case E.Kind.Audio:this.audioTrackPublications.delete(e);break;case E.Kind.Video:this.videoTrackPublications.delete(e);break}t&&this.emit(O.TrackUnpublished,i)}setAudioOutput(e){return k(this,void 0,void 0,function*(){this.audioOutput=e;const t=[];this.audioTrackPublications.forEach(i=>{var r;Xe(i.track)&&zr(i.track)&&t.push(i.track.setSinkId((r=e.deviceId)!==null&&r!==void 0?r:"default"))}),yield Promise.all(t)})}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:i})),super.emit(e,...i)}}var K;(function(n){n.Disconnected="disconnected",n.Connecting="connecting",n.Connected="connected",n.Reconnecting="reconnecting",n.SignalReconnecting="signalReconnecting"})(K||(K={}));const Dp=4*1e3;class ft extends nt.EventEmitter{get hasE2EESetup(){return this.e2eeManager!==void 0}constructor(e){var t,i,r,s,a;if(super(),t=this,this.state=K.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=j,this.bufferedEvents=[],this.isResuming=!1,this.rpcHandlers=new Map,this.connect=(o,c,l)=>k(this,void 0,void 0,function*(){var u;if(!nf())throw et()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const d=yield this.disconnectLock.lock();if(this.state===K.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),d(),Promise.resolve();if(this.connectFuture)return d(),this.connectFuture.promise;this.setAndEmitConnectionState(K.Connecting),((u=this.regionUrlProvider)===null||u===void 0?void 0:u.getServerUrl().toString())!==ml(o)&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),dn(new URL(o))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new z(o,c):this.regionUrlProvider.updateToken(c),this.regionUrlProvider.fetchRegionSettings().then(b=>{var m;(m=this.regionUrlProvider)===null||m===void 0||m.setServerReportedRegions(b)}).catch(b=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:b}))}));const h=(b,m,T)=>k(this,void 0,void 0,function*(){var S,P;this.abortController&&this.abortController.abort();const M=new AbortController;this.abortController=M,d?.();try{if(yield on.getInstance().getBackOffPromise(o),M.signal.aborted)throw F.cancelled("Connection attempt aborted");yield this.attemptConnection(T??o,c,l,M),this.abortController=void 0,b()}catch(v){if(this.regionUrlProvider&&v instanceof F&&v.reason!==Y.Cancelled&&v.reason!==Y.NotAllowed){let g=null;try{this.log.debug("Fetching next region"),g=yield this.regionUrlProvider.getNextBestRegionUrl((S=this.abortController)===null||S===void 0?void 0:S.signal)}catch(y){if(y instanceof F&&(y.status===401||y.reason===Y.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),m(y);return}}[Y.InternalError,Y.ServerUnreachable,Y.Timeout].includes(v.reason)&&(this.log.debug("Adding failed connection attempt to back off"),on.getInstance().addFailedConnectionAttempt(o)),g&&!(!((P=this.abortController)===null||P===void 0)&&P.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(v.message,". Retrying with another region: ").concat(g),this.logContext),this.recreateEngine(),yield h(b,m,g)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Fo(v)),m(v))}else{let g=Ve.UNKNOWN_REASON;v instanceof F&&(g=Fo(v)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,g),m(v)}}}),p=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Ae((b,m)=>{h(b,m,p)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(o,c,l,u,d,h)=>k(this,void 0,void 0,function*(){var p,b,m;const T=yield l.join(o,c,{autoSubscribe:u.autoSubscribe,adaptiveStream:typeof d.adaptiveStream=="object"?!0:d.adaptiveStream,maxRetries:u.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:u.websocketTimeout},h.signal,!d.singlePeerConnection);let S=T.serverInfo;if(S||(S={version:T.serverVersion,region:T.serverRegion}),this.serverInfo=S,this.log.debug("connected to Livekit Server ".concat(Object.entries(S).map(P=>{let[M,v]=P;return"".concat(M,": ").concat(v)}).join(", ")),{room:(p=T.room)===null||p===void 0?void 0:p.name,roomSid:(b=T.room)===null||b===void 0?void 0:b.sid,identity:(m=T.participant)===null||m===void 0?void 0:m.identity}),!S.version)throw new Fh("unknown server version");return S.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),d.dynacast=!1),T}),this.applyJoinResponse=o=>{const c=o.participant;if(this.localParticipant.sid=c.sid,this.localParticipant.identity=c.identity,this.localParticipant.setEnabledPublishCodecs(o.enabledPublishCodecs),this.e2eeManager)try{this.e2eeManager.setSifTrailer(o.sifTrailer)}catch(l){this.log.error(l instanceof Error?l.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:l}))}this.handleParticipantUpdates([c,...o.otherParticipants]),o.room&&this.handleRoomUpdate(o.room)},this.attemptConnection=(o,c,l,u)=>k(this,void 0,void 0,function*(){var d,h;this.state===K.Reconnecting||this.isResuming||!((d=this.engine)===null||d===void 0)&&d.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((h=this.regionUrlProvider)===null||h===void 0)&&h.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},Os),l),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const p=yield this.connectSignal(o,c,this.engine,this.connOptions,this.options,u);this.applyJoinResponse(p),this.setupLocalParticipantEvents(),this.emit(_.SignalConnected)}catch(p){yield this.engine.close(),this.recreateEngine();const b=u.signal.aborted?F.cancelled("Signal connection aborted"):F.serverUnreachable("could not establish signal connection");throw p instanceof Error&&(b.message="".concat(b.message,": ").concat(p.message)),p instanceof F&&(b.reason=p.reason,b.status=p.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:p})),b}if(u.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),F.cancelled("Connection attempt aborted");try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,u)}catch(p){throw yield this.engine.close(),this.recreateEngine(),p}Re()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),Re()&&window.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(K.Connected),this.emit(_.Connected),on.getInstance().resetFailedConnectionAttempts(o),this.registerConnectionReconcile(),this.regionUrlProvider&&this.regionUrlProvider.notifyConnected()}),this.disconnect=function(){for(var o=arguments.length,c=new Array(o),l=0;l<o;l++)c[l]=arguments[l];return k(t,[...c],void 0,function(){var u=this;let d=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var h,p,b;const m=yield u.disconnectLock.lock();try{if(u.state===K.Disconnected){u.log.debug("already disconnected",u.logContext);return}if(u.log.info("disconnect from room",Object.assign({},u.logContext)),u.state===K.Connecting||u.state===K.Reconnecting||u.isResuming){const T="Abort connection attempt due to user initiated disconnect";u.log.warn(T,u.logContext),(h=u.abortController)===null||h===void 0||h.abort(T),(b=(p=u.connectFuture)===null||p===void 0?void 0:p.reject)===null||b===void 0||b.call(p,F.cancelled("Client initiated disconnect")),u.connectFuture=void 0}u.engine&&(u.engine.client.isDisconnected||(yield u.engine.client.sendLeave()),yield u.engine.close()),u.handleDisconnect(d,Ve.CLIENT_INITIATED),u.engine=void 0}finally{m()}})()})},this.onPageLeave=()=>k(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>k(this,void 0,void 0,function*(){const o=[],c=Se();if(c&&c.os==="iOS"){const l="livekit-dummy-audio-el";let u=document.getElementById(l);if(!u){u=document.createElement("audio"),u.id=l,u.autoplay=!0,u.hidden=!0;const d=hr();d.enabled=!0;const h=new MediaStream([d]);u.srcObject=h,document.addEventListener("visibilitychange",()=>{u&&(u.srcObject=document.hidden?null:h,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(u),this.once(_.Disconnected,()=>{u?.remove(),u=null})}o.push(u)}this.remoteParticipants.forEach(l=>{l.audioTrackPublications.forEach(u=>{u.track&&u.track.attachedElements.forEach(d=>{o.push(d)})})});try{yield Promise.all([this.acquireAudioContext(),...o.map(l=>(l.muted=!1,l.play()))]),this.handleAudioPlaybackStarted()}catch(l){throw this.handleAudioPlaybackFailed(l),l}}),this.startVideo=()=>k(this,void 0,void 0,function*(){const o=[];for(const c of this.remoteParticipants.values())c.videoTrackPublications.forEach(l=>{var u;(u=l.track)===null||u===void 0||u.attachedElements.forEach(d=>{o.includes(d)||o.push(d)})});yield Promise.all(o.map(c=>c.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(c=>{c.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const o of this.remoteParticipants.values())this.handleParticipantDisconnected(o.identity,o);this.setAndEmitConnectionState(K.Reconnecting)&&this.emit(_.Reconnecting)},this.handleSignalRestarted=o=>k(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(o.serverRegion),Object.assign(Object.assign({},this.logContext),{region:o.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(o);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(c){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:c}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:o.serverRegion}))}catch{return}this.setAndEmitConnectionState(K.Connected),this.emit(_.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=o=>{o.forEach(c=>{var l;if(c.identity===this.localParticipant.identity){this.localParticipant.updateInfo(c);return}c.identity===""&&(c.identity=(l=this.sidToIdentity.get(c.sid))!==null&&l!==void 0?l:"");let u=this.remoteParticipants.get(c.identity);c.state===en.DISCONNECTED?this.handleParticipantDisconnected(c.identity,u):u=this.getOrCreateParticipant(c.identity,c)})},this.handleActiveSpeakersUpdate=o=>{const c=[],l={};o.forEach(u=>{if(l[u.sid]=!0,u.sid===this.localParticipant.sid)this.localParticipant.audioLevel=u.level,this.localParticipant.setIsSpeaking(!0),c.push(this.localParticipant);else{const d=this.getRemoteParticipantBySid(u.sid);d&&(d.audioLevel=u.level,d.setIsSpeaking(!0),c.push(d))}}),l[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(u=>{l[u.sid]||(u.audioLevel=0,u.setIsSpeaking(!1))}),this.activeSpeakers=c,this.emitWhenConnected(_.ActiveSpeakersChanged,c)},this.handleSpeakersChanged=o=>{const c=new Map;this.activeSpeakers.forEach(u=>{const d=this.remoteParticipants.get(u.identity);d&&d.sid!==u.sid||c.set(u.sid,u)}),o.forEach(u=>{let d=this.getRemoteParticipantBySid(u.sid);u.sid===this.localParticipant.sid&&(d=this.localParticipant),d&&(d.audioLevel=u.level,d.setIsSpeaking(u.active),u.active?c.set(u.sid,d):c.delete(u.sid))});const l=Array.from(c.values());l.sort((u,d)=>d.audioLevel-u.audioLevel),this.activeSpeakers=l,this.emitWhenConnected(_.ActiveSpeakersChanged,l)},this.handleStreamStateUpdate=o=>{o.streamStates.forEach(c=>{const l=this.getRemoteParticipantBySid(c.participantSid);if(!l)return;const u=l.getTrackPublicationBySid(c.trackSid);if(!u||!u.track)return;const d=E.streamStateFromProto(c.state);u.track.setStreamState(d),d!==u.track.streamState&&(l.emit(O.TrackStreamStateChanged,u,u.track.streamState),this.emitWhenConnected(_.TrackStreamStateChanged,u,u.track.streamState,l))})},this.handleSubscriptionPermissionUpdate=o=>{const c=this.getRemoteParticipantBySid(o.participantSid);if(!c)return;const l=c.getTrackPublicationBySid(o.trackSid);l&&l.setAllowed(o.allowed)},this.handleSubscriptionError=o=>{const c=Array.from(this.remoteParticipants.values()).find(u=>u.trackPublications.has(o.trackSid));if(!c)return;const l=c.getTrackPublicationBySid(o.trackSid);l&&l.setSubscriptionError(o.err)},this.handleDataPacket=(o,c)=>{const l=this.remoteParticipants.get(o.participantIdentity);if(o.value.case==="user")this.handleUserPacket(l,o.value.value,o.kind,c);else if(o.value.case==="transcription")this.handleTranscription(l,o.value.value);else if(o.value.case==="sipDtmf")this.handleSipDtmf(l,o.value.value);else if(o.value.case==="chatMessage")this.handleChatMessage(l,o.value.value);else if(o.value.case==="metrics")this.handleMetrics(o.value.value,l);else if(o.value.case==="streamHeader"||o.value.case==="streamChunk"||o.value.case==="streamTrailer")this.handleDataStream(o,c);else if(o.value.case==="rpcRequest"){const u=o.value.value;this.handleIncomingRpcRequest(o.participantIdentity,u.id,u.method,u.payload,u.responseTimeoutMs,u.version)}},this.handleUserPacket=(o,c,l,u)=>{this.emit(_.DataReceived,c.payload,o,l,c.topic,u),o?.emit(O.DataReceived,c.payload,l,u)},this.handleSipDtmf=(o,c)=>{this.emit(_.SipDTMFReceived,c,o),o?.emit(O.SipDTMFReceived,c)},this.handleTranscription=(o,c)=>{const l=c.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(c.transcribedParticipantIdentity),u=l?.trackPublications.get(c.trackId),d=hf(c,this.transcriptionReceivedTimes);u?.emit(L.TranscriptionReceived,d),l?.emit(O.TranscriptionReceived,d,u),this.emit(_.TranscriptionReceived,d,l,u)},this.handleChatMessage=(o,c)=>{const l=ff(c);this.emit(_.ChatMessage,l,o)},this.handleMetrics=(o,c)=>{this.emit(_.MetricsReceived,o,c)},this.handleDataStream=(o,c)=>{this.incomingDataStreamManager.handleDataStreamPacket(o,c)},this.bufferedSegments=new Map,this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(_.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=o=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:o})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(_.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(_.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(_.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>k(this,void 0,void 0,function*(){var o;((o=Se())===null||o===void 0?void 0:o.os)!=="iOS"&&(yield this.selectDefaultDevices()),this.emit(_.MediaDevicesChanged)}),this.handleRoomUpdate=o=>{const c=this.roomInfo;this.roomInfo=o,c&&c.metadata!==o.metadata&&this.emitWhenConnected(_.RoomMetadataChanged,o.metadata),c?.activeRecording!==o.activeRecording&&this.emitWhenConnected(_.RecordingStatusChanged,o.activeRecording)},this.handleConnectionQualityUpdate=o=>{o.updates.forEach(c=>{if(c.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(c.quality);return}const l=this.getRemoteParticipantBySid(c.participantSid);l&&l.setConnectionQuality(c.quality)})},this.onLocalParticipantMetadataChanged=o=>{this.emit(_.ParticipantMetadataChanged,o,this.localParticipant)},this.onLocalParticipantNameChanged=o=>{this.emit(_.ParticipantNameChanged,o,this.localParticipant)},this.onLocalAttributesChanged=o=>{this.emit(_.ParticipantAttributesChanged,o,this.localParticipant)},this.onLocalTrackMuted=o=>{this.emit(_.TrackMuted,o,this.localParticipant)},this.onLocalTrackUnmuted=o=>{this.emit(_.TrackUnmuted,o,this.localParticipant)},this.onTrackProcessorUpdate=o=>{var c;(c=o?.onPublish)===null||c===void 0||c.call(o,this)},this.onLocalTrackPublished=o=>k(this,void 0,void 0,function*(){var c,l,u,d,h,p;(c=o.track)===null||c===void 0||c.on(L.TrackProcessorUpdate,this.onTrackProcessorUpdate),(l=o.track)===null||l===void 0||l.on(L.Restarted,this.onLocalTrackRestarted),(h=(d=(u=o.track)===null||u===void 0?void 0:u.getProcessor())===null||d===void 0?void 0:d.onPublish)===null||h===void 0||h.call(d,this),this.emit(_.LocalTrackPublished,o,this.localParticipant),ot(o.track)&&(yield o.track.checkForSilence())&&this.emit(_.LocalAudioSilenceDetected,o);const b=yield(p=o.track)===null||p===void 0?void 0:p.getDeviceId(!1),m=qr(o.source);m&&b&&b!==this.localParticipant.activeDeviceMap.get(m)&&(this.localParticipant.activeDeviceMap.set(m,b),this.emit(_.ActiveDeviceChanged,m,b))}),this.onLocalTrackUnpublished=o=>{var c,l;(c=o.track)===null||c===void 0||c.off(L.TrackProcessorUpdate,this.onTrackProcessorUpdate),(l=o.track)===null||l===void 0||l.off(L.Restarted,this.onLocalTrackRestarted),this.emit(_.LocalTrackUnpublished,o,this.localParticipant)},this.onLocalTrackRestarted=o=>k(this,void 0,void 0,function*(){const c=yield o.getDeviceId(!1),l=qr(o.source);l&&c&&c!==this.localParticipant.activeDeviceMap.get(l)&&(this.log.debug("local track restarted, setting ".concat(l," ").concat(c," active"),this.logContext),this.localParticipant.activeDeviceMap.set(l,c),this.emit(_.ActiveDeviceChanged,l,c))}),this.onLocalConnectionQualityChanged=o=>{this.emit(_.ConnectionQualityChanged,o,this.localParticipant)},this.onMediaDevicesError=(o,c)=>{this.emit(_.MediaDevicesError,o,c)},this.onLocalParticipantPermissionsChanged=o=>{this.emit(_.ParticipantPermissionsChanged,o,this.localParticipant)},this.onLocalChatMessageSent=o=>{this.emit(_.ChatMessage,o,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},zf),e),this.log=ht((i=this.options.loggerName)!==null&&i!==void 0?i:qe.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},gl),e?.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},vl),e?.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},Kf),e?.publishDefaults),this.maybeCreateEngine(),this.incomingDataStreamManager=new Tp,this.outgoingDataStreamManager=new wp(this.engine,this.log),this.disconnectLock=new ke,this.localParticipant=new Mp("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager),(this.options.e2ee||this.options.encryption)&&this.setupE2EE(),this.engine.e2eeManager=this.e2eeManager,this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",Pt(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",Pt(this.options.audioCaptureDefaults.deviceId)),!((r=this.options.audioOutput)===null||r===void 0)&&r.deviceId&&this.switchActiveDevice("audiooutput",Pt(this.options.audioOutput.deviceId)).catch(o=>this.log.warn("Could not set audio output: ".concat(o.message),this.logContext)),Re()){const o=new AbortController;(a=(s=navigator.mediaDevices)===null||s===void 0?void 0:s.addEventListener)===null||a===void 0||a.call(s,"devicechange",this.handleDeviceChange,{signal:o.signal}),ft.cleanupRegistry&&ft.cleanupRegistry.register(this,()=>{o.abort()})}}registerTextStreamHandler(e,t){return this.incomingDataStreamManager.registerTextStreamHandler(e,t)}unregisterTextStreamHandler(e){return this.incomingDataStreamManager.unregisterTextStreamHandler(e)}registerByteStreamHandler(e,t){return this.incomingDataStreamManager.registerByteStreamHandler(e,t)}unregisterByteStreamHandler(e){return this.incomingDataStreamManager.unregisterByteStreamHandler(e)}registerRpcMethod(e,t){if(this.rpcHandlers.has(e))throw Error("RPC handler already registered for method ".concat(e,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setE2EEEnabled(e){return k(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var e;const t=!!this.options.encryption,i=this.options.encryption||this.options.e2ee;i&&("e2eeManager"in i?(this.e2eeManager=i.e2eeManager,this.e2eeManager.isDataChannelEncryptionEnabled=t):this.e2eeManager=new _f(i,t),this.e2eeManager.on(Ct.ParticipantEncryptionStatusChanged,(r,s)=>{mf(s)&&(this.isE2EEEnabled=r),this.emit(_.ParticipantEncryptionStatusChanged,r,s)}),this.e2eeManager.on(Ct.EncryptionError,(r,s)=>{const a=s?this.getParticipantByIdentity(s):void 0;this.emit(_.EncryptionError,r,a)}),(e=this.e2eeManager)===null||e===void 0||e.setup(this))}get logContext(){var e;return{room:this.name,roomID:(e=this.roomInfo)===null||e===void 0?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.activeRecording)!==null&&t!==void 0?t:!1}getSid(){return this.state===K.Disconnected?Pe.resolve(""):this.roomInfo&&this.roomInfo.sid!==""?Pe.resolve(this.roomInfo.sid):new Pe((e,t)=>{const i=r=>{r.sid!==""&&(this.engine.off(N.RoomUpdate,i),e(r.sid))};this.engine.on(N.RoomUpdate,i),this.once(_.Disconnected,()=>{this.engine.off(N.RoomUpdate,i),t(new re("Room disconnected before room server id was available"))})})}get name(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.name)!==null&&t!==void 0?t:""}get metadata(){var e;return(e=this.roomInfo)===null||e===void 0?void 0:e.metadata}get numParticipants(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numParticipants)!==null&&t!==void 0?t:0}get numPublishers(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numPublishers)!==null&&t!==void 0?t:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new bp(this.options),this.engine.e2eeManager=this.e2eeManager,this.engine.on(N.ParticipantUpdate,this.handleParticipantUpdates).on(N.RoomUpdate,this.handleRoomUpdate).on(N.SpeakersChanged,this.handleSpeakersChanged).on(N.StreamStateChanged,this.handleStreamStateUpdate).on(N.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(N.SubscriptionError,this.handleSubscriptionError).on(N.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(N.MediaTrackAdded,(e,t,i)=>{this.onTrackAdded(e,t,i)}).on(N.Disconnected,e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)}).on(N.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(N.DataPacketReceived,this.handleDataPacket).on(N.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(K.SignalReconnecting)&&this.emit(_.SignalReconnecting)}).on(N.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(K.Connected)&&this.emit(_.Reconnected)}).on(N.SignalResumed,()=>{this.bufferedEvents=[],(this.state===K.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(N.Restarting,this.handleRestarting).on(N.SignalRestarted,this.handleSignalRestarted).on(N.Offline,()=>{this.setAndEmitConnectionState(K.Reconnecting)&&this.emit(_.Reconnecting)}).on(N.DCBufferStatusChanged,(e,t)=>{this.emit(_.DCBufferStatusChanged,e,t)}).on(N.LocalTrackSubscribed,e=>{const t=this.localParticipant.getTrackPublications().find(i=>{let{trackSid:r}=i;return r===e});if(!t){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(O.LocalTrackSubscribed,t),this.emitWhenConnected(_.LocalTrackSubscribed,t,this.localParticipant)}).on(N.RoomMoved,e=>{this.log.debug("room moved",e),e.room&&this.handleRoomUpdate(e.room),this.remoteParticipants.forEach((t,i)=>{this.handleParticipantDisconnected(i,t)}),this.emit(_.Moved,e.room.name),e.participant?this.handleParticipantUpdates([e.participant,...e.otherParticipants]):this.handleParticipantUpdates(e.otherParticipants)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine),this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine))}static getLocalDevices(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return fe.getInstance().getDevices(e,t)}prepareConnection(e,t){return k(this,void 0,void 0,function*(){if(this.state===K.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(dn(new URL(e))&&t){this.regionUrlProvider=new z(e,t);const i=yield this.regionUrlProvider.getNextBestRegionUrl();i&&this.state===K.Disconnected&&(this.regionUrl=i,yield fetch(jn(i),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(i),this.logContext))}else yield fetch(jn(e),{method:"HEAD"})}catch(i){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:i}))}}})}getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return k(this,void 0,void 0,function*(){let i=()=>k(this,void 0,void 0,function*(){}),r;switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":r=new Qe({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":r=new Qe({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":r=new Qe({scenario:{case:"serverLeave",value:!0}});break;case"migration":r=new Qe({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>k(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new Qe({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":i=()=>k(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new Qe({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":r=new Qe({scenario:{case:"switchCandidateProtocol",value:e==="force-tls"?2:1}}),i=()=>k(this,void 0,void 0,function*(){const s=this.engine.client.onLeave;s&&s(new Vi({reason:Ve.CLIENT_INITIATED,action:tn.RECONNECT}))});break;case"subscriber-bandwidth":if(t===void 0||typeof t!="number")throw new Error("subscriber-bandwidth requires a number as argument");r=new Qe({scenario:{case:"subscriberBandwidth",value:Ut(t)}});break;case"leave-full-reconnect":r=new Qe({scenario:{case:"leaveRequestFullReconnect",value:!0}})}r&&(yield this.engine.client.sendSimulateScenario(r),yield i())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,t){return k(this,arguments,void 0,function(i,r){var s=this;let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return(function*(){var o,c,l,u,d,h,p;let b=!0,m=!1;const T=a?{exact:r}:r;if(i==="audioinput"){m=s.localParticipant.audioTrackPublications.size===0;const S=(o=s.getActiveDevice(i))!==null&&o!==void 0?o:s.options.audioCaptureDefaults.deviceId;s.options.audioCaptureDefaults.deviceId=T;const P=Array.from(s.localParticipant.audioTrackPublications.values()).filter(v=>v.source===E.Source.Microphone);try{b=(yield Promise.all(P.map(v=>{var g;return(g=v.audioTrack)===null||g===void 0?void 0:g.setDeviceId(T)}))).every(v=>v===!0)}catch(v){throw s.options.audioCaptureDefaults.deviceId=S,v}const M=P.some(v=>{var g,y;return(y=(g=v.track)===null||g===void 0?void 0:g.isMuted)!==null&&y!==void 0?y:!1});b&&M&&(m=!0)}else if(i==="videoinput"){m=s.localParticipant.videoTrackPublications.size===0;const S=(c=s.getActiveDevice(i))!==null&&c!==void 0?c:s.options.videoCaptureDefaults.deviceId;s.options.videoCaptureDefaults.deviceId=T;const P=Array.from(s.localParticipant.videoTrackPublications.values()).filter(v=>v.source===E.Source.Camera);try{b=(yield Promise.all(P.map(v=>{var g;return(g=v.videoTrack)===null||g===void 0?void 0:g.setDeviceId(T)}))).every(v=>v===!0)}catch(v){throw s.options.videoCaptureDefaults.deviceId=S,v}const M=P.some(v=>{var g,y;return(y=(g=v.track)===null||g===void 0?void 0:g.isMuted)!==null&&y!==void 0?y:!1});b&&M&&(m=!0)}else if(i==="audiooutput"){if(m=!0,!Kr()&&!s.options.webAudioMix||s.options.webAudioMix&&s.audioContext&&!("setSinkId"in s.audioContext))throw new Error("cannot switch audio output, the current browser does not support it");s.options.webAudioMix&&(r=(l=yield fe.getInstance().normalizeDeviceId("audiooutput",r))!==null&&l!==void 0?l:""),(u=(p=s.options).audioOutput)!==null&&u!==void 0||(p.audioOutput={});const S=(d=s.getActiveDevice(i))!==null&&d!==void 0?d:s.options.audioOutput.deviceId;s.options.audioOutput.deviceId=r;try{s.options.webAudioMix&&((h=s.audioContext)===null||h===void 0||h.setSinkId(r)),yield Promise.all(Array.from(s.remoteParticipants.values()).map(P=>P.setAudioOutput({deviceId:r})))}catch(P){throw s.options.audioOutput.deviceId=S,P}}return m&&(s.localParticipant.activeDeviceMap.set(i,r),s.emit(_.ActiveDeviceChanged,i,r)),b})()})}setupLocalParticipantEvents(){this.localParticipant.on(O.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(O.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(O.AttributesChanged,this.onLocalAttributesChanged).on(O.TrackMuted,this.onLocalTrackMuted).on(O.TrackUnmuted,this.onLocalTrackUnmuted).on(O.LocalTrackPublished,this.onLocalTrackPublished).on(O.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(O.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(O.MediaDevicesError,this.onMediaDevicesError).on(O.AudioStreamAcquired,this.startAudio).on(O.ChatMessage,this.onLocalChatMessageSent).on(O.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;(e=this.engine)===null||e===void 0||e.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,t,i){if(this.state===K.Connecting||this.state===K.Reconnecting){const d=()=>{this.log.debug("deferring on track for later",{mediaTrackId:e.id,mediaStreamId:t.id,tracksInStream:t.getTracks().map(p=>p.id)}),this.onTrackAdded(e,t,i),h()},h=()=>{this.off(_.Reconnected,d),this.off(_.Connected,d),this.off(_.Disconnected,h)};this.once(_.Reconnected,d),this.once(_.Connected,d),this.once(_.Disconnected,h);return}if(this.state===K.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}if(e.readyState==="ended"){this.log.info("skipping incoming track as it already ended",this.logContext);return}const r=Zh(t.id),s=r[0];let a=r[1],o=e.id;if(a&&a.startsWith("TR")&&(o=a),s===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const c=Array.from(this.remoteParticipants.values()).find(d=>d.sid===s);if(!c){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(s),this.logContext);return}if(!o.startsWith("TR")){const d=this.engine.getTrackIdForReceiver(i);if(!d){this.log.error("Tried to add a track whose 'sid' could not be found for a participant, that's not present. Sid: ".concat(s),this.logContext);return}o=d}o.startsWith("TR")||this.log.warn("Tried to add a track whose 'sid' could not be determined for a participant, that's not present. Sid: ".concat(s,", streamId: ").concat(a,", trackId: ").concat(o),Object.assign(Object.assign({},this.logContext),{rpID:s,streamId:a,trackId:o}));let l;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?l=this.options.adaptiveStream:l={});const u=c.addSubscribedMediaTrack(e,o,t,i,l);u?.isEncrypted&&!this.e2eeManager&&this.emit(_.EncryptionError,new Error("Encrypted ".concat(u.source," track received from participant ").concat(c.sid,", but room does not have encryption enabled!")))}handleDisconnect(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=arguments.length>1?arguments[1]:void 0;var i,r;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.incomingDataStreamManager.clearControllers(),this.state!==K.Disconnected){this.regionUrl=void 0,this.regionUrlProvider&&this.regionUrlProvider.notifyDisconnected();try{this.remoteParticipants.forEach(s=>{s.trackPublications.forEach(a=>{s.unpublishTrack(a.trackSid)})}),this.localParticipant.trackPublications.forEach(s=>{var a,o,c;s.track&&this.localParticipant.unpublishTrack(s.track,e),e?((a=s.track)===null||a===void 0||a.detach(),(o=s.track)===null||o===void 0||o.stop()):(c=s.track)===null||c===void 0||c.stopMonitor()}),this.localParticipant.off(O.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(O.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(O.AttributesChanged,this.onLocalAttributesChanged).off(O.TrackMuted,this.onLocalTrackMuted).off(O.TrackUnmuted,this.onLocalTrackUnmuted).off(O.LocalTrackPublished,this.onLocalTrackPublished).off(O.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(O.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(O.MediaDevicesError,this.onMediaDevicesError).off(O.AudioStreamAcquired,this.startAudio).off(O.ChatMessage,this.onLocalChatMessageSent).off(O.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),Re()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(r=(i=navigator.mediaDevices)===null||i===void 0?void 0:i.removeEventListener)===null||r===void 0||r.call(i,"devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(K.Disconnected),this.emit(_.Disconnected,t)}}}handleParticipantDisconnected(e,t){var i;this.remoteParticipants.delete(e),t&&(this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams(e),t.trackPublications.forEach(r=>{t.unpublishTrack(r.trackSid,!0)}),this.emit(_.ParticipantDisconnected,t),t.setDisconnected(),(i=this.localParticipant)===null||i===void 0||i.handleParticipantDisconnected(t.identity))}handleIncomingRpcRequest(e,t,i,r,s,a){return k(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck(e,t),a!==1){yield this.engine.publishRpcResponse(e,t,null,ie.builtIn("UNSUPPORTED_VERSION"));return}const o=this.rpcHandlers.get(i);if(!o){yield this.engine.publishRpcResponse(e,t,null,ie.builtIn("UNSUPPORTED_METHOD"));return}let c=null,l=null;try{const u=yield o({requestId:t,callerIdentity:e,payload:r,responseTimeout:s});Ms(u)>yl?(c=ie.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),this.log.warn("RPC Response payload too large for ".concat(i))):l=u}catch(u){u instanceof ie?c=u:(this.log.warn("Uncaught error returned by RPC handler for ".concat(i,". Returning APPLICATION_ERROR instead."),u),c=ie.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse(e,t,l,c)})}selectDefaultDevices(){return k(this,void 0,void 0,function*(){var e,t,i;const r=fe.getInstance().previousDevices,s=yield fe.getInstance().getDevices(void 0,!1),a=Se();if(a?.name==="Chrome"&&a.os!=="iOS")for(let c of s){const l=r.find(u=>u.deviceId===c.deviceId);l&&l.label!==""&&l.kind===c.kind&&l.label!==c.label&&this.getActiveDevice(c.kind)==="default"&&this.emit(_.ActiveDeviceChanged,c.kind,c.deviceId)}const o=["audiooutput","audioinput","videoinput"];for(let c of o){const l=Hh(c),u=this.localParticipant.getTrackPublication(l);if(u&&(!((e=u.track)===null||e===void 0)&&e.isUserProvided))continue;const d=s.filter(p=>p.kind===c),h=this.getActiveDevice(c);if(h===((t=r.filter(p=>p.kind===c)[0])===null||t===void 0?void 0:t.deviceId)&&d.length>0&&((i=d[0])===null||i===void 0?void 0:i.deviceId)!==h){yield this.switchActiveDevice(c,d[0].deviceId);continue}c==="audioinput"&&!Fn()||c==="videoinput"||d.length>0&&!d.find(p=>p.deviceId===this.getActiveDevice(c))&&(c!=="audiooutput"||!Fn())&&(yield this.switchActiveDevice(c,d[0].deviceId))}})}acquireAudioContext(){return k(this,void 0,void 0,function*(){var e,t;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=(e=ul())!==null&&e!==void 0?e:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(r=>r.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&this.audioContext.state==="suspended")try{yield Promise.race([this.audioContext.resume(),ge(200)])}catch(r){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:r}))}const i=((t=this.audioContext)===null||t===void 0?void 0:t.state)==="running";i!==this.canPlaybackAudio&&(this.audioEnabled=i,this.emit(_.AudioPlaybackStatusChanged,i))})}createParticipant(e,t){var i;let r;return t?r=Ri.fromParticipantInfo(this.engine.client,t,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):r=new Ri(this.engine.client,"",e,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&r.setAudioContext(this.audioContext),!((i=this.options.audioOutput)===null||i===void 0)&&i.deviceId&&r.setAudioOutput(this.options.audioOutput).catch(s=>this.log.warn("Could not set audio output: ".concat(s.message),this.logContext)),r}getOrCreateParticipant(e,t){if(this.remoteParticipants.has(e)){const r=this.remoteParticipants.get(e);return t&&r.updateInfo(t)&&this.sidToIdentity.set(t.sid,t.identity),r}const i=this.createParticipant(e,t);return this.remoteParticipants.set(e,i),this.sidToIdentity.set(t.sid,t.identity),this.emitWhenConnected(_.ParticipantConnected,i),i.on(O.TrackPublished,r=>{this.emitWhenConnected(_.TrackPublished,r,i)}).on(O.TrackSubscribed,(r,s)=>{r.kind===E.Kind.Audio?(r.on(L.AudioPlaybackStarted,this.handleAudioPlaybackStarted),r.on(L.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):r.kind===E.Kind.Video&&(r.on(L.VideoPlaybackFailed,this.handleVideoPlaybackFailed),r.on(L.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(_.TrackSubscribed,r,s,i)}).on(O.TrackUnpublished,r=>{this.emit(_.TrackUnpublished,r,i)}).on(O.TrackUnsubscribed,(r,s)=>{this.emit(_.TrackUnsubscribed,r,s,i)}).on(O.TrackMuted,r=>{this.emitWhenConnected(_.TrackMuted,r,i)}).on(O.TrackUnmuted,r=>{this.emitWhenConnected(_.TrackUnmuted,r,i)}).on(O.ParticipantMetadataChanged,r=>{this.emitWhenConnected(_.ParticipantMetadataChanged,r,i)}).on(O.ParticipantNameChanged,r=>{this.emitWhenConnected(_.ParticipantNameChanged,r,i)}).on(O.AttributesChanged,r=>{this.emitWhenConnected(_.ParticipantAttributesChanged,r,i)}).on(O.ConnectionQualityChanged,r=>{this.emitWhenConnected(_.ConnectionQualityChanged,r,i)}).on(O.ParticipantPermissionsChanged,r=>{this.emitWhenConnected(_.ParticipantPermissionsChanged,r,i)}).on(O.TrackSubscriptionStatusChanged,(r,s)=>{this.emitWhenConnected(_.TrackSubscriptionStatusChanged,r,s,i)}).on(O.TrackSubscriptionFailed,(r,s)=>{this.emit(_.TrackSubscriptionFailed,r,i,s)}).on(O.TrackSubscriptionPermissionChanged,(r,s)=>{this.emitWhenConnected(_.TrackSubscriptionPermissionChanged,r,s,i)}).on(O.Active,()=>{this.emitWhenConnected(_.ParticipantActive,i),i.kind===An.AGENT&&this.localParticipant.setActiveAgent(i)}),t&&i.updateInfo(t),i}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce((i,r)=>(i.push(...r.getTrackPublications()),i),[]),t=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const t of e.videoTrackPublications.values())t.isSubscribed&&pf(t)&&t.emitTrackUpdate()}getRemoteParticipantBySid(e){const t=this.sidToIdentity.get(e);if(t)return this.remoteParticipants.get(t)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=me.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Ve.STATE_MISMATCH))):e=0},Dp)}clearConnectionReconcile(){this.connectionReconcileInterval&&me.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e===this.state?!1:(this.state=e,this.emit(_.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(e=>{let[t,i]=e;this.emit(t,...i)}),this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(this.state===K.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,i]);else if(this.state===K.Connected)return this.emit(e,...i);return!1}simulateParticipants(e){return k(this,void 0,void 0,function*(){var t,i,r,s;const a=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),o=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new Ui({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:Z.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new Bt({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(_.SignalConnected),this.emit(_.Connected),this.setAndEmitConnectionState(K.Connected),a.video){const c=new wi(E.Kind.Video,new Yt({source:oe.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:Ue.AUDIO,name:"video-dummy"}),new Ei(a.useRealTracks&&(!((t=window.navigator.mediaDevices)===null||t===void 0)&&t.getUserMedia)?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:Uo(160*((i=o.aspectRatios[0])!==null&&i!==void 0?i:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(c),this.localParticipant.emit(O.LocalTrackPublished,c)}if(a.audio){const c=new wi(E.Kind.Audio,new Yt({source:oe.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:Ue.AUDIO}),new Ci(a.useRealTracks&&(!((r=navigator.mediaDevices)===null||r===void 0)&&r.getUserMedia)?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:hr(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(c),this.localParticipant.emit(O.LocalTrackPublished,c)}for(let c=0;c<o.count-1;c+=1){let l=new Bt({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(c),state:en.ACTIVE,tracks:[],joinedAt:Z.parse(Date.now())});const u=this.getOrCreateParticipant(l.identity,l);if(o.video){const d=Uo(160*((s=o.aspectRatios[c%o.aspectRatios.length])!==null&&s!==void 0?s:1),160,!1,!0),h=new Yt({source:oe.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:Ue.AUDIO});u.addSubscribedMediaTrack(d,h.sid,new MediaStream([d]),new RTCRtpReceiver),l.tracks=[...l.tracks,h]}if(o.audio){const d=hr(),h=new Yt({source:oe.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:Ue.AUDIO});u.addSubscribedMediaTrack(d,h.sid,new MediaStream([d]),new RTCRtpReceiver),l.tracks=[...l.tracks,h]}u.updateInfo(l)}})}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(e!==_.ActiveSpeakersChanged&&e!==_.TranscriptionReceived){const s=_l(i).filter(a=>a!==void 0);(e===_.TrackSubscribed||e===_.TrackUnsubscribed)&&this.log.trace("subscribe trace: ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:s})),this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:s}))}return super.emit(e,...i)}}ft.cleanupRegistry=typeof FinalizationRegistry<"u"&&new FinalizationRegistry(n=>{n()});function _l(n){return n.map(e=>{if(e)return Array.isArray(e)?_l(e):typeof e=="object"?"logContext"in e?e.logContext:void 0:e})}var Ne;(function(n){n[n.IDLE=0]="IDLE",n[n.RUNNING=1]="RUNNING",n[n.SKIPPED=2]="SKIPPED",n[n.SUCCESS=3]="SUCCESS",n[n.FAILED=4]="FAILED"})(Ne||(Ne={}));class Dt extends nt.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=Ne.IDLE,this.logs=[],this.options={},this.url=e,this.token=t,this.name=this.constructor.name,this.room=new ft(i.roomOptions),this.connectOptions=i.connectOptions,this.options=i}run(e){return k(this,void 0,void 0,function*(){if(this.status!==Ne.IDLE)throw Error("check is running already");this.setStatus(Ne.RUNNING);try{yield this.perform()}catch(t){t instanceof Error&&(this.options.errorsAsWarnings?this.appendWarning(t.message):this.appendError(t.message))}return yield this.disconnect(),yield new Promise(t=>setTimeout(t,500)),this.status!==Ne.SKIPPED&&this.setStatus(this.isSuccess()?Ne.SUCCESS:Ne.FAILED),e&&e(),this.getInfo()})}isSuccess(){return!this.logs.some(e=>e.level==="error")}connect(e){return k(this,void 0,void 0,function*(){return this.room.state===K.Connected?this.room:(e||(e=this.url),yield this.room.connect(e,this.token,this.connectOptions),this.room)})}disconnect(){return k(this,void 0,void 0,function*(){this.room&&this.room.state!==K.Disconnected&&(yield this.room.disconnect(),yield new Promise(e=>setTimeout(e,500)))})}skip(){this.setStatus(Ne.SKIPPED)}switchProtocol(e){return k(this,void 0,void 0,function*(){let t=!1,i=!1;if(this.room.on(_.Reconnecting,()=>{t=!0}),this.room.once(_.Reconnected,()=>{i=!0}),this.room.simulateScenario("force-".concat(e)),yield new Promise(s=>setTimeout(s,1e3)),!t)return;const r=Date.now()+1e4;for(;Date.now()<r;){if(i)return;yield ge(100)}throw new Error("Could not reconnect using ".concat(e," protocol after 10 seconds"))})}appendMessage(e){this.logs.push({level:"info",message:e}),this.emit("update",this.getInfo())}appendWarning(e){this.logs.push({level:"warning",message:e}),this.emit("update",this.getInfo())}appendError(e){this.logs.push({level:"error",message:e}),this.emit("update",this.getInfo())}setStatus(e){this.status=e,this.emit("update",this.getInfo())}get engine(){var e;return(e=this.room)===null||e===void 0?void 0:e.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}class Ap extends Dt{get description(){return"Cloud regions"}perform(){return k(this,void 0,void 0,function*(){const e=new z(this.url,this.token);if(!e.isCloud()){this.skip();return}const t=[],i=new Set;for(let s=0;s<3;s++){const a=yield e.getNextBestRegionUrl();if(!a)break;if(i.has(a))continue;i.add(a);const o=yield this.checkCloudRegion(a);this.appendMessage("".concat(o.region," RTT: ").concat(o.rtt,"ms, duration: ").concat(o.duration,"ms")),t.push(o)}t.sort((s,a)=>(s.duration-a.duration)*.5+(s.rtt-a.rtt)*.5);const r=t[0];this.bestStats=r,this.appendMessage("best Cloud region: ".concat(r.region))})}getInfo(){const e=super.getInfo();return e.data=this.bestStats,e}checkCloudRegion(e){return k(this,void 0,void 0,function*(){var t,i;yield this.connect(e),this.options.protocol==="tcp"&&(yield this.switchProtocol("tcp"));const r=(t=this.room.serverInfo)===null||t===void 0?void 0:t.region;if(!r)throw new Error("Region not found");const s=yield this.room.localParticipant.streamText({topic:"test"}),a=1e3,c=1e6/a,l="A".repeat(a),u=Date.now();for(let b=0;b<c;b++)yield s.write(l);yield s.close();const d=Date.now(),h=yield(i=this.room.engine.pcManager)===null||i===void 0?void 0:i.publisher.getStats(),p={region:r,rtt:1e4,duration:d-u};return h?.forEach(b=>{b.type==="candidate-pair"&&b.nominated&&(p.rtt=b.currentRoundTripTime*1e3)}),yield this.disconnect(),p})}}const Sr=1e4;class Lp extends Dt{get description(){return"Connection via UDP vs TCP"}perform(){return k(this,void 0,void 0,function*(){const e=yield this.checkConnectionProtocol("udp"),t=yield this.checkConnectionProtocol("tcp");this.bestStats=e,e.qualityLimitationDurations.bandwidth-t.qualityLimitationDurations.bandwidth>.5||(e.packetsLost-t.packetsLost)/e.packetsSent>.01?(this.appendMessage("best connection quality via tcp"),this.bestStats=t):this.appendMessage("best connection quality via udp");const i=this.bestStats;this.appendMessage("upstream bitrate: ".concat((i.bitrateTotal/i.count/1e3/1e3).toFixed(2)," mbps")),this.appendMessage("RTT: ".concat((i.rttTotal/i.count*1e3).toFixed(2)," ms")),this.appendMessage("jitter: ".concat((i.jitterTotal/i.count*1e3).toFixed(2)," ms")),i.packetsLost>0&&this.appendWarning("packets lost: ".concat((i.packetsLost/i.packetsSent*100).toFixed(2),"%")),i.qualityLimitationDurations.bandwidth>1&&this.appendWarning("bandwidth limited ".concat((i.qualityLimitationDurations.bandwidth/(Sr/1e3)*100).toFixed(2),"%")),i.qualityLimitationDurations.cpu>0&&this.appendWarning("cpu limited ".concat((i.qualityLimitationDurations.cpu/(Sr/1e3)*100).toFixed(2),"%"))})}getInfo(){const e=super.getInfo();return e.data=this.bestStats,e}checkConnectionProtocol(e){return k(this,void 0,void 0,function*(){yield this.connect(),e==="tcp"?yield this.switchProtocol("tcp"):yield this.switchProtocol("udp");const t=document.createElement("canvas");t.width=1280,t.height=720;const i=t.getContext("2d");if(!i)throw new Error("Could not get canvas context");let r=0;const s=()=>{r=(r+1)%360,i.fillStyle="hsl(".concat(r,", 100%, 50%)"),i.fillRect(0,0,t.width,t.height),requestAnimationFrame(s)};s();const o=t.captureStream(30).getVideoTracks()[0],l=(yield this.room.localParticipant.publishTrack(o,{simulcast:!1,degradationPreference:"maintain-resolution",videoEncoding:{maxBitrate:2e6}})).track,u={protocol:e,packetsLost:0,packetsSent:0,qualityLimitationDurations:{},rttTotal:0,jitterTotal:0,bitrateTotal:0,count:0},d=setInterval(()=>k(this,void 0,void 0,function*(){const h=yield l.getRTCStatsReport();h?.forEach(p=>{p.type==="outbound-rtp"?(u.packetsSent=p.packetsSent,u.qualityLimitationDurations=p.qualityLimitationDurations,u.bitrateTotal+=p.targetBitrate,u.count++):p.type==="remote-inbound-rtp"&&(u.packetsLost=p.packetsLost,u.rttTotal+=p.roundTripTime,u.jitterTotal+=p.jitter)})}),1e3);return yield new Promise(h=>setTimeout(h,Sr)),clearInterval(d),o.stop(),t.remove(),yield this.disconnect(),u})}}class Np extends Dt{get description(){return"Can publish audio"}perform(){return k(this,void 0,void 0,function*(){var e;const t=yield this.connect(),i=yield Ip();if(yield ll(i,1e3))throw new Error("unable to detect audio from microphone");this.appendMessage("detected audio from microphone"),t.localParticipant.publishTrack(i),yield new Promise(o=>setTimeout(o,3e3));const s=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!s)throw new Error("Could not get RTCStats");let a=0;if(s.forEach(o=>{o.type==="outbound-rtp"&&(o.kind==="audio"||!o.kind&&o.mediaType==="audio")&&(a=o.packetsSent)}),a===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(a," audio packets"))})}}class Up extends Dt{get description(){return"Can publish video"}perform(){return k(this,void 0,void 0,function*(){var e;const t=yield this.connect(),i=yield _p();yield this.checkForVideo(i.mediaStreamTrack),t.localParticipant.publishTrack(i),yield new Promise(a=>setTimeout(a,5e3));const r=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!r)throw new Error("Could not get RTCStats");let s=0;if(r.forEach(a=>{a.type==="outbound-rtp"&&(a.kind==="video"||!a.kind&&a.mediaType==="video")&&(s+=a.packetsSent)}),s===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(s," video packets"))})}checkForVideo(e){return k(this,void 0,void 0,function*(){const t=new MediaStream;t.addTrack(e.clone());const i=document.createElement("video");i.srcObject=t,i.muted=!0,i.autoplay=!0,i.playsInline=!0,i.setAttribute("playsinline","true"),document.body.appendChild(i),yield new Promise(r=>{i.onplay=()=>{setTimeout(()=>{var s,a,o,c;const l=document.createElement("canvas"),u=e.getSettings(),d=(a=(s=u.width)!==null&&s!==void 0?s:i.videoWidth)!==null&&a!==void 0?a:1280,h=(c=(o=u.height)!==null&&o!==void 0?o:i.videoHeight)!==null&&c!==void 0?c:720;l.width=d,l.height=h;const p=l.getContext("2d");p.drawImage(i,0,0);const m=p.getImageData(0,0,l.width,l.height).data;let T=!0;for(let S=0;S<m.length;S+=4)if(m[S]!==0||m[S+1]!==0||m[S+2]!==0){T=!1;break}T?this.appendError("camera appears to be producing only black frames"):this.appendMessage("received video frames"),r()},1e3)},i.play()}),t.getTracks().forEach(r=>r.stop()),i.remove()})}}class Fp extends Dt{get description(){return"Resuming connection after interruption"}perform(){return k(this,void 0,void 0,function*(){var e;const t=yield this.connect();let i=!1,r=!1,s;const a=new Promise(l=>{setTimeout(l,5e3),s=l}),o=()=>{i=!0};t.on(_.SignalReconnecting,o).on(_.Reconnecting,o).on(_.Reconnected,()=>{r=!0,s(!0)}),(e=t.engine.client.ws)===null||e===void 0||e.close();const c=t.engine.client.onClose;if(c&&c(""),yield a,i){if(!r||t.state!==K.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class jp extends Dt{get description(){return"Can connect via TURN"}perform(){return k(this,void 0,void 0,function*(){var e,t,i;dn(new URL(this.url))&&(this.appendMessage("Using region specific url"),this.url=(e=yield new z(this.url,this.token).getNextBestRegionUrl())!==null&&e!==void 0?e:this.url);const r=new Rs,s=yield r.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3},void 0,!0);let a=!1,o=!1,c=!1;for(let l of s.iceServers)for(let u of l.urls)u.startsWith("turn:")?(o=!0,c=!0):u.startsWith("turns:")&&(o=!0,c=!0,a=!0),u.startsWith("stun:")&&(c=!0);c?o&&!a&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield r.close(),!((i=(t=this.connectOptions)===null||t===void 0?void 0:t.rtcConfig)===null||i===void 0)&&i.iceServers||o?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(l=>setTimeout(l,0)))})}}class Bp extends Dt{get description(){return"Establishing WebRTC connection"}perform(){return k(this,void 0,void 0,function*(){let e=!1,t=!1;this.room.on(_.SignalConnected,()=>{var i;const r=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(s,a)=>{if(s.candidate){const o=new RTCIceCandidate(s);let c="".concat(o.protocol," ").concat(o.address,":").concat(o.port," ").concat(o.type);o.address&&(Vp(o.address)?c+=" (private)":o.protocol==="tcp"&&o.tcpType==="passive"?(e=!0,c+=" (passive)"):o.protocol==="udp"&&(t=!0)),this.appendMessage(c)}r&&r(s,a)},!((i=this.room.engine.pcManager)===null||i===void 0)&&i.subscriber&&(this.room.engine.pcManager.subscriber.onIceCandidateError=s=>{s instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(s.errorCode," ").concat(s.errorText," ").concat(s.url))})});try{yield this.connect(),j.info("now the room is connected")}catch(i){throw this.appendWarning("ports need to be open on firewall in order to connect."),i}e||this.appendWarning("Server is not configured for ICE/TCP"),t||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function Vp(n){const e=n.split(".");if(e.length===4){if(e[0]==="10")return!0;if(e[0]==="192"&&e[1]==="168")return!0;if(e[0]==="172"){const t=parseInt(e[1],10);if(t>=16&&t<=31)return!0}}return!1}class qp extends Dt{get description(){return"Connecting to signal connection via WebSocket"}perform(){return k(this,void 0,void 0,function*(){var e,t,i;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let r=new Rs,s;try{s=yield r.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3},void 0,!0)}catch(a){if(dn(new URL(this.url))){this.appendMessage("Initial connection failed with error ".concat(a.message,". Retrying with region fallback"));const c=yield new z(this.url,this.token).getNextBestRegionUrl();c&&(s=yield r.join(c,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3},void 0,!0),this.appendMessage("Fallback to region worked. To avoid initial connections failing, ensure you're calling room.prepareConnection() ahead of time"))}}s?(this.appendMessage("Connected to server, version ".concat(s.serverVersion,".")),((e=s.serverInfo)===null||e===void 0?void 0:e.edition)===fc.Cloud&&(!((t=s.serverInfo)===null||t===void 0)&&t.region)&&this.appendMessage("LiveKit Cloud: ".concat((i=s.serverInfo)===null||i===void 0?void 0:i.region))):this.appendError("Websocket connection could not be established"),yield r.close()})}}class Sy extends nt.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=e,this.token=t,this.options=i}getNextCheckId(){const e=this.checkResults.size;return this.checkResults.set(e,{logs:[],status:Ne.IDLE,name:"",description:""}),e}updateCheck(e,t){this.checkResults.set(e,t),this.emit("checkUpdate",e,t)}isSuccess(){return Array.from(this.checkResults.values()).every(e=>e.status!==Ne.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(e){return k(this,void 0,void 0,function*(){const t=this.getNextCheckId(),i=new e(this.url,this.token,this.options),r=a=>{this.updateCheck(t,a)};i.on("update",r);const s=yield i.run();return i.off("update",r),s})}checkWebsocket(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(qp)})}checkWebRTC(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(Bp)})}checkTURN(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(jp)})}checkReconnect(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(Fp)})}checkPublishAudio(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(Np)})}checkPublishVideo(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(Up)})}checkConnectionProtocol(){return k(this,void 0,void 0,function*(){const e=yield this.createAndRunCheck(Lp);if(e.data&&"protocol"in e.data){const t=e.data;this.options.protocol=t.protocol}return e})}checkCloudRegion(){return k(this,void 0,void 0,function*(){return this.createAndRunCheck(Ap)})}}function H(n,e,t){return(e=Hp(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Wp(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function Hp(n){var e=Wp(n,"string");return typeof e=="symbol"?e:e+""}new TextEncoder;new TextDecoder;class Te extends Error{constructor(e,t){var i;super(e,t),H(this,"code","ERR_JOSE_GENERIC"),this.name=this.constructor.name,(i=Error.captureStackTrace)===null||i===void 0||i.call(Error,this,this.constructor)}}H(Te,"code","ERR_JOSE_GENERIC");class Kp extends Te{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unspecified",r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"unspecified";super(e,{cause:{claim:i,reason:r,payload:t}}),H(this,"code","ERR_JWT_CLAIM_VALIDATION_FAILED"),H(this,"claim",void 0),H(this,"reason",void 0),H(this,"payload",void 0),this.claim=i,this.reason=r,this.payload=t}}H(Kp,"code","ERR_JWT_CLAIM_VALIDATION_FAILED");class zp extends Te{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unspecified",r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"unspecified";super(e,{cause:{claim:i,reason:r,payload:t}}),H(this,"code","ERR_JWT_EXPIRED"),H(this,"claim",void 0),H(this,"reason",void 0),H(this,"payload",void 0),this.claim=i,this.reason=r,this.payload=t}}H(zp,"code","ERR_JWT_EXPIRED");class Gp extends Te{constructor(){super(...arguments),H(this,"code","ERR_JOSE_ALG_NOT_ALLOWED")}}H(Gp,"code","ERR_JOSE_ALG_NOT_ALLOWED");class Jp extends Te{constructor(){super(...arguments),H(this,"code","ERR_JOSE_NOT_SUPPORTED")}}H(Jp,"code","ERR_JOSE_NOT_SUPPORTED");class $p extends Te{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"decryption operation failed",t=arguments.length>1?arguments[1]:void 0;super(e,t),H(this,"code","ERR_JWE_DECRYPTION_FAILED")}}H($p,"code","ERR_JWE_DECRYPTION_FAILED");class Qp extends Te{constructor(){super(...arguments),H(this,"code","ERR_JWE_INVALID")}}H(Qp,"code","ERR_JWE_INVALID");class Yp extends Te{constructor(){super(...arguments),H(this,"code","ERR_JWS_INVALID")}}H(Yp,"code","ERR_JWS_INVALID");class Xp extends Te{constructor(){super(...arguments),H(this,"code","ERR_JWT_INVALID")}}H(Xp,"code","ERR_JWT_INVALID");class Zp extends Te{constructor(){super(...arguments),H(this,"code","ERR_JWK_INVALID")}}H(Zp,"code","ERR_JWK_INVALID");class em extends Te{constructor(){super(...arguments),H(this,"code","ERR_JWKS_INVALID")}}H(em,"code","ERR_JWKS_INVALID");class tm extends Te{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"no applicable key found in the JSON Web Key Set",t=arguments.length>1?arguments[1]:void 0;super(e,t),H(this,"code","ERR_JWKS_NO_MATCHING_KEY")}}H(tm,"code","ERR_JWKS_NO_MATCHING_KEY");class nm extends Te{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"multiple matching keys found in the JSON Web Key Set",t=arguments.length>1?arguments[1]:void 0;super(e,t),H(this,Symbol.asyncIterator,void 0),H(this,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS")}}H(nm,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS");class im extends Te{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"request timed out",t=arguments.length>1?arguments[1]:void 0;super(e,t),H(this,"code","ERR_JWKS_TIMEOUT")}}H(im,"code","ERR_JWKS_TIMEOUT");class rm extends Te{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"signature verification failed",t=arguments.length>1?arguments[1]:void 0;super(e,t),H(this,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED")}}H(rm,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED");function sm(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var t;const i=Ft(n)?n.mediaStreamTrack:n,r=i.getSettings();let s={facingMode:(t=e.defaultFacingMode)!==null&&t!==void 0?t:"user",confidence:"low"};if("facingMode"in r){const a=r.facingMode;j.trace("rawFacingMode",{rawFacingMode:a}),a&&typeof a=="string"&&cm(a)&&(s={facingMode:a,confidence:"high"})}if(["low","medium"].includes(s.confidence)){j.trace("Try to get facing mode from device label: (".concat(i.label,")"));const a=am(i.label);a!==void 0&&(s=a)}return s}const aa=new Map([["obs virtual camera",{facingMode:"environment",confidence:"medium"}]]),om=new Map([["iphone",{facingMode:"environment",confidence:"medium"}],["ipad",{facingMode:"environment",confidence:"medium"}]]);function am(n){var e;const t=n.trim().toLowerCase();if(t!=="")return aa.has(t)?aa.get(t):(e=Array.from(om.entries()).find(i=>{let[r]=i;return t.includes(r)}))===null||e===void 0?void 0:e[1]}function cm(n){return n===void 0||["user","environment","left","right"].includes(n)}const _i=Math.min,jt=Math.max,Ii=Math.round,Yn=Math.floor,Ze=n=>({x:n,y:n}),lm={left:"right",right:"left",bottom:"top",top:"bottom"},um={start:"end",end:"start"};function ca(n,e,t){return jt(n,_i(e,t))}function Ki(n,e){return typeof n=="function"?n(e):n}function Wt(n){return n.split("-")[0]}function zi(n){return n.split("-")[1]}function Il(n){return n==="x"?"y":"x"}function xl(n){return n==="y"?"height":"width"}const dm=new Set(["top","bottom"]);function Et(n){return dm.has(Wt(n))?"y":"x"}function Ol(n){return Il(Et(n))}function hm(n,e,t){t===void 0&&(t=!1);const i=zi(n),r=Ol(n),s=xl(r);let a=r==="x"?i===(t?"end":"start")?"right":"left":i==="start"?"bottom":"top";return e.reference[s]>e.floating[s]&&(a=xi(a)),[a,xi(a)]}function fm(n){const e=xi(n);return[Xr(n),e,Xr(e)]}function Xr(n){return n.replace(/start|end/g,e=>um[e])}const la=["left","right"],ua=["right","left"],pm=["top","bottom"],mm=["bottom","top"];function gm(n,e,t){switch(n){case"top":case"bottom":return t?e?ua:la:e?la:ua;case"left":case"right":return e?pm:mm;default:return[]}}function vm(n,e,t,i){const r=zi(n);let s=gm(Wt(n),t==="start",i);return r&&(s=s.map(a=>a+"-"+r),e&&(s=s.concat(s.map(Xr)))),s}function xi(n){return n.replace(/left|right|bottom|top/g,e=>lm[e])}function bm(n){return{top:0,right:0,bottom:0,left:0,...n}}function ym(n){return typeof n!="number"?bm(n):{top:n,right:n,bottom:n,left:n}}function Oi(n){const{x:e,y:t,width:i,height:r}=n;return{width:i,height:r,top:t,left:e,right:e+i,bottom:t+r,x:e,y:t}}function da(n,e,t){let{reference:i,floating:r}=n;const s=Et(e),a=Ol(e),o=xl(a),c=Wt(e),l=s==="y",u=i.x+i.width/2-r.width/2,d=i.y+i.height/2-r.height/2,h=i[o]/2-r[o]/2;let p;switch(c){case"top":p={x:u,y:i.y-r.height};break;case"bottom":p={x:u,y:i.y+i.height};break;case"right":p={x:i.x+i.width,y:d};break;case"left":p={x:i.x-r.width,y:d};break;default:p={x:i.x,y:i.y}}switch(zi(e)){case"start":p[a]-=h*(t&&l?-1:1);break;case"end":p[a]+=h*(t&&l?-1:1);break}return p}const km=async(n,e,t)=>{const{placement:i="bottom",strategy:r="absolute",middleware:s=[],platform:a}=t,o=s.filter(Boolean),c=await(a.isRTL==null?void 0:a.isRTL(e));let l=await a.getElementRects({reference:n,floating:e,strategy:r}),{x:u,y:d}=da(l,i,c),h=i,p={},b=0;for(let m=0;m<o.length;m++){const{name:T,fn:S}=o[m],{x:P,y:M,data:v,reset:g}=await S({x:u,y:d,initialPlacement:i,placement:h,strategy:r,middlewareData:p,rects:l,platform:a,elements:{reference:n,floating:e}});u=P??u,d=M??d,p={...p,[T]:{...p[T],...v}},g&&b<=50&&(b++,typeof g=="object"&&(g.placement&&(h=g.placement),g.rects&&(l=g.rects===!0?await a.getElementRects({reference:n,floating:e,strategy:r}):g.rects),{x:u,y:d}=da(l,h,c)),m=-1)}return{x:u,y:d,placement:h,strategy:r,middlewareData:p}};async function Ml(n,e){var t;e===void 0&&(e={});const{x:i,y:r,platform:s,rects:a,elements:o,strategy:c}=n,{boundary:l="clippingAncestors",rootBoundary:u="viewport",elementContext:d="floating",altBoundary:h=!1,padding:p=0}=Ki(e,n),b=ym(p),m=o[h?d==="floating"?"reference":"floating":d],T=Oi(await s.getClippingRect({element:(t=await(s.isElement==null?void 0:s.isElement(m)))==null||t?m:m.contextElement||await(s.getDocumentElement==null?void 0:s.getDocumentElement(o.floating)),boundary:l,rootBoundary:u,strategy:c})),S=d==="floating"?{x:i,y:r,width:a.floating.width,height:a.floating.height}:a.reference,P=await(s.getOffsetParent==null?void 0:s.getOffsetParent(o.floating)),M=await(s.isElement==null?void 0:s.isElement(P))?await(s.getScale==null?void 0:s.getScale(P))||{x:1,y:1}:{x:1,y:1},v=Oi(s.convertOffsetParentRelativeRectToViewportRelativeRect?await s.convertOffsetParentRelativeRectToViewportRelativeRect({elements:o,rect:S,offsetParent:P,strategy:c}):S);return{top:(T.top-v.top+b.top)/M.y,bottom:(v.bottom-T.bottom+b.bottom)/M.y,left:(T.left-v.left+b.left)/M.x,right:(v.right-T.right+b.right)/M.x}}const Sm=function(n){return n===void 0&&(n={}),{name:"flip",options:n,async fn(e){var t,i;const{placement:r,middlewareData:s,rects:a,initialPlacement:o,platform:c,elements:l}=e,{mainAxis:u=!0,crossAxis:d=!0,fallbackPlacements:h,fallbackStrategy:p="bestFit",fallbackAxisSideDirection:b="none",flipAlignment:m=!0,...T}=Ki(n,e);if((t=s.arrow)!=null&&t.alignmentOffset)return{};const S=Wt(r),P=Et(o),M=Wt(o)===o,v=await(c.isRTL==null?void 0:c.isRTL(l.floating)),g=h||(M||!m?[xi(o)]:fm(o)),y=b!=="none";!h&&y&&g.push(...vm(o,m,b,v));const C=[o,...g],x=await Ml(e,T),R=[];let I=((i=s.flip)==null?void 0:i.overflows)||[];if(u&&R.push(x[S]),d){const G=hm(r,a,v);R.push(x[G[0]],x[G[1]])}if(I=[...I,{placement:r,overflows:R}],!R.every(G=>G<=0)){var D,U;const G=(((D=s.flip)==null?void 0:D.index)||0)+1,Ce=C[G];if(Ce&&(!(d==="alignment"&&P!==Et(Ce))||I.every(ee=>Et(ee.placement)===P?ee.overflows[0]>0:!0)))return{data:{index:G,overflows:I},reset:{placement:Ce}};let $=(U=I.filter(ee=>ee.overflows[0]<=0).sort((ee,ve)=>ee.overflows[1]-ve.overflows[1])[0])==null?void 0:U.placement;if(!$)switch(p){case"bestFit":{var V;const ee=(V=I.filter(ve=>{if(y){const Ee=Et(ve.placement);return Ee===P||Ee==="y"}return!0}).map(ve=>[ve.placement,ve.overflows.filter(Ee=>Ee>0).reduce((Ee,At)=>Ee+At,0)]).sort((ve,Ee)=>ve[1]-Ee[1])[0])==null?void 0:V[0];ee&&($=ee);break}case"initialPlacement":$=o;break}if(r!==$)return{reset:{placement:$}}}return{}}}},Tm=new Set(["left","top"]);async function Cm(n,e){const{placement:t,platform:i,elements:r}=n,s=await(i.isRTL==null?void 0:i.isRTL(r.floating)),a=Wt(t),o=zi(t),c=Et(t)==="y",l=Tm.has(a)?-1:1,u=s&&c?-1:1,d=Ki(e,n);let{mainAxis:h,crossAxis:p,alignmentAxis:b}=typeof d=="number"?{mainAxis:d,crossAxis:0,alignmentAxis:null}:{mainAxis:d.mainAxis||0,crossAxis:d.crossAxis||0,alignmentAxis:d.alignmentAxis};return o&&typeof b=="number"&&(p=o==="end"?b*-1:b),c?{x:p*u,y:h*l}:{x:h*l,y:p*u}}const Em=function(n){return n===void 0&&(n=0),{name:"offset",options:n,async fn(e){var t,i;const{x:r,y:s,placement:a,middlewareData:o}=e,c=await Cm(e,n);return a===((t=o.offset)==null?void 0:t.placement)&&(i=o.arrow)!=null&&i.alignmentOffset?{}:{x:r+c.x,y:s+c.y,data:{...c,placement:a}}}}},wm=function(n){return n===void 0&&(n={}),{name:"shift",options:n,async fn(e){const{x:t,y:i,placement:r}=e,{mainAxis:s=!0,crossAxis:a=!1,limiter:o={fn:T=>{let{x:S,y:P}=T;return{x:S,y:P}}},...c}=Ki(n,e),l={x:t,y:i},u=await Ml(e,c),d=Et(Wt(r)),h=Il(d);let p=l[h],b=l[d];if(s){const T=h==="y"?"top":"left",S=h==="y"?"bottom":"right",P=p+u[T],M=p-u[S];p=ca(P,p,M)}if(a){const T=d==="y"?"top":"left",S=d==="y"?"bottom":"right",P=b+u[T],M=b-u[S];b=ca(P,b,M)}const m=o.fn({...e,[h]:p,[d]:b});return{...m,data:{x:m.x-t,y:m.y-i,enabled:{[h]:s,[d]:a}}}}}};function Gi(){return typeof window<"u"}function mn(n){return Dl(n)?(n.nodeName||"").toLowerCase():"#document"}function Oe(n){var e;return(n==null||(e=n.ownerDocument)==null?void 0:e.defaultView)||window}function rt(n){var e;return(e=(Dl(n)?n.ownerDocument:n.document)||window.document)==null?void 0:e.documentElement}function Dl(n){return Gi()?n instanceof Node||n instanceof Oe(n).Node:!1}function He(n){return Gi()?n instanceof Element||n instanceof Oe(n).Element:!1}function tt(n){return Gi()?n instanceof HTMLElement||n instanceof Oe(n).HTMLElement:!1}function ha(n){return!Gi()||typeof ShadowRoot>"u"?!1:n instanceof ShadowRoot||n instanceof Oe(n).ShadowRoot}const Pm=new Set(["inline","contents"]);function Wn(n){const{overflow:e,overflowX:t,overflowY:i,display:r}=Ke(n);return/auto|scroll|overlay|hidden|clip/.test(e+i+t)&&!Pm.has(r)}const Rm=new Set(["table","td","th"]);function _m(n){return Rm.has(mn(n))}const Im=[":popover-open",":modal"];function Ji(n){return Im.some(e=>{try{return n.matches(e)}catch{return!1}})}const xm=["transform","translate","scale","rotate","perspective"],Om=["transform","translate","scale","rotate","perspective","filter"],Mm=["paint","layout","strict","content"];function Ls(n){const e=Ns(),t=He(n)?Ke(n):n;return xm.some(i=>t[i]?t[i]!=="none":!1)||(t.containerType?t.containerType!=="normal":!1)||!e&&(t.backdropFilter?t.backdropFilter!=="none":!1)||!e&&(t.filter?t.filter!=="none":!1)||Om.some(i=>(t.willChange||"").includes(i))||Mm.some(i=>(t.contain||"").includes(i))}function Dm(n){let e=Ot(n);for(;tt(e)&&!hn(e);){if(Ls(e))return e;if(Ji(e))return null;e=Ot(e)}return null}function Ns(){return typeof CSS>"u"||!CSS.supports?!1:CSS.supports("-webkit-backdrop-filter","none")}const Am=new Set(["html","body","#document"]);function hn(n){return Am.has(mn(n))}function Ke(n){return Oe(n).getComputedStyle(n)}function $i(n){return He(n)?{scrollLeft:n.scrollLeft,scrollTop:n.scrollTop}:{scrollLeft:n.scrollX,scrollTop:n.scrollY}}function Ot(n){if(mn(n)==="html")return n;const e=n.assignedSlot||n.parentNode||ha(n)&&n.host||rt(n);return ha(e)?e.host:e}function Al(n){const e=Ot(n);return hn(e)?n.ownerDocument?n.ownerDocument.body:n.body:tt(e)&&Wn(e)?e:Al(e)}function Bn(n,e,t){var i;e===void 0&&(e=[]),t===void 0&&(t=!0);const r=Al(n),s=r===((i=n.ownerDocument)==null?void 0:i.body),a=Oe(r);if(s){const o=Zr(a);return e.concat(a,a.visualViewport||[],Wn(r)?r:[],o&&t?Bn(o):[])}return e.concat(r,Bn(r,[],t))}function Zr(n){return n.parent&&Object.getPrototypeOf(n.parent)?n.frameElement:null}function Ll(n){const e=Ke(n);let t=parseFloat(e.width)||0,i=parseFloat(e.height)||0;const r=tt(n),s=r?n.offsetWidth:t,a=r?n.offsetHeight:i,o=Ii(t)!==s||Ii(i)!==a;return o&&(t=s,i=a),{width:t,height:i,$:o}}function Us(n){return He(n)?n:n.contextElement}function cn(n){const e=Us(n);if(!tt(e))return Ze(1);const t=e.getBoundingClientRect(),{width:i,height:r,$:s}=Ll(e);let a=(s?Ii(t.width):t.width)/i,o=(s?Ii(t.height):t.height)/r;return(!a||!Number.isFinite(a))&&(a=1),(!o||!Number.isFinite(o))&&(o=1),{x:a,y:o}}const Lm=Ze(0);function Nl(n){const e=Oe(n);return!Ns()||!e.visualViewport?Lm:{x:e.visualViewport.offsetLeft,y:e.visualViewport.offsetTop}}function Nm(n,e,t){return e===void 0&&(e=!1),!t||e&&t!==Oe(n)?!1:e}function Ht(n,e,t,i){e===void 0&&(e=!1),t===void 0&&(t=!1);const r=n.getBoundingClientRect(),s=Us(n);let a=Ze(1);e&&(i?He(i)&&(a=cn(i)):a=cn(n));const o=Nm(s,t,i)?Nl(s):Ze(0);let c=(r.left+o.x)/a.x,l=(r.top+o.y)/a.y,u=r.width/a.x,d=r.height/a.y;if(s){const h=Oe(s),p=i&&He(i)?Oe(i):i;let b=h,m=Zr(b);for(;m&&i&&p!==b;){const T=cn(m),S=m.getBoundingClientRect(),P=Ke(m),M=S.left+(m.clientLeft+parseFloat(P.paddingLeft))*T.x,v=S.top+(m.clientTop+parseFloat(P.paddingTop))*T.y;c*=T.x,l*=T.y,u*=T.x,d*=T.y,c+=M,l+=v,b=Oe(m),m=Zr(b)}}return Oi({width:u,height:d,x:c,y:l})}function Qi(n,e){const t=$i(n).scrollLeft;return e?e.left+t:Ht(rt(n)).left+t}function Ul(n,e){const t=n.getBoundingClientRect(),i=t.left+e.scrollLeft-Qi(n,t),r=t.top+e.scrollTop;return{x:i,y:r}}function Um(n){let{elements:e,rect:t,offsetParent:i,strategy:r}=n;const s=r==="fixed",a=rt(i),o=e?Ji(e.floating):!1;if(i===a||o&&s)return t;let c={scrollLeft:0,scrollTop:0},l=Ze(1);const u=Ze(0),d=tt(i);if((d||!d&&!s)&&((mn(i)!=="body"||Wn(a))&&(c=$i(i)),tt(i))){const p=Ht(i);l=cn(i),u.x=p.x+i.clientLeft,u.y=p.y+i.clientTop}const h=a&&!d&&!s?Ul(a,c):Ze(0);return{width:t.width*l.x,height:t.height*l.y,x:t.x*l.x-c.scrollLeft*l.x+u.x+h.x,y:t.y*l.y-c.scrollTop*l.y+u.y+h.y}}function Fm(n){return Array.from(n.getClientRects())}function jm(n){const e=rt(n),t=$i(n),i=n.ownerDocument.body,r=jt(e.scrollWidth,e.clientWidth,i.scrollWidth,i.clientWidth),s=jt(e.scrollHeight,e.clientHeight,i.scrollHeight,i.clientHeight);let a=-t.scrollLeft+Qi(n);const o=-t.scrollTop;return Ke(i).direction==="rtl"&&(a+=jt(e.clientWidth,i.clientWidth)-r),{width:r,height:s,x:a,y:o}}const fa=25;function Bm(n,e){const t=Oe(n),i=rt(n),r=t.visualViewport;let s=i.clientWidth,a=i.clientHeight,o=0,c=0;if(r){s=r.width,a=r.height;const u=Ns();(!u||u&&e==="fixed")&&(o=r.offsetLeft,c=r.offsetTop)}const l=Qi(i);if(l<=0){const u=i.ownerDocument,d=u.body,h=getComputedStyle(d),p=u.compatMode==="CSS1Compat"&&parseFloat(h.marginLeft)+parseFloat(h.marginRight)||0,b=Math.abs(i.clientWidth-d.clientWidth-p);b<=fa&&(s-=b)}else l<=fa&&(s+=l);return{width:s,height:a,x:o,y:c}}const Vm=new Set(["absolute","fixed"]);function qm(n,e){const t=Ht(n,!0,e==="fixed"),i=t.top+n.clientTop,r=t.left+n.clientLeft,s=tt(n)?cn(n):Ze(1),a=n.clientWidth*s.x,o=n.clientHeight*s.y,c=r*s.x,l=i*s.y;return{width:a,height:o,x:c,y:l}}function pa(n,e,t){let i;if(e==="viewport")i=Bm(n,t);else if(e==="document")i=jm(rt(n));else if(He(e))i=qm(e,t);else{const r=Nl(n);i={x:e.x-r.x,y:e.y-r.y,width:e.width,height:e.height}}return Oi(i)}function Fl(n,e){const t=Ot(n);return t===e||!He(t)||hn(t)?!1:Ke(t).position==="fixed"||Fl(t,e)}function Wm(n,e){const t=e.get(n);if(t)return t;let i=Bn(n,[],!1).filter(o=>He(o)&&mn(o)!=="body"),r=null;const s=Ke(n).position==="fixed";let a=s?Ot(n):n;for(;He(a)&&!hn(a);){const o=Ke(a),c=Ls(a);!c&&o.position==="fixed"&&(r=null),(s?!c&&!r:!c&&o.position==="static"&&r&&Vm.has(r.position)||Wn(a)&&!c&&Fl(n,a))?i=i.filter(l=>l!==a):r=o,a=Ot(a)}return e.set(n,i),i}function Hm(n){let{element:e,boundary:t,rootBoundary:i,strategy:r}=n;const s=[...t==="clippingAncestors"?Ji(e)?[]:Wm(e,this._c):[].concat(t),i],a=s[0],o=s.reduce((c,l)=>{const u=pa(e,l,r);return c.top=jt(u.top,c.top),c.right=_i(u.right,c.right),c.bottom=_i(u.bottom,c.bottom),c.left=jt(u.left,c.left),c},pa(e,a,r));return{width:o.right-o.left,height:o.bottom-o.top,x:o.left,y:o.top}}function Km(n){const{width:e,height:t}=Ll(n);return{width:e,height:t}}function zm(n,e,t){const i=tt(e),r=rt(e),s=t==="fixed",a=Ht(n,!0,s,e);let o={scrollLeft:0,scrollTop:0};const c=Ze(0);function l(){c.x=Qi(r)}if(i||!i&&!s)if((mn(e)!=="body"||Wn(r))&&(o=$i(e)),i){const p=Ht(e,!0,s,e);c.x=p.x+e.clientLeft,c.y=p.y+e.clientTop}else r&&l();s&&!i&&r&&l();const u=r&&!i&&!s?Ul(r,o):Ze(0),d=a.left+o.scrollLeft-c.x-u.x,h=a.top+o.scrollTop-c.y-u.y;return{x:d,y:h,width:a.width,height:a.height}}function Tr(n){return Ke(n).position==="static"}function ma(n,e){if(!tt(n)||Ke(n).position==="fixed")return null;if(e)return e(n);let t=n.offsetParent;return rt(n)===t&&(t=t.ownerDocument.body),t}function jl(n,e){const t=Oe(n);if(Ji(n))return t;if(!tt(n)){let r=Ot(n);for(;r&&!hn(r);){if(He(r)&&!Tr(r))return r;r=Ot(r)}return t}let i=ma(n,e);for(;i&&_m(i)&&Tr(i);)i=ma(i,e);return i&&hn(i)&&Tr(i)&&!Ls(i)?t:i||Dm(n)||t}const Gm=async function(n){const e=this.getOffsetParent||jl,t=this.getDimensions,i=await t(n.floating);return{reference:zm(n.reference,await e(n.floating),n.strategy),floating:{x:0,y:0,width:i.width,height:i.height}}};function Jm(n){return Ke(n).direction==="rtl"}const $m={convertOffsetParentRelativeRectToViewportRelativeRect:Um,getDocumentElement:rt,getClippingRect:Hm,getOffsetParent:jl,getElementRects:Gm,getClientRects:Fm,getDimensions:Km,getScale:cn,isElement:He,isRTL:Jm};function Bl(n,e){return n.x===e.x&&n.y===e.y&&n.width===e.width&&n.height===e.height}function Qm(n,e){let t=null,i;const r=rt(n);function s(){var o;clearTimeout(i),(o=t)==null||o.disconnect(),t=null}function a(o,c){o===void 0&&(o=!1),c===void 0&&(c=1),s();const l=n.getBoundingClientRect(),{left:u,top:d,width:h,height:p}=l;if(o||e(),!h||!p)return;const b=Yn(d),m=Yn(r.clientWidth-(u+h)),T=Yn(r.clientHeight-(d+p)),S=Yn(u),P={rootMargin:-b+"px "+-m+"px "+-T+"px "+-S+"px",threshold:jt(0,_i(1,c))||1};let M=!0;function v(g){const y=g[0].intersectionRatio;if(y!==c){if(!M)return a();y?a(!1,y):i=setTimeout(()=>{a(!1,1e-7)},1e3)}y===1&&!Bl(l,n.getBoundingClientRect())&&a(),M=!1}try{t=new IntersectionObserver(v,{...P,root:r.ownerDocument})}catch{t=new IntersectionObserver(v,P)}t.observe(n)}return a(!0),s}function Ym(n,e,t,i){i===void 0&&(i={});const{ancestorScroll:r=!0,ancestorResize:s=!0,elementResize:a=typeof ResizeObserver=="function",layoutShift:o=typeof IntersectionObserver=="function",animationFrame:c=!1}=i,l=Us(n),u=r||s?[...l?Bn(l):[],...Bn(e)]:[];u.forEach(S=>{r&&S.addEventListener("scroll",t,{passive:!0}),s&&S.addEventListener("resize",t)});const d=l&&o?Qm(l,t):null;let h=-1,p=null;a&&(p=new ResizeObserver(S=>{let[P]=S;P&&P.target===l&&p&&(p.unobserve(e),cancelAnimationFrame(h),h=requestAnimationFrame(()=>{var M;(M=p)==null||M.observe(e)})),t()}),l&&!c&&p.observe(l),p.observe(e));let b,m=c?Ht(n):null;c&&T();function T(){const S=Ht(n);m&&!Bl(m,S)&&t(),m=S,b=requestAnimationFrame(T)}return t(),()=>{var S;u.forEach(P=>{r&&P.removeEventListener("scroll",t),s&&P.removeEventListener("resize",t)}),d?.(),(S=p)==null||S.disconnect(),p=null,c&&cancelAnimationFrame(b)}}const Xm=Em,Zm=wm,eg=Sm,tg=(n,e,t)=>{const i=new Map,r={platform:$m,...t},s={...r.platform,_c:i};return km(n,e,{...r,platform:s})};var Xn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Vl(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var es={exports:{}},ng=es.exports,ga;function ig(){return ga||(ga=1,(function(n){(function(e,t){n.exports?n.exports=t():e.log=t()})(ng,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},a=null;function o(m,T){var S=m[T];if(typeof S.bind=="function")return S.bind(m);try{return Function.prototype.bind.call(S,m)}catch{return function(){return Function.prototype.apply.apply(S,[m,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&i?c:console[m]!==void 0?o(console,m):console.log!==void 0?o(console,"log"):e}function u(){for(var m=this.getLevel(),T=0;T<r.length;T++){var S=r[T];this[S]=T<m?e:this.methodFactory(S,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==t&&(u.call(this),this[m].apply(this,arguments))}}function h(m,T,S){return l(m)||d.apply(this,arguments)}function p(m,T){var S=this,P,M,v,g="loglevel";typeof m=="string"?g+=":"+m:typeof m=="symbol"&&(g=void 0);function y(D){var U=(r[D]||"silent").toUpperCase();if(!(typeof window===t||!g)){try{window.localStorage[g]=U;return}catch{}try{window.document.cookie=encodeURIComponent(g)+"="+U+";"}catch{}}}function C(){var D;if(!(typeof window===t||!g)){try{D=window.localStorage[g]}catch{}if(typeof D===t)try{var U=window.document.cookie,V=encodeURIComponent(g),G=U.indexOf(V+"=");G!==-1&&(D=/^([^;]+)/.exec(U.slice(G+V.length+1))[1])}catch{}return S.levels[D]===void 0&&(D=void 0),D}}function x(){if(!(typeof window===t||!g)){try{window.localStorage.removeItem(g)}catch{}try{window.document.cookie=encodeURIComponent(g)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function R(D){var U=D;if(typeof U=="string"&&S.levels[U.toUpperCase()]!==void 0&&(U=S.levels[U.toUpperCase()]),typeof U=="number"&&U>=0&&U<=S.levels.SILENT)return U;throw new TypeError("log.setLevel() called with invalid level: "+D)}S.name=m,S.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},S.methodFactory=T||h,S.getLevel=function(){return v??M??P},S.setLevel=function(D,U){return v=R(D),U!==!1&&y(v),u.call(S)},S.setDefaultLevel=function(D){M=R(D),C()||S.setLevel(D,!1)},S.resetLevel=function(){v=null,x(),u.call(S)},S.enableAll=function(D){S.setLevel(S.levels.TRACE,D)},S.disableAll=function(D){S.setLevel(S.levels.SILENT,D)},S.rebuild=function(){if(a!==S&&(P=R(a.getLevel())),u.call(S),a===S)for(var D in s)s[D].rebuild()},P=R(a?a.getLevel():"WARN");var I=C();I!=null&&(v=R(I)),u.call(S)}a=new p,a.getLogger=function(m){if(typeof m!="symbol"&&typeof m!="string"||m==="")throw new TypeError("You must supply a name when creating a logger.");var T=s[m];return T||(T=s[m]=new p(m,a.methodFactory)),T};var b=typeof window!==t?window.log:void 0;return a.noConflict=function(){return typeof window!==t&&window.log===a&&(window.log=b),a},a.getLoggers=function(){return s},a.default=a,a})})(es)),es.exports}var rg=ig();const sg=Vl(rg);var ts=function(n,e){return ts=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])},ts(n,e)};function pt(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");ts(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function og(n,e,t,i){function r(s){return s instanceof t?s:new t(function(a){a(s)})}return new(t||(t=Promise))(function(s,a){function o(u){try{l(i.next(u))}catch(d){a(d)}}function c(u){try{l(i.throw(u))}catch(d){a(d)}}function l(u){u.done?s(u.value):r(u.value).then(o,c)}l((i=i.apply(n,[])).next())})}function ql(n,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,r,s,a=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(l){return function(u){return c([l,u])}}function c(l){if(i)throw new TypeError("Generator is already executing.");for(;a&&(a=0,l[0]&&(t=0)),t;)try{if(i=1,r&&(s=l[0]&2?r.return:l[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,l[1])).done)return s;switch(r=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,r=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){t.label=l[1];break}if(l[0]===6&&t.label<s[1]){t.label=s[1],s=l;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(l);break}s[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(n,t)}catch(u){l=[6,u],r=0}finally{i=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function fn(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function pn(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var i=t.call(n),r,s=[],a;try{for(;(e===void 0||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(o){a={error:o}}finally{try{r&&!r.done&&(t=i.return)&&t.call(i)}finally{if(a)throw a.error}}return s}function Vn(n,e,t){if(arguments.length===2)for(var i=0,r=e.length,s;i<r;i++)(s||!(i in e))&&(s||(s=Array.prototype.slice.call(e,0,i)),s[i]=e[i]);return n.concat(s||Array.prototype.slice.call(e))}function ln(n){return this instanceof ln?(this.v=n,this):new ln(n)}function ag(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(n,e||[]),r,s=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",a),r[Symbol.asyncIterator]=function(){return this},r;function a(p){return function(b){return Promise.resolve(b).then(p,d)}}function o(p,b){i[p]&&(r[p]=function(m){return new Promise(function(T,S){s.push([p,m,T,S])>1||c(p,m)})},b&&(r[p]=b(r[p])))}function c(p,b){try{l(i[p](b))}catch(m){h(s[0][3],m)}}function l(p){p.value instanceof ln?Promise.resolve(p.value.v).then(u,d):h(s[0][2],p)}function u(p){c("next",p)}function d(p){c("throw",p)}function h(p,b){p(b),s.shift(),s.length&&c(s[0][0],s[0][1])}}function cg(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof fn=="function"?fn(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(a){return new Promise(function(o,c){a=n[s](a),r(o,c,a.done,a.value)})}}function r(s,a,o,c){Promise.resolve(c).then(function(l){s({value:l,done:o})},a)}}function X(n){return typeof n=="function"}function Fs(n){var e=function(i){Error.call(i),i.stack=new Error().stack},t=n(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var Cr=Fs(function(n){return function(e){n(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(t,i){return i+1+") "+t.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function Mi(n,e){if(n){var t=n.indexOf(e);0<=t&&n.splice(t,1)}}var Hn=(function(){function n(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return n.prototype.unsubscribe=function(){var e,t,i,r,s;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var o=fn(a),c=o.next();!c.done;c=o.next()){var l=c.value;l.remove(this)}}catch(m){e={error:m}}finally{try{c&&!c.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}else a.remove(this);var u=this.initialTeardown;if(X(u))try{u()}catch(m){s=m instanceof Cr?m.errors:[m]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var h=fn(d),p=h.next();!p.done;p=h.next()){var b=p.value;try{va(b)}catch(m){s=s??[],m instanceof Cr?s=Vn(Vn([],pn(s)),pn(m.errors)):s.push(m)}}}catch(m){i={error:m}}finally{try{p&&!p.done&&(r=h.return)&&r.call(h)}finally{if(i)throw i.error}}}if(s)throw new Cr(s)}},n.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)va(e);else{if(e instanceof n){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}},n.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},n.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},n.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Mi(t,e)},n.prototype.remove=function(e){var t=this._finalizers;t&&Mi(t,e),e instanceof n&&e._removeParent(this)},n.EMPTY=(function(){var e=new n;return e.closed=!0,e})(),n})(),Wl=Hn.EMPTY;function Hl(n){return n instanceof Hn||n&&"closed"in n&&X(n.remove)&&X(n.add)&&X(n.unsubscribe)}function va(n){X(n)?n():n.unsubscribe()}var lg={Promise:void 0},ug={setTimeout:function(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return setTimeout.apply(void 0,Vn([n,e],pn(t)))},clearTimeout:function(n){return clearTimeout(n)},delegate:void 0};function Kl(n){ug.setTimeout(function(){throw n})}function Di(){}function mi(n){n()}var js=(function(n){pt(e,n);function e(t){var i=n.call(this)||this;return i.isStopped=!1,t?(i.destination=t,Hl(t)&&t.add(i)):i.destination=fg,i}return e.create=function(t,i,r){return new ns(t,i,r)},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,n.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e})(Hn),dg=(function(){function n(e){this.partialObserver=e}return n.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(i){Zn(i)}},n.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(i){Zn(i)}else Zn(e)},n.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){Zn(t)}},n})(),ns=(function(n){pt(e,n);function e(t,i,r){var s=n.call(this)||this,a;return X(t)||!t?a={next:t??void 0,error:i??void 0,complete:r??void 0}:a=t,s.destination=new dg(a),s}return e})(js);function Zn(n){Kl(n)}function hg(n){throw n}var fg={closed:!0,next:Di,error:hg,complete:Di},Bs=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function Vs(n){return n}function pg(n){return n.length===0?Vs:n.length===1?n[0]:function(e){return n.reduce(function(t,i){return i(t)},e)}}var de=(function(){function n(e){e&&(this._subscribe=e)}return n.prototype.lift=function(e){var t=new n;return t.source=this,t.operator=e,t},n.prototype.subscribe=function(e,t,i){var r=this,s=gg(e)?e:new ns(e,t,i);return mi(function(){var a=r,o=a.operator,c=a.source;s.add(o?o.call(s,c):c?r._subscribe(s):r._trySubscribe(s))}),s},n.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},n.prototype.forEach=function(e,t){var i=this;return t=ba(t),new t(function(r,s){var a=new ns({next:function(o){try{e(o)}catch(c){s(c),a.unsubscribe()}},error:s,complete:r});i.subscribe(a)})},n.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},n.prototype[Bs]=function(){return this},n.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return pg(e)(this)},n.prototype.toPromise=function(e){var t=this;return e=ba(e),new e(function(i,r){var s;t.subscribe(function(a){return s=a},function(a){return r(a)},function(){return i(s)})})},n.create=function(e){return new n(e)},n})();function ba(n){var e;return(e=n??lg.Promise)!==null&&e!==void 0?e:Promise}function mg(n){return n&&X(n.next)&&X(n.error)&&X(n.complete)}function gg(n){return n&&n instanceof js||mg(n)&&Hl(n)}function vg(n){return X(n?.lift)}function Je(n){return function(e){if(vg(e))return e.lift(function(t){try{return n(t,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function ze(n,e,t,i,r){return new bg(n,e,t,i,r)}var bg=(function(n){pt(e,n);function e(t,i,r,s,a,o){var c=n.call(this,t)||this;return c.onFinalize=a,c.shouldUnsubscribe=o,c._next=i?function(l){try{i(l)}catch(u){t.error(u)}}:n.prototype._next,c._error=s?function(l){try{s(l)}catch(u){t.error(u)}finally{this.unsubscribe()}}:n.prototype._error,c._complete=r?function(){try{r()}catch(l){t.error(l)}finally{this.unsubscribe()}}:n.prototype._complete,c}return e.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;n.prototype.unsubscribe.call(this),!i&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},e})(js),yg=Fs(function(n){return function(){n(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Kt=(function(n){pt(e,n);function e(){var t=n.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var i=new ya(this,this);return i.operator=t,i},e.prototype._throwIfClosed=function(){if(this.closed)throw new yg},e.prototype.next=function(t){var i=this;mi(function(){var r,s;if(i._throwIfClosed(),!i.isStopped){i.currentObservers||(i.currentObservers=Array.from(i.observers));try{for(var a=fn(i.currentObservers),o=a.next();!o.done;o=a.next()){var c=o.value;c.next(t)}}catch(l){r={error:l}}finally{try{o&&!o.done&&(s=a.return)&&s.call(a)}finally{if(r)throw r.error}}}})},e.prototype.error=function(t){var i=this;mi(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=t;for(var r=i.observers;r.length;)r.shift().error(t)}})},e.prototype.complete=function(){var t=this;mi(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var i=t.observers;i.length;)i.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),n.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var i=this,r=this,s=r.hasError,a=r.isStopped,o=r.observers;return s||a?Wl:(this.currentObservers=null,o.push(t),new Hn(function(){i.currentObservers=null,Mi(o,t)}))},e.prototype._checkFinalizedStatuses=function(t){var i=this,r=i.hasError,s=i.thrownError,a=i.isStopped;r?t.error(s):a&&t.complete()},e.prototype.asObservable=function(){var t=new de;return t.source=this,t},e.create=function(t,i){return new ya(t,i)},e})(de),ya=(function(n){pt(e,n);function e(t,i){var r=n.call(this)||this;return r.destination=t,r.source=i,r}return e.prototype.next=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.next)===null||r===void 0||r.call(i,t)},e.prototype.error=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.error)===null||r===void 0||r.call(i,t)},e.prototype.complete=function(){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||i===void 0||i.call(t)},e.prototype._subscribe=function(t){var i,r;return(r=(i=this.source)===null||i===void 0?void 0:i.subscribe(t))!==null&&r!==void 0?r:Wl},e})(Kt),zl=(function(n){pt(e,n);function e(t){var i=n.call(this)||this;return i._value=t,i}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(t){var i=n.prototype._subscribe.call(this,t);return!i.closed&&t.next(this._value),i},e.prototype.getValue=function(){var t=this,i=t.hasError,r=t.thrownError,s=t._value;if(i)throw r;return this._throwIfClosed(),s},e.prototype.next=function(t){n.prototype.next.call(this,this._value=t)},e})(Kt),kg={now:function(){return Date.now()}},Sg=(function(n){pt(e,n);function e(t,i){return n.call(this)||this}return e.prototype.schedule=function(t,i){return this},e})(Hn),ka={setInterval:function(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return setInterval.apply(void 0,Vn([n,e],pn(t)))},clearInterval:function(n){return clearInterval(n)},delegate:void 0},Tg=(function(n){pt(e,n);function e(t,i){var r=n.call(this,t,i)||this;return r.scheduler=t,r.work=i,r.pending=!1,r}return e.prototype.schedule=function(t,i){var r;if(i===void 0&&(i=0),this.closed)return this;this.state=t;var s=this.id,a=this.scheduler;return s!=null&&(this.id=this.recycleAsyncId(a,s,i)),this.pending=!0,this.delay=i,this.id=(r=this.id)!==null&&r!==void 0?r:this.requestAsyncId(a,this.id,i),this},e.prototype.requestAsyncId=function(t,i,r){return r===void 0&&(r=0),ka.setInterval(t.flush.bind(t,this),r)},e.prototype.recycleAsyncId=function(t,i,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return i;i!=null&&ka.clearInterval(i)},e.prototype.execute=function(t,i){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(t,i);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,i){var r=!1,s;try{this.work(t)}catch(a){r=!0,s=a||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),s},e.prototype.unsubscribe=function(){if(!this.closed){var t=this,i=t.id,r=t.scheduler,s=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,Mi(s,this),i!=null&&(this.id=this.recycleAsyncId(r,i,null)),this.delay=null,n.prototype.unsubscribe.call(this)}},e})(Sg),Sa=(function(){function n(e,t){t===void 0&&(t=n.now),this.schedulerActionCtor=e,this.now=t}return n.prototype.schedule=function(e,t,i){return t===void 0&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},n.now=kg.now,n})(),Cg=(function(n){pt(e,n);function e(t,i){i===void 0&&(i=Sa.now);var r=n.call(this,t,i)||this;return r.actions=[],r._active=!1,r}return e.prototype.flush=function(t){var i=this.actions;if(this._active){i.push(t);return}var r;this._active=!0;do if(r=t.execute(t.state,t.delay))break;while(t=i.shift());if(this._active=!1,r){for(;t=i.shift();)t.unsubscribe();throw r}},e})(Sa),Eg=new Cg(Tg);function wg(n){return n&&X(n.schedule)}function Pg(n){return n[n.length-1]}function qs(n){return wg(Pg(n))?n.pop():void 0}var Ws=(function(n){return n&&typeof n.length=="number"&&typeof n!="function"});function Gl(n){return X(n?.then)}function Jl(n){return X(n[Bs])}function $l(n){return Symbol.asyncIterator&&X(n?.[Symbol.asyncIterator])}function Ql(n){return new TypeError("You provided "+(n!==null&&typeof n=="object"?"an invalid object":"'"+n+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Rg(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Yl=Rg();function Xl(n){return X(n?.[Yl])}function Zl(n){return ag(this,arguments,function(){var e,t,i,r;return ql(this,function(s){switch(s.label){case 0:e=n.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,ln(e.read())];case 3:return t=s.sent(),i=t.value,r=t.done,r?[4,ln(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,ln(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function eu(n){return X(n?.getReader)}function mt(n){if(n instanceof de)return n;if(n!=null){if(Jl(n))return _g(n);if(Ws(n))return Ig(n);if(Gl(n))return xg(n);if($l(n))return tu(n);if(Xl(n))return Og(n);if(eu(n))return Mg(n)}throw Ql(n)}function _g(n){return new de(function(e){var t=n[Bs]();if(X(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Ig(n){return new de(function(e){for(var t=0;t<n.length&&!e.closed;t++)e.next(n[t]);e.complete()})}function xg(n){return new de(function(e){n.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,Kl)})}function Og(n){return new de(function(e){var t,i;try{for(var r=fn(n),s=r.next();!s.done;s=r.next()){var a=s.value;if(e.next(a),e.closed)return}}catch(o){t={error:o}}finally{try{s&&!s.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}e.complete()})}function tu(n){return new de(function(e){Dg(n,e).catch(function(t){return e.error(t)})})}function Mg(n){return tu(Zl(n))}function Dg(n,e){var t,i,r,s;return og(this,void 0,void 0,function(){var a,o;return ql(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),t=cg(n),c.label=1;case 1:return[4,t.next()];case 2:if(i=c.sent(),!!i.done)return[3,4];if(a=i.value,e.next(a),e.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return o=c.sent(),r={error:o},[3,11];case 6:return c.trys.push([6,,9,10]),i&&!i.done&&(s=t.return)?[4,s.call(t)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function _t(n,e,t,i,r){i===void 0&&(i=0),r===void 0&&(r=!1);var s=e.schedule(function(){t(),r?n.add(this.schedule(null,i)):this.unsubscribe()},i);if(n.add(s),!r)return s}function nu(n,e){return e===void 0&&(e=0),Je(function(t,i){t.subscribe(ze(i,function(r){return _t(i,n,function(){return i.next(r)},e)},function(){return _t(i,n,function(){return i.complete()},e)},function(r){return _t(i,n,function(){return i.error(r)},e)}))})}function iu(n,e){return e===void 0&&(e=0),Je(function(t,i){i.add(n.schedule(function(){return t.subscribe(i)},e))})}function Ag(n,e){return mt(n).pipe(iu(e),nu(e))}function Lg(n,e){return mt(n).pipe(iu(e),nu(e))}function Ng(n,e){return new de(function(t){var i=0;return e.schedule(function(){i===n.length?t.complete():(t.next(n[i++]),t.closed||this.schedule())})})}function Ug(n,e){return new de(function(t){var i;return _t(t,e,function(){i=n[Yl](),_t(t,e,function(){var r,s,a;try{r=i.next(),s=r.value,a=r.done}catch(o){t.error(o);return}a?t.complete():t.next(s)},0,!0)}),function(){return X(i?.return)&&i.return()}})}function ru(n,e){if(!n)throw new Error("Iterable cannot be null");return new de(function(t){_t(t,e,function(){var i=n[Symbol.asyncIterator]();_t(t,e,function(){i.next().then(function(r){r.done?t.complete():t.next(r.value)})},0,!0)})})}function Fg(n,e){return ru(Zl(n),e)}function jg(n,e){if(n!=null){if(Jl(n))return Ag(n,e);if(Ws(n))return Ng(n,e);if(Gl(n))return Lg(n,e);if($l(n))return ru(n,e);if(Xl(n))return Ug(n,e);if(eu(n))return Fg(n,e)}throw Ql(n)}function Hs(n,e){return e?jg(n,e):mt(n)}function Ta(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=qs(n);return Hs(n,t)}function Bg(n){return n instanceof Date&&!isNaN(n)}var Vg=Fs(function(n){return function(e){e===void 0&&(e=null),n(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=e}});function qg(n,e){var t=Bg(n)?{first:n}:typeof n=="number"?{each:n}:n,i=t.first,r=t.each,s=t.with,a=s===void 0?Wg:s,o=t.scheduler,c=o===void 0?Eg:o,l=t.meta,u=l===void 0?null:l;if(i==null&&r==null)throw new TypeError("No timeout provided.");return Je(function(d,h){var p,b,m=null,T=0,S=function(P){b=_t(h,c,function(){try{p.unsubscribe(),mt(a({meta:u,lastValue:m,seen:T})).subscribe(h)}catch(M){h.error(M)}},P)};p=d.subscribe(ze(h,function(P){b?.unsubscribe(),T++,h.next(m=P),r>0&&S(r)},void 0,void 0,function(){b!=null&&b.closed||b==null||b.unsubscribe(),m=null})),!T&&S(i!=null?typeof i=="number"?i:+i-c.now():r)})}function Wg(n){throw new Vg(n)}function ae(n,e){return Je(function(t,i){var r=0;t.subscribe(ze(i,function(s){i.next(n.call(e,s,r++))}))})}var Hg=Array.isArray;function Kg(n,e){return Hg(e)?n.apply(void 0,Vn([],pn(e))):n(e)}function zg(n){return ae(function(e){return Kg(n,e)})}function Gg(n,e,t,i,r,s,a,o){var c=[],l=0,u=0,d=!1,h=function(){d&&!c.length&&!l&&e.complete()},p=function(m){return l<i?b(m):c.push(m)},b=function(m){l++;var T=!1;mt(t(m,u++)).subscribe(ze(e,function(S){e.next(S)},function(){T=!0},void 0,function(){if(T)try{l--;for(var S=function(){var P=c.shift();a||b(P)};c.length&&l<i;)S();h()}catch(P){e.error(P)}}))};return n.subscribe(ze(e,p,function(){d=!0,h()})),function(){}}function Ks(n,e,t){return t===void 0&&(t=1/0),X(e)?Ks(function(i,r){return ae(function(s,a){return e(i,s,r,a)})(mt(n(i,r)))},t):(typeof e=="number"&&(t=e),Je(function(i,r){return Gg(i,r,n,t)}))}function Jg(n){return Ks(Vs,n)}function $g(){return Jg(1)}function Ai(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return $g()(Hs(n,qs(n)))}var Qg=["addListener","removeListener"],Yg=["addEventListener","removeEventListener"],Xg=["on","off"];function is(n,e,t,i){if(X(t)&&(i=t,t=void 0),i)return is(n,e,t).pipe(zg(i));var r=pn(tv(n)?Yg.map(function(o){return function(c){return n[o](e,c,t)}}):Zg(n)?Qg.map(Ca(n,e)):ev(n)?Xg.map(Ca(n,e)):[],2),s=r[0],a=r[1];if(!s&&Ws(n))return Ks(function(o){return is(o,e,t)})(mt(n));if(!s)throw new TypeError("Invalid event target");return new de(function(o){var c=function(){for(var l=[],u=0;u<arguments.length;u++)l[u]=arguments[u];return o.next(1<l.length?l:l[0])};return s(c),function(){return a(c)}})}function Ca(n,e){return function(t){return function(i){return n[t](e,i)}}}function Zg(n){return X(n.addListener)&&X(n.removeListener)}function ev(n){return X(n.on)&&X(n.off)}function tv(n){return X(n.addEventListener)&&X(n.removeEventListener)}function Yi(n,e){return Je(function(t,i){var r=0;t.subscribe(ze(i,function(s){return n.call(e,s,r++)&&i.next(s)}))})}function nv(n,e,t,i,r){return function(s,a){var o=t,c=e,l=0;s.subscribe(ze(a,function(u){var d=l++;c=o?n(c,u,d):(o=!0,u),a.next(c)},r))}}function iv(n,e){return e===void 0&&(e=Vs),n=n??rv,Je(function(t,i){var r,s=!0;t.subscribe(ze(i,function(a){var o=e(a);(s||!n(r,o))&&(s=!1,r=o,i.next(a))}))})}function rv(n,e){return n===e}function Ea(n,e){return Je(nv(n,e,arguments.length>=2,!0))}function sv(n){return Je(function(e,t){var i=!1,r=ze(t,function(){r?.unsubscribe(),i=!0},Di);mt(n).subscribe(r),e.subscribe(ze(t,function(s){return i&&t.next(s)}))})}function $e(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=qs(n);return Je(function(i,r){(t?Ai(n,i,t):Ai(n,i)).subscribe(r)})}function wa(n){return Je(function(e,t){mt(n).subscribe(ze(t,function(){return t.complete()},Di)),!t.closed&&e.subscribe(t)})}var ov=Object.defineProperty,av=Object.defineProperties,cv=Object.getOwnPropertyDescriptors,Pa=Object.getOwnPropertySymbols,lv=Object.prototype.hasOwnProperty,uv=Object.prototype.propertyIsEnumerable,Ra=(n,e,t)=>e in n?ov(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Tt=(n,e)=>{for(var t in e||(e={}))lv.call(e,t)&&Ra(n,t,e[t]);if(Pa)for(var t of Pa(e))uv.call(e,t)&&Ra(n,t,e[t]);return n},wn=(n,e)=>av(n,cv(e)),Ge=(n,e,t)=>new Promise((i,r)=>{var s=c=>{try{o(t.next(c))}catch(l){r(l)}},a=c=>{try{o(t.throw(c))}catch(l){r(l)}},o=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,a);o((t=t.apply(n,e)).next())}),su="lk";function ue(n){return typeof n>"u"?!1:dv(n)||hv(n)}function dv(n){var e;return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&n.hasOwnProperty("track")&&typeof((e=n.publication)==null?void 0:e.track)<"u":!1}function hv(n){return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&n.hasOwnProperty("publication")&&typeof n.publication<"u":!1}function qn(n){return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&typeof n.publication>"u":!1}function pe(n){if(typeof n=="string"||typeof n=="number")return`${n}`;if(qn(n))return`${n.participant.identity}_${n.source}_placeholder`;if(ue(n))return`${n.participant.identity}_${n.publication.source}_${n.publication.trackSid}`;throw new Error(`Can't generate a id for the given track reference: ${n}`)}function fv(n,e){return n===void 0||e===void 0?!1:ue(n)&&ue(e)?n.publication.trackSid===e.publication.trackSid:pe(n)===pe(e)}function ou(n,e){return typeof e>"u"?!1:ue(n)?e.some(t=>t.participant.identity===n.participant.identity&&ue(t)&&t.publication.trackSid===n.publication.trackSid):qn(n)?e.some(t=>t.participant.identity===n.participant.identity&&qn(t)&&t.source===n.source):!1}function pv(n,e){return qn(n)&&ue(e)&&e.participant.identity===n.participant.identity&&e.source===n.source}function mv(){const n=document.createElement("p");n.style.width="100%",n.style.height="200px";const e=document.createElement("div");e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.visibility="hidden",e.style.width="200px",e.style.height="150px",e.style.overflow="hidden",e.appendChild(n),document.body.appendChild(e);const t=n.offsetWidth;e.style.overflow="scroll";let i=n.offsetWidth;return t===i&&(i=e.clientWidth),document.body.removeChild(e),t-i}function gv(){return typeof document<"u"}function vv(n,e,t){return Ym(n,e,()=>Ge(this,null,function*(){const{x:i,y:r}=yield tg(n,e,{placement:"top",middleware:[Xm(6),eg(),Zm({padding:5})]});t?.(i,r)}))}function bv(n,e){return!n.contains(e.target)}var yv=[_.ConnectionStateChanged,_.RoomMetadataChanged,_.ActiveSpeakersChanged,_.ConnectionQualityChanged,_.ParticipantConnected,_.ParticipantDisconnected,_.ParticipantPermissionsChanged,_.ParticipantMetadataChanged,_.ParticipantNameChanged,_.ParticipantAttributesChanged,_.TrackMuted,_.TrackUnmuted,_.TrackPublished,_.TrackUnpublished,_.TrackStreamStateChanged,_.TrackSubscriptionFailed,_.TrackSubscriptionPermissionChanged,_.TrackSubscriptionStatusChanged],kv=[...yv,_.LocalTrackPublished,_.LocalTrackUnpublished];O.TrackPublished,O.TrackUnpublished,O.TrackMuted,O.TrackUnmuted,O.TrackStreamStateChanged,O.TrackSubscribed,O.TrackUnsubscribed,O.TrackSubscriptionPermissionChanged,O.TrackSubscriptionFailed,O.LocalTrackPublished,O.LocalTrackUnpublished;var Sv=[O.ConnectionQualityChanged,O.IsSpeakingChanged,O.ParticipantMetadataChanged,O.ParticipantPermissionsChanged,O.TrackMuted,O.TrackUnmuted,O.TrackPublished,O.TrackUnpublished,O.TrackStreamStateChanged,O.TrackSubscriptionFailed,O.TrackSubscriptionPermissionChanged,O.TrackSubscriptionStatusChanged];[...Sv,O.LocalTrackPublished,O.LocalTrackUnpublished];var B=sg.getLogger("lk-components-js");B.setDefaultLevel("WARN");var Tv=[{columns:1,rows:1},{columns:1,rows:2,orientation:"portrait"},{columns:2,rows:1,orientation:"landscape"},{columns:2,rows:2,minWidth:560},{columns:3,rows:3,minWidth:700},{columns:4,rows:4,minWidth:960},{columns:5,rows:5,minWidth:1100}];function au(n,e,t,i){if(n.length<1)throw new Error("At least one grid layout definition must be provided.");const r=Cv(n);if(t<=0||i<=0)return r[0];let s=0;const a=t/i>1?"landscape":"portrait";let o=r.find((c,l,u)=>{s=l;const d=u.findIndex((h,p)=>{const b=!h.orientation||h.orientation===a,m=p>l,T=h.maxTiles===c.maxTiles;return m&&T&&b})!==-1;return c.maxTiles>=e&&!d});if(o===void 0)if(o=r[r.length-1],o)B.warn(`No layout found for: participantCount: ${e}, width/height: ${t}/${i} fallback to biggest available layout (${o}).`);else throw new Error("No layout or fallback layout found.");if((t<o.minWidth||i<o.minHeight)&&s>0){const c=r[s-1];o=au(r.slice(0,s),c.maxTiles,t,i)}return o}function Cv(n){return[...n].map(e=>{var t,i;return{name:`${e.columns}x${e.rows}`,columns:e.columns,rows:e.rows,maxTiles:e.columns*e.rows,minWidth:(t=e.minWidth)!=null?t:0,minHeight:(i=e.minHeight)!=null?i:0,orientation:e.orientation}}).sort((e,t)=>e.maxTiles!==t.maxTiles?e.maxTiles-t.maxTiles:e.minWidth!==0||t.minWidth!==0?e.minWidth-t.minWidth:e.minHeight!==0||t.minHeight!==0?e.minHeight-t.minHeight:0)}function Ev(){return typeof navigator<"u"&&navigator.mediaDevices&&!!navigator.mediaDevices.getDisplayMedia}var cu=(n=>(n.AgentState="lk.agent.state",n.PublishOnBehalf="lk.publish_on_behalf",n.TranscriptionFinal="lk.transcription_final",n.TranscriptionSegmentId="lk.segment_id",n.TranscribedTrackId="lk.transcribed_track_id",n))(cu||{}),lu=[],uu={showChat:!1,unreadMessages:0,showSettings:!1};function du(n){return typeof n=="object"}function hu(n){return Array.isArray(n)&&n.filter(du).length>0}function wv(n,e){return e.audioLevel-n.audioLevel}function Pv(n,e){return n.isSpeaking===e.isSpeaking?0:n.isSpeaking?-1:1}function Rv(n,e){var t,i,r,s;return n.lastSpokeAt!==void 0||e.lastSpokeAt!==void 0?((i=(t=e.lastSpokeAt)==null?void 0:t.getTime())!=null?i:0)-((s=(r=n.lastSpokeAt)==null?void 0:r.getTime())!=null?s:0):0}function rs(n,e){var t,i,r,s;return((i=(t=n.joinedAt)==null?void 0:t.getTime())!=null?i:0)-((s=(r=e.joinedAt)==null?void 0:r.getTime())!=null?s:0)}function _v(n,e){return ue(n)?ue(e)?0:-1:ue(e)?1:0}function Iv(n,e){const t=n.participant.isCameraEnabled,i=e.participant.isCameraEnabled;return t!==i?t?-1:1:0}function xv(n){const e=[],t=[],i=[],r=[];n.forEach(o=>{o.participant.isLocal&&o.source===E.Source.Camera?e.push(o):o.source===E.Source.ScreenShare?t.push(o):o.source===E.Source.Camera?i.push(o):r.push(o)});const s=Ov(t),a=Mv(i);return[...e,...s,...a,...r]}function Ov(n){const e=[],t=[];return n.forEach(i=>{i.participant.isLocal?e.push(i):t.push(i)}),e.sort((i,r)=>rs(i.participant,r.participant)),t.sort((i,r)=>rs(i.participant,r.participant)),[...t,...e]}function Mv(n){const e=[],t=[];return n.forEach(i=>{i.participant.isLocal?e.push(i):t.push(i)}),t.sort((i,r)=>i.participant.isSpeaking&&r.participant.isSpeaking?wv(i.participant,r.participant):i.participant.isSpeaking!==r.participant.isSpeaking?Pv(i.participant,r.participant):i.participant.lastSpokeAt!==r.participant.lastSpokeAt?Rv(i.participant,r.participant):ue(i)!==ue(r)?_v(i,r):i.participant.isCameraEnabled!==r.participant.isCameraEnabled?Iv(i,r):rs(i.participant,r.participant)),[...e,...t]}function Dv(n,e){return n.reduce((t,i,r)=>r%e===0?[...t,[i]]:[...t.slice(0,-1),[...t.slice(-1)[0],i]],[])}function _a(n,e){const t=Math.max(n.length,e.length);return new Array(t).fill([]).map((i,r)=>[n[r],e[r]])}function Li(n,e,t){return n.filter(i=>!e.map(r=>t(r)).includes(t(i)))}function ss(n){return n.map(e=>typeof e=="string"||typeof e=="number"?`${e}`:pe(e))}function Av(n,e){return{dropped:Li(n,e,pe),added:Li(e,n,pe)}}function Lv(n){return n.added.length!==0||n.dropped.length!==0}function os(n,e){const t=e.findIndex(i=>pe(i)===pe(n));if(t===-1)throw new Error(`Element not part of the array: ${pe(n)} not in ${ss(e)}`);return t}function Nv(n,e,t){const i=os(n,t),r=os(e,t);return t.splice(i,1,e),t.splice(r,1,n),t}function Uv(n,e){const t=os(n,e);return e.splice(t,1),e}function Fv(n,e){return[...e,n]}function Er(n,e){return Dv(n,e)}function jv(n,e,t){let i=Bv(n,e);if(i.length<e.length){const a=Li(e,i,pe);i=[...i,...a]}const r=Er(i,t),s=Er(e,t);if(_a(r,s).forEach(([a,o],c)=>{if(a&&o){const l=Er(i,t)[c],u=Av(l,o);Lv(u)&&(B.debug(`Detected visual changes on page: ${c}, current: ${ss(a)}, next: ${ss(o)}`,{changes:u}),u.added.length===u.dropped.length&&_a(u.added,u.dropped).forEach(([d,h])=>{if(d&&h)i=Nv(d,h,i);else throw new Error(`For a swap action we need a addition and a removal one is missing: ${d}, ${h}`)}),u.added.length===0&&u.dropped.length>0&&u.dropped.forEach(d=>{i=Uv(d,i)}),u.added.length>0&&u.dropped.length===0&&u.added.forEach(d=>{i=Fv(d,i)}))}}),i.length>e.length){const a=Li(i,e,pe);i=i.filter(o=>!a.map(pe).includes(pe(o)))}return i}function Bv(n,e){return n.map(t=>e.find(r=>pe(t)===pe(r)||typeof t!="number"&&qn(t)&&ue(r)&&pv(t,r))??t)}function _e(n){return`${su}-${n}`}function Vv(n){const e=as(n),t=fu(n.participant).pipe(ae(()=>as(n)),$e(e));return{className:_e(n.source===E.Source.Camera||n.source===E.Source.ScreenShare?"participant-media-video":"participant-media-audio"),trackObserver:t}}function as(n){if(ue(n))return n.publication;{const{source:e,name:t,participant:i}=n;if(e&&t)return i.getTrackPublications().find(r=>r.source===e&&r.trackName===t);if(t)return i.getTrackPublicationByName(t);if(e)return i.getTrackPublication(e);throw new Error("At least one of source and name needs to be defined")}}function zs(n,...e){return new de(t=>{const i=()=>{t.next(n)};return e.forEach(r=>{n.on(r,i)}),()=>{e.forEach(r=>{n.off(r,i)})}}).pipe($e(n))}function Xi(n,e){return new de(t=>{const i=(...r)=>{t.next(r)};return n.on(e,i),()=>{n.off(e,i)}})}function qv(n){return Xi(n,_.ConnectionStateChanged).pipe(ae(([e])=>e),$e(n.state))}function Wv(n,e,t=!0){const i=new de(s=>{ft.getLocalDevices(n,t).then(a=>{s.next(a),s.complete()}).catch(a=>{e?.(a),s.next([]),s.complete()})}),r=new de(s=>{var a;const o=()=>Ge(this,null,function*(){try{const c=yield ft.getLocalDevices(n,t);s.next(c)}catch(c){e?.(c)}});if(typeof window<"u"){if(!window.isSecureContext)throw new Error("Accessing media devices is available only in secure contexts (HTTPS and localhost), in some or all supporting browsers. See: https://developer.mozilla.org/en-US/docs/Web/API/Navigator/mediaDevices");(a=navigator?.mediaDevices)==null||a.addEventListener("devicechange",o)}return()=>{var c;(c=navigator?.mediaDevices)==null||c.removeEventListener("devicechange",o)}});return Ai(i,r)}function Hv(n){return Xi(n,_.DataReceived)}function Kv(n){return zs(n,_.AudioPlaybackStatusChanged).pipe(ae(e=>({canPlayAudio:e.canPlaybackAudio})))}function zv(n){return zs(n,_.VideoPlaybackStatusChanged).pipe(ae(e=>({canPlayVideo:e.canPlaybackVideo})))}function Gv(n,e){return Xi(n,_.ActiveDeviceChanged).pipe(Yi(([t])=>t===e),ae(([t,i])=>(B.debug("activeDeviceObservable | RoomEvent.ActiveDeviceChanged",{kind:t,deviceId:i}),i)))}function Jv(n,e){return Xi(n,_.ParticipantEncryptionStatusChanged).pipe(Yi(([,t])=>e?.identity===t?.identity||!t&&e?.identity===n.localParticipant.identity),ae(([t])=>t),$e(e!=null&&e.isLocal?e.isE2EEEnabled:!!(e!=null&&e.isEncrypted)))}function Gs(n,...e){return new de(t=>{const i=()=>{t.next(n)};return e.forEach(r=>{n.on(r,i)}),()=>{e.forEach(r=>{n.off(r,i)})}}).pipe($e(n))}function fu(n){return Gs(n,O.TrackMuted,O.TrackUnmuted,O.ParticipantPermissionsChanged,O.TrackPublished,O.TrackUnpublished,O.LocalTrackPublished,O.LocalTrackUnpublished,O.MediaDevicesError,O.TrackSubscriptionStatusChanged).pipe(ae(e=>{const{isMicrophoneEnabled:t,isCameraEnabled:i,isScreenShareEnabled:r}=e,s=e.getTrackPublication(E.Source.Microphone),a=e.getTrackPublication(E.Source.Camera);return{isCameraEnabled:i,isMicrophoneEnabled:t,isScreenShareEnabled:r,cameraTrack:a,microphoneTrack:s,participant:e}}))}function $v(n){return n?Gs(n,O.ParticipantMetadataChanged,O.ParticipantNameChanged).pipe(ae(({name:e,identity:t,metadata:i})=>({name:e,identity:t,metadata:i})),$e({name:n.name,identity:n.identity,metadata:n.metadata})):void 0}function Qv(n){return Js(n,O.ConnectionQualityChanged).pipe(ae(([e])=>e),$e(n.connectionQuality))}function Js(n,e){return new de(t=>{const i=(...r)=>{t.next(r)};return n.on(e,i),()=>{n.off(e,i)}})}function pu(n){var e,t,i,r;return Gs(n.participant,O.TrackMuted,O.TrackUnmuted,O.TrackSubscribed,O.TrackUnsubscribed,O.LocalTrackPublished,O.LocalTrackUnpublished).pipe(ae(s=>{var a,o;const c=(a=n.publication)!=null?a:s.getTrackPublication(n.source);return(o=c?.isMuted)!=null?o:!0}),$e((r=(i=(e=n.publication)==null?void 0:e.isMuted)!=null?i:(t=n.participant.getTrackPublication(n.source))==null?void 0:t.isMuted)!=null?r:!0))}function Yv(n){return Js(n,O.IsSpeakingChanged).pipe(ae(([e])=>e))}function Xv(n){return Js(n,O.ParticipantPermissionsChanged).pipe(ae(()=>n.permissions),$e(n.permissions))}function Zv(n,e,t,i,r){const{localParticipant:s}=e,a=(u,d)=>{let h=!1;switch(u){case E.Source.Camera:h=d.isCameraEnabled;break;case E.Source.Microphone:h=d.isMicrophoneEnabled;break;case E.Source.ScreenShare:h=d.isScreenShareEnabled;break}return h},o=fu(s).pipe(ae(u=>a(n,u.participant)),$e(a(n,s))),c=new Kt,l=(u,d)=>Ge(this,null,function*(){try{switch(d??(d=t),c.next(!0),n){case E.Source.Camera:return yield s.setCameraEnabled(u??!s.isCameraEnabled,d,i),s.isCameraEnabled;case E.Source.Microphone:return yield s.setMicrophoneEnabled(u??!s.isMicrophoneEnabled,d,i),s.isMicrophoneEnabled;case E.Source.ScreenShare:return yield s.setScreenShareEnabled(u??!s.isScreenShareEnabled,d,i),s.isScreenShareEnabled;default:throw new TypeError("Tried to toggle unsupported source")}}catch(h){if(r&&h instanceof Error){r?.(h);return}else throw h}finally{c.next(!1)}});return{className:_e("button"),toggle:l,enabledObserver:o,pendingObserver:c.asObservable()}}function e0(){let n=!1;const e=new Kt,t=new Kt,i=r=>Ge(this,null,function*(){t.next(!0),n=r??!n,e.next(n),t.next(!1)});return{className:_e("button"),toggle:i,enabledObserver:e.asObservable(),pendingObserver:t.asObservable()}}function t0(n,e,t){const i=new zl(void 0),r=Gv(e,n),s=(a,...o)=>Ge(this,[a,...o],function*(c,l={}){var u,d,h;if(e){const p=Se();if(n==="audiooutput"&&(p?.name==="Safari"||p?.os==="iOS")){B.warn("Switching audio output device is not supported on Safari and iOS.");return}B.debug(`Switching active device of kind "${n}" with id ${c}.`),yield e.switchActiveDevice(n,c,l.exact);const b=(u=e.getActiveDevice(n))!=null?u:c;b!==c&&c!=="default"&&B.info(`We tried to select the device with id (${c}), but the browser decided to select the device with id (${b}) instead.`);let m;n==="audioinput"?m=(d=e.localParticipant.getTrackPublication(E.Source.Microphone))==null?void 0:d.track:n==="videoinput"&&(m=(h=e.localParticipant.getTrackPublication(E.Source.Camera))==null?void 0:h.track);const T=c==="default"&&!m||c==="default"&&m?.mediaStreamTrack.label.startsWith("Default");i.next(T?c:b)}});return{className:_e("media-device-select"),activeDeviceObservable:r,setActiveMediaDevice:s}}function n0(n){const e=t=>{n.disconnect(t)};return{className:_e("disconnect-button"),disconnect:e}}function i0(n){const e=_e("connection-quality"),t=Qv(n);return{className:e,connectionQualityObserver:t}}function r0(n){let e="track-muted-indicator-camera";switch(n.source){case E.Source.Camera:e="track-muted-indicator-camera";break;case E.Source.Microphone:e="track-muted-indicator-microphone";break}const t=_e(e),i=pu(n);return{className:t,mediaMutedObserver:i}}function s0(n){return{className:"lk-participant-name",infoObserver:$v(n)}}function o0(){return{className:_e("participant-tile")}}var a0={CHAT:"lk.chat"},c0={CHAT:"lk-chat-topic"};function mu(n,e){return Ge(this,arguments,function*(t,i,r={}){const{reliable:s,destinationIdentities:a,topic:o}=r;yield t.publishData(i,{destinationIdentities:a,topic:o,reliable:s})})}function l0(n,e,t){const i=Array.isArray(e)?e:[e],r=Hv(n).pipe(Yi(([,,,o])=>e===void 0||o!==void 0&&i.includes(o)),ae(([o,c,,l])=>({payload:o,topic:l,from:c})));let s;const a=new de(o=>{s=o});return{messageObservable:r,isSendingObservable:a,send:(o,...c)=>Ge(this,[o,...c],function*(l,u={}){s.next(!0);try{yield mu(n.localParticipant,l,Tt({topic:i[0]},u))}finally{s.next(!1)}})}}var ei=new WeakMap;function u0(n){return n.ignoreLegacy==!0}var d0=n=>JSON.parse(new TextDecoder().decode(n)),h0=n=>new TextEncoder().encode(JSON.stringify(n));function f0(n,e){var t,i,r,s,a,o;const c=()=>{var g,y,C;return((g=n.serverInfo)==null?void 0:g.edition)===1||!!((y=n.serverInfo)!=null&&y.version)&&We((C=n.serverInfo)==null?void 0:C.version,"1.8.2")>0},l=new Kt,u=(t=e?.channelTopic)!=null?t:a0.CHAT,d=(i=e?.channelTopic)!=null?i:c0.CHAT;let h=!1;ei.has(n)||(h=!0);const p=(r=ei.get(n))!=null?r:new Map,b=(s=p.get(u))!=null?s:new Kt;p.set(u,b),ei.set(n,p);const m=(a=e?.messageDecoder)!=null?a:d0;if(h){n.registerTextStreamHandler(u,(y,C)=>Ge(this,null,function*(){const{id:x,timestamp:R}=y.info;Hs(y).pipe(Ea((I,D)=>I+D),ae(I=>({id:x,timestamp:R,message:I,from:n.getParticipantByIdentity(C.identity),type:"chatMessage"}))).subscribe({next:I=>b.next(I)})}));const{messageObservable:g}=l0(n,[d]);g.pipe(ae(y=>{const C=m(y.payload);return u0(C)?void 0:wn(Tt({},C),{type:"chatMessage",from:y.from})}),Yi(y=>!!y),wa(l)).subscribe(b)}const T=b.pipe(Ea((g,y)=>{if("id"in y&&g.find(C=>{var x,R;return((x=C.from)==null?void 0:x.identity)===((R=y.from)==null?void 0:R.identity)&&C.id===y.id})){const C=g.findIndex(x=>x.id===y.id);if(C>-1){const x=g[C];g[C]=wn(Tt({},y),{timestamp:x.timestamp,editTimestamp:y.timestamp})}return[...g]}return[...g,y]},[]),wa(l)),S=new zl(!1),P=(o=e?.messageEncoder)!=null?o:h0,M=(g,y)=>Ge(this,null,function*(){y||(y={}),y.topic!=null||(y.topic=u),S.next(!0);try{const C={id:(yield n.localParticipant.sendText(g,y)).id,timestamp:Date.now(),message:g},x=wn(Tt({},C),{attachedFiles:y.attachments}),R=wn(Tt({},x),{type:"chatMessage",from:n.localParticipant,attributes:y.attributes});b.next(R);const I=P(wn(Tt({},C),{ignoreLegacy:c()}));try{yield mu(n.localParticipant,I,{reliable:!0,topic:d})}catch(D){B.info("could not send message in legacy chat format",D)}return R}finally{S.next(!1)}});function v(){l.next(),l.complete(),b.complete(),ei.delete(n),n.unregisterTextStreamHandler(u)}return n.once(_.Disconnected,v),{messageObservable:T,isSendingObservable:S,send:M}}function p0(){const n=e=>Ge(this,null,function*(){B.info("Start Audio for room: ",e),yield e.startAudio()});return{className:_e("start-audio-button"),roomAudioPlaybackAllowedObservable:Kv,handleStartAudioPlayback:n}}function m0(){const n=e=>Ge(this,null,function*(){B.info("Start Video for room: ",e),yield e.startVideo()});return{className:_e("start-audio-button"),roomVideoPlaybackAllowedObservable:zv,handleStartVideoPlayback:n}}function g0(){return{className:[_e("button"),_e("chat-toggle")].join(" ")}}function v0(){return{className:[_e("button"),_e("focus-toggle-button")].join(" ")}}function b0(){return{className:"lk-room-container"}}function Ia(n,e,t=!0){const i=[n.localParticipant,...Array.from(n.remoteParticipants.values())],r=[];return i.forEach(s=>{e.forEach(a=>{const o=Array.from(s.trackPublications.values()).filter(c=>c.source===a&&(!t||c.track)).map(c=>({participant:s,publication:c,source:c.source}));r.push(...o)})}),{trackReferences:r,participants:i}}function y0(n,e,t){var i,r;const s=(i=t.additionalRoomEvents)!=null?i:kv,a=(r=t.onlySubscribed)!=null?r:!0,o=Array.from(new Set([_.ParticipantConnected,_.ParticipantDisconnected,_.ConnectionStateChanged,_.LocalTrackPublished,_.LocalTrackUnpublished,_.TrackPublished,_.TrackUnpublished,_.TrackSubscriptionStatusChanged,...s]).values());return zs(n,...o).pipe(ae(c=>{const l=Ia(c,e,a);return B.debug(`TrackReference[] was updated. (length ${l.trackReferences.length})`,l),l}),$e(Ia(n,e,a)))}function k0(n,e=1e3){if(n===null)return Ta(!1);const t=is(n,"mousemove",{passive:!0}).pipe(ae(()=>!0)),i=t.pipe(qg({each:e,with:()=>Ai(Ta(!1),i.pipe(sv(t)))}),iv());return i}function S0(n,e){if(typeof localStorage>"u"){B.error("Local storage is not available.");return}try{if(e){const t=Object.fromEntries(Object.entries(e).filter(([,i])=>i!==""));localStorage.setItem(n,JSON.stringify(t))}}catch(t){B.error(`Error setting item to local storage: ${t}`)}}function T0(n){if(typeof localStorage>"u"){B.error("Local storage is not available.");return}try{const e=localStorage.getItem(n);if(!e){B.warn(`Item with key ${n} does not exist in local storage.`);return}return JSON.parse(e)}catch(e){B.error(`Error getting item from local storage: ${e}`);return}}function C0(n){return{load:()=>T0(n),save:e=>S0(n,e)}}var E0=`${su}-user-choices`,Pn={videoEnabled:!0,audioEnabled:!0,videoDeviceId:"default",audioDeviceId:"default",username:""},{load:w0,save:P0}=C0(E0);function R0(n,e=!1){e!==!0&&P0(n)}function _0(n,e=!1){var t,i,r,s,a;const o={videoEnabled:(t=n?.videoEnabled)!=null?t:Pn.videoEnabled,audioEnabled:(i=n?.audioEnabled)!=null?i:Pn.audioEnabled,videoDeviceId:(r=n?.videoDeviceId)!=null?r:Pn.videoDeviceId,audioDeviceId:(s=n?.audioDeviceId)!=null?s:Pn.audioDeviceId,username:(a=n?.username)!=null?a:Pn.username};if(e)return o;{const c=w0();return Tt(Tt({},o),c??{})}}function gu(n,e){if(e.msg==="show_chat")return{...n,showChat:!0,unreadMessages:0};if(e.msg==="hide_chat")return{...n,showChat:!1};if(e.msg==="toggle_chat"){const t={...n,showChat:!n.showChat};return t.showChat===!0&&(t.unreadMessages=0),t}else return e.msg==="unread_msg"?{...n,unreadMessages:e.count}:e.msg==="toggle_settings"?{...n,showSettings:!n.showSettings}:{...n}}function vu(n,e){return e.msg==="set_pin"?[e.trackReference]:e.msg==="clear_pin"?[]:{...n}}const Zi=f.createContext(void 0);function bu(){const n=f.useContext(Zi);if(!n)throw Error("Tried to access LayoutContext context outside a LayoutContextProvider provider.");return n}function I0(n){const e=Kn();if(n??(n=e),!n)throw Error("Tried to access LayoutContext context outside a LayoutContextProvider provider.");return n}function x0(){const[n,e]=f.useReducer(vu,lu),[t,i]=f.useReducer(gu,uu);return{pin:{dispatch:e,state:n},widget:{dispatch:i,state:t}}}function O0(n){const[e,t]=f.useReducer(vu,lu),[i,r]=f.useReducer(gu,uu);return n??{pin:{dispatch:t,state:e},widget:{dispatch:r,state:i}}}function Kn(){return f.useContext(Zi)}const $s=f.createContext(void 0);function er(){return f.useContext($s)}function gn(n){const e=er(),t=n??e;if(!t)throw new Error("No TrackRef, make sure you are inside a TrackRefContext or pass the TrackRef explicitly");return t}const yu=f.createContext(void 0);function ku(){return f.useContext(yu)}function zn(n){const e=ku(),t=er(),i=n??e??t?.participant;if(!i)throw new Error("No participant provided, make sure you are inside a participant context or pass the participant explicitly");return i}const Qs=f.createContext(void 0);function Ys(){const n=f.useContext(Qs);if(!n)throw Error("tried to access room context outside of livekit room component");return n}function tr(){return f.useContext(Qs)}function vn(n){const e=tr(),t=n??e;if(!t)throw new Error("No room provided, make sure you are inside a Room context or pass the room explicitly");return t}f.createContext(void 0);const Su=f.createContext(void 0);function M0(n){return f.useContext(Su)}var xa={};function Tu(n){var e,t,i="";if(typeof n=="string"||typeof n=="number")i+=n;else if(typeof n=="object")if(Array.isArray(n)){var r=n.length;for(e=0;e<r;e++)n[e]&&(t=Tu(n[e]))&&(i&&(i+=" "),i+=t)}else for(t in n)n[t]&&(i&&(i+=" "),i+=t);return i}function Cu(){for(var n,e,t=0,i="",r=arguments.length;t<r;t++)(n=arguments[t])&&(e=Tu(n))&&(i&&(i+=" "),i+=e);return i}function D0(...n){return(...e)=>{for(const t of n)if(typeof t=="function")try{t(...e)}catch(i){console.error(i)}}}function st(...n){const e={...n[0]};for(let t=1;t<n.length;t++){const i=n[t];for(const r in i){const s=e[r],a=i[r];typeof s=="function"&&typeof a=="function"&&r[0]==="o"&&r[1]==="n"&&r.charCodeAt(2)>=65&&r.charCodeAt(2)<=90?e[r]=D0(s,a):(r==="className"||r==="UNSAFE_className")&&typeof s=="string"&&typeof a=="string"?e[r]=Cu(s,a):e[r]=a!==void 0?a:s}}return e}function A0(n){return n!==void 0}function gt(...n){return st(...n.filter(A0))}function Eu(n,e,t){return f.Children.map(n,i=>f.isValidElement(i)&&f.Children.only(n)?(i.props.className&&(e??(e={}),e.className=Cu(i.props.className,e.className),e.style={...i.props.style,...e.style}),f.cloneElement(i,{...e,key:t})):i)}function L0(n){var e,t;if(typeof window<"u"&&typeof process<"u"&&(((e=process==null?void 0:xa)==null?void 0:e.NODE_ENV)==="dev"||((t=process==null?void 0:xa)==null?void 0:t.NODE_ENV)==="development")){const i=document.querySelector(".lk-room-container");i&&!getComputedStyle(i).getPropertyValue("--lk-has-imported-styles")&&B.warn("It looks like you're not using the `@livekit/components-styles package`. To render the UI with the default styling, please import it in your layout or page.")}}function N0(n,e){return n==="processor"&&e&&typeof e=="object"&&"name"in e?e.name:n==="e2ee"&&e?"e2ee-enabled":e}const U0={connect:!0,audio:!1,video:!1};function F0(n){const{token:e,serverUrl:t,options:i,room:r,connectOptions:s,connect:a,audio:o,video:c,screen:l,onConnected:u,onDisconnected:d,onError:h,onMediaDeviceFailure:p,onEncryptionError:b,simulateParticipants:m,...T}={...U0,...n};i&&r&&B.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[S,P]=f.useState(),M=f.useRef(a);f.useEffect(()=>{P(r??new ft(i))},[r,JSON.stringify(i,N0)]);const v=f.useMemo(()=>{const{className:g}=b0();return st(T,{className:g})},[T]);return f.useEffect(()=>{if(!S)return;const g=()=>{const I=S.localParticipant;B.debug("trying to publish local tracks"),Promise.all([I.setMicrophoneEnabled(!!o,typeof o!="boolean"?o:void 0),I.setCameraEnabled(!!c,typeof c!="boolean"?c:void 0),I.setScreenShareEnabled(!!l,typeof l!="boolean"?l:void 0)]).catch(D=>{B.warn(D),h?.(D)})},y=(I,D)=>{const U=Nn.getFailure(I);p?.(U,D)},C=I=>{b?.(I)},x=I=>{d?.(I)},R=()=>{u?.()};return S.on(_.SignalConnected,g).on(_.MediaDevicesError,y).on(_.EncryptionError,C).on(_.Disconnected,x).on(_.Connected,R),()=>{S.off(_.SignalConnected,g).off(_.MediaDevicesError,y).off(_.EncryptionError,C).off(_.Disconnected,x).off(_.Connected,R)}},[S,o,c,l,h,b,p,u,d]),f.useEffect(()=>{if(S){if(m){S.simulateParticipants({participants:{count:m},publish:{audio:!0,useRealTracks:!0}});return}if(a){if(M.current=!0,B.debug("connecting"),!e){B.debug("no token yet");return}if(!t){B.warn("no livekit url provided"),h?.(Error("no livekit url provided"));return}S.connect(t,e,s).catch(g=>{B.warn(g),M.current===!0&&h?.(g)})}else B.debug("disconnecting because connect is false"),M.current=!1,S.disconnect()}},[a,e,JSON.stringify(s),S,h,t,m]),f.useEffect(()=>{if(S)return()=>{B.info("disconnecting on onmount"),S.disconnect()}},[S]),{room:S,htmlProps:v}}const j0=f.forwardRef(function(n,e){const{room:t,htmlProps:i}=F0(n);return f.createElement("div",{ref:e,...i},t&&f.createElement(Qs.Provider,{value:t},f.createElement(Su.Provider,{value:n.featureFlags},n.children)))}),B0=n=>{const e=f.useRef(n);return f.useEffect(()=>{e.current=n}),e};function V0(n,e){const t=W0(),i=B0(e);return f.useLayoutEffect(()=>{let r=!1;const s=n.current;if(!s)return;function a(o,c){r||i.current(o,c)}return t?.subscribe(s,a),()=>{r=!0,t?.unsubscribe(s,a)}},[n.current,t,i]),t?.observer}function q0(){let n=!1,e=[];const t=new Map;if(typeof window>"u")return;const i=new ResizeObserver((r,s)=>{e=e.concat(r),n||window.requestAnimationFrame(()=>{const a=new Set;for(let o=0;o<e.length;o++){if(a.has(e[o].target))continue;a.add(e[o].target);const c=t.get(e[o].target);c?.forEach(l=>l(e[o],s))}e=[],n=!1}),n=!0});return{observer:i,subscribe(r,s){i.observe(r);const a=t.get(r)??[];a.push(s),t.set(r,a)},unsubscribe(r,s){const a=t.get(r)??[];if(a.length===1){i.unobserve(r),t.delete(r);return}const o=a.indexOf(s);o!==-1&&a.splice(o,1),t.set(r,a)}}}let Oa;const W0=()=>Oa||(Oa=q0()),wu=n=>{const[e,t]=f.useState({width:0,height:0});f.useLayoutEffect(()=>{if(n.current){const{width:r,height:s}=n.current.getBoundingClientRect();t({width:r,height:s})}},[n.current]);const i=f.useCallback(r=>t(r.contentRect),[]);return V0(n,i),e};function Ie(n,e,t=!0){const[i,r]=f.useState(e);return f.useEffect(()=>{if(t&&r(e),typeof window>"u"||!n)return;const s=n.subscribe(r);return()=>s.unsubscribe()},[n,t]),i}function H0(n){const e=s=>typeof window<"u"?window.matchMedia(s).matches:!1,[t,i]=f.useState(e(n));function r(){i(e(n))}return f.useEffect(()=>{const s=window.matchMedia(n);return r(),s.addListener?s.addListener(r):s.addEventListener("change",r),()=>{s.removeListener?s.removeListener(r):s.removeEventListener("change",r)}},[n]),t}function K0(n={}){const e=zn(n.participant),{className:t,connectionQualityObserver:i}=f.useMemo(()=>i0(e),[e]),r=Ie(i,e.connectionQuality);return{className:t,quality:r}}function Xs(n){const e=vn(n),t=f.useMemo(()=>qv(e),[e]);return Ie(t,e.state)}function z0(n){const e=Ys(),t=Xs(e);return{buttonProps:f.useMemo(()=>{const{className:i,disconnect:r}=n0(e);return st(n,{className:i,onClick:()=>r(n.stopTracks??!0),disabled:t===K.Disconnected})},[e,n,t])}}function G0(n){if(n.publication instanceof wi){const e=n.publication.track;if(e){const{facingMode:t}=sm(e);return t}}return"undefined"}function J0({trackRef:n,props:e}){const t=gn(n),i=Kn(),{className:r}=f.useMemo(()=>v0(),[]),s=f.useMemo(()=>ou(t,i?.pin.state),[t,i?.pin.state]);return{mergedProps:f.useMemo(()=>st(e,{className:r,onClick:a=>{var o,c,l,u,d;(o=e.onClick)==null||o.call(e,a),s?(l=i==null?void 0:(c=i.pin).dispatch)==null||l.call(c,{msg:"clear_pin"}):(d=i==null?void 0:(u=i.pin).dispatch)==null||d.call(u,{msg:"set_pin",trackReference:t})}}),[e,r,t,s,i?.pin]),inFocus:s}}function $0(n,e,t={}){const i=t.gridLayouts??Tv,{width:r,height:s}=wu(n),a=au(i,e,r,s);return f.useEffect(()=>{n.current&&a&&(n.current.style.setProperty("--lk-col-count",a?.columns.toString()),n.current.style.setProperty("--lk-row-count",a?.rows.toString()))},[n,a]),{layout:a,containerWidth:r,containerHeight:s}}function Ma(n,e={}){var t,i;const r=typeof n=="string"?e.participant:n.participant,s=zn(r),a=typeof n=="string"?{participant:s,source:n}:n,[o,c]=f.useState(!!((t=a.publication)!=null&&t.isMuted||(i=s.getTrackPublication(a.source))!=null&&i.isMuted));return f.useEffect(()=>{const l=pu(a).subscribe(c);return()=>l.unsubscribe()},[pe(a)]),o}function Q0(n){const e=zn(n),t=f.useMemo(()=>Yv(e),[e]);return Ie(t,e.isSpeaking)}function Y0(){const n=Ys(),e=f.useMemo(()=>Xv(n.localParticipant),[n]);return Ie(e,n.localParticipant.permissions)}function X0({kind:n,room:e,track:t,requestPermissions:i,onError:r}){const s=tr(),a=f.useMemo(()=>e??s??new ft,[e,s]),o=f.useMemo(()=>Wv(n,r,i),[n,i,r]),c=Ie(o,[]),[l,u]=f.useState(a?.getActiveDevice(n)??"default"),{className:d,activeDeviceObservable:h,setActiveMediaDevice:p}=f.useMemo(()=>t0(n,a),[n,a,t]);return f.useEffect(()=>{const b=h.subscribe(m=>{m&&(B.info("setCurrentDeviceId",m),u(m))});return()=>{b?.unsubscribe()}},[h]),{devices:c,className:d,activeDeviceId:l,setActiveMediaDevice:p}}function Pu(n,e,t={}){const i=f.useRef([]),r=f.useRef(-1),s=e!==r.current,a=typeof t.customSortFunction=="function"?t.customSortFunction(n):xv(n);let o=[...a];if(s===!1)try{o=jv(i.current,a,e)}catch(c){B.error("Error while running updatePages(): ",c)}return s?i.current=a:i.current=o,r.current=e,o}function Z0(n,e){const[t,i]=f.useState(1),r=Math.max(Math.ceil(e.length/n),1);t>r&&i(r);const s=t*n,a=s-n,o=u=>{i(d=>u==="next"?d===r?d:d+1:d===1?d:d-1)},c=u=>{u>r?i(r):u<1?i(1):i(u)},l=Pu(e,n).slice(a,s);return{totalPageCount:r,nextPage:()=>o("next"),prevPage:()=>o("previous"),setPage:c,firstItemIndex:a,lastItemIndex:s,tracks:l,currentPage:t}}function eb({trackRef:n,onParticipantClick:e,disableSpeakingIndicator:t,htmlProps:i}){const r=gn(n),s=f.useMemo(()=>{const{className:h}=o0();return st(i,{className:h,onClick:p=>{var b;if((b=i.onClick)==null||b.call(i,p),typeof e=="function"){const m=r.publication??r.participant.getTrackPublication(r.source);e({participant:r.participant,track:m})}}})},[i,e,r.publication,r.source,r.participant]),a=r.participant.getTrackPublication(E.Source.Microphone),o=f.useMemo(()=>({participant:r.participant,source:E.Source.Microphone,publication:a}),[a,r.participant]),c=Ma(r),l=Ma(o),u=Q0(r.participant),d=G0(r);return{elementProps:{"data-lk-audio-muted":l,"data-lk-video-muted":c,"data-lk-speaking":t===!0?!1:u,"data-lk-local-participant":r.participant.isLocal,"data-lk-source":r.source,"data-lk-facing-mode":d,...s}}}function tb(n){return n=I0(n),f.useMemo(()=>n?.pin.state!==void 0&&n.pin.state.length>=1?n.pin.state:[],[n.pin.state])}function nb({room:n,props:e}){const t=vn(n),{className:i,roomAudioPlaybackAllowedObservable:r,handleStartAudioPlayback:s}=f.useMemo(()=>p0(),[]),a=f.useMemo(()=>r(t),[t,r]),{canPlayAudio:o}=Ie(a,{canPlayAudio:t.canPlaybackAudio});return{mergedProps:f.useMemo(()=>st(e,{className:i,onClick:()=>{s(t)},style:{display:o?"none":"block"}}),[e,i,o,s,t]),canPlayAudio:o}}function ib({room:n,props:e}){const t=vn(n),{className:i,roomVideoPlaybackAllowedObservable:r,handleStartVideoPlayback:s}=f.useMemo(()=>m0(),[]),a=f.useMemo(()=>r(t),[t,r]),{canPlayVideo:o}=Ie(a,{canPlayVideo:t.canPlaybackVideo});return{mergedProps:f.useMemo(()=>st(e,{className:i,onClick:()=>{s(t)},style:{display:o?"none":"block"}}),[e,i,o,s,t]),canPlayVideo:o}}function rb(n,e={}){const t=f.useRef(null),i=f.useRef(null),r=e.minSwipeDistance??50,s=c=>{i.current=null,t.current=c.targetTouches[0].clientX},a=c=>{i.current=c.targetTouches[0].clientX},o=f.useCallback(()=>{if(!t.current||!i.current)return;const c=t.current-i.current,l=c>r,u=c<-r;l&&e.onLeftSwipe&&e.onLeftSwipe(),u&&e.onRightSwipe&&e.onRightSwipe()},[r,e]);f.useEffect(()=>{const c=n.current;return c&&(c.addEventListener("touchstart",s,{passive:!0}),c.addEventListener("touchmove",a,{passive:!0}),c.addEventListener("touchend",o,{passive:!0})),()=>{c&&(c.removeEventListener("touchstart",s),c.removeEventListener("touchmove",a),c.removeEventListener("touchend",o))}},[n,o])}function sb({props:n}){const{dispatch:e,state:t}=bu().widget,{className:i}=f.useMemo(()=>g0(),[]);return{mergedProps:f.useMemo(()=>st(n,{className:i,onClick:()=>{e&&e({msg:"toggle_chat"})},"aria-pressed":t!=null&&t.showChat?"true":"false","data-lk-unread-msgs":t?t.unreadMessages<10?t.unreadMessages.toFixed(0):"9+":"0"}),[n,i,e,t])}}function ob(n){var e,t;const i=gn(n),{className:r,mediaMutedObserver:s}=f.useMemo(()=>r0(i),[pe(i)]);return{isMuted:Ie(s,!!((e=i.publication)!=null&&e.isMuted||(t=i.participant.getTrackPublication(i.source))!=null&&t.isMuted)),className:r}}function ab({source:n,onChange:e,initialState:t,captureOptions:i,publishOptions:r,onDeviceError:s,room:a,...o}){var c;const l=tr(),u=f.useMemo(()=>a??l,[a,l]),d=(c=u?.localParticipant)==null?void 0:c.getTrackPublication(n),h=f.useRef(!1),{toggle:p,className:b,pendingObserver:m,enabledObserver:T}=f.useMemo(()=>u?Zv(n,u,i,r,s):e0(),[u,n,JSON.stringify(i),r]),S=Ie(m,!1),P=Ie(T,t??!!(d!=null&&d.isEnabled));f.useEffect(()=>{e?.(P,h.current),h.current=!1},[P,e]),f.useEffect(()=>{t!==void 0&&(B.debug("forcing initial toggle state",n,t),p(t))},[]);const M=f.useMemo(()=>st(o,{className:b}),[o,b]),v=f.useCallback(g=>{var y;h.current=!0,p().catch(()=>h.current=!1),(y=o.onClick)==null||y.call(o,g)},[o,p]);return{toggle:p,enabled:P,pending:S,track:d,buttonProps:{...M,"aria-pressed":P,"data-lk-source":n,"data-lk-enabled":P,disabled:S,onClick:v}}}function Ru(n=[E.Source.Camera,E.Source.Microphone,E.Source.ScreenShare,E.Source.ScreenShareAudio,E.Source.Unknown],e={}){const t=vn(e.room),[i,r]=f.useState([]),[s,a]=f.useState([]),o=f.useMemo(()=>n.map(c=>du(c)?c.source:c),[JSON.stringify(n)]);return f.useEffect(()=>{const c=y0(t,o,{additionalRoomEvents:e.updateOnlyOn,onlySubscribed:e.onlySubscribed}).subscribe(({trackReferences:l,participants:u})=>{B.debug("setting track bundles",l,u),r(l),a(u)});return()=>c.unsubscribe()},[t,JSON.stringify(e.onlySubscribed),JSON.stringify(e.updateOnlyOn),JSON.stringify(n)]),f.useMemo(()=>{if(hu(n)){const c=lb(n,s),l=Array.from(i);return s.forEach(u=>{c.has(u.identity)&&(c.get(u.identity)??[]).forEach(d=>{if(i.find(({participant:p,publication:b})=>u.identity===p.identity&&b.source===d))return;B.debug(`Add ${d} placeholder for participant ${u.identity}.`);const h={participant:u,source:d};l.push(h)})}),l}else return i},[i,s,n])}function cb(n,e){const t=new Set(n);for(const i of e)t.delete(i);return t}function lb(n,e){const t=new Map;if(hu(n)){const i=n.filter(r=>r.withPlaceholder).map(r=>r.source);e.forEach(r=>{const s=r.getTrackPublications().map(o=>{var c;return(c=o.track)==null?void 0:c.source}).filter(o=>o!==void 0),a=Array.from(cb(new Set(i),new Set(s)));a.length>0&&t.set(r.identity,a)})}return t}function ub(n){const e=vn(n?.room),t=Xs(e),i=f.useMemo(()=>t===K.Disconnected,[t]),r=f.useMemo(()=>f0(e,n),[e,n,i]),s=Ie(r.isSendingObservable,!1),a=Ie(r.messageObservable,[]);return{send:r.send,chatMessages:a,isSending:s}}function db(n={}){const[e,t]=f.useState(_0(n.defaults,n.preventLoad??!1)),i=f.useCallback(c=>{t(l=>({...l,audioEnabled:c}))},[]),r=f.useCallback(c=>{t(l=>({...l,videoEnabled:c}))},[]),s=f.useCallback(c=>{t(l=>({...l,audioDeviceId:c}))},[]),a=f.useCallback(c=>{t(l=>({...l,videoDeviceId:c}))},[]),o=f.useCallback(c=>{t(l=>({...l,username:c}))},[]);return f.useEffect(()=>{R0(e,n.preventSave??!1)},[e,n.preventSave]),{userChoices:e,saveAudioInputEnabled:i,saveVideoInputEnabled:r,saveAudioInputDeviceId:s,saveVideoInputDeviceId:a,saveUsername:o}}function hb(n,e={}){const t=zn(n),i=vn(e.room),r=f.useMemo(()=>Jv(i,t),[i,t]);return Ie(r,t.isLocal?t.isE2EEEnabled:!!(t!=null&&t.isEncrypted))}cu.AgentState;var ti={exports:{}},Da;function fb(){if(Da)return ti.exports;Da=1;var n=typeof Reflect=="object"?Reflect:null,e=n&&typeof n.apply=="function"?n.apply:function(v,g,y){return Function.prototype.apply.call(v,g,y)},t;n&&typeof n.ownKeys=="function"?t=n.ownKeys:Object.getOwnPropertySymbols?t=function(v){return Object.getOwnPropertyNames(v).concat(Object.getOwnPropertySymbols(v))}:t=function(v){return Object.getOwnPropertyNames(v)};function i(v){console&&console.warn&&console.warn(v)}var r=Number.isNaN||function(v){return v!==v};function s(){s.init.call(this)}ti.exports=s,ti.exports.once=S,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var a=10;function o(v){if(typeof v!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof v)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(v){if(typeof v!="number"||v<0||r(v))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+v+".");a=v}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(v){if(typeof v!="number"||v<0||r(v))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+v+".");return this._maxListeners=v,this};function c(v){return v._maxListeners===void 0?s.defaultMaxListeners:v._maxListeners}s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(v){for(var g=[],y=1;y<arguments.length;y++)g.push(arguments[y]);var C=v==="error",x=this._events;if(x!==void 0)C=C&&x.error===void 0;else if(!C)return!1;if(C){var R;if(g.length>0&&(R=g[0]),R instanceof Error)throw R;var I=new Error("Unhandled error."+(R?" ("+R.message+")":""));throw I.context=R,I}var D=x[v];if(D===void 0)return!1;if(typeof D=="function")e(D,this,g);else for(var U=D.length,V=b(D,U),y=0;y<U;++y)e(V[y],this,g);return!0};function l(v,g,y,C){var x,R,I;if(o(y),R=v._events,R===void 0?(R=v._events=Object.create(null),v._eventsCount=0):(R.newListener!==void 0&&(v.emit("newListener",g,y.listener?y.listener:y),R=v._events),I=R[g]),I===void 0)I=R[g]=y,++v._eventsCount;else if(typeof I=="function"?I=R[g]=C?[y,I]:[I,y]:C?I.unshift(y):I.push(y),x=c(v),x>0&&I.length>x&&!I.warned){I.warned=!0;var D=new Error("Possible EventEmitter memory leak detected. "+I.length+" "+String(g)+" listeners added. Use emitter.setMaxListeners() to increase limit");D.name="MaxListenersExceededWarning",D.emitter=v,D.type=g,D.count=I.length,i(D)}return v}s.prototype.addListener=function(v,g){return l(this,v,g,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(v,g){return l(this,v,g,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(v,g,y){var C={fired:!1,wrapFn:void 0,target:v,type:g,listener:y},x=u.bind(C);return x.listener=y,C.wrapFn=x,x}s.prototype.once=function(v,g){return o(g),this.on(v,d(this,v,g)),this},s.prototype.prependOnceListener=function(v,g){return o(g),this.prependListener(v,d(this,v,g)),this},s.prototype.removeListener=function(v,g){var y,C,x,R,I;if(o(g),C=this._events,C===void 0)return this;if(y=C[v],y===void 0)return this;if(y===g||y.listener===g)--this._eventsCount===0?this._events=Object.create(null):(delete C[v],C.removeListener&&this.emit("removeListener",v,y.listener||g));else if(typeof y!="function"){for(x=-1,R=y.length-1;R>=0;R--)if(y[R]===g||y[R].listener===g){I=y[R].listener,x=R;break}if(x<0)return this;x===0?y.shift():m(y,x),y.length===1&&(C[v]=y[0]),C.removeListener!==void 0&&this.emit("removeListener",v,I||g)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(v){var g,y,C;if(y=this._events,y===void 0)return this;if(y.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):y[v]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete y[v]),this;if(arguments.length===0){var x=Object.keys(y),R;for(C=0;C<x.length;++C)R=x[C],R!=="removeListener"&&this.removeAllListeners(R);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(g=y[v],typeof g=="function")this.removeListener(v,g);else if(g!==void 0)for(C=g.length-1;C>=0;C--)this.removeListener(v,g[C]);return this};function h(v,g,y){var C=v._events;if(C===void 0)return[];var x=C[g];return x===void 0?[]:typeof x=="function"?y?[x.listener||x]:[x]:y?T(x):b(x,x.length)}s.prototype.listeners=function(v){return h(this,v,!0)},s.prototype.rawListeners=function(v){return h(this,v,!1)},s.listenerCount=function(v,g){return typeof v.listenerCount=="function"?v.listenerCount(g):p.call(v,g)},s.prototype.listenerCount=p;function p(v){var g=this._events;if(g!==void 0){var y=g[v];if(typeof y=="function")return 1;if(y!==void 0)return y.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function b(v,g){for(var y=new Array(g),C=0;C<g;++C)y[C]=v[C];return y}function m(v,g){for(;g+1<v.length;g++)v[g]=v[g+1];v.pop()}function T(v){for(var g=new Array(v.length),y=0;y<g.length;++y)g[y]=v[y].listener||v[y];return g}function S(v,g){return new Promise(function(y,C){function x(I){v.removeListener(g,R),C(I)}function R(){typeof v.removeListener=="function"&&v.removeListener("error",x),y([].slice.call(arguments))}M(v,g,R,{once:!0}),g!=="error"&&P(v,x,{once:!0})})}function P(v,g,y){typeof v.on=="function"&&M(v,"error",g,y)}function M(v,g,y,C){if(typeof v.on=="function")C.once?v.once(g,y):v.on(g,y);else if(typeof v.addEventListener=="function")v.addEventListener(g,function x(R){C.once&&v.removeEventListener(g,x),y(R)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof v)}return ti.exports}fb();const _u=f.forwardRef(function(n,e){const{mergedProps:t}=sb({props:n});return f.createElement("button",{ref:e,...t},n.children)}),pb=f.forwardRef(function(n,e){const{buttonProps:t}=z0(n);return f.createElement("button",{ref:e,...t},n.children)}),mb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{d:"M1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708L11 10.293V4.5A1.5 1.5 0 0 0 9.5 3H3.707zM0 4.5a1.5 1.5 0 0 1 .943-1.393l9.532 9.533c-.262.224-.603.36-.975.36h-8A1.5 1.5 0 0 1 0 11.5z"}),f.createElement("path",{d:"m15.2 3.6-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),gb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{d:"M0 4.5A1.5 1.5 0 0 1 1.5 3h8A1.5 1.5 0 0 1 11 4.5v7A1.5 1.5 0 0 1 9.5 13h-8A1.5 1.5 0 0 1 0 11.5zM15.2 3.6l-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),vb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,viewBox:"0 0 24 24",...n},f.createElement("path",{fill:"#FFF",d:"M4.99 3.99a1 1 0 0 0-.697 1.717L10.586 12l-6.293 6.293a1 1 0 1 0 1.414 1.414L12 13.414l6.293 6.293a1 1 0 1 0 1.414-1.414L13.414 12l6.293-6.293a1 1 0 0 0-.727-1.717 1 1 0 0 0-.687.303L12 10.586 5.707 4.293a1 1 0 0 0-.717-.303z"})),bb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:18,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h10.5A2.75 2.75 0 0 1 16 2.75v13.594a.75.75 0 0 1-1.234.572l-3.691-3.12a1.25 1.25 0 0 0-.807-.296H2.75A2.75 2.75 0 0 1 0 10.75v-8ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v8c0 .69.56 1.25 1.25 1.25h7.518c.65 0 1.279.23 1.775.65l2.457 2.077V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5Z",clipRule:"evenodd"})),Aa=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M5.293 2.293a1 1 0 0 1 1.414 0l4.823 4.823a1.25 1.25 0 0 1 0 1.768l-4.823 4.823a1 1 0 0 1-1.414-1.414L9.586 8 5.293 3.707a1 1 0 0 1 0-1.414z",clipRule:"evenodd"})),yb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},f.createElement("path",{d:"M10 1.75h4.25m0 0V6m0-4.25L9 7M6 14.25H1.75m0 0V10m0 4.25L7 9"}))),kb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M8.961.894C8.875-.298 7.125-.298 7.04.894c-.066.912-1.246 1.228-1.76.472-.67-.99-2.186-.115-1.664.96.399.824-.465 1.688-1.288 1.289-1.076-.522-1.95.994-.961 1.665.756.513.44 1.693-.472 1.759-1.192.086-1.192 1.836 0 1.922.912.066 1.228 1.246.472 1.76-.99.67-.115 2.186.96 1.664.824-.399 1.688.465 1.289 1.288-.522 1.076.994 1.95 1.665.961.513-.756 1.693-.44 1.759.472.086 1.192 1.836 1.192 1.922 0 .066-.912 1.246-1.228 1.76-.472.67.99 2.186.115 1.664-.96-.399-.824.465-1.688 1.288-1.289 1.076.522 1.95-.994.961-1.665-.756-.513-.44-1.693.472-1.759 1.192-.086 1.192-1.836 0-1.922-.912-.066-1.228-1.246-.472-1.76.99-.67.115-2.186-.96-1.664-.824.399-1.688-.465-1.289-1.288.522-1.076-.994-1.95-1.665-.961-.513.756-1.693.44-1.759-.472ZM8 13A5 5 0 1 0 8 3a5 5 0 0 0 0 10Z",clipRule:"evenodd"})),Sb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M2 2.75A2.75 2.75 0 0 1 4.75 0h6.5A2.75 2.75 0 0 1 14 2.75v10.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-.5a.75.75 0 0 1 1.5 0v.5c0 .69.56 1.25 1.25 1.25h6.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25h-6.5c-.69 0-1.25.56-1.25 1.25v.5a.75.75 0 0 1-1.5 0v-.5Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8.78 7.47a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 1 1-1.06-1.06l.97-.97H1.75a.75.75 0 0 1 0-1.5h4.69l-.97-.97a.75.75 0 0 1 1.06-1.06l2.25 2.25Z",clipRule:"evenodd"})),Tb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M4 6.104V4a4 4 0 1 1 8 0v2.104c1.154.326 2 1.387 2 2.646v4.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-4.5c0-1.259.846-2.32 2-2.646ZM5.5 4a2.5 2.5 0 0 1 5 0v2h-5V4Z",clipRule:"evenodd"})),Cb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{d:"M12.227 11.52a5.477 5.477 0 0 0 1.246-2.97.5.5 0 0 0-.995-.1 4.478 4.478 0 0 1-.962 2.359l-1.07-1.07C10.794 9.247 11 8.647 11 8V3a3 3 0 0 0-6 0v1.293L1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708zM8 12.5c.683 0 1.33-.152 1.911-.425l.743.743c-.649.359-1.378.59-2.154.66V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .995-.098A4.5 4.5 0 0 0 8 12.5z"}),f.createElement("path",{d:"M8.743 10.907 5 7.164V8a3 3 0 0 0 3.743 2.907z"})),Eb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{fillRule:"evenodd",d:"M2.975 8.002a.5.5 0 0 1 .547.449 4.5 4.5 0 0 0 8.956 0 .5.5 0 1 1 .995.098A5.502 5.502 0 0 1 8.5 13.478V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .448-.547z",clipRule:"evenodd"}),f.createElement("path",{d:"M5 3a3 3 0 1 1 6 0v5a3 3 0 0 1-6 0z"})),wb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"})),Pb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("g",{opacity:.25},f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),Rb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("g",{opacity:.25},f.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),_b=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("g",{opacity:.25},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}))),Iu=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h14.5A2.75 2.75 0 0 1 20 2.75v10.5A2.75 2.75 0 0 1 17.25 16H2.75A2.75 2.75 0 0 1 0 13.25V2.75ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v10.5c0 .69.56 1.25 1.25 1.25h14.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9.47 4.22a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1-1.06 1.06l-.97-.97v4.69a.75.75 0 0 1-1.5 0V6.56l-.97.97a.75.75 0 0 1-1.06-1.06l2.25-2.25Z",clipRule:"evenodd"})),Ib=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...n},f.createElement("g",{fill:"currentColor"},f.createElement("path",{d:"M7.28 4.22a.75.75 0 0 0-1.06 1.06L8.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L10 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L11.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L10 6.94z"}),f.createElement("path",{fillRule:"evenodd",d:"M2.75 0A2.75 2.75 0 0 0 0 2.75v10.5A2.75 2.75 0 0 0 2.75 16h14.5A2.75 2.75 0 0 0 20 13.25V2.75A2.75 2.75 0 0 0 17.25 0zM1.5 2.75c0-.69.56-1.25 1.25-1.25h14.5c.69 0 1.25.56 1.25 1.25v10.5c0 .69-.56 1.25-1.25 1.25H2.75c-.69 0-1.25-.56-1.25-1.25z",clipRule:"evenodd"}))),La=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8 0a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0V.75A.75.75 0 0 1 8 0Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8 12a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-2.5A.75.75 0 0 1 8 12Z",clipRule:"evenodd",opacity:.7}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M12 1.072a.75.75 0 0 1 .274 1.024l-1.25 2.165a.75.75 0 0 1-1.299-.75l1.25-2.165A.75.75 0 0 1 12 1.072Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M6 11.464a.75.75 0 0 1 .274 1.025l-1.25 2.165a.75.75 0 0 1-1.299-.75l1.25-2.165A.75.75 0 0 1 6 11.464Z",clipRule:"evenodd",opacity:.6}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M14.928 4a.75.75 0 0 1-.274 1.025l-2.165 1.25a.75.75 0 1 1-.75-1.3l2.165-1.25A.75.75 0 0 1 14.928 4Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.536 10a.75.75 0 0 1-.275 1.024l-2.165 1.25a.75.75 0 0 1-.75-1.298l2.165-1.25A.75.75 0 0 1 4.536 10Z",clipRule:"evenodd",opacity:.5}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M16 8a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h2.5A.75.75 0 0 1 16 8Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4 8a.75.75 0 0 1-.75.75H.75a.75.75 0 0 1 0-1.5h2.5A.75.75 0 0 1 4 8Z",clipRule:"evenodd",opacity:.4}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M14.928 12a.75.75 0 0 1-1.024.274l-2.165-1.25a.75.75 0 0 1 .75-1.299l2.165 1.25A.75.75 0 0 1 14.928 12Z",clipRule:"evenodd",opacity:.9}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.536 6a.75.75 0 0 1-1.025.275l-2.165-1.25a.75.75 0 1 1 .75-1.3l2.165 1.25A.75.75 0 0 1 4.536 6Z",clipRule:"evenodd",opacity:.3}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M12 14.928a.75.75 0 0 1-1.024-.274l-1.25-2.165a.75.75 0 0 1 1.298-.75l1.25 2.165A.75.75 0 0 1 12 14.928Z",clipRule:"evenodd",opacity:.8}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M6 4.536a.75.75 0 0 1-1.024-.275l-1.25-2.165a.75.75 0 1 1 1.299-.75l1.25 2.165A.75.75 0 0 1 6 4.536Z",clipRule:"evenodd",opacity:.2})),xb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},f.createElement("path",{d:"M13.25 7H9m0 0V2.75M9 7l5.25-5.25M2.75 9H7m0 0v4.25M7 9l-5.25 5.25"}))),Ob=f.forwardRef(function({trackRef:n,...e},t){const i=er(),{mergedProps:r,inFocus:s}=J0({trackRef:n??i,props:e});return f.createElement(Zi.Consumer,null,a=>a!==void 0&&f.createElement("button",{ref:t,...r},e.children?e.children:s?f.createElement(xb,null):f.createElement(yb,null)))}),wr=f.forwardRef(function({kind:n,initialSelection:e,onActiveDeviceChange:t,onDeviceListChange:i,onDeviceSelectError:r,exactMatch:s,track:a,requestPermissions:o,onError:c,...l},u){const d=tr(),h=f.useRef("default"),p=f.useCallback(y=>{d&&d.emit(_.MediaDevicesError,y),c?.(y)},[d,c]),{devices:b,activeDeviceId:m,setActiveMediaDevice:T,className:S}=X0({kind:n,room:d,track:a,requestPermissions:o,onError:p});f.useEffect(()=>{e!==void 0&&T(e)},[T]),f.useEffect(()=>{typeof i=="function"&&i(b)},[i,b]),f.useEffect(()=>{m!==h.current&&t?.(m),h.current=m},[m]);const P=async y=>{try{await T(y,{exact:s??!0})}catch(C){if(C instanceof Error)r?.(C);else throw C}},M=f.useMemo(()=>gt(l,{className:S},{className:"lk-list"}),[S,l]),v=!!b.find(y=>y.label.toLowerCase().startsWith("default"));function g(y,C,x){return y===C||!v&&x===0&&C==="default"}return f.createElement("ul",{ref:u,...M},b.map((y,C)=>f.createElement("li",{key:y.deviceId,id:y.deviceId,"data-lk-active":g(y.deviceId,m,C),"aria-selected":g(y.deviceId,m,C),role:"option"},f.createElement("button",{className:"lk-button",onClick:()=>P(y.deviceId)},y.label))))}),Mb=f.forwardRef(function({label:n,...e},t){const i=Ys(),{mergedProps:r,canPlayAudio:s}=nb({room:i,props:e}),{mergedProps:a,canPlayVideo:o}=ib({room:i,props:r}),{style:c,...l}=a;return c.display=s&&o?"none":"block",f.createElement("button",{ref:t,style:c,...l},n??`Start ${s?"Video":"Audio"}`)});function xu(n,e){switch(n){case E.Source.Microphone:return e?f.createElement(Eb,null):f.createElement(Cb,null);case E.Source.Camera:return e?f.createElement(gb,null):f.createElement(mb,null);case E.Source.ScreenShare:return e?f.createElement(Ib,null):f.createElement(Iu,null);default:return}}function Db(n){switch(n){case Be.Excellent:return f.createElement(wb,null);case Be.Good:return f.createElement(Pb,null);case Be.Poor:return f.createElement(Rb,null);default:return f.createElement(_b,null)}}const Pr=f.forwardRef(function({showIcon:n,...e},t){const{buttonProps:i,enabled:r}=ab(e),[s,a]=f.useState(!1);return f.useEffect(()=>{a(!0)},[]),s&&f.createElement("button",{ref:t,...i},(n??!0)&&xu(e.source,r),e.children)}),Ab=f.forwardRef(function(n,e){const{className:t,quality:i}=K0(n),r=f.useMemo(()=>({...gt(n,{className:t}),"data-lk-quality":i}),[i,n,t]);return f.createElement("div",{ref:e,...r},n.children??Db(i))}),Na=f.forwardRef(function({participant:n,...e},t){const i=zn(n),{className:r,infoObserver:s}=f.useMemo(()=>s0(i),[i]),{identity:a,name:o}=Ie(s,{name:i.name,identity:i.identity,metadata:i.metadata}),c=f.useMemo(()=>gt(e,{className:r,"data-lk-participant-name":o}),[e,r,o]);return f.createElement("span",{ref:t,...c},o!==""?o:a,e.children)}),Lb=f.forwardRef(function({trackRef:n,show:e="always",...t},i){const{className:r,isMuted:s}=ob(n),a=e==="always"||e==="muted"&&s||e==="unmuted"&&!s,o=f.useMemo(()=>gt(t,{className:r}),[r,t]);return a?f.createElement("div",{ref:i,...o,"data-lk-muted":s},t.children??xu(n.source,!s)):null}),Nb=n=>f.createElement("svg",{width:320,height:320,viewBox:"0 0 320 320",preserveAspectRatio:"xMidYMid meet",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},f.createElement("path",{d:"M160 180C204.182 180 240 144.183 240 100C240 55.8172 204.182 20 160 20C115.817 20 79.9997 55.8172 79.9997 100C79.9997 144.183 115.817 180 160 180Z",fill:"white",fillOpacity:.25}),f.createElement("path",{d:"M97.6542 194.614C103.267 191.818 109.841 192.481 115.519 195.141C129.025 201.466 144.1 205 159.999 205C175.899 205 190.973 201.466 204.48 195.141C210.158 192.481 216.732 191.818 222.345 194.614C262.703 214.719 291.985 253.736 298.591 300.062C300.15 310.997 291.045 320 280 320H39.9997C28.954 320 19.8495 310.997 21.4087 300.062C28.014 253.736 57.2966 214.72 97.6542 194.614Z",fill:"white",fillOpacity:.25}));function Ou(n,e={}){const[t,i]=f.useState(as(n)),[r,s]=f.useState(t?.isMuted),[a,o]=f.useState(t?.isSubscribed),[c,l]=f.useState(t?.track),[u,d]=f.useState("landscape"),h=f.useRef(),{className:p,trackObserver:b}=f.useMemo(()=>Vv(n),[n.participant.sid??n.participant.identity,n.source,ue(n)&&n.publication.trackSid]);return f.useEffect(()=>{const m=b.subscribe(T=>{B.debug("update track",T),i(T),s(T?.isMuted),o(T?.isSubscribed),l(T?.track)});return()=>m?.unsubscribe()},[b]),f.useEffect(()=>{var m,T;return c&&(h.current&&c.detach(h.current),(m=e.element)!=null&&m.current&&!(n.participant.isLocal&&c?.kind==="audio")&&c.attach(e.element.current)),h.current=(T=e.element)==null?void 0:T.current,()=>{h.current&&c?.detach(h.current)}},[c,e.element]),f.useEffect(()=>{var m,T;if(typeof((m=t?.dimensions)==null?void 0:m.width)=="number"&&typeof((T=t?.dimensions)==null?void 0:T.height)=="number"){const S=t.dimensions.width>t.dimensions.height?"landscape":"portrait";d(S)}},[t]),{publication:t,isMuted:r,isSubscribed:a,track:c,elementProps:gt(e.props,{className:p,"data-lk-local-participant":n.participant.isLocal,"data-lk-source":t?.source,...t?.kind==="video"&&{"data-lk-orientation":u}})}}var Rr,Ua;function Ub(){if(Ua)return Rr;Ua=1;var n="Expected a function",e=NaN,t="[object Symbol]",i=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,a=/^0o[0-7]+$/i,o=parseInt,c=typeof Xn=="object"&&Xn&&Xn.Object===Object&&Xn,l=typeof self=="object"&&self&&self.Object===Object&&self,u=c||l||Function("return this")(),d=Object.prototype,h=d.toString,p=Math.max,b=Math.min,m=function(){return u.Date.now()};function T(g,y,C){var x,R,I,D,U,V,G=0,Ce=!1,$=!1,ee=!0;if(typeof g!="function")throw new TypeError(n);y=v(y)||0,S(C)&&(Ce=!!C.leading,$="maxWait"in C,I=$?p(v(C.maxWait)||0,y):I,ee="trailing"in C?!!C.trailing:ee);function ve(ce){var bt=x,bn=R;return x=R=void 0,G=ce,D=g.apply(bn,bt),D}function Ee(ce){return G=ce,U=setTimeout(vt,y),Ce?ve(ce):D}function At(ce){var bt=ce-V,bn=ce-G,Zs=y-bt;return $?b(Zs,I-bn):Zs}function Gt(ce){var bt=ce-V,bn=ce-G;return V===void 0||bt>=y||bt<0||$&&bn>=I}function vt(){var ce=m();if(Gt(ce))return Jt(ce);U=setTimeout(vt,At(ce))}function Jt(ce){return U=void 0,ee&&x?ve(ce):(x=R=void 0,D)}function nr(){U!==void 0&&clearTimeout(U),G=0,x=V=R=U=void 0}function Gn(){return U===void 0?D:Jt(m())}function Lt(){var ce=m(),bt=Gt(ce);if(x=arguments,R=this,V=ce,bt){if(U===void 0)return Ee(V);if($)return U=setTimeout(vt,y),ve(V)}return U===void 0&&(U=setTimeout(vt,y)),D}return Lt.cancel=nr,Lt.flush=Gn,Lt}function S(g){var y=typeof g;return!!g&&(y=="object"||y=="function")}function P(g){return!!g&&typeof g=="object"}function M(g){return typeof g=="symbol"||P(g)&&h.call(g)==t}function v(g){if(typeof g=="number")return g;if(M(g))return e;if(S(g)){var y=typeof g.valueOf=="function"?g.valueOf():g;g=S(y)?y+"":y}if(typeof g!="string")return g===0?g:+g;g=g.replace(i,"");var C=s.test(g);return C||a.test(g)?o(g.slice(2),C?2:8):r.test(g)?e:+g}return Rr=T,Rr}var Fb=Ub();const Fa=Vl(Fb);function jb(n){const e=f.useRef(n);e.current=n,f.useEffect(()=>()=>{e.current()},[])}function Bb(n,e=500,t){const i=f.useRef();jb(()=>{i.current&&i.current.cancel()});const r=f.useMemo(()=>{const s=Fa(n,e,t),a=(...o)=>s(...o);return a.cancel=()=>{s.cancel()},a.isPending=()=>!!i.current,a.flush=()=>s.flush(),a},[n,e,t]);return f.useEffect(()=>{i.current=Fa(n,e,t)},[n,e,t]),r}function Vb(n,e,t){const i=((l,u)=>l===u),r=n instanceof Function?n():n,[s,a]=f.useState(r),o=f.useRef(r),c=Bb(a,e,t);return i(o.current,r)||(c(r),o.current=r),[s,c]}function qb({threshold:n=0,root:e=null,rootMargin:t="0%",freezeOnceVisible:i=!1,initialIsIntersecting:r=!1,onChange:s}={}){var a;const[o,c]=f.useState(null),[l,u]=f.useState(()=>({isIntersecting:r,entry:void 0})),d=f.useRef();d.current=s;const h=((a=l.entry)==null?void 0:a.isIntersecting)&&i;f.useEffect(()=>{if(!o||!("IntersectionObserver"in window)||h)return;const m=new IntersectionObserver(T=>{const S=Array.isArray(m.thresholds)?m.thresholds:[m.thresholds];T.forEach(P=>{const M=P.isIntersecting&&S.some(v=>P.intersectionRatio>=v);u({isIntersecting:M,entry:P}),d.current&&d.current(M,P)})},{threshold:n,root:e,rootMargin:t});return m.observe(o),()=>{m.disconnect()}},[o,JSON.stringify(n),e,t,h,i]);const p=f.useRef(null);f.useEffect(()=>{var m;!o&&(m=l.entry)!=null&&m.target&&!i&&!h&&p.current!==l.entry.target&&(p.current=l.entry.target,u({isIntersecting:r,entry:void 0}))},[o,l.entry,i,h,r]);const b=[c,!!l.isIntersecting,l.entry];return b.ref=b[0],b.isIntersecting=b[1],b.entry=b[2],b}const Wb=f.forwardRef(function({onTrackClick:n,onClick:e,onSubscriptionStatusChanged:t,trackRef:i,manageSubscription:r,...s},a){const o=gn(i),c=f.useRef(null);f.useImperativeHandle(a,()=>c.current);const l=qb({root:c.current}),[u]=Vb(l,3e3);f.useEffect(()=>{r&&o.publication instanceof Pi&&u?.isIntersecting===!1&&l?.isIntersecting===!1&&o.publication.setSubscribed(!1)},[u,o,r]),f.useEffect(()=>{r&&o.publication instanceof Pi&&l?.isIntersecting===!0&&o.publication.setSubscribed(!0)},[l,o,r]);const{elementProps:d,publication:h,isSubscribed:p}=Ou(o,{element:c,props:s});f.useEffect(()=>{t?.(!!p)},[p,t]);const b=m=>{e?.(m),n?.({participant:o?.participant,track:h})};return f.createElement("video",{ref:c,...d,muted:!0,onClick:b})}),Mu=f.forwardRef(function({trackRef:n,onSubscriptionStatusChanged:e,volume:t,...i},r){const s=gn(n),a=f.useRef(null);f.useImperativeHandle(r,()=>a.current);const{elementProps:o,isSubscribed:c,track:l,publication:u}=Ou(s,{element:a,props:i});return f.useEffect(()=>{e?.(!!c)},[c,e]),f.useEffect(()=>{l===void 0||t===void 0||(l instanceof Pl?l.setVolume(t):B.warn("Volume can only be set on remote audio tracks."))},[t,l]),f.useEffect(()=>{u===void 0||i.muted===void 0||(u instanceof Pi?u.setEnabled(!i.muted):B.warn("Can only call setEnabled on remote track publications."))},[i.muted,u,l]),f.createElement("audio",{ref:a,...o})});function Hb(n){const e=!!ku();return n.participant&&!e?f.createElement(yu.Provider,{value:n.participant},n.children):f.createElement(f.Fragment,null,n.children)}function Kb(n){const e=!!er();return n.trackRef&&!e?f.createElement($s.Provider,{value:n.trackRef},n.children):f.createElement(f.Fragment,null,n.children)}const cs=f.forwardRef(function({trackRef:n,children:e,onParticipantClick:t,disableSpeakingIndicator:i,...r},s){var a,o;const c=gn(n),{elementProps:l}=eb({htmlProps:r,disableSpeakingIndicator:i,onParticipantClick:t,trackRef:c}),u=hb(c.participant),d=Kn(),h=(a=M0())==null?void 0:a.autoSubscription,p=f.useCallback(b=>{c.source&&!b&&d&&d.pin.dispatch&&ou(c,d.pin.state)&&d.pin.dispatch({msg:"clear_pin"})},[c,d]);return f.createElement("div",{ref:s,style:{position:"relative"},...l},f.createElement(Kb,{trackRef:c},f.createElement(Hb,{participant:c.participant},e??f.createElement(f.Fragment,null,ue(c)&&(((o=c.publication)==null?void 0:o.kind)==="video"||c.source===E.Source.Camera||c.source===E.Source.ScreenShare)?f.createElement(Wb,{trackRef:c,onSubscriptionStatusChanged:p,manageSubscription:h}):ue(c)&&f.createElement(Mu,{trackRef:c,onSubscriptionStatusChanged:p}),f.createElement("div",{className:"lk-participant-placeholder"},f.createElement(Nb,null)),f.createElement("div",{className:"lk-participant-metadata"},f.createElement("div",{className:"lk-participant-metadata-item"},c.source===E.Source.Camera?f.createElement(f.Fragment,null,u&&f.createElement(Tb,{style:{marginRight:"0.25rem"}}),f.createElement(Lb,{trackRef:{participant:c.participant,source:E.Source.Microphone},show:"muted"}),f.createElement(Na,null)):f.createElement(f.Fragment,null,f.createElement(Iu,{style:{marginRight:"0.25rem"}}),f.createElement(Na,null,"'s screen"))),f.createElement(Ab,{className:"lk-participant-metadata-item"}))),f.createElement(Ob,{trackRef:c}))))});function zb(n){const e=gt(n,{className:"lk-focus-layout"});return f.createElement("div",{...e},n.children)}function Gb({trackRef:n,...e}){return f.createElement(cs,{trackRef:n,...e})}function Du({tracks:n,...e}){return f.createElement(f.Fragment,null,n.map(t=>f.createElement($s.Provider,{value:t,key:pe(t)},Eu(e.children))))}function Jb({totalPageCount:n,nextPage:e,prevPage:t,currentPage:i,pagesContainer:r}){const[s,a]=f.useState(!1);return f.useEffect(()=>{let o;return r&&(o=k0(r.current,2e3).subscribe(a)),()=>{o&&o.unsubscribe()}},[r]),f.createElement("div",{className:"lk-pagination-control","data-lk-user-interaction":s},f.createElement("button",{className:"lk-button",onClick:t},f.createElement(Aa,null)),f.createElement("span",{className:"lk-pagination-count"},`${i} of ${n}`),f.createElement("button",{className:"lk-button",onClick:e},f.createElement(Aa,null)))}const $b=f.forwardRef(function({totalPageCount:n,currentPage:e},t){const i=new Array(n).fill("").map((r,s)=>s+1===e?f.createElement("span",{"data-lk-active":!0,key:s}):f.createElement("span",{key:s}));return f.createElement("div",{ref:t,className:"lk-pagination-indicator"},i)});function Qb({tracks:n,...e}){const t=f.createRef(),i=f.useMemo(()=>gt(e,{className:"lk-grid-layout"}),[e]),{layout:r}=$0(t,n.length),s=Z0(r.maxTiles,n);return rb(t,{onLeftSwipe:s.nextPage,onRightSwipe:s.prevPage}),f.createElement("div",{ref:t,"data-lk-pagination":s.totalPageCount>1,...i},f.createElement(Du,{tracks:s.tracks},e.children),n.length>r.maxTiles&&f.createElement(f.Fragment,null,f.createElement($b,{totalPageCount:s.totalPageCount,currentPage:s.currentPage}),f.createElement(Jb,{pagesContainer:t,...s})))}const Yb=130,Xb=140,Zb=1,Au=16/10,ey=(1-Au)*-1;function ty({tracks:n,orientation:e,...t}){const i=f.useRef(null),[r,s]=f.useState(0),{width:a,height:o}=wu(i),c=e||(o>=a?"vertical":"horizontal"),l=c==="vertical"?Math.max(a*ey,Yb):Math.max(o*Au,Xb),u=mv(),d=Math.max(c==="vertical"?(o-u)/l:(a-u)/l,Zb);let h=Math.round(d);Math.abs(d-r)<.5?h=Math.round(r):r!==d&&s(d);const p=Pu(n,h);return f.useLayoutEffect(()=>{i.current&&(i.current.dataset.lkOrientation=c,i.current.style.setProperty("--lk-max-visible-tiles",h.toString()))},[h,c]),f.createElement("aside",{key:c,className:"lk-carousel",ref:i,...t},f.createElement(Du,{tracks:p},t.children))}function ny({value:n,onPinChange:e,onWidgetChange:t,children:i}){const r=O0(n);return f.useEffect(()=>{B.debug("PinState Updated",{state:r.pin.state}),e&&r.pin.state&&e(r.pin.state)},[r.pin.state,e]),f.useEffect(()=>{B.debug("Widget Updated",{widgetState:r.widget.state}),t&&r.widget.state&&t(r.widget.state)},[t,r.widget.state]),f.createElement(Zi.Provider,{value:r},i)}function iy({room:n,volume:e,muted:t}){const i=Ru([E.Source.Microphone,E.Source.ScreenShareAudio,E.Source.Unknown],{updateOnlyOn:[],onlySubscribed:!0,room:n}).filter(r=>!r.participant.isLocal&&r.publication.kind===E.Kind.Audio);return f.createElement("div",{style:{display:"none"}},i.map(r=>f.createElement(Mu,{key:pe(r),trackRef:r,volume:e,muted:t})))}function ry(n){const e=f.useMemo(()=>gt(n,{className:"lk-toast"}),[n]);return f.createElement("div",{...e},n.children)}function sy(n){const[e,t]=f.useState(void 0),i=Xs(n.room);return f.useEffect(()=>{switch(i){case K.Reconnecting:t(f.createElement(f.Fragment,null,f.createElement(La,{className:"lk-spinner"})," Reconnecting"));break;case K.Connecting:t(f.createElement(f.Fragment,null,f.createElement(La,{className:"lk-spinner"})," Connecting"));break;case K.Disconnected:t(f.createElement(f.Fragment,null,"Disconnected"));break;default:t(void 0);break}},[i]),e?f.createElement(ry,{className:"lk-toast-connection-state"},e):f.createElement(f.Fragment,null)}const oy=f.forwardRef(function({entry:n,hideName:e=!1,hideTimestamp:t=!1,messageFormatter:i,...r},s){var a,o,c,l;const u=f.useMemo(()=>i?i(n.message):n.message,[n.message,i]),d=!!n.editTimestamp,h=new Date(n.timestamp),p=typeof navigator<"u"?navigator.language:"en-US",b=((a=n.from)==null?void 0:a.name)??((o=n.from)==null?void 0:o.identity);return f.createElement("li",{ref:s,className:"lk-chat-entry",title:h.toLocaleTimeString(p,{timeStyle:"full"}),"data-lk-message-origin":(c=n.from)!=null&&c.isLocal?"local":"remote",...r},(!t||!e||d)&&f.createElement("span",{className:"lk-meta-data"},!e&&f.createElement("strong",{className:"lk-participant-name"},b),(!t||d)&&f.createElement("span",{className:"lk-timestamp"},d&&"edited ",h.toLocaleTimeString(p,{timeStyle:"short"}))),f.createElement("span",{className:"lk-message-body"},u),f.createElement("span",{className:"lk-message-attachements"},(l=n.attachedFiles)==null?void 0:l.map(m=>m.type.startsWith("image/")&&f.createElement("img",{style:{maxWidth:"300px",maxHeight:"300px"},key:m.name,src:URL.createObjectURL(m),alt:m.name}))))});function ay({messageFormatter:n,messageDecoder:e,messageEncoder:t,channelTopic:i,...r}){const s=f.useRef(null),a=f.useRef(null),o=f.useMemo(()=>({messageDecoder:e,messageEncoder:t,channelTopic:i}),[e,t,i]),{chatMessages:c,send:l,isSending:u}=ub(o),d=Kn(),h=f.useRef(0);async function p(b){b.preventDefault(),a.current&&a.current.value.trim()!==""&&(await l(a.current.value),a.current.value="",a.current.focus())}return f.useEffect(()=>{var b;s&&((b=s.current)==null||b.scrollTo({top:s.current.scrollHeight}))},[s,c]),f.useEffect(()=>{var b,m,T,S,P;if(!d||c.length===0)return;if((b=d.widget.state)!=null&&b.showChat&&c.length>0&&h.current!==((m=c[c.length-1])==null?void 0:m.timestamp)){h.current=(T=c[c.length-1])==null?void 0:T.timestamp;return}const M=c.filter(g=>!h.current||g.timestamp>h.current).length,{widget:v}=d;M>0&&((S=v.state)==null?void 0:S.unreadMessages)!==M&&((P=v.dispatch)==null||P.call(v,{msg:"unread_msg",count:M}))},[c,d?.widget]),f.createElement("div",{...r,className:"lk-chat"},f.createElement("div",{className:"lk-chat-header"},"Messages",d&&f.createElement(_u,{className:"lk-close-button"},f.createElement(vb,null))),f.createElement("ul",{className:"lk-list lk-chat-messages",ref:s},r.children?c.map((b,m)=>Eu(r.children,{entry:b,key:b.id??m,messageFormatter:n})):c.map((b,m,T)=>{const S=m>=1&&T[m-1].from===b.from,P=m>=1&&b.timestamp-T[m-1].timestamp<6e4;return f.createElement(oy,{key:b.id??m,hideName:S,hideTimestamp:S===!1?!1:P,entry:b,messageFormatter:n})})),f.createElement("form",{className:"lk-chat-form",onSubmit:p},f.createElement("input",{className:"lk-form-control lk-chat-form-input",disabled:u,ref:a,type:"text",placeholder:"Enter a message...",onInput:b=>b.stopPropagation(),onKeyDown:b=>b.stopPropagation(),onKeyUp:b=>b.stopPropagation()}),f.createElement("button",{type:"submit",className:"lk-button lk-chat-form-button",disabled:u},"Send")))}function ja({kind:n,initialSelection:e,onActiveDeviceChange:t,tracks:i,requestPermissions:r=!1,...s}){const[a,o]=f.useState(!1),[c,l]=f.useState([]),[u,d]=f.useState(!0),[h,p]=f.useState(r),b=(P,M)=>{B.debug("handle device change"),o(!1),t?.(P,M)},m=f.useRef(null),T=f.useRef(null);f.useLayoutEffect(()=>{a&&p(!0)},[a]),f.useLayoutEffect(()=>{let P;return m.current&&T.current&&(c||u)&&(P=vv(m.current,T.current,(M,v)=>{T.current&&Object.assign(T.current.style,{left:`${M}px`,top:`${v}px`})})),d(!1),()=>{P?.()}},[m,T,c,u]);const S=f.useCallback(P=>{T.current&&P.target!==m.current&&a&&bv(T.current,P)&&o(!1)},[a,T,m]);return f.useEffect(()=>(document.addEventListener("click",S),()=>{document.removeEventListener("click",S)}),[S]),f.createElement(f.Fragment,null,f.createElement("button",{className:"lk-button lk-button-menu","aria-pressed":a,...s,onClick:()=>o(!a),ref:m},s.children),!s.disabled&&f.createElement("div",{className:"lk-device-menu",ref:T,style:{visibility:a?"visible":"hidden"}},n?f.createElement(wr,{initialSelection:e,onActiveDeviceChange:P=>b(n,P),onDeviceListChange:l,kind:n,track:i?.[n],requestPermissions:h}):f.createElement(f.Fragment,null,f.createElement("div",{className:"lk-device-menu-heading"},"Audio inputs"),f.createElement(wr,{kind:"audioinput",onActiveDeviceChange:P=>b("audioinput",P),onDeviceListChange:l,track:i?.audioinput,requestPermissions:h}),f.createElement("div",{className:"lk-device-menu-heading"},"Video inputs"),f.createElement(wr,{kind:"videoinput",onActiveDeviceChange:P=>b("videoinput",P),onDeviceListChange:l,track:i?.videoinput,requestPermissions:h}))))}function cy(){f.useEffect(()=>{L0()},[])}function ly({props:n}){const{dispatch:e,state:t}=bu().widget,i="lk-button lk-settings-toggle";return{mergedProps:f.useMemo(()=>st(n,{className:i,onClick:()=>{e&&e({msg:"toggle_settings"})},"aria-pressed":t!=null&&t.showSettings?"true":"false"}),[n,i,e,t])}}const uy=f.forwardRef(function(n,e){const{mergedProps:t}=ly({props:n});return f.createElement("button",{ref:e,...t},n.children)}),dy=n=>{switch(n){case E.Source.Camera:return 1;case E.Source.Microphone:return 2;case E.Source.ScreenShare:return 3;default:return 0}};function hy({variation:n,controls:e,saveUserChoices:t=!0,onDeviceError:i,...r}){var s;const[a,o]=f.useState(!1),c=Kn();f.useEffect(()=>{var R,I;((R=c?.widget.state)==null?void 0:R.showChat)!==void 0&&o((I=c?.widget.state)==null?void 0:I.showChat)},[(s=c?.widget.state)==null?void 0:s.showChat]);const l=H0(`(max-width: ${a?1e3:760}px)`)?"minimal":"verbose";n??(n=l);const u={leave:!0,...e},d=Y0();if(!d)u.camera=!1,u.chat=!1,u.microphone=!1,u.screenShare=!1;else{const R=I=>d.canPublish&&(d.canPublishSources.length===0||d.canPublishSources.includes(dy(I)));u.camera??(u.camera=R(E.Source.Camera)),u.microphone??(u.microphone=R(E.Source.Microphone)),u.screenShare??(u.screenShare=R(E.Source.ScreenShare)),u.chat??(u.chat=d.canPublishData&&e?.chat)}const h=f.useMemo(()=>n==="minimal"||n==="verbose",[n]),p=f.useMemo(()=>n==="textOnly"||n==="verbose",[n]),b=Ev(),[m,T]=f.useState(!1),S=f.useCallback(R=>{T(R)},[T]),P=gt({className:"lk-control-bar"},r),{saveAudioInputEnabled:M,saveVideoInputEnabled:v,saveAudioInputDeviceId:g,saveVideoInputDeviceId:y}=db({preventSave:!t}),C=f.useCallback((R,I)=>I?M(R):null,[M]),x=f.useCallback((R,I)=>I?v(R):null,[v]);return f.createElement("div",{...P},u.microphone&&f.createElement("div",{className:"lk-button-group"},f.createElement(Pr,{source:E.Source.Microphone,showIcon:h,onChange:C,onDeviceError:R=>i?.({source:E.Source.Microphone,error:R})},p&&"Microphone"),f.createElement("div",{className:"lk-button-group-menu"},f.createElement(ja,{kind:"audioinput",onActiveDeviceChange:(R,I)=>g(I??"default")}))),u.camera&&f.createElement("div",{className:"lk-button-group"},f.createElement(Pr,{source:E.Source.Camera,showIcon:h,onChange:x,onDeviceError:R=>i?.({source:E.Source.Camera,error:R})},p&&"Camera"),f.createElement("div",{className:"lk-button-group-menu"},f.createElement(ja,{kind:"videoinput",onActiveDeviceChange:(R,I)=>y(I??"default")}))),u.screenShare&&b&&f.createElement(Pr,{source:E.Source.ScreenShare,captureOptions:{audio:!0,selfBrowserSurface:"include"},showIcon:h,onChange:S,onDeviceError:R=>i?.({source:E.Source.ScreenShare,error:R})},p&&(m?"Stop screen share":"Share screen")),u.chat&&f.createElement(_u,null,h&&f.createElement(bb,null),p&&"Chat"),u.settings&&f.createElement(uy,null,h&&f.createElement(kb,null),p&&"Settings"),u.leave&&f.createElement(pb,null,h&&f.createElement(Sb,null),p&&"Leave"),f.createElement(Mb,null))}function fy({chatMessageFormatter:n,chatMessageDecoder:e,chatMessageEncoder:t,SettingsComponent:i,...r}){var s,a;const[o,c]=f.useState({showChat:!1,unreadMessages:0,showSettings:!1}),l=f.useRef(null),u=Ru([{source:E.Source.Camera,withPlaceholder:!0},{source:E.Source.ScreenShare,withPlaceholder:!1}],{updateOnlyOn:[_.ActiveSpeakersChanged],onlySubscribed:!1}),d=T=>{B.debug("updating widget state",T),c(T)},h=x0(),p=u.filter(ue).filter(T=>T.publication.source===E.Source.ScreenShare),b=(s=tb(h))==null?void 0:s[0],m=u.filter(T=>!fv(T,b));return f.useEffect(()=>{var T,S,P,M,v,g;if(p.some(y=>y.publication.isSubscribed)&&l.current===null?(B.debug("Auto set screen share focus:",{newScreenShareTrack:p[0]}),(S=(T=h.pin).dispatch)==null||S.call(T,{msg:"set_pin",trackReference:p[0]}),l.current=p[0]):l.current&&!p.some(y=>{var C,x;return y.publication.trackSid===((x=(C=l.current)==null?void 0:C.publication)==null?void 0:x.trackSid)})&&(B.debug("Auto clearing screen share focus."),(M=(P=h.pin).dispatch)==null||M.call(P,{msg:"clear_pin"}),l.current=null),b&&!ue(b)){const y=u.find(C=>C.participant.identity===b.participant.identity&&C.source===b.source);y!==b&&ue(y)&&((g=(v=h.pin).dispatch)==null||g.call(v,{msg:"set_pin",trackReference:y}))}},[p.map(T=>`${T.publication.trackSid}_${T.publication.isSubscribed}`).join(),(a=b?.publication)==null?void 0:a.trackSid,u]),cy(),f.createElement("div",{className:"lk-video-conference",...r},gv()&&f.createElement(ny,{value:h,onWidgetChange:d},f.createElement("div",{className:"lk-video-conference-inner"},b?f.createElement("div",{className:"lk-focus-layout-wrapper"},f.createElement(zb,null,f.createElement(ty,{tracks:m},f.createElement(cs,null)),b&&f.createElement(Gb,{trackRef:b}))):f.createElement("div",{className:"lk-grid-layout-wrapper"},f.createElement(Qb,{tracks:u},f.createElement(cs,null))),f.createElement(hy,{controls:{chat:!0,settings:!!i}})),f.createElement(ay,{style:{display:o.showChat?"grid":"none"},messageFormatter:n,messageEncoder:t,messageDecoder:e}),i&&f.createElement("div",{className:"lk-settings-menu-modal",style:{display:o.showSettings?"block":"none"}},f.createElement(i,null))),f.createElement(iy,null),f.createElement(sy,null))}const Ty=Lu(function(){const{classId:e}=Nu(),[t,i]=f.useState(""),{getToken:r}=Fu();return f.useEffect(()=>{e&&(async()=>{try{const a=await r(),o=await Uu("/video/token",a,{method:"POST",body:JSON.stringify({classId:e,isInstructor:!1})});o.token&&i(o.token)}catch(a){console.error("Failed to get video token",a)}})()},[e]),t?Jn.jsx(j0,{video:!0,audio:!0,token:t,serverUrl:"wss://your-project.livekit.cloud","data-lk-theme":"default",style:{height:"100vh"},children:Jn.jsx(fy,{})}):Jn.jsx("div",{className:"flex items-center justify-center h-screen bg-zinc-900 text-white",children:Jn.jsx("p",{children:"Loading Studio..."})})});export{Ty as default};
