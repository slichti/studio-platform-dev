import{w as K,e as Q}from"./chunk-EPOLDU6W-QEwcj8It.js";import{j as e}from"./vendor-puck-d5q8lBvG.js";import{a as x}from"./api-D1U4i9fn.js";import{r as s}from"./vendor-charts-C-svo-KU.js";import{E as k,S as v,C as w}from"./Dialogs-BRIOyyxK.js";import{u as V}from"./chunk-OT5FTIRN-D-HR3R-F.js";import"./Modal-BYssylRb.js";import"./index-DuaIRY-g.js";const ce=K(function(){const{tenant:h,member:X,roles:I}=Q(),u=I.includes("owner");if(!u)return e.jsx("div",{className:"p-8 text-center text-zinc-500 dark:text-zinc-400",children:"You do not have permission to view this page."});const E=()=>{const t="https://studio-platform-api.slichti.workers.dev";window.location.href=`${t}/studios/stripe/connect?tenantId=${h.id}`},{getToken:m}=V(),[p,M]=s.useState(null),[C,L]=s.useState([]),[z,B]=s.useState(null),[r,d]=s.useState({isOpen:!1,message:""}),[c,f]=s.useState({isOpen:!1,message:""}),[l,b]=s.useState(null);s.useEffect(()=>{if(!h.stripeAccountId||!u)return;(async()=>{const a=await m(),i="https://studio-platform-api.slichti.workers.dev";x(`${i}/commerce/stats`,a).then(n=>{n&&M(n)}),x(`${i}/commerce/transactions`,a).then(n=>{n&&n.transactions&&L(n.transactions)}),x(`${i}/commerce/balance`,a).then(n=>{n&&!n.error&&B(n)})})()},[h.id,u,m]);const[g,S]=s.useState("overview"),[j,O]=s.useState([]),[R,D]=s.useState(null);s.useEffect(()=>{g==="failed"&&u&&(async()=>{const a=await m(),n=await x("https://studio-platform-api.slichti.workers.dev/failed-payments",a);n?.payments&&O(n.payments)})()},[g,u,m]);const Y=t=>{b(t)},y=async()=>{if(l){D(l);try{const t=await m(),i=await x(`https://studio-platform-api.slichti.workers.dev/failed-payments/${l}/retry`,t,{method:"POST"});i.success?(f({isOpen:!0,message:`Payment successful! (Status: ${i.status})`}),O(n=>n.filter(G=>G.id!==l))):d({isOpen:!0,message:i.error||"Retry failed"})}catch{d({isOpen:!0,message:"Error processing retry"})}finally{D(null),b(null)}}},[o,q]=s.useState(null),[U,N]=s.useState(!1),[P,$]=s.useState(""),[A,_]=s.useState(""),[F,T]=s.useState(!1),H=t=>{q(t),$((t.amount/100).toFixed(2)),N(!0)},J=async()=>{if(o){T(!0);try{const t=await m();let a="pos";o.description?.includes("Pack")&&(a="pack"),o.description?.includes("Membership")&&(a="membership");const i=await x("https://studio-platform-api.slichti.workers.dev/refunds",t,{method:"POST",body:JSON.stringify({amount:Math.round(parseFloat(P)*100),reason:A,referenceId:o.id,type:o.type||a})});i&&!i.error?(f({isOpen:!0,message:"Refund processed successfully"}),N(!1)):d({isOpen:!0,message:i?.error||"Refund failed"})}catch(t){d({isOpen:!0,message:t.message||"Refund failed"})}finally{T(!1)}}};return e.jsxs("div",{className:"max-w-4xl text-zinc-900 dark:text-zinc-100",children:[e.jsx(k,{isOpen:r.isOpen,onClose:()=>d({...r,isOpen:!1}),message:r.message}),e.jsx(v,{isOpen:c.isOpen,onClose:()=>f({...c,isOpen:!1}),message:c.message}),e.jsx(w,{isOpen:!!l,onClose:()=>b(null),onConfirm:y,title:"Retry Payment",message:"Attempt to charge the customer's payment method now?",confirmText:"Charge Now"}),e.jsx(k,{isOpen:r.isOpen,onClose:()=>d({...r,isOpen:!1}),message:r.message}),e.jsx(v,{isOpen:c.isOpen,onClose:()=>f({...c,isOpen:!1}),message:c.message}),e.jsx(w,{isOpen:!!l,onClose:()=>b(null),onConfirm:y,title:"Retry Payment",message:"Attempt to charge the customer's payment method now?",confirmText:"Charge Now"}),e.jsx(k,{isOpen:r.isOpen,onClose:()=>d({...r,isOpen:!1}),message:r.message}),e.jsx(v,{isOpen:c.isOpen,onClose:()=>f({...c,isOpen:!1}),message:c.message}),e.jsx(w,{isOpen:!!l,onClose:()=>b(null),onConfirm:y,title:"Retry Payment",message:"Attempt to charge the customer's payment method now?",confirmText:"Charge Now"}),e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Finances"}),e.jsxs("div",{className:"flex bg-zinc-100 dark:bg-zinc-800 p-1 rounded-lg",children:[e.jsx("button",{onClick:()=>S("overview"),className:`px-4 py-1.5 text-sm font-medium rounded-md transition ${g==="overview"?"bg-white dark:bg-black shadow-sm text-zinc-900 dark:text-zinc-100":"text-zinc-500 hover:text-zinc-700"}`,children:"Overview"}),e.jsxs("button",{onClick:()=>S("failed"),className:`px-4 py-1.5 text-sm font-medium rounded-md transition flex items-center gap-2 ${g==="failed"?"bg-white dark:bg-black shadow-sm text-zinc-900 dark:text-zinc-100":"text-zinc-500 hover:text-zinc-700"}`,children:["Failed Payments",j.length>0&&e.jsx("span",{className:"w-5 h-5 flex items-center justify-center bg-red-100 text-red-600 text-xs rounded-full",children:j.length})]})]})]}),U&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 rounded-xl shadow-xl border border-zinc-200 dark:border-zinc-800 w-full max-w-md p-6 animate-in fade-in zoom-in duration-200",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Process Refund"}),e.jsxs("p",{className:"text-sm text-zinc-500 mb-6",children:["Refund for ",o?.description," on ",new Date(o?.date).toLocaleDateString()]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Amount ($)"}),e.jsx("input",{type:"number",value:P,onChange:t=>$(t.target.value),className:"w-full bg-zinc-50 dark:bg-zinc-800 border-none rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-200 dark:focus:ring-zinc-700"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Reason"}),e.jsx("textarea",{value:A,onChange:t=>_(t.target.value),placeholder:"Customer requested...",className:"w-full bg-zinc-50 dark:bg-zinc-800 border-none rounded-md px-3 py-2 outline-none focus:ring-2 focus:ring-zinc-200 dark:focus:ring-zinc-700"})]})]}),e.jsxs("div",{className:"flex gap-3 mt-6 justify-end",children:[e.jsx("button",{onClick:()=>N(!1),className:"px-4 py-2 text-zinc-600 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-md",children:"Cancel"}),e.jsx("button",{onClick:J,disabled:F,className:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50",children:F?"Processing...":"Confirm Refund"})]})]})}),g==="failed"?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-zinc-200 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/50",children:[e.jsx("h3",{className:"font-semibold",children:"Failed Subscription Payments"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Subscriptions currently suspended due to payment failure."})]}),j.length===0?e.jsx("div",{className:"p-12 text-center text-zinc-500",children:e.jsx("p",{children:"No failed payments found. All subscriptions are healthy."})}):e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-zinc-200 dark:border-zinc-800",children:[e.jsx("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Customer"}),e.jsx("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Plan"}),e.jsx("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Status"}),e.jsx("th",{className:"text-left px-4 py-3 font-medium text-zinc-500",children:"Date"}),e.jsx("th",{className:"text-right px-4 py-3 font-medium text-zinc-500",children:"Action"})]})}),e.jsx("tbody",{children:j.map(t=>e.jsxs("tr",{className:"border-b last:border-0 border-zinc-200 dark:border-zinc-800",children:[e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"font-medium text-zinc-900 dark:text-zinc-100",children:t.member?.user?.name||"Unknown"}),e.jsx("div",{className:"text-xs text-zinc-500",children:t.member?.user?.email})]}),e.jsx("td",{className:"px-4 py-3 text-zinc-600",children:t.planId}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${t.dunningState==="failed"?"bg-red-100 text-red-800":"bg-amber-100 text-amber-800"}`,children:t.dunningState?.toUpperCase()})}),e.jsx("td",{className:"px-4 py-3 text-zinc-500",children:t.lastDunningAt?new Date(t.lastDunningAt).toLocaleDateString():"-"}),e.jsx("td",{className:"px-4 py-3 text-right",children:e.jsx("button",{onClick:()=>Y(t.id),disabled:R===t.id,className:"text-xs bg-zinc-900 text-white px-3 py-1.5 rounded hover:bg-zinc-800 disabled:opacity-50",children:R===t.id?"Retrying...":"Retry Payment"})})]},t.id))})]})]})}):h.stripeAccountId?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-800 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-green-100 dark:bg-green-800 flex items-center justify-center text-green-600 dark:text-green-300",children:"âœ“"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-green-800 dark:text-green-300",children:"Stripe Connected"}),e.jsx("p",{className:"text-sm text-green-600 dark:text-green-400",children:"Your account is ready to process payments."})]})]}),e.jsx("div",{className:"text-sm font-mono text-zinc-500 dark:text-zinc-400",children:h.stripeAccountId})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-lg shadow-sm",children:[e.jsx("div",{className:"text-sm font-medium mb-1 text-zinc-500 dark:text-zinc-400",children:"Total Revenue"}),e.jsxs("div",{className:"text-3xl font-bold",children:["$",p?(p.totalRevenue/100).toFixed(2):"0.00"]}),e.jsx("div",{className:"text-xs mt-2 text-zinc-500 dark:text-zinc-400",children:"Est. All Time"})]}),e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-lg shadow-sm",children:[e.jsx("div",{className:"text-sm font-medium mb-1 text-zinc-500 dark:text-zinc-400",children:"Monthly Recurring"}),e.jsxs("div",{className:"text-3xl font-bold",children:["$",p?(p.mrr/100).toFixed(2):"0.00"]}),e.jsxs("div",{className:"text-xs mt-2 text-zinc-500 dark:text-zinc-400",children:["Active Subs: ",p?.activeSubscriptions||0]})]}),e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-6 rounded-lg shadow-sm",children:[e.jsx("div",{className:"text-sm font-medium mb-1 text-zinc-500 dark:text-zinc-400",children:"Stripe Balance"}),e.jsxs("div",{className:"text-3xl font-bold",children:["$",z?(z.available/100).toFixed(2):"0.00"]}),e.jsxs("div",{className:"text-xs mt-2 text-zinc-500 dark:text-zinc-400",children:["Pending: $",z?(z.pending/100).toFixed(2):"0.00"]})]})]}),e.jsxs("div",{className:"p-4 rounded-lg bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800",children:[e.jsx("h3",{className:"font-semibold mb-4 text-zinc-900 dark:text-zinc-100",children:"Transaction History"}),C.length===0?e.jsx("p",{className:"text-sm text-zinc-500 dark:text-zinc-400",children:"No recent transactions."}):e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-zinc-200 dark:border-zinc-700",children:[e.jsx("th",{className:"text-left py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Date"}),e.jsx("th",{className:"text-left py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Description"}),e.jsx("th",{className:"text-left py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Customer"}),e.jsx("th",{className:"text-right py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Amount"}),e.jsx("th",{className:"text-right py-2 font-medium text-zinc-700 dark:text-zinc-300",children:"Actions"})]})}),e.jsx("tbody",{children:C.map(t=>e.jsxs("tr",{className:"border-b last:border-0 border-zinc-200 dark:border-zinc-700",children:[e.jsx("td",{className:"py-2 text-zinc-600 dark:text-zinc-400",children:new Date(t.date).toLocaleDateString()}),e.jsx("td",{className:"py-2 text-zinc-600 dark:text-zinc-400",children:t.description}),e.jsx("td",{className:"py-2 text-zinc-600 dark:text-zinc-400",children:t.customer}),e.jsxs("td",{className:"py-2 text-right text-zinc-900 dark:text-zinc-100",children:["$",(t.amount/100).toFixed(2)]}),e.jsx("td",{className:"py-2 text-right",children:e.jsx("button",{onClick:()=>H(t),className:"text-xs text-red-600 hover:text-red-700 hover:underline",children:"Refund"})})]},t.id))})]})]})]}):e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 p-8 rounded-lg shadow-sm text-center",children:[e.jsx("div",{className:"mb-4 text-4xl",children:"ðŸ’³"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Setup Payouts"}),e.jsx("p",{className:"mb-6 max-w-md mx-auto text-zinc-500 dark:text-zinc-400",children:"Connect with Stripe to start accepting payments for class packs and memberships. Funds will be deposited directly to your bank account."}),e.jsxs("button",{onClick:E,className:"bg-[#635BFF] text-white px-6 py-2.5 rounded-md font-medium hover:bg-[#534be0] transition-colors inline-flex items-center gap-2",children:[e.jsx("span",{children:"Connect with Stripe"}),e.jsx("svg",{className:"w-4 h-4",fill:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{d:"M10 6v-2h14v16h-14v-2h-2v4h18v-20h-18v4h2zm-8 4h10v-3l6 5-6 5v-3h-10v-4z"})})]}),e.jsx("p",{className:"mt-4 text-xs text-zinc-400 dark:text-zinc-500",children:"You will be redirected to Stripe to verify your business information."})]})]})});export{ce as default};
