import{w as oe,e as de,r as n}from"./chunk-EPOLDU6W-mFdHVWdG.js";import{j as e}from"./jsx-runtime-u17CrQMm.js";import{a as x}from"./api-LAgipKeK.js";import{c as ue}from"./createLucideIcon-DI_cxpme.js";import{P as $}from"./plus-Dh_J2SL1.js";import{S as me}from"./square-pen-BYdsRrno.js";import{A as xe}from"./archive-DcrbgpvI.js";import{X as q}from"./x-CiCFaN0j.js";import{U as fe}from"./user-CQp1uXw2.js";import{S as B}from"./search-DruSDDtp.js";import{T as he}from"./trash-2-CqDiHFCr.js";import{S as pe}from"./shopping-cart-DYOvvu3n.js";import{C as be}from"./credit-card-BrEDGTo6.js";import{L as ge}from"./loader-circle-e7Murp-9.js";const je=[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]],F=ue("wifi",je);var M="https://js.stripe.com/terminal/v1",ye=function(){var r=document.createElement("script");r.src=M;var i=document.head||document.body;if(!i)throw new Error("Expected document.body not to be null. Terminal requires a <body> element.");return i.appendChild(r),r},k=null,we=function(){return k!==null||(k=new Promise(function(r,i){if(typeof window>"u"){r(null);return}if(window.StripeTerminal){r(window.StripeTerminal);return}var u=document.querySelector('script[src="'.concat(M,'"], script[src="').concat(M,'/"]'))||ye();u.addEventListener("load",function(){window.StripeTerminal?r(window.StripeTerminal):i(new Error("StripeTerminal not available"))}),u.addEventListener("error",function(){i(new Error("Failed to load StripeTerminal"))})})),k},X=Promise.resolve().then(we),H=!1;X.catch(function(d){H||console.warn(d)});var ve=function(){return H=!0,X};const Qe=oe(function(){const{tenant:r,token:i,features:u}=de()||{},[f,h]=n.useState([]),[c,o]=n.useState([]),[b,C]=n.useState(!0),[p,g]=n.useState(!1),[j,K]=n.useState(null),[y,w]=n.useState("disconnected"),[I,Y]=n.useState([]),[A,Q]=n.useState(null),[Z,N]=n.useState(!1),[ee,z]=n.useState(!1),[D,L]=n.useState(null),[te,U]=n.useState(0),[l,S]=n.useState(null),[V,P]=n.useState(!1),[v,_]=n.useState(""),[se,J]=n.useState([]),[re,W]=n.useState(!1),[ne,T]=n.useState(!1);n.useEffect(()=>{ie()},[te,r]);const ie=async()=>{try{const t=await x("/pos/products",i);t.products&&h(t.products.filter(s=>s.isActive))}catch(t){console.error(t)}finally{C(!1)}};n.useEffect(()=>{if(!r)return;(async()=>{const s=await ve();if(!s)return;const m=s.create({onFetchConnectionToken:async()=>{const a=await x("/pos/connection-token",i,{method:"POST"});if(a.error)throw new Error(a.error);return a.secret},onUnexpectedReaderDisconnect:()=>{w("disconnected"),Q(null)}});K(m)})()},[r]);const ae=async t=>{w("connecting");try{const s=await j.connectReader(t);s.reader?(Q(s.reader),w("connected"),N(!1)):(console.error("Connect failed",s.error),w("disconnected"))}catch(s){console.error("Connect error",s),w("disconnected")}},ce=t=>{o(s=>s.find(a=>a.productId===t.id)?s.map(a=>a.productId===t.id?{...a,quantity:a.quantity+1}:a):[...s,{productId:t.id,name:t.name,price:t.price,quantity:1}])},le=t=>{o(s=>s.filter(m=>m.productId!==t))},G=c.reduce((t,s)=>t+s.price*s.quantity,0),R=async t=>{if(c.length!==0){g(!0);try{if(t==="terminal"){if(y!=="connected"||!A){alert("Please connect a reader first."),g(!1),N(!0);return}const s=await x("/pos/process-payment",i,{method:"POST",body:JSON.stringify({items:c,customerId:l?.stripeCustomerId})});if(s.error)throw new Error(s.error);const m=s.clientSecret,a=await j.collectPaymentMethod(m);if(a.error)throw new Error(a.error.message);const O=await j.processPayment(a.paymentIntent);if(O.error)throw new Error(O.error.message);await E("card",O.paymentIntent.id,l?.id)}else t==="card"?await E("card","manual_entry",l?.id):await E("cash",null,l?.id);o([]),S(null),alert("Order Completed!"),U(s=>s+1)}catch(s){console.error(s),alert(`Checkout Failed: ${s.message}`)}finally{g(!1)}}},E=async(t,s,m)=>{await x("/pos/orders",i,{method:"POST",body:JSON.stringify({items:c,memberId:m||null,paymentMethod:t,totalAmount:G})})};return n.useEffect(()=>{if(!v||v.length<2){J([]);return}const t=setTimeout(async()=>{W(!0);try{const s=await x(`/pos/customers?query=${v}`,i);J(s.customers||[])}catch(s){console.error(s)}finally{W(!1)}},500);return()=>clearTimeout(t)},[v]),e.jsxs("div",{className:"flex h-full",children:[e.jsxs("div",{className:"flex-1 p-6 overflow-y-auto bg-zinc-50 dark:bg-zinc-950",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-zinc-900 dark:text-zinc-100",children:"POS & Retail"}),e.jsx("p",{className:"text-sm text-zinc-500",children:"Manage inventory and process sales."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>N(!0),className:`flex items-center gap-2 px-3 py-2 rounded-lg border text-sm transition-colors ${y==="connected"?"bg-green-50 text-green-700 border-green-200":"bg-white text-zinc-700 border-zinc-200"}`,children:[e.jsx(F,{size:16}),y==="connected"?A?.label||"Reader Connected":"Connect Reader"]}),e.jsxs("button",{onClick:()=>{L(null),z(!0)},className:"flex items-center gap-2 px-3 py-2 bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 rounded-lg text-sm hover:opacity-90",children:[e.jsx($,{size:16})," Add Product"]})]})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4",children:f.map(t=>e.jsxs("div",{className:"bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-4 flex flex-col gap-3 shadow-sm hover:shadow-md transition-shadow group relative",children:[e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1",children:e.jsx("button",{onClick:()=>{L(t),z(!0)},className:"p-1.5 bg-zinc-100 rounded text-zinc-600 hover:text-blue-600",children:e.jsx(me,{size:14})})}),e.jsx("div",{className:"aspect-square bg-zinc-100 dark:bg-zinc-800 rounded-lg flex items-center justify-center text-zinc-300",children:t.imageUrl?e.jsx("img",{src:t.imageUrl,className:"w-full h-full object-cover rounded-lg"}):e.jsx(xe,{size:32})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h3",{className:"font-medium text-zinc-900 dark:text-zinc-100 truncate",children:t.name}),e.jsxs("span",{className:"text-xs font-bold bg-zinc-100 dark:bg-zinc-800 px-1.5 py-0.5 rounded text-zinc-600",children:["$",(t.price/100).toFixed(2)]})]}),e.jsx("p",{className:"text-xs text-zinc-500 truncate",children:t.category||"General"})]}),e.jsxs("div",{className:"mt-auto pt-2 flex items-center justify-between",children:[e.jsxs("span",{className:`text-xs ${t.stockQuantity>0?"text-green-600":"text-red-500"} font-medium`,children:[t.stockQuantity," in stock"]}),e.jsx("button",{onClick:()=>ce(t),disabled:t.stockQuantity<=0,className:"p-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx($,{size:16})})]})]},t.id))})]}),e.jsxs("div",{className:"w-96 bg-white dark:bg-zinc-900 border-l border-zinc-200 dark:border-zinc-800 flex flex-col z-10 shadow-xl",children:[e.jsx("div",{className:"p-4 border-b border-zinc-100 dark:border-zinc-800",children:l?e.jsxs("div",{className:"flex justify-between items-center bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg border border-blue-100 dark:border-blue-800",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-200 text-blue-700 flex items-center justify-center text-xs font-bold",children:l.profile?.firstName?.[0]||l.name?.[0]||"C"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-blue-900 dark:text-blue-100",children:l.profile?`${l.profile.firstName} ${l.profile.lastName}`:l.name}),e.jsx("div",{className:"text-[10px] text-blue-600 dark:text-blue-300 truncate w-32",children:l.email})]})]}),e.jsx("button",{onClick:()=>S(null),className:"text-blue-400 hover:text-blue-600",children:e.jsx(q,{size:14})})]}):e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>P(!V),className:"w-full flex items-center justify-between px-3 py-2 bg-zinc-50 dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg text-sm text-zinc-500 hover:border-blue-400 transition-colors",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(fe,{size:14})," Add Customer to Sale"]}),e.jsx($,{size:14})]}),V&&e.jsxs("div",{className:"absolute top-12 left-0 right-0 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg shadow-lg p-2 z-20",children:[e.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 bg-zinc-50 rounded border border-zinc-100 mb-2",children:[e.jsx(B,{size:14,className:"text-zinc-400"}),e.jsx("input",{autoFocus:!0,className:"bg-transparent text-sm w-full outline-none",placeholder:"Search name or email...",value:v,onChange:t=>_(t.target.value)})]}),e.jsxs("div",{className:"max-h-48 overflow-y-auto space-y-1",children:[re&&e.jsx("div",{className:"text-xs text-center p-2 text-zinc-400",children:"Searching..."}),se.map(t=>e.jsxs("button",{onClick:()=>{S(t),P(!1),_("")},className:"w-full text-left p-2 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded text-sm group",children:[e.jsx("div",{className:"font-medium",children:t.profile?`${t.profile.firstName} ${t.profile.lastName}`:t.name}),e.jsx("div",{className:"text-xs text-zinc-500",children:t.email}),t.isStripeGuest&&e.jsx("span",{className:"text-[10px] bg-indigo-50 text-indigo-600 px-1 rounded ml-auto",children:"Stripe"})]},t.id||t.stripeCustomerId)),e.jsx("button",{onClick:()=>{T(!0),P(!1)},className:"w-full text-left p-2 border-t border-zinc-100 text-blue-600 text-xs font-medium hover:bg-blue-50 rounded mt-1",children:"+ Create New Customer"})]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[c.map((t,s)=>e.jsxs("div",{className:"flex justify-between items-center group",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-zinc-900 dark:text-zinc-100",children:t.name}),e.jsxs("div",{className:"text-xs text-zinc-500",children:["$",(t.price/100).toFixed(2)," x ",t.quantity]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"font-medium text-sm",children:["$",(t.price*t.quantity/100).toFixed(2)]}),e.jsx("button",{onClick:()=>le(t.productId),className:"text-zinc-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(he,{size:14})})]})]},s)),c.length===0&&e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-zinc-400 space-y-2 opacity-50",children:[e.jsx(pe,{size:32}),e.jsx("span",{className:"text-sm",children:"Cart is empty"})]})]}),e.jsxs("div",{className:"p-4 border-t border-zinc-200 dark:border-zinc-800 bg-zinc-50/50 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center text-lg font-bold text-zinc-900 dark:text-zinc-100",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["$",(G/100).toFixed(2)]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("button",{disabled:p||c.length===0,onClick:()=>R("card"),className:"bg-white border border-zinc-200 text-zinc-700 py-3 rounded-lg font-medium hover:bg-zinc-50 flex items-center justify-center gap-2 disabled:opacity-50",children:[e.jsx(be,{size:16})," Manual Card"]}),e.jsx("button",{disabled:p||c.length===0,onClick:()=>R("cash"),className:"bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 disabled:opacity-50",children:"Cash"})]}),e.jsxs("button",{disabled:p||c.length===0,onClick:()=>R("terminal"),className:`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition-all ${y==="connected"?"bg-blue-600 hover:bg-blue-700 text-white shadow-blue-200 dark:shadow-blue-900/20":"bg-zinc-200 text-zinc-500 cursor-not-allowed"}`,children:[p?e.jsx(ge,{className:"animate-spin"}):e.jsx(F,{size:20}),y==="connected"?"Charge Application":"Connect Reader to Charge"]})]})]}),ee&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden p-6 space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-lg font-bold",children:D?"Edit Product":"New Product"}),e.jsx("button",{onClick:()=>z(!1),children:e.jsx(q,{size:20})})]}),e.jsx(Ne,{token:i,product:D,onSuccess:()=>{z(!1),U(t=>t+1)}})]})}),Z&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 w-full max-w-lg rounded-2xl shadow-2xl p-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("h2",{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(F,{})," Connect Reader"]}),e.jsx("button",{onClick:()=>N(!1),children:e.jsx(q,{size:20})})]}),e.jsx("div",{className:"flex flex-col gap-4 min-h-[200px]",children:I.length===0?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center space-y-4 text-center",children:[e.jsx("div",{className:"p-4 bg-zinc-100 rounded-full",children:e.jsx(B,{size:24,className:"text-zinc-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"No Readers Found"}),e.jsx("p",{className:"text-sm text-zinc-500 max-w-xs mx-auto mt-1",children:"Make sure your WisePOS E or Verifone P630 is on, connected to WiFi, and registered in your Stripe Dashboard > Terminal."})]}),e.jsx("button",{onClick:async()=>{if(g(!0),j){const t=await j.discoverReaders({discoveryMethod:"internet",simulated:!1}).catch(s=>({error:s}));t&&t.discoveredReaders?Y(t.discoveredReaders):t&&t.error&&console.error(t.error),!t||t.discoveredReaders}g(!1)},disabled:p,className:"px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium disabled:opacity-50",children:p?"Scanning...":"Scan for Readers"})]}):e.jsx("div",{className:"space-y-2",children:I.map((t,s)=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg hover:bg-zinc-50",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.label||t.serialNumber}),e.jsxs("div",{className:"text-xs text-zinc-500",children:[t.deviceType," â€¢ ",t.status]})]}),e.jsx("button",{onClick:()=>ae(t),className:"px-3 py-1.5 bg-zinc-900 text-white rounded text-sm font-medium",children:"Connect"})]},s))})})]})}),ne&&e.jsx("div",{className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white dark:bg-zinc-900 w-full max-w-md rounded-2xl shadow-2xl p-6",children:[e.jsx("h2",{className:"text-lg font-bold mb-4",children:"Create New Customer"}),e.jsx(ze,{token:i,onSuccess:t=>{S(t),T(!1)},onCancel:()=>T(!1)})]})})]})});function Ne({token:d,product:r,onSuccess:i}){const[u,f]=n.useState(!1);return e.jsxs("form",{className:"space-y-4",onSubmit:async h=>{h.preventDefault(),f(!0);const c=new FormData(h.currentTarget),o=Object.fromEntries(c);o.price=(parseFloat(o.price)*100).toString();const b={...o,price:Math.round(parseFloat(o.price)*100),stockQuantity:parseInt(o.stockQuantity),isActive:!0},C=r?`/pos/products/${r.id}`:"/pos/products";await x(C,d,{method:r?"PUT":"POST",body:JSON.stringify(b)}),f(!1),i()},children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Product Name"}),e.jsx("input",{name:"name",defaultValue:r?.name,required:!0,className:"w-full input-field border border-zinc-200 rounded p-2"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Price ($)"}),e.jsx("input",{name:"price",type:"number",step:"0.01",defaultValue:r?r.price/100:"",required:!0,className:"w-full input-field border border-zinc-200 rounded p-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Stock"}),e.jsx("input",{name:"stockQuantity",type:"number",defaultValue:r?.stockQuantity,required:!0,className:"w-full input-field border border-zinc-200 rounded p-2"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Description"}),e.jsx("textarea",{name:"description",defaultValue:r?.description,className:"w-full input-field h-20 border border-zinc-200 rounded p-2"})]}),r&&e.jsxs("div",{className:"flex justify-between items-center text-xs text-zinc-500",children:[e.jsx("span",{children:"Active product"}),e.jsx("button",{type:"button",onClick:async()=>{confirm("Archive this product?")&&(await x(`/pos/products/${r.id}/archive`,d,{method:"POST"}),i())},className:"text-red-500 hover:underline",children:"Archive Product"})]}),e.jsx("button",{disabled:u,type:"submit",className:"w-full bg-zinc-900 text-white rounded p-2 hover:bg-zinc-800",children:u?"Saving...":"Save Product"})]})}function ze({token:d,onSuccess:r,onCancel:i}){const[u,f]=n.useState(!1);return e.jsxs("form",{className:"space-y-4",onSubmit:async h=>{h.preventDefault(),f(!0);const c=new FormData(h.currentTarget),o=Object.fromEntries(c),b=await x("/pos/customers",d,{method:"POST",body:JSON.stringify(o)});f(!1),b.customer&&r(b.customer)},children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Customer Name"}),e.jsx("input",{name:"name",required:!0,className:"w-full input-field border border-zinc-200 rounded p-2",placeholder:"Jane Doe"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium mb-1",children:"Email"}),e.jsx("input",{name:"email",type:"email",required:!0,className:"w-full input-field border border-zinc-200 rounded p-2",placeholder:"jane@example.com"})]}),e.jsxs("div",{className:"flex gap-2 justify-end pt-2",children:[e.jsx("button",{type:"button",onClick:i,className:"px-4 py-2 border rounded-lg text-sm",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:u,className:"px-4 py-2 bg-blue-600 text-white rounded-lg text-sm",children:u?"Creating...":"Create Customer"})]})]})}export{Qe as default};
