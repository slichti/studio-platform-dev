function Fu(n,e){for(var t=0;t<e.length;t++){const i=e[t];if(typeof i!="string"&&!Array.isArray(i)){for(const r in i)if(r!=="default"&&!(r in n)){const s=Object.getOwnPropertyDescriptor(i,r);s&&Object.defineProperty(n,r,s.get?s:{enumerable:!0,get:()=>i[r]})}}}return Object.freeze(Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}))}var gy=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ju(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var rr={exports:{}},H={};var to;function Bu(){if(to)return H;to=1;var n=Symbol.for("react.transitional.element"),e=Symbol.for("react.portal"),t=Symbol.for("react.fragment"),i=Symbol.for("react.strict_mode"),r=Symbol.for("react.profiler"),s=Symbol.for("react.consumer"),a=Symbol.for("react.context"),o=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),l=Symbol.for("react.memo"),u=Symbol.for("react.lazy"),d=Symbol.for("react.activity"),h=Symbol.iterator;function p(E){return E===null||typeof E!="object"?null:(E=h&&E[h]||E["@@iterator"],typeof E=="function"?E:null)}var b={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m=Object.assign,T={};function k(E,N,V){this.props=E,this.context=N,this.refs=T,this.updater=V||b}k.prototype.isReactComponent={},k.prototype.setState=function(E,N){if(typeof E!="object"&&typeof E!="function"&&E!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,E,N,"setState")},k.prototype.forceUpdate=function(E){this.updater.enqueueForceUpdate(this,E,"forceUpdate")};function w(){}w.prototype=k.prototype;function M(E,N,V){this.props=E,this.context=N,this.refs=T,this.updater=V||b}var v=M.prototype=new w;v.constructor=M,m(v,k.prototype),v.isPureReactComponent=!0;var g=Array.isArray;function y(){}var C={H:null,A:null,T:null,S:null},x=Object.prototype.hasOwnProperty;function _(E,N,V){var q=V.ref;return{$$typeof:n,type:E,key:N,ref:q!==void 0?q:null,props:V}}function O(E,N){return _(E.type,N,E.props)}function D(E){return typeof E=="object"&&E!==null&&E.$$typeof===n}function j(E){var N={"=":"=0",":":"=2"};return"$"+E.replace(/[=:]/g,function(V){return N[V]})}var z=/\/+/g;function ee(E,N){return typeof E=="object"&&E!==null&&E.key!=null?j(""+E.key):N.toString(36)}function _e(E){switch(E.status){case"fulfilled":return E.value;case"rejected":throw E.reason;default:switch(typeof E.status=="string"?E.then(y,y):(E.status="pending",E.then(function(N){E.status==="pending"&&(E.status="fulfilled",E.value=N)},function(N){E.status==="pending"&&(E.status="rejected",E.reason=N)})),E.status){case"fulfilled":return E.value;case"rejected":throw E.reason}}throw E}function te(E,N,V,q,Q){var X=typeof E;(X==="undefined"||X==="boolean")&&(E=null);var W=!1;if(E===null)W=!0;else switch(X){case"bigint":case"string":case"number":W=!0;break;case"object":switch(E.$$typeof){case n:case e:W=!0;break;case u:return W=E._init,te(W(E._payload),N,V,q,Q)}}if(W)return Q=Q(E),W=q===""?"."+ee(E,0):q,g(Q)?(V="",W!=null&&(V=W.replace(z,"$&/")+"/"),te(Q,N,V,"",function(Yn){return Yn})):Q!=null&&(D(Q)&&(Q=O(Q,V+(Q.key==null||E&&E.key===Q.key?"":(""+Q.key).replace(z,"$&/")+"/")+W)),N.push(Q)),1;W=0;var ve=q===""?".":q+":";if(g(E))for(var pe=0;pe<E.length;pe++)q=E[pe],X=ve+ee(q,pe),W+=te(q,N,V,X,Q);else if(pe=p(E),typeof pe=="function")for(E=pe.call(E),pe=0;!(q=E.next()).done;)q=q.value,X=ve+ee(q,pe++),W+=te(q,N,V,X,Q);else if(X==="object"){if(typeof E.then=="function")return te(_e(E),N,V,q,Q);throw N=String(E),Error("Objects are not valid as a React child (found: "+(N==="[object Object]"?"object with keys {"+Object.keys(E).join(", ")+"}":N)+"). If you meant to render a collection of children, use an array instead.")}return W}function re(E,N,V){if(E==null)return E;var q=[],Q=0;return te(E,q,"","",function(X){return N.call(V,X,Q++)}),q}function Se(E){if(E._status===-1){var N=E._result;N=N(),N.then(function(V){(E._status===0||E._status===-1)&&(E._status=1,E._result=V)},function(V){(E._status===0||E._status===-1)&&(E._status=2,E._result=V)}),E._status===-1&&(E._status=0,E._result=N)}if(E._status===1)return E._result.default;throw E._result}var we=typeof reportError=="function"?reportError:function(E){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var N=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof E=="object"&&E!==null&&typeof E.message=="string"?String(E.message):String(E),error:E});if(!window.dispatchEvent(N))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",E);return}console.error(E)},mt={map:re,forEach:function(E,N,V){re(E,function(){N.apply(this,arguments)},V)},count:function(E){var N=0;return re(E,function(){N++}),N},toArray:function(E){return re(E,function(N){return N})||[]},only:function(E){if(!D(E))throw Error("React.Children.only expected to receive a single React element child.");return E}};return H.Activity=d,H.Children=mt,H.Component=k,H.Fragment=t,H.Profiler=r,H.PureComponent=M,H.StrictMode=i,H.Suspense=c,H.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=C,H.__COMPILER_RUNTIME={__proto__:null,c:function(E){return C.H.useMemoCache(E)}},H.cache=function(E){return function(){return E.apply(null,arguments)}},H.cacheSignal=function(){return null},H.cloneElement=function(E,N,V){if(E==null)throw Error("The argument must be a React element, but you passed "+E+".");var q=m({},E.props),Q=E.key;if(N!=null)for(X in N.key!==void 0&&(Q=""+N.key),N)!x.call(N,X)||X==="key"||X==="__self"||X==="__source"||X==="ref"&&N.ref===void 0||(q[X]=N[X]);var X=arguments.length-2;if(X===1)q.children=V;else if(1<X){for(var W=Array(X),ve=0;ve<X;ve++)W[ve]=arguments[ve+2];q.children=W}return _(E.type,Q,q)},H.createContext=function(E){return E={$$typeof:a,_currentValue:E,_currentValue2:E,_threadCount:0,Provider:null,Consumer:null},E.Provider=E,E.Consumer={$$typeof:s,_context:E},E},H.createElement=function(E,N,V){var q,Q={},X=null;if(N!=null)for(q in N.key!==void 0&&(X=""+N.key),N)x.call(N,q)&&q!=="key"&&q!=="__self"&&q!=="__source"&&(Q[q]=N[q]);var W=arguments.length-2;if(W===1)Q.children=V;else if(1<W){for(var ve=Array(W),pe=0;pe<W;pe++)ve[pe]=arguments[pe+2];Q.children=ve}if(E&&E.defaultProps)for(q in W=E.defaultProps,W)Q[q]===void 0&&(Q[q]=W[q]);return _(E,X,Q)},H.createRef=function(){return{current:null}},H.forwardRef=function(E){return{$$typeof:o,render:E}},H.isValidElement=D,H.lazy=function(E){return{$$typeof:u,_payload:{_status:-1,_result:E},_init:Se}},H.memo=function(E,N){return{$$typeof:l,type:E,compare:N===void 0?null:N}},H.startTransition=function(E){var N=C.T,V={};C.T=V;try{var q=E(),Q=C.S;Q!==null&&Q(V,q),typeof q=="object"&&q!==null&&typeof q.then=="function"&&q.then(y,we)}catch(X){we(X)}finally{N!==null&&V.types!==null&&(N.types=V.types),C.T=N}},H.unstable_useCacheRefresh=function(){return C.H.useCacheRefresh()},H.use=function(E){return C.H.use(E)},H.useActionState=function(E,N,V){return C.H.useActionState(E,N,V)},H.useCallback=function(E,N){return C.H.useCallback(E,N)},H.useContext=function(E){return C.H.useContext(E)},H.useDebugValue=function(){},H.useDeferredValue=function(E,N){return C.H.useDeferredValue(E,N)},H.useEffect=function(E,N){return C.H.useEffect(E,N)},H.useEffectEvent=function(E){return C.H.useEffectEvent(E)},H.useId=function(){return C.H.useId()},H.useImperativeHandle=function(E,N,V){return C.H.useImperativeHandle(E,N,V)},H.useInsertionEffect=function(E,N){return C.H.useInsertionEffect(E,N)},H.useLayoutEffect=function(E,N){return C.H.useLayoutEffect(E,N)},H.useMemo=function(E,N){return C.H.useMemo(E,N)},H.useOptimistic=function(E,N){return C.H.useOptimistic(E,N)},H.useReducer=function(E,N,V){return C.H.useReducer(E,N,V)},H.useRef=function(E){return C.H.useRef(E)},H.useState=function(E){return C.H.useState(E)},H.useSyncExternalStore=function(E,N,V){return C.H.useSyncExternalStore(E,N,V)},H.useTransition=function(){return C.H.useTransition()},H.version="19.2.3",H}var no;function Vu(){return no||(no=1,rr.exports=Bu()),rr.exports}var f=Vu();const qu=ju(f),vy=Fu({__proto__:null,default:qu},[f]);var io={};function Wu(n,e){return e.forEach(function(t){t&&typeof t!="string"&&!Array.isArray(t)&&Object.keys(t).forEach(function(i){if(i!=="default"&&!(i in n)){var r=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(n,i,r.get?r:{enumerable:!0,get:function(){return t[i]}})}})}),Object.freeze(n)}var Hu=Object.defineProperty,Ku=(n,e,t)=>e in n?Hu(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,ro=(n,e,t)=>Ku(n,typeof e!="symbol"?e+"":e,t);class xe{constructor(){ro(this,"_locking"),ro(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let e;const t=new Promise(r=>e=()=>{this._locks-=1,r()}),i=this._locking.then(()=>e);return this._locking=this._locking.then(()=>t),i}}function ue(n,e){if(!n)throw new Error(e)}const zu=34028234663852886e22,Gu=-34028234663852886e22,$u=4294967295,Ju=2147483647,Yu=-2147483648;function ri(n){if(typeof n!="number")throw new Error("invalid int 32: "+typeof n);if(!Number.isInteger(n)||n>Ju||n<Yu)throw new Error("invalid int 32: "+n)}function Or(n){if(typeof n!="number")throw new Error("invalid uint 32: "+typeof n);if(!Number.isInteger(n)||n>$u||n<0)throw new Error("invalid uint 32: "+n)}function Wa(n){if(typeof n!="number")throw new Error("invalid float 32: "+typeof n);if(Number.isFinite(n)&&(n>zu||n<Gu))throw new Error("invalid float 32: "+n)}const Ha=Symbol("@bufbuild/protobuf/enum-type");function Qu(n){const e=n[Ha];return ue(e,"missing enum type on enum object"),e}function Ka(n,e,t,i){n[Ha]=za(e,t.map(r=>({no:r.no,name:r.name,localName:n[r.no]})))}function za(n,e,t){const i=Object.create(null),r=Object.create(null),s=[];for(const a of e){const o=Ga(a);s.push(o),i[a.name]=o,r[a.no]=o}return{typeName:n,values:s,findName(a){return i[a]},findNumber(a){return r[a]}}}function Xu(n,e,t){const i={};for(const r of e){const s=Ga(r);i[s.localName]=s.no,i[s.no]=s.localName}return Ka(i,n,e),i}function Ga(n){return"localName"in n?n:Object.assign(Object.assign({},n),{localName:n.name})}class ds{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const i=this.getType(),r=i.runtime.bin,s=r.makeReadOptions(t);return r.readMessage(this,s.readerFactory(e),e.byteLength,s),this}fromJson(e,t){const i=this.getType(),r=i.runtime.json,s=r.makeReadOptions(t);return r.readMessage(i,e,s,this),this}fromJsonString(e,t){let i;try{i=JSON.parse(e)}catch(r){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(r instanceof Error?r.message:String(r)))}return this.fromJson(i,t)}toBinary(e){const t=this.getType(),i=t.runtime.bin,r=i.makeWriteOptions(e),s=r.writerFactory();return i.writeMessage(this,s,r),s.finish()}toJson(e){const t=this.getType(),i=t.runtime.json,r=i.makeWriteOptions(e);return i.writeMessage(this,r)}toJsonString(e){var t;const i=this.toJson(e);return JSON.stringify(i,null,(t=e?.prettySpaces)!==null&&t!==void 0?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function Zu(n,e,t,i){var r;const s=(r=i?.localName)!==null&&r!==void 0?r:e.substring(e.lastIndexOf(".")+1),a={[s]:function(o){n.util.initFields(this),n.util.initPartial(o,this)}}[s];return Object.setPrototypeOf(a.prototype,new ds),Object.assign(a,{runtime:n,typeName:e,fields:n.util.newFieldList(t),fromBinary(o,c){return new a().fromBinary(o,c)},fromJson(o,c){return new a().fromJson(o,c)},fromJsonString(o,c){return new a().fromJsonString(o,c)},equals(o,c){return n.util.equals(a,o,c)}}),a}function ed(){let n=0,e=0;for(let i=0;i<28;i+=7){let r=this.buf[this.pos++];if(n|=(r&127)<<i,(r&128)==0)return this.assertBounds(),[n,e]}let t=this.buf[this.pos++];if(n|=(t&15)<<28,e=(t&112)>>4,(t&128)==0)return this.assertBounds(),[n,e];for(let i=3;i<=31;i+=7){let r=this.buf[this.pos++];if(e|=(r&127)<<i,(r&128)==0)return this.assertBounds(),[n,e]}throw new Error("invalid varint")}function sr(n,e,t){for(let s=0;s<28;s=s+7){const a=n>>>s,o=!(!(a>>>7)&&e==0),c=(o?a|128:a)&255;if(t.push(c),!o)return}const i=n>>>28&15|(e&7)<<4,r=e>>3!=0;if(t.push((r?i|128:i)&255),!!r){for(let s=3;s<31;s=s+7){const a=e>>>s,o=!!(a>>>7),c=(o?a|128:a)&255;if(t.push(c),!o)return}t.push(e>>>31&1)}}const si=4294967296;function so(n){const e=n[0]==="-";e&&(n=n.slice(1));const t=1e6;let i=0,r=0;function s(a,o){const c=Number(n.slice(a,o));r*=t,i=i*t+c,i>=si&&(r=r+(i/si|0),i=i%si)}return s(-24,-18),s(-18,-12),s(-12,-6),s(-6),e?Ja(i,r):hs(i,r)}function td(n,e){let t=hs(n,e);const i=t.hi&2147483648;i&&(t=Ja(t.lo,t.hi));const r=$a(t.lo,t.hi);return i?"-"+r:r}function $a(n,e){if({lo:n,hi:e}=nd(n,e),e<=2097151)return String(si*e+n);const t=n&16777215,i=(n>>>24|e<<8)&16777215,r=e>>16&65535;let s=t+i*6777216+r*6710656,a=i+r*8147497,o=r*2;const c=1e7;return s>=c&&(a+=Math.floor(s/c),s%=c),a>=c&&(o+=Math.floor(a/c),a%=c),o.toString()+oo(a)+oo(s)}function nd(n,e){return{lo:n>>>0,hi:e>>>0}}function hs(n,e){return{lo:n|0,hi:e|0}}function Ja(n,e){return e=~e,n?n=~n+1:e+=1,hs(n,e)}const oo=n=>{const e=String(n);return"0000000".slice(e.length)+e};function ao(n,e){if(n>=0){for(;n>127;)e.push(n&127|128),n=n>>>7;e.push(n)}else{for(let t=0;t<9;t++)e.push(n&127|128),n=n>>7;e.push(1)}}function id(){let n=this.buf[this.pos++],e=n&127;if((n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<7,(n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<14,(n&128)==0)return this.assertBounds(),e;if(n=this.buf[this.pos++],e|=(n&127)<<21,(n&128)==0)return this.assertBounds(),e;n=this.buf[this.pos++],e|=(n&15)<<28;for(let t=5;(n&128)!==0&&t<10;t++)n=this.buf[this.pos++];if((n&128)!=0)throw new Error("invalid varint");return this.assertBounds(),e>>>0}function rd(){const n=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof n.getBigInt64=="function"&&typeof n.getBigUint64=="function"&&typeof n.setBigInt64=="function"&&typeof n.setBigUint64=="function"&&(typeof process!="object"||typeof io!="object"||io.BUF_BIGINT_DISABLE!=="1")){const r=BigInt("-9223372036854775808"),s=BigInt("9223372036854775807"),a=BigInt("0"),o=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>s||l<r)throw new Error("int64 invalid: ".concat(c));return l},uParse(c){const l=typeof c=="bigint"?c:BigInt(c);if(l>o||l<a)throw new Error("uint64 invalid: ".concat(c));return l},enc(c){return n.setBigInt64(0,this.parse(c),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},uEnc(c){return n.setBigInt64(0,this.uParse(c),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},dec(c,l){return n.setInt32(0,c,!0),n.setInt32(4,l,!0),n.getBigInt64(0,!0)},uDec(c,l){return n.setInt32(0,c,!0),n.setInt32(4,l,!0),n.getBigUint64(0,!0)}}}const t=r=>ue(/^-?[0-9]+$/.test(r),"int64 invalid: ".concat(r)),i=r=>ue(/^[0-9]+$/.test(r),"uint64 invalid: ".concat(r));return{zero:"0",supported:!1,parse(r){return typeof r!="string"&&(r=r.toString()),t(r),r},uParse(r){return typeof r!="string"&&(r=r.toString()),i(r),r},enc(r){return typeof r!="string"&&(r=r.toString()),t(r),so(r)},uEnc(r){return typeof r!="string"&&(r=r.toString()),i(r),so(r)},dec(r,s){return td(r,s)},uDec(r,s){return $a(r,s)}}}const ce=rd();var L;(function(n){n[n.DOUBLE=1]="DOUBLE",n[n.FLOAT=2]="FLOAT",n[n.INT64=3]="INT64",n[n.UINT64=4]="UINT64",n[n.INT32=5]="INT32",n[n.FIXED64=6]="FIXED64",n[n.FIXED32=7]="FIXED32",n[n.BOOL=8]="BOOL",n[n.STRING=9]="STRING",n[n.BYTES=12]="BYTES",n[n.UINT32=13]="UINT32",n[n.SFIXED32=15]="SFIXED32",n[n.SFIXED64=16]="SFIXED64",n[n.SINT32=17]="SINT32",n[n.SINT64=18]="SINT64"})(L||(L={}));var Ut;(function(n){n[n.BIGINT=0]="BIGINT",n[n.STRING=1]="STRING"})(Ut||(Ut={}));function Rt(n,e,t){if(e===t)return!0;if(n==L.BYTES){if(!(e instanceof Uint8Array)||!(t instanceof Uint8Array)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0}switch(n){case L.UINT64:case L.FIXED64:case L.INT64:case L.SFIXED64:case L.SINT64:return e==t}return!1}function pn(n,e){switch(n){case L.BOOL:return!1;case L.UINT64:case L.FIXED64:case L.INT64:case L.SFIXED64:case L.SINT64:return e==0?ce.zero:"0";case L.DOUBLE:case L.FLOAT:return 0;case L.BYTES:return new Uint8Array(0);case L.STRING:return"";default:return 0}}function Ya(n,e){switch(n){case L.BOOL:return e===!1;case L.STRING:return e==="";case L.BYTES:return e instanceof Uint8Array&&!e.byteLength;default:return e==0}}var fe;(function(n){n[n.Varint=0]="Varint",n[n.Bit64=1]="Bit64",n[n.LengthDelimited=2]="LengthDelimited",n[n.StartGroup=3]="StartGroup",n[n.EndGroup=4]="EndGroup",n[n.Bit32=5]="Bit32"})(fe||(fe={}));class sd{constructor(e){this.stack=[],this.textEncoder=e??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let r=0;r<this.chunks.length;r++)e+=this.chunks[r].length;let t=new Uint8Array(e),i=0;for(let r=0;r<this.chunks.length;r++)t.set(this.chunks[r],i),i+=this.chunks[r].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(Or(e);e>127;)this.buf.push(e&127|128),e=e>>>7;return this.buf.push(e),this}int32(e){return ri(e),ao(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){Wa(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){Or(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){ri(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return ri(e),e=(e<<1^e>>31)>>>0,ao(e,this.buf),this}sfixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),r=ce.enc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),r=ce.uEnc(e);return i.setInt32(0,r.lo,!0),i.setInt32(4,r.hi,!0),this.raw(t)}int64(e){let t=ce.enc(e);return sr(t.lo,t.hi,this.buf),this}sint64(e){let t=ce.enc(e),i=t.hi>>31,r=t.lo<<1^i,s=(t.hi<<1|t.lo>>>31)^i;return sr(r,s,this.buf),this}uint64(e){let t=ce.uEnc(e);return sr(t.lo,t.hi,this.buf),this}}class od{constructor(e,t){this.varint64=ed,this.uint32=id,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=t??new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,i=e&7;if(t<=0||i<0||i>5)throw new Error("illegal tag: field no "+t+" wire type "+i);return[t,i]}skip(e,t){let i=this.pos;switch(e){case fe.Varint:for(;this.buf[this.pos++]&128;);break;case fe.Bit64:this.pos+=4;case fe.Bit32:this.pos+=4;break;case fe.LengthDelimited:let r=this.uint32();this.pos+=r;break;case fe.StartGroup:for(;;){const[s,a]=this.tag();if(a===fe.EndGroup){if(t!==void 0&&s!==t)throw new Error("invalid end group tag");break}this.skip(a,s)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(i,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return ce.dec(...this.varint64())}uint64(){return ce.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),i=-(e&1);return e=(e>>>1|(t&1)<<31)^i,t=t>>>1^i,ce.dec(e,t)}bool(){let[e,t]=this.varint64();return e!==0||t!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return ce.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return ce.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function ad(n,e,t,i){let r;return{typeName:e,extendee:t,get field(){if(!r){const s=typeof i=="function"?i():i;s.name=e.split(".").pop(),s.jsonName="[".concat(e,"]"),r=n.util.newFieldList([s]).list()[0]}return r},runtime:n}}function Qa(n){const e=n.field.localName,t=Object.create(null);return t[e]=cd(n),[t,()=>t[e]]}function cd(n){const e=n.field;if(e.repeated)return[];if(e.default!==void 0)return e.default;switch(e.kind){case"enum":return e.T.values[0].no;case"scalar":return pn(e.T,e.L);case"message":const t=e.T,i=new t;return t.fieldWrapper?t.fieldWrapper.unwrapField(i):i;case"map":throw"map fields are not allowed to be extensions"}}function ld(n,e){if(!e.repeated&&(e.kind=="enum"||e.kind=="scalar")){for(let t=n.length-1;t>=0;--t)if(n[t].no==e.no)return[n[t]];return[]}return n.filter(t=>t.no===e.no)}let bt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),Fi=[];for(let n=0;n<bt.length;n++)Fi[bt[n].charCodeAt(0)]=n;Fi[45]=bt.indexOf("+");Fi[95]=bt.indexOf("/");const Xa={dec(n){let e=n.length*3/4;n[n.length-2]=="="?e-=2:n[n.length-1]=="="&&(e-=1);let t=new Uint8Array(e),i=0,r=0,s,a=0;for(let o=0;o<n.length;o++){if(s=Fi[n.charCodeAt(o)],s===void 0)switch(n[o]){case"=":r=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(r){case 0:a=s,r=1;break;case 1:t[i++]=a<<2|(s&48)>>4,a=s,r=2;break;case 2:t[i++]=(a&15)<<4|(s&60)>>2,a=s,r=3;break;case 3:t[i++]=(a&3)<<6|s,r=0;break}}if(r==1)throw Error("invalid base64 string.");return t.subarray(0,i)},enc(n){let e="",t=0,i,r=0;for(let s=0;s<n.length;s++)switch(i=n[s],t){case 0:e+=bt[i>>2],r=(i&3)<<4,t=1;break;case 1:e+=bt[r|i>>4],r=(i&15)<<2,t=2;break;case 2:e+=bt[r|i>>6],e+=bt[i&63],t=0;break}return t&&(e+=bt[r],e+="=",t==1&&(e+="=")),e}};function ud(n,e,t){ec(e,n);const i=e.runtime.bin.makeReadOptions(t),r=ld(n.getType().runtime.bin.listUnknownFields(n),e.field),[s,a]=Qa(e);for(const o of r)e.runtime.bin.readField(s,i.readerFactory(o.data),e.field,o.wireType,i);return a()}function dd(n,e,t,i){ec(e,n);const r=e.runtime.bin.makeReadOptions(i),s=e.runtime.bin.makeWriteOptions(i);if(Za(n,e)){const l=n.getType().runtime.bin.listUnknownFields(n).filter(u=>u.no!=e.field.no);n.getType().runtime.bin.discardUnknownFields(n);for(const u of l)n.getType().runtime.bin.onUnknownField(n,u.no,u.wireType,u.data)}const a=s.writerFactory();let o=e.field;!o.opt&&!o.repeated&&(o.kind=="enum"||o.kind=="scalar")&&(o=Object.assign(Object.assign({},e.field),{opt:!0})),e.runtime.bin.writeField(o,t,a,s);const c=r.readerFactory(a.finish());for(;c.pos<c.len;){const[l,u]=c.tag(),d=c.skip(u,l);n.getType().runtime.bin.onUnknownField(n,l,u,d)}}function Za(n,e){const t=n.getType();return e.extendee.typeName===t.typeName&&!!t.runtime.bin.listUnknownFields(n).find(i=>i.no==e.field.no)}function ec(n,e){ue(n.extendee.typeName==e.getType().typeName,"extension ".concat(n.typeName," can only be applied to message ").concat(n.extendee.typeName))}function tc(n,e){const t=n.localName;if(n.repeated)return e[t].length>0;if(n.oneof)return e[n.oneof.localName].case===t;switch(n.kind){case"enum":case"scalar":return n.opt||n.req?e[t]!==void 0:n.kind=="enum"?e[t]!==n.T.values[0].no:!Ya(n.T,e[t]);case"message":return e[t]!==void 0;case"map":return Object.keys(e[t]).length>0}}function co(n,e){const t=n.localName,i=!n.opt&&!n.req;if(n.repeated)e[t]=[];else if(n.oneof)e[n.oneof.localName]={case:void 0};else switch(n.kind){case"map":e[t]={};break;case"enum":e[t]=i?n.T.values[0].no:void 0;break;case"scalar":e[t]=i?pn(n.T,n.L):void 0;break;case"message":e[t]=void 0;break}}function yt(n,e){if(n===null||typeof n!="object"||!Object.getOwnPropertyNames(ds.prototype).every(i=>i in n&&typeof n[i]=="function"))return!1;const t=n.getType();return t===null||typeof t!="function"||!("typeName"in t)||typeof t.typeName!="string"?!1:e===void 0?!0:t.typeName==e.typeName}function nc(n,e){return yt(e)||!n.fieldWrapper?e:n.fieldWrapper.wrapField(e)}L.DOUBLE,L.FLOAT,L.INT64,L.UINT64,L.INT32,L.UINT32,L.BOOL,L.STRING,L.BYTES;const lo={ignoreUnknownFields:!1},uo={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function hd(n){return n?Object.assign(Object.assign({},lo),n):lo}function fd(n){return n?Object.assign(Object.assign({},uo),n):uo}const bi=Symbol(),oi=Symbol();function pd(){return{makeReadOptions:hd,makeWriteOptions:fd,readMessage(n,e,t,i){if(e==null||Array.isArray(e)||typeof e!="object")throw new Error("cannot decode message ".concat(n.typeName," from JSON: ").concat(ot(e)));i=i??new n;const r=new Map,s=t.typeRegistry;for(const[a,o]of Object.entries(e)){const c=n.fields.findJsonName(a);if(c){if(c.oneof){if(o===null&&c.kind=="scalar")continue;const l=r.get(c.oneof);if(l!==void 0)throw new Error("cannot decode message ".concat(n.typeName,' from JSON: multiple keys for oneof "').concat(c.oneof.name,'" present: "').concat(l,'", "').concat(a,'"'));r.set(c.oneof,a)}ho(i,o,c,t,n)}else{let l=!1;if(s?.findExtension&&a.startsWith("[")&&a.endsWith("]")){const u=s.findExtension(a.substring(1,a.length-1));if(u&&u.extendee.typeName==n.typeName){l=!0;const[d,h]=Qa(u);ho(d,o,u.field,t,u),dd(i,u,h(),t)}}if(!l&&!t.ignoreUnknownFields)throw new Error("cannot decode message ".concat(n.typeName,' from JSON: key "').concat(a,'" is unknown'))}}return i},writeMessage(n,e){const t=n.getType(),i={};let r;try{for(r of t.fields.byNumber()){if(!tc(r,n)){if(r.req)throw"required field not set";if(!e.emitDefaultValues||!gd(r))continue}const a=r.oneof?n[r.oneof.localName].value:n[r.localName],o=fo(r,a,e);o!==void 0&&(i[e.useProtoFieldName?r.name:r.jsonName]=o)}const s=e.typeRegistry;if(s?.findExtensionFor)for(const a of t.runtime.bin.listUnknownFields(n)){const o=s.findExtensionFor(t.typeName,a.no);if(o&&Za(n,o)){const c=ud(n,o,e),l=fo(o.field,c,e);l!==void 0&&(i[o.field.jsonName]=l)}}}catch(s){const a=r?"cannot encode field ".concat(t.typeName,".").concat(r.name," to JSON"):"cannot encode message ".concat(t.typeName," to JSON"),o=s instanceof Error?s.message:String(s);throw new Error(a+(o.length>0?": ".concat(o):""))}return i},readScalar(n,e,t){return Mn(n,e,t??Ut.BIGINT,!0)},writeScalar(n,e,t){if(e!==void 0&&(t||Ya(n,e)))return ai(n,e)},debug:ot}}function ot(n){if(n===null)return"null";switch(typeof n){case"object":return Array.isArray(n)?"array":"object";case"string":return n.length>100?"string":'"'.concat(n.split('"').join('\\"'),'"');default:return String(n)}}function ho(n,e,t,i,r){let s=t.localName;if(t.repeated){if(ue(t.kind!="map"),e===null)return;if(!Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(ot(e)));const a=n[s];for(const o of e){if(o===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(ot(o)));switch(t.kind){case"message":a.push(t.T.fromJson(o,i));break;case"enum":const c=or(t.T,o,i.ignoreUnknownFields,!0);c!==oi&&a.push(c);break;case"scalar":try{a.push(Mn(t.T,o,t.L,!0))}catch(l){let u="cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(ot(o));throw l instanceof Error&&l.message.length>0&&(u+=": ".concat(l.message)),new Error(u)}break}}}else if(t.kind=="map"){if(e===null)return;if(typeof e!="object"||Array.isArray(e))throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(ot(e)));const a=n[s];for(const[o,c]of Object.entries(e)){if(c===null)throw new Error("cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: map value null"));let l;try{l=md(t.K,o)}catch(u){let d="cannot decode map key for field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(ot(e));throw u instanceof Error&&u.message.length>0&&(d+=": ".concat(u.message)),new Error(d)}switch(t.V.kind){case"message":a[l]=t.V.T.fromJson(c,i);break;case"enum":const u=or(t.V.T,c,i.ignoreUnknownFields,!0);u!==oi&&(a[l]=u);break;case"scalar":try{a[l]=Mn(t.V.T,c,Ut.BIGINT,!0)}catch(d){let h="cannot decode map value for field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(ot(e));throw d instanceof Error&&d.message.length>0&&(h+=": ".concat(d.message)),new Error(h)}break}}}else switch(t.oneof&&(n=n[t.oneof.localName]={case:s},s="value"),t.kind){case"message":const a=t.T;if(e===null&&a.typeName!="google.protobuf.Value")return;let o=n[s];yt(o)?o.fromJson(e,i):(n[s]=o=a.fromJson(e,i),a.fieldWrapper&&!t.oneof&&(n[s]=a.fieldWrapper.unwrapField(o)));break;case"enum":const c=or(t.T,e,i.ignoreUnknownFields,!1);switch(c){case bi:co(t,n);break;case oi:break;default:n[s]=c;break}break;case"scalar":try{const l=Mn(t.T,e,t.L,!1);switch(l){case bi:co(t,n);break;default:n[s]=l;break}}catch(l){let u="cannot decode field ".concat(r.typeName,".").concat(t.name," from JSON: ").concat(ot(e));throw l instanceof Error&&l.message.length>0&&(u+=": ".concat(l.message)),new Error(u)}break}}function md(n,e){if(n===L.BOOL)switch(e){case"true":e=!0;break;case"false":e=!1;break}return Mn(n,e,Ut.BIGINT,!0).toString()}function Mn(n,e,t,i){if(e===null)return i?pn(n,t):bi;switch(n){case L.DOUBLE:case L.FLOAT:if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""||typeof e=="string"&&e.trim().length!==e.length||typeof e!="string"&&typeof e!="number")break;const r=Number(e);if(Number.isNaN(r)||!Number.isFinite(r))break;return n==L.FLOAT&&Wa(r),r;case L.INT32:case L.FIXED32:case L.SFIXED32:case L.SINT32:case L.UINT32:let s;if(typeof e=="number"?s=e:typeof e=="string"&&e.length>0&&e.trim().length===e.length&&(s=Number(e)),s===void 0)break;return n==L.UINT32||n==L.FIXED32?Or(s):ri(s),s;case L.INT64:case L.SFIXED64:case L.SINT64:if(typeof e!="number"&&typeof e!="string")break;const a=ce.parse(e);return t?a.toString():a;case L.FIXED64:case L.UINT64:if(typeof e!="number"&&typeof e!="string")break;const o=ce.uParse(e);return t?o.toString():o;case L.BOOL:if(typeof e!="boolean")break;return e;case L.STRING:if(typeof e!="string")break;try{encodeURIComponent(e)}catch{throw new Error("invalid UTF8")}return e;case L.BYTES:if(e==="")return new Uint8Array(0);if(typeof e!="string")break;return Xa.dec(e)}throw new Error}function or(n,e,t,i){if(e===null)return n.typeName=="google.protobuf.NullValue"?0:i?n.values[0].no:bi;switch(typeof e){case"number":if(Number.isInteger(e))return e;break;case"string":const r=n.findName(e);if(r!==void 0)return r.no;if(t)return oi;break}throw new Error("cannot decode enum ".concat(n.typeName," from JSON: ").concat(ot(e)))}function gd(n){return n.repeated||n.kind=="map"?!0:!(n.oneof||n.kind=="message"||n.opt||n.req)}function fo(n,e,t){if(n.kind=="map"){ue(typeof e=="object"&&e!=null);const i={},r=Object.entries(e);switch(n.V.kind){case"scalar":for(const[a,o]of r)i[a.toString()]=ai(n.V.T,o);break;case"message":for(const[a,o]of r)i[a.toString()]=o.toJson(t);break;case"enum":const s=n.V.T;for(const[a,o]of r)i[a.toString()]=ar(s,o,t.enumAsInteger);break}return t.emitDefaultValues||r.length>0?i:void 0}if(n.repeated){ue(Array.isArray(e));const i=[];switch(n.kind){case"scalar":for(let r=0;r<e.length;r++)i.push(ai(n.T,e[r]));break;case"enum":for(let r=0;r<e.length;r++)i.push(ar(n.T,e[r],t.enumAsInteger));break;case"message":for(let r=0;r<e.length;r++)i.push(e[r].toJson(t));break}return t.emitDefaultValues||i.length>0?i:void 0}switch(n.kind){case"scalar":return ai(n.T,e);case"enum":return ar(n.T,e,t.enumAsInteger);case"message":return nc(n.T,e).toJson(t)}}function ar(n,e,t){var i;if(ue(typeof e=="number"),n.typeName=="google.protobuf.NullValue")return null;if(t)return e;const r=n.findNumber(e);return(i=r?.name)!==null&&i!==void 0?i:e}function ai(n,e){switch(n){case L.INT32:case L.SFIXED32:case L.SINT32:case L.FIXED32:case L.UINT32:return ue(typeof e=="number"),e;case L.FLOAT:case L.DOUBLE:return ue(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e;case L.STRING:return ue(typeof e=="string"),e;case L.BOOL:return ue(typeof e=="boolean"),e;case L.UINT64:case L.FIXED64:case L.INT64:case L.SFIXED64:case L.SINT64:return ue(typeof e=="bigint"||typeof e=="string"||typeof e=="number"),e.toString();case L.BYTES:return ue(e instanceof Uint8Array),Xa.enc(e)}}const Zt=Symbol("@bufbuild/protobuf/unknown-fields"),po={readUnknownFields:!0,readerFactory:n=>new od(n)},mo={writeUnknownFields:!0,writerFactory:()=>new sd};function vd(n){return n?Object.assign(Object.assign({},po),n):po}function bd(n){return n?Object.assign(Object.assign({},mo),n):mo}function yd(){return{makeReadOptions:vd,makeWriteOptions:bd,listUnknownFields(n){var e;return(e=n[Zt])!==null&&e!==void 0?e:[]},discardUnknownFields(n){delete n[Zt]},writeUnknownFields(n,e){const i=n[Zt];if(i)for(const r of i)e.tag(r.no,r.wireType).raw(r.data)},onUnknownField(n,e,t,i){const r=n;Array.isArray(r[Zt])||(r[Zt]=[]),r[Zt].push({no:e,wireType:t,data:i})},readMessage(n,e,t,i,r){const s=n.getType(),a=r?e.len:e.pos+t;let o,c;for(;e.pos<a&&([o,c]=e.tag(),!(r===!0&&c==fe.EndGroup));){const l=s.fields.find(o);if(!l){const u=e.skip(c,o);i.readUnknownFields&&this.onUnknownField(n,o,c,u);continue}go(n,e,l,c,i)}if(r&&(c!=fe.EndGroup||o!==t))throw new Error("invalid end group tag")},readField:go,writeMessage(n,e,t){const i=n.getType();for(const r of i.fields.byNumber()){if(!tc(r,n)){if(r.req)throw new Error("cannot encode field ".concat(i.typeName,".").concat(r.name," to binary: required field not set"));continue}const s=r.oneof?n[r.oneof.localName].value:n[r.localName];vo(r,s,e,t)}return t.writeUnknownFields&&this.writeUnknownFields(n,e),e},writeField(n,e,t,i){e!==void 0&&vo(n,e,t,i)}}}function go(n,e,t,i,r){let{repeated:s,localName:a}=t;switch(t.oneof&&(n=n[t.oneof.localName],n.case!=a&&delete n.value,n.case=a,a="value"),t.kind){case"scalar":case"enum":const o=t.kind=="enum"?L.INT32:t.T;let c=yi;if(t.kind=="scalar"&&t.L>0&&(c=Sd),s){let h=n[a];if(i==fe.LengthDelimited&&o!=L.STRING&&o!=L.BYTES){let b=e.uint32()+e.pos;for(;e.pos<b;)h.push(c(e,o))}else h.push(c(e,o))}else n[a]=c(e,o);break;case"message":const l=t.T;s?n[a].push(ci(e,new l,r,t)):yt(n[a])?ci(e,n[a],r,t):(n[a]=ci(e,new l,r,t),l.fieldWrapper&&!t.oneof&&!t.repeated&&(n[a]=l.fieldWrapper.unwrapField(n[a])));break;case"map":let[u,d]=kd(t,e,r);n[a][u]=d;break}}function ci(n,e,t,i){const r=e.getType().runtime.bin,s=i?.delimited;return r.readMessage(e,n,s?i.no:n.uint32(),t,s),e}function kd(n,e,t){const i=e.uint32(),r=e.pos+i;let s,a;for(;e.pos<r;){const[o]=e.tag();switch(o){case 1:s=yi(e,n.K);break;case 2:switch(n.V.kind){case"scalar":a=yi(e,n.V.T);break;case"enum":a=e.int32();break;case"message":a=ci(e,new n.V.T,t,void 0);break}break}}if(s===void 0&&(s=pn(n.K,Ut.BIGINT)),typeof s!="string"&&typeof s!="number"&&(s=s.toString()),a===void 0)switch(n.V.kind){case"scalar":a=pn(n.V.T,Ut.BIGINT);break;case"enum":a=n.V.T.values[0].no;break;case"message":a=new n.V.T;break}return[s,a]}function Sd(n,e){const t=yi(n,e);return typeof t=="bigint"?t.toString():t}function yi(n,e){switch(e){case L.STRING:return n.string();case L.BOOL:return n.bool();case L.DOUBLE:return n.double();case L.FLOAT:return n.float();case L.INT32:return n.int32();case L.INT64:return n.int64();case L.UINT64:return n.uint64();case L.FIXED64:return n.fixed64();case L.BYTES:return n.bytes();case L.FIXED32:return n.fixed32();case L.SFIXED32:return n.sfixed32();case L.SFIXED64:return n.sfixed64();case L.SINT64:return n.sint64();case L.UINT32:return n.uint32();case L.SINT32:return n.sint32()}}function vo(n,e,t,i){ue(e!==void 0);const r=n.repeated;switch(n.kind){case"scalar":case"enum":let s=n.kind=="enum"?L.INT32:n.T;if(r)if(ue(Array.isArray(e)),n.packed)Cd(t,s,n.no,e);else for(const a of e)An(t,s,n.no,a);else An(t,s,n.no,e);break;case"message":if(r){ue(Array.isArray(e));for(const a of e)bo(t,i,n,a)}else bo(t,i,n,e);break;case"map":ue(typeof e=="object"&&e!=null);for(const[a,o]of Object.entries(e))Td(t,i,n,a,o);break}}function Td(n,e,t,i,r){n.tag(t.no,fe.LengthDelimited),n.fork();let s=i;switch(t.K){case L.INT32:case L.FIXED32:case L.UINT32:case L.SFIXED32:case L.SINT32:s=Number.parseInt(i);break;case L.BOOL:ue(i=="true"||i=="false"),s=i=="true";break}switch(An(n,t.K,1,s),t.V.kind){case"scalar":An(n,t.V.T,2,r);break;case"enum":An(n,L.INT32,2,r);break;case"message":ue(r!==void 0),n.tag(2,fe.LengthDelimited).bytes(r.toBinary(e));break}n.join()}function bo(n,e,t,i){const r=nc(t.T,i);t.delimited?n.tag(t.no,fe.StartGroup).raw(r.toBinary(e)).tag(t.no,fe.EndGroup):n.tag(t.no,fe.LengthDelimited).bytes(r.toBinary(e))}function An(n,e,t,i){ue(i!==void 0);let[r,s]=ic(e);n.tag(t,r)[s](i)}function Cd(n,e,t,i){if(!i.length)return;n.tag(t,fe.LengthDelimited).fork();let[,r]=ic(e);for(let s=0;s<i.length;s++)n[r](i[s]);n.join()}function ic(n){let e=fe.Varint;switch(n){case L.BYTES:case L.STRING:e=fe.LengthDelimited;break;case L.DOUBLE:case L.FIXED64:case L.SFIXED64:e=fe.Bit64;break;case L.FIXED32:case L.SFIXED32:case L.FLOAT:e=fe.Bit32;break}const t=L[n].toLowerCase();return[e,t]}function Ed(){return{setEnumType:Ka,initPartial(n,e){if(n===void 0)return;const t=e.getType();for(const i of t.fields.byMember()){const r=i.localName,s=e,a=n;if(a[r]!=null)switch(i.kind){case"oneof":const o=a[r].case;if(o===void 0)continue;const c=i.findField(o);let l=a[r].value;c&&c.kind=="message"&&!yt(l,c.T)?l=new c.T(l):c&&c.kind==="scalar"&&c.T===L.BYTES&&(l=Tn(l)),s[r]={case:o,value:l};break;case"scalar":case"enum":let u=a[r];i.T===L.BYTES&&(u=i.repeated?u.map(Tn):Tn(u)),s[r]=u;break;case"map":switch(i.V.kind){case"scalar":case"enum":if(i.V.T===L.BYTES)for(const[p,b]of Object.entries(a[r]))s[r][p]=Tn(b);else Object.assign(s[r],a[r]);break;case"message":const h=i.V.T;for(const p of Object.keys(a[r])){let b=a[r][p];h.fieldWrapper||(b=new h(b)),s[r][p]=b}break}break;case"message":const d=i.T;if(i.repeated)s[r]=a[r].map(h=>yt(h,d)?h:new d(h));else{const h=a[r];d.fieldWrapper?d.typeName==="google.protobuf.BytesValue"?s[r]=Tn(h):s[r]=h:s[r]=yt(h,d)?h:new d(h)}break}}},equals(n,e,t){return e===t?!0:!e||!t?!1:n.fields.byMember().every(i=>{const r=e[i.localName],s=t[i.localName];if(i.repeated){if(r.length!==s.length)return!1;switch(i.kind){case"message":return r.every((a,o)=>i.T.equals(a,s[o]));case"scalar":return r.every((a,o)=>Rt(i.T,a,s[o]));case"enum":return r.every((a,o)=>Rt(L.INT32,a,s[o]))}throw new Error("repeated cannot contain ".concat(i.kind))}switch(i.kind){case"message":let a=r,o=s;return i.T.fieldWrapper&&(a!==void 0&&!yt(a)&&(a=i.T.fieldWrapper.wrapField(a)),o!==void 0&&!yt(o)&&(o=i.T.fieldWrapper.wrapField(o))),i.T.equals(a,o);case"enum":return Rt(L.INT32,r,s);case"scalar":return Rt(i.T,r,s);case"oneof":if(r.case!==s.case)return!1;const c=i.findField(r.case);if(c===void 0)return!0;switch(c.kind){case"message":return c.T.equals(r.value,s.value);case"enum":return Rt(L.INT32,r.value,s.value);case"scalar":return Rt(c.T,r.value,s.value)}throw new Error("oneof cannot contain ".concat(c.kind));case"map":const l=Object.keys(r).concat(Object.keys(s));switch(i.V.kind){case"message":const u=i.V.T;return l.every(h=>u.equals(r[h],s[h]));case"enum":return l.every(h=>Rt(L.INT32,r[h],s[h]));case"scalar":const d=i.V.T;return l.every(h=>Rt(d,r[h],s[h]))}break}})},clone(n){const e=n.getType(),t=new e,i=t;for(const r of e.fields.byMember()){const s=n[r.localName];let a;if(r.repeated)a=s.map(Qn);else if(r.kind=="map"){a=i[r.localName];for(const[o,c]of Object.entries(s))a[o]=Qn(c)}else r.kind=="oneof"?a=r.findField(s.case)?{case:s.case,value:Qn(s.value)}:{case:void 0}:a=Qn(s);i[r.localName]=a}for(const r of e.runtime.bin.listUnknownFields(n))e.runtime.bin.onUnknownField(i,r.no,r.wireType,r.data);return t}}}function Qn(n){if(n===void 0)return n;if(yt(n))return n.clone();if(n instanceof Uint8Array){const e=new Uint8Array(n.byteLength);return e.set(n),e}return n}function Tn(n){return n instanceof Uint8Array?n:new Uint8Array(n)}function wd(n,e,t){return{syntax:n,json:pd(),bin:yd(),util:Object.assign(Object.assign({},Ed()),{newFieldList:e,initFields:t}),makeMessageType(i,r,s){return Zu(this,i,r,s)},makeEnum:Xu,makeEnumType:za,getEnumType:Qu,makeExtension(i,r,s){return ad(this,i,r,s)}}}class Pd{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const t={};for(const i of this.list())t[i.jsonName]=t[i.name]=i;this.jsonNames=t}return this.jsonNames[e]}find(e){if(!this.numbers){const t={};for(const i of this.list())t[i.no]=i;this.numbers=t}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const i of this.list())i.oneof?i.oneof!==t&&(t=i.oneof,e.push(t)):e.push(i)}return this.members}}function rc(n,e){const t=sc(n);return e?t:Md(xd(t))}function Rd(n){return rc(n,!1)}const _d=sc;function sc(n){let e=!1;const t=[];for(let i=0;i<n.length;i++){let r=n.charAt(i);switch(r){case"_":e=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.push(r),e=!1;break;default:e&&(e=!1,r=r.toUpperCase()),t.push(r);break}}return t.join("")}const Id=new Set(["constructor","toString","toJSON","valueOf"]),Od=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),oc=n=>"".concat(n,"$"),xd=n=>Od.has(n)?oc(n):n,Md=n=>Id.has(n)?oc(n):n;class Ad{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=Rd(e)}addField(e){ue(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let t=0;t<this.fields.length;t++)this._lookup[this.fields[t].localName]=this.fields[t]}return this._lookup[e]}}function Dd(n,e){var t,i,r,s,a,o;const c=[];let l;for(const u of typeof n=="function"?n():n){const d=u;if(d.localName=rc(u.name,u.oneof!==void 0),d.jsonName=(t=u.jsonName)!==null&&t!==void 0?t:_d(u.name),d.repeated=(i=u.repeated)!==null&&i!==void 0?i:!1,u.kind=="scalar"&&(d.L=(r=u.L)!==null&&r!==void 0?r:Ut.BIGINT),d.delimited=(s=u.delimited)!==null&&s!==void 0?s:!1,d.req=(a=u.req)!==null&&a!==void 0?a:!1,d.opt=(o=u.opt)!==null&&o!==void 0?o:!1,u.packed===void 0&&(d.packed=u.kind=="enum"||u.kind=="scalar"&&u.T!=L.BYTES&&u.T!=L.STRING),u.oneof!==void 0){const h=typeof u.oneof=="string"?u.oneof:u.oneof.name;(!l||l.name!=h)&&(l=new Ad(h)),d.oneof=l,l.addField(d)}c.push(d)}return c}const R=wd("proto3",n=>new Pd(n,e=>Dd(e)),n=>{for(const e of n.getType().fields.byMember()){if(e.opt)continue;const t=e.localName,i=n;if(e.repeated){i[t]=[];continue}switch(e.kind){case"oneof":i[t]={case:void 0};break;case"enum":i[t]=0;break;case"map":i[t]={};break;case"scalar":i[t]=pn(e.T,e.L);break}}});class De extends ds{constructor(e){super(),this.seconds=ce.zero,this.nanos=0,R.util.initPartial(e,this)}fromJson(e,t){if(typeof e!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(R.json.debug(e)));const i=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!i)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const r=Date.parse(i[1]+"-"+i[2]+"-"+i[3]+"T"+i[4]+":"+i[5]+":"+i[6]+(i[8]?i[8]:"Z"));if(Number.isNaN(r))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(r<Date.parse("0001-01-01T00:00:00Z")||r>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=ce.parse(r/1e3),this.nanos=0,i[7]&&(this.nanos=parseInt("1"+i[7]+"0".repeat(9-i[7].length))-1e9),this}toJson(e){const t=Number(this.seconds)*1e3;if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let i="Z";if(this.nanos>0){const r=(this.nanos+1e9).toString().substring(1);r.substring(3)==="000000"?i="."+r.substring(0,3)+"Z":r.substring(6)==="000"?i="."+r.substring(0,6)+"Z":i="."+r+"Z"}return new Date(t).toISOString().replace(".000Z",i)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return De.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new De({seconds:ce.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return new De().fromBinary(e,t)}static fromJson(e,t){return new De().fromJson(e,t)}static fromJsonString(e,t){return new De().fromJsonString(e,t)}static equals(e,t){return R.util.equals(De,e,t)}}De.runtime=R;De.typeName="google.protobuf.Timestamp";De.fields=R.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const Ld=R.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:De},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:Nd,repeated:!0},{no:5,name:"events",kind:"message",T:Fd,repeated:!0}]),Nd=R.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:Ud,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),Ud=R.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:De},{no:3,name:"value",kind:"scalar",T:2}]),Fd=R.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:De},{no:7,name:"normalized_end_timestamp",kind:"message",T:De,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),ac=R.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),ze=R.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),me=R.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),fs=R.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),On=R.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),Nn=R.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),Ye=R.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]),qt=R.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),jd=R.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),Te=R.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),ji=R.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:ki,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:kc}]),ki=R.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),Bd=R.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:R.getEnumType(me),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),zt=R.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:R.getEnumType(sn)},{no:4,name:"tracks",kind:"message",T:tn,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:Bd},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:R.getEnumType(Un)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:R.getEnumType(Ye)},{no:18,name:"kind_details",kind:"enum",T:R.getEnumType(Vd),repeated:!0}]),sn=R.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),Un=R.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"},{no:7,name:"CONNECTOR"}]),Vd=R.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),be=R.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),qd=R.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:At,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:R.getEnumType(cc)},{no:6,name:"sdp_cid",kind:"scalar",T:9}]),tn=R.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:R.getEnumType(ze)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:R.getEnumType(me)},{no:10,name:"layers",kind:"message",T:At,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:qd,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:R.getEnumType(be)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:kc},{no:19,name:"audio_features",kind:"enum",T:R.getEnumType(Te),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:R.getEnumType(ac)}]),At=R.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:R.getEnumType(fs)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}]),cc=R.makeEnum("livekit.VideoLayer.Mode",[{no:0,name:"MODE_UNUSED"},{no:1,name:"ONE_SPATIAL_LAYER_PER_STREAM"},{no:2,name:"MULTIPLE_SPATIAL_LAYERS_PER_STREAM"},{no:3,name:"ONE_SPATIAL_LAYER_PER_STREAM_INCOMPLETE_RTCP_SR"}]),Oe=R.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:R.getEnumType($)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:ps,oneof:"value"},{no:3,name:"speaker",kind:"message",T:Wd,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:hc,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Hd,oneof:"value"},{no:8,name:"metrics",kind:"message",T:Ld,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:Si,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:ms,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:gs,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:vs,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:Ti,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:Ci,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:Ei,oneof:"value"},{no:18,name:"encrypted_packet",kind:"message",T:lc,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}]),$=R.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),lc=R.makeMessageType("livekit.EncryptedPacket",()=>[{no:1,name:"encryption_type",kind:"enum",T:R.getEnumType(be)},{no:2,name:"iv",kind:"scalar",T:12},{no:3,name:"key_index",kind:"scalar",T:13},{no:4,name:"encrypted_value",kind:"scalar",T:12}]),uc=R.makeMessageType("livekit.EncryptedPacketPayload",()=>[{no:1,name:"user",kind:"message",T:ps,oneof:"value"},{no:3,name:"chat_message",kind:"message",T:Si,oneof:"value"},{no:4,name:"rpc_request",kind:"message",T:ms,oneof:"value"},{no:5,name:"rpc_ack",kind:"message",T:gs,oneof:"value"},{no:6,name:"rpc_response",kind:"message",T:vs,oneof:"value"},{no:7,name:"stream_header",kind:"message",T:Ti,oneof:"value"},{no:8,name:"stream_chunk",kind:"message",T:Ci,oneof:"value"},{no:9,name:"stream_trailer",kind:"message",T:Ei,oneof:"value"}]),Wd=R.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:dc,repeated:!0}]),dc=R.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),ps=R.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),hc=R.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),Hd=R.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:Kd,repeated:!0}]),Kd=R.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),Si=R.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),ms=R.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),gs=R.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),vs=R.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:fc,oneof:"value"}]),fc=R.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),pc=R.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),mc=R.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:R.getEnumType(gc)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),gc=R.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),vc=R.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:R.getEnumType(bc)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),bc=R.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]),yc=R.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:yo},{no:2,name:"screen",kind:"message",T:yo},{no:3,name:"resume_connection",kind:"enum",T:R.getEnumType(Nn)},{no:4,name:"disabled_codecs",kind:"message",T:zd},{no:5,name:"force_relay",kind:"enum",T:R.getEnumType(Nn)}]),yo=R.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:R.getEnumType(Nn)}]),zd=R.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:ki,repeated:!0},{no:2,name:"publish",kind:"message",T:ki,repeated:!0}]),kc=R.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),xr=R.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),Sc=R.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:R.getEnumType(xr)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),Tc=R.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),Ti=R.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:R.getEnumType(be)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:Sc,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:Tc,oneof:"content_header"}],{localName:"DataStream_Header"}),Ci=R.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),Ei=R.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),Gd=R.makeMessageType("livekit.SubscribedAudioCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"enabled",kind:"scalar",T:8}]),Ge=R.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),Mr=R.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),$d=R.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),Jd=R.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:Ft,oneof:"message"},{no:2,name:"answer",kind:"message",T:Ft,oneof:"message"},{no:3,name:"trickle",kind:"message",T:Bi,oneof:"message"},{no:4,name:"add_track",kind:"message",T:Fn,oneof:"message"},{no:5,name:"mute",kind:"message",T:Vi,oneof:"message"},{no:6,name:"subscription",kind:"message",T:qi,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:Cc,oneof:"message"},{no:8,name:"leave",kind:"message",T:Wi,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:wc,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:_c,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:Ts,oneof:"message"},{no:13,name:"simulate",kind:"message",T:st,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:ks,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:xc,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:ys,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:Ec,oneof:"message"}]),ko=R.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:Yd,oneof:"message"},{no:2,name:"answer",kind:"message",T:Ft,oneof:"message"},{no:3,name:"offer",kind:"message",T:Ft,oneof:"message"},{no:4,name:"trickle",kind:"message",T:Bi,oneof:"message"},{no:5,name:"update",kind:"message",T:Zd,oneof:"message"},{no:6,name:"track_published",kind:"message",T:bs,oneof:"message"},{no:8,name:"leave",kind:"message",T:Wi,oneof:"message"},{no:9,name:"mute",kind:"message",T:Vi,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:eh,oneof:"message"},{no:11,name:"room_update",kind:"message",T:th,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:ih,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:sh,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:ah,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:lh,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:Xd,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:Qd,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:dh,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:ph,oneof:"message"},{no:22,name:"request_response",kind:"message",T:mh,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:gh,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:uh,oneof:"message"},{no:25,name:"media_sections_requirement",kind:"message",T:kh,oneof:"message"},{no:26,name:"subscribed_audio_codec_update",kind:"message",T:ch,oneof:"message"}]),Ar=R.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:At,repeated:!0},{no:5,name:"video_layer_mode",kind:"enum",T:R.getEnumType(cc)}]),Fn=R.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:R.getEnumType(ze)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:R.getEnumType(me)},{no:9,name:"layers",kind:"message",T:At,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:Ar,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:R.getEnumType(be)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:R.getEnumType(ac)},{no:17,name:"audio_features",kind:"enum",T:R.getEnumType(Te),repeated:!0}]),Bi=R.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:R.getEnumType(Ge)},{no:3,name:"final",kind:"scalar",T:8}]),Vi=R.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),Yd=R.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:ji},{no:2,name:"participant",kind:"message",T:zt},{no:3,name:"other_participants",kind:"message",T:zt,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:Pc,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:yc},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:mc},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:ki,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),Qd=R.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:Pc,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:yc},{no:3,name:"server_info",kind:"message",T:mc},{no:4,name:"last_message_seq",kind:"scalar",T:13}]),bs=R.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:tn}]),Xd=R.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),Ft=R.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13},{no:4,name:"mid_to_track_id",kind:"map",K:9,V:{kind:"scalar",T:9}}]),Zd=R.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:zt,repeated:!0}]),qi=R.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:pc,repeated:!0}]),Cc=R.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:R.getEnumType(fs)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),ys=R.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:R.getEnumType(Te),repeated:!0}]),Ec=R.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),Wi=R.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:R.getEnumType(Ye)},{no:3,name:"action",kind:"enum",T:R.getEnumType(on)},{no:4,name:"regions",kind:"message",T:hh}]),on=R.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),wc=R.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:At,repeated:!0}]),ks=R.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),Pc=R.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),eh=R.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:dc,repeated:!0}]),th=R.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:ji}]),nh=R.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:R.getEnumType(On)},{no:3,name:"score",kind:"scalar",T:2}]),ih=R.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:nh,repeated:!0}]),rh=R.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:R.getEnumType(Mr)}]),sh=R.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:rh,repeated:!0}]),Ss=R.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:R.getEnumType(fs)},{no:2,name:"enabled",kind:"scalar",T:8}]),oh=R.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:Ss,repeated:!0}]),ah=R.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:Ss,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:oh,repeated:!0}]),ch=R.makeMessageType("livekit.SubscribedAudioCodecUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_audio_codecs",kind:"message",T:Gd,repeated:!0}]),Rc=R.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),_c=R.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:Rc,repeated:!0}]),lh=R.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),uh=R.makeMessageType("livekit.RoomMovedResponse",()=>[{no:1,name:"room",kind:"message",T:ji},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:zt},{no:4,name:"other_participants",kind:"message",T:zt,repeated:!0}]),Ts=R.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:Ft},{no:2,name:"subscription",kind:"message",T:qi},{no:3,name:"publish_tracks",kind:"message",T:bs,repeated:!0},{no:4,name:"data_channels",kind:"message",T:Oc,repeated:!0},{no:5,name:"offer",kind:"message",T:Ft},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0},{no:7,name:"datachannel_receive_states",kind:"message",T:Ic,repeated:!0}]),Ic=R.makeMessageType("livekit.DataChannelReceiveState",()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}]),Oc=R.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:R.getEnumType(Ge)}]),st=R.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:R.getEnumType($d),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),xc=R.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),dh=R.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),hh=R.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:fh,repeated:!0}]),fh=R.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),ph=R.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:R.getEnumType(jd)}]),mh=R.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:R.getEnumType(Cs)},{no:3,name:"message",kind:"scalar",T:9},{no:4,name:"trickle",kind:"message",T:Bi,oneof:"request"},{no:5,name:"add_track",kind:"message",T:Fn,oneof:"request"},{no:6,name:"mute",kind:"message",T:Vi,oneof:"request"},{no:7,name:"update_metadata",kind:"message",T:ks,oneof:"request"},{no:8,name:"update_audio_track",kind:"message",T:ys,oneof:"request"},{no:9,name:"update_video_track",kind:"message",T:Ec,oneof:"request"}]),Cs=R.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"},{no:4,name:"QUEUED"},{no:5,name:"UNSUPPORTED_TYPE"},{no:6,name:"UNCLASSIFIED_ERROR"}]),gh=R.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),Mc=R.makeMessageType("livekit.ConnectionSettings",()=>[{no:1,name:"auto_subscribe",kind:"scalar",T:8},{no:2,name:"adaptive_stream",kind:"scalar",T:8},{no:3,name:"subscriber_allow_pause",kind:"scalar",T:8,opt:!0},{no:4,name:"disable_ice_lite",kind:"scalar",T:8}]),vh=R.makeMessageType("livekit.JoinRequest",()=>[{no:1,name:"client_info",kind:"message",T:vc},{no:2,name:"connection_settings",kind:"message",T:Mc},{no:3,name:"metadata",kind:"scalar",T:9},{no:4,name:"participant_attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:5,name:"add_track_requests",kind:"message",T:Fn,repeated:!0},{no:6,name:"publisher_offer",kind:"message",T:Ft},{no:7,name:"reconnect",kind:"scalar",T:8},{no:8,name:"reconnect_reason",kind:"enum",T:R.getEnumType(qt)},{no:9,name:"participant_sid",kind:"scalar",T:9},{no:10,name:"sync_state",kind:"message",T:Ts}]),bh=R.makeMessageType("livekit.WrappedJoinRequest",()=>[{no:1,name:"compression",kind:"enum",T:R.getEnumType(yh)},{no:2,name:"join_request",kind:"scalar",T:12}]),yh=R.makeEnum("livekit.WrappedJoinRequest.Compression",[{no:0,name:"NONE"},{no:1,name:"GZIP"}]),kh=R.makeMessageType("livekit.MediaSectionsRequirement",()=>[{no:1,name:"num_audios",kind:"scalar",T:13},{no:2,name:"num_videos",kind:"scalar",T:13}]);function Sh(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var li={exports:{}},Th=li.exports,So;function Ch(){return So||(So=1,(function(n){(function(e,t){n.exports?n.exports=t():e.log=t()})(Th,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},a=null;function o(m,T){var k=m[T];if(typeof k.bind=="function")return k.bind(m);try{return Function.prototype.bind.call(k,m)}catch{return function(){return Function.prototype.apply.apply(k,[m,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&i?c:console[m]!==void 0?o(console,m):console.log!==void 0?o(console,"log"):e}function u(){for(var m=this.getLevel(),T=0;T<r.length;T++){var k=r[T];this[k]=T<m?e:this.methodFactory(k,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==t&&(u.call(this),this[m].apply(this,arguments))}}function h(m,T,k){return l(m)||d.apply(this,arguments)}function p(m,T){var k=this,w,M,v,g="loglevel";typeof m=="string"?g+=":"+m:typeof m=="symbol"&&(g=void 0);function y(D){var j=(r[D]||"silent").toUpperCase();if(!(typeof window===t||!g)){try{window.localStorage[g]=j;return}catch{}try{window.document.cookie=encodeURIComponent(g)+"="+j+";"}catch{}}}function C(){var D;if(!(typeof window===t||!g)){try{D=window.localStorage[g]}catch{}if(typeof D===t)try{var j=window.document.cookie,z=encodeURIComponent(g),ee=j.indexOf(z+"=");ee!==-1&&(D=/^([^;]+)/.exec(j.slice(ee+z.length+1))[1])}catch{}return k.levels[D]===void 0&&(D=void 0),D}}function x(){if(!(typeof window===t||!g)){try{window.localStorage.removeItem(g)}catch{}try{window.document.cookie=encodeURIComponent(g)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function _(D){var j=D;if(typeof j=="string"&&k.levels[j.toUpperCase()]!==void 0&&(j=k.levels[j.toUpperCase()]),typeof j=="number"&&j>=0&&j<=k.levels.SILENT)return j;throw new TypeError("log.setLevel() called with invalid level: "+D)}k.name=m,k.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},k.methodFactory=T||h,k.getLevel=function(){return v??M??w},k.setLevel=function(D,j){return v=_(D),j!==!1&&y(v),u.call(k)},k.setDefaultLevel=function(D){M=_(D),C()||k.setLevel(D,!1)},k.resetLevel=function(){v=null,x(),u.call(k)},k.enableAll=function(D){k.setLevel(k.levels.TRACE,D)},k.disableAll=function(D){k.setLevel(k.levels.SILENT,D)},k.rebuild=function(){if(a!==k&&(w=_(a.getLevel())),u.call(k),a===k)for(var D in s)s[D].rebuild()},w=_(a?a.getLevel():"WARN");var O=C();O!=null&&(v=_(O)),u.call(k)}a=new p,a.getLogger=function(T){if(typeof T!="symbol"&&typeof T!="string"||T==="")throw new TypeError("You must supply a name when creating a logger.");var k=s[T];return k||(k=s[T]=new p(T,a.methodFactory)),k};var b=typeof window!==t?window.log:void 0;return a.noConflict=function(){return typeof window!==t&&window.log===a&&(window.log=b),a},a.getLoggers=function(){return s},a.default=a,a})})(li)),li.exports}var Hi=Ch(),Dr;(function(n){n[n.trace=0]="trace",n[n.debug=1]="debug",n[n.info=2]="info",n[n.warn=3]="warn",n[n.error=4]="error",n[n.silent=5]="silent"})(Dr||(Dr={}));var Qe;(function(n){n.Default="livekit",n.Room="livekit-room",n.TokenSource="livekit-token-source",n.Participant="livekit-participant",n.Track="livekit-track",n.Publication="livekit-track-publication",n.Engine="livekit-engine",n.Signal="livekit-signal",n.PCManager="livekit-pc-manager",n.PCTransport="livekit-pc-transport",n.E2EE="lk-e2ee"})(Qe||(Qe={}));let K=Hi.getLogger("livekit");Object.values(Qe).map(n=>Hi.getLogger(n));K.setDefaultLevel(Dr.info);function Tt(n){const e=Hi.getLogger(n);return e.setDefaultLevel(K.getLevel()),e}const Eh=Hi.getLogger("lk-e2ee"),Cn=7e3,wh=[0,300,4*300,9*300,16*300,Cn,Cn,Cn,Cn,Cn];class Ph{constructor(e){this._retryDelays=e!==void 0?[...e]:wh}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+Math.random()*1e3}}function Rh(n,e){var t={};for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&e.indexOf(i)<0&&(t[i]=n[i]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(n);r<i.length;r++)e.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(n,i[r])&&(t[i[r]]=n[i[r]]);return t}function S(n,e,t,i){function r(s){return s instanceof t?s:new t(function(a){a(s)})}return new(t||(t=Promise))(function(s,a){function o(u){try{l(i.next(u))}catch(d){a(d)}}function c(u){try{l(i.throw(u))}catch(d){a(d)}}function l(u){u.done?s(u.value):r(u.value).then(o,c)}l((i=i.apply(n,e||[])).next())})}function To(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function kt(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof To=="function"?To(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(a){return new Promise(function(o,c){a=n[s](a),r(o,c,a.done,a.value)})}}function r(s,a,o,c){Promise.resolve(c).then(function(l){s({value:l,done:o})},a)}}var Xn={exports:{}},Co;function _h(){if(Co)return Xn.exports;Co=1;var n=typeof Reflect=="object"?Reflect:null,e=n&&typeof n.apply=="function"?n.apply:function(g,y,C){return Function.prototype.apply.call(g,y,C)},t;n&&typeof n.ownKeys=="function"?t=n.ownKeys:Object.getOwnPropertySymbols?t=function(g){return Object.getOwnPropertyNames(g).concat(Object.getOwnPropertySymbols(g))}:t=function(g){return Object.getOwnPropertyNames(g)};function i(v){console&&console.warn&&console.warn(v)}var r=Number.isNaN||function(g){return g!==g};function s(){s.init.call(this)}Xn.exports=s,Xn.exports.once=k,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var a=10;function o(v){if(typeof v!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof v)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(v){if(typeof v!="number"||v<0||r(v))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+v+".");a=v}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(g){if(typeof g!="number"||g<0||r(g))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+g+".");return this._maxListeners=g,this};function c(v){return v._maxListeners===void 0?s.defaultMaxListeners:v._maxListeners}s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(g){for(var y=[],C=1;C<arguments.length;C++)y.push(arguments[C]);var x=g==="error",_=this._events;if(_!==void 0)x=x&&_.error===void 0;else if(!x)return!1;if(x){var O;if(y.length>0&&(O=y[0]),O instanceof Error)throw O;var D=new Error("Unhandled error."+(O?" ("+O.message+")":""));throw D.context=O,D}var j=_[g];if(j===void 0)return!1;if(typeof j=="function")e(j,this,y);else for(var z=j.length,ee=b(j,z),C=0;C<z;++C)e(ee[C],this,y);return!0};function l(v,g,y,C){var x,_,O;if(o(y),_=v._events,_===void 0?(_=v._events=Object.create(null),v._eventsCount=0):(_.newListener!==void 0&&(v.emit("newListener",g,y.listener?y.listener:y),_=v._events),O=_[g]),O===void 0)O=_[g]=y,++v._eventsCount;else if(typeof O=="function"?O=_[g]=C?[y,O]:[O,y]:C?O.unshift(y):O.push(y),x=c(v),x>0&&O.length>x&&!O.warned){O.warned=!0;var D=new Error("Possible EventEmitter memory leak detected. "+O.length+" "+String(g)+" listeners added. Use emitter.setMaxListeners() to increase limit");D.name="MaxListenersExceededWarning",D.emitter=v,D.type=g,D.count=O.length,i(D)}return v}s.prototype.addListener=function(g,y){return l(this,g,y,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(g,y){return l(this,g,y,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(v,g,y){var C={fired:!1,wrapFn:void 0,target:v,type:g,listener:y},x=u.bind(C);return x.listener=y,C.wrapFn=x,x}s.prototype.once=function(g,y){return o(y),this.on(g,d(this,g,y)),this},s.prototype.prependOnceListener=function(g,y){return o(y),this.prependListener(g,d(this,g,y)),this},s.prototype.removeListener=function(g,y){var C,x,_,O,D;if(o(y),x=this._events,x===void 0)return this;if(C=x[g],C===void 0)return this;if(C===y||C.listener===y)--this._eventsCount===0?this._events=Object.create(null):(delete x[g],x.removeListener&&this.emit("removeListener",g,C.listener||y));else if(typeof C!="function"){for(_=-1,O=C.length-1;O>=0;O--)if(C[O]===y||C[O].listener===y){D=C[O].listener,_=O;break}if(_<0)return this;_===0?C.shift():m(C,_),C.length===1&&(x[g]=C[0]),x.removeListener!==void 0&&this.emit("removeListener",g,D||y)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(g){var y,C,x;if(C=this._events,C===void 0)return this;if(C.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):C[g]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete C[g]),this;if(arguments.length===0){var _=Object.keys(C),O;for(x=0;x<_.length;++x)O=_[x],O!=="removeListener"&&this.removeAllListeners(O);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(y=C[g],typeof y=="function")this.removeListener(g,y);else if(y!==void 0)for(x=y.length-1;x>=0;x--)this.removeListener(g,y[x]);return this};function h(v,g,y){var C=v._events;if(C===void 0)return[];var x=C[g];return x===void 0?[]:typeof x=="function"?y?[x.listener||x]:[x]:y?T(x):b(x,x.length)}s.prototype.listeners=function(g){return h(this,g,!0)},s.prototype.rawListeners=function(g){return h(this,g,!1)},s.listenerCount=function(v,g){return typeof v.listenerCount=="function"?v.listenerCount(g):p.call(v,g)},s.prototype.listenerCount=p;function p(v){var g=this._events;if(g!==void 0){var y=g[v];if(typeof y=="function")return 1;if(y!==void 0)return y.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function b(v,g){for(var y=new Array(g),C=0;C<g;++C)y[C]=v[C];return y}function m(v,g){for(;g+1<v.length;g++)v[g]=v[g+1];v.pop()}function T(v){for(var g=new Array(v.length),y=0;y<g.length;++y)g[y]=v[y].listener||v[y];return g}function k(v,g){return new Promise(function(y,C){function x(O){v.removeListener(g,_),C(O)}function _(){typeof v.removeListener=="function"&&v.removeListener("error",x),y([].slice.call(arguments))}M(v,g,_,{once:!0}),g!=="error"&&w(v,x,{once:!0})})}function w(v,g,y){typeof v.on=="function"&&M(v,"error",g,y)}function M(v,g,y,C){if(typeof v.on=="function")C.once?v.once(g,y):v.on(g,y);else if(typeof v.addEventListener=="function")v.addEventListener(g,function x(_){C.once&&v.removeEventListener(g,x),y(_)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof v)}return Xn.exports}var dt=_h();let Ac=!0,Dc=!0;function xn(n,e,t){const i=n.match(e);return i&&i.length>=t&&parseFloat(i[t],10)}function Xt(n,e,t){if(!n.RTCPeerConnection)return;const i=n.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(a,o){if(a!==e)return r.apply(this,arguments);const c=l=>{const u=t(l);u&&(o.handleEvent?o.handleEvent(u):o(u))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(o,c),r.apply(this,[a,c])};const s=i.removeEventListener;i.removeEventListener=function(a,o){if(a!==e||!this._eventMap||!this._eventMap[e])return s.apply(this,arguments);if(!this._eventMap[e].has(o))return s.apply(this,arguments);const c=this._eventMap[e].get(o);return this._eventMap[e].delete(o),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[a,c])},Object.defineProperty(i,"on"+e,{get(){return this["_on"+e]},set(a){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),a&&this.addEventListener(e,this["_on"+e]=a)},enumerable:!0,configurable:!0})}function Ih(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(Ac=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function Oh(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(Dc=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function Lc(){if(typeof window=="object"){if(Ac)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Es(n,e){Dc&&console.warn(n+" is deprecated, please use "+e+" instead.")}function xh(n){const e={browser:null,version:null};if(typeof n>"u"||!n.navigator||!n.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:t}=n;if(t.userAgentData&&t.userAgentData.brands){const i=t.userAgentData.brands.find(r=>r.brand==="Chromium");if(i)return{browser:"chrome",version:parseInt(i.version,10)}}if(t.mozGetUserMedia)e.browser="firefox",e.version=parseInt(xn(t.userAgent,/Firefox\/(\d+)\./,1));else if(t.webkitGetUserMedia||n.isSecureContext===!1&&n.webkitRTCPeerConnection)e.browser="chrome",e.version=parseInt(xn(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else if(n.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))e.browser="safari",e.version=parseInt(xn(t.userAgent,/AppleWebKit\/(\d+)\./,1)),e.supportsUnifiedPlan=n.RTCRtpTransceiver&&"currentDirection"in n.RTCRtpTransceiver.prototype,e._safariVersion=xn(t.userAgent,/Version\/(\d+(\.?\d+))/,1);else return e.browser="Not a supported browser.",e;return e}function Eo(n){return Object.prototype.toString.call(n)==="[object Object]"}function Nc(n){return Eo(n)?Object.keys(n).reduce(function(e,t){const i=Eo(n[t]),r=i?Nc(n[t]):n[t],s=i&&!Object.keys(r).length;return r===void 0||s?e:Object.assign(e,{[t]:r})},{}):n}function Lr(n,e,t){!e||t.has(e.id)||(t.set(e.id,e),Object.keys(e).forEach(i=>{i.endsWith("Id")?Lr(n,n.get(e[i]),t):i.endsWith("Ids")&&e[i].forEach(r=>{Lr(n,n.get(r),t)})}))}function wo(n,e,t){const i=t?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;const s=[];return n.forEach(a=>{a.type==="track"&&a.trackIdentifier===e.id&&s.push(a)}),s.forEach(a=>{n.forEach(o=>{o.type===i&&o.trackId===a.id&&Lr(n,o,r)})}),r}const Po=Lc;function Uc(n,e){const t=n&&n.navigator;if(!t.mediaDevices)return;const i=function(o){if(typeof o!="object"||o.mandatory||o.optional)return o;const c={};return Object.keys(o).forEach(l=>{if(l==="require"||l==="advanced"||l==="mediaSource")return;const u=typeof o[l]=="object"?o[l]:{ideal:o[l]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const d=function(h,p){return h?h+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(u.ideal!==void 0){c.optional=c.optional||[];let h={};typeof u.ideal=="number"?(h[d("min",l)]=u.ideal,c.optional.push(h),h={},h[d("max",l)]=u.ideal,c.optional.push(h)):(h[d("",l)]=u.ideal,c.optional.push(h))}u.exact!==void 0&&typeof u.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[d("",l)]=u.exact):["min","max"].forEach(h=>{u[h]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[d(h,l)]=u[h])})}),o.advanced&&(c.optional=(c.optional||[]).concat(o.advanced)),c},r=function(o,c){if(e.version>=61)return c(o);if(o=JSON.parse(JSON.stringify(o)),o&&typeof o.audio=="object"){const l=function(u,d,h){d in u&&!(h in u)&&(u[h]=u[d],delete u[d])};o=JSON.parse(JSON.stringify(o)),l(o.audio,"autoGainControl","googAutoGainControl"),l(o.audio,"noiseSuppression","googNoiseSuppression"),o.audio=i(o.audio)}if(o&&typeof o.video=="object"){let l=o.video.facingMode;l=l&&(typeof l=="object"?l:{ideal:l});const u=e.version<66;if(l&&(l.exact==="user"||l.exact==="environment"||l.ideal==="user"||l.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!u)){delete o.video.facingMode;let d;if(l.exact==="environment"||l.ideal==="environment"?d=["back","rear"]:(l.exact==="user"||l.ideal==="user")&&(d=["front"]),d)return t.mediaDevices.enumerateDevices().then(h=>{h=h.filter(b=>b.kind==="videoinput");let p=h.find(b=>d.some(m=>b.label.toLowerCase().includes(m)));return!p&&h.length&&d.includes("back")&&(p=h[h.length-1]),p&&(o.video.deviceId=l.exact?{exact:p.deviceId}:{ideal:p.deviceId}),o.video=i(o.video),Po("chrome: "+JSON.stringify(o)),c(o)})}o.video=i(o.video)}return Po("chrome: "+JSON.stringify(o)),c(o)},s=function(o){return e.version>=64?o:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[o.name]||o.name,message:o.message,constraint:o.constraint||o.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},a=function(o,c,l){r(o,u=>{t.webkitGetUserMedia(u,c,d=>{l&&l(s(d))})})};if(t.getUserMedia=a.bind(t),t.mediaDevices.getUserMedia){const o=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(c){return r(c,l=>o(l).then(u=>{if(l.audio&&!u.getAudioTracks().length||l.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(d=>{d.stop()}),new DOMException("","NotFoundError");return u},u=>Promise.reject(s(u))))}}}function Fc(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function jc(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",r=>{let s;n.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(o=>o.track&&o.track.id===r.track.id):s={track:r.track};const a=new Event("track");a.track=r.track,a.receiver=s,a.transceiver={receiver:s},a.streams=[i.stream],this.dispatchEvent(a)}),i.stream.getTracks().forEach(r=>{let s;n.RTCPeerConnection.prototype.getReceivers?s=this.getReceivers().find(o=>o.track&&o.track.id===r.id):s={track:r};const a=new Event("track");a.track=r,a.receiver=s,a.transceiver={receiver:s},a.streams=[i.stream],this.dispatchEvent(a)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else Xt(n,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function Bc(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){const e=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(o,c){let l=r.apply(this,arguments);return l||(l=e(this,o),this._senders.push(l)),l};const s=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(o){s.apply(this,arguments);const c=this._senders.indexOf(o);c!==-1&&this._senders.splice(c,1)}}const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(s){this._senders=this._senders||[],t.apply(this,[s]),s.getTracks().forEach(a=>{this._senders.push(e(this,a))})};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(s){this._senders=this._senders||[],i.apply(this,[s]),s.getTracks().forEach(a=>{const o=this._senders.find(c=>c.track===a);o&&this._senders.splice(this._senders.indexOf(o),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){const e=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Vc(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){const t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){const s=t.apply(this,[]);return s.forEach(a=>a._pc=this),s});const i=n.RTCPeerConnection.prototype.addTrack;i&&(n.RTCPeerConnection.prototype.addTrack=function(){const s=i.apply(this,arguments);return s._pc=this,s}),n.RTCRtpSender.prototype.getStats=function(){const s=this;return this._pc.getStats().then(a=>wo(a,s.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){const t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){const r=t.apply(this,[]);return r.forEach(s=>s._pc=this),r}),Xt(n,"track",i=>(i.receiver._pc=i.srcElement,i)),n.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(s=>wo(s,r.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype&&"getStats"in n.RTCRtpReceiver.prototype))return;const e=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){const i=arguments[0];let r,s,a;return this.getSenders().forEach(o=>{o.track===i&&(r?a=!0:r=o)}),this.getReceivers().forEach(o=>(o.track===i&&(s?a=!0:s=o),o.track===i)),a||r&&s?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():s?s.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function qc(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(a=>this._shimmedLocalStreams[a][0])};const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(a,o){if(!o)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=e.apply(this,arguments);return this._shimmedLocalStreams[o.id]?this._shimmedLocalStreams[o.id].indexOf(c)===-1&&this._shimmedLocalStreams[o.id].push(c):this._shimmedLocalStreams[o.id]=[o,c],c};const t=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(a){this._shimmedLocalStreams=this._shimmedLocalStreams||{},a.getTracks().forEach(l=>{if(this.getSenders().find(d=>d.track===l))throw new DOMException("Track already exists.","InvalidAccessError")});const o=this.getSenders();t.apply(this,arguments);const c=this.getSenders().filter(l=>o.indexOf(l)===-1);this._shimmedLocalStreams[a.id]=[a].concat(c)};const i=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[a.id],i.apply(this,arguments)};const r=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},a&&Object.keys(this._shimmedLocalStreams).forEach(o=>{const c=this._shimmedLocalStreams[o].indexOf(a);c!==-1&&this._shimmedLocalStreams[o].splice(c,1),this._shimmedLocalStreams[o].length===1&&delete this._shimmedLocalStreams[o]}),r.apply(this,arguments)}}function Wc(n,e){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&e.version>=65)return qc(n);const t=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){const u=t.apply(this);return this._reverseStreams=this._reverseStreams||{},u.map(d=>this._reverseStreams[d.id])};const i=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(u){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},u.getTracks().forEach(d=>{if(this.getSenders().find(p=>p.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[u.id]){const d=new n.MediaStream(u.getTracks());this._streams[u.id]=d,this._reverseStreams[d.id]=u,u=d}i.apply(this,[u])};const r=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(u){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[u.id]||u]),delete this._reverseStreams[this._streams[u.id]?this._streams[u.id].id:u.id],delete this._streams[u.id]},n.RTCPeerConnection.prototype.addTrack=function(u,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(m=>m===u))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(m=>m.track===u))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const b=this._streams[d.id];if(b)b.addTrack(u),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const m=new n.MediaStream([u]);this._streams[d.id]=m,this._reverseStreams[m.id]=d,this.addStream(m)}return this.getSenders().find(m=>m.track===u)};function s(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(h=>{const p=l._reverseStreams[h],b=l._streams[p.id];d=d.replace(new RegExp(b.id,"g"),p.id)}),new RTCSessionDescription({type:u.type,sdp:d})}function a(l,u){let d=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(h=>{const p=l._reverseStreams[h],b=l._streams[p.id];d=d.replace(new RegExp(p.id,"g"),b.id)}),new RTCSessionDescription({type:u.type,sdp:d})}["createOffer","createAnswer"].forEach(function(l){const u=n.RTCPeerConnection.prototype[l],d={[l](){const h=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[b=>{const m=s(this,b);h[0].apply(null,[m])},b=>{h[1]&&h[1].apply(null,b)},arguments[2]]):u.apply(this,arguments).then(b=>s(this,b))}};n.RTCPeerConnection.prototype[l]=d[l]});const o=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?o.apply(this,arguments):(arguments[0]=a(this,arguments[0]),o.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){const l=c.get.apply(this);return l.type===""?l:s(this,l)}}),n.RTCPeerConnection.prototype.removeTrack=function(u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!u._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(u._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let h;Object.keys(this._streams).forEach(p=>{this._streams[p].getTracks().find(m=>u.track===m)&&(h=this._streams[p])}),h&&(h.getTracks().length===1?this.removeStream(this._reverseStreams[h.id]):h.removeTrack(u.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Nr(n,e){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const i=n.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new(t==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};n.RTCPeerConnection.prototype[t]=r[t]})}function Hc(n,e){Xt(n,"negotiationneeded",t=>{const i=t.target;if(!((e.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")&&i.signalingState!=="stable"))return t})}var Ro=Object.freeze({__proto__:null,fixNegotiationNeeded:Hc,shimAddTrackRemoveTrack:Wc,shimAddTrackRemoveTrackWithNative:qc,shimGetSendersWithDtmf:Bc,shimGetUserMedia:Uc,shimMediaStream:Fc,shimOnTrack:jc,shimPeerConnection:Nr,shimSenderReceiverGetStats:Vc});function Kc(n,e){const t=n&&n.navigator,i=n&&n.MediaStreamTrack;if(t.getUserMedia=function(r,s,a){Es("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(r).then(s,a)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){const r=function(a,o,c){o in a&&!(c in a)&&(a[c]=a[o],delete a[o])},s=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(a){return typeof a=="object"&&typeof a.audio=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a.audio,"autoGainControl","mozAutoGainControl"),r(a.audio,"noiseSuppression","mozNoiseSuppression")),s(a)},i&&i.prototype.getSettings){const a=i.prototype.getSettings;i.prototype.getSettings=function(){const o=a.apply(this,arguments);return r(o,"mozAutoGainControl","autoGainControl"),r(o,"mozNoiseSuppression","noiseSuppression"),o}}if(i&&i.prototype.applyConstraints){const a=i.prototype.applyConstraints;i.prototype.applyConstraints=function(o){return this.kind==="audio"&&typeof o=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o,"autoGainControl","mozAutoGainControl"),r(o,"noiseSuppression","mozNoiseSuppression")),a.apply(this,[o])}}}}function Mh(n,e){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return i.video===!0?i.video={mediaSource:e}:i.video.mediaSource=e,n.navigator.mediaDevices.getUserMedia(i)})}function zc(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Ur(n,e){if(typeof n!="object"||!(n.RTCPeerConnection||n.mozRTCPeerConnection))return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const s=n.RTCPeerConnection.prototype[r],a={[r](){return arguments[0]=new(r==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};n.RTCPeerConnection.prototype[r]=a[r]});const t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[s,a,o]=arguments;return i.apply(this,[s||null]).then(c=>{if(e.version<53&&!a)try{c.forEach(l=>{l.type=t[l.type]||l.type})}catch(l){if(l.name!=="TypeError")throw l;c.forEach((u,d)=>{c.set(d,Object.assign({},u,{type:t[u.type]||u.type}))})}return c}).then(a,o)}}function Gc(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;const e=n.RTCPeerConnection.prototype.getSenders;e&&(n.RTCPeerConnection.prototype.getSenders=function(){const r=e.apply(this,[]);return r.forEach(s=>s._pc=this),r});const t=n.RTCPeerConnection.prototype.addTrack;t&&(n.RTCPeerConnection.prototype.addTrack=function(){const r=t.apply(this,arguments);return r._pc=this,r}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function $c(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;const e=n.RTCPeerConnection.prototype.getReceivers;e&&(n.RTCPeerConnection.prototype.getReceivers=function(){const i=e.apply(this,[]);return i.forEach(r=>r._pc=this),i}),Xt(n,"track",t=>(t.receiver._pc=t.srcElement,t)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Jc(n){!n.RTCPeerConnection||"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){Es("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&t.getTracks().includes(i.track)&&this.removeTrack(i)})})}function Yc(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function Qc(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.addTransceiver;e&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const r=i.length>0;r&&i.forEach(a=>{if("rid"in a&&!/^[a-z0-9]{0,16}$/i.test(a.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in a&&!(parseFloat(a.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in a&&!(parseFloat(a.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const s=e.apply(this,arguments);if(r){const{sender:a}=s,o=a.getParameters();(!("encodings"in o)||o.encodings.length===1&&Object.keys(o.encodings[0]).length===0)&&(o.encodings=i,a.sendEncodings=i,this.setParametersPromises.push(a.setParameters(o).then(()=>{delete a.sendEncodings}).catch(()=>{delete a.sendEncodings})))}return s})}function Xc(n){if(!(typeof n=="object"&&n.RTCRtpSender))return;const e=n.RTCRtpSender.prototype.getParameters;e&&(n.RTCRtpSender.prototype.getParameters=function(){const i=e.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function Zc(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function el(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const e=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var _o=Object.freeze({__proto__:null,shimAddTransceiver:Qc,shimCreateAnswer:el,shimCreateOffer:Zc,shimGetDisplayMedia:Mh,shimGetParameters:Xc,shimGetUserMedia:Kc,shimOnTrack:zc,shimPeerConnection:Ur,shimRTCDataChannel:Yc,shimReceiverGetStats:$c,shimRemoveStream:Jc,shimSenderGetStats:Gc});function tl(n){if(!(typeof n!="object"||!n.RTCPeerConnection)){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){const e=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(r=>e.call(this,r,i)),i.getVideoTracks().forEach(r=>e.call(this,r,i))},n.RTCPeerConnection.prototype.addTrack=function(i){for(var r=arguments.length,s=new Array(r>1?r-1:0),a=1;a<r;a++)s[a-1]=arguments[a];return s&&s.forEach(o=>{this._localStreams?this._localStreams.includes(o)||this._localStreams.push(o):this._localStreams=[o]}),e.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(t);if(i===-1)return;this._localStreams.splice(i,1);const r=t.getTracks();this.getSenders().forEach(s=>{r.includes(s.track)&&this.removeTrack(s)})})}}function nl(n){if(!(typeof n!="object"||!n.RTCPeerConnection)&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});const e=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(s=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(s)>=0)return;i._remoteStreams.push(s);const a=new Event("addstream");a.stream=s,i.dispatchEvent(a)})}),e.apply(i,arguments)}}}function il(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const e=n.RTCPeerConnection.prototype,t=e.createOffer,i=e.createAnswer,r=e.setLocalDescription,s=e.setRemoteDescription,a=e.addIceCandidate;e.createOffer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],h=t.apply(this,[d]);return u?(h.then(l,u),Promise.resolve()):h},e.createAnswer=function(l,u){const d=arguments.length>=2?arguments[2]:arguments[0],h=i.apply(this,[d]);return u?(h.then(l,u),Promise.resolve()):h};let o=function(c,l,u){const d=r.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d};e.setLocalDescription=o,o=function(c,l,u){const d=s.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.setRemoteDescription=o,o=function(c,l,u){const d=a.apply(this,[c]);return u?(d.then(l,u),Promise.resolve()):d},e.addIceCandidate=o}function rl(n){const e=n&&n.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,i=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=r=>i(sl(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(i,r,s){e.mediaDevices.getUserMedia(i).then(r,s)}).bind(e))}function sl(n){return n&&n.video!==void 0?Object.assign({},n,{video:Nc(n.video)}):n}function ol(n){if(!n.RTCPeerConnection)return;const e=n.RTCPeerConnection;n.RTCPeerConnection=function(i,r){if(i&&i.iceServers){const s=[];for(let a=0;a<i.iceServers.length;a++){let o=i.iceServers[a];o.urls===void 0&&o.url?(Es("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,s.push(o)):s.push(i.iceServers[a])}i.iceServers=s}return new e(i,r)},n.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}function al(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function cl(n){const e=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(i){if(i){typeof i.offerToReceiveAudio<"u"&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const r=this.getTransceivers().find(a=>a.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof i.offerToReceiveVideo<"u"&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const s=this.getTransceivers().find(a=>a.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&s?s.direction==="sendrecv"?s.setDirection?s.setDirection("sendonly"):s.direction="sendonly":s.direction==="recvonly"&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive"):i.offerToReceiveVideo===!0&&!s&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function ll(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}var Io=Object.freeze({__proto__:null,shimAudioContext:ll,shimCallbacksAPI:il,shimConstraints:sl,shimCreateOfferLegacy:cl,shimGetUserMedia:rl,shimLocalStreamsAPI:tl,shimRTCIceServerUrls:ol,shimRemoteStreamsAPI:nl,shimTrackEventTransceiver:al}),cr={exports:{}},Oo;function Ah(){return Oo||(Oo=1,(function(n){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(i=>i.trim())},e.splitSections=function(t){return t.split(`
m=`).map((r,s)=>(s>0?"m="+r:r).trim()+`\r
`)},e.getDescription=function(t){const i=e.splitSections(t);return i&&i[0]},e.getMediaSections=function(t){const i=e.splitSections(t);return i.shift(),i},e.matchPrefix=function(t,i){return e.splitLines(t).filter(r=>r.indexOf(i)===0)},e.parseCandidate=function(t){let i;t.indexOf("a=candidate:")===0?i=t.substring(12).split(" "):i=t.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let s=8;s<i.length;s+=2)switch(i[s]){case"raddr":r.relatedAddress=i[s+1];break;case"rport":r.relatedPort=parseInt(i[s+1],10);break;case"tcptype":r.tcpType=i[s+1];break;case"ufrag":r.ufrag=i[s+1],r.usernameFragment=i[s+1];break;default:r[i[s]]===void 0&&(r[i[s]]=i[s+1]);break}return r},e.writeCandidate=function(t){const i=[];i.push(t.foundation);const r=t.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(t.protocol.toUpperCase()),i.push(t.priority),i.push(t.address||t.ip),i.push(t.port);const s=t.type;return i.push("typ"),i.push(s),s!=="host"&&t.relatedAddress&&t.relatedPort&&(i.push("raddr"),i.push(t.relatedAddress),i.push("rport"),i.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(i.push("ufrag"),i.push(t.usernameFragment||t.ufrag)),"candidate:"+i.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let i=t.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(t){let i=t.payloadType;t.preferredPayloadType!==void 0&&(i=t.preferredPayloadType);const r=t.channels||t.numChannels||1;return"a=rtpmap:"+i+" "+t.name+"/"+t.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(t){const i=t.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){const i={};let r;const s=t.substring(t.indexOf(" ")+1).split(";");for(let a=0;a<s.length;a++)r=s[a].trim().split("="),i[r[0].trim()]=r[1];return i},e.writeFmtp=function(t){let i="",r=t.payloadType;if(t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const s=[];Object.keys(t.parameters).forEach(a=>{t.parameters[a]!==void 0?s.push(a+"="+t.parameters[a]):s.push(a)}),i+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return i},e.parseRtcpFb=function(t){const i=t.substring(t.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},e.writeRtcpFb=function(t){let i="",r=t.payloadType;return t.preferredPayloadType!==void 0&&(r=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(s=>{i+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`}),i},e.parseSsrcMedia=function(t){const i=t.indexOf(" "),r={ssrc:parseInt(t.substring(7,i),10)},s=t.indexOf(":",i);return s>-1?(r.attribute=t.substring(i+1,s),r.value=t.substring(s+1)):r.attribute=t.substring(i+1),r},e.parseSsrcGroup=function(t){const i=t.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},e.getMid=function(t){const i=e.matchPrefix(t,"a=mid:")[0];if(i)return i.substring(6)},e.parseFingerprint=function(t){const i=t.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},e.getDtlsParameters=function(t,i){return{role:"auto",fingerprints:e.matchPrefix(t+i,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,i){let r="a=setup:"+i+`\r
`;return t.fingerprints.forEach(s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`}),r},e.parseCryptoLine=function(t){const i=t.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;const i=t.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,i){return e.matchPrefix(t+i,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,i){const r=e.matchPrefix(t+i,"a=ice-ufrag:")[0],s=e.matchPrefix(t+i,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},e.writeIceParameters=function(t){let i="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(i+=`a=ice-lite\r
`),i},e.parseRtpParameters=function(t){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},s=e.splitLines(t)[0].split(" ");i.profile=s[2];for(let o=3;o<s.length;o++){const c=s[o],l=e.matchPrefix(t,"a=rtpmap:"+c+" ")[0];if(l){const u=e.parseRtpMap(l),d=e.matchPrefix(t,"a=fmtp:"+c+" ");switch(u.parameters=d.length?e.parseFmtp(d[0]):{},u.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+c+" ").map(e.parseRtcpFb),i.codecs.push(u),u.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(u.name.toUpperCase());break}}}e.matchPrefix(t,"a=extmap:").forEach(o=>{i.headerExtensions.push(e.parseExtmap(o))});const a=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return i.codecs.forEach(o=>{a.forEach(c=>{o.rtcpFeedback.find(u=>u.type===c.type&&u.parameter===c.parameter)||o.rtcpFeedback.push(c)})}),i},e.writeRtpDescription=function(t,i){let r="";r+="m="+t+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(a=>a.preferredPayloadType!==void 0?a.preferredPayloadType:a.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(a=>{r+=e.writeRtpMap(a),r+=e.writeFmtp(a),r+=e.writeRtcpFb(a)});let s=0;return i.codecs.forEach(a=>{a.maxptime>s&&(s=a.maxptime)}),s>0&&(r+="a=maxptime:"+s+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(a=>{r+=e.writeExtmap(a)}),r},e.parseRtpEncodingParameters=function(t){const i=[],r=e.parseRtpParameters(t),s=r.fecMechanisms.indexOf("RED")!==-1,a=r.fecMechanisms.indexOf("ULPFEC")!==-1,o=e.matchPrefix(t,"a=ssrc:").map(h=>e.parseSsrcMedia(h)).filter(h=>h.attribute==="cname"),c=o.length>0&&o[0].ssrc;let l;const u=e.matchPrefix(t,"a=ssrc-group:FID").map(h=>h.substring(17).split(" ").map(b=>parseInt(b,10)));u.length>0&&u[0].length>1&&u[0][0]===c&&(l=u[0][1]),r.codecs.forEach(h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let p={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&l&&(p.rtx={ssrc:l}),i.push(p),s&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:a?"red+ulpfec":"red"},i.push(p))}}),i.length===0&&c&&i.push({ssrc:c});let d=e.matchPrefix(t,"b=");return d.length&&(d[0].indexOf("b=TIAS:")===0?d=parseInt(d[0].substring(7),10):d[0].indexOf("b=AS:")===0?d=parseInt(d[0].substring(5),10)*1e3*.95-2e3*8:d=void 0,i.forEach(h=>{h.maxBitrate=d})),i},e.parseRtcpParameters=function(t){const i={},r=e.matchPrefix(t,"a=ssrc:").map(o=>e.parseSsrcMedia(o)).filter(o=>o.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const s=e.matchPrefix(t,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=s.length===0;const a=e.matchPrefix(t,"a=rtcp-mux");return i.mux=a.length>0,i},e.writeRtcpParameters=function(t){let i="";return t.reducedSize&&(i+=`a=rtcp-rsize\r
`),t.mux&&(i+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(i+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),i},e.parseMsid=function(t){let i;const r=e.matchPrefix(t,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=e.matchPrefix(t,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="msid");if(s.length>0)return i=s[0].value.split(" "),{stream:i[0],track:i[1]}},e.parseSctpDescription=function(t){const i=e.parseMLine(t),r=e.matchPrefix(t,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const a=e.matchPrefix(t,"a=sctp-port:");if(a.length>0)return{port:parseInt(a[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const o=e.matchPrefix(t,"a=sctpmap:");if(o.length>0){const c=o[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},e.writeSctpDescription=function(t,i){let r=[];return t.protocol!=="DTLS/SCTP"?r=["m="+t.kind+" 9 "+t.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:r=["m="+t.kind+" 9 "+t.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,i,r){let s;const a=i!==void 0?i:2;return t?s=t:s=e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+a+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,i){const r=e.splitLines(t);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return i?e.getDirection(i):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){const r=e.splitLines(t)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},e.parseOLine=function(t){const r=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;const i=e.splitLines(t);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},n.exports=e})(cr)),cr.exports}var ul=Ah(),an=Sh(ul),Dh=Wu({__proto__:null,default:an},[ul]);function ui(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;const e=n.RTCIceCandidate;n.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&(i=JSON.parse(JSON.stringify(i)),i.candidate=i.candidate.substring(2)),i.candidate&&i.candidate.length){const r=new e(i),s=an.parseCandidate(i.candidate);for(const a in s)a in r||Object.defineProperty(r,a,{value:s[a]});return r.toJSON=function(){return{candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex,usernameFragment:r.usernameFragment}},r}return new e(i)},n.RTCIceCandidate.prototype=e.prototype,Xt(n,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new n.RTCIceCandidate(t.candidate),writable:"false"}),t))}function Fr(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||Xt(n,"icecandidate",e=>{if(e.candidate){const t=an.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function di(n,e){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const t=function(o){if(!o||!o.sdp)return!1;const c=an.splitSections(o.sdp);return c.shift(),c.some(l=>{const u=an.parseMLine(l);return u&&u.kind==="application"&&u.protocol.indexOf("SCTP")!==-1})},i=function(o){const c=o.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const l=parseInt(c[1],10);return l!==l?-1:l},r=function(o){let c=65536;return e.browser==="firefox"&&(e.version<57?o===-1?c=16384:c=2147483637:e.version<60?c=e.version===57?65535:65536:c=2147483637),c},s=function(o,c){let l=65536;e.browser==="firefox"&&e.version===57&&(l=65535);const u=an.matchPrefix(o.sdp,"a=max-message-size:");return u.length>0?l=parseInt(u[0].substring(19),10):e.browser==="firefox"&&c!==-1&&(l=2147483637),l},a=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){const c=i(arguments[0]),l=r(c),u=s(arguments[0],c);let d;l===0&&u===0?d=Number.POSITIVE_INFINITY:l===0||u===0?d=Math.max(l,u):d=Math.min(l,u);const h={};Object.defineProperty(h,"maxMessageSize",{get(){return d}}),this._sctp=h}return a.apply(this,arguments)}}function hi(n){if(!(n.RTCPeerConnection&&"createDataChannel"in n.RTCPeerConnection.prototype))return;function e(i,r){const s=i.send;i.send=function(){const o=arguments[0],c=o.length||o.size||o.byteLength;if(i.readyState==="open"&&r.sctp&&c>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(i,arguments)}}const t=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){const r=t.apply(this,arguments);return e(r,this),r},Xt(n,"datachannel",i=>(e(i.channel,i.target),i))}function jr(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;const e=n.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{const i=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const a=new Event("connectionstatechange",r);s.dispatchEvent(a)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function Br(n,e){if(!n.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e._safariVersion>=13.1)return;const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const s=r.sdp.split(`
`).filter(a=>a.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&r instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:r.type,sdp:s}):r.sdp=s}return t.apply(this,arguments)}}function fi(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.addIceCandidate;!t||t.length===0||(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function pi(n,e){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const t=n.RTCPeerConnection.prototype.setLocalDescription;!t||t.length===0||(n.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return t.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?t.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(a=>t.apply(this,[a]))})}var Lh=Object.freeze({__proto__:null,removeExtmapAllowMixed:Br,shimAddIceCandidateNullOrEmpty:fi,shimConnectionState:jr,shimMaxMessageSize:di,shimParameterlessSetLocalDescription:pi,shimRTCIceCandidate:ui,shimRTCIceCandidateRelayProtocol:Fr,shimSendThrowTypeError:hi});function Nh(){let{window:n}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const t=Lc,i=xh(n),r={browserDetails:i,commonShim:Lh,extractVersion:xn,disableLog:Ih,disableWarnings:Oh,sdp:Dh};switch(i.browser){case"chrome":if(!Ro||!Nr||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),r;if(i.version===null)return t("Chrome shim can not determine version, not shimming."),r;t("adapter.js shimming chrome."),r.browserShim=Ro,fi(n,i),pi(n),Uc(n,i),Fc(n),Nr(n,i),jc(n),Wc(n,i),Bc(n),Vc(n),Hc(n,i),ui(n),Fr(n),jr(n),di(n,i),hi(n),Br(n,i);break;case"firefox":if(!_o||!Ur||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),r;t("adapter.js shimming firefox."),r.browserShim=_o,fi(n,i),pi(n),Kc(n,i),Ur(n,i),zc(n),Jc(n),Gc(n),$c(n),Yc(n),Qc(n),Xc(n),Zc(n),el(n),ui(n),jr(n),di(n,i),hi(n);break;case"safari":if(!Io||!e.shimSafari)return t("Safari shim is not included in this adapter release."),r;t("adapter.js shimming safari."),r.browserShim=Io,fi(n,i),pi(n),ol(n),cl(n),il(n),tl(n),nl(n),al(n),rl(n),ll(n),ui(n),Fr(n),di(n,i),hi(n),Br(n,i);break;default:t("Unsupported browser!");break}return r}Nh({window:typeof window>"u"?void 0:window});class Le extends Promise{constructor(e){super(e)}catch(e){return super.catch(e)}static reject(e){return super.reject(e)}static all(e){return super.all(e)}static race(e){return super.race(e)}}const Uh=/version\/(\d+(\.?_?\d+)+)/i;let lr;function Me(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const t=navigator.userAgent.toLowerCase();if(lr===void 0||e){const i=Fh.find(r=>{let{test:s}=r;return s.test(t)});lr=i?.describe(t)}return lr}const Fh=[{test:/firefox|iceweasel|fxios/i,describe(n){return{name:"Firefox",version:mi(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:ur(n)}}},{test:/chrom|crios|crmo/i,describe(n){return{name:"Chrome",version:mi(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("crios")?"iOS":void 0,osVersion:ur(n)}}},{test:/safari|applewebkit/i,describe(n){return{name:"Safari",version:mi(Uh,n),os:n.includes("mobile/")?"iOS":"macOS",osVersion:ur(n)}}}];function mi(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const i=e.match(n);return i&&i.length>=t&&i[t]||""}function ur(n){return n.includes("mac os")?mi(/\(.+?(\d+_\d+(:?_\d+)?)/,n,1).replace(/_/g,"."):void 0}var jh="2.17.0";const Bh=jh,Vh=16;class ht extends Error{constructor(e,t){super(t||"an error has occured"),this.name="LiveKitError",this.code=e}}var oe;(function(n){n[n.NotAllowed=0]="NotAllowed",n[n.ServerUnreachable=1]="ServerUnreachable",n[n.InternalError=2]="InternalError",n[n.Cancelled=3]="Cancelled",n[n.LeaveRequest=4]="LeaveRequest",n[n.Timeout=5]="Timeout",n[n.WebSocket=6]="WebSocket",n[n.ServiceNotFound=7]="ServiceNotFound"})(oe||(oe={}));class B extends ht{constructor(e,t,i,r){super(1,e),this.name="ConnectionError",this.status=i,this.reason=t,this.context=r,this.reasonName=oe[t]}static notAllowed(e,t,i){return new B(e,oe.NotAllowed,t,i)}static timeout(e){return new B(e,oe.Timeout)}static leaveRequest(e,t){return new B(e,oe.LeaveRequest,void 0,t)}static internal(e,t){return new B(e,oe.InternalError,void 0,t)}static cancelled(e){return new B(e,oe.Cancelled)}static serverUnreachable(e,t){return new B(e,oe.ServerUnreachable,t)}static websocket(e,t,i){return new B(e,oe.WebSocket,t,i)}static serviceNotFound(e,t){return new B(e,oe.ServiceNotFound,void 0,t)}}class ws extends ht{constructor(e){super(21,e??"device is unsupported"),this.name="DeviceUnsupportedError"}}class St extends ht{constructor(e){super(20,e??"track is invalid"),this.name="TrackInvalidError"}}class qh extends ht{constructor(e){super(10,e??"unsupported server"),this.name="UnsupportedServer"}}class he extends ht{constructor(e){super(12,e??"unexpected connection state"),this.name="UnexpectedConnectionState"}}class cn extends ht{constructor(e){super(13,e??"unable to negotiate"),this.name="NegotiationError"}}class xo extends ht{constructor(e,t){super(15,e),this.name="PublishTrackError",this.status=t}}class Mo extends ht{constructor(e,t){super(15,e),this.name="SignalRequestError",this.reason=t,this.reasonName=typeof t=="string"?t:Cs[t]}}var Ie;(function(n){n[n.AlreadyOpened=0]="AlreadyOpened",n[n.AbnormalEnd=1]="AbnormalEnd",n[n.DecodeFailed=2]="DecodeFailed",n[n.LengthExceeded=3]="LengthExceeded",n[n.Incomplete=4]="Incomplete",n[n.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered",n[n.EncryptionTypeMismatch=8]="EncryptionTypeMismatch"})(Ie||(Ie={}));class qe extends ht{constructor(e,t){super(16,e),this.name="DataStreamError",this.reason=t,this.reasonName=Ie[t]}}class en extends ht{constructor(e){super(18,e),this.name="SignalReconnectError"}}var jn;(function(n){n.PermissionDenied="PermissionDenied",n.NotFound="NotFound",n.DeviceInUse="DeviceInUse",n.Other="Other"})(jn||(jn={}));(function(n){function e(t){if(t&&"name"in t)return t.name==="NotFoundError"||t.name==="DevicesNotFoundError"?n.NotFound:t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?n.PermissionDenied:t.name==="NotReadableError"||t.name==="TrackStartError"?n.DeviceInUse:n.Other}n.getFailure=e})(jn||(jn={}));class Pe{}Pe.setTimeout=function(){return setTimeout(...arguments)};Pe.setInterval=function(){return setInterval(...arguments)};Pe.clearTimeout=function(){return clearTimeout(...arguments)};Pe.clearInterval=function(){return clearInterval(...arguments)};var I;(function(n){n.Connected="connected",n.Reconnecting="reconnecting",n.SignalReconnecting="signalReconnecting",n.Reconnected="reconnected",n.Disconnected="disconnected",n.ConnectionStateChanged="connectionStateChanged",n.Moved="moved",n.MediaDevicesChanged="mediaDevicesChanged",n.ParticipantConnected="participantConnected",n.ParticipantDisconnected="participantDisconnected",n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalAudioSilenceDetected="localAudioSilenceDetected",n.ActiveSpeakersChanged="activeSpeakersChanged",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.ParticipantAttributesChanged="participantAttributesChanged",n.ParticipantActive="participantActive",n.RoomMetadataChanged="roomMetadataChanged",n.DataReceived="dataReceived",n.SipDTMFReceived="sipDTMFReceived",n.TranscriptionReceived="transcriptionReceived",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.AudioPlaybackStatusChanged="audioPlaybackChanged",n.VideoPlaybackStatusChanged="videoPlaybackChanged",n.MediaDevicesError="mediaDevicesError",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.SignalConnected="signalConnected",n.RecordingStatusChanged="recordingStatusChanged",n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ActiveDeviceChanged="activeDeviceChanged",n.ChatMessage="chatMessage",n.LocalTrackSubscribed="localTrackSubscribed",n.MetricsReceived="metricsReceived"})(I||(I={}));var A;(function(n){n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalTrackCpuConstrained="localTrackCpuConstrained",n.LocalSenderCreated="localSenderCreated",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.DataReceived="dataReceived",n.SipDTMFReceived="sipDTMFReceived",n.TranscriptionReceived="transcriptionReceived",n.IsSpeakingChanged="isSpeakingChanged",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.TrackCpuConstrained="trackCpuConstrained",n.MediaDevicesError="mediaDevicesError",n.AudioStreamAcquired="audioStreamAcquired",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.PCTrackAdded="pcTrackAdded",n.AttributesChanged="attributesChanged",n.LocalTrackSubscribed="localTrackSubscribed",n.ChatMessage="chatMessage",n.Active="active"})(A||(A={}));var F;(function(n){n.TransportsCreated="transportsCreated",n.Connected="connected",n.Disconnected="disconnected",n.Resuming="resuming",n.Resumed="resumed",n.Restarting="restarting",n.Restarted="restarted",n.SignalResumed="signalResumed",n.SignalRestarted="signalRestarted",n.Closing="closing",n.MediaTrackAdded="mediaTrackAdded",n.ActiveSpeakersUpdate="activeSpeakersUpdate",n.DataPacketReceived="dataPacketReceived",n.RTPVideoMapUpdate="rtpVideoMapUpdate",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ParticipantUpdate="participantUpdate",n.RoomUpdate="roomUpdate",n.SpeakersChanged="speakersChanged",n.StreamStateChanged="streamStateChanged",n.ConnectionQualityUpdate="connectionQualityUpdate",n.SubscriptionError="subscriptionError",n.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",n.RemoteMute="remoteMute",n.SubscribedQualityUpdate="subscribedQualityUpdate",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalTrackSubscribed="localTrackSubscribed",n.Offline="offline",n.SignalRequestResponse="signalRequestResponse",n.SignalConnected="signalConnected",n.RoomMoved="roomMoved"})(F||(F={}));var U;(function(n){n.Message="message",n.Muted="muted",n.Unmuted="unmuted",n.Restarted="restarted",n.Ended="ended",n.Subscribed="subscribed",n.Unsubscribed="unsubscribed",n.CpuConstrained="cpuConstrained",n.UpdateSettings="updateSettings",n.UpdateSubscription="updateSubscription",n.AudioPlaybackStarted="audioPlaybackStarted",n.AudioPlaybackFailed="audioPlaybackFailed",n.AudioSilenceDetected="audioSilenceDetected",n.VisibilityChanged="visibilityChanged",n.VideoDimensionsChanged="videoDimensionsChanged",n.VideoPlaybackStarted="videoPlaybackStarted",n.VideoPlaybackFailed="videoPlaybackFailed",n.ElementAttached="elementAttached",n.ElementDetached="elementDetached",n.UpstreamPaused="upstreamPaused",n.UpstreamResumed="upstreamResumed",n.SubscriptionPermissionChanged="subscriptionPermissionChanged",n.SubscriptionStatusChanged="subscriptionStatusChanged",n.SubscriptionFailed="subscriptionFailed",n.TrackProcessorUpdate="trackProcessorUpdate",n.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",n.TranscriptionReceived="transcriptionReceived",n.TimeSyncUpdate="timeSyncUpdate",n.PreConnectBufferFlushed="preConnectBufferFlushed"})(U||(U={}));function Wh(n){return typeof n>"u"?n:typeof structuredClone=="function"?typeof n=="object"&&n!==null?structuredClone(Object.assign({},n)):structuredClone(n):JSON.parse(JSON.stringify(n))}class ie{constructor(e,t,i,r,s){if(typeof e=="object")this.width=e.width,this.height=e.height,this.aspectRatio=e.aspectRatio,this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority};else if(t!==void 0&&i!==void 0)this.width=e,this.height=t,this.aspectRatio=e/t,this.encoding={maxBitrate:i,maxFramerate:r,priority:s};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const Hh=["vp8","h264"],Kh=["vp8","h264","vp9","av1","h265"];function zh(n){return!!Hh.find(e=>e===n)}const Gh=zh;var Ao;(function(n){n[n.PREFER_REGRESSION=0]="PREFER_REGRESSION",n[n.SIMULCAST=1]="SIMULCAST",n[n.REGRESSION=2]="REGRESSION"})(Ao||(Ao={}));var Vr;(function(n){n.telephone={maxBitrate:12e3},n.speech={maxBitrate:24e3},n.music={maxBitrate:48e3},n.musicStereo={maxBitrate:64e3},n.musicHighQuality={maxBitrate:96e3},n.musicHighQualityStereo={maxBitrate:128e3}})(Vr||(Vr={}));const Bn={h90:new ie(160,90,9e4,20),h180:new ie(320,180,16e4,20),h216:new ie(384,216,18e4,20),h360:new ie(640,360,45e4,20),h540:new ie(960,540,8e5,25),h720:new ie(1280,720,17e5,30),h1080:new ie(1920,1080,3e6,30),h1440:new ie(2560,1440,5e6,30),h2160:new ie(3840,2160,8e6,30)},qr={h120:new ie(160,120,7e4,20),h180:new ie(240,180,125e3,20),h240:new ie(320,240,14e4,20),h360:new ie(480,360,33e4,20),h480:new ie(640,480,5e5,20),h540:new ie(720,540,6e5,25),h720:new ie(960,720,13e5,30),h1080:new ie(1440,1080,23e5,30),h1440:new ie(1920,1440,38e5,30)},Ps={h360fps3:new ie(640,360,2e5,3,"medium"),h360fps15:new ie(640,360,4e5,15,"medium"),h720fps5:new ie(1280,720,8e5,5,"medium"),h720fps15:new ie(1280,720,15e5,15,"medium"),h720fps30:new ie(1280,720,2e6,30,"medium"),h1080fps15:new ie(1920,1080,25e5,15,"medium"),h1080fps30:new ie(1920,1080,5e6,30,"medium"),original:new ie(0,0,7e6,30,"medium")};function dl(n,e,t){var i,r,s,a;const{optionsWithoutProcessor:o,audioProcessor:c,videoProcessor:l}=pl(n??{}),u=e?.processor,d=t?.processor,h=o??{};return h.audio===!0&&(h.audio={}),h.video===!0&&(h.video={}),h.audio&&(Wr(h.audio,e),(i=(s=h.audio).deviceId)!==null&&i!==void 0||(s.deviceId={ideal:"default"}),(c||u)&&(h.audio.processor=c??u)),h.video&&(Wr(h.video,t),(r=(a=h.video).deviceId)!==null&&r!==void 0||(a.deviceId={ideal:"default"}),(l||d)&&(h.video.processor=l??d)),h}function Wr(n,e){return Object.keys(e).forEach(t=>{n[t]===void 0&&(n[t]=e[t])}),n}function Rs(n){var e,t,i,r;const s={};if(n.video)if(typeof n.video=="object"){const a={},o=a,c=n.video;Object.keys(c).forEach(l=>{switch(l){case"resolution":Wr(o,c.resolution);break;default:o[l]=c[l]}}),s.video=a,(e=(i=s.video).deviceId)!==null&&e!==void 0||(i.deviceId={ideal:"default"})}else s.video=n.video?{deviceId:{ideal:"default"}}:!1;else s.video=!1;return n.audio?typeof n.audio=="object"?(s.audio=n.audio,(t=(r=s.audio).deviceId)!==null&&t!==void 0||(r.deviceId={ideal:"default"})):s.audio={deviceId:{ideal:"default"}}:s.audio=!1,s}function hl(n){return S(this,arguments,void 0,function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return(function*(){const i=fl();if(i){const r=i.createAnalyser();r.fftSize=2048;const s=r.frequencyBinCount,a=new Uint8Array(s);i.createMediaStreamSource(new MediaStream([e.mediaStreamTrack])).connect(r),yield Re(t),r.getByteTimeDomainData(a);const c=a.some(l=>l!==128&&l!==0);return i.close(),!c}return!1})()})}function fl(){var n;const e=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(e){const t=new e({latencyHint:"interactive"});if(t.state==="suspended"&&typeof window<"u"&&(!((n=window.document)===null||n===void 0)&&n.body)){const i=()=>S(this,void 0,void 0,function*(){var r;try{t.state==="suspended"&&(yield t.resume())}catch(s){console.warn("Error trying to auto-resume audio context",s)}finally{(r=window.document.body)===null||r===void 0||r.removeEventListener("click",i)}});t.addEventListener("statechange",()=>{var r;t.state==="closed"&&((r=window.document.body)===null||r===void 0||r.removeEventListener("click",i))}),window.document.body.addEventListener("click",i)}return t}}function $h(n){return n==="audioinput"?P.Source.Microphone:n==="videoinput"?P.Source.Camera:P.Source.Unknown}function Hr(n){return n===P.Source.Microphone?"audioinput":n===P.Source.Camera?"videoinput":void 0}function Jh(n){var e,t;let i=(e=n.video)!==null&&e!==void 0?e:!0;return n.resolution&&n.resolution.width>0&&n.resolution.height>0&&(i=typeof i=="boolean"?{}:i,$t()?i=Object.assign(Object.assign({},i),{width:{max:n.resolution.width},height:{max:n.resolution.height},frameRate:n.resolution.frameRate}):i=Object.assign(Object.assign({},i),{width:{ideal:n.resolution.width},height:{ideal:n.resolution.height},frameRate:n.resolution.frameRate})),{audio:(t=n.audio)!==null&&t!==void 0?t:!1,video:i,controller:n.controller,selfBrowserSurface:n.selfBrowserSurface,surfaceSwitching:n.surfaceSwitching,systemAudio:n.systemAudio,preferCurrentTab:n.preferCurrentTab}}function Dn(n){return n.split("/")[1].toLowerCase()}function Yh(n){const e=[];return n.forEach(t=>{t.track!==void 0&&e.push(new bs({cid:t.track.mediaStreamID,track:t.trackInfo}))}),e}function J(n){return"mediaStreamTrack"in n?{trackID:n.sid,source:n.source,muted:n.isMuted,enabled:n.mediaStreamTrack.enabled,kind:n.kind,streamID:n.mediaStreamID,streamTrackID:n.mediaStreamTrack.id}:{trackID:n.trackSid,enabled:n.isEnabled,muted:n.isMuted,trackInfo:Object.assign({mimeType:n.mimeType,name:n.trackName,encrypted:n.isEncrypted,kind:n.kind,source:n.source},n.track?J(n.track):{})}}function Qh(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function Xh(n,e){var t;n===void 0&&(n={}),e===void 0&&(e={});const i=[...Object.keys(e),...Object.keys(n)],r={};for(const s of i)n[s]!==e[s]&&(r[s]=(t=e[s])!==null&&t!==void 0?t:"");return r}function pl(n){const e=Object.assign({},n);let t,i;return typeof e.audio=="object"&&e.audio.processor&&(t=e.audio.processor,e.audio=Object.assign(Object.assign({},e.audio),{processor:void 0})),typeof e.video=="object"&&e.video.processor&&(i=e.video.processor,e.video=Object.assign(Object.assign({},e.video),{processor:void 0})),{audioProcessor:t,videoProcessor:i,optionsWithoutProcessor:Wh(e)}}function Zh(n){switch(n){case me.CAMERA:return P.Source.Camera;case me.MICROPHONE:return P.Source.Microphone;case me.SCREEN_SHARE:return P.Source.ScreenShare;case me.SCREEN_SHARE_AUDIO:return P.Source.ScreenShareAudio;default:return P.Source.Unknown}}function Do(n,e){return n.width*n.height<e.width*e.height}function ef(n,e){var t;return(t=n.layers)===null||t===void 0?void 0:t.find(i=>i.quality===e)}const tf=5e3,En=[];var je;(function(n){n[n.LOW=0]="LOW",n[n.MEDIUM=1]="MEDIUM",n[n.HIGH=2]="HIGH"})(je||(je={}));class P extends dt.EventEmitter{get streamState(){return this._streamState}setStreamState(e){this._streamState=e}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var r;super(),this.attachedElements=[],this.isMuted=!1,this._streamState=P.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=K,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),tf):this.handleAppVisibilityChanged()},this.log=Tt((r=i.loggerName)!==null&&r!==void 0?r:Qe.Track),this.loggerContextCb=i.loggerContextCb,this.setMaxListeners(100),this.kind=t,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=P.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),J(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===P.Kind.Video&&(t="video"),this.attachedElements.length===0&&this.kind===P.Kind.Video&&this.addAppVisibilityListener(),e||(t==="audio"&&(En.forEach(s=>{s.parentElement===null&&!e&&(e=s)}),e&&En.splice(En.indexOf(e),1)),e||(e=document.createElement(t))),this.attachedElements.includes(e)||this.attachedElements.push(e),nn(this.mediaStreamTrack,e);const i=e.srcObject.getTracks(),r=i.some(s=>s.kind==="audio");return e.play().then(()=>{this.emit(r?U.AudioPlaybackStarted:U.VideoPlaybackStarted)}).catch(s=>{s.name==="NotAllowedError"?this.emit(r?U.AudioPlaybackFailed:U.VideoPlaybackFailed,s):s.name==="AbortError"?K.debug("".concat(r?"audio":"video"," playback aborted, likely due to new play request")):K.warn("could not playback ".concat(r?"audio":"video"),s),r&&e&&i.some(a=>a.kind==="video")&&s.name==="NotAllowedError"&&(e.muted=!0,e.play().catch(()=>{}))}),this.emit(U.ElementAttached,e),e}detach(e){try{if(e){ln(this.mediaStreamTrack,e);const i=this.attachedElements.indexOf(e);return i>=0&&(this.attachedElements.splice(i,1),this.recycleElement(e),this.emit(U.ElementDetached,e)),e}const t=[];return this.attachedElements.forEach(i=>{ln(this.mediaStreamTrack,i),t.push(i),this.recycleElement(i),this.emit(U.ElementDetached,i)}),this.attachedElements=[],t}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=Tt(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=!0;e.pause(),En.forEach(i=>{i.parentElement||(t=!1)}),t&&En.push(e)}}handleAppVisibilityChanged(){return S(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===P.Kind.Video&&setTimeout(()=>this.attachedElements.forEach(e=>e.play().catch(()=>{})),0)})}addAppVisibilityListener(){Ne()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){Ne()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function nn(n,e){let t;e.srcObject instanceof MediaStream?t=e.srcObject:t=new MediaStream;let i;n.kind==="audio"?i=t.getAudioTracks():i=t.getVideoTracks(),i.includes(n)||(i.forEach(r=>{t.removeTrack(r)}),t.addTrack(n)),(!$t()||!(e instanceof HTMLVideoElement))&&(e.autoplay=!0),e.muted=t.getAudioTracks().length===0,e instanceof HTMLVideoElement&&(e.playsInline=!0),e.srcObject!==t&&(e.srcObject=t,($t()||Gt())&&e instanceof HTMLVideoElement&&setTimeout(()=>{e.srcObject=t,e.play().catch(()=>{})},0))}function ln(n,e){if(e.srcObject instanceof MediaStream){const t=e.srcObject;t.removeTrack(n),t.getTracks().length>0?e.srcObject=t:e.srcObject=null}}(function(n){let e;(function(l){l.Audio="audio",l.Video="video",l.Unknown="unknown"})(e=n.Kind||(n.Kind={}));let t;(function(l){l.Camera="camera",l.Microphone="microphone",l.ScreenShare="screen_share",l.ScreenShareAudio="screen_share_audio",l.Unknown="unknown"})(t=n.Source||(n.Source={}));let i;(function(l){l.Active="active",l.Paused="paused",l.Unknown="unknown"})(i=n.StreamState||(n.StreamState={}));function r(l){switch(l){case e.Audio:return ze.AUDIO;case e.Video:return ze.VIDEO;default:return ze.DATA}}n.kindToProto=r;function s(l){switch(l){case ze.AUDIO:return e.Audio;case ze.VIDEO:return e.Video;default:return e.Unknown}}n.kindFromProto=s;function a(l){switch(l){case t.Camera:return me.CAMERA;case t.Microphone:return me.MICROPHONE;case t.ScreenShare:return me.SCREEN_SHARE;case t.ScreenShareAudio:return me.SCREEN_SHARE_AUDIO;default:return me.UNKNOWN}}n.sourceToProto=a;function o(l){switch(l){case me.CAMERA:return t.Camera;case me.MICROPHONE:return t.Microphone;case me.SCREEN_SHARE:return t.ScreenShare;case me.SCREEN_SHARE_AUDIO:return t.ScreenShareAudio;default:return t.Unknown}}n.sourceFromProto=o;function c(l){switch(l){case Mr.ACTIVE:return i.Active;case Mr.PAUSED:return i.Paused;default:return i.Unknown}}n.streamStateFromProto=c})(P||(P={}));const nf="|",Lo="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function rf(n){const e=n.split(nf);return e.length>1?[e[0],n.substr(e[0].length+1)]:[n,""]}function Re(n){return new Le(e=>Pe.setTimeout(e,n))}function Kr(){return"addTransceiver"in RTCPeerConnection.prototype}function zr(){return"addTrack"in RTCPeerConnection.prototype}function sf(){if(!("getCapabilities"in RTCRtpSender)||$t()||Gt())return!1;const n=RTCRtpSender.getCapabilities("video");let e=!1;if(n){for(const t of n.codecs)if(t.mimeType.toLowerCase()==="video/av1"){e=!0;break}}return e}function of(){if(!("getCapabilities"in RTCRtpSender)||Gt())return!1;if($t()){const t=Me();if(t?.version&&Xe(t.version,"16")<0||t?.os==="iOS"&&t?.osVersion&&Xe(t.osVersion,"16")<0)return!1}const n=RTCRtpSender.getCapabilities("video");let e=!1;if(n){for(const t of n.codecs)if(t.mimeType.toLowerCase()==="video/vp9"){e=!0;break}}return e}function $e(n){return n==="av1"||n==="vp9"}function Gr(n){return!document||Vn()?!1:(n||(n=document.createElement("audio")),"setSinkId"in n)}function af(){return typeof RTCPeerConnection>"u"?!1:Kr()||zr()}function Gt(){var n;return((n=Me())===null||n===void 0?void 0:n.name)==="Firefox"}function No(){const n=Me();return!!n&&n.name==="Chrome"&&n.os!=="iOS"}function $t(){var n;return((n=Me())===null||n===void 0?void 0:n.name)==="Safari"}function Vn(){const n=Me();return n?.name==="Safari"||n?.os==="iOS"}function cf(){const n=Me();return n?.name==="Safari"&&n.version.startsWith("17.")||n?.os==="iOS"&&!!n?.osVersion&&Xe(n.osVersion,"17")>=0}function lf(n){return n||(n=Me()),n?.name==="Safari"&&Xe(n.version,"18.3")>0||n?.os==="iOS"&&!!n?.osVersion&&Xe(n.osVersion,"18.3")>0}function ml(){var n,e;return Ne()?(e=(n=navigator.userAgentData)===null||n===void 0?void 0:n.mobile)!==null&&e!==void 0?e:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function uf(){const n=Me(),e="17.2";if(n)return n.name!=="Safari"&&n.os!=="iOS"||n.os==="iOS"&&n.osVersion&&Xe(n.osVersion,e)>=0?!0:n.name==="Safari"&&Xe(n.version,e)>=0}function Ne(){return typeof document<"u"}function lt(){return navigator.product=="ReactNative"}function mn(n){return n.hostname.endsWith(".livekit.cloud")||n.hostname.endsWith(".livekit.run")}function dr(n){return mn(n)?n.hostname.split(".")[0]:null}function gl(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function vl(){if(!lt())return;let n=gl();if(n)return n.platform}function Uo(){if(Ne())return window.devicePixelRatio;if(lt()){let n=gl();if(n)return n.devicePixelRatio}return 1}function Xe(n,e){const t=n.split("."),i=e.split("."),r=Math.min(t.length,i.length);for(let s=0;s<r;++s){const a=parseInt(t[s],10),o=parseInt(i[s],10);if(a>o)return 1;if(a<o)return-1;if(s===r-1&&a===o)return 0}return n===""&&e!==""?-1:e===""?1:t.length==i.length?0:t.length<i.length?-1:1}function df(n){for(const e of n)e.target.handleResize(e)}function hf(n){for(const e of n)e.target.handleVisibilityChanged(e)}let hr=null;const Fo=()=>(hr||(hr=new ResizeObserver(df)),hr);let fr=null;const jo=()=>(fr||(fr=new IntersectionObserver(hf,{root:null,rootMargin:"0px"})),fr);function ff(){var n;const e=new vc({sdk:bc.JS,protocol:Vh,version:Bh});return lt()&&(e.os=(n=vl())!==null&&n!==void 0?n:""),e}function Bo(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const r=document.createElement("canvas");r.width=n,r.height=e;const s=r.getContext("2d");s?.fillRect(0,0,r.width,r.height),i&&s&&(s.beginPath(),s.arc(n/2,e/2,50,0,Math.PI*2,!0),s.closePath(),s.fillStyle="grey",s.fill());const a=r.captureStream(),[o]=a.getTracks();if(!o)throw Error("Could not get empty media stream video track");return o.enabled=t,o}let wn;function pr(){if(!wn){const n=new AudioContext,e=n.createOscillator(),t=n.createGain();t.gain.setValueAtTime(0,0);const i=n.createMediaStreamDestination();if(e.connect(t),t.connect(i),e.start(),[wn]=i.stream.getAudioTracks(),!wn)throw Error("Could not get empty media stream audio track");wn.enabled=!1}return wn.clone()}class We{get isResolved(){return this._isResolved}constructor(e,t){this._isResolved=!1,this.onFinally=t,this.promise=new Promise((i,r)=>S(this,void 0,void 0,function*(){this.resolve=i,this.reject=r,e&&(yield e(i,r))})).finally(()=>{var i;this._isResolved=!0,(i=this.onFinally)===null||i===void 0||i.call(this)})}}function pf(n){return Kh.includes(n)}function Dt(n){if(typeof n=="string"||typeof n=="number")return n;if(Array.isArray(n))return n[0];if(n.exact!==void 0)return Array.isArray(n.exact)?n.exact[0]:n.exact;if(n.ideal!==void 0)return Array.isArray(n.ideal)?n.ideal[0]:n.ideal;throw Error("could not unwrap constraint")}function mf(n){return n.startsWith("http")?n.replace(/^(http)/,"ws"):n}function qn(n){return n.startsWith("ws")?n.replace(/^(ws)/,"http"):n}function gf(n,e){return n.segments.map(t=>{let{id:i,text:r,language:s,startTime:a,endTime:o,final:c}=t;var l;const u=(l=e.get(i))!==null&&l!==void 0?l:Date.now(),d=Date.now();return c?e.delete(i):e.set(i,u),{id:i,text:r,startTime:Number.parseInt(a.toString()),endTime:Number.parseInt(o.toString()),final:c,language:s,firstReceivedTime:u,lastReceivedTime:d}})}function vf(n){const{id:e,timestamp:t,message:i,editTimestamp:r}=n;return{id:e,timestamp:Number.parseInt(t.toString()),editTimestamp:r?Number.parseInt(r.toString()):void 0,message:i}}function Vo(n){switch(n.reason){case oe.LeaveRequest:return n.context;case oe.Cancelled:return Ye.CLIENT_INITIATED;case oe.NotAllowed:return Ye.USER_REJECTED;case oe.ServerUnreachable:return Ye.JOIN_FAILURE;default:return Ye.UNKNOWN_REASON}}function gi(n){return n!==void 0?Number(n):void 0}function Wt(n){return n!==void 0?BigInt(n):void 0}function Ht(n){return!!n&&!(n instanceof MediaStreamTrack)&&n.isLocal}function at(n){return!!n&&n.kind==P.Kind.Audio}function Bt(n){return!!n&&n.kind==P.Kind.Video}function _t(n){return Ht(n)&&Bt(n)}function gt(n){return Ht(n)&&at(n)}function $r(n){return!!n&&!n.isLocal}function bf(n){return!!n&&!n.isLocal}function mr(n){return $r(n)&&Bt(n)}function yf(n){return n.isLocal}function kf(n,e){const t=[];let i=new TextEncoder().encode(n);for(;i.length>e;){let r=e;for(;r>0;){const s=i[r];if(s!==void 0&&(s&192)!==128)break;r--}t.push(i.slice(0,r)),i=i.slice(r)}return i.length>0&&t.push(i),t}function Sf(n){var e;const t=n.get("Cache-Control");if(t){const i=(e=t.match(/(?:^|[,\s])max-age=(\d+)/))===null||e===void 0?void 0:e[1];if(i)return parseInt(i,10)}}function Tf(n,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;const i=Cf(n,e);return t?i:_s(i,"v1")}function Cf(n,e){const t=new URL(mf(n));return e.forEach((i,r)=>{t.searchParams.set(r,i)}),_s(t,"rtc")}function Ef(n){const e=new URL(qn(n));return _s(e,"validate")}function bl(n){return n.endsWith("/")?n:"".concat(n,"/")}function _s(n,e){return n.pathname="".concat(bl(n.pathname)).concat(e),n}function qo(n){if(typeof n=="string")return ko.fromJson(JSON.parse(n),{ignoreUnknownFields:!0});if(n instanceof ArrayBuffer)return ko.fromBinary(new Uint8Array(n));throw new Error("could not decode websocket message: ".concat(typeof n))}function wf(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"Unknown reason";if(!(n instanceof AbortSignal))return e;const t=n.reason;switch(typeof t){case"string":return t;case"object":return t instanceof Error?t.message:e;default:return"toString"in t?t.toString():e}}const Pf=10,Pn="lk_e2ee",Rf="LKFrameEncryptionKey",_f={sharedKey:!1,ratchetSalt:Rf,ratchetWindowSize:8,failureTolerance:Pf,keyringSize:16};var Lt;(function(n){n.SetKey="setKey",n.RatchetRequest="ratchetRequest",n.KeyRatcheted="keyRatcheted"})(Lt||(Lt={}));var Wo;(function(n){n.KeyRatcheted="keyRatcheted"})(Wo||(Wo={}));var xt;(function(n){n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError"})(xt||(xt={}));var Ho;(function(n){n.Error="cryptorError"})(Ho||(Ho={}));function If(){return Of()||Jr()}function Jr(){return typeof window.RTCRtpScriptTransform<"u"}function Of(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}function xf(n){var e,t,i,r,s;if(((e=n.value)===null||e===void 0?void 0:e.case)!=="sipDtmf"&&((t=n.value)===null||t===void 0?void 0:t.case)!=="metrics"&&((i=n.value)===null||i===void 0?void 0:i.case)!=="speaker"&&((r=n.value)===null||r===void 0?void 0:r.case)!=="transcription"&&((s=n.value)===null||s===void 0?void 0:s.case)!=="encryptedPacket")return new uc({value:n.value})}class by extends dt.EventEmitter{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(t,i,r)=>{K.debug("key ratcheted event received",{ratchetResult:t,participantId:i,keyIndex:r})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},_f),e),this.on(Lt.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey(e,t,i){const r={key:e,participantIdentity:t,keyIndex:i};if(!this.options.sharedKey&&!t)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(t??"shared","-").concat(i??0),r),this.emit(Lt.SetKey,r)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(e,t){this.emit(Lt.RatchetRequest,e,t)}}var Ko;(function(n){n[n.InvalidKey=0]="InvalidKey",n[n.MissingKey=1]="MissingKey",n[n.InternalError=2]="InternalError"})(Ko||(Ko={}));class Mf extends dt.EventEmitter{constructor(e,t){super(),this.decryptDataRequests=new Map,this.encryptDataRequests=new Map,this.onWorkerMessage=i=>{var r,s;const{kind:a,data:o}=i.data;switch(a){case"error":if(K.error(o.error.message),o.uuid){const u=this.decryptDataRequests.get(o.uuid);if(u?.reject){u.reject(o.error);break}const d=this.encryptDataRequests.get(o.uuid);if(d?.reject){d.reject(o.error);break}}this.emit(xt.EncryptionError,o.error,o.participantIdentity);break;case"initAck":o.enabled&&this.keyProvider.getKeys().forEach(u=>{this.postKey(u)});break;case"enable":if(o.enabled&&this.keyProvider.getKeys().forEach(u=>{this.postKey(u)}),this.encryptionEnabled!==o.enabled&&o.participantIdentity===((r=this.room)===null||r===void 0?void 0:r.localParticipant.identity))this.emit(xt.ParticipantEncryptionStatusChanged,o.enabled,this.room.localParticipant),this.encryptionEnabled=o.enabled;else if(o.participantIdentity){const u=(s=this.room)===null||s===void 0?void 0:s.getParticipantByIdentity(o.participantIdentity);if(!u)throw TypeError("couldn't set encryption status, participant not found".concat(o.participantIdentity));this.emit(xt.ParticipantEncryptionStatusChanged,o.enabled,u)}break;case"ratchetKey":this.keyProvider.emit(Lt.KeyRatcheted,o.ratchetResult,o.participantIdentity,o.keyIndex);break;case"decryptDataResponse":const c=this.decryptDataRequests.get(o.uuid);c?.resolve&&c.resolve(o);break;case"encryptDataResponse":const l=this.encryptDataRequests.get(o.uuid);l?.resolve&&l.resolve(o);break}},this.onWorkerError=i=>{K.error("e2ee worker encountered an error:",{error:i.error}),this.emit(xt.EncryptionError,i.error,void 0)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1,this.dataChannelEncryptionEnabled=t}get isEnabled(){return this.encryptionEnabled}get isDataChannelEncryptionEnabled(){return this.isEnabled&&this.dataChannelEncryptionEnabled}setup(e){if(!If())throw new ws("tried to setup end-to-end encryption on an unsupported browser");if(K.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:Eh.getLevel()}};this.worker&&(K.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(t))}}setParticipantCryptorEnabled(e,t){K.debug("set e2ee to ".concat(e," for participant ").concat(t)),this.postEnable(e,t)}setSifTrailer(e){!e||e.length===0?K.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer(e)}setupEngine(e){e.on(F.RTPVideoMapUpdate,t=>{this.postRTPMap(t)})}setupEventListeners(e,t){e.on(I.TrackPublished,(i,r)=>this.setParticipantCryptorEnabled(i.trackInfo.encryption!==be.NONE,r.identity)),e.on(I.ConnectionStateChanged,i=>{i===Z.Connected&&e.remoteParticipants.forEach(r=>{r.trackPublications.forEach(s=>{this.setParticipantCryptorEnabled(s.trackInfo.encryption!==be.NONE,r.identity)})})}).on(I.TrackUnsubscribed,(i,r,s)=>{var a;const o={kind:"removeTransform",data:{participantIdentity:s.identity,trackId:i.mediaStreamID}};(a=this.worker)===null||a===void 0||a.postMessage(o)}).on(I.TrackSubscribed,(i,r,s)=>{this.setupE2EEReceiver(i,s.identity,r.trackInfo)}).on(I.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");t.getKeys().forEach(i=>{this.postKey(i)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),e.localParticipant.on(A.LocalSenderCreated,(i,r)=>S(this,void 0,void 0,function*(){this.setupE2EESender(r,i)})),e.localParticipant.on(A.LocalTrackPublished,i=>{if(!Bt(i.track)||!Vn())return;const r={kind:"updateCodec",data:{trackId:i.track.mediaStreamID,codec:Dn(i.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(r)}),t.on(Lt.SetKey,i=>this.postKey(i)).on(Lt.RatchetRequest,(i,r)=>this.postRatchetRequest(i,r))}encryptData(e){return S(this,void 0,void 0,function*(){if(!this.worker)throw Error("could not encrypt data, worker is missing");const t=crypto.randomUUID(),i={kind:"encryptDataRequest",data:{uuid:t,payload:e,participantIdentity:this.room.localParticipant.identity}},r=new We;return r.onFinally=()=>{this.encryptDataRequests.delete(t)},this.encryptDataRequests.set(t,r),this.worker.postMessage(i),r.promise})}handleEncryptedData(e,t,i,r){if(!this.worker)throw Error("could not handle encrypted data, worker is missing");const s=crypto.randomUUID(),a={kind:"decryptDataRequest",data:{uuid:s,payload:e,iv:t,participantIdentity:i,keyIndex:r}},o=new We;return o.onFinally=()=>{this.decryptDataRequests.delete(s)},this.decryptDataRequests.set(s,o),this.worker.postMessage(a),o.promise}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const i={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(i)}postKey(e){let{key:t,participantIdentity:i,keyIndex:r}=e;var s;if(!this.worker)throw Error("could not set key, worker is missing");const a={kind:"setKey",data:{participantIdentity:i,isPublisher:i===((s=this.room)===null||s===void 0?void 0:s.localParticipant.identity),key:t,keyIndex:r}};this.worker.postMessage(a)}postEnable(e,t){if(this.worker){const i={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(i)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((t=this.room)===null||t===void 0)&&t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const i={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(i)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,i){if(e.receiver){if(!i?.mimeType||i.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,e.kind==="video"?Dn(i.mimeType):void 0)}}setupE2EESender(e,t){if(!Ht(e)||!t){t||K.warn("early return because sender is not ready");return}this.handleSender(t,e.mediaStreamID,void 0)}handleReceiver(e,t,i,r){return S(this,void 0,void 0,function*(){if(this.worker){if(Jr()&&!No()){const s={kind:"decode",participantIdentity:i,trackId:t,codec:r};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{if(Pn in e&&r){const c={kind:"updateCodec",data:{trackId:t,codec:r,participantIdentity:i}};this.worker.postMessage(c);return}let s=e.writableStream,a=e.readableStream;if(!s||!a){const c=e.createEncodedStreams();e.writableStream=c.writable,s=c.writable,e.readableStream=c.readable,a=c.readable}const o={kind:"decode",data:{readableStream:a,writableStream:s,trackId:t,codec:r,participantIdentity:i,isReuse:Pn in e}};this.worker.postMessage(o,[a,s])}e[Pn]=!0}})}handleSender(e,t,i){var r;if(!(Pn in e||!this.worker)){if(!(!((r=this.room)===null||r===void 0)&&r.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(Jr()&&!No()){K.info("initialize script transform");const s={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:i};e.transform=new RTCRtpScriptTransform(this.worker,s)}else{K.info("initialize encoded streams");const s=e.createEncodedStreams(),a={kind:"encode",data:{readableStream:s.readable,writableStream:s.writable,codec:i,trackId:t,participantIdentity:this.room.localParticipant.identity,isReuse:!1}};this.worker.postMessage(a,[s.readable,s.writable])}e[Pn]=!0}}}const Af=500,Df=15e3;class un{constructor(){this.failedConnectionAttempts=new Map,this.backOffPromises=new Map}static getInstance(){return this._instance||(this._instance=new un),this._instance}addFailedConnectionAttempt(e){var t;const i=new URL(e),r=dr(i);if(!r)return;let s=(t=this.failedConnectionAttempts.get(r))!==null&&t!==void 0?t:0;this.failedConnectionAttempts.set(r,s+1),this.backOffPromises.set(r,Re(Math.min(Af*Math.pow(2,s),Df)))}getBackOffPromise(e){const t=new URL(e),i=t&&dr(t);return i&&this.backOffPromises.get(i)||Promise.resolve()}resetFailedConnectionAttempts(e){const t=new URL(e),i=t&&dr(t);i&&(this.failedConnectionAttempts.set(i,0),this.backOffPromises.set(i,Promise.resolve()))}resetAll(){this.backOffPromises.clear(),this.failedConnectionAttempts.clear()}}un._instance=null;const gr="default";class Ce{constructor(){this._previousDevices=[]}static getInstance(){return this.instance===void 0&&(this.instance=new Ce),this.instance}get previousDevices(){return this._previousDevices}getDevices(e){return S(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var s;if(((s=Ce.userMediaPromiseMap)===null||s===void 0?void 0:s.size)>0){K.debug("awaiting getUserMedia promise");try{t?yield Ce.userMediaPromiseMap.get(t):yield Promise.all(Ce.userMediaPromiseMap.values())}catch{K.warn("error waiting for media permissons")}}let a=yield navigator.mediaDevices.enumerateDevices();if(r&&!($t()&&i.hasDeviceInUse(t))&&(a.filter(c=>c.kind===t).length===0||a.some(c=>{const l=c.label==="",u=t?c.kind===t:!0;return l&&u}))){const c={video:t!=="audioinput"&&t!=="audiooutput",audio:t!=="videoinput"&&{deviceId:{ideal:"default"}}},l=yield navigator.mediaDevices.getUserMedia(c);a=yield navigator.mediaDevices.enumerateDevices(),l.getTracks().forEach(u=>{u.stop()})}return i._previousDevices=a,t&&(a=a.filter(o=>o.kind===t)),a})()})}normalizeDeviceId(e,t,i){return S(this,void 0,void 0,function*(){if(t!==gr)return t;const r=yield this.getDevices(e),s=r.find(o=>o.deviceId===gr);if(!s){K.warn("could not reliably determine default device");return}const a=r.find(o=>o.deviceId!==gr&&o.groupId===(i??s.groupId));if(!a){K.warn("could not reliably determine default device");return}return a?.deviceId})}hasDeviceInUse(e){return e?Ce.userMediaPromiseMap.has(e):Ce.userMediaPromiseMap.size>0}}Ce.mediaDeviceKinds=["audioinput","audiooutput","videoinput"];Ce.userMediaPromiseMap=new Map;var Ln;(function(n){n[n.WAITING=0]="WAITING",n[n.RUNNING=1]="RUNNING",n[n.COMPLETED=2]="COMPLETED"})(Ln||(Ln={}));class Lf{constructor(){this.pendingTasks=new Map,this.taskMutex=new xe,this.nextTaskIndex=0}run(e){return S(this,void 0,void 0,function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:Ln.WAITING};this.pendingTasks.set(t.id,t);const i=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=Ln.RUNNING,yield e()}finally{t.status=Ln.COMPLETED,this.pendingTasks.delete(t.id),i()}})}flush(){return S(this,void 0,void 0,function*(){return this.run(()=>S(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}class Nf{get readyState(){return this.ws.readyState}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i,r;if(!((i=t.signal)===null||i===void 0)&&i.aborted)throw new DOMException("This operation was aborted","AbortError");this.url=e;const s=new WebSocket(e,(r=t.protocols)!==null&&r!==void 0?r:[]);s.binaryType="arraybuffer",this.ws=s;const a=function(){let{closeCode:o,reason:c}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return s.close(o,c)};this.opened=new Le((o,c)=>{const l=()=>{c(B.websocket("Encountered websocket error during connection establishment"))};s.onopen=()=>{o({readable:new ReadableStream({start(u){s.onmessage=d=>{let{data:h}=d;return u.enqueue(h)},s.onerror=d=>u.error(d)},cancel:a}),writable:new WritableStream({write(u){s.send(u)},abort(){s.close()},close:a}),protocol:s.protocol,extensions:s.extensions}),s.removeEventListener("error",l)},s.addEventListener("error",l)}),this.closed=new Le((o,c)=>{const l=()=>S(this,void 0,void 0,function*(){const u=new Le(h=>{s.readyState!==WebSocket.CLOSED&&s.addEventListener("close",p=>{h(p)},{once:!0})}),d=yield Le.race([Re(250),u]);d?o(d):c(B.websocket("Encountered unspecified websocket error without a timely close event"))});s.onclose=u=>{let{code:d,reason:h}=u;o({closeCode:d,reason:h}),s.removeEventListener("error",l)},s.addEventListener("error",l)}),t.signal&&(t.signal.onabort=()=>s.close()),this.close=a}}const Uf=["syncState","trickle","offer","answer","simulate","leave"];function Ff(n){const e=Uf.indexOf(n.case)>=0;return K.trace("request allowed to bypass queue:",{canPass:e,req:n}),e}var se;(function(n){n[n.CONNECTING=0]="CONNECTING",n[n.CONNECTED=1]="CONNECTED",n[n.RECONNECTING=2]="RECONNECTING",n[n.DISCONNECTING=3]="DISCONNECTING",n[n.DISCONNECTED=4]="DISCONNECTED"})(se||(se={}));const jf=250;class Is{get currentState(){return this.state}get isDisconnected(){return this.state===se.DISCONNECTING||this.state===se.DISCONNECTED}get isEstablishingConnection(){return this.state===se.CONNECTING||this.state===se.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;this.rtt=0,this.state=se.DISCONNECTED,this.log=K,this._requestId=0,this.useV0SignalPath=!1,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0,this.onMediaSectionsRequirement=void 0},this.log=Tt((i=t.loggerName)!==null&&i!==void 0?i:Qe.Signal),this.loggerContextCb=t.loggerContextCb,this.useJSON=e,this.requestQueue=new Lf,this.queuedRequests=[],this.closingLock=new xe,this.connectionLock=new xe,this.state=se.DISCONNECTED}get logContext(){var e,t;return(t=(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:{}}join(e,t,i,r){return S(this,arguments,void 0,function(s,a,o,c){var l=this;let u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;return(function*(){return l.state=se.CONNECTING,l.options=o,yield l.connect(s,a,o,c,u)})()})}reconnect(e,t,i,r){return S(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=se.RECONNECTING,this.clearPingInterval(),yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:i,reconnectReason:r}),void 0,this.useV0SignalPath)})}connect(e,t,i,r){return S(this,arguments,void 0,function(s,a,o,c){var l=this;let u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;return(function*(){const d=yield l.connectionLock.lock();l.connectOptions=o,l.useV0SignalPath=u;const h=ff(),p=u?Bf(a,h,o):Vf(a,h,o),b=Tf(s,p,u).toString(),m=Ef(b).toString();return new Promise((T,k)=>S(l,void 0,void 0,function*(){var w,M;try{let v=!1;const g=O=>S(this,void 0,void 0,function*(){if(v)return;v=!0;const D=O instanceof Event?O.currentTarget:O,j=wf(D,"Abort handler called");this.streamWriter&&!this.isDisconnected?this.sendLeave().then(()=>this.close(j)).catch(z=>{this.log.error(z),this.close()}):this.close(),y(),k(B.cancelled(j))});c?.addEventListener("abort",g);const y=()=>{clearTimeout(C),c?.removeEventListener("abort",g)},C=setTimeout(()=>{g(B.timeout("room connection has timed out (signal)"))},o.websocketTimeout),x=(O,D)=>{this.handleSignalConnected(O,C,D)},_=new URL(b);_.searchParams.has("access_token")&&_.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(_),Object.assign({reconnect:o.reconnect,reconnectReason:o.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new Nf(b);try{this.ws.closed.then(te=>{var re;this.isEstablishingConnection&&k(B.internal("Websocket got closed during a (re)connection attempt: ".concat(te.reason))),te.closeCode!==1e3&&(this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:te.reason,code:te.closeCode,wasClean:te.closeCode===1e3,state:this.state})),this.state===se.CONNECTED&&this.handleOnClose((re=te.reason)!==null&&re!==void 0?re:"Unexpected WS error"))}).catch(te=>{this.isEstablishingConnection&&k(B.internal("Websocket error during a (re)connection attempt: ".concat(te)))});const O=yield this.ws.opened.catch(te=>S(this,void 0,void 0,function*(){if(this.state!==se.CONNECTED){this.state=se.DISCONNECTED,clearTimeout(C);const re=yield this.handleConnectionError(te,m);k(re);return}this.handleWSError(te),k(te)}));if(clearTimeout(C),!O)return;const D=O.readable.getReader();this.streamWriter=O.writable.getWriter();const j=yield D.read();if(D.releaseLock(),!j.value)throw B.internal("no message received as first message");const z=qo(j.value),ee=this.validateFirstMessage(z,(w=o.reconnect)!==null&&w!==void 0?w:!1);if(!ee.isValid){k(ee.error);return}((M=z.message)===null||M===void 0?void 0:M.case)==="join"&&(this.pingTimeoutDuration=z.message.value.pingTimeout,this.pingIntervalDuration=z.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})));const _e=ee.shouldProcessFirstMessage?z:void 0;x(O,_e),T(ee.response)}catch(O){k(O)}finally{y()}}finally{d()}}))})()})}startReadingLoop(e,t){return S(this,void 0,void 0,function*(){for(t&&this.handleSignalResponse(t);;){this.signalLatency&&(yield Re(this.signalLatency));const{done:i,value:r}=yield e.read();if(i)break;const s=qo(r);this.handleSignalResponse(s)}})}close(){return S(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"Close method called on signal client";return(function*(){if([se.DISCONNECTING||se.DISCONNECTED].includes(e.state)){e.log.debug("ignoring signal close as it's already in disconnecting state");return}const r=yield e.closingLock.lock();try{if(e.clearPingInterval(),t&&(e.state=se.DISCONNECTING),e.ws){e.ws.close({closeCode:1e3,reason:i});const s=e.ws.closed;e.ws=void 0,e.streamWriter=void 0,yield Promise.race([s,Re(jf)])}}catch(s){e.log.debug("websocket error while closing",Object.assign(Object.assign({},e.logContext),{error:s}))}finally{t&&(e.state=se.DISCONNECTED),r()}})()})}sendOffer(e,t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:rn(e,t)})}sendAnswer(e,t){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:rn(e,t)})}sendIceCandidate(e,t){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new Bi({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new Vi({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return S(this,arguments,void 0,function(i,r){var s=this;let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return(function*(){const o=s.getNextRequestId();return yield s.sendRequest({case:"updateMetadata",value:new ks({requestId:o,metadata:i,name:r,attributes:a})}),o})()})}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new wc({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new _c({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:ce.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new xc({timestamp:ce.parse(Date.now()),rtt:ce.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,t){return this.sendRequest({case:"updateAudioTrack",value:new ys({trackSid:e,features:t})})}sendLeave(){return this.sendRequest({case:"leave",value:new Wi({reason:Ye.CLIENT_INITIATED,action:on.DISCONNECT})})}sendRequest(e){return S(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return(function*(){if(!r&&!Ff(t)&&i.state===se.RECONNECTING){i.queuedRequests.push(()=>S(i,void 0,void 0,function*(){yield this.sendRequest(t,!0)}));return}if(r||(yield i.requestQueue.flush()),i.signalLatency&&(yield Re(i.signalLatency)),i.isDisconnected){i.log.debug("skipping signal request (type: ".concat(t.case,") - SignalClient disconnected"));return}if(!i.streamWriter){i.log.error("cannot send signal request before connected, type: ".concat(t?.case),i.logContext);return}const a=new Jd({message:t});try{i.useJSON?yield i.streamWriter.write(a.toJsonString()):yield i.streamWriter.write(a.toBinary())}catch(o){i.log.error("error sending signal message",Object.assign(Object.assign({},i.logContext),{error:o}))}})()})}handleSignalResponse(e){var t,i;const r=e.message;if(r==null){this.log.debug("received unsupported message",this.logContext);return}let s=!1;if(r.case==="answer"){const a=zo(r.value);this.onAnswer&&this.onAnswer(a,r.value.id,r.value.midToTrackId)}else if(r.case==="offer"){const a=zo(r.value);this.onOffer&&this.onOffer(a,r.value.id,r.value.midToTrackId)}else if(r.case==="trickle"){const a=JSON.parse(r.value.candidateInit);this.onTrickle&&this.onTrickle(a,r.value.target)}else r.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((t=r.value.participants)!==null&&t!==void 0?t:[]):r.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(r.value):r.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((i=r.value.speakers)!==null&&i!==void 0?i:[]):r.case==="leave"?this.onLeave&&this.onLeave(r.value):r.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(r.value.sid,r.value.muted):r.case==="roomUpdate"?this.onRoomUpdate&&r.value.room&&this.onRoomUpdate(r.value.room):r.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(r.value):r.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(r.value):r.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(r.value):r.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(r.value):r.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(r.value):r.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(r.value):r.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(r.value):r.case==="pong"||(r.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(r.value.lastPingTimestamp.toString()),this.resetPingTimeout(),s=!0):r.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(r.value):r.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(r.value.trackSid):r.case==="roomMoved"?(this.onTokenRefresh&&this.onTokenRefresh(r.value.token),this.onRoomMoved&&this.onRoomMoved(r.value)):r.case==="mediaSectionsRequirement"?this.onMediaSectionsRequirement&&this.onMediaSectionsRequirement(r.value):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:r.case})));s||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return S(this,void 0,void 0,function*(){if(this.state===se.DISCONNECTED)return;const t=this.onClose;yield this.close(void 0,e),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),t&&t(e)})}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=Pe.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&Pe.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=Pe.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&Pe.clearInterval(this.pingInterval)}handleSignalConnected(e,t,i){this.state=se.CONNECTED,clearTimeout(t),this.startPingInterval(),this.startReadingLoop(e.readable.getReader(),i)}validateFirstMessage(e,t){var i,r,s,a,o;return((i=e.message)===null||i===void 0?void 0:i.case)==="join"?{isValid:!0,response:e.message.value}:this.state===se.RECONNECTING&&((r=e.message)===null||r===void 0?void 0:r.case)!=="leave"?((s=e.message)===null||s===void 0?void 0:s.case)==="reconnect"?{isValid:!0,response:e.message.value}:(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),{isValid:!0,response:void 0,shouldProcessFirstMessage:!0}):this.isEstablishingConnection&&((a=e.message)===null||a===void 0?void 0:a.case)==="leave"?{isValid:!1,error:B.leaveRequest("Received leave request while trying to (re)connect",e.message.value.reason)}:t?{isValid:!1,error:B.internal("Unexpected first message")}:{isValid:!1,error:B.internal("did not receive join response, got ".concat((o=e.message)===null||o===void 0?void 0:o.case," instead"))}}handleConnectionError(e,t){return S(this,void 0,void 0,function*(){try{const i=yield fetch(t);switch(i.status){case 404:return B.serviceNotFound("v1 RTC path not found. Consider upgrading your LiveKit server version","v0-rtc");case 401:case 403:const r=yield i.text();return B.notAllowed(r,i.status);default:break}return e instanceof B?e:B.internal("Encountered unknown websocket error during connection: ".concat(e),{status:i.status,statusText:i.statusText})}catch(i){return i instanceof B?i:B.serverUnreachable(i instanceof Error?i.message:"server was not reachable")}})}}function zo(n){const e={type:"offer",sdp:n.sdp};switch(n.type){case"answer":case"offer":case"pranswer":case"rollback":e.type=n.type;break}return e}function rn(n,e){return new Ft({sdp:n.sdp,type:n.type,id:e})}function Bf(n,e,t){var i;const r=new URLSearchParams;return r.set("access_token",n),t.reconnect&&(r.set("reconnect","1"),t.sid&&r.set("sid",t.sid)),r.set("auto_subscribe",t.autoSubscribe?"1":"0"),r.set("sdk",lt()?"reactnative":"js"),r.set("version",e.version),r.set("protocol",e.protocol.toString()),e.deviceModel&&r.set("device_model",e.deviceModel),e.os&&r.set("os",e.os),e.osVersion&&r.set("os_version",e.osVersion),e.browser&&r.set("browser",e.browser),e.browserVersion&&r.set("browser_version",e.browserVersion),t.adaptiveStream&&r.set("adaptive_stream","1"),t.reconnectReason&&r.set("reconnect_reason",t.reconnectReason.toString()),!((i=navigator.connection)===null||i===void 0)&&i.type&&r.set("network",navigator.connection.type),r}function Vf(n,e,t){const i=new URLSearchParams;i.set("access_token",n);const r=new vh({clientInfo:e,connectionSettings:new Mc({autoSubscribe:!!t.autoSubscribe,adaptiveStream:!!t.adaptiveStream}),reconnect:!!t.reconnect,participantSid:t.sid?t.sid:void 0});t.reconnectReason&&(r.reconnectReason=t.reconnectReason);const s=new bh({joinRequest:r.toBinary()});return i.set("join_request",btoa(new TextDecoder("utf-8").decode(s.toBinary()))),i}class Go{constructor(){this.buffer=[],this._totalSize=0}push(e){this.buffer.push(e),this._totalSize+=e.data.byteLength}pop(){const e=this.buffer.shift();return e&&(this._totalSize-=e.data.byteLength),e}getAll(){return this.buffer.slice()}popToSequence(e){for(;this.buffer.length>0&&this.buffer[0].sequence<=e;)this.pop()}alignBufferedAmount(e){for(;this.buffer.length>0;){const t=this.buffer[0];if(this._totalSize-t.data.byteLength<=e)break;this.pop()}}get length(){return this.buffer.length}}class qf{constructor(e){this._map=new Map,this._lastCleanup=0,this.ttl=e}set(e,t){const i=Date.now();i-this._lastCleanup>this.ttl/2&&this.cleanup();const r=i+this.ttl;return this._map.set(e,{value:t,expiresAt:r}),this}get(e){const t=this._map.get(e);if(t){if(t.expiresAt<Date.now()){this._map.delete(e);return}return t.value}}has(e){const t=this._map.get(e);return t?t.expiresAt<Date.now()?(this._map.delete(e),!1):!0:!1}delete(e){return this._map.delete(e)}clear(){this._map.clear()}cleanup(){const e=Date.now();for(const[t,i]of this._map.entries())i.expiresAt<e&&this._map.delete(t);this._lastCleanup=e}get size(){return this.cleanup(),this._map.size}forEach(e){this.cleanup();for(const[t,i]of this._map.entries())i.expiresAt>=Date.now()&&e(i.value,t,this.asValueMap())}map(e){this.cleanup();const t=[],i=this.asValueMap();for(const[r,s]of i.entries())t.push(e(s,r,i));return t}asValueMap(){const e=new Map;for(const[t,i]of this._map.entries())i.expiresAt>=Date.now()&&e.set(t,i.value);return e}}var He={},vr={},br={exports:{}},$o;function Os(){if($o)return br.exports;$o=1;var n=br.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(n).forEach(function(e){var t=n[e];t.forEach(function(i){i.reg||(i.reg=/(.*)/),i.format||(i.format="%s")})}),br.exports}var Jo;function Wf(){return Jo||(Jo=1,(function(n){var e=function(o){return String(Number(o))===o?Number(o):o},t=function(o,c,l,u){if(u&&!l)c[u]=e(o[1]);else for(var d=0;d<l.length;d+=1)o[d+1]!=null&&(c[l[d]]=e(o[d+1]))},i=function(o,c,l){var u=o.name&&o.names;o.push&&!c[o.push]?c[o.push]=[]:u&&!c[o.name]&&(c[o.name]={});var d=o.push?{}:u?c[o.name]:c;t(l.match(o.reg),d,o.names,o.name),o.push&&c[o.push].push(d)},r=Os(),s=RegExp.prototype.test.bind(/^([a-z])=(.*)/);n.parse=function(o){var c={},l=[],u=c;return o.split(/(\r\n|\r|\n)/).filter(s).forEach(function(d){var h=d[0],p=d.slice(2);h==="m"&&(l.push({rtp:[],fmtp:[]}),u=l[l.length-1]);for(var b=0;b<(r[h]||[]).length;b+=1){var m=r[h][b];if(m.reg.test(p))return i(m,u,p)}}),c.media=l,c};var a=function(o,c){var l=c.split(/=(.+)/,2);return l.length===2?o[l[0]]=e(l[1]):l.length===1&&c.length>1&&(o[l[0]]=void 0),o};n.parseParams=function(o){return o.split(/;\s?/).reduce(a,{})},n.parseFmtpConfig=n.parseParams,n.parsePayloads=function(o){return o.toString().split(" ").map(Number)},n.parseRemoteCandidates=function(o){for(var c=[],l=o.split(" ").map(e),u=0;u<l.length;u+=3)c.push({component:l[u],ip:l[u+1],port:l[u+2]});return c},n.parseImageAttributes=function(o){return o.split(" ").map(function(c){return c.substring(1,c.length-1).split(",").reduce(a,{})})},n.parseSimulcastStreamList=function(o){return o.split(";").map(function(c){return c.split(",").map(function(l){var u,d=!1;return l[0]!=="~"?u=e(l):(u=e(l.substring(1,l.length)),d=!0),{scid:u,paused:d}})})}})(vr)),vr}var yr,Yo;function Hf(){if(Yo)return yr;Yo=1;var n=Os(),e=/%[sdv%]/g,t=function(a){var o=1,c=arguments,l=c.length;return a.replace(e,function(u){if(o>=l)return u;var d=c[o];switch(o+=1,u){case"%%":return"%";case"%s":return String(d);case"%d":return Number(d);case"%v":return""}})},i=function(a,o,c){var l=o.format instanceof Function?o.format(o.push?c:c[o.name]):o.format,u=[a+"="+l];if(o.names)for(var d=0;d<o.names.length;d+=1){var h=o.names[d];o.name?u.push(c[o.name][h]):u.push(c[o.names[d]])}else u.push(c[o.name]);return t.apply(null,u)},r=["v","o","s","i","u","e","p","c","b","t","r","z","a"],s=["i","c","b","a"];return yr=function(a,o){o=o||{},a.version==null&&(a.version=0),a.name==null&&(a.name=" "),a.media.forEach(function(d){d.payloads==null&&(d.payloads="")});var c=o.outerOrder||r,l=o.innerOrder||s,u=[];return c.forEach(function(d){n[d].forEach(function(h){h.name in a&&a[h.name]!=null?u.push(i(d,h,a)):h.push in a&&a[h.push]!=null&&a[h.push].forEach(function(p){u.push(i(d,h,p))})})}),a.media.forEach(function(d){u.push(i("m",n.m[0],d)),l.forEach(function(h){n[h].forEach(function(p){p.name in d&&d[p.name]!=null?u.push(i(h,p,d)):p.push in d&&d[p.push]!=null&&d[p.push].forEach(function(b){u.push(i(h,p,b))})})})}),u.join(`\r
`)+`\r
`},yr}var Qo;function Kf(){if(Qo)return He;Qo=1;var n=Wf(),e=Hf(),t=Os();return He.grammar=t,He.write=e,He.parse=n.parse,He.parseParams=n.parseParams,He.parseFmtpConfig=n.parseFmtpConfig,He.parsePayloads=n.parsePayloads,He.parseRemoteCandidates=n.parseRemoteCandidates,He.parseImageAttributes=n.parseImageAttributes,He.parseSimulcastStreamList=n.parseSimulcastStreamList,He}var It=Kf();function xs(n,e,t){var i,r,s;e===void 0&&(e=50),t===void 0&&(t={});var a=(i=t.isImmediate)!=null&&i,o=(r=t.callback)!=null&&r,c=t.maxWait,l=Date.now(),u=[];function d(){if(c!==void 0){var p=Date.now()-l;if(p+e>=c)return c-p}return e}var h=function(){var p=[].slice.call(arguments),b=this;return new Promise(function(m,T){var k=a&&s===void 0;if(s!==void 0&&clearTimeout(s),s=setTimeout(function(){if(s=void 0,l=Date.now(),!a){var M=n.apply(b,p);o&&o(M),u.forEach(function(v){return(0,v.resolve)(M)}),u=[]}},d()),k){var w=n.apply(b,p);return o&&o(w),m(w)}u.push({resolve:m,reject:T})})};return h.cancel=function(p){s!==void 0&&clearTimeout(s),u.forEach(function(b){return(0,b.reject)(p)}),u=[]},h}const zf=.7,Gf=20,dn={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class Xo extends dt.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;super(),this.log=K,this.ddExtID=0,this.latestOfferId=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=xs(r=>S(this,void 0,void 0,function*(){this.emit(dn.NegotiationStarted);try{yield this.createAndSendOffer()}catch(s){if(r)r(s);else throw s}}),Gf),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=Tt((i=t.loggerName)!==null&&i!==void 0?i:Qe.PCTransport),this.loggerOptions=t,this.config=e,this._pc=this.createPC(),this.offerLock=new xe}createPC(){const e=new RTCPeerConnection(this.config);return e.onicecandidate=t=>{var i;t.candidate&&((i=this.onIceCandidate)===null||i===void 0||i.call(this,t.candidate))},e.onicecandidateerror=t=>{var i;(i=this.onIceCandidateError)===null||i===void 0||i.call(this,t)},e.oniceconnectionstatechange=()=>{var t;(t=this.onIceConnectionStateChange)===null||t===void 0||t.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var t;(t=this.onSignalingStatechange)===null||t===void 0||t.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,e.connectionState)},e.ondatachannel=t=>{var i;(i=this.onDataChannel)===null||i===void 0||i.call(this,t)},e.ontrack=t=>{var i;(i=this.onTrack)===null||i===void 0||i.call(this,t)},e}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(e){return S(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)})}setRemoteDescription(e,t){return S(this,void 0,void 0,function*(){var i;if(e.type==="answer"&&this.latestOfferId>0&&t>0&&t!==this.latestOfferId)return this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:t,latestOfferId:this.latestOfferId})),!1;let r;if(e.type==="offer"){let{stereoMids:s,nackMids:a}=$f(e);this.remoteStereoMids=s,this.remoteNackMids=a}else if(e.type==="answer"){const s=It.parse((i=e.sdp)!==null&&i!==void 0?i:"");s.media.forEach(a=>{const o=Ms(a.mid);a.type==="audio"&&this.trackBitrates.some(c=>{if(!c.transceiver||o!=c.transceiver.mid)return!1;let l=0;if(a.rtp.some(d=>d.codec.toUpperCase()===c.codec.toUpperCase()?(l=d.payload,!0):!1),l===0)return!0;let u=!1;for(const d of a.fmtp)if(d.payload===l){d.config=d.config.split(";").filter(h=>!h.includes("maxaveragebitrate")).join(";"),c.maxbr>0&&(d.config+=";maxaveragebitrate=".concat(c.maxbr*1e3)),u=!0;break}return u||c.maxbr>0&&a.fmtp.push({payload:l,config:"maxaveragebitrate=".concat(c.maxbr*1e3)}),!0})}),r=It.write(s)}return yield this.setMungedSDP(e,r,!0),this.pendingCandidates.forEach(s=>{this.pc.addIceCandidate(s)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):e.type==="answer"&&(this.emit(dn.NegotiationComplete),e.sdp&&It.parse(e.sdp).media.forEach(a=>{a.type==="video"&&this.emit(dn.RTPVideoPayloadTypes,a.rtp)})),!0})}createAndSendOffer(e){return S(this,void 0,void 0,function*(){var t;const i=yield this.offerLock.lock();try{if(this.onOffer===void 0)return;if(e?.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const o=this._pc.remoteDescription;if(e?.iceRestart&&o)yield this._pc.setRemoteDescription(o);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const r=this.latestOfferId+1;this.latestOfferId=r;const s=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:s.sdp},this.logContext));const a=It.parse((t=s.sdp)!==null&&t!==void 0?t:"");if(a.media.forEach(o=>{ea(o),o.type==="audio"?Zo(o,["all"],[]):o.type==="video"&&this.trackBitrates.some(c=>{if(!o.msid||!c.cid||!o.msid.includes(c.cid))return!1;let l=0;if(o.rtp.some(d=>d.codec.toUpperCase()===c.codec.toUpperCase()?(l=d.payload,!0):!1),l===0||($e(c.codec)&&!$t()&&this.ensureVideoDDExtensionForSVC(o,a),!$e(c.codec)))return!0;const u=Math.round(c.maxbr*zf);for(const d of o.fmtp)if(d.payload===l){d.config.includes("x-google-start-bitrate")||(d.config+=";x-google-start-bitrate=".concat(u));break}return!0})}),this.latestOfferId>r){this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:r}));return}yield this.setMungedSDP(s,It.write(a)),this.onOffer(s,this.latestOfferId)}finally{i()}})}createAndSetAnswer(){return S(this,void 0,void 0,function*(){var e;const t=yield this.pc.createAnswer(),i=It.parse((e=t.sdp)!==null&&e!==void 0?e:"");return i.media.forEach(r=>{ea(r),r.type==="audio"&&Zo(r,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(t,It.write(i)),t})}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTransceiverOfKind(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new he("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new he("PC closed, cannot configure");return(t=this._pc)===null||t===void 0?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!(!((e=this._pc)===null||e===void 0)&&e.removeTrack)}removeTrack(e){var t;return(t=this._pc)===null||t===void 0?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.connectionState)!==null&&t!==void 0?t:"closed"}getICEConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.iceConnectionState)!==null&&t!==void 0?t:"closed"}getSignallingState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.signalingState)!==null&&t!==void 0?t:"closed"}getTransceivers(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getTransceivers())!==null&&t!==void 0?t:[]}getSenders(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getSenders())!==null&&t!==void 0?t:[]}getLocalDescription(){var e;return(e=this._pc)===null||e===void 0?void 0:e.localDescription}getRemoteDescription(){var e;return(e=this.pc)===null||e===void 0?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return S(this,void 0,void 0,function*(){var e;if(!this._pc)return;let t="";const i=new Map,r=new Map;if((yield this._pc.getStats()).forEach(o=>{switch(o.type){case"transport":t=o.selectedCandidatePairId;break;case"candidate-pair":t===""&&o.selected&&(t=o.id),i.set(o.id,o);break;case"remote-candidate":r.set(o.id,"".concat(o.address,":").concat(o.port));break}}),t==="")return;const a=(e=i.get(t))===null||e===void 0?void 0:e.remoteCandidateId;if(a!==void 0)return r.get(a)})}setMungedSDP(e,t,i){return S(this,void 0,void 0,function*(){if(t){const r=e.sdp;e.sdp=t;try{this.log.debug("setting munged ".concat(i?"remote":"local"," description"),this.logContext),i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e);return}catch(s){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:s,sdp:t})),e.sdp=r}}try{i?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(r){let s="unknown error";r instanceof Error?s=r.message:typeof r=="string"&&(s=r);const a={error:s,sdp:e.sdp};throw!i&&this.pc.remoteDescription&&(a.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:a})),new cn(s)}})}ensureVideoDDExtensionForSVC(e,t){var i,r;if(!((i=e.ext)===null||i===void 0?void 0:i.some(a=>a.uri===Lo))){if(this.ddExtID===0){let a=0;t.media.forEach(o=>{var c;o.type==="video"&&((c=o.ext)===null||c===void 0||c.forEach(l=>{l.value>a&&(a=l.value)}))}),this.ddExtID=a+1}(r=e.ext)===null||r===void 0||r.push({value:this.ddExtID,uri:Lo})}}}function Zo(n,e,t){const i=Ms(n.mid);let r=0;n.rtp.some(s=>s.codec==="opus"?(r=s.payload,!0):!1),r>0&&(n.rtcpFb||(n.rtcpFb=[]),t.includes(i)&&!n.rtcpFb.some(s=>s.payload===r&&s.type==="nack")&&n.rtcpFb.push({payload:r,type:"nack"}),(e.includes(i)||e.length===1&&e[0]==="all")&&n.fmtp.some(s=>s.payload===r?(s.config.includes("stereo=1")||(s.config+=";stereo=1"),!0):!1))}function $f(n){var e;const t=[],i=[],r=It.parse((e=n.sdp)!==null&&e!==void 0?e:"");let s=0;return r.media.forEach(a=>{var o;const c=Ms(a.mid);a.type==="audio"&&(a.rtp.some(l=>l.codec==="opus"?(s=l.payload,!0):!1),!((o=a.rtcpFb)===null||o===void 0)&&o.some(l=>l.payload===s&&l.type==="nack")&&i.push(c),a.fmtp.some(l=>l.payload===s?(l.config.includes("sprop-stereo=1")&&t.push(c),!0):!1))}),{stereoMids:t,nackMids:i}}function ea(n){if(n.connection){const e=n.connection.ip.indexOf(":")>=0;(n.connection.version===4&&e||n.connection.version===6&&!e)&&(n.connection.ip="0.0.0.0",n.connection.version=4)}}function Ms(n){return typeof n=="number"?n.toFixed(0):n}const Yr="vp8",Jf={audioPreset:Vr.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:Ps.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:Yr,backupCodec:!0,preConnectBuffer:!1},yl={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},kl={deviceId:{ideal:"default"},resolution:Bn.h720.resolution},Yf={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new Ph,disconnectOnPageLeave:!0,webAudioMix:!1,singlePeerConnection:!0},As={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var le;(function(n){n[n.NEW=0]="NEW",n[n.CONNECTING=1]="CONNECTING",n[n.CONNECTED=2]="CONNECTED",n[n.FAILED=3]="FAILED",n[n.CLOSING=4]="CLOSING",n[n.CLOSED=5]="CLOSED"})(le||(le={}));class Qf{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}get mode(){return this._mode}constructor(e,t,i){var r;this.peerConnectionTimeout=As.peerConnectionTimeout,this.log=K,this.updateState=()=>{var s,a;const o=this.state,c=this.requiredTransports.map(l=>l.getConnectionState());c.every(l=>l==="connected")?this.state=le.CONNECTED:c.some(l=>l==="failed")?this.state=le.FAILED:c.some(l=>l==="connecting")?this.state=le.CONNECTING:c.every(l=>l==="closed")?this.state=le.CLOSED:c.some(l=>l==="closed")?this.state=le.CLOSING:c.every(l=>l==="new")&&(this.state=le.NEW),o!==this.state&&(this.log.debug("pc state change: from ".concat(le[o]," to ").concat(le[this.state]),this.logContext),(s=this.onStateChange)===null||s===void 0||s.call(this,this.state,this.publisher.getConnectionState(),(a=this.subscriber)===null||a===void 0?void 0:a.getConnectionState()))},this.log=Tt((r=i.loggerName)!==null&&r!==void 0?r:Qe.PCManager),this.loggerOptions=i,this.isPublisherConnectionRequired=t!=="subscriber-primary",this.isSubscriberConnectionRequired=t==="subscriber-primary",this.publisher=new Xo(e,i),this._mode=t,t!=="publisher-only"&&(this.subscriber=new Xo(e,i),this.subscriber.onConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.subscriber.onIceCandidate=s=>{var a;(a=this.onIceCandidate)===null||a===void 0||a.call(this,s,Ge.SUBSCRIBER)},this.subscriber.onDataChannel=s=>{var a;(a=this.onDataChannel)===null||a===void 0||a.call(this,s)},this.subscriber.onTrack=s=>{var a;(a=this.onTrack)===null||a===void 0||a.call(this,s)}),this.publisher.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=s=>{var a;(a=this.onIceCandidate)===null||a===void 0||a.call(this,s,Ge.PUBLISHER)},this.publisher.onTrack=s=>{var a;(a=this.onTrack)===null||a===void 0||a.call(this,s)},this.publisher.onOffer=(s,a)=>{var o;(o=this.onPublisherOffer)===null||o===void 0||o.call(this,s,a)},this.state=le.NEW,this.connectionLock=new xe,this.remoteOfferLock=new xe}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}requirePublisher(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e,t){return this.publisher.setRemoteDescription(e,t)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return S(this,void 0,void 0,function*(){var e;if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const t=this.publisher;for(const i of t.getSenders())try{t.canRemoveTrack()&&t.removeTrack(i)}catch(r){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:r}))}}yield Promise.all([this.publisher.close(),(e=this.subscriber)===null||e===void 0?void 0:e.close()]),this.updateState()})}triggerIceRestart(){return S(this,void 0,void 0,function*(){this.subscriber&&(this.subscriber.restartingIce=!0),this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(e,t){return S(this,void 0,void 0,function*(){var i;t===Ge.PUBLISHER?yield this.publisher.addIceCandidate(e):yield(i=this.subscriber)===null||i===void 0?void 0:i.addIceCandidate(e)})}createSubscriberAnswerFromOffer(e,t){return S(this,void 0,void 0,function*(){var i,r,s;this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:(i=this.subscriber)===null||i===void 0?void 0:i.getSignallingState().toString()}));const a=yield this.remoteOfferLock.lock();try{return(yield(r=this.subscriber)===null||r===void 0?void 0:r.setRemoteDescription(e,t))?yield(s=this.subscriber)===null||s===void 0?void 0:s.createAndSetAnswer():void 0}finally{a()}})}updateConfiguration(e,t){var i;this.publisher.setConfiguration(e),(i=this.subscriber)===null||i===void 0||i.setConfiguration(e),t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){return S(this,void 0,void 0,function*(){var i;const r=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((i=this.requiredTransports)===null||i===void 0?void 0:i.map(s=>this.ensureTransportConnected(s,e,t)))}finally{r()}})}negotiate(e){return S(this,void 0,void 0,function*(){return new Le((t,i)=>S(this,void 0,void 0,function*(){const r=setTimeout(()=>{i(new cn("negotiation timed out"))},this.peerConnectionTimeout),s=()=>{clearTimeout(r),i(new cn("negotiation aborted"))};e.signal.addEventListener("abort",s),this.publisher.once(dn.NegotiationStarted,()=>{e.signal.aborted||this.publisher.once(dn.NegotiationComplete,()=>{clearTimeout(r),t()})}),yield this.publisher.negotiate(a=>{clearTimeout(r),a instanceof Error?i(a):i(new Error(String(a)))})}))})}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTransceiverOfKind(e,t){return this.publisher.addTransceiverOfKind(e,t)}getMidForReceiver(e){const i=(this.subscriber?this.subscriber.getTransceivers():this.publisher.getTransceivers()).find(r=>r.receiver===e);return i?.mid}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===Ge.PUBLISHER?this.publisher.getConnectedAddress():e===Ge.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&this.subscriber&&e.push(this.subscriber),e}ensureTransportConnected(e,t){return S(this,arguments,void 0,function(i,r){var s=this;let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return(function*(){if(i.getConnectionState()!=="connected")return new Promise((c,l)=>S(s,void 0,void 0,function*(){const u=()=>{this.log.warn("abort transport connection",this.logContext),Pe.clearTimeout(d),l(B.cancelled("room connection has been cancelled"))};r?.signal.aborted&&u(),r?.signal.addEventListener("abort",u);const d=Pe.setTimeout(()=>{r?.signal.removeEventListener("abort",u),l(B.internal("could not establish pc connection"))},a);for(;this.state!==le.CONNECTED;)if(yield Re(50),r?.signal.aborted){l(B.cancelled("room connection has been cancelled"));return}Pe.clearTimeout(d),r?.signal.removeEventListener("abort",u),c()}))})()})}}const Sl=5e3,Xf=3e4;class ne{static fetchRegionSettings(e,t,i){return S(this,void 0,void 0,function*(){const r=yield ne.fetchLock.lock();try{const s=yield fetch("".concat(Zf(e),"/regions"),{headers:{authorization:"Bearer ".concat(t)},signal:i});if(s.ok){const a=Sf(s.headers),o=a?a*1e3:Sl;return{regionSettings:yield s.json(),updatedAtInMs:Date.now(),maxAgeInMs:o}}else throw s.status===401?B.notAllowed("Could not fetch region settings: ".concat(s.statusText),s.status):B.internal("Could not fetch region settings: ".concat(s.statusText))}catch(s){throw s instanceof B?s:i?.aborted?B.cancelled("Region fetching was aborted"):B.serverUnreachable("Could not fetch region settings, ".concat(s instanceof Error?"".concat(s.name,": ").concat(s.message):s))}finally{r()}})}static scheduleRefetch(e,t,i){return S(this,void 0,void 0,function*(){const r=ne.settingsTimeouts.get(e.hostname);clearTimeout(r),ne.settingsTimeouts.set(e.hostname,setTimeout(()=>S(this,void 0,void 0,function*(){try{const s=yield ne.fetchRegionSettings(e,t);ne.updateCachedRegionSettings(e,t,s)}catch(s){if(s instanceof B&&s.reason===oe.NotAllowed){K.debug("token is not valid, cancelling auto region refresh");return}K.debug("auto refetching of region settings failed",{error:s}),ne.scheduleRefetch(e,t,i)}}),i))})}static updateCachedRegionSettings(e,t,i){ne.cache.set(e.hostname,i),ne.scheduleRefetch(e,t,i.maxAgeInMs)}static stopRefetch(e){const t=ne.settingsTimeouts.get(e);t&&(clearTimeout(t),ne.settingsTimeouts.delete(e))}static scheduleCleanup(e){let t=ne.connectionTrackers.get(e);t&&(t.cleanupTimeout&&clearTimeout(t.cleanupTimeout),t.cleanupTimeout=setTimeout(()=>{const i=ne.connectionTrackers.get(e);i&&i.connectionCount===0&&(K.debug("stopping region refetch after disconnect delay",{hostname:e}),ne.stopRefetch(e)),i&&(i.cleanupTimeout=void 0)},Xf))}static cancelCleanup(e){const t=ne.connectionTrackers.get(e);t?.cleanupTimeout&&(clearTimeout(t.cleanupTimeout),t.cleanupTimeout=void 0)}notifyConnected(){const e=this.serverUrl.hostname;let t=ne.connectionTrackers.get(e);t||(t={connectionCount:0},ne.connectionTrackers.set(e,t)),t.connectionCount++,ne.cancelCleanup(e)}notifyDisconnected(){const e=this.serverUrl.hostname,t=ne.connectionTrackers.get(e);t&&(t.connectionCount=Math.max(0,t.connectionCount-1),t.connectionCount===0&&ne.scheduleCleanup(e))}constructor(e,t){this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=t}updateToken(e){this.token=e}isCloud(){return mn(this.serverUrl)}getServerUrl(){return this.serverUrl}fetchRegionSettings(e){return S(this,void 0,void 0,function*(){return ne.fetchRegionSettings(this.serverUrl,this.token,e)})}getNextBestRegionUrl(e){return S(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");let t=ne.cache.get(this.serverUrl.hostname);(!t||Date.now()-t.updatedAtInMs>t.maxAgeInMs)&&(t=yield this.fetchRegionSettings(e),ne.updateCachedRegionSettings(this.serverUrl,this.token,t));const i=t.regionSettings.regions.filter(r=>!this.attemptedRegions.find(s=>s.url===r.url));if(i.length>0){const r=i[0];return this.attemptedRegions.push(r),K.debug("next region: ".concat(r.region)),r.url}else return null})}resetAttempts(){this.attemptedRegions=[]}setServerReportedRegions(e){ne.updateCachedRegionSettings(this.serverUrl,this.token,e)}}ne.cache=new Map;ne.settingsTimeouts=new Map;ne.connectionTrackers=new Map;ne.fetchLock=new xe;function Zf(n){return"".concat(n.protocol.replace("ws","http"),"//").concat(n.host,"/settings")}class de extends Error{constructor(e,t,i){super(t),this.code=e,this.message=ta(t,de.MAX_MESSAGE_BYTES),this.data=i?ta(i,de.MAX_DATA_BYTES):void 0}static fromProto(e){return new de(e.code,e.message,e.data)}toProto(){return new fc({code:this.code,message:this.message,data:this.data})}static builtIn(e,t){return new de(de.ErrorCode[e],de.ErrorMessage[e],t)}}de.MAX_MESSAGE_BYTES=256;de.MAX_DATA_BYTES=15360;de.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404};de.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const Tl=15360;function Ds(n){return new TextEncoder().encode(n).length}function ta(n,e){if(Ds(n)<=e)return n;let t=0,i=n.length;const r=new TextEncoder;for(;t<i;){const s=Math.floor((t+i+1)/2);r.encode(n.slice(0,s)).length<=e?t=s:i=s-1}return n.slice(0,t)}const Ls=2e3;function Ki(n,e){if(!e)return 0;let t,i;return"bytesReceived"in n?(t=n.bytesReceived,i=e.bytesReceived):"bytesSent"in n&&(t=n.bytesSent,i=e.bytesSent),t===void 0||i===void 0||n.timestamp===void 0||e.timestamp===void 0?0:(t-i)*8*1e3/(n.timestamp-e.timestamp)}const Ns=typeof MediaRecorder<"u";class ep{constructor(){throw new Error("MediaRecorder is not available in this environment")}}const tp=Ns?MediaRecorder:ep;class np extends tp{constructor(e,t){if(!Ns)throw new Error("MediaRecorder is not available in this environment");super(new MediaStream([e.mediaStreamTrack]),t);let i,r;const s=()=>r===void 0,a=()=>{this.removeEventListener("dataavailable",i),this.removeEventListener("stop",a),this.removeEventListener("error",o),r?.close(),r=void 0},o=c=>{r?.error(c),this.removeEventListener("dataavailable",i),this.removeEventListener("stop",a),this.removeEventListener("error",o),r=void 0};this.byteStream=new ReadableStream({start:c=>{r=c,i=l=>S(this,void 0,void 0,function*(){let u;if(l.data.arrayBuffer){const d=yield l.data.arrayBuffer();u=new Uint8Array(d)}else if(l.data.byteArray)u=l.data.byteArray;else throw new Error("no data available!");s()||c.enqueue(u)}),this.addEventListener("dataavailable",i)},cancel:()=>{a()}}),this.addEventListener("stop",a),this.addEventListener("error",o)}}function ip(){return Ns}const rp=1e3,sp=1e4;class Cl extends P{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor(e,t,i){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,s=arguments.length>4?arguments[4]:void 0;super(e,t,s),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=xs(()=>S(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>S(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(U.Ended,this)},this.reacquireTrack=!1,this.providedByUser=r,this.muteLock=new xe,this.pauseUpstreamLock=new xe,this.trackChangeLock=new xe,this.trackChangeLock.lock().then(a=>S(this,void 0,void 0,function*(){try{yield this.setMediaStreamTrack(e,!0)}finally{a()}})),this._constraints=e.getConstraints(),i&&(this._constraints=i)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==P.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();if(e&&t)return{width:e,height:t}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return(t=(e=this.processor)===null||e===void 0?void 0:e.processedTrack)!==null&&t!==void 0?t:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(e,t){return S(this,void 0,void 0,function*(){var i;if(e===this._mediaStreamTrack&&!t)return;this._mediaStreamTrack&&(this.attachedElements.forEach(s=>{ln(this._mediaStreamTrack,s)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints());let r;if(this.processor&&e){if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(nn(e,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),r=this.processor.processedTrack}this.sender&&((i=this.sender.transport)===null||i===void 0?void 0:i.state)!=="closed"&&(yield this.sender.replaceTrack(r??e)),!this.providedByUser&&this._mediaStreamTrack!==e&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(s=>{nn(r??e,s)}))})}waitForDimensions(){return S(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:rp;return(function*(){var i;if(e.kind===P.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((i=Me())===null||i===void 0?void 0:i.os)==="iOS"&&(yield Re(10));const r=Date.now();for(;Date.now()-r<t;){const s=e.dimensions;if(s)return s;yield Re(50)}throw new St("unable to get track dimensions after timeout")})()})}setDeviceId(e){return S(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===Dt(e)||(this._constraints.deviceId=e,this.isMuted)?!0:(yield this.restartTrack(),Dt(e)===this._mediaStreamTrack.getSettings().deviceId)})}getDeviceId(){return S(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){if(e.source===P.Source.ScreenShare)return;const{deviceId:i,groupId:r}=e._mediaStreamTrack.getSettings(),s=e.kind===P.Kind.Audio?"audioinput":"videoinput";return t?Ce.getInstance().normalizeDeviceId(s,i,r):i})()})}mute(){return S(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return S(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(e,t){return S(this,void 0,void 0,function*(){const i=yield this.trackChangeLock.lock();try{if(!this.sender)throw new St("unable to replace an unpublished track");let r,s;return typeof t=="boolean"?r=t:t!==void 0&&(r=t.userProvidedTrack,s=t.stopProcessor),this.providedByUser=r??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),s&&this.processor&&(yield this.internalStopProcessor()),this}finally{i()}})}restart(e){return S(this,void 0,void 0,function*(){this.manuallyStopped=!1;const t=yield this.trackChangeLock.lock();try{e||(e=this._constraints);const{deviceId:i,facingMode:r}=e,s=Rh(e,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const a={audio:!1,video:!1};this.kind===P.Kind.Video?a.video=i||r?{deviceId:i,facingMode:r}:!0:a.audio=i?Object.assign({deviceId:i},s):!0,this.attachedElements.forEach(l=>{ln(this.mediaStreamTrack,l)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const c=(yield navigator.mediaDevices.getUserMedia(a)).getTracks()[0];return this.kind===P.Kind.Video&&(yield c.applyConstraints(s)),c.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(c),this._constraints=e,this.emit(U.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{t()}})}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),!(this.isMuted===e&&this._mediaStreamTrack.enabled!==e)&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?U.Muted:U.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return S(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),ml()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var e;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),(e=this.processor)===null||e===void 0||e.destroy(),this.processor=void 0}pauseUpstream(){return S(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(U.UpstreamPaused,this);const i=Me();if(i?.name==="Safari"&&Xe(i.version,"12.0")<0)throw new ws("pauseUpstream is not supported on Safari < 12.");((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{t()}})}resumeUpstream(){return S(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(U.UpstreamResumed,this),((e=this.sender.transport)===null||e===void 0?void 0:e.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{t()}})}getRTCStatsReport(){return S(this,void 0,void 0,function*(){var e;return!((e=this.sender)===null||e===void 0)&&e.getStats?yield this.sender.getStats():void 0})}setProcessor(e){return S(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var s;const a=yield i.trackChangeLock.lock();try{i.log.debug("setting up processor",i.logContext);const o=document.createElement(i.kind),c={kind:i.kind,track:i._mediaStreamTrack,element:o,audioContext:i.audioContext};if(yield t.init(c),i.log.debug("processor initialized",i.logContext),i.processor&&(yield i.internalStopProcessor()),i.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(nn(i._mediaStreamTrack,o),o.muted=!0,o.play().catch(l=>{l instanceof DOMException&&l.name==="AbortError"?(i.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},i.logContext),{error:l})),setTimeout(()=>{o.play().catch(u=>{i.log.error("failed to play processor element",Object.assign(Object.assign({},i.logContext),{err:u}))})},100)):i.log.error("failed to play processor element",Object.assign(Object.assign({},i.logContext),{error:l}))}),i.processor=t,i.processorElement=o,i.processor.processedTrack){for(const l of i.attachedElements)l!==i.processorElement&&r&&(ln(i._mediaStreamTrack,l),nn(i.processor.processedTrack,l));yield(s=i.sender)===null||s===void 0?void 0:s.replaceTrack(i.processor.processedTrack)}i.emit(U.TrackProcessorUpdate,i.processor)}finally{a()}})()})}getProcessor(){return this.processor}stopProcessor(){return S(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){const i=yield e.trackChangeLock.lock();try{yield e.internalStopProcessor(t)}finally{i()}})()})}internalStopProcessor(){return S(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var i,r;e.processor&&(e.log.debug("stopping processor",e.logContext),(i=e.processor.processedTrack)===null||i===void 0||i.stop(),yield e.processor.destroy(),e.processor=void 0,t||((r=e.processorElement)===null||r===void 0||r.remove(),e.processorElement=void 0),yield e._mediaStreamTrack.applyConstraints(e._constraints),yield e.setMediaStreamTrack(e._mediaStreamTrack,!0),e.emit(U.TrackProcessorUpdate))})()})}startPreConnectBuffer(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;if(!ip()){this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext);return}if(this.localTrackRecorder){this.log.warn("preconnect buffer already started");return}else{let t="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(t)||(t="video/mp4"),this.localTrackRecorder=new np(this,{mimeType:t})}this.localTrackRecorder.start(e),this.autoStopPreConnectBuffer=setTimeout(()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()},sp)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.byteStream}getPreConnectBufferMimeType(){var e;return(e=this.localTrackRecorder)===null||e===void 0?void 0:e.mimeType}}class wi extends Cl{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;super(e,P.Kind.Audio,t,i,s),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>S(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let a;try{a=yield this.getSenderStats()}catch(o){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:o}));return}a&&this.prevStats&&(this._currentBitrate=Ki(a,this.prevStats)),this.prevStats=a}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(U.AudioTrackFeatureUpdate,this,Te.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(U.AudioTrackFeatureUpdate,this,Te.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=r,this.checkForSilence()}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return S(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===P.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return S(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const i=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==Dt(this._constraints.deviceId);return this.source===P.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||i)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}})}restartTrack(e){return S(this,void 0,void 0,function*(){let t;if(e){const i=Rs({audio:e});typeof i.audio!="boolean"&&(t=i.audio)}yield this.restart(t)})}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return S(this,void 0,void 0,function*(){const i=yield t.restart.call(this,e);return this.checkForSilence(),i})}startMonitor(){Ne()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},Ls)))}setProcessor(e){return S(this,void 0,void 0,function*(){var t;const i=yield this.trackChangeLock.lock();try{if(!lt()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());const r={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(r),this.processor=e,this.processor.processedTrack&&(yield(t=this.sender)===null||t===void 0?void 0:t.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(U.TrackProcessorUpdate,this.processor)}finally{i()}})}setAudioContext(e){this.audioContext=e}getSenderStats(){return S(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return;const t=yield this.sender.getStats();let i;return t.forEach(r=>{r.type==="outbound-rtp"&&(i={type:"audio",streamId:r.id,packetsSent:r.packetsSent,packetsLost:r.packetsLost,bytesSent:r.bytesSent,timestamp:r.timestamp,roundTripTime:r.roundTripTime,jitter:r.jitter})}),i})}checkForSilence(){return S(this,void 0,void 0,function*(){const e=yield hl(this);return e&&(this.isMuted||this.log.debug("silence detected on local audio track",this.logContext),this.emit(U.AudioSilenceDetected)),e})}}function op(n,e,t){switch(n.kind){case"audio":return new wi(n,e,!1,void 0,t);case"video":return new Pi(n,e,!1,t);default:throw new St("unsupported track type: ".concat(n.kind))}}const ap=Object.values(Bn),cp=Object.values(qr),lp=Object.values(Ps),up=[Bn.h180,Bn.h360],dp=[qr.h180,qr.h360],hp=n=>[{scaleResolutionDownBy:2,fps:n.encoding.maxFramerate}].map(t=>{var i,r;return new ie(Math.floor(n.width/t.scaleResolutionDownBy),Math.floor(n.height/t.scaleResolutionDownBy),Math.max(15e4,Math.floor(n.encoding.maxBitrate/(Math.pow(t.scaleResolutionDownBy,2)*(((i=n.encoding.maxFramerate)!==null&&i!==void 0?i:30)/((r=t.fps)!==null&&r!==void 0?r:30))))),t.fps,n.encoding.priority)}),Qr=["q","h","f"];function Xr(n,e,t,i){var r,s;let a=i?.videoEncoding;n&&(a=i?.screenShareEncoding);const o=i?.simulcast,c=i?.scalabilityMode,l=i?.videoCodec;if(!a&&!o&&!c||!e||!t)return[{}];a||(a=pp(n,e,t,l),K.debug("using video encoding",a));const u=a.maxFramerate,d=new ie(e,t,a.maxBitrate,a.maxFramerate,a.priority);if(c&&$e(l)){const b=new El(c),m=[];if(b.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(c));const T=Me();if(Vn()||lt()||T?.name==="Chrome"&&Xe(T?.version,"113")<0){const k=b.suffix=="h"?2:3,w=lf(T);for(let M=0;M<b.spatial;M+=1)m.push({rid:Qr[2-M],maxBitrate:a.maxBitrate/Math.pow(k,M),maxFramerate:d.encoding.maxFramerate,scaleResolutionDownBy:w?Math.pow(2,M):void 0});m[0].scalabilityMode=c}else m.push({maxBitrate:a.maxBitrate,maxFramerate:d.encoding.maxFramerate,scalabilityMode:c});return d.encoding.priority&&(m[0].priority=d.encoding.priority,m[0].networkPriority=d.encoding.priority),K.debug("using svc encoding",{encodings:m}),m}if(!o)return[a];let h=[];n?h=(r=ia(i?.screenShareSimulcastLayers))!==null&&r!==void 0?r:na(n,d):h=(s=ia(i?.videoSimulcastLayers))!==null&&s!==void 0?s:na(n,d);let p;if(h.length>0){const b=h[0];h.length>1&&([,p]=h);const m=Math.max(e,t);if(m>=960&&p)return kr(e,t,[b,p,d],u);if(m>=480)return kr(e,t,[b,d],u)}return kr(e,t,[d])}function fp(n,e,t){var i,r,s,a;if(!t.backupCodec||t.backupCodec===!0||t.backupCodec.codec===t.videoCodec)return;e!==t.backupCodec.codec&&K.warn("requested a different codec than specified as backup",{serverRequested:e,backup:t.backupCodec.codec}),t.videoCodec=e,t.videoEncoding=t.backupCodec.encoding;const o=n.mediaStreamTrack.getSettings(),c=(i=o.width)!==null&&i!==void 0?i:(r=n.dimensions)===null||r===void 0?void 0:r.width,l=(s=o.height)!==null&&s!==void 0?s:(a=n.dimensions)===null||a===void 0?void 0:a.height;return n.source===P.Source.ScreenShare&&t.simulcast&&(t.simulcast=!1),Xr(n.source===P.Source.ScreenShare,c,l,t)}function pp(n,e,t,i){const r=mp(n,e,t);let{encoding:s}=r[0];const a=Math.max(e,t);for(let o=0;o<r.length;o+=1){const c=r[o];if(s=c.encoding,c.width>=a)break}if(i)switch(i){case"av1":case"h265":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.7;break;case"vp9":s=Object.assign({},s),s.maxBitrate=s.maxBitrate*.85;break}return s}function mp(n,e,t){if(n)return lp;const i=e>t?e/t:t/e;return Math.abs(i-16/9)<Math.abs(i-4/3)?ap:cp}function na(n,e){if(n)return hp(e);const{width:t,height:i}=e,r=t>i?t/i:i/t;return Math.abs(r-16/9)<Math.abs(r-4/3)?up:dp}function kr(n,e,t,i){const r=[];if(t.forEach((s,a)=>{if(a>=Qr.length)return;const o=Math.min(n,e),l={rid:Qr[a],scaleResolutionDownBy:Math.max(1,o/Math.min(s.width,s.height)),maxBitrate:s.encoding.maxBitrate},u=i&&s.encoding.maxFramerate?Math.min(i,s.encoding.maxFramerate):s.encoding.maxFramerate;u&&(l.maxFramerate=u);const d=Gt()||a===0;s.encoding.priority&&d&&(l.priority=s.encoding.priority,l.networkPriority=s.encoding.priority),r.push(l)}),lt()&&vl()==="ios"){let s;r.forEach(o=>{s?o.maxFramerate&&o.maxFramerate>s&&(s=o.maxFramerate):s=o.maxFramerate});let a=!0;r.forEach(o=>{var c;o.maxFramerate!=s&&(a&&(a=!1,K.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),K.info('Setting framerate of encoding "'.concat((c=o.rid)!==null&&c!==void 0?c:"",'" to ').concat(s)),o.maxFramerate=s)})}return r}function ia(n){if(n)return n.sort((e,t)=>{const{encoding:i}=e,{encoding:r}=t;return i.maxBitrate>r.maxBitrate?1:i.maxBitrate<r.maxBitrate?-1:i.maxBitrate===r.maxBitrate&&i.maxFramerate&&r.maxFramerate?i.maxFramerate>r.maxFramerate?1:-1:0})}class El{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");if(this.spatial=parseInt(t[1]),this.temporal=parseInt(t[2]),t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat((e=this.suffix)!==null&&e!==void 0?e:"")}}function gp(n){return n.source===P.Source.ScreenShare||n.constraints.height&&Dt(n.constraints.height)>=1080?"maintain-resolution":"balanced"}const vp=5e3;class Pi extends Cl{get sender(){return this._sender}set sender(e){this._sender=e,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,r=arguments.length>3?arguments[3]:void 0;super(e,P.Kind.Video,t,i,r),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.isCpuConstrained=!1,this.optimizeForPerformance=!1,this.monitorSender=()=>S(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let s;try{s=yield this.getSenderStats()}catch(c){this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:c}));return}const a=new Map(s.map(c=>[c.rid,c])),o=s.some(c=>c.qualityLimitationReason==="cpu");if(o!==this.isCpuConstrained&&(this.isCpuConstrained=o,this.isCpuConstrained&&this.emit(U.CpuConstrained)),this.prevStats){let c=0;a.forEach((l,u)=>{var d;const h=(d=this.prevStats)===null||d===void 0?void 0:d.get(u);c+=Ki(l,h)}),this._currentBitrate=c}this.prevStats=a}),this.senderLock=new xe}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;if(this.signalClient=e,!Ne())return;const i=(t=this.sender)===null||t===void 0?void 0:t.getParameters();i&&(this.encodings=i.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},Ls))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(e=>{e.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return S(this,void 0,void 0,function*(){var t,i,r,s,a;yield e.pauseUpstream.call(this);try{for(var o=!0,c=kt(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;o=!0)s=l.value,o=!1,yield(a=s.sender)===null||a===void 0?void 0:a.replaceTrack(null)}catch(u){i={error:u}}finally{try{!o&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return S(this,void 0,void 0,function*(){var t,i,r,s,a;yield e.resumeUpstream.call(this);try{for(var o=!0,c=kt(this.simulcastCodecs.values()),l;l=yield c.next(),t=l.done,!t;o=!0){s=l.value,o=!1;const u=s;yield(a=u.sender)===null||a===void 0?void 0:a.replaceTrack(u.mediaStreamTrack)}}catch(u){i={error:u}}finally{try{!o&&!t&&(r=c.return)&&(yield r.call(c))}finally{if(i)throw i.error}}})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return S(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===P.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return S(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.source===P.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{t()}})}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){return S(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return[];const t=[],i=yield this.sender.getStats();return i.forEach(r=>{var s;if(r.type==="outbound-rtp"){const a={type:"video",streamId:r.id,frameHeight:r.frameHeight,frameWidth:r.frameWidth,framesPerSecond:r.framesPerSecond,framesSent:r.framesSent,firCount:r.firCount,pliCount:r.pliCount,nackCount:r.nackCount,packetsSent:r.packetsSent,bytesSent:r.bytesSent,qualityLimitationReason:r.qualityLimitationReason,qualityLimitationDurations:r.qualityLimitationDurations,qualityLimitationResolutionChanges:r.qualityLimitationResolutionChanges,rid:(s=r.rid)!==null&&s!==void 0?s:r.id,retransmittedPacketsSent:r.retransmittedPacketsSent,targetBitrate:r.targetBitrate,timestamp:r.timestamp},o=i.get(r.remoteId);o&&(a.jitter=o.jitter,a.packetsLost=o.packetsLost,a.roundTripTime=o.roundTripTime),t.push(a)}}),t.sort((r,s)=>{var a,o;return((a=s.frameWidth)!==null&&a!==void 0?a:0)-((o=r.frameWidth)!==null&&o!==void 0?o:0)}),t})}setPublishingQuality(e){const t=[];for(let i=je.LOW;i<=je.HIGH;i+=1)t.push(new Ss({quality:i,enabled:i<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers($e(this.codec),t)}restartTrack(e){return S(this,void 0,void 0,function*(){var t,i,r,s,a;let o;if(e){const d=Rs({video:e});typeof d.video!="boolean"&&(o=d.video)}yield this.restart(o),this.isCpuConstrained=!1;try{for(var c=!0,l=kt(this.simulcastCodecs.values()),u;u=yield l.next(),t=u.done,!t;c=!0){s=u.value,c=!1;const d=s;d.sender&&((a=d.sender.transport)===null||a===void 0?void 0:a.state)!=="closed"&&(d.mediaStreamTrack=this.mediaStreamTrack.clone(),yield d.sender.replaceTrack(d.mediaStreamTrack))}}catch(d){i={error:d}}finally{try{!c&&!t&&(r=l.return)&&(yield r.call(l))}finally{if(i)throw i.error}}})}setProcessor(e){const t=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return S(this,arguments,void 0,function(i){var r=this;let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var a,o,c,l,u,d;if(yield t.setProcessor.call(r,i,s),!((u=r.processor)===null||u===void 0)&&u.processedTrack)try{for(var h=!0,p=kt(r.simulcastCodecs.values()),b;b=yield p.next(),a=b.done,!a;h=!0)l=b.value,h=!1,yield(d=l.sender)===null||d===void 0?void 0:d.replaceTrack(r.processor.processedTrack)}catch(m){o={error:m}}finally{try{!h&&!a&&(c=p.return)&&(yield c.call(p))}finally{if(o)throw o.error}}})()})}setDegradationPreference(e){return S(this,void 0,void 0,function*(){if(this.degradationPreference=e,this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const t=this.sender.getParameters();t.degradationPreference=e,this.sender.setParameters(t)}catch(t){this.log.warn("failed to set degradationPreference",Object.assign({error:t},this.logContext))}})}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e)){this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);return}const i={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};return this.simulcastCodecs.set(e,i),i}setSimulcastTrackSender(e,t){const i=this.simulcastCodecs.get(e);i&&(i.sender=t,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},vp))}setPublishingCodecs(e){return S(this,void 0,void 0,function*(){var t,i,r,s,a,o,c;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers($e(e[0].codec),e[0].qualities),[];this.subscribedCodecs=e;const l=[];try{for(t=!0,i=kt(e);r=yield i.next(),s=r.done,!s;t=!0){c=r.value,t=!1;const u=c;if(!this.codec||this.codec===u.codec)yield this.setPublishingLayers($e(u.codec),u.qualities);else{const d=this.simulcastCodecs.get(u.codec);if(this.log.debug("try setPublishingCodec for ".concat(u.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:d})),!d||!d.sender){for(const h of u.qualities)if(h.enabled){l.push(u.codec);break}}else d.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(u.codec),this.logContext),yield ra(d.sender,d.encodings,u.qualities,this.senderLock,$e(u.codec),this.log,this.logContext))}}}catch(u){a={error:u}}finally{try{!t&&!s&&(o=i.return)&&(yield o.call(i))}finally{if(a)throw a.error}}return l})}setPublishingLayers(e,t){return S(this,void 0,void 0,function*(){if(this.optimizeForPerformance){this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:t}));return}this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t})),!(!this.sender||!this.encodings)&&(yield ra(this.sender,this.encodings,t,this.senderLock,e,this.log,this.logContext))})}prioritizePerformance(){return S(this,void 0,void 0,function*(){if(!this.sender)throw new Error("sender not found");const e=yield this.senderLock.lock();try{this.optimizeForPerformance=!0;const t=this.sender.getParameters();t.encodings=t.encodings.map((i,r)=>{var s;return Object.assign(Object.assign({},i),{active:r===0,scaleResolutionDownBy:Math.max(1,Math.ceil(((s=this.mediaStreamTrack.getSettings().height)!==null&&s!==void 0?s:360)/360)),scalabilityMode:r===0&&$e(this.codec)?"L1T3":void 0,maxFramerate:r===0?15:0,maxBitrate:r===0?i.maxBitrate:0})}),this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:t.encodings})),this.encodings=t.encodings,yield this.sender.setParameters(t)}catch(t){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:t})),this.optimizeForPerformance=!1}finally{e()}})}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return S(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),ml()&&this.isInBackground&&this.source===P.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function ra(n,e,t,i,r,s,a){return S(this,void 0,void 0,function*(){const o=yield i.lock();s.debug("setPublishingLayersForSender",Object.assign(Object.assign({},a),{sender:n,qualities:t,senderEncodings:e}));try{const c=n.getParameters(),{encodings:l}=c;if(!l)return;if(l.length!==e.length){s.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},a),{encodings:l,senderEncodings:e}));return}let u=!1;!1&&l[0].scalabilityMode||(r&&t.some(p=>p.enabled)&&t.forEach(p=>p.enabled=!0),l.forEach((h,p)=>{var b;let m=(b=h.rid)!==null&&b!==void 0?b:"";m===""&&(m="q");const T=wl(m),k=t.find(w=>w.quality===T);k&&h.active!==k.enabled&&(u=!0,h.active=k.enabled,s.debug("setting layer ".concat(k.quality," to ").concat(h.active?"enabled":"disabled"),a),Gt()&&(k.enabled?(h.scaleResolutionDownBy=e[p].scaleResolutionDownBy,h.maxBitrate=e[p].maxBitrate,h.maxFrameRate=e[p].maxFrameRate):(h.scaleResolutionDownBy=4,h.maxBitrate=10,h.maxFrameRate=2)))})),u&&(c.encodings=l,s.debug("setting encodings",Object.assign(Object.assign({},a),{encodings:c.encodings})),yield n.setParameters(c))}finally{o()}})}function wl(n){switch(n){case"f":return je.HIGH;case"h":return je.MEDIUM;case"q":return je.LOW;default:return je.HIGH}}function sa(n,e,t,i){if(!t)return[new At({quality:je.HIGH,width:n,height:e,bitrate:0,ssrc:0})];if(i){const r=t[0].scalabilityMode,s=new El(r),a=[],o=s.suffix=="h"?1.5:2,c=s.suffix=="h"?2:3;for(let l=0;l<s.spatial;l+=1)a.push(new At({quality:Math.min(je.HIGH,s.spatial-1)-l,width:Math.ceil(n/Math.pow(o,l)),height:Math.ceil(e/Math.pow(o,l)),bitrate:t[0].maxBitrate?Math.ceil(t[0].maxBitrate/Math.pow(c,l)):0,ssrc:0}));return a}return t.map(r=>{var s,a,o;const c=(s=r.scaleResolutionDownBy)!==null&&s!==void 0?s:1;let l=wl((a=r.rid)!==null&&a!==void 0?a:"");return new At({quality:l,width:Math.ceil(n/c),height:Math.ceil(e/c),bitrate:(o=r.maxBitrate)!==null&&o!==void 0?o:0,ssrc:0})})}const oa="_lossy",aa="_reliable",bp=2*1e3,Sr="leave-reconnect",yp=3e4,kp=8*1024,Sp=256*1024;var Ve;(function(n){n[n.New=0]="New",n[n.Connected=1]="Connected",n[n.Disconnected=2]="Disconnected",n[n.Reconnecting=3]="Reconnecting",n[n.Closed=4]="Closed"})(Ve||(Ve={}));class Tp extends dt.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var t;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=As.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.latestRemoteOfferId=0,this.subscriberPrimary=!1,this.pcState=Ve.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=K,this.reliableDataSequence=1,this.reliableMessageBuffer=new Go,this.reliableReceivedState=new qf(yp),this.lossyDataStatCurrentBytes=0,this.lossyDataStatByterate=0,this.lossyDataDropCount=0,this.midToTrackId={},this.isWaitingForNetworkReconnect=!1,this.handleDataChannel=i=>S(this,[i],void 0,function(r){var s=this;let{channel:a}=r;return(function*(){if(a){if(a.label===aa)s.reliableDCSub=a;else if(a.label===oa)s.lossyDCSub=a;else return;s.log.debug("on data channel ".concat(a.id,", ").concat(a.label),s.logContext),a.onmessage=s.handleDataMessage}})()}),this.handleDataMessage=i=>S(this,void 0,void 0,function*(){var r,s,a,o,c;const l=yield this.dataProcessLock.lock();try{let u;if(i.data instanceof ArrayBuffer)u=i.data;else if(i.data instanceof Blob)u=yield i.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:i.data}));return}const d=Oe.fromBinary(new Uint8Array(u));if(d.sequence>0&&d.participantSid!==""){const h=this.reliableReceivedState.get(d.participantSid);if(h&&d.sequence<=h)return;this.reliableReceivedState.set(d.participantSid,d.sequence)}if(((r=d.value)===null||r===void 0?void 0:r.case)==="speaker")this.emit(F.ActiveSpeakersUpdate,d.value.value.speakers);else if(((s=d.value)===null||s===void 0?void 0:s.case)==="encryptedPacket"){if(!this.e2eeManager){this.log.error("Received encrypted packet but E2EE not set up",this.logContext);return}const h=yield(a=this.e2eeManager)===null||a===void 0?void 0:a.handleEncryptedData(d.value.value.encryptedValue,d.value.value.iv,d.participantIdentity,d.value.value.keyIndex),p=uc.fromBinary(h.payload),b=new Oe({value:p.value,participantIdentity:d.participantIdentity,participantSid:d.participantSid});((o=b.value)===null||o===void 0?void 0:o.case)==="user"&&ca(b,b.value.value),this.emit(F.DataPacketReceived,b,d.value.value.encryptionType)}else((c=d.value)===null||c===void 0?void 0:c.case)==="user"&&ca(d,d.value.value),this.emit(F.DataPacketReceived,d,be.NONE)}finally{l()}}),this.handleDataError=i=>{const s=i.currentTarget.maxRetransmits===0?"lossy":"reliable";if(i instanceof ErrorEvent&&i.error){const{error:a}=i.error;this.log.error("DataChannel error on ".concat(s,": ").concat(i.message),Object.assign(Object.assign({},this.logContext),{error:a}))}else this.log.error("Unknown DataChannel error on ".concat(s),Object.assign(Object.assign({},this.logContext),{event:i}))},this.handleBufferedAmountLow=i=>{const s=i.currentTarget.maxRetransmits===0?$.LOSSY:$.RELIABLE;this.updateAndEmitDCBufferStatus(s)},this.handleDisconnect=(i,r)=>{if(this._isClosed)return;this.log.warn("".concat(i," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const s=c=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(c,"ms. giving up"),this.logContext),this.emit(F.Disconnected),this.close()},a=Date.now()-this.reconnectStart;let o=this.getNextRetryDelay({elapsedMs:a,retryCount:this.reconnectAttempts});if(o===null){s(a);return}i===Sr&&(o=0),this.log.debug("reconnecting in ".concat(o,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=Pe.setTimeout(()=>this.attemptReconnect(r).finally(()=>this.reconnectTimeout=void 0),o)},this.waitForRestarted=()=>new Promise((i,r)=>{this.pcState===Ve.Connected&&i();const s=()=>{this.off(F.Disconnected,a),i()},a=()=>{this.off(F.Restarted,s),r()};this.once(F.Restarted,s),this.once(F.Disconnected,a)}),this.updateAndEmitDCBufferStatus=i=>{if(i===$.RELIABLE){const s=this.dataChannelForKind(i);s&&this.reliableMessageBuffer.alignBufferedAmount(s.bufferedAmount)}const r=this.isBufferStatusLow(i);typeof r<"u"&&r!==this.dcBufferStatus.get(i)&&(this.dcBufferStatus.set(i,r),this.emit(F.DCBufferStatusChanged,r,i))},this.isBufferStatusLow=i=>{const r=this.dataChannelForKind(i);if(r)return r.bufferedAmount<=r.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>S(this,void 0,void 0,function*(){!this.url||!(yield fetch(qn(this.url),{method:"HEAD"}).then(r=>r.ok).catch(()=>!1))||(this.log.info("detected network reconnected"),(this.client.currentState===se.RECONNECTING||this.isWaitingForNetworkReconnect&&this.client.currentState===se.CONNECTED)&&(this.clearReconnectTimeout(),this.attemptReconnect(qt.RR_SIGNAL_DISCONNECTED),this.isWaitingForNetworkReconnect=!1))}),this.handleBrowserOffline=()=>S(this,void 0,void 0,function*(){if(this.url)try{yield Promise.race([fetch(qn(this.url),{method:"HEAD"}),Re(4e3).then(()=>Promise.reject())])}catch{window.navigator.onLine===!1&&(this.log.info("detected network interruption"),this.isWaitingForNetworkReconnect=!0)}}),this.log=Tt((t=e.loggerName)!==null&&t!==void 0?t:Qe.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new Is(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.closingLock=new xe,this.dataProcessLock=new xe,this.dcBufferStatus=new Map([[$.LOSSY,!0],[$.RELIABLE,!0]]),this.client.onParticipantUpdate=i=>this.emit(F.ParticipantUpdate,i),this.client.onConnectionQuality=i=>this.emit(F.ConnectionQualityUpdate,i),this.client.onRoomUpdate=i=>this.emit(F.RoomUpdate,i),this.client.onSubscriptionError=i=>this.emit(F.SubscriptionError,i),this.client.onSubscriptionPermissionUpdate=i=>this.emit(F.SubscriptionPermissionUpdate,i),this.client.onSpeakersChanged=i=>this.emit(F.SpeakersChanged,i),this.client.onStreamStateUpdate=i=>this.emit(F.StreamStateChanged,i),this.client.onRequestResponse=i=>this.emit(F.SignalRequestResponse,i)}get logContext(){var e,t,i,r,s,a;return{room:(t=(e=this.latestJoinResponse)===null||e===void 0?void 0:e.room)===null||t===void 0?void 0:t.name,roomID:(r=(i=this.latestJoinResponse)===null||i===void 0?void 0:i.room)===null||r===void 0?void 0:r.sid,participant:(a=(s=this.latestJoinResponse)===null||s===void 0?void 0:s.participant)===null||a===void 0?void 0:a.identity,pID:this.participantSid}}join(e,t,i,r){return S(this,arguments,void 0,function(s,a,o,c){var l=this;let u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;return(function*(){l.url=s,l.token=a,l.signalOpts=o,l.maxJoinAttempts=o.maxRetries;try{l.joinAttempts+=1,l.setupSignalClientCallbacks();const d=yield l.client.join(s,a,o,c,u);return l._isClosed=!1,l.latestJoinResponse=d,l.subscriberPrimary=d.subscriberPrimary,l.pcManager||(yield l.configure(d,!u)),(!l.subscriberPrimary||d.fastPublish)&&l.negotiate().catch(h=>{K.error(h,l.logContext)}),l.registerOnLineListener(),l.clientConfiguration=d.clientConfiguration,l.emit(F.SignalConnected,d),d}catch(d){if(d instanceof B){if(d.reason===oe.ServerUnreachable){if(l.log.warn("Couldn't connect to server, attempt ".concat(l.joinAttempts," of ").concat(l.maxJoinAttempts),l.logContext),l.joinAttempts<l.maxJoinAttempts)return l.join(s,a,o,c,u)}else if(d.reason===oe.ServiceNotFound)return l.log.warn("Initial connection failed: ".concat(d.message,"  Retrying")),l.join(s,a,o,c,!0)}throw d}})()})}close(){return S(this,void 0,void 0,function*(){const e=yield this.closingLock.lock();if(this.isClosed){e();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(F.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),this.cleanupLossyDataStats(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}})}cleanupPeerConnections(){return S(this,void 0,void 0,function*(){var e;yield(e=this.pcManager)===null||e===void 0?void 0:e.close(),this.pcManager=void 0;const t=i=>{i&&(i.close(),i.onbufferedamountlow=null,i.onclose=null,i.onclosing=null,i.onerror=null,i.onmessage=null,i.onopen=null)};t(this.lossyDC),t(this.lossyDCSub),t(this.reliableDC),t(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0,this.reliableMessageBuffer=new Go,this.reliableDataSequence=1,this.reliableReceivedState.clear()})}cleanupLossyDataStats(){this.lossyDataStatByterate=0,this.lossyDataStatCurrentBytes=0,this.lossyDataStatInterval&&(clearInterval(this.lossyDataStatInterval),this.lossyDataStatInterval=void 0),this.lossyDataDropCount=0}cleanupClient(){return S(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new St("a track with the same ID has already been published");return new Promise((t,i)=>{const r=setTimeout(()=>{delete this.pendingTrackResolvers[e.cid],i(B.timeout("publication of local track timed out, no response from server"))},1e4);this.pendingTrackResolvers[e.cid]={resolve:s=>{clearTimeout(r),t(s)},reject:()=>{clearTimeout(r),i(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)})}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(t){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:t}))}return!1}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return(e=this.reliableDCSub)===null||e===void 0?void 0:e.readyState}getConnectedServerAddress(){return S(this,void 0,void 0,function*(){var e;return(e=this.pcManager)===null||e===void 0?void 0:e.getConnectedAddress()})}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e,t){return S(this,void 0,void 0,function*(){var i,r;if(this.pcManager&&this.pcManager.currentState!==le.NEW)return;this.participantSid=(i=e.participant)===null||i===void 0?void 0:i.sid;const s=this.makeRTCConfiguration(e);this.pcManager=new Qf(s,t?"publisher-only":e.subscriberPrimary?"subscriber-primary":"publisher-primary",this.loggerOptions),this.emit(F.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(a,o)=>{this.client.sendIceCandidate(a,o)},this.pcManager.onPublisherOffer=(a,o)=>{this.client.sendOffer(a,o)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(a,o,c)=>S(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(a),this.logContext),["closed","disconnected","failed"].includes(o)&&(this.publisherConnectionPromise=void 0),a===le.CONNECTED){const d=this.pcState===Ve.New;this.pcState=Ve.Connected,d&&this.emit(F.Connected,e)}else a===le.FAILED&&(this.pcState===Ve.Connected||this.pcState===Ve.Reconnecting)&&(this.pcState=Ve.Disconnected,this.handleDisconnect("peerconnection failed",c==="failed"?qt.RR_SUBSCRIBER_FAILED:qt.RR_PUBLISHER_FAILED));const l=this.client.isDisconnected||this.client.currentState===se.RECONNECTING,u=[le.FAILED,le.CLOSING,le.CLOSED].includes(a);l&&u&&!this._isClosed&&this.emit(F.Offline)}),this.pcManager.onTrack=a=>{a.streams.length!==0&&this.emit(F.MediaTrackAdded,a.track,a.streams[0],a.receiver)},Cp((r=e.serverInfo)===null||r===void 0?void 0:r.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=(e,t,i)=>S(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,midToTrackId:i})),this.midToTrackId=i,yield this.pcManager.setPublisherAnswer(e,t))}),this.client.onTrickle=(e,t)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t})),this.pcManager.addIceCandidate(e,t))},this.client.onOffer=(e,t,i)=>S(this,void 0,void 0,function*(){if(this.latestRemoteOfferId=t,!this.pcManager)return;this.midToTrackId=i;const r=yield this.pcManager.createSubscriberAnswerFromOffer(e,t);r&&this.client.sendAnswer(r,t)}),this.client.onLocalTrackPublished=e=>{var t;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:(t=e.track)===null||t===void 0?void 0:t.sid})),!this.pendingTrackResolvers[e.cid]){this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));return}const{resolve:i}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],i(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(F.LocalTrackUnpublished,e)},this.client.onLocalTrackSubscribed=e=>{this.emit(F.LocalTrackSubscribed,e)},this.client.onTokenRefresh=e=>{var t;this.token=e,(t=this.regionUrlProvider)===null||t===void 0||t.updateToken(e)},this.client.onRemoteMuteChanged=(e,t)=>{this.emit(F.RemoteMute,e,t)},this.client.onSubscribedQualityUpdate=e=>{this.emit(F.SubscribedQualityUpdate,e)},this.client.onRoomMoved=e=>{var t;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=e.room),this.emit(F.RoomMoved,e)},this.client.onMediaSectionsRequirement=e=>{var t,i;const r={direction:"recvonly"};for(let s=0;s<e.numAudios;s++)(t=this.pcManager)===null||t===void 0||t.addPublisherTransceiverOfKind("audio",r);for(let s=0;s<e.numVideos;s++)(i=this.pcManager)===null||i===void 0||i.addPublisherTransceiverOfKind("video",r);this.negotiate()},this.client.onClose=()=>{this.handleDisconnect("signal",qt.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:e?.reason})),e.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions({updatedAtInMs:Date.now(),maxAgeInMs:Sl,regionSettings:e.regions})),e.action){case on.DISCONNECT:this.emit(F.Disconnected,e?.reason),this.close();break;case on.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(Sr);break;case on.RESUME:this.handleDisconnect(Sr)}}}makeRTCConfiguration(e){var t;const i=Object.assign({},this.rtcConfig);if(!((t=this.signalOpts)===null||t===void 0)&&t.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),i.encodedInsertableStreams=!0),e.iceServers&&!i.iceServers){const r=[];e.iceServers.forEach(s=>{const a={urls:s.urls};s.username&&(a.username=s.username),s.credential&&(a.credential=s.credential),r.push(a)}),i.iceServers=r}return e.clientConfiguration&&e.clientConfiguration.forceRelay===Nn.ENABLED&&(i.iceTransportPolicy="relay"),i.sdpSemantics="unified-plan",i.continualGatheringPolicy="gather_continually",i}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(oa,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(aa,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow,this.cleanupLossyDataStats(),this.lossyDataStatInterval=setInterval(()=>{this.lossyDataStatByterate=this.lossyDataStatCurrentBytes,this.lossyDataStatCurrentBytes=0;const e=this.dataChannelForKind($.LOSSY);if(e){const t=this.lossyDataStatByterate/10;e.bufferedAmountLowThreshold=Math.min(Math.max(t,kp),Sp)}},1e3))}createSender(e,t,i){return S(this,void 0,void 0,function*(){if(Kr())return yield this.createTransceiverRTCRtpSender(e,t,i);if(zr())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(e.mediaStreamTrack);throw new he("Required webRTC APIs not supported on this device")})}createSimulcastSender(e,t,i,r){return S(this,void 0,void 0,function*(){if(Kr())return this.createSimulcastTransceiverSender(e,t,i,r);if(zr())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new he("Cannot stream on this device")})}createTransceiverRTCRtpSender(e,t,i){return S(this,void 0,void 0,function*(){if(!this.pcManager)throw new he("publisher is closed");const r=[];e.mediaStream&&r.push(e.mediaStream),Bt(e)&&(e.codec=t.videoCodec);const s={direction:"sendonly",streams:r};return i&&(s.sendEncodings=i),(yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,s)).sender})}createSimulcastTransceiverSender(e,t,i,r){return S(this,void 0,void 0,function*(){if(!this.pcManager)throw new he("publisher is closed");const s={direction:"sendonly"};r&&(s.sendEncodings=r);const a=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,s);if(i.videoCodec)return e.setSimulcastTrackSender(i.videoCodec,a.sender),a.sender})}createRTCRtpSender(e){return S(this,void 0,void 0,function*(){if(!this.pcManager)throw new he("publisher is closed");return this.pcManager.addPublisherTrack(e)})}attemptReconnect(e){return S(this,void 0,void 0,function*(){var t,i,r;if(!this._isClosed){if(this.attemptingReconnect){K.warn("already attempting reconnect, returning early",this.logContext);return}(((t=this.clientConfiguration)===null||t===void 0?void 0:t.resumeConnection)===Nn.DISABLED||((r=(i=this.pcManager)===null||i===void 0?void 0:i.currentState)!==null&&r!==void 0?r:le.NEW)===le.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(s){this.reconnectAttempts+=1;let a=!0;s instanceof he?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:s})),a=!1):s instanceof en||(this.fullReconnectOnNext=!0),a?this.handleDisconnect("reconnect",qt.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(F.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(t){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:t}))}return null}restartConnection(e){return S(this,void 0,void 0,function*(){var t,i,r;try{if(!this.url||!this.token)throw new he("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(F.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let s;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new en;s=yield this.join(e??this.url,this.token,this.signalOpts,void 0,!this.options.singlePeerConnection)}catch(a){throw a instanceof B&&a.reason===oe.NotAllowed?new he("could not reconnect, token might be expired"):new en}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(F.SignalRestarted,s),yield this.waitForPCReconnected(),this.client.currentState!==se.CONNECTED)throw new en("Signal connection got severed during reconnect");(t=this.regionUrlProvider)===null||t===void 0||t.resetAttempts(),this.emit(F.Restarted)}catch(s){const a=yield(i=this.regionUrlProvider)===null||i===void 0?void 0:i.getNextBestRegionUrl();if(a){yield this.restartConnection(a);return}else throw(r=this.regionUrlProvider)===null||r===void 0||r.resetAttempts(),s}})}resumeConnection(e){return S(this,void 0,void 0,function*(){var t;if(!this.url||!this.token)throw new he("could not reconnect, url or token not saved");if(!this.pcManager)throw new he("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(F.Resuming);let i;try{this.setupSignalClientCallbacks(),i=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(r){let s="";throw r instanceof Error&&(s=r.message,this.log.error(r.message,Object.assign(Object.assign({},this.logContext),{error:r}))),r instanceof B&&r.reason===oe.NotAllowed?new he("could not reconnect, token might be expired"):r instanceof B&&r.reason===oe.LeaveRequest?r:new en(s)}if(this.emit(F.SignalResumed),i){const r=this.makeRTCConfiguration(i);this.pcManager.updateConfiguration(r),this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=i.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==se.CONNECTED)throw new en("Signal connection got severed during reconnect");this.client.setReconnected(),((t=this.reliableDC)===null||t===void 0?void 0:t.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),i?.lastMessageSeq&&this.resendReliableMessagesForResume(i.lastMessageSeq),this.emit(F.Resumed)})}waitForPCInitialConnection(e,t){return S(this,void 0,void 0,function*(){if(!this.pcManager)throw new he("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)})}waitForPCReconnected(){return S(this,void 0,void 0,function*(){this.pcState=Ve.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield Re(bp),!this.pcManager)throw new he("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=Ve.Connected}catch(e){throw this.pcState=Ve.Disconnected,B.internal("could not establish PC connection, ".concat(e.message))}})}publishRpcResponse(e,t,i,r){return S(this,void 0,void 0,function*(){const s=new Oe({destinationIdentities:[e],kind:$.RELIABLE,value:{case:"rpcResponse",value:new vs({requestId:t,value:r?{case:"error",value:r.toProto()}:{case:"payload",value:i??""}})}});yield this.sendDataPacket(s,$.RELIABLE)})}publishRpcAck(e,t){return S(this,void 0,void 0,function*(){const i=new Oe({destinationIdentities:[e],kind:$.RELIABLE,value:{case:"rpcAck",value:new gs({requestId:t})}});yield this.sendDataPacket(i,$.RELIABLE)})}sendDataPacket(e,t){return S(this,void 0,void 0,function*(){if(yield this.ensurePublisherConnected(t),this.e2eeManager&&this.e2eeManager.isDataChannelEncryptionEnabled){const s=xf(e);if(s){const a=yield this.e2eeManager.encryptData(s.toBinary());e.value={case:"encryptedPacket",value:new lc({encryptedValue:a.payload,iv:a.iv,keyIndex:a.keyIndex})}}}t===$.RELIABLE&&(e.sequence=this.reliableDataSequence,this.reliableDataSequence+=1);const i=e.toBinary(),r=this.dataChannelForKind(t);if(r){if(t===$.RELIABLE)yield this.waitForBufferStatusLow(t),this.reliableMessageBuffer.push({data:i,sequence:e.sequence});else{if(!this.isBufferStatusLow(t)){this.lossyDataDropCount+=1,this.lossyDataDropCount%100===0&&this.log.warn("dropping lossy data channel messages, total dropped: ".concat(this.lossyDataDropCount),this.logContext);return}this.lossyDataStatCurrentBytes+=i.byteLength}if(this.attemptingReconnect)return;r.send(i)}this.updateAndEmitDCBufferStatus(t)})}resendReliableMessagesForResume(e){return S(this,void 0,void 0,function*(){yield this.ensurePublisherConnected($.RELIABLE);const t=this.dataChannelForKind($.RELIABLE);t&&(this.reliableMessageBuffer.popToSequence(e),this.reliableMessageBuffer.getAll().forEach(i=>{t.send(i.data)})),this.updateAndEmitDCBufferStatus($.RELIABLE)})}waitForBufferStatusLow(e){return new Le((t,i)=>S(this,void 0,void 0,function*(){if(this.isBufferStatusLow(e))t();else{const r=()=>i(new he("engine closed"));for(this.once(F.Closing,r);!this.dcBufferStatus.get(e);)yield Re(10);this.off(F.Closing,r),t()}}))}ensureDataTransportConnected(e){return S(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return(function*(){var s;if(!i.pcManager)throw new he("PC manager is closed");const a=r?i.pcManager.subscriber:i.pcManager.publisher,o=r?"Subscriber":"Publisher";if(!a)throw B.internal("".concat(o," connection not set"));let c=!1;!r&&!i.dataChannelForKind(t,r)&&(i.createDataChannels(),c=!0),!c&&!r&&!i.pcManager.publisher.isICEConnected&&i.pcManager.publisher.getICEConnectionState()!=="checking"&&(c=!0),c&&i.negotiate().catch(d=>{K.error(d,i.logContext)});const l=i.dataChannelForKind(t,r);if(l?.readyState==="open")return;const u=new Date().getTime()+i.peerConnectionTimeout;for(;new Date().getTime()<u;){if(a.isICEConnected&&((s=i.dataChannelForKind(t,r))===null||s===void 0?void 0:s.readyState)==="open")return;yield Re(50)}throw B.internal("could not establish ".concat(o," connection, state: ").concat(a.getICEConnectionState()))})()})}ensurePublisherConnected(e){return S(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==le.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return S(this,void 0,void 0,function*(){return new Le((e,t)=>S(this,void 0,void 0,function*(){if(!this.pcManager){t(new cn("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const i=new AbortController,r=()=>{i.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&t(new cn("cannot negotiate on closed engine")),this.on(F.Closing,r),this.pcManager.publisher.once(dn.RTPVideoPayloadTypes,s=>{const a=new Map;s.forEach(o=>{const c=o.codec.toLowerCase();pf(c)&&a.set(o.payload,c)}),this.emit(F.RTPVideoMapUpdate,a)});try{yield this.pcManager.negotiate(i),e()}catch(s){s instanceof cn&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",qt.RR_UNKNOWN),s instanceof Error?t(s):t(new Error(String(s)))}finally{this.off(F.Closing,r)}}))})}dataChannelForKind(e,t){if(t){if(e===$.LOSSY)return this.lossyDCSub;if(e===$.RELIABLE)return this.reliableDCSub}else{if(e===$.LOSSY)return this.lossyDC;if(e===$.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var i,r,s,a;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const o=this.pcManager.publisher.getLocalDescription(),c=this.pcManager.publisher.getRemoteDescription(),l=(i=this.pcManager.subscriber)===null||i===void 0?void 0:i.getRemoteDescription(),u=(r=this.pcManager.subscriber)===null||r===void 0?void 0:r.getLocalDescription(),d=(a=(s=this.signalOpts)===null||s===void 0?void 0:s.autoSubscribe)!==null&&a!==void 0?a:!0,h=new Array,p=new Array;e.forEach(b=>{b.isDesired!==d&&h.push(b.trackSid),b.isEnabled||p.push(b.trackSid)}),this.client.sendSyncState(new Ts({answer:this.pcManager.mode==="publisher-only"?c?rn({sdp:c.sdp,type:c.type}):void 0:u?rn({sdp:u.sdp,type:u.type}):void 0,offer:this.pcManager.mode==="publisher-only"?o?rn({sdp:o.sdp,type:o.type}):void 0:l?rn({sdp:l.sdp,type:l.type}):void 0,subscription:new qi({trackSids:h,subscribe:!d,participantTracks:[]}),publishTracks:Yh(t),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:p,datachannelReceiveStates:this.reliableReceivedState.map((b,m)=>new Ic({publisherSid:m,lastSeq:b}))}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],t=(i,r)=>{i?.id!==void 0&&i.id!==null&&e.push(new Oc({label:i.label,id:i.id,target:r}))};return t(this.dataChannelForKind($.LOSSY),Ge.PUBLISHER),t(this.dataChannelForKind($.RELIABLE),Ge.PUBLISHER),t(this.dataChannelForKind($.LOSSY,!0),Ge.SUBSCRIBER),t(this.dataChannelForKind($.RELIABLE,!0),Ge.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&Pe.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){Ne()&&(window.addEventListener("online",this.handleBrowserOnLine),window.addEventListener("offline",this.handleBrowserOffline))}deregisterOnLineListener(){Ne()&&(window.removeEventListener("online",this.handleBrowserOnLine),window.removeEventListener("offline",this.handleBrowserOffline))}getTrackIdForReceiver(e){var t;const i=(t=this.pcManager)===null||t===void 0?void 0:t.getMidForReceiver(e);if(i){const r=Object.entries(this.midToTrackId).find(s=>{let[a]=s;return a===i});if(r)return r[1]}}}function Cp(n){return n!==void 0&&n>13}function ca(n,e){const t=n.participantIdentity?n.participantIdentity:e.participantIdentity;n.participantIdentity=t,e.participantIdentity=t;const i=n.destinationIdentities.length!==0?n.destinationIdentities:e.destinationIdentities;n.destinationIdentities=i,e.destinationIdentities=i}class Pl{get info(){return this._info}validateBytesReceived(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!(typeof this.totalByteSize!="number"||this.totalByteSize===0)){if(e&&this.bytesReceived<this.totalByteSize)throw new qe("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),Ie.Incomplete);if(this.bytesReceived>this.totalByteSize)throw new qe("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),Ie.LengthExceeded)}}constructor(e,t,i,r){this.reader=t,this.totalByteSize=i,this._info=e,this.bytesReceived=0,this.outOfBandFailureRejectingFuture=r}}class Ep extends Pl{handleChunkReceived(e){var t;this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const i=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0||t.call(this,i)}[Symbol.asyncIterator](){const e=this.reader.getReader();let t=new We,i=null,r=null;if(this.signal){const a=this.signal;r=()=>{var o;(o=t.reject)===null||o===void 0||o.call(t,a.reason)},a.addEventListener("abort",r),i=a}const s=()=>{e.releaseLock(),i&&r&&i.removeEventListener("abort",r),this.signal=void 0};return{next:()=>S(this,void 0,void 0,function*(){var a,o;try{const{done:c,value:l}=yield Promise.race([e.read(),t.promise,(o=(a=this.outOfBandFailureRejectingFuture)===null||a===void 0?void 0:a.promise)!==null&&o!==void 0?o:new Promise(()=>{})]);return c?(this.validateBytesReceived(!0),{done:!0,value:void 0}):(this.handleChunkReceived(l),{done:!1,value:l.content})}catch(c){throw s(),c}}),return(){return S(this,void 0,void 0,function*(){return s(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return S(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var i,r,s,a;let o=new Set;const c=t.signal?e.withAbortSignal(t.signal):e;try{for(var l=!0,u=kt(c),d;d=yield u.next(),i=d.done,!i;l=!0){a=d.value,l=!1;const h=a;o.add(h)}}catch(h){r={error:h}}finally{try{!l&&!i&&(s=u.return)&&(yield s.call(u))}finally{if(r)throw r.error}}return Array.from(o)})()})}}class wp extends Pl{constructor(e,t,i,r){super(e,t,i,r),this.receivedChunks=new Map}handleChunkReceived(e){var t;const i=gi(e.chunkIndex),r=this.receivedChunks.get(i);if(r&&r.version>e.version)return;this.receivedChunks.set(i,e),this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const s=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(t=this.onProgress)===null||t===void 0||t.call(this,s)}[Symbol.asyncIterator](){const e=this.reader.getReader(),t=new TextDecoder("utf-8",{fatal:!0});let i=new We,r=null,s=null;if(this.signal){const o=this.signal;s=()=>{var c;(c=i.reject)===null||c===void 0||c.call(i,o.reason)},o.addEventListener("abort",s),r=o}const a=()=>{e.releaseLock(),r&&s&&r.removeEventListener("abort",s),this.signal=void 0};return{next:()=>S(this,void 0,void 0,function*(){var o,c;try{const{done:l,value:u}=yield Promise.race([e.read(),i.promise,(c=(o=this.outOfBandFailureRejectingFuture)===null||o===void 0?void 0:o.promise)!==null&&c!==void 0?c:new Promise(()=>{})]);if(l)return this.validateBytesReceived(!0),{done:!0,value:void 0};{this.handleChunkReceived(u);let d;try{d=t.decode(u.content)}catch(h){throw new qe("Cannot decode datastream chunk ".concat(u.chunkIndex," as text: ").concat(h),Ie.DecodeFailed)}return{done:!1,value:d}}}catch(l){throw a(),l}}),return(){return S(this,void 0,void 0,function*(){return a(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return S(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var i,r,s,a;let o="";const c=t.signal?e.withAbortSignal(t.signal):e;try{for(var l=!0,u=kt(c),d;d=yield u.next(),i=d.done,!i;l=!0)a=d.value,l=!1,o+=a}catch(h){r={error:h}}finally{try{!l&&!i&&(s=u.return)&&(yield s.call(u))}finally{if(r)throw r.error}}return o})()})}}class Pp{constructor(){this.log=K,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map}registerTextStreamHandler(e,t){if(this.textStreamHandlers.has(e))throw new qe('A text stream handler for topic "'.concat(e,'" has already been set.'),Ie.HandlerAlreadyRegistered);this.textStreamHandlers.set(e,t)}unregisterTextStreamHandler(e){this.textStreamHandlers.delete(e)}registerByteStreamHandler(e,t){if(this.byteStreamHandlers.has(e))throw new qe('A byte stream handler for topic "'.concat(e,'" has already been set.'),Ie.HandlerAlreadyRegistered);this.byteStreamHandlers.set(e,t)}unregisterByteStreamHandler(e){this.byteStreamHandlers.delete(e)}clearControllers(){this.byteStreamControllers.clear(),this.textStreamControllers.clear()}validateParticipantHasNoActiveDataStreams(e){var t,i,r,s;const a=Array.from(this.textStreamControllers.entries()).filter(c=>c[1].sendingParticipantIdentity===e),o=Array.from(this.byteStreamControllers.entries()).filter(c=>c[1].sendingParticipantIdentity===e);if(a.length>0||o.length>0){const c=new qe("Participant ".concat(e," unexpectedly disconnected in the middle of sending data"),Ie.AbnormalEnd);for(const[l,u]of o)(i=(t=u.outOfBandFailureRejectingFuture).reject)===null||i===void 0||i.call(t,c),this.byteStreamControllers.delete(l);for(const[l,u]of a)(s=(r=u.outOfBandFailureRejectingFuture).reject)===null||s===void 0||s.call(r,c),this.textStreamControllers.delete(l)}}handleDataStreamPacket(e,t){return S(this,void 0,void 0,function*(){switch(e.value.case){case"streamHeader":return this.handleStreamHeader(e.value.value,e.participantIdentity,t);case"streamChunk":return this.handleStreamChunk(e.value.value,t);case"streamTrailer":return this.handleStreamTrailer(e.value.value,t);default:throw new Error('DataPacket of value "'.concat(e.value.case,'" is not data stream related!'))}})}handleStreamHeader(e,t,i){return S(this,void 0,void 0,function*(){var r;if(e.contentHeader.case==="byteHeader"){const s=this.byteStreamHandlers.get(e.topic);if(!s){this.log.debug("ignoring incoming byte stream due to no handler for topic",e.topic);return}let a;const o=new We;o.promise.catch(u=>{this.log.error(u)});const c={id:e.streamId,name:(r=e.contentHeader.value.name)!==null&&r!==void 0?r:"unknown",mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:gi(e.timestamp),attributes:e.attributes,encryptionType:i},l=new ReadableStream({start:u=>{if(a=u,this.textStreamControllers.has(e.streamId))throw new qe("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),Ie.AlreadyOpened);this.byteStreamControllers.set(e.streamId,{info:c,controller:a,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:o})}});s(new Ep(c,l,gi(e.totalLength),o),{identity:t})}else if(e.contentHeader.case==="textHeader"){const s=this.textStreamHandlers.get(e.topic);if(!s){this.log.debug("ignoring incoming text stream due to no handler for topic",e.topic);return}let a;const o=new We;o.promise.catch(u=>{this.log.error(u)});const c={id:e.streamId,mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Number(e.timestamp),attributes:e.attributes,encryptionType:i},l=new ReadableStream({start:u=>{if(a=u,this.textStreamControllers.has(e.streamId))throw new qe("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),Ie.AlreadyOpened);this.textStreamControllers.set(e.streamId,{info:c,controller:a,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:o})}});s(new wp(c,l,gi(e.totalLength),o),{identity:t})}})}handleStreamChunk(e,t){const i=this.byteStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?(i.controller.error(new qe("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),Ie.EncryptionTypeMismatch)),this.byteStreamControllers.delete(e.streamId)):e.content.length>0&&i.controller.enqueue(e));const r=this.textStreamControllers.get(e.streamId);r&&(r.info.encryptionType!==t?(r.controller.error(new qe("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(r.info.encryptionType),Ie.EncryptionTypeMismatch)),this.textStreamControllers.delete(e.streamId)):e.content.length>0&&r.controller.enqueue(e))}handleStreamTrailer(e,t){const i=this.textStreamControllers.get(e.streamId);i&&(i.info.encryptionType!==t?i.controller.error(new qe("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(i.info.encryptionType),Ie.EncryptionTypeMismatch)):(i.info.attributes=Object.assign(Object.assign({},i.info.attributes),e.attributes),i.controller.close(),this.textStreamControllers.delete(e.streamId)));const r=this.byteStreamControllers.get(e.streamId);r&&(r.info.encryptionType!==t?r.controller.error(new qe("Encryption type mismatch for stream ".concat(e.streamId,". Expected ").concat(t,", got ").concat(r.info.encryptionType),Ie.EncryptionTypeMismatch)):(r.info.attributes=Object.assign(Object.assign({},r.info.attributes),e.attributes),r.controller.close()),this.byteStreamControllers.delete(e.streamId))}}class Rl{constructor(e,t,i){this.writableStream=e,this.defaultWriter=e.getWriter(),this.onClose=i,this.info=t}write(e){return this.defaultWriter.write(e)}close(){return S(this,void 0,void 0,function*(){var e;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),(e=this.onClose)===null||e===void 0||e.call(this)})}}class Rp extends Rl{}class _p extends Rl{}const la=15e3;class Ip{constructor(e,t){this.engine=e,this.log=t}setupEngine(e){this.engine=e}sendText(e,t){return S(this,void 0,void 0,function*(){var i;const r=crypto.randomUUID(),a=new TextEncoder().encode(e).byteLength,o=(i=t?.attachments)===null||i===void 0?void 0:i.map(()=>crypto.randomUUID()),c=new Array(o?o.length+1:1).fill(0),l=(d,h)=>{var p;c[h]=d;const b=c.reduce((m,T)=>m+T,0);(p=t?.onProgress)===null||p===void 0||p.call(t,b)},u=yield this.streamText({streamId:r,totalSize:a,destinationIdentities:t?.destinationIdentities,topic:t?.topic,attachedStreamIds:o,attributes:t?.attributes});return yield u.write(e),l(1,0),yield u.close(),t?.attachments&&o&&(yield Promise.all(t.attachments.map((d,h)=>S(this,void 0,void 0,function*(){return this._sendFile(o[h],d,{topic:t.topic,mimeType:d.type,onProgress:p=>{l(p,h+1)}})})))),u.info})}streamText(e){return S(this,void 0,void 0,function*(){var t,i,r;const s=(t=e?.streamId)!==null&&t!==void 0?t:crypto.randomUUID(),a={id:s,mimeType:"text/plain",timestamp:Date.now(),topic:(i=e?.topic)!==null&&i!==void 0?i:"",size:e?.totalSize,attributes:e?.attributes,encryptionType:!((r=this.engine.e2eeManager)===null||r===void 0)&&r.isDataChannelEncryptionEnabled?be.GCM:be.NONE},o=new Ti({streamId:s,mimeType:a.mimeType,topic:a.topic,timestamp:Wt(a.timestamp),totalLength:Wt(e?.totalSize),attributes:a.attributes,contentHeader:{case:"textHeader",value:new Sc({version:e?.version,attachedStreamIds:e?.attachedStreamIds,replyToStreamId:e?.replyToStreamId,operationType:e?.type==="update"?xr.UPDATE:xr.CREATE})}}),c=e?.destinationIdentities,l=new Oe({destinationIdentities:c,value:{case:"streamHeader",value:o}});yield this.engine.sendDataPacket(l,$.RELIABLE);let u=0;const d=this.engine,h=new WritableStream({write(m){return S(this,void 0,void 0,function*(){for(const T of kf(m,la)){const k=new Ci({content:T,streamId:s,chunkIndex:Wt(u)}),w=new Oe({destinationIdentities:c,value:{case:"streamChunk",value:k}});yield d.sendDataPacket(w,$.RELIABLE),u+=1}})},close(){return S(this,void 0,void 0,function*(){const m=new Ei({streamId:s}),T=new Oe({destinationIdentities:c,value:{case:"streamTrailer",value:m}});yield d.sendDataPacket(T,$.RELIABLE)})},abort(m){console.log("Sink error:",m)}});let p=()=>S(this,void 0,void 0,function*(){yield b.close()});d.once(F.Closing,p);const b=new Rp(h,a,()=>this.engine.off(F.Closing,p));return b})}sendFile(e,t){return S(this,void 0,void 0,function*(){const i=crypto.randomUUID();return yield this._sendFile(i,e,t),{id:i}})}_sendFile(e,t,i){return S(this,void 0,void 0,function*(){var r;const s=yield this.streamBytes({streamId:e,totalSize:t.size,name:t.name,mimeType:(r=i?.mimeType)!==null&&r!==void 0?r:t.type,topic:i?.topic,destinationIdentities:i?.destinationIdentities}),a=t.stream().getReader();for(;;){const{done:o,value:c}=yield a.read();if(o)break;yield s.write(c)}return yield s.close(),s.info})}streamBytes(e){return S(this,void 0,void 0,function*(){var t,i,r,s,a,o;const c=(t=e?.streamId)!==null&&t!==void 0?t:crypto.randomUUID(),l=e?.destinationIdentities,u={id:c,mimeType:(i=e?.mimeType)!==null&&i!==void 0?i:"application/octet-stream",topic:(r=e?.topic)!==null&&r!==void 0?r:"",timestamp:Date.now(),attributes:e?.attributes,size:e?.totalSize,name:(s=e?.name)!==null&&s!==void 0?s:"unknown",encryptionType:!((a=this.engine.e2eeManager)===null||a===void 0)&&a.isDataChannelEncryptionEnabled?be.GCM:be.NONE},d=new Ti({totalLength:Wt((o=u.size)!==null&&o!==void 0?o:0),mimeType:u.mimeType,streamId:c,topic:u.topic,timestamp:Wt(Date.now()),attributes:u.attributes,contentHeader:{case:"byteHeader",value:new Tc({name:u.name})}}),h=new Oe({destinationIdentities:l,value:{case:"streamHeader",value:d}});yield this.engine.sendDataPacket(h,$.RELIABLE);let p=0;const b=new xe,m=this.engine,T=this.log,k=new WritableStream({write(M){return S(this,void 0,void 0,function*(){const v=yield b.lock();let g=0;try{for(;g<M.byteLength;){const y=M.slice(g,g+la),C=new Oe({destinationIdentities:l,value:{case:"streamChunk",value:new Ci({content:y,streamId:c,chunkIndex:Wt(p)})}});yield m.sendDataPacket(C,$.RELIABLE),p+=1,g+=y.byteLength}}finally{v()}})},close(){return S(this,void 0,void 0,function*(){const M=new Ei({streamId:c}),v=new Oe({destinationIdentities:l,value:{case:"streamTrailer",value:M}});yield m.sendDataPacket(v,$.RELIABLE)})},abort(M){T.error("Sink error:",M)}});return new _p(k,u)})}}class _l extends P{constructor(e,t,i,r,s){super(e,i,s),this.sid=t,this.receiver=r}get isLocal(){return!1}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?U.Muted:U.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const t=i=>{i.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",t),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(U.Ended,this))};e.addEventListener("removetrack",t)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return S(this,void 0,void 0,function*(){var e;return!((e=this.receiver)===null||e===void 0)&&e.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),Ls)),Qh()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var t;this.timeSyncHandle=requestAnimationFrame(()=>e());const i=(t=this.receiver)===null||t===void 0?void 0:t.getSynchronizationSources()[0];if(i){const{timestamp:r,rtpTimestamp:s}=i;s&&this.rtpTimestamp!==s&&(this.emit(U.TimeSyncUpdate,{timestamp:r,rtpTimestamp:s}),this.rtpTimestamp=s)}};e()}}class Il extends _l{constructor(e,t,i,r,s,a){super(e,t,P.Kind.Audio,i,a),this.monitorReceiver=()=>S(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const o=yield this.getReceiverStats();o&&this.prevStats&&this.receiver&&(this._currentBitrate=Ki(o,this.prevStats)),this.prevStats=o}),this.audioContext=r,this.webAudioPluginNodes=[],s&&(this.sinkId=s.deviceId)}setVolume(e){var t;for(const i of this.attachedElements)this.audioContext?(t=this.gainNode)===null||t===void 0||t.gain.setTargetAtTime(e,0,.1):i.volume=e;lt()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(lt())return 1;let e=0;return this.attachedElements.forEach(t=>{t.volume>e&&(e=t.volume)}),e}setSinkId(e){return S(this,void 0,void 0,function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map(t=>{if(Gr(t))return t.setSinkId(e)}))})}attach(e){const t=this.attachedElements.length===0;return e?super.attach(e):e=super.attach(),this.sinkId&&Gr(e)&&e.setSinkId(this.sinkId).catch(i=>{this.log.error("Failed to set sink id on remote audio track",i,this.logContext)}),this.audioContext&&t&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let t;return e?(t=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(t=super.detach(),this.disconnectWebAudio()),t}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(t.srcObject);let i=this.sourceNode;this.webAudioPluginNodes.forEach(r=>{i.connect(r),i=r}),this.gainNode=e.createGain(),i.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),e.state!=="running"&&e.resume().then(()=>{e.state!=="running"&&this.emit(U.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(r=>{this.emit(U.AudioPlaybackFailed,r)})}disconnectWebAudio(){var e,t;(e=this.gainNode)===null||e===void 0||e.disconnect(),(t=this.sourceNode)===null||t===void 0||t.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return S(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t;return e.forEach(i=>{i.type==="inbound-rtp"&&(t={type:"audio",streamId:i.id,timestamp:i.timestamp,jitter:i.jitter,bytesReceived:i.bytesReceived,concealedSamples:i.concealedSamples,concealmentEvents:i.concealmentEvents,silentConcealedSamples:i.silentConcealedSamples,silentConcealmentEvents:i.silentConcealmentEvents,totalAudioEnergy:i.totalAudioEnergy,totalSamplesDuration:i.totalSamplesDuration})}),t})}}const Tr=100;class Op extends _l{constructor(e,t,i,r,s){super(e,t,P.Kind.Video,i,s),this.elementInfos=[],this.monitorReceiver=()=>S(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const a=yield this.getReceiverStats();a&&this.prevStats&&this.receiver&&(this._currentBitrate=Ki(a,this.prevStats)),this.prevStats=a}),this.debouncedHandleResize=xs(()=>{this.updateDimensions()},Tr),this.adaptiveStreamSettings=r}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}setStreamState(e){super.setStreamState(e),this.log.debug("setStreamState",e),this.isAdaptiveStream&&e===P.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach(t=>{e?ln(this._mediaStreamTrack,t):nn(this._mediaStreamTrack,t)})}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(t=>t.element===e)===void 0){const t=new xp(e);this.observeElementInfo(t)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&this.elementInfos.find(t=>t===e)===void 0?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const t=this.elementInfos.filter(i=>i===e);for(const i of t)i.stopObserving();this.elementInfos=this.elementInfos.filter(i=>i!==e),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let t=[];if(e)return this.stopObservingElement(e),super.detach(e);t=super.detach();for(const i of t)this.stopObservingElement(i);return t}getDecoderImplementation(){var e;return(e=this.prevStats)===null||e===void 0?void 0:e.decoderImplementation}getReceiverStats(){return S(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t,i="",r=new Map;return e.forEach(s=>{s.type==="inbound-rtp"?(i=s.codecId,t={type:"video",streamId:s.id,framesDecoded:s.framesDecoded,framesDropped:s.framesDropped,framesReceived:s.framesReceived,packetsReceived:s.packetsReceived,packetsLost:s.packetsLost,frameWidth:s.frameWidth,frameHeight:s.frameHeight,pliCount:s.pliCount,firCount:s.firCount,nackCount:s.nackCount,jitter:s.jitter,timestamp:s.timestamp,bytesReceived:s.bytesReceived,decoderImplementation:s.decoderImplementation}):s.type==="codec"&&r.set(s.id,s)}),t&&i!==""&&r.get(i)&&(t.mimeType=r.get(i).mimeType),t})}stopObservingElement(e){const t=this.elementInfos.filter(i=>i.element===e);for(const i of t)this.stopObservingElementInfo(i)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return S(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(e){var t,i;const r=this.elementInfos.reduce((c,l)=>Math.max(c,l.visibilityChangedAt||0),0),s=!((i=(t=this.adaptiveStreamSettings)===null||t===void 0?void 0:t.pauseVideoInBackground)!==null&&i!==void 0)||i?this.isInBackground:!1,a=this.elementInfos.some(c=>c.pictureInPicture),o=this.elementInfos.some(c=>c.visible)&&!s||a;if(!(this.lastVisible===o&&!e)){if(!o&&Date.now()-r<Tr){Pe.setTimeout(()=>{this.updateVisibility()},Tr);return}this.lastVisible=o,this.emit(U.VisibilityChanged,o,this)}}updateDimensions(){var e,t;let i=0,r=0;const s=this.getPixelDensity();for(const a of this.elementInfos){const o=a.width()*s,c=a.height()*s;o+c>i+r&&(i=o,r=c)}((e=this.lastDimensions)===null||e===void 0?void 0:e.width)===i&&((t=this.lastDimensions)===null||t===void 0?void 0:t.height)===r||(this.lastDimensions={width:i,height:r},this.emit(U.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const t=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pixelDensity;return t==="screen"?Uo():t||(Uo()>2?2:1)}}class xp{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=i=>{var r;const{target:s,isIntersecting:a}=i;s===this.element&&(this.isIntersecting=a,this.isPiP=Rn(this.element),this.visibilityChangedAt=Date.now(),(r=this.handleVisibilityChanged)===null||r===void 0||r.call(this))},this.onEnterPiP=()=>{var i,r,s;(r=(i=window.documentPictureInPicture)===null||i===void 0?void 0:i.window)===null||r===void 0||r.addEventListener("pagehide",this.onLeavePiP),this.isPiP=Rn(this.element),(s=this.handleVisibilityChanged)===null||s===void 0||s.call(this)},this.onLeavePiP=()=>{var i;this.isPiP=Rn(this.element),(i=this.handleVisibilityChanged)===null||i===void 0||i.call(this)},this.element=e,this.isIntersecting=t??Zr(e),this.isPiP=Ne()&&Rn(e),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var e,t,i;this.isIntersecting=Zr(this.element),this.isPiP=Rn(this.element),this.element.handleResize=()=>{var r;(r=this.handleResize)===null||r===void 0||r.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,jo().observe(this.element),Fo().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),(e=window.documentPictureInPicture)===null||e===void 0||e.addEventListener("enter",this.onEnterPiP),(i=(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window)===null||i===void 0||i.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var e,t,i,r,s;(e=jo())===null||e===void 0||e.unobserve(this.element),(t=Fo())===null||t===void 0||t.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),(i=window.documentPictureInPicture)===null||i===void 0||i.removeEventListener("enter",this.onEnterPiP),(s=(r=window.documentPictureInPicture)===null||r===void 0?void 0:r.window)===null||s===void 0||s.removeEventListener("pagehide",this.onLeavePiP)}}function Rn(n){var e,t;return document.pictureInPictureElement===n?!0:!((e=window.documentPictureInPicture)===null||e===void 0)&&e.window?Zr(n,(t=window.documentPictureInPicture)===null||t===void 0?void 0:t.window):!1}function Zr(n,e){const t=e||window;let i=n.offsetTop,r=n.offsetLeft;const s=n.offsetWidth,a=n.offsetHeight,{hidden:o}=n,{display:c}=getComputedStyle(n);for(;n.offsetParent;)n=n.offsetParent,i+=n.offsetTop,r+=n.offsetLeft;return i<t.pageYOffset+t.innerHeight&&r<t.pageXOffset+t.innerWidth&&i+a>t.pageYOffset&&r+s>t.pageXOffset&&!o&&c!=="none"}class vt extends dt.EventEmitter{constructor(e,t,i,r){var s;super(),this.metadataMuted=!1,this.encryption=be.NONE,this.log=K,this.handleMuted=()=>{this.emit(U.Muted)},this.handleUnmuted=()=>{this.emit(U.Unmuted)},this.log=Tt((s=r?.loggerName)!==null&&s!==void 0?s:Qe.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=t,this.trackName=i,this.source=P.Source.Unknown}setTrack(e){this.track&&(this.track.off(U.Muted,this.handleMuted),this.track.off(U.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(U.Muted,this.handleMuted),e.on(U.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),J(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==be.NONE}get audioTrack(){if(at(this.track))return this.track}get videoTrack(){if(Bt(this.track))return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=P.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===P.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}(function(n){(function(e){e.Desired="desired",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed"})(n.SubscriptionStatus||(n.SubscriptionStatus={})),(function(e){e.Allowed="allowed",e.NotAllowed="not_allowed"})(n.PermissionStatus||(n.PermissionStatus={}))})(vt||(vt={}));class Ri extends vt{get isUpstreamPaused(){var e;return(e=this.track)===null||e===void 0?void 0:e.isUpstreamPaused}constructor(e,t,i,r){super(e,t.sid,t.name,r),this.track=void 0,this.handleTrackEnded=()=>{this.emit(U.Ended)},this.handleCpuConstrained=()=>{this.track&&Bt(this.track)&&this.emit(U.CpuConstrained,this.track)},this.updateInfo(t),this.setTrack(i)}setTrack(e){this.track&&(this.track.off(U.Ended,this.handleTrackEnded),this.track.off(U.CpuConstrained,this.handleCpuConstrained)),super.setTrack(e),e&&(e.on(U.Ended,this.handleTrackEnded),e.on(U.CpuConstrained,this.handleCpuConstrained))}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return S(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.mute()})}unmute(){return S(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.unmute()})}pauseUpstream(){return S(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.pauseUpstream()})}resumeUpstream(){return S(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.resumeUpstream()})}getTrackFeatures(){var e;if(at(this.track)){const t=this.track.getSourceTrackSettings(),i=new Set;return t.autoGainControl&&i.add(Te.TF_AUTO_GAIN_CONTROL),t.echoCancellation&&i.add(Te.TF_ECHO_CANCELLATION),t.noiseSuppression&&i.add(Te.TF_NOISE_SUPPRESSION),t.channelCount&&t.channelCount>1&&i.add(Te.TF_STEREO),!((e=this.options)===null||e===void 0)&&e.dtx||i.add(Te.TF_NO_DTX),this.track.enhancedNoiseCancellation&&i.add(Te.TF_ENHANCED_NOISE_CANCELLATION),Array.from(i.values())}else return[]}}function zi(n,e){return S(this,void 0,void 0,function*(){n??(n={});let t=!1;const{audioProcessor:i,videoProcessor:r,optionsWithoutProcessor:s}=pl(n);let a=s.audio,o=s.video;if(i&&typeof s.audio=="object"&&(s.audio.processor=i),r&&typeof s.video=="object"&&(s.video.processor=r),n.audio&&typeof s.audio=="object"&&typeof s.audio.deviceId=="string"){const d=s.audio.deviceId;s.audio.deviceId={exact:d},t=!0,a=Object.assign(Object.assign({},s.audio),{deviceId:{ideal:d}})}if(s.video&&typeof s.video=="object"&&typeof s.video.deviceId=="string"){const d=s.video.deviceId;s.video.deviceId={exact:d},t=!0,o=Object.assign(Object.assign({},s.video),{deviceId:{ideal:d}})}s.audio===!0?s.audio={deviceId:"default"}:typeof s.audio=="object"&&s.audio!==null&&(s.audio=Object.assign(Object.assign({},s.audio),{deviceId:s.audio.deviceId||"default"})),s.video===!0?s.video={deviceId:"default"}:typeof s.video=="object"&&!s.video.deviceId&&(s.video.deviceId="default");const c=dl(s,yl,kl),l=Rs(c),u=navigator.mediaDevices.getUserMedia(l);s.audio&&(Ce.userMediaPromiseMap.set("audioinput",u),u.catch(()=>Ce.userMediaPromiseMap.delete("audioinput"))),s.video&&(Ce.userMediaPromiseMap.set("videoinput",u),u.catch(()=>Ce.userMediaPromiseMap.delete("videoinput")));try{const d=yield u;return yield Promise.all(d.getTracks().map(h=>S(this,void 0,void 0,function*(){const p=h.kind==="audio";let b=p?c.audio:c.video;(typeof b=="boolean"||!b)&&(b={});let m;const T=p?l.audio:l.video;typeof T!="boolean"&&(m=T);const k=h.getSettings().deviceId;m?.deviceId&&Dt(m.deviceId)!==k?m.deviceId=k:m||(m={deviceId:k});const w=op(h,m,e);return w.kind===P.Kind.Video?w.source=P.Source.Camera:w.kind===P.Kind.Audio&&(w.source=P.Source.Microphone),w.mediaStream=d,at(w)&&i?yield w.setProcessor(i):Bt(w)&&r&&(yield w.setProcessor(r)),w})))}catch(d){if(!t)throw d;return zi(Object.assign(Object.assign({},n),{audio:a,video:o}),e)}})}function Mp(n){return S(this,void 0,void 0,function*(){return(yield zi({audio:!1,video:!0}))[0]})}function Ap(n){return S(this,void 0,void 0,function*(){return(yield zi({audio:!0,video:!1}))[0]})}var Je;(function(n){n.Excellent="excellent",n.Good="good",n.Poor="poor",n.Lost="lost",n.Unknown="unknown"})(Je||(Je={}));function Dp(n){switch(n){case On.EXCELLENT:return Je.Excellent;case On.GOOD:return Je.Good;case On.POOR:return Je.Poor;case On.LOST:return Je.Lost;default:return Je.Unknown}}class Ol extends dt.EventEmitter{get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions)===null||e===void 0?void 0:e.loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(e=>e.isEncrypted)}get isAgent(){var e;return((e=this.permissions)===null||e===void 0?void 0:e.agent)||this.kind===Un.AGENT}get isActive(){var e;return((e=this.participantInfo)===null||e===void 0?void 0:e.state)===sn.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,t,i,r,s,a){let o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:Un.STANDARD;var c;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=Je.Unknown,this.log=K,this.log=Tt((c=a?.loggerName)!==null&&c!==void 0?c:Qe.Participant),this.loggerOptions=a,this.setMaxListeners(100),this.sid=e,this.identity=t,this.name=i,this.metadata=r,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=o,this._attributes=s??{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,t]of this.trackPublications)if(t.source===e)return t}getTrackPublicationByName(e){for(const[,t]of this.trackPublications)if(t.trackName===e)return t}waitUntilActive(){return this.isActive?Promise.resolve():this.activeFuture?this.activeFuture.promise:(this.activeFuture=new We,this.once(A.Active,()=>{var e,t;(t=(e=this.activeFuture)===null||e===void 0?void 0:e.resolve)===null||t===void 0||t.call(e),this.activeFuture=void 0}),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrackPublication(P.Source.Camera);return!(!((e=t?.isMuted)!==null&&e!==void 0)||e)}get isMicrophoneEnabled(){var e;const t=this.getTrackPublication(P.Source.Microphone);return!(!((e=t?.isMuted)!==null&&e!==void 0)||e)}get isScreenShareEnabled(){return!!this.getTrackPublication(P.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(e){var t;return this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version?!1:(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),this._setAttributes(e.attributes),e.state===sn.ACTIVE&&((t=this.participantInfo)===null||t===void 0?void 0:t.state)!==sn.ACTIVE&&this.emit(A.Active),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,!0)}_setMetadata(e){const t=this.metadata!==e,i=this.metadata;this.metadata=e,t&&this.emit(A.ParticipantMetadataChanged,i)}_setName(e){const t=this.name!==e;this.name=e,t&&this.emit(A.ParticipantNameChanged,e)}_setAttributes(e){const t=Xh(this.attributes,e);this._attributes=e,Object.keys(t).length>0&&this.emit(A.AttributesChanged,t)}setPermissions(e){var t,i,r,s,a,o;const c=this.permissions,l=e.canPublish!==((t=this.permissions)===null||t===void 0?void 0:t.canPublish)||e.canSubscribe!==((i=this.permissions)===null||i===void 0?void 0:i.canSubscribe)||e.canPublishData!==((r=this.permissions)===null||r===void 0?void 0:r.canPublishData)||e.hidden!==((s=this.permissions)===null||s===void 0?void 0:s.hidden)||e.recorder!==((a=this.permissions)===null||a===void 0?void 0:a.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some((u,d)=>{var h;return u!==((h=this.permissions)===null||h===void 0?void 0:h.canPublishSources[d])})||e.canSubscribeMetrics!==((o=this.permissions)===null||o===void 0?void 0:o.canSubscribeMetrics);return this.permissions=e,l&&this.emit(A.ParticipantPermissionsChanged,c),l}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(A.IsSpeakingChanged,e))}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=Dp(e),t!==this._connectionQuality&&this.emit(A.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var e,t;this.activeFuture&&((t=(e=this.activeFuture).reject)===null||t===void 0||t.call(e,new Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext(e){this.audioContext=e,this.audioTrackPublications.forEach(t=>at(t.track)&&t.track.setAudioContext(e))}addTrackPublication(e){e.on(U.Muted,()=>{this.emit(A.TrackMuted,e)}),e.on(U.Unmuted,()=>{this.emit(A.TrackUnmuted,e)});const t=e;switch(t.track&&(t.track.sid=e.trackSid),this.trackPublications.set(e.trackSid,e),e.kind){case P.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case P.Kind.Video:this.videoTrackPublications.set(e.trackSid,e);break}}}function Lp(n){var e,t,i;if(!n.participantSid&&!n.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new Rc({participantIdentity:(e=n.participantIdentity)!==null&&e!==void 0?e:"",participantSid:(t=n.participantSid)!==null&&t!==void 0?t:"",allTracks:(i=n.allowAll)!==null&&i!==void 0?i:!1,trackSids:n.allowedTrackSids||[]})}class Np extends Ol{constructor(e,t,i,r,s,a){super(e,t,void 0,void 0,void 0,{loggerName:r.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=be.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new We)},this.handleReconnected=()=>{var o,c;(c=(o=this.reconnectFuture)===null||o===void 0?void 0:o.resolve)===null||c===void 0||c.call(o),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleClosing=()=>{var o,c,l,u,d,h;this.reconnectFuture&&(this.reconnectFuture.promise.catch(p=>this.log.warn(p.message,this.logContext)),(c=(o=this.reconnectFuture)===null||o===void 0?void 0:o.reject)===null||c===void 0||c.call(o,new Error("Got disconnected during reconnection attempt")),this.reconnectFuture=void 0),this.signalConnectedFuture&&((u=(l=this.signalConnectedFuture).reject)===null||u===void 0||u.call(l,new Error("Got disconnected without signal connected")),this.signalConnectedFuture=void 0),(h=(d=this.activeAgentFuture)===null||d===void 0?void 0:d.reject)===null||h===void 0||h.call(d,new Error("Got disconnected without active agent present")),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=o=>{var c,l;o.participant&&this.updateInfo(o.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new We),(l=(c=this.signalConnectedFuture).resolve)===null||l===void 0||l.call(c)},this.handleSignalRequestResponse=o=>{const{requestId:c,reason:l,message:u}=o,d=this.pendingSignalRequests.get(c);d&&(l!==Cs.OK&&d.reject(new Mo(u,l)),this.pendingSignalRequests.delete(c))},this.handleDataPacket=o=>{switch(o.value.case){case"rpcResponse":let c=o.value.value,l=null,u=null;c.value.case==="payload"?l=c.value.value:c.value.case==="error"&&(u=de.fromProto(c.value.value)),this.handleIncomingRpcResponse(c.requestId,l,u);break;case"rpcAck":let d=o.value.value;this.handleIncomingRpcAck(d.requestId);break}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(o=>Lp(o)))},this.onTrackUnmuted=o=>{this.onTrackMuted(o,o.isUpstreamPaused)},this.onTrackMuted=(o,c)=>{if(c===void 0&&(c=!0),!o.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),J(o)));return}this.engine.updateMuteStatus(o.sid,c)},this.onTrackUpstreamPaused=o=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),J(o))),this.onTrackMuted(o,!0)},this.onTrackUpstreamResumed=o=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),J(o))),this.onTrackMuted(o,o.isMuted)},this.onTrackFeatureUpdate=o=>{const c=this.audioTrackPublications.get(o.sid);if(!c){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(o.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(c.trackSid,c.getTrackFeatures())},this.onTrackCpuConstrained=(o,c)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),J(c))),this.emit(A.LocalTrackCpuConstrained,o,c)},this.handleSubscribedQualityUpdate=o=>S(this,void 0,void 0,function*(){var c,l,u,d,h;if(!(!((h=this.roomOptions)===null||h===void 0)&&h.dynacast))return;const p=this.videoTrackPublications.get(o.trackSid);if(!p){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:o.trackSid}));return}if(!p.videoTrack)return;const b=yield p.videoTrack.setPublishingCodecs(o.subscribedCodecs);try{for(var m=!0,T=kt(b),k;k=yield T.next(),c=k.done,!c;m=!0){d=k.value,m=!1;const w=d;Gh(w)&&(this.log.debug("publish ".concat(w," for ").concat(p.videoTrack.sid),Object.assign(Object.assign({},this.logContext),J(p))),yield this.publishAdditionalCodecForTrack(p.videoTrack,w,p.options))}}catch(w){l={error:w}}finally{try{!m&&!c&&(u=T.return)&&(yield u.call(T))}finally{if(l)throw l.error}}}),this.handleLocalTrackUnpublished=o=>{const c=this.trackPublications.get(o.trackSid);if(!c){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:o.trackSid}));return}this.unpublishTrack(c.track)},this.handleTrackEnded=o=>S(this,void 0,void 0,function*(){if(o.source===P.Source.ScreenShare||o.source===P.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),J(o))),this.unpublishTrack(o);else if(o.isUserProvided)yield o.mute();else if(gt(o)||_t(o))try{if(Ne())try{const c=yield navigator?.permissions.query({name:o.source===P.Source.Camera?"camera":"microphone"});if(c&&c.state==="denied")throw this.log.warn("user has revoked access to ".concat(o.source),Object.assign(Object.assign({},this.logContext),J(o))),c.onchange=()=>{c.state!=="denied"&&(o.isMuted||o.restartTrack(),c.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}o.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),J(o))),gt(o)?yield o.restartTrack({deviceId:"default"}):yield o.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),J(o))),yield o.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=i,this.roomOptions=r,this.setupEngine(i),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=s,this.roomOutgoingDataStreamManager=a}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==be.NONE}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setupEngine(e){var t;this.engine=e,this.engine.on(F.RemoteMute,(i,r)=>{const s=this.trackPublications.get(i);!s||!s.track||(r?s.mute():s.unmute())}),!((t=this.signalConnectedFuture)===null||t===void 0)&&t.isResolved&&(this.signalConnectedFuture=void 0),this.engine.on(F.Connected,this.handleReconnected).on(F.SignalConnected,this.handleSignalConnected).on(F.SignalRestarted,this.handleReconnected).on(F.SignalResumed,this.handleReconnected).on(F.Restarting,this.handleReconnecting).on(F.Resuming,this.handleReconnecting).on(F.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(F.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(F.Closing,this.handleClosing).on(F.SignalRequestResponse,this.handleSignalRequestResponse).on(F.DataPacketReceived,this.handleDataPacket)}setMetadata(e){return S(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:e})})}setName(e){return S(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:e})})}setAttributes(e){return S(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:e})})}requestMetadataUpdate(e){return S(this,arguments,void 0,function(t){var i=this;let{metadata:r,name:s,attributes:a}=t;return(function*(){return new Le((o,c)=>S(i,void 0,void 0,function*(){var l,u;try{let d=!1;const h=yield this.engine.client.sendUpdateLocalMetadata((l=r??this.metadata)!==null&&l!==void 0?l:"",(u=s??this.name)!==null&&u!==void 0?u:"",a),p=performance.now();for(this.pendingSignalRequests.set(h,{resolve:o,reject:b=>{c(b),d=!0},values:{name:s,metadata:r,attributes:a}});performance.now()-p<5e3&&!d;){if((!s||this.name===s)&&(!r||this.metadata===r)&&(!a||Object.entries(a).every(b=>{let[m,T]=b;return this.attributes[m]===T||T===""&&!this.attributes[m]}))){this.pendingSignalRequests.delete(h),o();return}yield Re(50)}c(new Mo("Request to update local metadata timed out","TimeoutError"))}catch(d){d instanceof Error?c(d):c(new Error(String(d)))}}))})()})}setCameraEnabled(e,t,i){return this.setTrackEnabled(P.Source.Camera,e,t,i)}setMicrophoneEnabled(e,t,i){return this.setTrackEnabled(P.Source.Microphone,e,t,i)}setScreenShareEnabled(e,t,i){return this.setTrackEnabled(P.Source.ScreenShare,e,t,i)}setE2EEEnabled(e){return S(this,void 0,void 0,function*(){this.encryptionType=e?be.GCM:be.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(e,t,i,r){return S(this,void 0,void 0,function*(){var s,a;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t})),this.republishPromise&&(yield this.republishPromise);let o=this.getTrackPublication(e);if(t)if(o)yield o.unmute();else{let c;if(this.pendingPublishing.has(e)){const l=yield this.waitForPendingPublicationOfSource(e);return l||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e})),yield l?.unmute(),l}this.pendingPublishing.add(e);try{switch(e){case P.Source.Camera:c=yield this.createTracks({video:(s=i)!==null&&s!==void 0?s:!0});break;case P.Source.Microphone:c=yield this.createTracks({audio:(a=i)!==null&&a!==void 0?a:!0});break;case P.Source.ScreenShare:c=yield this.createScreenTracks(Object.assign({},i));break;default:throw new St(e)}}catch(l){throw c?.forEach(u=>{u.stop()}),l instanceof Error&&this.emit(A.MediaDevicesError,l,Hr(e)),this.pendingPublishing.delete(e),l}for(const l of c){const u=Object.assign(Object.assign({},this.roomOptions.publishDefaults),i);e===P.Source.Microphone&&at(l)&&u.preConnectBuffer&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),l.startPreConnectBuffer())}try{const l=[];for(const d of c)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),J(d))),l.push(this.publishTrack(d,r));[o]=yield Promise.all(l)}catch(l){throw c?.forEach(u=>{u.stop()}),l}finally{this.pendingPublishing.delete(e)}}else if(!o?.track&&this.pendingPublishing.has(e)&&(o=yield this.waitForPendingPublicationOfSource(e),o||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e}))),o&&o.track)if(e===P.Source.ScreenShare){o=yield this.unpublishTrack(o.track);const c=this.getTrackPublication(P.Source.ScreenShareAudio);c&&c.track&&this.unpublishTrack(c.track)}else yield o.mute();return o})}enableCameraAndMicrophone(){return S(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(P.Source.Camera)||this.pendingPublishing.has(P.Source.Microphone))){this.pendingPublishing.add(P.Source.Camera),this.pendingPublishing.add(P.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map(t=>this.publishTrack(t)))}finally{this.pendingPublishing.delete(P.Source.Camera),this.pendingPublishing.delete(P.Source.Microphone)}}})}createTracks(e){return S(this,void 0,void 0,function*(){var t,i;e??(e={});const r=dl(e,(t=this.roomOptions)===null||t===void 0?void 0:t.audioCaptureDefaults,(i=this.roomOptions)===null||i===void 0?void 0:i.videoCaptureDefaults);try{return(yield zi(r,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext})).map(o=>(at(o)&&(this.microphoneError=void 0,o.setAudioContext(this.audioContext),o.source=P.Source.Microphone,this.emit(A.AudioStreamAcquired)),Bt(o)&&(this.cameraError=void 0,o.source=P.Source.Camera),o))}catch(s){throw s instanceof Error&&(e.audio&&(this.microphoneError=s),e.video&&(this.cameraError=s)),s}})}createScreenTracks(e){return S(this,void 0,void 0,function*(){if(e===void 0&&(e={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new ws("getDisplayMedia not supported");e.resolution===void 0&&!cf()&&(e.resolution=Ps.h1080fps30.resolution);const t=Jh(e),i=yield navigator.mediaDevices.getDisplayMedia(t),r=i.getVideoTracks();if(r.length===0)throw new St("no video track found");const s=new Pi(r[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});s.source=P.Source.ScreenShare,e.contentHint&&(s.mediaStreamTrack.contentHint=e.contentHint);const a=[s];if(i.getAudioTracks().length>0){this.emit(A.AudioStreamAcquired);const o=new wi(i.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});o.source=P.Source.ScreenShareAudio,a.push(o)}return a})}publishTrack(e,t){return S(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(e,t)})}publishOrRepublishTrack(e,t){return S(this,arguments,void 0,function(i,r){var s=this;let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return(function*(){var o,c,l,u;gt(i)&&i.setAudioContext(s.audioContext),yield(o=s.reconnectFuture)===null||o===void 0?void 0:o.promise,s.republishPromise&&!a&&(yield s.republishPromise),Ht(i)&&s.pendingPublishPromises.has(i)&&(yield s.pendingPublishPromises.get(i));let d;if(i instanceof MediaStreamTrack)d=i.getConstraints();else{d=i.constraints;let k;switch(i.source){case P.Source.Microphone:k="audioinput";break;case P.Source.Camera:k="videoinput"}k&&s.activeDeviceMap.has(k)&&(d=Object.assign(Object.assign({},d),{deviceId:s.activeDeviceMap.get(k)}))}if(i instanceof MediaStreamTrack)switch(i.kind){case"audio":i=new wi(i,d,!0,s.audioContext,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;case"video":i=new Pi(i,d,!0,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;default:throw new St("unsupported MediaStreamTrack kind ".concat(i.kind))}else i.updateLoggerOptions({loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});let h;if(s.trackPublications.forEach(k=>{k.track&&k.track===i&&(h=k)}),h)return s.log.warn("track has already been published, skipping",Object.assign(Object.assign({},s.logContext),J(h))),h;const p=Object.assign(Object.assign({},s.roomOptions.publishDefaults),r),b="channelCount"in i.mediaStreamTrack.getSettings()&&i.mediaStreamTrack.getSettings().channelCount===2||i.mediaStreamTrack.getConstraints().channelCount===2,m=(c=p.forceStereo)!==null&&c!==void 0?c:b;m&&(p.dtx===void 0&&s.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},s.logContext),J(i))),p.red===void 0&&s.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(l=p.dtx)!==null&&l!==void 0||(p.dtx=!1),(u=p.red)!==null&&u!==void 0||(p.red=!1)),!uf()&&s.roomOptions.e2ee&&(s.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},s.logContext)),p.simulcast=!1),p.source&&(i.source=p.source);const T=new Promise((k,w)=>S(s,void 0,void 0,function*(){try{if(this.engine.client.currentState!==se.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:J(i)}));let M=!1;const v=setTimeout(()=>{M=!0,i.stop(),w(new xo("publishing rejected as engine not connected within timeout",408))},15e3);if(yield this.waitUntilEngineConnected(),clearTimeout(v),M)return;const g=yield this.publish(i,p,m);k(g)}else try{const M=yield this.publish(i,p,m);k(M)}catch(M){w(M)}}catch(M){w(M)}}));s.pendingPublishPromises.set(i,T);try{return yield T}catch(k){throw k}finally{s.pendingPublishPromises.delete(i)}})()})}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new We),this.signalConnectedFuture.promise}hasPermissionsToPublish(e){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),J(e))),!1;const{canPublish:t,canPublishSources:i}=this.permissions;return t&&(i.length===0||i.map(r=>Zh(r)).includes(e.source))?!0:(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),J(e))),!1)}publish(e,t,i){return S(this,void 0,void 0,function*(){var r,s,a,o,c,l,u,d,h,p;if(!this.hasPermissionsToPublish(e))throw new xo("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(_=>Ht(e)&&_.source===e.source)&&e.source!==P.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),J(e))),t.stopMicTrackOnMute&&at(e)&&(e.stopOnMute=!0),e.source===P.Source.ScreenShare&&Gt()&&(t.simulcast=!1),t.videoCodec==="av1"&&!sf()&&(t.videoCodec=void 0),t.videoCodec==="vp9"&&!of()&&(t.videoCodec=void 0),t.videoCodec===void 0&&(t.videoCodec=Yr),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(_=>t.videoCodec===Dn(_.mime))||(t.videoCodec=Dn(this.enabledPublishVideoCodecs[0].mime)));const m=t.videoCodec;e.on(U.Muted,this.onTrackMuted),e.on(U.Unmuted,this.onTrackUnmuted),e.on(U.Ended,this.handleTrackEnded),e.on(U.UpstreamPaused,this.onTrackUpstreamPaused),e.on(U.UpstreamResumed,this.onTrackUpstreamResumed),e.on(U.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const T=[],k=!(!((r=t.dtx)!==null&&r!==void 0)||r),w=e.getSourceTrackSettings();w.autoGainControl&&T.push(Te.TF_AUTO_GAIN_CONTROL),w.echoCancellation&&T.push(Te.TF_ECHO_CANCELLATION),w.noiseSuppression&&T.push(Te.TF_NOISE_SUPPRESSION),w.channelCount&&w.channelCount>1&&T.push(Te.TF_STEREO),k&&T.push(Te.TF_NO_DTX),gt(e)&&e.hasPreConnectBuffer&&T.push(Te.TF_PRECONNECT_BUFFER);const M=new Fn({cid:e.mediaStreamTrack.id,name:t.name,type:P.kindToProto(e.kind),muted:e.isMuted,source:P.sourceToProto(e.source),disableDtx:k,encryption:this.encryptionType,stereo:i,disableRed:this.isE2EEEnabled||!(!((s=t.red)!==null&&s!==void 0)||s),stream:t?.stream,backupCodecPolicy:t?.backupCodecPolicy,audioFeatures:T});let v;if(e.kind===P.Kind.Video){let _={width:0,height:0};try{_=yield e.waitForDimensions()}catch{const D=(o=(a=this.roomOptions.videoCaptureDefaults)===null||a===void 0?void 0:a.resolution)!==null&&o!==void 0?o:Bn.h720.resolution;_={width:D.width,height:D.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),J(e)),{dims:_}))}M.width=_.width,M.height=_.height,_t(e)&&($e(m)&&(e.source===P.Source.ScreenShare&&(t.scalabilityMode="L1T3","contentHint"in e.mediaStreamTrack&&(e.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),J(e))))),t.scalabilityMode=(c=t.scalabilityMode)!==null&&c!==void 0?c:"L3T3_KEY"),M.simulcastCodecs=[new Ar({codec:m,cid:e.mediaStreamTrack.id})],t.backupCodec===!0&&(t.backupCodec={codec:Yr}),t.backupCodec&&m!==t.backupCodec.codec&&M.encryption===be.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),M.simulcastCodecs.push(new Ar({codec:t.backupCodec.codec,cid:""})))),v=Xr(e.source===P.Source.ScreenShare,M.width,M.height,t),M.layers=sa(M.width,M.height,v,$e(t.videoCodec))}else e.kind===P.Kind.Audio&&(v=[{maxBitrate:(l=t.audioPreset)===null||l===void 0?void 0:l.maxBitrate,priority:(d=(u=t.audioPreset)===null||u===void 0?void 0:u.priority)!==null&&d!==void 0?d:"high",networkPriority:(p=(h=t.audioPreset)===null||h===void 0?void 0:h.priority)!==null&&p!==void 0?p:"high"}]);if(!this.engine||this.engine.isClosed)throw new he("cannot publish track when not connected");const g=()=>S(this,void 0,void 0,function*(){var _,O,D;if(!this.engine.pcManager)throw new he("pcManager is not ready");if(e.sender=yield this.engine.createSender(e,t,v),this.emit(A.LocalSenderCreated,e.sender,e),_t(e)&&((_=t.degradationPreference)!==null&&_!==void 0||(t.degradationPreference=gp(e)),e.setDegradationPreference(t.degradationPreference)),v)if(Gt()&&e.kind===P.Kind.Audio){let j;for(const z of this.engine.pcManager.publisher.getTransceivers())if(z.sender===e.sender){j=z;break}j&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:j,codec:"opus",maxbr:!((O=v[0])===null||O===void 0)&&O.maxBitrate?v[0].maxBitrate/1e3:0})}else e.codec&&$e(e.codec)&&(!((D=v[0])===null||D===void 0)&&D.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:M.cid,codec:e.codec,maxbr:v[0].maxBitrate/1e3});yield this.engine.negotiate()});let y;const C=new Promise((_,O)=>S(this,void 0,void 0,function*(){var D;try{y=yield this.engine.addTrack(M),_(y)}catch(j){e.sender&&(!((D=this.engine.pcManager)===null||D===void 0)&&D.publisher)&&(this.engine.pcManager.publisher.removeTrack(e.sender),yield this.engine.negotiate().catch(z=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),J(e)),{error:z}))})),O(j)}}));if(this.enabledPublishVideoCodecs.length>0)y=(yield Promise.all([C,g()]))[0];else{y=yield C;let _;if(y.codecs.forEach(O=>{_===void 0&&(_=O.mimeType)}),_&&e.kind===P.Kind.Video){const O=Dn(_);O!==m&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),J(e)),{codec:O})),t.videoCodec=O,v=Xr(e.source===P.Source.ScreenShare,M.width,M.height,t))}yield g()}const x=new Ri(e.kind,y,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(x.on(U.CpuConstrained,_=>this.onTrackCpuConstrained(_,x)),x.options=t,e.sid=y.sid,this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:v,trackInfo:y})),_t(e)?e.startMonitor(this.engine.client):gt(e)&&e.startMonitor(),this.addTrackPublication(x),this.emit(A.LocalTrackPublished,x),gt(e)&&y.audioFeatures.includes(Te.TF_PRECONNECT_BUFFER)){const _=e.getPreConnectBuffer(),O=e.getPreConnectBufferMimeType();this.on(A.LocalTrackSubscribed,D=>{if(D.trackSid===y.sid){if(!e.hasPreConnectBuffer){this.log.warn("subscribe event came to late, buffer already closed",this.logContext);return}this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),J(e))),e.stopPreConnectBuffer()}}),_&&new Promise((j,z)=>S(this,void 0,void 0,function*(){var ee,_e,te,re,Se,we;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),J(e)));const V=setTimeout(()=>{z(new Error("agent not active within 10 seconds"))},1e4),q=yield this.waitUntilActiveAgentPresent();clearTimeout(V),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),J(e)));const Q=yield this.streamBytes({name:"preconnect-buffer",mimeType:O,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[q.identity],attributes:{trackId:x.trackSid,sampleRate:String((Se=w.sampleRate)!==null&&Se!==void 0?Se:"48000"),channels:String((we=w.channelCount)!==null&&we!==void 0?we:"1")}});try{for(var mt=!0,E=kt(_),N;N=yield E.next(),ee=N.done,!ee;mt=!0){re=N.value,mt=!1;const X=re;yield Q.write(X)}}catch(X){_e={error:X}}finally{try{!mt&&!ee&&(te=E.return)&&(yield te.call(E))}finally{if(_e)throw _e.error}}yield Q.close(),j()}catch(V){z(V)}})).then(()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),J(e)))}).catch(j=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),J(e)),{error:j}))})}return x})}get isLocal(){return!0}publishAdditionalCodecForTrack(e,t,i){return S(this,void 0,void 0,function*(){var r;if(this.encryptionType!==be.NONE)return;let s;if(this.trackPublications.forEach(p=>{p.track&&p.track===e&&(s=p)}),!s)throw new St("track is not published");if(!_t(e))throw new St("track is not a video track");const a=Object.assign(Object.assign({},(r=this.roomOptions)===null||r===void 0?void 0:r.publishDefaults),i),o=fp(e,t,a);if(!o){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),J(e)));return}const c=e.addSimulcastTrack(t,o);if(!c)return;const l=new Fn({cid:c.mediaStreamTrack.id,type:P.kindToProto(e.kind),muted:e.isMuted,source:P.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:a.videoCodec,cid:c.mediaStreamTrack.id}]});if(l.layers=sa(l.width,l.height,o),!this.engine||this.engine.isClosed)throw new he("cannot publish track when not connected");const u=()=>S(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(e,c,a,o),yield this.engine.negotiate()}),h=(yield Promise.all([this.engine.addTrack(l),u()]))[0];this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:o,trackInfo:h}))})}unpublishTrack(e,t){return S(this,void 0,void 0,function*(){var i,r;if(Ht(e)){const l=this.pendingPublishPromises.get(e);l&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),J(e))),yield l)}const s=this.getPublicationForTrack(e),a=s?J(s):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),a)),!s||!s.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),a));return}e=s.track,e.off(U.Muted,this.onTrackMuted),e.off(U.Unmuted,this.onTrackUnmuted),e.off(U.Ended,this.handleTrackEnded),e.off(U.UpstreamPaused,this.onTrackUpstreamPaused),e.off(U.UpstreamResumed,this.onTrackUpstreamResumed),e.off(U.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),t===void 0&&(t=(r=(i=this.roomOptions)===null||i===void 0?void 0:i.stopLocalTrackOnUnpublish)!==null&&r!==void 0?r:!0),t?e.stop():e.stopMonitor();let o=!1;const c=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<le.FAILED&&c)try{for(const l of this.engine.pcManager.publisher.getTransceivers())l.sender===c&&(l.direction="inactive",o=!0);if(this.engine.removeTrack(c)&&(o=!0),_t(e)){for(const[,l]of e.simulcastCodecs)l.sender&&(this.engine.removeTrack(l.sender)&&(o=!0),l.sender=void 0);e.simulcastCodecs.clear()}}catch(l){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),a),{error:l}))}switch(this.trackPublications.delete(s.trackSid),s.kind){case P.Kind.Audio:this.audioTrackPublications.delete(s.trackSid);break;case P.Kind.Video:this.videoTrackPublications.delete(s.trackSid);break}return this.emit(A.LocalTrackUnpublished,s),s.setTrack(void 0),o&&(yield this.engine.negotiate()),s})}unpublishTracks(e){return S(this,void 0,void 0,function*(){return(yield Promise.all(e.map(i=>this.unpublishTrack(i)))).filter(i=>!!i)})}republishAllTracks(e){return S(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){i.republishPromise&&(yield i.republishPromise),i.republishPromise=new Le((s,a)=>S(i,void 0,void 0,function*(){try{const o=[];this.trackPublications.forEach(c=>{c.track&&(t&&(c.options=Object.assign(Object.assign({},c.options),t)),o.push(c))}),yield Promise.all(o.map(c=>S(this,void 0,void 0,function*(){const l=c.track;yield this.unpublishTrack(l,!1),r&&!l.isMuted&&l.source!==P.Source.ScreenShare&&l.source!==P.Source.ScreenShareAudio&&(gt(l)||_t(l))&&!l.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:c.trackSid})),yield l.restartTrack()),yield this.publishOrRepublishTrack(l,c.options,!0)}))),s()}catch(o){o instanceof Error?a(o):a(new Error(String(o)))}finally{this.republishPromise=void 0}})),yield i.republishPromise})()})}publishData(e){return S(this,arguments,void 0,function(t){var i=this;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return(function*(){const s=r.reliable?$.RELIABLE:$.LOSSY,a=r.destinationIdentities,o=r.topic;let c=new ps({participantIdentity:i.identity,payload:t,destinationIdentities:a,topic:o});const l=new Oe({kind:s,value:{case:"user",value:c}});yield i.engine.sendDataPacket(l,s)})()})}publishDtmf(e,t){return S(this,void 0,void 0,function*(){const i=new Oe({kind:$.RELIABLE,value:{case:"sipDtmf",value:new hc({code:e,digit:t})}});yield this.engine.sendDataPacket(i,$.RELIABLE)})}sendChatMessage(e,t){return S(this,void 0,void 0,function*(){const i={id:crypto.randomUUID(),message:e,timestamp:Date.now(),attachedFiles:t?.attachments},r=new Oe({value:{case:"chatMessage",value:new Si(Object.assign(Object.assign({},i),{timestamp:ce.parse(i.timestamp)}))}});return yield this.engine.sendDataPacket(r,$.RELIABLE),this.emit(A.ChatMessage,i),i})}editChatMessage(e,t){return S(this,void 0,void 0,function*(){const i=Object.assign(Object.assign({},t),{message:e,editTimestamp:Date.now()}),r=new Oe({value:{case:"chatMessage",value:new Si(Object.assign(Object.assign({},i),{timestamp:ce.parse(i.timestamp),editTimestamp:ce.parse(i.editTimestamp)}))}});return yield this.engine.sendDataPacket(r,$.RELIABLE),this.emit(A.ChatMessage,i),i})}sendText(e,t){return S(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendText(e,t)})}streamText(e){return S(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamText(e)})}sendFile(e,t){return S(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendFile(e,t)})}streamBytes(e){return S(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamBytes(e)})}performRpc(e){let{destinationIdentity:t,method:i,payload:r,responseTimeout:s=15e3}=e;const a=7e3,o=a+1e3;return new Le((c,l)=>S(this,void 0,void 0,function*(){var u,d,h,p;if(Ds(r)>Tl){l(de.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(!((d=(u=this.engine.latestJoinResponse)===null||u===void 0?void 0:u.serverInfo)===null||d===void 0)&&d.version&&Xe((p=(h=this.engine.latestJoinResponse)===null||h===void 0?void 0:h.serverInfo)===null||p===void 0?void 0:p.version,"1.8.0")<0){l(de.builtIn("UNSUPPORTED_SERVER"));return}const b=Math.max(s,o),m=crypto.randomUUID();yield this.publishRpcRequest(t,m,i,r,b);const T=setTimeout(()=>{this.pendingAcks.delete(m),l(de.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(m),clearTimeout(k)},a);this.pendingAcks.set(m,{resolve:()=>{clearTimeout(T)},participantIdentity:t});const k=setTimeout(()=>{this.pendingResponses.delete(m),l(de.builtIn("RESPONSE_TIMEOUT"))},s);this.pendingResponses.set(m,{resolve:(w,M)=>{clearTimeout(k),this.pendingAcks.has(m)&&(this.log.warn("RPC response received before ack",m),this.pendingAcks.delete(m),clearTimeout(T)),M?l(M):c(w??"")},participantIdentity:t})}))}registerRpcMethod(e,t){this.rpcHandlers.has(e)&&this.log.warn("you're overriding the RPC handler for method ".concat(e,", in the future this will throw an error")),this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setTrackSubscriptionPermissions(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=t,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(e){const t=this.pendingAcks.get(e);t?(t.resolve(),this.pendingAcks.delete(e)):console.error("Ack received for unexpected RPC request",e)}handleIncomingRpcResponse(e,t,i){const r=this.pendingResponses.get(e);r?(r.resolve(t,i),this.pendingResponses.delete(e)):console.error("Response received for unexpected RPC request",e)}publishRpcRequest(e,t,i,r,s){return S(this,void 0,void 0,function*(){const a=new Oe({destinationIdentities:[e],kind:$.RELIABLE,value:{case:"rpcRequest",value:new ms({id:t,method:i,payload:r,responseTimeoutMs:s,version:1})}});yield this.engine.sendDataPacket(a,$.RELIABLE)})}handleParticipantDisconnected(e){for(const[t,{participantIdentity:i}]of this.pendingAcks)i===e&&this.pendingAcks.delete(t);for(const[t,{participantIdentity:i,resolve:r}]of this.pendingResponses)i===e&&(r(null,de.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(t))}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter(t=>t.mime.split("/")[0].toLowerCase()==="video")}updateInfo(e){return super.updateInfo(e)?(e.tracks.forEach(t=>{var i,r;const s=this.trackPublications.get(t.sid);if(s){const a=s.isMuted||((r=(i=s.track)===null||i===void 0?void 0:i.isUpstreamPaused)!==null&&r!==void 0?r:!1);a!==t.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),J(s)),{mutedOnServer:a})),this.engine.client.sendMuteTrack(t.sid,a))}}),!0):!1}setActiveAgent(e){var t,i,r,s;this.firstActiveAgent=e,e&&!this.firstActiveAgent&&(this.firstActiveAgent=e),e?(i=(t=this.activeAgentFuture)===null||t===void 0?void 0:t.resolve)===null||i===void 0||i.call(t,e):(s=(r=this.activeAgentFuture)===null||r===void 0?void 0:r.reject)===null||s===void 0||s.call(r,new Error("Agent disconnected")),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new We),this.activeAgentFuture.promise)}getPublicationForTrack(e){let t;return this.trackPublications.forEach(i=>{const r=i.track;r&&(e instanceof MediaStreamTrack?(gt(r)||_t(r))&&r.mediaStreamTrack===e&&(t=i):e===r&&(t=i))}),t}waitForPendingPublicationOfSource(e){return S(this,void 0,void 0,function*(){const i=Date.now();for(;Date.now()<i+1e4;){const r=Array.from(this.pendingPublishPromises.entries()).find(s=>{let[a]=s;return a.source===e});if(r)return r[1];yield Re(20)}})}}class _i extends vt{constructor(e,t,i,r){super(e,t.sid,t.name,r),this.track=void 0,this.allowed=!0,this.requestedDisabled=void 0,this.visible=!0,this.handleEnded=s=>{this.setTrack(void 0),this.emit(U.Ended,s)},this.handleVisibilityChange=s=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(s),this.logContext),this.visible=s,this.emitTrackUpdate()},this.handleVideoDimensionsChange=s=>{this.log.debug("adaptivestream video dimensions ".concat(s.width,"x").concat(s.height),this.logContext),this.videoDimensionsAdaptiveStream=s,this.emitTrackUpdate()},this.subscribed=i,this.updateInfo(t)}setSubscribed(e){const t=this.subscriptionStatus,i=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const r=new qi({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new pc({participantSid:"",trackSids:[this.trackSid]})]});this.emit(U.UpdateSubscription,r),this.emitSubscriptionUpdateIfChanged(t),this.emitPermissionUpdateIfChanged(i)}get subscriptionStatus(){return this.subscribed===!1?vt.SubscriptionStatus.Unsubscribed:super.isSubscribed?vt.SubscriptionStatus.Subscribed:vt.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?vt.PermissionStatus.Allowed:vt.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return this.requestedDisabled!==void 0?!this.requestedDisabled:this.isAdaptiveStream?this.visible:!0}get isLocal(){return!1}setEnabled(e){!this.isManualOperationAllowed()||this.requestedDisabled===!e||(this.requestedDisabled=!e,this.emitTrackUpdate())}setVideoQuality(e){!this.isManualOperationAllowed()||this.requestedMaxQuality===e||(this.requestedMaxQuality=e,this.requestedVideoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var t,i;this.isManualOperationAllowed()&&(((t=this.requestedVideoDimensions)===null||t===void 0?void 0:t.width)===e.width&&((i=this.requestedVideoDimensions)===null||i===void 0?void 0:i.height)===e.height||(mr(this.track)&&(this.requestedVideoDimensions=e),this.requestedMaxQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&mr(this.track)&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){var e;return(e=this.requestedMaxQuality)!==null&&e!==void 0?e:je.HIGH}setTrack(e){const t=this.subscriptionStatus,i=this.permissionStatus,r=this.track;r!==e&&(r&&(r.off(U.VideoDimensionsChanged,this.handleVideoDimensionsChange),r.off(U.VisibilityChanged,this.handleVisibilityChange),r.off(U.Ended,this.handleEnded),r.detach(),r.stopMonitor(),this.emit(U.Unsubscribed,r)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(U.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(U.VisibilityChanged,this.handleVisibilityChange),e.on(U.Ended,this.handleEnded),this.emit(U.Subscribed,e)),this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(t))}setAllowed(e){const t=this.subscriptionStatus,i=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(i),this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(U.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?U.Muted:U.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(U.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(U.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return mr(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new Cc({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===P.Kind.Video){let t=this.requestedVideoDimensions;if(this.videoDimensionsAdaptiveStream!==void 0)if(t)Do(this.videoDimensionsAdaptiveStream,t)&&(this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream);else if(this.requestedMaxQuality!==void 0&&this.trackInfo){const i=ef(this.trackInfo,this.requestedMaxQuality);i&&Do(this.videoDimensionsAdaptiveStream,i)&&(this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream)}else this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),t=this.videoDimensionsAdaptiveStream;t?(e.width=Math.ceil(t.width),e.height=Math.ceil(t.height)):this.requestedMaxQuality!==void 0?(this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality})),e.quality=this.requestedMaxQuality):(this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:je.HIGH})),e.quality=je.HIGH)}this.emit(U.UpdateSettings,e)}}class Ii extends Ol{static fromParticipantInfo(e,t,i){return new Ii(e,t.sid,t.identity,t.name,t.metadata,t.attributes,i,t.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,t,i,r,s,a,o){let c=arguments.length>7&&arguments[7]!==void 0?arguments[7]:Un.STANDARD;super(t,i||"",r,s,a,o,c),this.signalClient=e,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(U.UpdateSettings,t=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),J(e)),{settings:t})),this.signalClient.sendUpdateTrackSettings(t)}),e.on(U.UpdateSubscription,t=>{t.participantTracks.forEach(i=>{i.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(t)}),e.on(U.SubscriptionPermissionChanged,t=>{this.emit(A.TrackSubscriptionPermissionChanged,e,t)}),e.on(U.SubscriptionStatusChanged,t=>{this.emit(A.TrackSubscriptionStatusChanged,e,t)}),e.on(U.Subscribed,t=>{this.emit(A.TrackSubscribed,t,e)}),e.on(U.Unsubscribed,t=>{this.emit(A.TrackUnsubscribed,t,e)}),e.on(U.SubscriptionFailed,t=>{this.emit(A.TrackSubscriptionFailed,e.trackSid,t)})}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:P.Source.Microphone;this.volumeMap.set(t,e);const i=this.getTrackPublication(t);i&&i.track&&i.track.setVolume(e)}getVolume(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:P.Source.Microphone;const t=this.getTrackPublication(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,i,r,s,a){let o=this.getTrackPublicationBySid(t);if(o||t.startsWith("TR")||this.trackPublications.forEach(u=>{!o&&e.kind===u.kind.toString()&&(o=u)}),!o){if(a===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t})),this.emit(A.TrackSubscriptionFailed,t);return}a===void 0&&(a=20),setTimeout(()=>{this.addSubscribedMediaTrack(e,t,i,r,s,a-1)},150);return}if(e.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),J(o))),this.emit(A.TrackSubscriptionFailed,t);return}const c=e.kind==="video";let l;return c?l=new Op(e,t,r,s):l=new Il(e,t,r,this.audioContext,this.audioOutput),l.source=o.source,l.isMuted=o.isMuted,l.setMediaStream(i),l.start(),o.setTrack(l),this.volumeMap.has(o.source)&&$r(l)&&at(l)&&l.setVolume(this.volumeMap.get(o.source)),o}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const t=new Map,i=new Map;return e.tracks.forEach(r=>{var s,a;let o=this.getTrackPublicationBySid(r.sid);if(o)o.updateInfo(r);else{const c=P.kindFromProto(r.type);if(!c)return;o=new _i(c,r,(s=this.signalClient.connectOptions)===null||s===void 0?void 0:s.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(a=this.loggerOptions)===null||a===void 0?void 0:a.loggerName}),o.updateInfo(r),i.set(r.sid,o);const l=Array.from(this.trackPublications.values()).find(u=>u.source===o?.source);l&&o.source!==P.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(o.source),Object.assign(Object.assign({},this.logContext),{oldTrack:J(l),newTrack:J(o)})),this.addTrackPublication(o)}t.set(r.sid,o)}),this.trackPublications.forEach(r=>{t.has(r.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),J(r))),this.unpublishTrack(r.trackSid,!0))}),i.forEach(r=>{this.emit(A.TrackPublished,r)}),!0}unpublishTrack(e,t){const i=this.trackPublications.get(e);if(!i)return;const{track:r}=i;switch(r&&(r.stop(),i.setTrack(void 0)),this.trackPublications.delete(e),i.kind){case P.Kind.Audio:this.audioTrackPublications.delete(e);break;case P.Kind.Video:this.videoTrackPublications.delete(e);break}t&&this.emit(A.TrackUnpublished,i)}setAudioOutput(e){return S(this,void 0,void 0,function*(){this.audioOutput=e;const t=[];this.audioTrackPublications.forEach(i=>{var r;at(i.track)&&$r(i.track)&&t.push(i.track.setSinkId((r=e.deviceId)!==null&&r!==void 0?r:"default"))}),yield Promise.all(t)})}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:i})),super.emit(e,...i)}}var Z;(function(n){n.Disconnected="disconnected",n.Connecting="connecting",n.Connected="connected",n.Reconnecting="reconnecting",n.SignalReconnecting="signalReconnecting"})(Z||(Z={}));const Up=4*1e3;class Ct extends dt.EventEmitter{get hasE2EESetup(){return this.e2eeManager!==void 0}constructor(e){var t,i,r,s,a;if(super(),t=this,this.state=Z.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=K,this.bufferedEvents=[],this.isResuming=!1,this.rpcHandlers=new Map,this.connect=(o,c,l)=>S(this,void 0,void 0,function*(){var u;if(!af())throw lt()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const d=yield this.disconnectLock.lock();if(this.state===Z.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),d(),Promise.resolve();if(this.connectFuture)return d(),this.connectFuture.promise;this.setAndEmitConnectionState(Z.Connecting),((u=this.regionUrlProvider)===null||u===void 0?void 0:u.getServerUrl().toString())!==bl(o)&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),mn(new URL(o))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new ne(o,c):this.regionUrlProvider.updateToken(c),this.regionUrlProvider.fetchRegionSettings().then(b=>{var m;(m=this.regionUrlProvider)===null||m===void 0||m.setServerReportedRegions(b)}).catch(b=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:b}))}));const h=(b,m,T)=>S(this,void 0,void 0,function*(){var k,w;this.abortController&&this.abortController.abort();const M=new AbortController;this.abortController=M,d?.();try{if(yield un.getInstance().getBackOffPromise(o),M.signal.aborted)throw B.cancelled("Connection attempt aborted");yield this.attemptConnection(T??o,c,l,M),this.abortController=void 0,b()}catch(v){if(this.regionUrlProvider&&v instanceof B&&v.reason!==oe.Cancelled&&v.reason!==oe.NotAllowed){let g=null;try{this.log.debug("Fetching next region"),g=yield this.regionUrlProvider.getNextBestRegionUrl((k=this.abortController)===null||k===void 0?void 0:k.signal)}catch(y){if(y instanceof B&&(y.status===401||y.reason===oe.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),m(y);return}}[oe.InternalError,oe.ServerUnreachable,oe.Timeout].includes(v.reason)&&(this.log.debug("Adding failed connection attempt to back off"),un.getInstance().addFailedConnectionAttempt(o)),g&&!(!((w=this.abortController)===null||w===void 0)&&w.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(v.message,". Retrying with another region: ").concat(g),this.logContext),this.recreateEngine(),yield h(b,m,g)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Vo(v)),m(v))}else{let g=Ye.UNKNOWN_REASON;v instanceof B&&(g=Vo(v)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,g),m(v)}}}),p=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new We((b,m)=>{h(b,m,p)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(o,c,l,u,d,h)=>S(this,void 0,void 0,function*(){var p,b,m;const T=yield l.join(o,c,{autoSubscribe:u.autoSubscribe,adaptiveStream:typeof d.adaptiveStream=="object"?!0:d.adaptiveStream,maxRetries:u.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:u.websocketTimeout},h.signal,!d.singlePeerConnection);let k=T.serverInfo;if(k||(k={version:T.serverVersion,region:T.serverRegion}),this.serverInfo=k,this.log.debug("connected to Livekit Server ".concat(Object.entries(k).map(w=>{let[M,v]=w;return"".concat(M,": ").concat(v)}).join(", ")),{room:(p=T.room)===null||p===void 0?void 0:p.name,roomSid:(b=T.room)===null||b===void 0?void 0:b.sid,identity:(m=T.participant)===null||m===void 0?void 0:m.identity}),!k.version)throw new qh("unknown server version");return k.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),d.dynacast=!1),T}),this.applyJoinResponse=o=>{const c=o.participant;if(this.localParticipant.sid=c.sid,this.localParticipant.identity=c.identity,this.localParticipant.setEnabledPublishCodecs(o.enabledPublishCodecs),this.e2eeManager)try{this.e2eeManager.setSifTrailer(o.sifTrailer)}catch(l){this.log.error(l instanceof Error?l.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:l}))}this.handleParticipantUpdates([c,...o.otherParticipants]),o.room&&this.handleRoomUpdate(o.room)},this.attemptConnection=(o,c,l,u)=>S(this,void 0,void 0,function*(){var d,h;this.state===Z.Reconnecting||this.isResuming||!((d=this.engine)===null||d===void 0)&&d.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((h=this.regionUrlProvider)===null||h===void 0)&&h.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},As),l),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const p=yield this.connectSignal(o,c,this.engine,this.connOptions,this.options,u);this.applyJoinResponse(p),this.setupLocalParticipantEvents(),this.emit(I.SignalConnected)}catch(p){yield this.engine.close(),this.recreateEngine();const b=u.signal.aborted?B.cancelled("Signal connection aborted"):B.serverUnreachable("could not establish signal connection");throw p instanceof Error&&(b.message="".concat(b.message,": ").concat(p.message)),p instanceof B&&(b.reason=p.reason,b.status=p.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:p})),b}if(u.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),B.cancelled("Connection attempt aborted");try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,u)}catch(p){throw yield this.engine.close(),this.recreateEngine(),p}Ne()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),Ne()&&window.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(Z.Connected),this.emit(I.Connected),un.getInstance().resetFailedConnectionAttempts(o),this.registerConnectionReconcile(),this.regionUrlProvider&&this.regionUrlProvider.notifyConnected()}),this.disconnect=function(){for(var o=arguments.length,c=new Array(o),l=0;l<o;l++)c[l]=arguments[l];return S(t,[...c],void 0,function(){var u=this;let d=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var h,p,b;const m=yield u.disconnectLock.lock();try{if(u.state===Z.Disconnected){u.log.debug("already disconnected",u.logContext);return}if(u.log.info("disconnect from room",Object.assign({},u.logContext)),u.state===Z.Connecting||u.state===Z.Reconnecting||u.isResuming){const T="Abort connection attempt due to user initiated disconnect";u.log.warn(T,u.logContext),(h=u.abortController)===null||h===void 0||h.abort(T),(b=(p=u.connectFuture)===null||p===void 0?void 0:p.reject)===null||b===void 0||b.call(p,B.cancelled("Client initiated disconnect")),u.connectFuture=void 0}u.engine&&(u.engine.client.isDisconnected||(yield u.engine.client.sendLeave()),yield u.engine.close()),u.handleDisconnect(d,Ye.CLIENT_INITIATED),u.engine=void 0}finally{m()}})()})},this.onPageLeave=()=>S(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>S(this,void 0,void 0,function*(){const o=[],c=Me();if(c&&c.os==="iOS"){const l="livekit-dummy-audio-el";let u=document.getElementById(l);if(!u){u=document.createElement("audio"),u.id=l,u.autoplay=!0,u.hidden=!0;const d=pr();d.enabled=!0;const h=new MediaStream([d]);u.srcObject=h,document.addEventListener("visibilitychange",()=>{u&&(u.srcObject=document.hidden?null:h,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(u),this.once(I.Disconnected,()=>{u?.remove(),u=null})}o.push(u)}this.remoteParticipants.forEach(l=>{l.audioTrackPublications.forEach(u=>{u.track&&u.track.attachedElements.forEach(d=>{o.push(d)})})});try{yield Promise.all([this.acquireAudioContext(),...o.map(l=>(l.muted=!1,l.play()))]),this.handleAudioPlaybackStarted()}catch(l){throw this.handleAudioPlaybackFailed(l),l}}),this.startVideo=()=>S(this,void 0,void 0,function*(){const o=[];for(const c of this.remoteParticipants.values())c.videoTrackPublications.forEach(l=>{var u;(u=l.track)===null||u===void 0||u.attachedElements.forEach(d=>{o.includes(d)||o.push(d)})});yield Promise.all(o.map(c=>c.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(c=>{c.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const o of this.remoteParticipants.values())this.handleParticipantDisconnected(o.identity,o);this.setAndEmitConnectionState(Z.Reconnecting)&&this.emit(I.Reconnecting)},this.handleSignalRestarted=o=>S(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(o.serverRegion),Object.assign(Object.assign({},this.logContext),{region:o.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(o);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(c){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:c}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:o.serverRegion}))}catch{return}this.setAndEmitConnectionState(Z.Connected),this.emit(I.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=o=>{o.forEach(c=>{var l;if(c.identity===this.localParticipant.identity){this.localParticipant.updateInfo(c);return}c.identity===""&&(c.identity=(l=this.sidToIdentity.get(c.sid))!==null&&l!==void 0?l:"");let u=this.remoteParticipants.get(c.identity);c.state===sn.DISCONNECTED?this.handleParticipantDisconnected(c.identity,u):u=this.getOrCreateParticipant(c.identity,c)})},this.handleActiveSpeakersUpdate=o=>{const c=[],l={};o.forEach(u=>{if(l[u.sid]=!0,u.sid===this.localParticipant.sid)this.localParticipant.audioLevel=u.level,this.localParticipant.setIsSpeaking(!0),c.push(this.localParticipant);else{const d=this.getRemoteParticipantBySid(u.sid);d&&(d.audioLevel=u.level,d.setIsSpeaking(!0),c.push(d))}}),l[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(u=>{l[u.sid]||(u.audioLevel=0,u.setIsSpeaking(!1))}),this.activeSpeakers=c,this.emitWhenConnected(I.ActiveSpeakersChanged,c)},this.handleSpeakersChanged=o=>{const c=new Map;this.activeSpeakers.forEach(u=>{const d=this.remoteParticipants.get(u.identity);d&&d.sid!==u.sid||c.set(u.sid,u)}),o.forEach(u=>{let d=this.getRemoteParticipantBySid(u.sid);u.sid===this.localParticipant.sid&&(d=this.localParticipant),d&&(d.audioLevel=u.level,d.setIsSpeaking(u.active),u.active?c.set(u.sid,d):c.delete(u.sid))});const l=Array.from(c.values());l.sort((u,d)=>d.audioLevel-u.audioLevel),this.activeSpeakers=l,this.emitWhenConnected(I.ActiveSpeakersChanged,l)},this.handleStreamStateUpdate=o=>{o.streamStates.forEach(c=>{const l=this.getRemoteParticipantBySid(c.participantSid);if(!l)return;const u=l.getTrackPublicationBySid(c.trackSid);if(!u||!u.track)return;const d=P.streamStateFromProto(c.state);u.track.setStreamState(d),d!==u.track.streamState&&(l.emit(A.TrackStreamStateChanged,u,u.track.streamState),this.emitWhenConnected(I.TrackStreamStateChanged,u,u.track.streamState,l))})},this.handleSubscriptionPermissionUpdate=o=>{const c=this.getRemoteParticipantBySid(o.participantSid);if(!c)return;const l=c.getTrackPublicationBySid(o.trackSid);l&&l.setAllowed(o.allowed)},this.handleSubscriptionError=o=>{const c=Array.from(this.remoteParticipants.values()).find(u=>u.trackPublications.has(o.trackSid));if(!c)return;const l=c.getTrackPublicationBySid(o.trackSid);l&&l.setSubscriptionError(o.err)},this.handleDataPacket=(o,c)=>{const l=this.remoteParticipants.get(o.participantIdentity);if(o.value.case==="user")this.handleUserPacket(l,o.value.value,o.kind,c);else if(o.value.case==="transcription")this.handleTranscription(l,o.value.value);else if(o.value.case==="sipDtmf")this.handleSipDtmf(l,o.value.value);else if(o.value.case==="chatMessage")this.handleChatMessage(l,o.value.value);else if(o.value.case==="metrics")this.handleMetrics(o.value.value,l);else if(o.value.case==="streamHeader"||o.value.case==="streamChunk"||o.value.case==="streamTrailer")this.handleDataStream(o,c);else if(o.value.case==="rpcRequest"){const u=o.value.value;this.handleIncomingRpcRequest(o.participantIdentity,u.id,u.method,u.payload,u.responseTimeoutMs,u.version)}},this.handleUserPacket=(o,c,l,u)=>{this.emit(I.DataReceived,c.payload,o,l,c.topic,u),o?.emit(A.DataReceived,c.payload,l,u)},this.handleSipDtmf=(o,c)=>{this.emit(I.SipDTMFReceived,c,o),o?.emit(A.SipDTMFReceived,c)},this.handleTranscription=(o,c)=>{const l=c.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(c.transcribedParticipantIdentity),u=l?.trackPublications.get(c.trackId),d=gf(c,this.transcriptionReceivedTimes);u?.emit(U.TranscriptionReceived,d),l?.emit(A.TranscriptionReceived,d,u),this.emit(I.TranscriptionReceived,d,l,u)},this.handleChatMessage=(o,c)=>{const l=vf(c);this.emit(I.ChatMessage,l,o)},this.handleMetrics=(o,c)=>{this.emit(I.MetricsReceived,o,c)},this.handleDataStream=(o,c)=>{this.incomingDataStreamManager.handleDataStreamPacket(o,c)},this.bufferedSegments=new Map,this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(I.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=o=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:o})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(I.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(I.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(I.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>S(this,void 0,void 0,function*(){var o;((o=Me())===null||o===void 0?void 0:o.os)!=="iOS"&&(yield this.selectDefaultDevices()),this.emit(I.MediaDevicesChanged)}),this.handleRoomUpdate=o=>{const c=this.roomInfo;this.roomInfo=o,c&&c.metadata!==o.metadata&&this.emitWhenConnected(I.RoomMetadataChanged,o.metadata),c?.activeRecording!==o.activeRecording&&this.emitWhenConnected(I.RecordingStatusChanged,o.activeRecording)},this.handleConnectionQualityUpdate=o=>{o.updates.forEach(c=>{if(c.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(c.quality);return}const l=this.getRemoteParticipantBySid(c.participantSid);l&&l.setConnectionQuality(c.quality)})},this.onLocalParticipantMetadataChanged=o=>{this.emit(I.ParticipantMetadataChanged,o,this.localParticipant)},this.onLocalParticipantNameChanged=o=>{this.emit(I.ParticipantNameChanged,o,this.localParticipant)},this.onLocalAttributesChanged=o=>{this.emit(I.ParticipantAttributesChanged,o,this.localParticipant)},this.onLocalTrackMuted=o=>{this.emit(I.TrackMuted,o,this.localParticipant)},this.onLocalTrackUnmuted=o=>{this.emit(I.TrackUnmuted,o,this.localParticipant)},this.onTrackProcessorUpdate=o=>{var c;(c=o?.onPublish)===null||c===void 0||c.call(o,this)},this.onLocalTrackPublished=o=>S(this,void 0,void 0,function*(){var c,l,u,d,h,p;(c=o.track)===null||c===void 0||c.on(U.TrackProcessorUpdate,this.onTrackProcessorUpdate),(l=o.track)===null||l===void 0||l.on(U.Restarted,this.onLocalTrackRestarted),(h=(d=(u=o.track)===null||u===void 0?void 0:u.getProcessor())===null||d===void 0?void 0:d.onPublish)===null||h===void 0||h.call(d,this),this.emit(I.LocalTrackPublished,o,this.localParticipant),gt(o.track)&&(yield o.track.checkForSilence())&&this.emit(I.LocalAudioSilenceDetected,o);const b=yield(p=o.track)===null||p===void 0?void 0:p.getDeviceId(!1),m=Hr(o.source);m&&b&&b!==this.localParticipant.activeDeviceMap.get(m)&&(this.localParticipant.activeDeviceMap.set(m,b),this.emit(I.ActiveDeviceChanged,m,b))}),this.onLocalTrackUnpublished=o=>{var c,l;(c=o.track)===null||c===void 0||c.off(U.TrackProcessorUpdate,this.onTrackProcessorUpdate),(l=o.track)===null||l===void 0||l.off(U.Restarted,this.onLocalTrackRestarted),this.emit(I.LocalTrackUnpublished,o,this.localParticipant)},this.onLocalTrackRestarted=o=>S(this,void 0,void 0,function*(){const c=yield o.getDeviceId(!1),l=Hr(o.source);l&&c&&c!==this.localParticipant.activeDeviceMap.get(l)&&(this.log.debug("local track restarted, setting ".concat(l," ").concat(c," active"),this.logContext),this.localParticipant.activeDeviceMap.set(l,c),this.emit(I.ActiveDeviceChanged,l,c))}),this.onLocalConnectionQualityChanged=o=>{this.emit(I.ConnectionQualityChanged,o,this.localParticipant)},this.onMediaDevicesError=(o,c)=>{this.emit(I.MediaDevicesError,o,c)},this.onLocalParticipantPermissionsChanged=o=>{this.emit(I.ParticipantPermissionsChanged,o,this.localParticipant)},this.onLocalChatMessageSent=o=>{this.emit(I.ChatMessage,o,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},Yf),e),this.log=Tt((i=this.options.loggerName)!==null&&i!==void 0?i:Qe.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},yl),e?.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},kl),e?.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},Jf),e?.publishDefaults),this.maybeCreateEngine(),this.incomingDataStreamManager=new Pp,this.outgoingDataStreamManager=new Ip(this.engine,this.log),this.disconnectLock=new xe,this.localParticipant=new Np("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager),(this.options.e2ee||this.options.encryption)&&this.setupE2EE(),this.engine.e2eeManager=this.e2eeManager,this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",Dt(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",Dt(this.options.audioCaptureDefaults.deviceId)),!((r=this.options.audioOutput)===null||r===void 0)&&r.deviceId&&this.switchActiveDevice("audiooutput",Dt(this.options.audioOutput.deviceId)).catch(o=>this.log.warn("Could not set audio output: ".concat(o.message),this.logContext)),Ne()){const o=new AbortController;(a=(s=navigator.mediaDevices)===null||s===void 0?void 0:s.addEventListener)===null||a===void 0||a.call(s,"devicechange",this.handleDeviceChange,{signal:o.signal}),Ct.cleanupRegistry&&Ct.cleanupRegistry.register(this,()=>{o.abort()})}}registerTextStreamHandler(e,t){return this.incomingDataStreamManager.registerTextStreamHandler(e,t)}unregisterTextStreamHandler(e){return this.incomingDataStreamManager.unregisterTextStreamHandler(e)}registerByteStreamHandler(e,t){return this.incomingDataStreamManager.registerByteStreamHandler(e,t)}unregisterByteStreamHandler(e){return this.incomingDataStreamManager.unregisterByteStreamHandler(e)}registerRpcMethod(e,t){if(this.rpcHandlers.has(e))throw Error("RPC handler already registered for method ".concat(e,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setE2EEEnabled(e){return S(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var e;const t=!!this.options.encryption,i=this.options.encryption||this.options.e2ee;i&&("e2eeManager"in i?(this.e2eeManager=i.e2eeManager,this.e2eeManager.isDataChannelEncryptionEnabled=t):this.e2eeManager=new Mf(i,t),this.e2eeManager.on(xt.ParticipantEncryptionStatusChanged,(r,s)=>{yf(s)&&(this.isE2EEEnabled=r),this.emit(I.ParticipantEncryptionStatusChanged,r,s)}),this.e2eeManager.on(xt.EncryptionError,(r,s)=>{const a=s?this.getParticipantByIdentity(s):void 0;this.emit(I.EncryptionError,r,a)}),(e=this.e2eeManager)===null||e===void 0||e.setup(this))}get logContext(){var e;return{room:this.name,roomID:(e=this.roomInfo)===null||e===void 0?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.activeRecording)!==null&&t!==void 0?t:!1}getSid(){return this.state===Z.Disconnected?Le.resolve(""):this.roomInfo&&this.roomInfo.sid!==""?Le.resolve(this.roomInfo.sid):new Le((e,t)=>{const i=r=>{r.sid!==""&&(this.engine.off(F.RoomUpdate,i),e(r.sid))};this.engine.on(F.RoomUpdate,i),this.once(I.Disconnected,()=>{this.engine.off(F.RoomUpdate,i),t(new he("Room disconnected before room server id was available"))})})}get name(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.name)!==null&&t!==void 0?t:""}get metadata(){var e;return(e=this.roomInfo)===null||e===void 0?void 0:e.metadata}get numParticipants(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numParticipants)!==null&&t!==void 0?t:0}get numPublishers(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numPublishers)!==null&&t!==void 0?t:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new Tp(this.options),this.engine.e2eeManager=this.e2eeManager,this.engine.on(F.ParticipantUpdate,this.handleParticipantUpdates).on(F.RoomUpdate,this.handleRoomUpdate).on(F.SpeakersChanged,this.handleSpeakersChanged).on(F.StreamStateChanged,this.handleStreamStateUpdate).on(F.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(F.SubscriptionError,this.handleSubscriptionError).on(F.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(F.MediaTrackAdded,(e,t,i)=>{this.onTrackAdded(e,t,i)}).on(F.Disconnected,e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)}).on(F.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(F.DataPacketReceived,this.handleDataPacket).on(F.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(Z.SignalReconnecting)&&this.emit(I.SignalReconnecting)}).on(F.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(Z.Connected)&&this.emit(I.Reconnected)}).on(F.SignalResumed,()=>{this.bufferedEvents=[],(this.state===Z.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(F.Restarting,this.handleRestarting).on(F.SignalRestarted,this.handleSignalRestarted).on(F.Offline,()=>{this.setAndEmitConnectionState(Z.Reconnecting)&&this.emit(I.Reconnecting)}).on(F.DCBufferStatusChanged,(e,t)=>{this.emit(I.DCBufferStatusChanged,e,t)}).on(F.LocalTrackSubscribed,e=>{const t=this.localParticipant.getTrackPublications().find(i=>{let{trackSid:r}=i;return r===e});if(!t){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(A.LocalTrackSubscribed,t),this.emitWhenConnected(I.LocalTrackSubscribed,t,this.localParticipant)}).on(F.RoomMoved,e=>{this.log.debug("room moved",e),e.room&&this.handleRoomUpdate(e.room),this.remoteParticipants.forEach((t,i)=>{this.handleParticipantDisconnected(i,t)}),this.emit(I.Moved,e.room.name),e.participant?this.handleParticipantUpdates([e.participant,...e.otherParticipants]):this.handleParticipantUpdates(e.otherParticipants)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine),this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine))}static getLocalDevices(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return Ce.getInstance().getDevices(e,t)}prepareConnection(e,t){return S(this,void 0,void 0,function*(){if(this.state===Z.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(mn(new URL(e))&&t){this.regionUrlProvider=new ne(e,t);const i=yield this.regionUrlProvider.getNextBestRegionUrl();i&&this.state===Z.Disconnected&&(this.regionUrl=i,yield fetch(qn(i),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(i),this.logContext))}else yield fetch(qn(e),{method:"HEAD"})}catch(i){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:i}))}}})}getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return S(this,void 0,void 0,function*(){let i=()=>S(this,void 0,void 0,function*(){}),r;switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":r=new st({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":r=new st({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":r=new st({scenario:{case:"serverLeave",value:!0}});break;case"migration":r=new st({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>S(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new st({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":i=()=>S(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),r=new st({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":r=new st({scenario:{case:"switchCandidateProtocol",value:e==="force-tls"?2:1}}),i=()=>S(this,void 0,void 0,function*(){const s=this.engine.client.onLeave;s&&s(new Wi({reason:Ye.CLIENT_INITIATED,action:on.RECONNECT}))});break;case"subscriber-bandwidth":if(t===void 0||typeof t!="number")throw new Error("subscriber-bandwidth requires a number as argument");r=new st({scenario:{case:"subscriberBandwidth",value:Wt(t)}});break;case"leave-full-reconnect":r=new st({scenario:{case:"leaveRequestFullReconnect",value:!0}})}r&&(yield this.engine.client.sendSimulateScenario(r),yield i())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,t){return S(this,arguments,void 0,function(i,r){var s=this;let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return(function*(){var o,c,l,u,d,h,p;let b=!0,m=!1;const T=a?{exact:r}:r;if(i==="audioinput"){m=s.localParticipant.audioTrackPublications.size===0;const k=(o=s.getActiveDevice(i))!==null&&o!==void 0?o:s.options.audioCaptureDefaults.deviceId;s.options.audioCaptureDefaults.deviceId=T;const w=Array.from(s.localParticipant.audioTrackPublications.values()).filter(v=>v.source===P.Source.Microphone);try{b=(yield Promise.all(w.map(v=>{var g;return(g=v.audioTrack)===null||g===void 0?void 0:g.setDeviceId(T)}))).every(v=>v===!0)}catch(v){throw s.options.audioCaptureDefaults.deviceId=k,v}const M=w.some(v=>{var g,y;return(y=(g=v.track)===null||g===void 0?void 0:g.isMuted)!==null&&y!==void 0?y:!1});b&&M&&(m=!0)}else if(i==="videoinput"){m=s.localParticipant.videoTrackPublications.size===0;const k=(c=s.getActiveDevice(i))!==null&&c!==void 0?c:s.options.videoCaptureDefaults.deviceId;s.options.videoCaptureDefaults.deviceId=T;const w=Array.from(s.localParticipant.videoTrackPublications.values()).filter(v=>v.source===P.Source.Camera);try{b=(yield Promise.all(w.map(v=>{var g;return(g=v.videoTrack)===null||g===void 0?void 0:g.setDeviceId(T)}))).every(v=>v===!0)}catch(v){throw s.options.videoCaptureDefaults.deviceId=k,v}const M=w.some(v=>{var g,y;return(y=(g=v.track)===null||g===void 0?void 0:g.isMuted)!==null&&y!==void 0?y:!1});b&&M&&(m=!0)}else if(i==="audiooutput"){if(m=!0,!Gr()&&!s.options.webAudioMix||s.options.webAudioMix&&s.audioContext&&!("setSinkId"in s.audioContext))throw new Error("cannot switch audio output, the current browser does not support it");s.options.webAudioMix&&(r=(l=yield Ce.getInstance().normalizeDeviceId("audiooutput",r))!==null&&l!==void 0?l:""),(u=(p=s.options).audioOutput)!==null&&u!==void 0||(p.audioOutput={});const k=(d=s.getActiveDevice(i))!==null&&d!==void 0?d:s.options.audioOutput.deviceId;s.options.audioOutput.deviceId=r;try{s.options.webAudioMix&&((h=s.audioContext)===null||h===void 0||h.setSinkId(r)),yield Promise.all(Array.from(s.remoteParticipants.values()).map(w=>w.setAudioOutput({deviceId:r})))}catch(w){throw s.options.audioOutput.deviceId=k,w}}return m&&(s.localParticipant.activeDeviceMap.set(i,r),s.emit(I.ActiveDeviceChanged,i,r)),b})()})}setupLocalParticipantEvents(){this.localParticipant.on(A.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(A.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(A.AttributesChanged,this.onLocalAttributesChanged).on(A.TrackMuted,this.onLocalTrackMuted).on(A.TrackUnmuted,this.onLocalTrackUnmuted).on(A.LocalTrackPublished,this.onLocalTrackPublished).on(A.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(A.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(A.MediaDevicesError,this.onMediaDevicesError).on(A.AudioStreamAcquired,this.startAudio).on(A.ChatMessage,this.onLocalChatMessageSent).on(A.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;(e=this.engine)===null||e===void 0||e.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,t,i){if(this.state===Z.Connecting||this.state===Z.Reconnecting){const d=()=>{this.log.debug("deferring on track for later",{mediaTrackId:e.id,mediaStreamId:t.id,tracksInStream:t.getTracks().map(p=>p.id)}),this.onTrackAdded(e,t,i),h()},h=()=>{this.off(I.Reconnected,d),this.off(I.Connected,d),this.off(I.Disconnected,h)};this.once(I.Reconnected,d),this.once(I.Connected,d),this.once(I.Disconnected,h);return}if(this.state===Z.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}if(e.readyState==="ended"){this.log.info("skipping incoming track as it already ended",this.logContext);return}const r=rf(t.id),s=r[0];let a=r[1],o=e.id;if(a&&a.startsWith("TR")&&(o=a),s===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const c=Array.from(this.remoteParticipants.values()).find(d=>d.sid===s);if(!c){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(s),this.logContext);return}if(!o.startsWith("TR")){const d=this.engine.getTrackIdForReceiver(i);if(!d){this.log.error("Tried to add a track whose 'sid' could not be found for a participant, that's not present. Sid: ".concat(s),this.logContext);return}o=d}o.startsWith("TR")||this.log.warn("Tried to add a track whose 'sid' could not be determined for a participant, that's not present. Sid: ".concat(s,", streamId: ").concat(a,", trackId: ").concat(o),Object.assign(Object.assign({},this.logContext),{rpID:s,streamId:a,trackId:o}));let l;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?l=this.options.adaptiveStream:l={});const u=c.addSubscribedMediaTrack(e,o,t,i,l);u?.isEncrypted&&!this.e2eeManager&&this.emit(I.EncryptionError,new Error("Encrypted ".concat(u.source," track received from participant ").concat(c.sid,", but room does not have encryption enabled!")))}handleDisconnect(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=arguments.length>1?arguments[1]:void 0;var i,r;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.incomingDataStreamManager.clearControllers(),this.state!==Z.Disconnected){this.regionUrl=void 0,this.regionUrlProvider&&this.regionUrlProvider.notifyDisconnected();try{this.remoteParticipants.forEach(s=>{s.trackPublications.forEach(a=>{s.unpublishTrack(a.trackSid)})}),this.localParticipant.trackPublications.forEach(s=>{var a,o,c;s.track&&this.localParticipant.unpublishTrack(s.track,e),e?((a=s.track)===null||a===void 0||a.detach(),(o=s.track)===null||o===void 0||o.stop()):(c=s.track)===null||c===void 0||c.stopMonitor()}),this.localParticipant.off(A.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(A.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(A.AttributesChanged,this.onLocalAttributesChanged).off(A.TrackMuted,this.onLocalTrackMuted).off(A.TrackUnmuted,this.onLocalTrackUnmuted).off(A.LocalTrackPublished,this.onLocalTrackPublished).off(A.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(A.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(A.MediaDevicesError,this.onMediaDevicesError).off(A.AudioStreamAcquired,this.startAudio).off(A.ChatMessage,this.onLocalChatMessageSent).off(A.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),Ne()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(r=(i=navigator.mediaDevices)===null||i===void 0?void 0:i.removeEventListener)===null||r===void 0||r.call(i,"devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(Z.Disconnected),this.emit(I.Disconnected,t)}}}handleParticipantDisconnected(e,t){var i;this.remoteParticipants.delete(e),t&&(this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams(e),t.trackPublications.forEach(r=>{t.unpublishTrack(r.trackSid,!0)}),this.emit(I.ParticipantDisconnected,t),t.setDisconnected(),(i=this.localParticipant)===null||i===void 0||i.handleParticipantDisconnected(t.identity))}handleIncomingRpcRequest(e,t,i,r,s,a){return S(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck(e,t),a!==1){yield this.engine.publishRpcResponse(e,t,null,de.builtIn("UNSUPPORTED_VERSION"));return}const o=this.rpcHandlers.get(i);if(!o){yield this.engine.publishRpcResponse(e,t,null,de.builtIn("UNSUPPORTED_METHOD"));return}let c=null,l=null;try{const u=yield o({requestId:t,callerIdentity:e,payload:r,responseTimeout:s});Ds(u)>Tl?(c=de.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),this.log.warn("RPC Response payload too large for ".concat(i))):l=u}catch(u){u instanceof de?c=u:(this.log.warn("Uncaught error returned by RPC handler for ".concat(i,". Returning APPLICATION_ERROR instead."),u),c=de.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse(e,t,l,c)})}selectDefaultDevices(){return S(this,void 0,void 0,function*(){var e,t,i;const r=Ce.getInstance().previousDevices,s=yield Ce.getInstance().getDevices(void 0,!1),a=Me();if(a?.name==="Chrome"&&a.os!=="iOS")for(let c of s){const l=r.find(u=>u.deviceId===c.deviceId);l&&l.label!==""&&l.kind===c.kind&&l.label!==c.label&&this.getActiveDevice(c.kind)==="default"&&this.emit(I.ActiveDeviceChanged,c.kind,c.deviceId)}const o=["audiooutput","audioinput","videoinput"];for(let c of o){const l=$h(c),u=this.localParticipant.getTrackPublication(l);if(u&&(!((e=u.track)===null||e===void 0)&&e.isUserProvided))continue;const d=s.filter(p=>p.kind===c),h=this.getActiveDevice(c);if(h===((t=r.filter(p=>p.kind===c)[0])===null||t===void 0?void 0:t.deviceId)&&d.length>0&&((i=d[0])===null||i===void 0?void 0:i.deviceId)!==h){yield this.switchActiveDevice(c,d[0].deviceId);continue}c==="audioinput"&&!Vn()||c==="videoinput"||d.length>0&&!d.find(p=>p.deviceId===this.getActiveDevice(c))&&(c!=="audiooutput"||!Vn())&&(yield this.switchActiveDevice(c,d[0].deviceId))}})}acquireAudioContext(){return S(this,void 0,void 0,function*(){var e,t;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=(e=fl())!==null&&e!==void 0?e:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(r=>r.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&this.audioContext.state==="suspended")try{yield Promise.race([this.audioContext.resume(),Re(200)])}catch(r){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:r}))}const i=((t=this.audioContext)===null||t===void 0?void 0:t.state)==="running";i!==this.canPlaybackAudio&&(this.audioEnabled=i,this.emit(I.AudioPlaybackStatusChanged,i))})}createParticipant(e,t){var i;let r;return t?r=Ii.fromParticipantInfo(this.engine.client,t,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):r=new Ii(this.engine.client,"",e,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&r.setAudioContext(this.audioContext),!((i=this.options.audioOutput)===null||i===void 0)&&i.deviceId&&r.setAudioOutput(this.options.audioOutput).catch(s=>this.log.warn("Could not set audio output: ".concat(s.message),this.logContext)),r}getOrCreateParticipant(e,t){if(this.remoteParticipants.has(e)){const r=this.remoteParticipants.get(e);return t&&r.updateInfo(t)&&this.sidToIdentity.set(t.sid,t.identity),r}const i=this.createParticipant(e,t);return this.remoteParticipants.set(e,i),this.sidToIdentity.set(t.sid,t.identity),this.emitWhenConnected(I.ParticipantConnected,i),i.on(A.TrackPublished,r=>{this.emitWhenConnected(I.TrackPublished,r,i)}).on(A.TrackSubscribed,(r,s)=>{r.kind===P.Kind.Audio?(r.on(U.AudioPlaybackStarted,this.handleAudioPlaybackStarted),r.on(U.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):r.kind===P.Kind.Video&&(r.on(U.VideoPlaybackFailed,this.handleVideoPlaybackFailed),r.on(U.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(I.TrackSubscribed,r,s,i)}).on(A.TrackUnpublished,r=>{this.emit(I.TrackUnpublished,r,i)}).on(A.TrackUnsubscribed,(r,s)=>{this.emit(I.TrackUnsubscribed,r,s,i)}).on(A.TrackMuted,r=>{this.emitWhenConnected(I.TrackMuted,r,i)}).on(A.TrackUnmuted,r=>{this.emitWhenConnected(I.TrackUnmuted,r,i)}).on(A.ParticipantMetadataChanged,r=>{this.emitWhenConnected(I.ParticipantMetadataChanged,r,i)}).on(A.ParticipantNameChanged,r=>{this.emitWhenConnected(I.ParticipantNameChanged,r,i)}).on(A.AttributesChanged,r=>{this.emitWhenConnected(I.ParticipantAttributesChanged,r,i)}).on(A.ConnectionQualityChanged,r=>{this.emitWhenConnected(I.ConnectionQualityChanged,r,i)}).on(A.ParticipantPermissionsChanged,r=>{this.emitWhenConnected(I.ParticipantPermissionsChanged,r,i)}).on(A.TrackSubscriptionStatusChanged,(r,s)=>{this.emitWhenConnected(I.TrackSubscriptionStatusChanged,r,s,i)}).on(A.TrackSubscriptionFailed,(r,s)=>{this.emit(I.TrackSubscriptionFailed,r,i,s)}).on(A.TrackSubscriptionPermissionChanged,(r,s)=>{this.emitWhenConnected(I.TrackSubscriptionPermissionChanged,r,s,i)}).on(A.Active,()=>{this.emitWhenConnected(I.ParticipantActive,i),i.kind===Un.AGENT&&this.localParticipant.setActiveAgent(i)}),t&&i.updateInfo(t),i}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce((i,r)=>(i.push(...r.getTrackPublications()),i),[]),t=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const t of e.videoTrackPublications.values())t.isSubscribed&&bf(t)&&t.emitTrackUpdate()}getRemoteParticipantBySid(e){const t=this.sidToIdentity.get(e);if(t)return this.remoteParticipants.get(t)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=Pe.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Ye.STATE_MISMATCH))):e=0},Up)}clearConnectionReconcile(){this.connectionReconcileInterval&&Pe.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e===this.state?!1:(this.state=e,this.emit(I.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(e=>{let[t,i]=e;this.emit(t,...i)}),this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(this.state===Z.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,i]);else if(this.state===Z.Connected)return this.emit(e,...i);return!1}simulateParticipants(e){return S(this,void 0,void 0,function*(){var t,i,r,s;const a=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),o=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new ji({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:ce.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new zt({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(I.SignalConnected),this.emit(I.Connected),this.setAndEmitConnectionState(Z.Connected),a.video){const c=new Ri(P.Kind.Video,new tn({source:me.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:ze.AUDIO,name:"video-dummy"}),new Pi(a.useRealTracks&&(!((t=window.navigator.mediaDevices)===null||t===void 0)&&t.getUserMedia)?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:Bo(160*((i=o.aspectRatios[0])!==null&&i!==void 0?i:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(c),this.localParticipant.emit(A.LocalTrackPublished,c)}if(a.audio){const c=new Ri(P.Kind.Audio,new tn({source:me.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:ze.AUDIO}),new wi(a.useRealTracks&&(!((r=navigator.mediaDevices)===null||r===void 0)&&r.getUserMedia)?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:pr(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(c),this.localParticipant.emit(A.LocalTrackPublished,c)}for(let c=0;c<o.count-1;c+=1){let l=new zt({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(c),state:sn.ACTIVE,tracks:[],joinedAt:ce.parse(Date.now())});const u=this.getOrCreateParticipant(l.identity,l);if(o.video){const d=Bo(160*((s=o.aspectRatios[c%o.aspectRatios.length])!==null&&s!==void 0?s:1),160,!1,!0),h=new tn({source:me.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:ze.AUDIO});u.addSubscribedMediaTrack(d,h.sid,new MediaStream([d]),new RTCRtpReceiver),l.tracks=[...l.tracks,h]}if(o.audio){const d=pr(),h=new tn({source:me.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:ze.AUDIO});u.addSubscribedMediaTrack(d,h.sid,new MediaStream([d]),new RTCRtpReceiver),l.tracks=[...l.tracks,h]}u.updateInfo(l)}})}emit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];if(e!==I.ActiveSpeakersChanged&&e!==I.TranscriptionReceived){const s=xl(i).filter(a=>a!==void 0);(e===I.TrackSubscribed||e===I.TrackUnsubscribed)&&this.log.trace("subscribe trace: ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:s})),this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:s}))}return super.emit(e,...i)}}Ct.cleanupRegistry=typeof FinalizationRegistry<"u"&&new FinalizationRegistry(n=>{n()});function xl(n){return n.map(e=>{if(e)return Array.isArray(e)?xl(e):typeof e=="object"?"logContext"in e?e.logContext:void 0:e})}var Ke;(function(n){n[n.IDLE=0]="IDLE",n[n.RUNNING=1]="RUNNING",n[n.SKIPPED=2]="SKIPPED",n[n.SUCCESS=3]="SUCCESS",n[n.FAILED=4]="FAILED"})(Ke||(Ke={}));class Vt extends dt.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=Ke.IDLE,this.logs=[],this.options={},this.url=e,this.token=t,this.name=this.constructor.name,this.room=new Ct(i.roomOptions),this.connectOptions=i.connectOptions,this.options=i}run(e){return S(this,void 0,void 0,function*(){if(this.status!==Ke.IDLE)throw Error("check is running already");this.setStatus(Ke.RUNNING);try{yield this.perform()}catch(t){t instanceof Error&&(this.options.errorsAsWarnings?this.appendWarning(t.message):this.appendError(t.message))}return yield this.disconnect(),yield new Promise(t=>setTimeout(t,500)),this.status!==Ke.SKIPPED&&this.setStatus(this.isSuccess()?Ke.SUCCESS:Ke.FAILED),e&&e(),this.getInfo()})}isSuccess(){return!this.logs.some(e=>e.level==="error")}connect(e){return S(this,void 0,void 0,function*(){return this.room.state===Z.Connected?this.room:(e||(e=this.url),yield this.room.connect(e,this.token,this.connectOptions),this.room)})}disconnect(){return S(this,void 0,void 0,function*(){this.room&&this.room.state!==Z.Disconnected&&(yield this.room.disconnect(),yield new Promise(e=>setTimeout(e,500)))})}skip(){this.setStatus(Ke.SKIPPED)}switchProtocol(e){return S(this,void 0,void 0,function*(){let t=!1,i=!1;if(this.room.on(I.Reconnecting,()=>{t=!0}),this.room.once(I.Reconnected,()=>{i=!0}),this.room.simulateScenario("force-".concat(e)),yield new Promise(s=>setTimeout(s,1e3)),!t)return;const r=Date.now()+1e4;for(;Date.now()<r;){if(i)return;yield Re(100)}throw new Error("Could not reconnect using ".concat(e," protocol after 10 seconds"))})}appendMessage(e){this.logs.push({level:"info",message:e}),this.emit("update",this.getInfo())}appendWarning(e){this.logs.push({level:"warning",message:e}),this.emit("update",this.getInfo())}appendError(e){this.logs.push({level:"error",message:e}),this.emit("update",this.getInfo())}setStatus(e){this.status=e,this.emit("update",this.getInfo())}get engine(){var e;return(e=this.room)===null||e===void 0?void 0:e.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}class Fp extends Vt{get description(){return"Cloud regions"}perform(){return S(this,void 0,void 0,function*(){const e=new ne(this.url,this.token);if(!e.isCloud()){this.skip();return}const t=[],i=new Set;for(let s=0;s<3;s++){const a=yield e.getNextBestRegionUrl();if(!a)break;if(i.has(a))continue;i.add(a);const o=yield this.checkCloudRegion(a);this.appendMessage("".concat(o.region," RTT: ").concat(o.rtt,"ms, duration: ").concat(o.duration,"ms")),t.push(o)}t.sort((s,a)=>(s.duration-a.duration)*.5+(s.rtt-a.rtt)*.5);const r=t[0];this.bestStats=r,this.appendMessage("best Cloud region: ".concat(r.region))})}getInfo(){const e=super.getInfo();return e.data=this.bestStats,e}checkCloudRegion(e){return S(this,void 0,void 0,function*(){var t,i;yield this.connect(e),this.options.protocol==="tcp"&&(yield this.switchProtocol("tcp"));const r=(t=this.room.serverInfo)===null||t===void 0?void 0:t.region;if(!r)throw new Error("Region not found");const s=yield this.room.localParticipant.streamText({topic:"test"}),a=1e3,c=1e6/a,l="A".repeat(a),u=Date.now();for(let b=0;b<c;b++)yield s.write(l);yield s.close();const d=Date.now(),h=yield(i=this.room.engine.pcManager)===null||i===void 0?void 0:i.publisher.getStats(),p={region:r,rtt:1e4,duration:d-u};return h?.forEach(b=>{b.type==="candidate-pair"&&b.nominated&&(p.rtt=b.currentRoundTripTime*1e3)}),yield this.disconnect(),p})}}const Cr=1e4;class jp extends Vt{get description(){return"Connection via UDP vs TCP"}perform(){return S(this,void 0,void 0,function*(){const e=yield this.checkConnectionProtocol("udp"),t=yield this.checkConnectionProtocol("tcp");this.bestStats=e,e.qualityLimitationDurations.bandwidth-t.qualityLimitationDurations.bandwidth>.5||(e.packetsLost-t.packetsLost)/e.packetsSent>.01?(this.appendMessage("best connection quality via tcp"),this.bestStats=t):this.appendMessage("best connection quality via udp");const i=this.bestStats;this.appendMessage("upstream bitrate: ".concat((i.bitrateTotal/i.count/1e3/1e3).toFixed(2)," mbps")),this.appendMessage("RTT: ".concat((i.rttTotal/i.count*1e3).toFixed(2)," ms")),this.appendMessage("jitter: ".concat((i.jitterTotal/i.count*1e3).toFixed(2)," ms")),i.packetsLost>0&&this.appendWarning("packets lost: ".concat((i.packetsLost/i.packetsSent*100).toFixed(2),"%")),i.qualityLimitationDurations.bandwidth>1&&this.appendWarning("bandwidth limited ".concat((i.qualityLimitationDurations.bandwidth/(Cr/1e3)*100).toFixed(2),"%")),i.qualityLimitationDurations.cpu>0&&this.appendWarning("cpu limited ".concat((i.qualityLimitationDurations.cpu/(Cr/1e3)*100).toFixed(2),"%"))})}getInfo(){const e=super.getInfo();return e.data=this.bestStats,e}checkConnectionProtocol(e){return S(this,void 0,void 0,function*(){yield this.connect(),e==="tcp"?yield this.switchProtocol("tcp"):yield this.switchProtocol("udp");const t=document.createElement("canvas");t.width=1280,t.height=720;const i=t.getContext("2d");if(!i)throw new Error("Could not get canvas context");let r=0;const s=()=>{r=(r+1)%360,i.fillStyle="hsl(".concat(r,", 100%, 50%)"),i.fillRect(0,0,t.width,t.height),requestAnimationFrame(s)};s();const o=t.captureStream(30).getVideoTracks()[0],l=(yield this.room.localParticipant.publishTrack(o,{simulcast:!1,degradationPreference:"maintain-resolution",videoEncoding:{maxBitrate:2e6}})).track,u={protocol:e,packetsLost:0,packetsSent:0,qualityLimitationDurations:{},rttTotal:0,jitterTotal:0,bitrateTotal:0,count:0},d=setInterval(()=>S(this,void 0,void 0,function*(){const h=yield l.getRTCStatsReport();h?.forEach(p=>{p.type==="outbound-rtp"?(u.packetsSent=p.packetsSent,u.qualityLimitationDurations=p.qualityLimitationDurations,u.bitrateTotal+=p.targetBitrate,u.count++):p.type==="remote-inbound-rtp"&&(u.packetsLost=p.packetsLost,u.rttTotal+=p.roundTripTime,u.jitterTotal+=p.jitter)})}),1e3);return yield new Promise(h=>setTimeout(h,Cr)),clearInterval(d),o.stop(),t.remove(),yield this.disconnect(),u})}}class Bp extends Vt{get description(){return"Can publish audio"}perform(){return S(this,void 0,void 0,function*(){var e;const t=yield this.connect(),i=yield Ap();if(yield hl(i,1e3))throw new Error("unable to detect audio from microphone");this.appendMessage("detected audio from microphone"),t.localParticipant.publishTrack(i),yield new Promise(o=>setTimeout(o,3e3));const s=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!s)throw new Error("Could not get RTCStats");let a=0;if(s.forEach(o=>{o.type==="outbound-rtp"&&(o.kind==="audio"||!o.kind&&o.mediaType==="audio")&&(a=o.packetsSent)}),a===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(a," audio packets"))})}}class Vp extends Vt{get description(){return"Can publish video"}perform(){return S(this,void 0,void 0,function*(){var e;const t=yield this.connect(),i=yield Mp();yield this.checkForVideo(i.mediaStreamTrack),t.localParticipant.publishTrack(i),yield new Promise(a=>setTimeout(a,5e3));const r=yield(e=i.sender)===null||e===void 0?void 0:e.getStats();if(!r)throw new Error("Could not get RTCStats");let s=0;if(r.forEach(a=>{a.type==="outbound-rtp"&&(a.kind==="video"||!a.kind&&a.mediaType==="video")&&(s+=a.packetsSent)}),s===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(s," video packets"))})}checkForVideo(e){return S(this,void 0,void 0,function*(){const t=new MediaStream;t.addTrack(e.clone());const i=document.createElement("video");i.srcObject=t,i.muted=!0,i.autoplay=!0,i.playsInline=!0,i.setAttribute("playsinline","true"),document.body.appendChild(i),yield new Promise(r=>{i.onplay=()=>{setTimeout(()=>{var s,a,o,c;const l=document.createElement("canvas"),u=e.getSettings(),d=(a=(s=u.width)!==null&&s!==void 0?s:i.videoWidth)!==null&&a!==void 0?a:1280,h=(c=(o=u.height)!==null&&o!==void 0?o:i.videoHeight)!==null&&c!==void 0?c:720;l.width=d,l.height=h;const p=l.getContext("2d");p.drawImage(i,0,0);const m=p.getImageData(0,0,l.width,l.height).data;let T=!0;for(let k=0;k<m.length;k+=4)if(m[k]!==0||m[k+1]!==0||m[k+2]!==0){T=!1;break}T?this.appendError("camera appears to be producing only black frames"):this.appendMessage("received video frames"),r()},1e3)},i.play()}),t.getTracks().forEach(r=>r.stop()),i.remove()})}}class qp extends Vt{get description(){return"Resuming connection after interruption"}perform(){return S(this,void 0,void 0,function*(){var e;const t=yield this.connect();let i=!1,r=!1,s;const a=new Promise(l=>{setTimeout(l,5e3),s=l}),o=()=>{i=!0};t.on(I.SignalReconnecting,o).on(I.Reconnecting,o).on(I.Reconnected,()=>{r=!0,s(!0)}),(e=t.engine.client.ws)===null||e===void 0||e.close();const c=t.engine.client.onClose;if(c&&c(""),yield a,i){if(!r||t.state!==Z.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class Wp extends Vt{get description(){return"Can connect via TURN"}perform(){return S(this,void 0,void 0,function*(){var e,t,i;mn(new URL(this.url))&&(this.appendMessage("Using region specific url"),this.url=(e=yield new ne(this.url,this.token).getNextBestRegionUrl())!==null&&e!==void 0?e:this.url);const r=new Is,s=yield r.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3},void 0,!0);let a=!1,o=!1,c=!1;for(let l of s.iceServers)for(let u of l.urls)u.startsWith("turn:")?(o=!0,c=!0):u.startsWith("turns:")&&(o=!0,c=!0,a=!0),u.startsWith("stun:")&&(c=!0);c?o&&!a&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield r.close(),!((i=(t=this.connectOptions)===null||t===void 0?void 0:t.rtcConfig)===null||i===void 0)&&i.iceServers||o?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(l=>setTimeout(l,0)))})}}class Hp extends Vt{get description(){return"Establishing WebRTC connection"}perform(){return S(this,void 0,void 0,function*(){let e=!1,t=!1;this.room.on(I.SignalConnected,()=>{var i;const r=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(s,a)=>{if(s.candidate){const o=new RTCIceCandidate(s);let c="".concat(o.protocol," ").concat(o.address,":").concat(o.port," ").concat(o.type);o.address&&(Kp(o.address)?c+=" (private)":o.protocol==="tcp"&&o.tcpType==="passive"?(e=!0,c+=" (passive)"):o.protocol==="udp"&&(t=!0)),this.appendMessage(c)}r&&r(s,a)},!((i=this.room.engine.pcManager)===null||i===void 0)&&i.subscriber&&(this.room.engine.pcManager.subscriber.onIceCandidateError=s=>{s instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(s.errorCode," ").concat(s.errorText," ").concat(s.url))})});try{yield this.connect(),K.info("now the room is connected")}catch(i){throw this.appendWarning("ports need to be open on firewall in order to connect."),i}e||this.appendWarning("Server is not configured for ICE/TCP"),t||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function Kp(n){const e=n.split(".");if(e.length===4){if(e[0]==="10")return!0;if(e[0]==="192"&&e[1]==="168")return!0;if(e[0]==="172"){const t=parseInt(e[1],10);if(t>=16&&t<=31)return!0}}return!1}class zp extends Vt{get description(){return"Connecting to signal connection via WebSocket"}perform(){return S(this,void 0,void 0,function*(){var e,t,i;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let r=new Is,s;try{s=yield r.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3},void 0,!0)}catch(a){if(mn(new URL(this.url))){this.appendMessage("Initial connection failed with error ".concat(a.message,". Retrying with region fallback"));const c=yield new ne(this.url,this.token).getNextBestRegionUrl();c&&(s=yield r.join(c,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3},void 0,!0),this.appendMessage("Fallback to region worked. To avoid initial connections failing, ensure you're calling room.prepareConnection() ahead of time"))}}s?(this.appendMessage("Connected to server, version ".concat(s.serverVersion,".")),((e=s.serverInfo)===null||e===void 0?void 0:e.edition)===gc.Cloud&&(!((t=s.serverInfo)===null||t===void 0)&&t.region)&&this.appendMessage("LiveKit Cloud: ".concat((i=s.serverInfo)===null||i===void 0?void 0:i.region))):this.appendError("Websocket connection could not be established"),yield r.close()})}}class yy extends dt.EventEmitter{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=e,this.token=t,this.options=i}getNextCheckId(){const e=this.checkResults.size;return this.checkResults.set(e,{logs:[],status:Ke.IDLE,name:"",description:""}),e}updateCheck(e,t){this.checkResults.set(e,t),this.emit("checkUpdate",e,t)}isSuccess(){return Array.from(this.checkResults.values()).every(e=>e.status!==Ke.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(e){return S(this,void 0,void 0,function*(){const t=this.getNextCheckId(),i=new e(this.url,this.token,this.options),r=a=>{this.updateCheck(t,a)};i.on("update",r);const s=yield i.run();return i.off("update",r),s})}checkWebsocket(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(zp)})}checkWebRTC(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(Hp)})}checkTURN(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(Wp)})}checkReconnect(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(qp)})}checkPublishAudio(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(Bp)})}checkPublishVideo(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(Vp)})}checkConnectionProtocol(){return S(this,void 0,void 0,function*(){const e=yield this.createAndRunCheck(jp);if(e.data&&"protocol"in e.data){const t=e.data;this.options.protocol=t.protocol}return e})}checkCloudRegion(){return S(this,void 0,void 0,function*(){return this.createAndRunCheck(Fp)})}}function Y(n,e,t){return(e=$p(e))in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Gp(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e);if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function $p(n){var e=Gp(n,"string");return typeof e=="symbol"?e:e+""}new TextEncoder;new TextDecoder;class Ae extends Error{constructor(e,t){var i;super(e,t),Y(this,"code","ERR_JOSE_GENERIC"),this.name=this.constructor.name,(i=Error.captureStackTrace)===null||i===void 0||i.call(Error,this,this.constructor)}}Y(Ae,"code","ERR_JOSE_GENERIC");class Jp extends Ae{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unspecified",r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"unspecified";super(e,{cause:{claim:i,reason:r,payload:t}}),Y(this,"code","ERR_JWT_CLAIM_VALIDATION_FAILED"),Y(this,"claim",void 0),Y(this,"reason",void 0),Y(this,"payload",void 0),this.claim=i,this.reason=r,this.payload=t}}Y(Jp,"code","ERR_JWT_CLAIM_VALIDATION_FAILED");class Yp extends Ae{constructor(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unspecified",r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"unspecified";super(e,{cause:{claim:i,reason:r,payload:t}}),Y(this,"code","ERR_JWT_EXPIRED"),Y(this,"claim",void 0),Y(this,"reason",void 0),Y(this,"payload",void 0),this.claim=i,this.reason=r,this.payload=t}}Y(Yp,"code","ERR_JWT_EXPIRED");class Qp extends Ae{constructor(){super(...arguments),Y(this,"code","ERR_JOSE_ALG_NOT_ALLOWED")}}Y(Qp,"code","ERR_JOSE_ALG_NOT_ALLOWED");class Xp extends Ae{constructor(){super(...arguments),Y(this,"code","ERR_JOSE_NOT_SUPPORTED")}}Y(Xp,"code","ERR_JOSE_NOT_SUPPORTED");class Zp extends Ae{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"decryption operation failed",t=arguments.length>1?arguments[1]:void 0;super(e,t),Y(this,"code","ERR_JWE_DECRYPTION_FAILED")}}Y(Zp,"code","ERR_JWE_DECRYPTION_FAILED");class em extends Ae{constructor(){super(...arguments),Y(this,"code","ERR_JWE_INVALID")}}Y(em,"code","ERR_JWE_INVALID");class tm extends Ae{constructor(){super(...arguments),Y(this,"code","ERR_JWS_INVALID")}}Y(tm,"code","ERR_JWS_INVALID");class nm extends Ae{constructor(){super(...arguments),Y(this,"code","ERR_JWT_INVALID")}}Y(nm,"code","ERR_JWT_INVALID");class im extends Ae{constructor(){super(...arguments),Y(this,"code","ERR_JWK_INVALID")}}Y(im,"code","ERR_JWK_INVALID");class rm extends Ae{constructor(){super(...arguments),Y(this,"code","ERR_JWKS_INVALID")}}Y(rm,"code","ERR_JWKS_INVALID");class sm extends Ae{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"no applicable key found in the JSON Web Key Set",t=arguments.length>1?arguments[1]:void 0;super(e,t),Y(this,"code","ERR_JWKS_NO_MATCHING_KEY")}}Y(sm,"code","ERR_JWKS_NO_MATCHING_KEY");class om extends Ae{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"multiple matching keys found in the JSON Web Key Set",t=arguments.length>1?arguments[1]:void 0;super(e,t),Y(this,Symbol.asyncIterator,void 0),Y(this,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS")}}Y(om,"code","ERR_JWKS_MULTIPLE_MATCHING_KEYS");class am extends Ae{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"request timed out",t=arguments.length>1?arguments[1]:void 0;super(e,t),Y(this,"code","ERR_JWKS_TIMEOUT")}}Y(am,"code","ERR_JWKS_TIMEOUT");class cm extends Ae{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"signature verification failed",t=arguments.length>1?arguments[1]:void 0;super(e,t),Y(this,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED")}}Y(cm,"code","ERR_JWS_SIGNATURE_VERIFICATION_FAILED");function lm(n){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var t;const i=Ht(n)?n.mediaStreamTrack:n,r=i.getSettings();let s={facingMode:(t=e.defaultFacingMode)!==null&&t!==void 0?t:"user",confidence:"low"};if("facingMode"in r){const a=r.facingMode;K.trace("rawFacingMode",{rawFacingMode:a}),a&&typeof a=="string"&&hm(a)&&(s={facingMode:a,confidence:"high"})}if(["low","medium"].includes(s.confidence)){K.trace("Try to get facing mode from device label: (".concat(i.label,")"));const a=dm(i.label);a!==void 0&&(s=a)}return s}const ua=new Map([["obs virtual camera",{facingMode:"environment",confidence:"medium"}]]),um=new Map([["iphone",{facingMode:"environment",confidence:"medium"}],["ipad",{facingMode:"environment",confidence:"medium"}]]);function dm(n){var e;const t=n.trim().toLowerCase();if(t!=="")return ua.has(t)?ua.get(t):(e=Array.from(um.entries()).find(i=>{let[r]=i;return t.includes(r)}))===null||e===void 0?void 0:e[1]}function hm(n){return n===void 0||["user","environment","left","right"].includes(n)}const Oi=Math.min,Kt=Math.max,xi=Math.round,Zn=Math.floor,ct=n=>({x:n,y:n}),fm={left:"right",right:"left",bottom:"top",top:"bottom"},pm={start:"end",end:"start"};function da(n,e,t){return Kt(n,Oi(e,t))}function Gi(n,e){return typeof n=="function"?n(e):n}function Jt(n){return n.split("-")[0]}function $i(n){return n.split("-")[1]}function Ml(n){return n==="x"?"y":"x"}function Al(n){return n==="y"?"height":"width"}const mm=new Set(["top","bottom"]);function Mt(n){return mm.has(Jt(n))?"y":"x"}function Dl(n){return Ml(Mt(n))}function gm(n,e,t){t===void 0&&(t=!1);const i=$i(n),r=Dl(n),s=Al(r);let a=r==="x"?i===(t?"end":"start")?"right":"left":i==="start"?"bottom":"top";return e.reference[s]>e.floating[s]&&(a=Mi(a)),[a,Mi(a)]}function vm(n){const e=Mi(n);return[es(n),e,es(e)]}function es(n){return n.replace(/start|end/g,e=>pm[e])}const ha=["left","right"],fa=["right","left"],bm=["top","bottom"],ym=["bottom","top"];function km(n,e,t){switch(n){case"top":case"bottom":return t?e?fa:ha:e?ha:fa;case"left":case"right":return e?bm:ym;default:return[]}}function Sm(n,e,t,i){const r=$i(n);let s=km(Jt(n),t==="start",i);return r&&(s=s.map(a=>a+"-"+r),e&&(s=s.concat(s.map(es)))),s}function Mi(n){return n.replace(/left|right|bottom|top/g,e=>fm[e])}function Tm(n){return{top:0,right:0,bottom:0,left:0,...n}}function Cm(n){return typeof n!="number"?Tm(n):{top:n,right:n,bottom:n,left:n}}function Ai(n){const{x:e,y:t,width:i,height:r}=n;return{width:i,height:r,top:t,left:e,right:e+i,bottom:t+r,x:e,y:t}}function pa(n,e,t){let{reference:i,floating:r}=n;const s=Mt(e),a=Dl(e),o=Al(a),c=Jt(e),l=s==="y",u=i.x+i.width/2-r.width/2,d=i.y+i.height/2-r.height/2,h=i[o]/2-r[o]/2;let p;switch(c){case"top":p={x:u,y:i.y-r.height};break;case"bottom":p={x:u,y:i.y+i.height};break;case"right":p={x:i.x+i.width,y:d};break;case"left":p={x:i.x-r.width,y:d};break;default:p={x:i.x,y:i.y}}switch($i(e)){case"start":p[a]-=h*(t&&l?-1:1);break;case"end":p[a]+=h*(t&&l?-1:1);break}return p}const Em=async(n,e,t)=>{const{placement:i="bottom",strategy:r="absolute",middleware:s=[],platform:a}=t,o=s.filter(Boolean),c=await(a.isRTL==null?void 0:a.isRTL(e));let l=await a.getElementRects({reference:n,floating:e,strategy:r}),{x:u,y:d}=pa(l,i,c),h=i,p={},b=0;for(let m=0;m<o.length;m++){const{name:T,fn:k}=o[m],{x:w,y:M,data:v,reset:g}=await k({x:u,y:d,initialPlacement:i,placement:h,strategy:r,middlewareData:p,rects:l,platform:a,elements:{reference:n,floating:e}});u=w??u,d=M??d,p={...p,[T]:{...p[T],...v}},g&&b<=50&&(b++,typeof g=="object"&&(g.placement&&(h=g.placement),g.rects&&(l=g.rects===!0?await a.getElementRects({reference:n,floating:e,strategy:r}):g.rects),{x:u,y:d}=pa(l,h,c)),m=-1)}return{x:u,y:d,placement:h,strategy:r,middlewareData:p}};async function Ll(n,e){var t;e===void 0&&(e={});const{x:i,y:r,platform:s,rects:a,elements:o,strategy:c}=n,{boundary:l="clippingAncestors",rootBoundary:u="viewport",elementContext:d="floating",altBoundary:h=!1,padding:p=0}=Gi(e,n),b=Cm(p),m=o[h?d==="floating"?"reference":"floating":d],T=Ai(await s.getClippingRect({element:(t=await(s.isElement==null?void 0:s.isElement(m)))==null||t?m:m.contextElement||await(s.getDocumentElement==null?void 0:s.getDocumentElement(o.floating)),boundary:l,rootBoundary:u,strategy:c})),k=d==="floating"?{x:i,y:r,width:a.floating.width,height:a.floating.height}:a.reference,w=await(s.getOffsetParent==null?void 0:s.getOffsetParent(o.floating)),M=await(s.isElement==null?void 0:s.isElement(w))?await(s.getScale==null?void 0:s.getScale(w))||{x:1,y:1}:{x:1,y:1},v=Ai(s.convertOffsetParentRelativeRectToViewportRelativeRect?await s.convertOffsetParentRelativeRectToViewportRelativeRect({elements:o,rect:k,offsetParent:w,strategy:c}):k);return{top:(T.top-v.top+b.top)/M.y,bottom:(v.bottom-T.bottom+b.bottom)/M.y,left:(T.left-v.left+b.left)/M.x,right:(v.right-T.right+b.right)/M.x}}const wm=function(n){return n===void 0&&(n={}),{name:"flip",options:n,async fn(e){var t,i;const{placement:r,middlewareData:s,rects:a,initialPlacement:o,platform:c,elements:l}=e,{mainAxis:u=!0,crossAxis:d=!0,fallbackPlacements:h,fallbackStrategy:p="bestFit",fallbackAxisSideDirection:b="none",flipAlignment:m=!0,...T}=Gi(n,e);if((t=s.arrow)!=null&&t.alignmentOffset)return{};const k=Jt(r),w=Mt(o),M=Jt(o)===o,v=await(c.isRTL==null?void 0:c.isRTL(l.floating)),g=h||(M||!m?[Mi(o)]:vm(o)),y=b!=="none";!h&&y&&g.push(...Sm(o,m,b,v));const C=[o,...g],x=await Ll(e,T),_=[];let O=((i=s.flip)==null?void 0:i.overflows)||[];if(u&&_.push(x[k]),d){const ee=gm(r,a,v);_.push(x[ee[0]],x[ee[1]])}if(O=[...O,{placement:r,overflows:_}],!_.every(ee=>ee<=0)){var D,j;const ee=(((D=s.flip)==null?void 0:D.index)||0)+1,_e=C[ee];if(_e&&(!(d==="alignment"&&w!==Mt(_e))||O.every(re=>Mt(re.placement)===w?re.overflows[0]>0:!0)))return{data:{index:ee,overflows:O},reset:{placement:_e}};let te=(j=O.filter(re=>re.overflows[0]<=0).sort((re,Se)=>re.overflows[1]-Se.overflows[1])[0])==null?void 0:j.placement;if(!te)switch(p){case"bestFit":{var z;const re=(z=O.filter(Se=>{if(y){const we=Mt(Se.placement);return we===w||we==="y"}return!0}).map(Se=>[Se.placement,Se.overflows.filter(we=>we>0).reduce((we,mt)=>we+mt,0)]).sort((Se,we)=>Se[1]-we[1])[0])==null?void 0:z[0];re&&(te=re);break}case"initialPlacement":te=o;break}if(r!==te)return{reset:{placement:te}}}return{}}}},Pm=new Set(["left","top"]);async function Rm(n,e){const{placement:t,platform:i,elements:r}=n,s=await(i.isRTL==null?void 0:i.isRTL(r.floating)),a=Jt(t),o=$i(t),c=Mt(t)==="y",l=Pm.has(a)?-1:1,u=s&&c?-1:1,d=Gi(e,n);let{mainAxis:h,crossAxis:p,alignmentAxis:b}=typeof d=="number"?{mainAxis:d,crossAxis:0,alignmentAxis:null}:{mainAxis:d.mainAxis||0,crossAxis:d.crossAxis||0,alignmentAxis:d.alignmentAxis};return o&&typeof b=="number"&&(p=o==="end"?b*-1:b),c?{x:p*u,y:h*l}:{x:h*l,y:p*u}}const _m=function(n){return n===void 0&&(n=0),{name:"offset",options:n,async fn(e){var t,i;const{x:r,y:s,placement:a,middlewareData:o}=e,c=await Rm(e,n);return a===((t=o.offset)==null?void 0:t.placement)&&(i=o.arrow)!=null&&i.alignmentOffset?{}:{x:r+c.x,y:s+c.y,data:{...c,placement:a}}}}},Im=function(n){return n===void 0&&(n={}),{name:"shift",options:n,async fn(e){const{x:t,y:i,placement:r}=e,{mainAxis:s=!0,crossAxis:a=!1,limiter:o={fn:T=>{let{x:k,y:w}=T;return{x:k,y:w}}},...c}=Gi(n,e),l={x:t,y:i},u=await Ll(e,c),d=Mt(Jt(r)),h=Ml(d);let p=l[h],b=l[d];if(s){const T=h==="y"?"top":"left",k=h==="y"?"bottom":"right",w=p+u[T],M=p-u[k];p=da(w,p,M)}if(a){const T=d==="y"?"top":"left",k=d==="y"?"bottom":"right",w=b+u[T],M=b-u[k];b=da(w,b,M)}const m=o.fn({...e,[h]:p,[d]:b});return{...m,data:{x:m.x-t,y:m.y-i,enabled:{[h]:s,[d]:a}}}}}};function Ji(){return typeof window<"u"}function yn(n){return Nl(n)?(n.nodeName||"").toLowerCase():"#document"}function Be(n){var e;return(n==null||(e=n.ownerDocument)==null?void 0:e.defaultView)||window}function ft(n){var e;return(e=(Nl(n)?n.ownerDocument:n.document)||window.document)==null?void 0:e.documentElement}function Nl(n){return Ji()?n instanceof Node||n instanceof Be(n).Node:!1}function Ze(n){return Ji()?n instanceof Element||n instanceof Be(n).Element:!1}function ut(n){return Ji()?n instanceof HTMLElement||n instanceof Be(n).HTMLElement:!1}function ma(n){return!Ji()||typeof ShadowRoot>"u"?!1:n instanceof ShadowRoot||n instanceof Be(n).ShadowRoot}const Om=new Set(["inline","contents"]);function zn(n){const{overflow:e,overflowX:t,overflowY:i,display:r}=et(n);return/auto|scroll|overlay|hidden|clip/.test(e+i+t)&&!Om.has(r)}const xm=new Set(["table","td","th"]);function Mm(n){return xm.has(yn(n))}const Am=[":popover-open",":modal"];function Yi(n){return Am.some(e=>{try{return n.matches(e)}catch{return!1}})}const Dm=["transform","translate","scale","rotate","perspective"],Lm=["transform","translate","scale","rotate","perspective","filter"],Nm=["paint","layout","strict","content"];function Us(n){const e=Fs(),t=Ze(n)?et(n):n;return Dm.some(i=>t[i]?t[i]!=="none":!1)||(t.containerType?t.containerType!=="normal":!1)||!e&&(t.backdropFilter?t.backdropFilter!=="none":!1)||!e&&(t.filter?t.filter!=="none":!1)||Lm.some(i=>(t.willChange||"").includes(i))||Nm.some(i=>(t.contain||"").includes(i))}function Um(n){let e=jt(n);for(;ut(e)&&!gn(e);){if(Us(e))return e;if(Yi(e))return null;e=jt(e)}return null}function Fs(){return typeof CSS>"u"||!CSS.supports?!1:CSS.supports("-webkit-backdrop-filter","none")}const Fm=new Set(["html","body","#document"]);function gn(n){return Fm.has(yn(n))}function et(n){return Be(n).getComputedStyle(n)}function Qi(n){return Ze(n)?{scrollLeft:n.scrollLeft,scrollTop:n.scrollTop}:{scrollLeft:n.scrollX,scrollTop:n.scrollY}}function jt(n){if(yn(n)==="html")return n;const e=n.assignedSlot||n.parentNode||ma(n)&&n.host||ft(n);return ma(e)?e.host:e}function Ul(n){const e=jt(n);return gn(e)?n.ownerDocument?n.ownerDocument.body:n.body:ut(e)&&zn(e)?e:Ul(e)}function Wn(n,e,t){var i;e===void 0&&(e=[]),t===void 0&&(t=!0);const r=Ul(n),s=r===((i=n.ownerDocument)==null?void 0:i.body),a=Be(r);if(s){const o=ts(a);return e.concat(a,a.visualViewport||[],zn(r)?r:[],o&&t?Wn(o):[])}return e.concat(r,Wn(r,[],t))}function ts(n){return n.parent&&Object.getPrototypeOf(n.parent)?n.frameElement:null}function Fl(n){const e=et(n);let t=parseFloat(e.width)||0,i=parseFloat(e.height)||0;const r=ut(n),s=r?n.offsetWidth:t,a=r?n.offsetHeight:i,o=xi(t)!==s||xi(i)!==a;return o&&(t=s,i=a),{width:t,height:i,$:o}}function js(n){return Ze(n)?n:n.contextElement}function hn(n){const e=js(n);if(!ut(e))return ct(1);const t=e.getBoundingClientRect(),{width:i,height:r,$:s}=Fl(e);let a=(s?xi(t.width):t.width)/i,o=(s?xi(t.height):t.height)/r;return(!a||!Number.isFinite(a))&&(a=1),(!o||!Number.isFinite(o))&&(o=1),{x:a,y:o}}const jm=ct(0);function jl(n){const e=Be(n);return!Fs()||!e.visualViewport?jm:{x:e.visualViewport.offsetLeft,y:e.visualViewport.offsetTop}}function Bm(n,e,t){return e===void 0&&(e=!1),!t||e&&t!==Be(n)?!1:e}function Yt(n,e,t,i){e===void 0&&(e=!1),t===void 0&&(t=!1);const r=n.getBoundingClientRect(),s=js(n);let a=ct(1);e&&(i?Ze(i)&&(a=hn(i)):a=hn(n));const o=Bm(s,t,i)?jl(s):ct(0);let c=(r.left+o.x)/a.x,l=(r.top+o.y)/a.y,u=r.width/a.x,d=r.height/a.y;if(s){const h=Be(s),p=i&&Ze(i)?Be(i):i;let b=h,m=ts(b);for(;m&&i&&p!==b;){const T=hn(m),k=m.getBoundingClientRect(),w=et(m),M=k.left+(m.clientLeft+parseFloat(w.paddingLeft))*T.x,v=k.top+(m.clientTop+parseFloat(w.paddingTop))*T.y;c*=T.x,l*=T.y,u*=T.x,d*=T.y,c+=M,l+=v,b=Be(m),m=ts(b)}}return Ai({width:u,height:d,x:c,y:l})}function Xi(n,e){const t=Qi(n).scrollLeft;return e?e.left+t:Yt(ft(n)).left+t}function Bl(n,e){const t=n.getBoundingClientRect(),i=t.left+e.scrollLeft-Xi(n,t),r=t.top+e.scrollTop;return{x:i,y:r}}function Vm(n){let{elements:e,rect:t,offsetParent:i,strategy:r}=n;const s=r==="fixed",a=ft(i),o=e?Yi(e.floating):!1;if(i===a||o&&s)return t;let c={scrollLeft:0,scrollTop:0},l=ct(1);const u=ct(0),d=ut(i);if((d||!d&&!s)&&((yn(i)!=="body"||zn(a))&&(c=Qi(i)),ut(i))){const p=Yt(i);l=hn(i),u.x=p.x+i.clientLeft,u.y=p.y+i.clientTop}const h=a&&!d&&!s?Bl(a,c):ct(0);return{width:t.width*l.x,height:t.height*l.y,x:t.x*l.x-c.scrollLeft*l.x+u.x+h.x,y:t.y*l.y-c.scrollTop*l.y+u.y+h.y}}function qm(n){return Array.from(n.getClientRects())}function Wm(n){const e=ft(n),t=Qi(n),i=n.ownerDocument.body,r=Kt(e.scrollWidth,e.clientWidth,i.scrollWidth,i.clientWidth),s=Kt(e.scrollHeight,e.clientHeight,i.scrollHeight,i.clientHeight);let a=-t.scrollLeft+Xi(n);const o=-t.scrollTop;return et(i).direction==="rtl"&&(a+=Kt(e.clientWidth,i.clientWidth)-r),{width:r,height:s,x:a,y:o}}const ga=25;function Hm(n,e){const t=Be(n),i=ft(n),r=t.visualViewport;let s=i.clientWidth,a=i.clientHeight,o=0,c=0;if(r){s=r.width,a=r.height;const u=Fs();(!u||u&&e==="fixed")&&(o=r.offsetLeft,c=r.offsetTop)}const l=Xi(i);if(l<=0){const u=i.ownerDocument,d=u.body,h=getComputedStyle(d),p=u.compatMode==="CSS1Compat"&&parseFloat(h.marginLeft)+parseFloat(h.marginRight)||0,b=Math.abs(i.clientWidth-d.clientWidth-p);b<=ga&&(s-=b)}else l<=ga&&(s+=l);return{width:s,height:a,x:o,y:c}}const Km=new Set(["absolute","fixed"]);function zm(n,e){const t=Yt(n,!0,e==="fixed"),i=t.top+n.clientTop,r=t.left+n.clientLeft,s=ut(n)?hn(n):ct(1),a=n.clientWidth*s.x,o=n.clientHeight*s.y,c=r*s.x,l=i*s.y;return{width:a,height:o,x:c,y:l}}function va(n,e,t){let i;if(e==="viewport")i=Hm(n,t);else if(e==="document")i=Wm(ft(n));else if(Ze(e))i=zm(e,t);else{const r=jl(n);i={x:e.x-r.x,y:e.y-r.y,width:e.width,height:e.height}}return Ai(i)}function Vl(n,e){const t=jt(n);return t===e||!Ze(t)||gn(t)?!1:et(t).position==="fixed"||Vl(t,e)}function Gm(n,e){const t=e.get(n);if(t)return t;let i=Wn(n,[],!1).filter(o=>Ze(o)&&yn(o)!=="body"),r=null;const s=et(n).position==="fixed";let a=s?jt(n):n;for(;Ze(a)&&!gn(a);){const o=et(a),c=Us(a);!c&&o.position==="fixed"&&(r=null),(s?!c&&!r:!c&&o.position==="static"&&r&&Km.has(r.position)||zn(a)&&!c&&Vl(n,a))?i=i.filter(l=>l!==a):r=o,a=jt(a)}return e.set(n,i),i}function $m(n){let{element:e,boundary:t,rootBoundary:i,strategy:r}=n;const s=[...t==="clippingAncestors"?Yi(e)?[]:Gm(e,this._c):[].concat(t),i],a=s[0],o=s.reduce((c,l)=>{const u=va(e,l,r);return c.top=Kt(u.top,c.top),c.right=Oi(u.right,c.right),c.bottom=Oi(u.bottom,c.bottom),c.left=Kt(u.left,c.left),c},va(e,a,r));return{width:o.right-o.left,height:o.bottom-o.top,x:o.left,y:o.top}}function Jm(n){const{width:e,height:t}=Fl(n);return{width:e,height:t}}function Ym(n,e,t){const i=ut(e),r=ft(e),s=t==="fixed",a=Yt(n,!0,s,e);let o={scrollLeft:0,scrollTop:0};const c=ct(0);function l(){c.x=Xi(r)}if(i||!i&&!s)if((yn(e)!=="body"||zn(r))&&(o=Qi(e)),i){const p=Yt(e,!0,s,e);c.x=p.x+e.clientLeft,c.y=p.y+e.clientTop}else r&&l();s&&!i&&r&&l();const u=r&&!i&&!s?Bl(r,o):ct(0),d=a.left+o.scrollLeft-c.x-u.x,h=a.top+o.scrollTop-c.y-u.y;return{x:d,y:h,width:a.width,height:a.height}}function Er(n){return et(n).position==="static"}function ba(n,e){if(!ut(n)||et(n).position==="fixed")return null;if(e)return e(n);let t=n.offsetParent;return ft(n)===t&&(t=t.ownerDocument.body),t}function ql(n,e){const t=Be(n);if(Yi(n))return t;if(!ut(n)){let r=jt(n);for(;r&&!gn(r);){if(Ze(r)&&!Er(r))return r;r=jt(r)}return t}let i=ba(n,e);for(;i&&Mm(i)&&Er(i);)i=ba(i,e);return i&&gn(i)&&Er(i)&&!Us(i)?t:i||Um(n)||t}const Qm=async function(n){const e=this.getOffsetParent||ql,t=this.getDimensions,i=await t(n.floating);return{reference:Ym(n.reference,await e(n.floating),n.strategy),floating:{x:0,y:0,width:i.width,height:i.height}}};function Xm(n){return et(n).direction==="rtl"}const Zm={convertOffsetParentRelativeRectToViewportRelativeRect:Vm,getDocumentElement:ft,getClippingRect:$m,getOffsetParent:ql,getElementRects:Qm,getClientRects:qm,getDimensions:Jm,getScale:hn,isElement:Ze,isRTL:Xm};function Wl(n,e){return n.x===e.x&&n.y===e.y&&n.width===e.width&&n.height===e.height}function eg(n,e){let t=null,i;const r=ft(n);function s(){var o;clearTimeout(i),(o=t)==null||o.disconnect(),t=null}function a(o,c){o===void 0&&(o=!1),c===void 0&&(c=1),s();const l=n.getBoundingClientRect(),{left:u,top:d,width:h,height:p}=l;if(o||e(),!h||!p)return;const b=Zn(d),m=Zn(r.clientWidth-(u+h)),T=Zn(r.clientHeight-(d+p)),k=Zn(u),w={rootMargin:-b+"px "+-m+"px "+-T+"px "+-k+"px",threshold:Kt(0,Oi(1,c))||1};let M=!0;function v(g){const y=g[0].intersectionRatio;if(y!==c){if(!M)return a();y?a(!1,y):i=setTimeout(()=>{a(!1,1e-7)},1e3)}y===1&&!Wl(l,n.getBoundingClientRect())&&a(),M=!1}try{t=new IntersectionObserver(v,{...w,root:r.ownerDocument})}catch{t=new IntersectionObserver(v,w)}t.observe(n)}return a(!0),s}function tg(n,e,t,i){i===void 0&&(i={});const{ancestorScroll:r=!0,ancestorResize:s=!0,elementResize:a=typeof ResizeObserver=="function",layoutShift:o=typeof IntersectionObserver=="function",animationFrame:c=!1}=i,l=js(n),u=r||s?[...l?Wn(l):[],...Wn(e)]:[];u.forEach(k=>{r&&k.addEventListener("scroll",t,{passive:!0}),s&&k.addEventListener("resize",t)});const d=l&&o?eg(l,t):null;let h=-1,p=null;a&&(p=new ResizeObserver(k=>{let[w]=k;w&&w.target===l&&p&&(p.unobserve(e),cancelAnimationFrame(h),h=requestAnimationFrame(()=>{var M;(M=p)==null||M.observe(e)})),t()}),l&&!c&&p.observe(l),p.observe(e));let b,m=c?Yt(n):null;c&&T();function T(){const k=Yt(n);m&&!Wl(m,k)&&t(),m=k,b=requestAnimationFrame(T)}return t(),()=>{var k;u.forEach(w=>{r&&w.removeEventListener("scroll",t),s&&w.removeEventListener("resize",t)}),d?.(),(k=p)==null||k.disconnect(),p=null,c&&cancelAnimationFrame(b)}}const ng=_m,ig=Im,rg=wm,sg=(n,e,t)=>{const i=new Map,r={platform:Zm,...t},s={...r.platform,_c:i};return Em(n,e,{...r,platform:s})};var ei=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Hl(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ns={exports:{}},og=ns.exports,ya;function ag(){return ya||(ya=1,(function(n){(function(e,t){n.exports?n.exports=t():e.log=t()})(og,function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},a=null;function o(m,T){var k=m[T];if(typeof k.bind=="function")return k.bind(m);try{return Function.prototype.bind.call(k,m)}catch{return function(){return Function.prototype.apply.apply(k,[m,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(m){return m==="debug"&&(m="log"),typeof console===t?!1:m==="trace"&&i?c:console[m]!==void 0?o(console,m):console.log!==void 0?o(console,"log"):e}function u(){for(var m=this.getLevel(),T=0;T<r.length;T++){var k=r[T];this[k]=T<m?e:this.methodFactory(k,m,this.name)}if(this.log=this.debug,typeof console===t&&m<this.levels.SILENT)return"No console available for logging"}function d(m){return function(){typeof console!==t&&(u.call(this),this[m].apply(this,arguments))}}function h(m,T,k){return l(m)||d.apply(this,arguments)}function p(m,T){var k=this,w,M,v,g="loglevel";typeof m=="string"?g+=":"+m:typeof m=="symbol"&&(g=void 0);function y(D){var j=(r[D]||"silent").toUpperCase();if(!(typeof window===t||!g)){try{window.localStorage[g]=j;return}catch{}try{window.document.cookie=encodeURIComponent(g)+"="+j+";"}catch{}}}function C(){var D;if(!(typeof window===t||!g)){try{D=window.localStorage[g]}catch{}if(typeof D===t)try{var j=window.document.cookie,z=encodeURIComponent(g),ee=j.indexOf(z+"=");ee!==-1&&(D=/^([^;]+)/.exec(j.slice(ee+z.length+1))[1])}catch{}return k.levels[D]===void 0&&(D=void 0),D}}function x(){if(!(typeof window===t||!g)){try{window.localStorage.removeItem(g)}catch{}try{window.document.cookie=encodeURIComponent(g)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function _(D){var j=D;if(typeof j=="string"&&k.levels[j.toUpperCase()]!==void 0&&(j=k.levels[j.toUpperCase()]),typeof j=="number"&&j>=0&&j<=k.levels.SILENT)return j;throw new TypeError("log.setLevel() called with invalid level: "+D)}k.name=m,k.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},k.methodFactory=T||h,k.getLevel=function(){return v??M??w},k.setLevel=function(D,j){return v=_(D),j!==!1&&y(v),u.call(k)},k.setDefaultLevel=function(D){M=_(D),C()||k.setLevel(D,!1)},k.resetLevel=function(){v=null,x(),u.call(k)},k.enableAll=function(D){k.setLevel(k.levels.TRACE,D)},k.disableAll=function(D){k.setLevel(k.levels.SILENT,D)},k.rebuild=function(){if(a!==k&&(w=_(a.getLevel())),u.call(k),a===k)for(var D in s)s[D].rebuild()},w=_(a?a.getLevel():"WARN");var O=C();O!=null&&(v=_(O)),u.call(k)}a=new p,a.getLogger=function(m){if(typeof m!="symbol"&&typeof m!="string"||m==="")throw new TypeError("You must supply a name when creating a logger.");var T=s[m];return T||(T=s[m]=new p(m,a.methodFactory)),T};var b=typeof window!==t?window.log:void 0;return a.noConflict=function(){return typeof window!==t&&window.log===a&&(window.log=b),a},a.getLoggers=function(){return s},a.default=a,a})})(ns)),ns.exports}var cg=ag();const lg=Hl(cg);var is=function(n,e){return is=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])},is(n,e)};function Et(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");is(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function ug(n,e,t,i){function r(s){return s instanceof t?s:new t(function(a){a(s)})}return new(t||(t=Promise))(function(s,a){function o(u){try{l(i.next(u))}catch(d){a(d)}}function c(u){try{l(i.throw(u))}catch(d){a(d)}}function l(u){u.done?s(u.value):r(u.value).then(o,c)}l((i=i.apply(n,[])).next())})}function Kl(n,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,r,s,a=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return a.next=o(0),a.throw=o(1),a.return=o(2),typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function o(l){return function(u){return c([l,u])}}function c(l){if(i)throw new TypeError("Generator is already executing.");for(;a&&(a=0,l[0]&&(t=0)),t;)try{if(i=1,r&&(s=l[0]&2?r.return:l[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,l[1])).done)return s;switch(r=0,s&&(l=[l[0]&2,s.value]),l[0]){case 0:case 1:s=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,r=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!s||l[1]>s[0]&&l[1]<s[3])){t.label=l[1];break}if(l[0]===6&&t.label<s[1]){t.label=s[1],s=l;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(l);break}s[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(n,t)}catch(u){l=[6,u],r=0}finally{i=s=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}function vn(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],i=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function bn(n,e){var t=typeof Symbol=="function"&&n[Symbol.iterator];if(!t)return n;var i=t.call(n),r,s=[],a;try{for(;(e===void 0||e-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(o){a={error:o}}finally{try{r&&!r.done&&(t=i.return)&&t.call(i)}finally{if(a)throw a.error}}return s}function Hn(n,e,t){if(arguments.length===2)for(var i=0,r=e.length,s;i<r;i++)(s||!(i in e))&&(s||(s=Array.prototype.slice.call(e,0,i)),s[i]=e[i]);return n.concat(s||Array.prototype.slice.call(e))}function fn(n){return this instanceof fn?(this.v=n,this):new fn(n)}function dg(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(n,e||[]),r,s=[];return r=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",a),r[Symbol.asyncIterator]=function(){return this},r;function a(p){return function(b){return Promise.resolve(b).then(p,d)}}function o(p,b){i[p]&&(r[p]=function(m){return new Promise(function(T,k){s.push([p,m,T,k])>1||c(p,m)})},b&&(r[p]=b(r[p])))}function c(p,b){try{l(i[p](b))}catch(m){h(s[0][3],m)}}function l(p){p.value instanceof fn?Promise.resolve(p.value.v).then(u,d):h(s[0][2],p)}function u(p){c("next",p)}function d(p){c("throw",p)}function h(p,b){p(b),s.shift(),s.length&&c(s[0][0],s[0][1])}}function hg(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=n[Symbol.asyncIterator],t;return e?e.call(n):(n=typeof vn=="function"?vn(n):n[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=n[s]&&function(a){return new Promise(function(o,c){a=n[s](a),r(o,c,a.done,a.value)})}}function r(s,a,o,c){Promise.resolve(c).then(function(l){s({value:l,done:o})},a)}}function ae(n){return typeof n=="function"}function Bs(n){var e=function(i){Error.call(i),i.stack=new Error().stack},t=n(e);return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var wr=Bs(function(n){return function(e){n(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(t,i){return i+1+") "+t.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function Di(n,e){if(n){var t=n.indexOf(e);0<=t&&n.splice(t,1)}}var Gn=(function(){function n(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return n.prototype.unsubscribe=function(){var e,t,i,r,s;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var o=vn(a),c=o.next();!c.done;c=o.next()){var l=c.value;l.remove(this)}}catch(m){e={error:m}}finally{try{c&&!c.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}else a.remove(this);var u=this.initialTeardown;if(ae(u))try{u()}catch(m){s=m instanceof wr?m.errors:[m]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var h=vn(d),p=h.next();!p.done;p=h.next()){var b=p.value;try{ka(b)}catch(m){s=s??[],m instanceof wr?s=Hn(Hn([],bn(s)),bn(m.errors)):s.push(m)}}}catch(m){i={error:m}}finally{try{p&&!p.done&&(r=h.return)&&r.call(h)}finally{if(i)throw i.error}}}if(s)throw new wr(s)}},n.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)ka(e);else{if(e instanceof n){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(t=this._finalizers)!==null&&t!==void 0?t:[]).push(e)}},n.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},n.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},n.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Di(t,e)},n.prototype.remove=function(e){var t=this._finalizers;t&&Di(t,e),e instanceof n&&e._removeParent(this)},n.EMPTY=(function(){var e=new n;return e.closed=!0,e})(),n})(),zl=Gn.EMPTY;function Gl(n){return n instanceof Gn||n&&"closed"in n&&ae(n.remove)&&ae(n.add)&&ae(n.unsubscribe)}function ka(n){ae(n)?n():n.unsubscribe()}var fg={Promise:void 0},pg={setTimeout:function(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return setTimeout.apply(void 0,Hn([n,e],bn(t)))},clearTimeout:function(n){return clearTimeout(n)},delegate:void 0};function $l(n){pg.setTimeout(function(){throw n})}function Li(){}function vi(n){n()}var Vs=(function(n){Et(e,n);function e(t){var i=n.call(this)||this;return i.isStopped=!1,t?(i.destination=t,Gl(t)&&t.add(i)):i.destination=vg,i}return e.create=function(t,i,r){return new rs(t,i,r)},e.prototype.next=function(t){this.isStopped||this._next(t)},e.prototype.error=function(t){this.isStopped||(this.isStopped=!0,this._error(t))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,n.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(t){this.destination.next(t)},e.prototype._error=function(t){try{this.destination.error(t)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e})(Gn),mg=(function(){function n(e){this.partialObserver=e}return n.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(i){ti(i)}},n.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(i){ti(i)}else ti(e)},n.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){ti(t)}},n})(),rs=(function(n){Et(e,n);function e(t,i,r){var s=n.call(this)||this,a;return ae(t)||!t?a={next:t??void 0,error:i??void 0,complete:r??void 0}:a=t,s.destination=new mg(a),s}return e})(Vs);function ti(n){$l(n)}function gg(n){throw n}var vg={closed:!0,next:Li,error:gg,complete:Li},qs=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function Ws(n){return n}function bg(n){return n.length===0?Ws:n.length===1?n[0]:function(e){return n.reduce(function(t,i){return i(t)},e)}}var ke=(function(){function n(e){e&&(this._subscribe=e)}return n.prototype.lift=function(e){var t=new n;return t.source=this,t.operator=e,t},n.prototype.subscribe=function(e,t,i){var r=this,s=kg(e)?e:new rs(e,t,i);return vi(function(){var a=r,o=a.operator,c=a.source;s.add(o?o.call(s,c):c?r._subscribe(s):r._trySubscribe(s))}),s},n.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},n.prototype.forEach=function(e,t){var i=this;return t=Sa(t),new t(function(r,s){var a=new rs({next:function(o){try{e(o)}catch(c){s(c),a.unsubscribe()}},error:s,complete:r});i.subscribe(a)})},n.prototype._subscribe=function(e){var t;return(t=this.source)===null||t===void 0?void 0:t.subscribe(e)},n.prototype[qs]=function(){return this},n.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return bg(e)(this)},n.prototype.toPromise=function(e){var t=this;return e=Sa(e),new e(function(i,r){var s;t.subscribe(function(a){return s=a},function(a){return r(a)},function(){return i(s)})})},n.create=function(e){return new n(e)},n})();function Sa(n){var e;return(e=n??fg.Promise)!==null&&e!==void 0?e:Promise}function yg(n){return n&&ae(n.next)&&ae(n.error)&&ae(n.complete)}function kg(n){return n&&n instanceof Vs||yg(n)&&Gl(n)}function Sg(n){return ae(n?.lift)}function it(n){return function(e){if(Sg(e))return e.lift(function(t){try{return n(t,this)}catch(i){this.error(i)}});throw new TypeError("Unable to lift unknown Observable type")}}function tt(n,e,t,i,r){return new Tg(n,e,t,i,r)}var Tg=(function(n){Et(e,n);function e(t,i,r,s,a,o){var c=n.call(this,t)||this;return c.onFinalize=a,c.shouldUnsubscribe=o,c._next=i?function(l){try{i(l)}catch(u){t.error(u)}}:n.prototype._next,c._error=s?function(l){try{s(l)}catch(u){t.error(u)}finally{this.unsubscribe()}}:n.prototype._error,c._complete=r?function(){try{r()}catch(l){t.error(l)}finally{this.unsubscribe()}}:n.prototype._complete,c}return e.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;n.prototype.unsubscribe.call(this),!i&&((t=this.onFinalize)===null||t===void 0||t.call(this))}},e})(Vs),Cg=Bs(function(n){return function(){n(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Qt=(function(n){Et(e,n);function e(){var t=n.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return e.prototype.lift=function(t){var i=new Ta(this,this);return i.operator=t,i},e.prototype._throwIfClosed=function(){if(this.closed)throw new Cg},e.prototype.next=function(t){var i=this;vi(function(){var r,s;if(i._throwIfClosed(),!i.isStopped){i.currentObservers||(i.currentObservers=Array.from(i.observers));try{for(var a=vn(i.currentObservers),o=a.next();!o.done;o=a.next()){var c=o.value;c.next(t)}}catch(l){r={error:l}}finally{try{o&&!o.done&&(s=a.return)&&s.call(a)}finally{if(r)throw r.error}}}})},e.prototype.error=function(t){var i=this;vi(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=t;for(var r=i.observers;r.length;)r.shift().error(t)}})},e.prototype.complete=function(){var t=this;vi(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var i=t.observers;i.length;)i.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var t;return((t=this.observers)===null||t===void 0?void 0:t.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(t){return this._throwIfClosed(),n.prototype._trySubscribe.call(this,t)},e.prototype._subscribe=function(t){return this._throwIfClosed(),this._checkFinalizedStatuses(t),this._innerSubscribe(t)},e.prototype._innerSubscribe=function(t){var i=this,r=this,s=r.hasError,a=r.isStopped,o=r.observers;return s||a?zl:(this.currentObservers=null,o.push(t),new Gn(function(){i.currentObservers=null,Di(o,t)}))},e.prototype._checkFinalizedStatuses=function(t){var i=this,r=i.hasError,s=i.thrownError,a=i.isStopped;r?t.error(s):a&&t.complete()},e.prototype.asObservable=function(){var t=new ke;return t.source=this,t},e.create=function(t,i){return new Ta(t,i)},e})(ke),Ta=(function(n){Et(e,n);function e(t,i){var r=n.call(this)||this;return r.destination=t,r.source=i,r}return e.prototype.next=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.next)===null||r===void 0||r.call(i,t)},e.prototype.error=function(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.error)===null||r===void 0||r.call(i,t)},e.prototype.complete=function(){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||i===void 0||i.call(t)},e.prototype._subscribe=function(t){var i,r;return(r=(i=this.source)===null||i===void 0?void 0:i.subscribe(t))!==null&&r!==void 0?r:zl},e})(Qt),Jl=(function(n){Et(e,n);function e(t){var i=n.call(this)||this;return i._value=t,i}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(t){var i=n.prototype._subscribe.call(this,t);return!i.closed&&t.next(this._value),i},e.prototype.getValue=function(){var t=this,i=t.hasError,r=t.thrownError,s=t._value;if(i)throw r;return this._throwIfClosed(),s},e.prototype.next=function(t){n.prototype.next.call(this,this._value=t)},e})(Qt),Eg={now:function(){return Date.now()}},wg=(function(n){Et(e,n);function e(t,i){return n.call(this)||this}return e.prototype.schedule=function(t,i){return this},e})(Gn),Ca={setInterval:function(n,e){for(var t=[],i=2;i<arguments.length;i++)t[i-2]=arguments[i];return setInterval.apply(void 0,Hn([n,e],bn(t)))},clearInterval:function(n){return clearInterval(n)},delegate:void 0},Pg=(function(n){Et(e,n);function e(t,i){var r=n.call(this,t,i)||this;return r.scheduler=t,r.work=i,r.pending=!1,r}return e.prototype.schedule=function(t,i){var r;if(i===void 0&&(i=0),this.closed)return this;this.state=t;var s=this.id,a=this.scheduler;return s!=null&&(this.id=this.recycleAsyncId(a,s,i)),this.pending=!0,this.delay=i,this.id=(r=this.id)!==null&&r!==void 0?r:this.requestAsyncId(a,this.id,i),this},e.prototype.requestAsyncId=function(t,i,r){return r===void 0&&(r=0),Ca.setInterval(t.flush.bind(t,this),r)},e.prototype.recycleAsyncId=function(t,i,r){if(r===void 0&&(r=0),r!=null&&this.delay===r&&this.pending===!1)return i;i!=null&&Ca.clearInterval(i)},e.prototype.execute=function(t,i){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var r=this._execute(t,i);if(r)return r;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(t,i){var r=!1,s;try{this.work(t)}catch(a){r=!0,s=a||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),s},e.prototype.unsubscribe=function(){if(!this.closed){var t=this,i=t.id,r=t.scheduler,s=r.actions;this.work=this.state=this.scheduler=null,this.pending=!1,Di(s,this),i!=null&&(this.id=this.recycleAsyncId(r,i,null)),this.delay=null,n.prototype.unsubscribe.call(this)}},e})(wg),Ea=(function(){function n(e,t){t===void 0&&(t=n.now),this.schedulerActionCtor=e,this.now=t}return n.prototype.schedule=function(e,t,i){return t===void 0&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},n.now=Eg.now,n})(),Rg=(function(n){Et(e,n);function e(t,i){i===void 0&&(i=Ea.now);var r=n.call(this,t,i)||this;return r.actions=[],r._active=!1,r}return e.prototype.flush=function(t){var i=this.actions;if(this._active){i.push(t);return}var r;this._active=!0;do if(r=t.execute(t.state,t.delay))break;while(t=i.shift());if(this._active=!1,r){for(;t=i.shift();)t.unsubscribe();throw r}},e})(Ea),_g=new Rg(Pg);function Ig(n){return n&&ae(n.schedule)}function Og(n){return n[n.length-1]}function Hs(n){return Ig(Og(n))?n.pop():void 0}var Ks=(function(n){return n&&typeof n.length=="number"&&typeof n!="function"});function Yl(n){return ae(n?.then)}function Ql(n){return ae(n[qs])}function Xl(n){return Symbol.asyncIterator&&ae(n?.[Symbol.asyncIterator])}function Zl(n){return new TypeError("You provided "+(n!==null&&typeof n=="object"?"an invalid object":"'"+n+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function xg(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var eu=xg();function tu(n){return ae(n?.[eu])}function nu(n){return dg(this,arguments,function(){var e,t,i,r;return Kl(this,function(s){switch(s.label){case 0:e=n.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,fn(e.read())];case 3:return t=s.sent(),i=t.value,r=t.done,r?[4,fn(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,fn(i)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function iu(n){return ae(n?.getReader)}function wt(n){if(n instanceof ke)return n;if(n!=null){if(Ql(n))return Mg(n);if(Ks(n))return Ag(n);if(Yl(n))return Dg(n);if(Xl(n))return ru(n);if(tu(n))return Lg(n);if(iu(n))return Ng(n)}throw Zl(n)}function Mg(n){return new ke(function(e){var t=n[qs]();if(ae(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Ag(n){return new ke(function(e){for(var t=0;t<n.length&&!e.closed;t++)e.next(n[t]);e.complete()})}function Dg(n){return new ke(function(e){n.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,$l)})}function Lg(n){return new ke(function(e){var t,i;try{for(var r=vn(n),s=r.next();!s.done;s=r.next()){var a=s.value;if(e.next(a),e.closed)return}}catch(o){t={error:o}}finally{try{s&&!s.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}e.complete()})}function ru(n){return new ke(function(e){Ug(n,e).catch(function(t){return e.error(t)})})}function Ng(n){return ru(nu(n))}function Ug(n,e){var t,i,r,s;return ug(this,void 0,void 0,function(){var a,o;return Kl(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),t=hg(n),c.label=1;case 1:return[4,t.next()];case 2:if(i=c.sent(),!!i.done)return[3,4];if(a=i.value,e.next(a),e.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return o=c.sent(),r={error:o},[3,11];case 6:return c.trys.push([6,,9,10]),i&&!i.done&&(s=t.return)?[4,s.call(t)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(r)throw r.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function Nt(n,e,t,i,r){i===void 0&&(i=0),r===void 0&&(r=!1);var s=e.schedule(function(){t(),r?n.add(this.schedule(null,i)):this.unsubscribe()},i);if(n.add(s),!r)return s}function su(n,e){return e===void 0&&(e=0),it(function(t,i){t.subscribe(tt(i,function(r){return Nt(i,n,function(){return i.next(r)},e)},function(){return Nt(i,n,function(){return i.complete()},e)},function(r){return Nt(i,n,function(){return i.error(r)},e)}))})}function ou(n,e){return e===void 0&&(e=0),it(function(t,i){i.add(n.schedule(function(){return t.subscribe(i)},e))})}function Fg(n,e){return wt(n).pipe(ou(e),su(e))}function jg(n,e){return wt(n).pipe(ou(e),su(e))}function Bg(n,e){return new ke(function(t){var i=0;return e.schedule(function(){i===n.length?t.complete():(t.next(n[i++]),t.closed||this.schedule())})})}function Vg(n,e){return new ke(function(t){var i;return Nt(t,e,function(){i=n[eu](),Nt(t,e,function(){var r,s,a;try{r=i.next(),s=r.value,a=r.done}catch(o){t.error(o);return}a?t.complete():t.next(s)},0,!0)}),function(){return ae(i?.return)&&i.return()}})}function au(n,e){if(!n)throw new Error("Iterable cannot be null");return new ke(function(t){Nt(t,e,function(){var i=n[Symbol.asyncIterator]();Nt(t,e,function(){i.next().then(function(r){r.done?t.complete():t.next(r.value)})},0,!0)})})}function qg(n,e){return au(nu(n),e)}function Wg(n,e){if(n!=null){if(Ql(n))return Fg(n,e);if(Ks(n))return Bg(n,e);if(Yl(n))return jg(n,e);if(Xl(n))return au(n,e);if(tu(n))return Vg(n,e);if(iu(n))return qg(n,e)}throw Zl(n)}function zs(n,e){return e?Wg(n,e):wt(n)}function wa(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=Hs(n);return zs(n,t)}function Hg(n){return n instanceof Date&&!isNaN(n)}var Kg=Bs(function(n){return function(e){e===void 0&&(e=null),n(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=e}});function zg(n,e){var t=Hg(n)?{first:n}:typeof n=="number"?{each:n}:n,i=t.first,r=t.each,s=t.with,a=s===void 0?Gg:s,o=t.scheduler,c=o===void 0?_g:o,l=t.meta,u=l===void 0?null:l;if(i==null&&r==null)throw new TypeError("No timeout provided.");return it(function(d,h){var p,b,m=null,T=0,k=function(w){b=Nt(h,c,function(){try{p.unsubscribe(),wt(a({meta:u,lastValue:m,seen:T})).subscribe(h)}catch(M){h.error(M)}},w)};p=d.subscribe(tt(h,function(w){b?.unsubscribe(),T++,h.next(m=w),r>0&&k(r)},void 0,void 0,function(){b!=null&&b.closed||b==null||b.unsubscribe(),m=null})),!T&&k(i!=null?typeof i=="number"?i:+i-c.now():r)})}function Gg(n){throw new Kg(n)}function ge(n,e){return it(function(t,i){var r=0;t.subscribe(tt(i,function(s){i.next(n.call(e,s,r++))}))})}var $g=Array.isArray;function Jg(n,e){return $g(e)?n.apply(void 0,Hn([],bn(e))):n(e)}function Yg(n){return ge(function(e){return Jg(n,e)})}function Qg(n,e,t,i,r,s,a,o){var c=[],l=0,u=0,d=!1,h=function(){d&&!c.length&&!l&&e.complete()},p=function(m){return l<i?b(m):c.push(m)},b=function(m){l++;var T=!1;wt(t(m,u++)).subscribe(tt(e,function(k){e.next(k)},function(){T=!0},void 0,function(){if(T)try{l--;for(var k=function(){var w=c.shift();a||b(w)};c.length&&l<i;)k();h()}catch(w){e.error(w)}}))};return n.subscribe(tt(e,p,function(){d=!0,h()})),function(){}}function Gs(n,e,t){return t===void 0&&(t=1/0),ae(e)?Gs(function(i,r){return ge(function(s,a){return e(i,s,r,a)})(wt(n(i,r)))},t):(typeof e=="number"&&(t=e),it(function(i,r){return Qg(i,r,n,t)}))}function Xg(n){return Gs(Ws,n)}function Zg(){return Xg(1)}function Ni(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return Zg()(zs(n,Hs(n)))}var ev=["addListener","removeListener"],tv=["addEventListener","removeEventListener"],nv=["on","off"];function ss(n,e,t,i){if(ae(t)&&(i=t,t=void 0),i)return ss(n,e,t).pipe(Yg(i));var r=bn(sv(n)?tv.map(function(o){return function(c){return n[o](e,c,t)}}):iv(n)?ev.map(Pa(n,e)):rv(n)?nv.map(Pa(n,e)):[],2),s=r[0],a=r[1];if(!s&&Ks(n))return Gs(function(o){return ss(o,e,t)})(wt(n));if(!s)throw new TypeError("Invalid event target");return new ke(function(o){var c=function(){for(var l=[],u=0;u<arguments.length;u++)l[u]=arguments[u];return o.next(1<l.length?l:l[0])};return s(c),function(){return a(c)}})}function Pa(n,e){return function(t){return function(i){return n[t](e,i)}}}function iv(n){return ae(n.addListener)&&ae(n.removeListener)}function rv(n){return ae(n.on)&&ae(n.off)}function sv(n){return ae(n.addEventListener)&&ae(n.removeEventListener)}function Zi(n,e){return it(function(t,i){var r=0;t.subscribe(tt(i,function(s){return n.call(e,s,r++)&&i.next(s)}))})}function ov(n,e,t,i,r){return function(s,a){var o=t,c=e,l=0;s.subscribe(tt(a,function(u){var d=l++;c=o?n(c,u,d):(o=!0,u),a.next(c)},r))}}function av(n,e){return e===void 0&&(e=Ws),n=n??cv,it(function(t,i){var r,s=!0;t.subscribe(tt(i,function(a){var o=e(a);(s||!n(r,o))&&(s=!1,r=o,i.next(a))}))})}function cv(n,e){return n===e}function Ra(n,e){return it(ov(n,e,arguments.length>=2,!0))}function lv(n){return it(function(e,t){var i=!1,r=tt(t,function(){r?.unsubscribe(),i=!0},Li);wt(n).subscribe(r),e.subscribe(tt(t,function(s){return i&&t.next(s)}))})}function rt(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];var t=Hs(n);return it(function(i,r){(t?Ni(n,i,t):Ni(n,i)).subscribe(r)})}function _a(n){return it(function(e,t){wt(n).subscribe(tt(t,function(){return t.complete()},Li)),!t.closed&&e.subscribe(t)})}var uv=Object.defineProperty,dv=Object.defineProperties,hv=Object.getOwnPropertyDescriptors,Ia=Object.getOwnPropertySymbols,fv=Object.prototype.hasOwnProperty,pv=Object.prototype.propertyIsEnumerable,Oa=(n,e,t)=>e in n?uv(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ot=(n,e)=>{for(var t in e||(e={}))fv.call(e,t)&&Oa(n,t,e[t]);if(Ia)for(var t of Ia(e))pv.call(e,t)&&Oa(n,t,e[t]);return n},_n=(n,e)=>dv(n,hv(e)),nt=(n,e,t)=>new Promise((i,r)=>{var s=c=>{try{o(t.next(c))}catch(l){r(l)}},a=c=>{try{o(t.throw(c))}catch(l){r(l)}},o=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,a);o((t=t.apply(n,e)).next())}),cu="lk";function ye(n){return typeof n>"u"?!1:mv(n)||gv(n)}function mv(n){var e;return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&n.hasOwnProperty("track")&&typeof((e=n.publication)==null?void 0:e.track)<"u":!1}function gv(n){return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&n.hasOwnProperty("publication")&&typeof n.publication<"u":!1}function Kn(n){return n?n.hasOwnProperty("participant")&&n.hasOwnProperty("source")&&typeof n.publication>"u":!1}function Ee(n){if(typeof n=="string"||typeof n=="number")return`${n}`;if(Kn(n))return`${n.participant.identity}_${n.source}_placeholder`;if(ye(n))return`${n.participant.identity}_${n.publication.source}_${n.publication.trackSid}`;throw new Error(`Can't generate a id for the given track reference: ${n}`)}function vv(n,e){return n===void 0||e===void 0?!1:ye(n)&&ye(e)?n.publication.trackSid===e.publication.trackSid:Ee(n)===Ee(e)}function lu(n,e){return typeof e>"u"?!1:ye(n)?e.some(t=>t.participant.identity===n.participant.identity&&ye(t)&&t.publication.trackSid===n.publication.trackSid):Kn(n)?e.some(t=>t.participant.identity===n.participant.identity&&Kn(t)&&t.source===n.source):!1}function bv(n,e){return Kn(n)&&ye(e)&&e.participant.identity===n.participant.identity&&e.source===n.source}function yv(){const n=document.createElement("p");n.style.width="100%",n.style.height="200px";const e=document.createElement("div");e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.visibility="hidden",e.style.width="200px",e.style.height="150px",e.style.overflow="hidden",e.appendChild(n),document.body.appendChild(e);const t=n.offsetWidth;e.style.overflow="scroll";let i=n.offsetWidth;return t===i&&(i=e.clientWidth),document.body.removeChild(e),t-i}function kv(){return typeof document<"u"}function Sv(n,e,t){return tg(n,e,()=>nt(this,null,function*(){const{x:i,y:r}=yield sg(n,e,{placement:"top",middleware:[ng(6),rg(),ig({padding:5})]});t?.(i,r)}))}function Tv(n,e){return!n.contains(e.target)}var Cv=[I.ConnectionStateChanged,I.RoomMetadataChanged,I.ActiveSpeakersChanged,I.ConnectionQualityChanged,I.ParticipantConnected,I.ParticipantDisconnected,I.ParticipantPermissionsChanged,I.ParticipantMetadataChanged,I.ParticipantNameChanged,I.ParticipantAttributesChanged,I.TrackMuted,I.TrackUnmuted,I.TrackPublished,I.TrackUnpublished,I.TrackStreamStateChanged,I.TrackSubscriptionFailed,I.TrackSubscriptionPermissionChanged,I.TrackSubscriptionStatusChanged],Ev=[...Cv,I.LocalTrackPublished,I.LocalTrackUnpublished];A.TrackPublished,A.TrackUnpublished,A.TrackMuted,A.TrackUnmuted,A.TrackStreamStateChanged,A.TrackSubscribed,A.TrackUnsubscribed,A.TrackSubscriptionPermissionChanged,A.TrackSubscriptionFailed,A.LocalTrackPublished,A.LocalTrackUnpublished;var wv=[A.ConnectionQualityChanged,A.IsSpeakingChanged,A.ParticipantMetadataChanged,A.ParticipantPermissionsChanged,A.TrackMuted,A.TrackUnmuted,A.TrackPublished,A.TrackUnpublished,A.TrackStreamStateChanged,A.TrackSubscriptionFailed,A.TrackSubscriptionPermissionChanged,A.TrackSubscriptionStatusChanged];[...wv,A.LocalTrackPublished,A.LocalTrackUnpublished];var G=lg.getLogger("lk-components-js");G.setDefaultLevel("WARN");var Pv=[{columns:1,rows:1},{columns:1,rows:2,orientation:"portrait"},{columns:2,rows:1,orientation:"landscape"},{columns:2,rows:2,minWidth:560},{columns:3,rows:3,minWidth:700},{columns:4,rows:4,minWidth:960},{columns:5,rows:5,minWidth:1100}];function uu(n,e,t,i){if(n.length<1)throw new Error("At least one grid layout definition must be provided.");const r=Rv(n);if(t<=0||i<=0)return r[0];let s=0;const a=t/i>1?"landscape":"portrait";let o=r.find((c,l,u)=>{s=l;const d=u.findIndex((h,p)=>{const b=!h.orientation||h.orientation===a,m=p>l,T=h.maxTiles===c.maxTiles;return m&&T&&b})!==-1;return c.maxTiles>=e&&!d});if(o===void 0)if(o=r[r.length-1],o)G.warn(`No layout found for: participantCount: ${e}, width/height: ${t}/${i} fallback to biggest available layout (${o}).`);else throw new Error("No layout or fallback layout found.");if((t<o.minWidth||i<o.minHeight)&&s>0){const c=r[s-1];o=uu(r.slice(0,s),c.maxTiles,t,i)}return o}function Rv(n){return[...n].map(e=>{var t,i;return{name:`${e.columns}x${e.rows}`,columns:e.columns,rows:e.rows,maxTiles:e.columns*e.rows,minWidth:(t=e.minWidth)!=null?t:0,minHeight:(i=e.minHeight)!=null?i:0,orientation:e.orientation}}).sort((e,t)=>e.maxTiles!==t.maxTiles?e.maxTiles-t.maxTiles:e.minWidth!==0||t.minWidth!==0?e.minWidth-t.minWidth:e.minHeight!==0||t.minHeight!==0?e.minHeight-t.minHeight:0)}function _v(){return typeof navigator<"u"&&navigator.mediaDevices&&!!navigator.mediaDevices.getDisplayMedia}var du=(n=>(n.AgentState="lk.agent.state",n.PublishOnBehalf="lk.publish_on_behalf",n.TranscriptionFinal="lk.transcription_final",n.TranscriptionSegmentId="lk.segment_id",n.TranscribedTrackId="lk.transcribed_track_id",n))(du||{}),hu=[],fu={showChat:!1,unreadMessages:0,showSettings:!1};function pu(n){return typeof n=="object"}function mu(n){return Array.isArray(n)&&n.filter(pu).length>0}function Iv(n,e){return e.audioLevel-n.audioLevel}function Ov(n,e){return n.isSpeaking===e.isSpeaking?0:n.isSpeaking?-1:1}function xv(n,e){var t,i,r,s;return n.lastSpokeAt!==void 0||e.lastSpokeAt!==void 0?((i=(t=e.lastSpokeAt)==null?void 0:t.getTime())!=null?i:0)-((s=(r=n.lastSpokeAt)==null?void 0:r.getTime())!=null?s:0):0}function os(n,e){var t,i,r,s;return((i=(t=n.joinedAt)==null?void 0:t.getTime())!=null?i:0)-((s=(r=e.joinedAt)==null?void 0:r.getTime())!=null?s:0)}function Mv(n,e){return ye(n)?ye(e)?0:-1:ye(e)?1:0}function Av(n,e){const t=n.participant.isCameraEnabled,i=e.participant.isCameraEnabled;return t!==i?t?-1:1:0}function Dv(n){const e=[],t=[],i=[],r=[];n.forEach(o=>{o.participant.isLocal&&o.source===P.Source.Camera?e.push(o):o.source===P.Source.ScreenShare?t.push(o):o.source===P.Source.Camera?i.push(o):r.push(o)});const s=Lv(t),a=Nv(i);return[...e,...s,...a,...r]}function Lv(n){const e=[],t=[];return n.forEach(i=>{i.participant.isLocal?e.push(i):t.push(i)}),e.sort((i,r)=>os(i.participant,r.participant)),t.sort((i,r)=>os(i.participant,r.participant)),[...t,...e]}function Nv(n){const e=[],t=[];return n.forEach(i=>{i.participant.isLocal?e.push(i):t.push(i)}),t.sort((i,r)=>i.participant.isSpeaking&&r.participant.isSpeaking?Iv(i.participant,r.participant):i.participant.isSpeaking!==r.participant.isSpeaking?Ov(i.participant,r.participant):i.participant.lastSpokeAt!==r.participant.lastSpokeAt?xv(i.participant,r.participant):ye(i)!==ye(r)?Mv(i,r):i.participant.isCameraEnabled!==r.participant.isCameraEnabled?Av(i,r):os(i.participant,r.participant)),[...e,...t]}function Uv(n,e){return n.reduce((t,i,r)=>r%e===0?[...t,[i]]:[...t.slice(0,-1),[...t.slice(-1)[0],i]],[])}function xa(n,e){const t=Math.max(n.length,e.length);return new Array(t).fill([]).map((i,r)=>[n[r],e[r]])}function Ui(n,e,t){return n.filter(i=>!e.map(r=>t(r)).includes(t(i)))}function as(n){return n.map(e=>typeof e=="string"||typeof e=="number"?`${e}`:Ee(e))}function Fv(n,e){return{dropped:Ui(n,e,Ee),added:Ui(e,n,Ee)}}function jv(n){return n.added.length!==0||n.dropped.length!==0}function cs(n,e){const t=e.findIndex(i=>Ee(i)===Ee(n));if(t===-1)throw new Error(`Element not part of the array: ${Ee(n)} not in ${as(e)}`);return t}function Bv(n,e,t){const i=cs(n,t),r=cs(e,t);return t.splice(i,1,e),t.splice(r,1,n),t}function Vv(n,e){const t=cs(n,e);return e.splice(t,1),e}function qv(n,e){return[...e,n]}function Pr(n,e){return Uv(n,e)}function Wv(n,e,t){let i=Hv(n,e);if(i.length<e.length){const a=Ui(e,i,Ee);i=[...i,...a]}const r=Pr(i,t),s=Pr(e,t);if(xa(r,s).forEach(([a,o],c)=>{if(a&&o){const l=Pr(i,t)[c],u=Fv(l,o);jv(u)&&(G.debug(`Detected visual changes on page: ${c}, current: ${as(a)}, next: ${as(o)}`,{changes:u}),u.added.length===u.dropped.length&&xa(u.added,u.dropped).forEach(([d,h])=>{if(d&&h)i=Bv(d,h,i);else throw new Error(`For a swap action we need a addition and a removal one is missing: ${d}, ${h}`)}),u.added.length===0&&u.dropped.length>0&&u.dropped.forEach(d=>{i=Vv(d,i)}),u.added.length>0&&u.dropped.length===0&&u.added.forEach(d=>{i=qv(d,i)}))}}),i.length>e.length){const a=Ui(i,e,Ee);i=i.filter(o=>!a.map(Ee).includes(Ee(o)))}return i}function Hv(n,e){return n.map(t=>e.find(r=>Ee(t)===Ee(r)||typeof t!="number"&&Kn(t)&&ye(r)&&bv(t,r))??t)}function Ue(n){return`${cu}-${n}`}function Kv(n){const e=ls(n),t=gu(n.participant).pipe(ge(()=>ls(n)),rt(e));return{className:Ue(n.source===P.Source.Camera||n.source===P.Source.ScreenShare?"participant-media-video":"participant-media-audio"),trackObserver:t}}function ls(n){if(ye(n))return n.publication;{const{source:e,name:t,participant:i}=n;if(e&&t)return i.getTrackPublications().find(r=>r.source===e&&r.trackName===t);if(t)return i.getTrackPublicationByName(t);if(e)return i.getTrackPublication(e);throw new Error("At least one of source and name needs to be defined")}}function $s(n,...e){return new ke(t=>{const i=()=>{t.next(n)};return e.forEach(r=>{n.on(r,i)}),()=>{e.forEach(r=>{n.off(r,i)})}}).pipe(rt(n))}function er(n,e){return new ke(t=>{const i=(...r)=>{t.next(r)};return n.on(e,i),()=>{n.off(e,i)}})}function zv(n){return er(n,I.ConnectionStateChanged).pipe(ge(([e])=>e),rt(n.state))}function Gv(n,e,t=!0){const i=new ke(s=>{Ct.getLocalDevices(n,t).then(a=>{s.next(a),s.complete()}).catch(a=>{e?.(a),s.next([]),s.complete()})}),r=new ke(s=>{var a;const o=()=>nt(this,null,function*(){try{const c=yield Ct.getLocalDevices(n,t);s.next(c)}catch(c){e?.(c)}});if(typeof window<"u"){if(!window.isSecureContext)throw new Error("Accessing media devices is available only in secure contexts (HTTPS and localhost), in some or all supporting browsers. See: https://developer.mozilla.org/en-US/docs/Web/API/Navigator/mediaDevices");(a=navigator?.mediaDevices)==null||a.addEventListener("devicechange",o)}return()=>{var c;(c=navigator?.mediaDevices)==null||c.removeEventListener("devicechange",o)}});return Ni(i,r)}function $v(n){return er(n,I.DataReceived)}function Jv(n){return $s(n,I.AudioPlaybackStatusChanged).pipe(ge(e=>({canPlayAudio:e.canPlaybackAudio})))}function Yv(n){return $s(n,I.VideoPlaybackStatusChanged).pipe(ge(e=>({canPlayVideo:e.canPlaybackVideo})))}function Qv(n,e){return er(n,I.ActiveDeviceChanged).pipe(Zi(([t])=>t===e),ge(([t,i])=>(G.debug("activeDeviceObservable | RoomEvent.ActiveDeviceChanged",{kind:t,deviceId:i}),i)))}function Xv(n,e){return er(n,I.ParticipantEncryptionStatusChanged).pipe(Zi(([,t])=>e?.identity===t?.identity||!t&&e?.identity===n.localParticipant.identity),ge(([t])=>t),rt(e!=null&&e.isLocal?e.isE2EEEnabled:!!(e!=null&&e.isEncrypted)))}function Js(n,...e){return new ke(t=>{const i=()=>{t.next(n)};return e.forEach(r=>{n.on(r,i)}),()=>{e.forEach(r=>{n.off(r,i)})}}).pipe(rt(n))}function gu(n){return Js(n,A.TrackMuted,A.TrackUnmuted,A.ParticipantPermissionsChanged,A.TrackPublished,A.TrackUnpublished,A.LocalTrackPublished,A.LocalTrackUnpublished,A.MediaDevicesError,A.TrackSubscriptionStatusChanged).pipe(ge(e=>{const{isMicrophoneEnabled:t,isCameraEnabled:i,isScreenShareEnabled:r}=e,s=e.getTrackPublication(P.Source.Microphone),a=e.getTrackPublication(P.Source.Camera);return{isCameraEnabled:i,isMicrophoneEnabled:t,isScreenShareEnabled:r,cameraTrack:a,microphoneTrack:s,participant:e}}))}function Zv(n){return n?Js(n,A.ParticipantMetadataChanged,A.ParticipantNameChanged).pipe(ge(({name:e,identity:t,metadata:i})=>({name:e,identity:t,metadata:i})),rt({name:n.name,identity:n.identity,metadata:n.metadata})):void 0}function e0(n){return Ys(n,A.ConnectionQualityChanged).pipe(ge(([e])=>e),rt(n.connectionQuality))}function Ys(n,e){return new ke(t=>{const i=(...r)=>{t.next(r)};return n.on(e,i),()=>{n.off(e,i)}})}function vu(n){var e,t,i,r;return Js(n.participant,A.TrackMuted,A.TrackUnmuted,A.TrackSubscribed,A.TrackUnsubscribed,A.LocalTrackPublished,A.LocalTrackUnpublished).pipe(ge(s=>{var a,o;const c=(a=n.publication)!=null?a:s.getTrackPublication(n.source);return(o=c?.isMuted)!=null?o:!0}),rt((r=(i=(e=n.publication)==null?void 0:e.isMuted)!=null?i:(t=n.participant.getTrackPublication(n.source))==null?void 0:t.isMuted)!=null?r:!0))}function t0(n){return Ys(n,A.IsSpeakingChanged).pipe(ge(([e])=>e))}function n0(n){return Ys(n,A.ParticipantPermissionsChanged).pipe(ge(()=>n.permissions),rt(n.permissions))}function i0(n,e,t,i,r){const{localParticipant:s}=e,a=(u,d)=>{let h=!1;switch(u){case P.Source.Camera:h=d.isCameraEnabled;break;case P.Source.Microphone:h=d.isMicrophoneEnabled;break;case P.Source.ScreenShare:h=d.isScreenShareEnabled;break}return h},o=gu(s).pipe(ge(u=>a(n,u.participant)),rt(a(n,s))),c=new Qt,l=(u,d)=>nt(this,null,function*(){try{switch(d??(d=t),c.next(!0),n){case P.Source.Camera:return yield s.setCameraEnabled(u??!s.isCameraEnabled,d,i),s.isCameraEnabled;case P.Source.Microphone:return yield s.setMicrophoneEnabled(u??!s.isMicrophoneEnabled,d,i),s.isMicrophoneEnabled;case P.Source.ScreenShare:return yield s.setScreenShareEnabled(u??!s.isScreenShareEnabled,d,i),s.isScreenShareEnabled;default:throw new TypeError("Tried to toggle unsupported source")}}catch(h){if(r&&h instanceof Error){r?.(h);return}else throw h}finally{c.next(!1)}});return{className:Ue("button"),toggle:l,enabledObserver:o,pendingObserver:c.asObservable()}}function r0(){let n=!1;const e=new Qt,t=new Qt,i=r=>nt(this,null,function*(){t.next(!0),n=r??!n,e.next(n),t.next(!1)});return{className:Ue("button"),toggle:i,enabledObserver:e.asObservable(),pendingObserver:t.asObservable()}}function s0(n,e,t){const i=new Jl(void 0),r=Qv(e,n),s=(a,...o)=>nt(this,[a,...o],function*(c,l={}){var u,d,h;if(e){const p=Me();if(n==="audiooutput"&&(p?.name==="Safari"||p?.os==="iOS")){G.warn("Switching audio output device is not supported on Safari and iOS.");return}G.debug(`Switching active device of kind "${n}" with id ${c}.`),yield e.switchActiveDevice(n,c,l.exact);const b=(u=e.getActiveDevice(n))!=null?u:c;b!==c&&c!=="default"&&G.info(`We tried to select the device with id (${c}), but the browser decided to select the device with id (${b}) instead.`);let m;n==="audioinput"?m=(d=e.localParticipant.getTrackPublication(P.Source.Microphone))==null?void 0:d.track:n==="videoinput"&&(m=(h=e.localParticipant.getTrackPublication(P.Source.Camera))==null?void 0:h.track);const T=c==="default"&&!m||c==="default"&&m?.mediaStreamTrack.label.startsWith("Default");i.next(T?c:b)}});return{className:Ue("media-device-select"),activeDeviceObservable:r,setActiveMediaDevice:s}}function o0(n){const e=t=>{n.disconnect(t)};return{className:Ue("disconnect-button"),disconnect:e}}function a0(n){const e=Ue("connection-quality"),t=e0(n);return{className:e,connectionQualityObserver:t}}function c0(n){let e="track-muted-indicator-camera";switch(n.source){case P.Source.Camera:e="track-muted-indicator-camera";break;case P.Source.Microphone:e="track-muted-indicator-microphone";break}const t=Ue(e),i=vu(n);return{className:t,mediaMutedObserver:i}}function l0(n){return{className:"lk-participant-name",infoObserver:Zv(n)}}function u0(){return{className:Ue("participant-tile")}}var d0={CHAT:"lk.chat"},h0={CHAT:"lk-chat-topic"};function bu(n,e){return nt(this,arguments,function*(t,i,r={}){const{reliable:s,destinationIdentities:a,topic:o}=r;yield t.publishData(i,{destinationIdentities:a,topic:o,reliable:s})})}function f0(n,e,t){const i=Array.isArray(e)?e:[e],r=$v(n).pipe(Zi(([,,,o])=>e===void 0||o!==void 0&&i.includes(o)),ge(([o,c,,l])=>({payload:o,topic:l,from:c})));let s;const a=new ke(o=>{s=o});return{messageObservable:r,isSendingObservable:a,send:(o,...c)=>nt(this,[o,...c],function*(l,u={}){s.next(!0);try{yield bu(n.localParticipant,l,Ot({topic:i[0]},u))}finally{s.next(!1)}})}}var ni=new WeakMap;function p0(n){return n.ignoreLegacy==!0}var m0=n=>JSON.parse(new TextDecoder().decode(n)),g0=n=>new TextEncoder().encode(JSON.stringify(n));function v0(n,e){var t,i,r,s,a,o;const c=()=>{var g,y,C;return((g=n.serverInfo)==null?void 0:g.edition)===1||!!((y=n.serverInfo)!=null&&y.version)&&Xe((C=n.serverInfo)==null?void 0:C.version,"1.8.2")>0},l=new Qt,u=(t=e?.channelTopic)!=null?t:d0.CHAT,d=(i=e?.channelTopic)!=null?i:h0.CHAT;let h=!1;ni.has(n)||(h=!0);const p=(r=ni.get(n))!=null?r:new Map,b=(s=p.get(u))!=null?s:new Qt;p.set(u,b),ni.set(n,p);const m=(a=e?.messageDecoder)!=null?a:m0;if(h){n.registerTextStreamHandler(u,(y,C)=>nt(this,null,function*(){const{id:x,timestamp:_}=y.info;zs(y).pipe(Ra((O,D)=>O+D),ge(O=>({id:x,timestamp:_,message:O,from:n.getParticipantByIdentity(C.identity),type:"chatMessage"}))).subscribe({next:O=>b.next(O)})}));const{messageObservable:g}=f0(n,[d]);g.pipe(ge(y=>{const C=m(y.payload);return p0(C)?void 0:_n(Ot({},C),{type:"chatMessage",from:y.from})}),Zi(y=>!!y),_a(l)).subscribe(b)}const T=b.pipe(Ra((g,y)=>{if("id"in y&&g.find(C=>{var x,_;return((x=C.from)==null?void 0:x.identity)===((_=y.from)==null?void 0:_.identity)&&C.id===y.id})){const C=g.findIndex(x=>x.id===y.id);if(C>-1){const x=g[C];g[C]=_n(Ot({},y),{timestamp:x.timestamp,editTimestamp:y.timestamp})}return[...g]}return[...g,y]},[]),_a(l)),k=new Jl(!1),w=(o=e?.messageEncoder)!=null?o:g0,M=(g,y)=>nt(this,null,function*(){y||(y={}),y.topic!=null||(y.topic=u),k.next(!0);try{const C={id:(yield n.localParticipant.sendText(g,y)).id,timestamp:Date.now(),message:g},x=_n(Ot({},C),{attachedFiles:y.attachments}),_=_n(Ot({},x),{type:"chatMessage",from:n.localParticipant,attributes:y.attributes});b.next(_);const O=w(_n(Ot({},C),{ignoreLegacy:c()}));try{yield bu(n.localParticipant,O,{reliable:!0,topic:d})}catch(D){G.info("could not send message in legacy chat format",D)}return _}finally{k.next(!1)}});function v(){l.next(),l.complete(),b.complete(),ni.delete(n),n.unregisterTextStreamHandler(u)}return n.once(I.Disconnected,v),{messageObservable:T,isSendingObservable:k,send:M}}function b0(){const n=e=>nt(this,null,function*(){G.info("Start Audio for room: ",e),yield e.startAudio()});return{className:Ue("start-audio-button"),roomAudioPlaybackAllowedObservable:Jv,handleStartAudioPlayback:n}}function y0(){const n=e=>nt(this,null,function*(){G.info("Start Video for room: ",e),yield e.startVideo()});return{className:Ue("start-audio-button"),roomVideoPlaybackAllowedObservable:Yv,handleStartVideoPlayback:n}}function k0(){return{className:[Ue("button"),Ue("chat-toggle")].join(" ")}}function S0(){return{className:[Ue("button"),Ue("focus-toggle-button")].join(" ")}}function T0(){return{className:"lk-room-container"}}function Ma(n,e,t=!0){const i=[n.localParticipant,...Array.from(n.remoteParticipants.values())],r=[];return i.forEach(s=>{e.forEach(a=>{const o=Array.from(s.trackPublications.values()).filter(c=>c.source===a&&(!t||c.track)).map(c=>({participant:s,publication:c,source:c.source}));r.push(...o)})}),{trackReferences:r,participants:i}}function C0(n,e,t){var i,r;const s=(i=t.additionalRoomEvents)!=null?i:Ev,a=(r=t.onlySubscribed)!=null?r:!0,o=Array.from(new Set([I.ParticipantConnected,I.ParticipantDisconnected,I.ConnectionStateChanged,I.LocalTrackPublished,I.LocalTrackUnpublished,I.TrackPublished,I.TrackUnpublished,I.TrackSubscriptionStatusChanged,...s]).values());return $s(n,...o).pipe(ge(c=>{const l=Ma(c,e,a);return G.debug(`TrackReference[] was updated. (length ${l.trackReferences.length})`,l),l}),rt(Ma(n,e,a)))}function E0(n,e=1e3){if(n===null)return wa(!1);const t=ss(n,"mousemove",{passive:!0}).pipe(ge(()=>!0)),i=t.pipe(zg({each:e,with:()=>Ni(wa(!1),i.pipe(lv(t)))}),av());return i}function w0(n,e){if(typeof localStorage>"u"){G.error("Local storage is not available.");return}try{if(e){const t=Object.fromEntries(Object.entries(e).filter(([,i])=>i!==""));localStorage.setItem(n,JSON.stringify(t))}}catch(t){G.error(`Error setting item to local storage: ${t}`)}}function P0(n){if(typeof localStorage>"u"){G.error("Local storage is not available.");return}try{const e=localStorage.getItem(n);if(!e){G.warn(`Item with key ${n} does not exist in local storage.`);return}return JSON.parse(e)}catch(e){G.error(`Error getting item from local storage: ${e}`);return}}function R0(n){return{load:()=>P0(n),save:e=>w0(n,e)}}var _0=`${cu}-user-choices`,In={videoEnabled:!0,audioEnabled:!0,videoDeviceId:"default",audioDeviceId:"default",username:""},{load:I0,save:O0}=R0(_0);function x0(n,e=!1){e!==!0&&O0(n)}function M0(n,e=!1){var t,i,r,s,a;const o={videoEnabled:(t=n?.videoEnabled)!=null?t:In.videoEnabled,audioEnabled:(i=n?.audioEnabled)!=null?i:In.audioEnabled,videoDeviceId:(r=n?.videoDeviceId)!=null?r:In.videoDeviceId,audioDeviceId:(s=n?.audioDeviceId)!=null?s:In.audioDeviceId,username:(a=n?.username)!=null?a:In.username};if(e)return o;{const c=I0();return Ot(Ot({},o),c??{})}}function yu(n,e){if(e.msg==="show_chat")return{...n,showChat:!0,unreadMessages:0};if(e.msg==="hide_chat")return{...n,showChat:!1};if(e.msg==="toggle_chat"){const t={...n,showChat:!n.showChat};return t.showChat===!0&&(t.unreadMessages=0),t}else return e.msg==="unread_msg"?{...n,unreadMessages:e.count}:e.msg==="toggle_settings"?{...n,showSettings:!n.showSettings}:{...n}}function ku(n,e){return e.msg==="set_pin"?[e.trackReference]:e.msg==="clear_pin"?[]:{...n}}const tr=f.createContext(void 0);function Su(){const n=f.useContext(tr);if(!n)throw Error("Tried to access LayoutContext context outside a LayoutContextProvider provider.");return n}function A0(n){const e=$n();if(n??(n=e),!n)throw Error("Tried to access LayoutContext context outside a LayoutContextProvider provider.");return n}function D0(){const[n,e]=f.useReducer(ku,hu),[t,i]=f.useReducer(yu,fu);return{pin:{dispatch:e,state:n},widget:{dispatch:i,state:t}}}function L0(n){const[e,t]=f.useReducer(ku,hu),[i,r]=f.useReducer(yu,fu);return n??{pin:{dispatch:t,state:e},widget:{dispatch:r,state:i}}}function $n(){return f.useContext(tr)}const Qs=f.createContext(void 0);function nr(){return f.useContext(Qs)}function kn(n){const e=nr(),t=n??e;if(!t)throw new Error("No TrackRef, make sure you are inside a TrackRefContext or pass the TrackRef explicitly");return t}const Tu=f.createContext(void 0);function Cu(){return f.useContext(Tu)}function Jn(n){const e=Cu(),t=nr(),i=n??e??t?.participant;if(!i)throw new Error("No participant provided, make sure you are inside a participant context or pass the participant explicitly");return i}const Xs=f.createContext(void 0);function Zs(){const n=f.useContext(Xs);if(!n)throw Error("tried to access room context outside of livekit room component");return n}function ir(){return f.useContext(Xs)}function Sn(n){const e=ir(),t=n??e;if(!t)throw new Error("No room provided, make sure you are inside a Room context or pass the room explicitly");return t}f.createContext(void 0);const Eu=f.createContext(void 0);function N0(n){return f.useContext(Eu)}var Aa={};function wu(n){var e,t,i="";if(typeof n=="string"||typeof n=="number")i+=n;else if(typeof n=="object")if(Array.isArray(n)){var r=n.length;for(e=0;e<r;e++)n[e]&&(t=wu(n[e]))&&(i&&(i+=" "),i+=t)}else for(t in n)n[t]&&(i&&(i+=" "),i+=t);return i}function Pu(){for(var n,e,t=0,i="",r=arguments.length;t<r;t++)(n=arguments[t])&&(e=wu(n))&&(i&&(i+=" "),i+=e);return i}function U0(...n){return(...e)=>{for(const t of n)if(typeof t=="function")try{t(...e)}catch(i){console.error(i)}}}function pt(...n){const e={...n[0]};for(let t=1;t<n.length;t++){const i=n[t];for(const r in i){const s=e[r],a=i[r];typeof s=="function"&&typeof a=="function"&&r[0]==="o"&&r[1]==="n"&&r.charCodeAt(2)>=65&&r.charCodeAt(2)<=90?e[r]=U0(s,a):(r==="className"||r==="UNSAFE_className")&&typeof s=="string"&&typeof a=="string"?e[r]=Pu(s,a):e[r]=a!==void 0?a:s}}return e}function F0(n){return n!==void 0}function Pt(...n){return pt(...n.filter(F0))}function Ru(n,e,t){return f.Children.map(n,i=>f.isValidElement(i)&&f.Children.only(n)?(i.props.className&&(e??(e={}),e.className=Pu(i.props.className,e.className),e.style={...i.props.style,...e.style}),f.cloneElement(i,{...e,key:t})):i)}function j0(n){var e,t;if(typeof window<"u"&&typeof process<"u"&&(((e=process==null?void 0:Aa)==null?void 0:e.NODE_ENV)==="dev"||((t=process==null?void 0:Aa)==null?void 0:t.NODE_ENV)==="development")){const i=document.querySelector(".lk-room-container");i&&!getComputedStyle(i).getPropertyValue("--lk-has-imported-styles")&&G.warn("It looks like you're not using the `@livekit/components-styles package`. To render the UI with the default styling, please import it in your layout or page.")}}function B0(n,e){return n==="processor"&&e&&typeof e=="object"&&"name"in e?e.name:n==="e2ee"&&e?"e2ee-enabled":e}const V0={connect:!0,audio:!1,video:!1};function q0(n){const{token:e,serverUrl:t,options:i,room:r,connectOptions:s,connect:a,audio:o,video:c,screen:l,onConnected:u,onDisconnected:d,onError:h,onMediaDeviceFailure:p,onEncryptionError:b,simulateParticipants:m,...T}={...V0,...n};i&&r&&G.warn("when using a manually created room, the options object will be ignored. set the desired options directly when creating the room instead.");const[k,w]=f.useState(),M=f.useRef(a);f.useEffect(()=>{w(r??new Ct(i))},[r,JSON.stringify(i,B0)]);const v=f.useMemo(()=>{const{className:g}=T0();return pt(T,{className:g})},[T]);return f.useEffect(()=>{if(!k)return;const g=()=>{const O=k.localParticipant;G.debug("trying to publish local tracks"),Promise.all([O.setMicrophoneEnabled(!!o,typeof o!="boolean"?o:void 0),O.setCameraEnabled(!!c,typeof c!="boolean"?c:void 0),O.setScreenShareEnabled(!!l,typeof l!="boolean"?l:void 0)]).catch(D=>{G.warn(D),h?.(D)})},y=(O,D)=>{const j=jn.getFailure(O);p?.(j,D)},C=O=>{b?.(O)},x=O=>{d?.(O)},_=()=>{u?.()};return k.on(I.SignalConnected,g).on(I.MediaDevicesError,y).on(I.EncryptionError,C).on(I.Disconnected,x).on(I.Connected,_),()=>{k.off(I.SignalConnected,g).off(I.MediaDevicesError,y).off(I.EncryptionError,C).off(I.Disconnected,x).off(I.Connected,_)}},[k,o,c,l,h,b,p,u,d]),f.useEffect(()=>{if(k){if(m){k.simulateParticipants({participants:{count:m},publish:{audio:!0,useRealTracks:!0}});return}if(a){if(M.current=!0,G.debug("connecting"),!e){G.debug("no token yet");return}if(!t){G.warn("no livekit url provided"),h?.(Error("no livekit url provided"));return}k.connect(t,e,s).catch(g=>{G.warn(g),M.current===!0&&h?.(g)})}else G.debug("disconnecting because connect is false"),M.current=!1,k.disconnect()}},[a,e,JSON.stringify(s),k,h,t,m]),f.useEffect(()=>{if(k)return()=>{G.info("disconnecting on onmount"),k.disconnect()}},[k]),{room:k,htmlProps:v}}const ky=f.forwardRef(function(n,e){const{room:t,htmlProps:i}=q0(n);return f.createElement("div",{ref:e,...i},t&&f.createElement(Xs.Provider,{value:t},f.createElement(Eu.Provider,{value:n.featureFlags},n.children)))}),W0=n=>{const e=f.useRef(n);return f.useEffect(()=>{e.current=n}),e};function H0(n,e){const t=z0(),i=W0(e);return f.useLayoutEffect(()=>{let r=!1;const s=n.current;if(!s)return;function a(o,c){r||i.current(o,c)}return t?.subscribe(s,a),()=>{r=!0,t?.unsubscribe(s,a)}},[n.current,t,i]),t?.observer}function K0(){let n=!1,e=[];const t=new Map;if(typeof window>"u")return;const i=new ResizeObserver((r,s)=>{e=e.concat(r),n||window.requestAnimationFrame(()=>{const a=new Set;for(let o=0;o<e.length;o++){if(a.has(e[o].target))continue;a.add(e[o].target);const c=t.get(e[o].target);c?.forEach(l=>l(e[o],s))}e=[],n=!1}),n=!0});return{observer:i,subscribe(r,s){i.observe(r);const a=t.get(r)??[];a.push(s),t.set(r,a)},unsubscribe(r,s){const a=t.get(r)??[];if(a.length===1){i.unobserve(r),t.delete(r);return}const o=a.indexOf(s);o!==-1&&a.splice(o,1),t.set(r,a)}}}let Da;const z0=()=>Da||(Da=K0()),_u=n=>{const[e,t]=f.useState({width:0,height:0});f.useLayoutEffect(()=>{if(n.current){const{width:r,height:s}=n.current.getBoundingClientRect();t({width:r,height:s})}},[n.current]);const i=f.useCallback(r=>t(r.contentRect),[]);return H0(n,i),e};function Fe(n,e,t=!0){const[i,r]=f.useState(e);return f.useEffect(()=>{if(t&&r(e),typeof window>"u"||!n)return;const s=n.subscribe(r);return()=>s.unsubscribe()},[n,t]),i}function G0(n){const e=s=>typeof window<"u"?window.matchMedia(s).matches:!1,[t,i]=f.useState(e(n));function r(){i(e(n))}return f.useEffect(()=>{const s=window.matchMedia(n);return r(),s.addListener?s.addListener(r):s.addEventListener("change",r),()=>{s.removeListener?s.removeListener(r):s.removeEventListener("change",r)}},[n]),t}function $0(n={}){const e=Jn(n.participant),{className:t,connectionQualityObserver:i}=f.useMemo(()=>a0(e),[e]),r=Fe(i,e.connectionQuality);return{className:t,quality:r}}function eo(n){const e=Sn(n),t=f.useMemo(()=>zv(e),[e]);return Fe(t,e.state)}function J0(n){const e=Zs(),t=eo(e);return{buttonProps:f.useMemo(()=>{const{className:i,disconnect:r}=o0(e);return pt(n,{className:i,onClick:()=>r(n.stopTracks??!0),disabled:t===Z.Disconnected})},[e,n,t])}}function Y0(n){if(n.publication instanceof Ri){const e=n.publication.track;if(e){const{facingMode:t}=lm(e);return t}}return"undefined"}function Q0({trackRef:n,props:e}){const t=kn(n),i=$n(),{className:r}=f.useMemo(()=>S0(),[]),s=f.useMemo(()=>lu(t,i?.pin.state),[t,i?.pin.state]);return{mergedProps:f.useMemo(()=>pt(e,{className:r,onClick:a=>{var o,c,l,u,d;(o=e.onClick)==null||o.call(e,a),s?(l=i==null?void 0:(c=i.pin).dispatch)==null||l.call(c,{msg:"clear_pin"}):(d=i==null?void 0:(u=i.pin).dispatch)==null||d.call(u,{msg:"set_pin",trackReference:t})}}),[e,r,t,s,i?.pin]),inFocus:s}}function X0(n,e,t={}){const i=t.gridLayouts??Pv,{width:r,height:s}=_u(n),a=uu(i,e,r,s);return f.useEffect(()=>{n.current&&a&&(n.current.style.setProperty("--lk-col-count",a?.columns.toString()),n.current.style.setProperty("--lk-row-count",a?.rows.toString()))},[n,a]),{layout:a,containerWidth:r,containerHeight:s}}function La(n,e={}){var t,i;const r=typeof n=="string"?e.participant:n.participant,s=Jn(r),a=typeof n=="string"?{participant:s,source:n}:n,[o,c]=f.useState(!!((t=a.publication)!=null&&t.isMuted||(i=s.getTrackPublication(a.source))!=null&&i.isMuted));return f.useEffect(()=>{const l=vu(a).subscribe(c);return()=>l.unsubscribe()},[Ee(a)]),o}function Z0(n){const e=Jn(n),t=f.useMemo(()=>t0(e),[e]);return Fe(t,e.isSpeaking)}function eb(){const n=Zs(),e=f.useMemo(()=>n0(n.localParticipant),[n]);return Fe(e,n.localParticipant.permissions)}function tb({kind:n,room:e,track:t,requestPermissions:i,onError:r}){const s=ir(),a=f.useMemo(()=>e??s??new Ct,[e,s]),o=f.useMemo(()=>Gv(n,r,i),[n,i,r]),c=Fe(o,[]),[l,u]=f.useState(a?.getActiveDevice(n)??"default"),{className:d,activeDeviceObservable:h,setActiveMediaDevice:p}=f.useMemo(()=>s0(n,a),[n,a,t]);return f.useEffect(()=>{const b=h.subscribe(m=>{m&&(G.info("setCurrentDeviceId",m),u(m))});return()=>{b?.unsubscribe()}},[h]),{devices:c,className:d,activeDeviceId:l,setActiveMediaDevice:p}}function Iu(n,e,t={}){const i=f.useRef([]),r=f.useRef(-1),s=e!==r.current,a=typeof t.customSortFunction=="function"?t.customSortFunction(n):Dv(n);let o=[...a];if(s===!1)try{o=Wv(i.current,a,e)}catch(c){G.error("Error while running updatePages(): ",c)}return s?i.current=a:i.current=o,r.current=e,o}function nb(n,e){const[t,i]=f.useState(1),r=Math.max(Math.ceil(e.length/n),1);t>r&&i(r);const s=t*n,a=s-n,o=u=>{i(d=>u==="next"?d===r?d:d+1:d===1?d:d-1)},c=u=>{u>r?i(r):u<1?i(1):i(u)},l=Iu(e,n).slice(a,s);return{totalPageCount:r,nextPage:()=>o("next"),prevPage:()=>o("previous"),setPage:c,firstItemIndex:a,lastItemIndex:s,tracks:l,currentPage:t}}function ib({trackRef:n,onParticipantClick:e,disableSpeakingIndicator:t,htmlProps:i}){const r=kn(n),s=f.useMemo(()=>{const{className:h}=u0();return pt(i,{className:h,onClick:p=>{var b;if((b=i.onClick)==null||b.call(i,p),typeof e=="function"){const m=r.publication??r.participant.getTrackPublication(r.source);e({participant:r.participant,track:m})}}})},[i,e,r.publication,r.source,r.participant]),a=r.participant.getTrackPublication(P.Source.Microphone),o=f.useMemo(()=>({participant:r.participant,source:P.Source.Microphone,publication:a}),[a,r.participant]),c=La(r),l=La(o),u=Z0(r.participant),d=Y0(r);return{elementProps:{"data-lk-audio-muted":l,"data-lk-video-muted":c,"data-lk-speaking":t===!0?!1:u,"data-lk-local-participant":r.participant.isLocal,"data-lk-source":r.source,"data-lk-facing-mode":d,...s}}}function rb(n){return n=A0(n),f.useMemo(()=>n?.pin.state!==void 0&&n.pin.state.length>=1?n.pin.state:[],[n.pin.state])}function sb({room:n,props:e}){const t=Sn(n),{className:i,roomAudioPlaybackAllowedObservable:r,handleStartAudioPlayback:s}=f.useMemo(()=>b0(),[]),a=f.useMemo(()=>r(t),[t,r]),{canPlayAudio:o}=Fe(a,{canPlayAudio:t.canPlaybackAudio});return{mergedProps:f.useMemo(()=>pt(e,{className:i,onClick:()=>{s(t)},style:{display:o?"none":"block"}}),[e,i,o,s,t]),canPlayAudio:o}}function ob({room:n,props:e}){const t=Sn(n),{className:i,roomVideoPlaybackAllowedObservable:r,handleStartVideoPlayback:s}=f.useMemo(()=>y0(),[]),a=f.useMemo(()=>r(t),[t,r]),{canPlayVideo:o}=Fe(a,{canPlayVideo:t.canPlaybackVideo});return{mergedProps:f.useMemo(()=>pt(e,{className:i,onClick:()=>{s(t)},style:{display:o?"none":"block"}}),[e,i,o,s,t]),canPlayVideo:o}}function ab(n,e={}){const t=f.useRef(null),i=f.useRef(null),r=e.minSwipeDistance??50,s=c=>{i.current=null,t.current=c.targetTouches[0].clientX},a=c=>{i.current=c.targetTouches[0].clientX},o=f.useCallback(()=>{if(!t.current||!i.current)return;const c=t.current-i.current,l=c>r,u=c<-r;l&&e.onLeftSwipe&&e.onLeftSwipe(),u&&e.onRightSwipe&&e.onRightSwipe()},[r,e]);f.useEffect(()=>{const c=n.current;return c&&(c.addEventListener("touchstart",s,{passive:!0}),c.addEventListener("touchmove",a,{passive:!0}),c.addEventListener("touchend",o,{passive:!0})),()=>{c&&(c.removeEventListener("touchstart",s),c.removeEventListener("touchmove",a),c.removeEventListener("touchend",o))}},[n,o])}function cb({props:n}){const{dispatch:e,state:t}=Su().widget,{className:i}=f.useMemo(()=>k0(),[]);return{mergedProps:f.useMemo(()=>pt(n,{className:i,onClick:()=>{e&&e({msg:"toggle_chat"})},"aria-pressed":t!=null&&t.showChat?"true":"false","data-lk-unread-msgs":t?t.unreadMessages<10?t.unreadMessages.toFixed(0):"9+":"0"}),[n,i,e,t])}}function lb(n){var e,t;const i=kn(n),{className:r,mediaMutedObserver:s}=f.useMemo(()=>c0(i),[Ee(i)]);return{isMuted:Fe(s,!!((e=i.publication)!=null&&e.isMuted||(t=i.participant.getTrackPublication(i.source))!=null&&t.isMuted)),className:r}}function ub({source:n,onChange:e,initialState:t,captureOptions:i,publishOptions:r,onDeviceError:s,room:a,...o}){var c;const l=ir(),u=f.useMemo(()=>a??l,[a,l]),d=(c=u?.localParticipant)==null?void 0:c.getTrackPublication(n),h=f.useRef(!1),{toggle:p,className:b,pendingObserver:m,enabledObserver:T}=f.useMemo(()=>u?i0(n,u,i,r,s):r0(),[u,n,JSON.stringify(i),r]),k=Fe(m,!1),w=Fe(T,t??!!(d!=null&&d.isEnabled));f.useEffect(()=>{e?.(w,h.current),h.current=!1},[w,e]),f.useEffect(()=>{t!==void 0&&(G.debug("forcing initial toggle state",n,t),p(t))},[]);const M=f.useMemo(()=>pt(o,{className:b}),[o,b]),v=f.useCallback(g=>{var y;h.current=!0,p().catch(()=>h.current=!1),(y=o.onClick)==null||y.call(o,g)},[o,p]);return{toggle:p,enabled:w,pending:k,track:d,buttonProps:{...M,"aria-pressed":w,"data-lk-source":n,"data-lk-enabled":w,disabled:k,onClick:v}}}function Ou(n=[P.Source.Camera,P.Source.Microphone,P.Source.ScreenShare,P.Source.ScreenShareAudio,P.Source.Unknown],e={}){const t=Sn(e.room),[i,r]=f.useState([]),[s,a]=f.useState([]),o=f.useMemo(()=>n.map(c=>pu(c)?c.source:c),[JSON.stringify(n)]);return f.useEffect(()=>{const c=C0(t,o,{additionalRoomEvents:e.updateOnlyOn,onlySubscribed:e.onlySubscribed}).subscribe(({trackReferences:l,participants:u})=>{G.debug("setting track bundles",l,u),r(l),a(u)});return()=>c.unsubscribe()},[t,JSON.stringify(e.onlySubscribed),JSON.stringify(e.updateOnlyOn),JSON.stringify(n)]),f.useMemo(()=>{if(mu(n)){const c=hb(n,s),l=Array.from(i);return s.forEach(u=>{c.has(u.identity)&&(c.get(u.identity)??[]).forEach(d=>{if(i.find(({participant:p,publication:b})=>u.identity===p.identity&&b.source===d))return;G.debug(`Add ${d} placeholder for participant ${u.identity}.`);const h={participant:u,source:d};l.push(h)})}),l}else return i},[i,s,n])}function db(n,e){const t=new Set(n);for(const i of e)t.delete(i);return t}function hb(n,e){const t=new Map;if(mu(n)){const i=n.filter(r=>r.withPlaceholder).map(r=>r.source);e.forEach(r=>{const s=r.getTrackPublications().map(o=>{var c;return(c=o.track)==null?void 0:c.source}).filter(o=>o!==void 0),a=Array.from(db(new Set(i),new Set(s)));a.length>0&&t.set(r.identity,a)})}return t}function fb(n){const e=Sn(n?.room),t=eo(e),i=f.useMemo(()=>t===Z.Disconnected,[t]),r=f.useMemo(()=>v0(e,n),[e,n,i]),s=Fe(r.isSendingObservable,!1),a=Fe(r.messageObservable,[]);return{send:r.send,chatMessages:a,isSending:s}}function pb(n={}){const[e,t]=f.useState(M0(n.defaults,n.preventLoad??!1)),i=f.useCallback(c=>{t(l=>({...l,audioEnabled:c}))},[]),r=f.useCallback(c=>{t(l=>({...l,videoEnabled:c}))},[]),s=f.useCallback(c=>{t(l=>({...l,audioDeviceId:c}))},[]),a=f.useCallback(c=>{t(l=>({...l,videoDeviceId:c}))},[]),o=f.useCallback(c=>{t(l=>({...l,username:c}))},[]);return f.useEffect(()=>{x0(e,n.preventSave??!1)},[e,n.preventSave]),{userChoices:e,saveAudioInputEnabled:i,saveVideoInputEnabled:r,saveAudioInputDeviceId:s,saveVideoInputDeviceId:a,saveUsername:o}}function mb(n,e={}){const t=Jn(n),i=Sn(e.room),r=f.useMemo(()=>Xv(i,t),[i,t]);return Fe(r,t.isLocal?t.isE2EEEnabled:!!(t!=null&&t.isEncrypted))}du.AgentState;var ii={exports:{}},Na;function gb(){if(Na)return ii.exports;Na=1;var n=typeof Reflect=="object"?Reflect:null,e=n&&typeof n.apply=="function"?n.apply:function(v,g,y){return Function.prototype.apply.call(v,g,y)},t;n&&typeof n.ownKeys=="function"?t=n.ownKeys:Object.getOwnPropertySymbols?t=function(v){return Object.getOwnPropertyNames(v).concat(Object.getOwnPropertySymbols(v))}:t=function(v){return Object.getOwnPropertyNames(v)};function i(v){console&&console.warn&&console.warn(v)}var r=Number.isNaN||function(v){return v!==v};function s(){s.init.call(this)}ii.exports=s,ii.exports.once=k,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var a=10;function o(v){if(typeof v!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof v)}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(v){if(typeof v!="number"||v<0||r(v))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+v+".");a=v}}),s.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(v){if(typeof v!="number"||v<0||r(v))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+v+".");return this._maxListeners=v,this};function c(v){return v._maxListeners===void 0?s.defaultMaxListeners:v._maxListeners}s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(v){for(var g=[],y=1;y<arguments.length;y++)g.push(arguments[y]);var C=v==="error",x=this._events;if(x!==void 0)C=C&&x.error===void 0;else if(!C)return!1;if(C){var _;if(g.length>0&&(_=g[0]),_ instanceof Error)throw _;var O=new Error("Unhandled error."+(_?" ("+_.message+")":""));throw O.context=_,O}var D=x[v];if(D===void 0)return!1;if(typeof D=="function")e(D,this,g);else for(var j=D.length,z=b(D,j),y=0;y<j;++y)e(z[y],this,g);return!0};function l(v,g,y,C){var x,_,O;if(o(y),_=v._events,_===void 0?(_=v._events=Object.create(null),v._eventsCount=0):(_.newListener!==void 0&&(v.emit("newListener",g,y.listener?y.listener:y),_=v._events),O=_[g]),O===void 0)O=_[g]=y,++v._eventsCount;else if(typeof O=="function"?O=_[g]=C?[y,O]:[O,y]:C?O.unshift(y):O.push(y),x=c(v),x>0&&O.length>x&&!O.warned){O.warned=!0;var D=new Error("Possible EventEmitter memory leak detected. "+O.length+" "+String(g)+" listeners added. Use emitter.setMaxListeners() to increase limit");D.name="MaxListenersExceededWarning",D.emitter=v,D.type=g,D.count=O.length,i(D)}return v}s.prototype.addListener=function(v,g){return l(this,v,g,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(v,g){return l(this,v,g,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(v,g,y){var C={fired:!1,wrapFn:void 0,target:v,type:g,listener:y},x=u.bind(C);return x.listener=y,C.wrapFn=x,x}s.prototype.once=function(v,g){return o(g),this.on(v,d(this,v,g)),this},s.prototype.prependOnceListener=function(v,g){return o(g),this.prependListener(v,d(this,v,g)),this},s.prototype.removeListener=function(v,g){var y,C,x,_,O;if(o(g),C=this._events,C===void 0)return this;if(y=C[v],y===void 0)return this;if(y===g||y.listener===g)--this._eventsCount===0?this._events=Object.create(null):(delete C[v],C.removeListener&&this.emit("removeListener",v,y.listener||g));else if(typeof y!="function"){for(x=-1,_=y.length-1;_>=0;_--)if(y[_]===g||y[_].listener===g){O=y[_].listener,x=_;break}if(x<0)return this;x===0?y.shift():m(y,x),y.length===1&&(C[v]=y[0]),C.removeListener!==void 0&&this.emit("removeListener",v,O||g)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(v){var g,y,C;if(y=this._events,y===void 0)return this;if(y.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):y[v]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete y[v]),this;if(arguments.length===0){var x=Object.keys(y),_;for(C=0;C<x.length;++C)_=x[C],_!=="removeListener"&&this.removeAllListeners(_);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(g=y[v],typeof g=="function")this.removeListener(v,g);else if(g!==void 0)for(C=g.length-1;C>=0;C--)this.removeListener(v,g[C]);return this};function h(v,g,y){var C=v._events;if(C===void 0)return[];var x=C[g];return x===void 0?[]:typeof x=="function"?y?[x.listener||x]:[x]:y?T(x):b(x,x.length)}s.prototype.listeners=function(v){return h(this,v,!0)},s.prototype.rawListeners=function(v){return h(this,v,!1)},s.listenerCount=function(v,g){return typeof v.listenerCount=="function"?v.listenerCount(g):p.call(v,g)},s.prototype.listenerCount=p;function p(v){var g=this._events;if(g!==void 0){var y=g[v];if(typeof y=="function")return 1;if(y!==void 0)return y.length}return 0}s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function b(v,g){for(var y=new Array(g),C=0;C<g;++C)y[C]=v[C];return y}function m(v,g){for(;g+1<v.length;g++)v[g]=v[g+1];v.pop()}function T(v){for(var g=new Array(v.length),y=0;y<g.length;++y)g[y]=v[y].listener||v[y];return g}function k(v,g){return new Promise(function(y,C){function x(O){v.removeListener(g,_),C(O)}function _(){typeof v.removeListener=="function"&&v.removeListener("error",x),y([].slice.call(arguments))}M(v,g,_,{once:!0}),g!=="error"&&w(v,x,{once:!0})})}function w(v,g,y){typeof v.on=="function"&&M(v,"error",g,y)}function M(v,g,y,C){if(typeof v.on=="function")C.once?v.once(g,y):v.on(g,y);else if(typeof v.addEventListener=="function")v.addEventListener(g,function x(_){C.once&&v.removeEventListener(g,x),y(_)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof v)}return ii.exports}gb();const xu=f.forwardRef(function(n,e){const{mergedProps:t}=cb({props:n});return f.createElement("button",{ref:e,...t},n.children)}),vb=f.forwardRef(function(n,e){const{buttonProps:t}=J0(n);return f.createElement("button",{ref:e,...t},n.children)}),bb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{d:"M1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708L11 10.293V4.5A1.5 1.5 0 0 0 9.5 3H3.707zM0 4.5a1.5 1.5 0 0 1 .943-1.393l9.532 9.533c-.262.224-.603.36-.975.36h-8A1.5 1.5 0 0 1 0 11.5z"}),f.createElement("path",{d:"m15.2 3.6-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),yb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{d:"M0 4.5A1.5 1.5 0 0 1 1.5 3h8A1.5 1.5 0 0 1 11 4.5v7A1.5 1.5 0 0 1 9.5 13h-8A1.5 1.5 0 0 1 0 11.5zM15.2 3.6l-2.8 2.1a1 1 0 0 0-.4.8v3a1 1 0 0 0 .4.8l2.8 2.1a.5.5 0 0 0 .8-.4V4a.5.5 0 0 0-.8-.4z"})),kb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,viewBox:"0 0 24 24",...n},f.createElement("path",{fill:"#FFF",d:"M4.99 3.99a1 1 0 0 0-.697 1.717L10.586 12l-6.293 6.293a1 1 0 1 0 1.414 1.414L12 13.414l6.293 6.293a1 1 0 1 0 1.414-1.414L13.414 12l6.293-6.293a1 1 0 0 0-.727-1.717 1 1 0 0 0-.687.303L12 10.586 5.707 4.293a1 1 0 0 0-.717-.303z"})),Sb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:18,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h10.5A2.75 2.75 0 0 1 16 2.75v13.594a.75.75 0 0 1-1.234.572l-3.691-3.12a1.25 1.25 0 0 0-.807-.296H2.75A2.75 2.75 0 0 1 0 10.75v-8ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v8c0 .69.56 1.25 1.25 1.25h7.518c.65 0 1.279.23 1.775.65l2.457 2.077V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M3 4.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5Zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5Z",clipRule:"evenodd"})),Ua=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M5.293 2.293a1 1 0 0 1 1.414 0l4.823 4.823a1.25 1.25 0 0 1 0 1.768l-4.823 4.823a1 1 0 0 1-1.414-1.414L9.586 8 5.293 3.707a1 1 0 0 1 0-1.414z",clipRule:"evenodd"})),Tb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},f.createElement("path",{d:"M10 1.75h4.25m0 0V6m0-4.25L9 7M6 14.25H1.75m0 0V10m0 4.25L7 9"}))),Cb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M8.961.894C8.875-.298 7.125-.298 7.04.894c-.066.912-1.246 1.228-1.76.472-.67-.99-2.186-.115-1.664.96.399.824-.465 1.688-1.288 1.289-1.076-.522-1.95.994-.961 1.665.756.513.44 1.693-.472 1.759-1.192.086-1.192 1.836 0 1.922.912.066 1.228 1.246.472 1.76-.99.67-.115 2.186.96 1.664.824-.399 1.688.465 1.289 1.288-.522 1.076.994 1.95 1.665.961.513-.756 1.693-.44 1.759.472.086 1.192 1.836 1.192 1.922 0 .066-.912 1.246-1.228 1.76-.472.67.99 2.186.115 1.664-.96-.399-.824.465-1.688 1.288-1.289 1.076.522 1.95-.994.961-1.665-.756-.513-.44-1.693.472-1.759 1.192-.086 1.192-1.836 0-1.922-.912-.066-1.228-1.246-.472-1.76.99-.67.115-2.186-.96-1.664-.824.399-1.688-.465-1.289-1.288.522-1.076-.994-1.95-1.665-.961-.513.756-1.693.44-1.759-.472ZM8 13A5 5 0 1 0 8 3a5 5 0 0 0 0 10Z",clipRule:"evenodd"})),Eb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M2 2.75A2.75 2.75 0 0 1 4.75 0h6.5A2.75 2.75 0 0 1 14 2.75v10.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-.5a.75.75 0 0 1 1.5 0v.5c0 .69.56 1.25 1.25 1.25h6.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25h-6.5c-.69 0-1.25.56-1.25 1.25v.5a.75.75 0 0 1-1.5 0v-.5Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8.78 7.47a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 1 1-1.06-1.06l.97-.97H1.75a.75.75 0 0 1 0-1.5h4.69l-.97-.97a.75.75 0 0 1 1.06-1.06l2.25 2.25Z",clipRule:"evenodd"})),wb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentcolor",fillRule:"evenodd",d:"M4 6.104V4a4 4 0 1 1 8 0v2.104c1.154.326 2 1.387 2 2.646v4.5A2.75 2.75 0 0 1 11.25 16h-6.5A2.75 2.75 0 0 1 2 13.25v-4.5c0-1.259.846-2.32 2-2.646ZM5.5 4a2.5 2.5 0 0 1 5 0v2h-5V4Z",clipRule:"evenodd"})),Pb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{d:"M12.227 11.52a5.477 5.477 0 0 0 1.246-2.97.5.5 0 0 0-.995-.1 4.478 4.478 0 0 1-.962 2.359l-1.07-1.07C10.794 9.247 11 8.647 11 8V3a3 3 0 0 0-6 0v1.293L1.354.646a.5.5 0 1 0-.708.708l14 14a.5.5 0 0 0 .708-.708zM8 12.5c.683 0 1.33-.152 1.911-.425l.743.743c-.649.359-1.378.59-2.154.66V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .995-.098A4.5 4.5 0 0 0 8 12.5z"}),f.createElement("path",{d:"M8.743 10.907 5 7.164V8a3 3 0 0 0 3.743 2.907z"})),Rb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("path",{fillRule:"evenodd",d:"M2.975 8.002a.5.5 0 0 1 .547.449 4.5 4.5 0 0 0 8.956 0 .5.5 0 1 1 .995.098A5.502 5.502 0 0 1 8.5 13.478V15h2a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1h2v-1.522a5.502 5.502 0 0 1-4.973-4.929.5.5 0 0 1 .448-.547z",clipRule:"evenodd"}),f.createElement("path",{d:"M5 3a3 3 0 1 1 6 0v5a3 3 0 0 1-6 0z"})),_b=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"})),Ib=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("g",{opacity:.25},f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),Ob=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentcolor",...n},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("g",{opacity:.25},f.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M6 6.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}),f.createElement("path",{d:"M12 .5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5z"}))),xb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"currentColor",...n},f.createElement("g",{opacity:.25},f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}),f.createElement("path",{d:"M0 11.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-4Zm6-5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-9Zm6-6a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v15a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V.5Z"}))),Mu=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M0 2.75A2.75 2.75 0 0 1 2.75 0h14.5A2.75 2.75 0 0 1 20 2.75v10.5A2.75 2.75 0 0 1 17.25 16H2.75A2.75 2.75 0 0 1 0 13.25V2.75ZM2.75 1.5c-.69 0-1.25.56-1.25 1.25v10.5c0 .69.56 1.25 1.25 1.25h14.5c.69 0 1.25-.56 1.25-1.25V2.75c0-.69-.56-1.25-1.25-1.25H2.75Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M9.47 4.22a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1-1.06 1.06l-.97-.97v4.69a.75.75 0 0 1-1.5 0V6.56l-.97.97a.75.75 0 0 1-1.06-1.06l2.25-2.25Z",clipRule:"evenodd"})),Mb=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:20,height:16,fill:"none",...n},f.createElement("g",{fill:"currentColor"},f.createElement("path",{d:"M7.28 4.22a.75.75 0 0 0-1.06 1.06L8.94 8l-2.72 2.72a.75.75 0 1 0 1.06 1.06L10 9.06l2.72 2.72a.75.75 0 1 0 1.06-1.06L11.06 8l2.72-2.72a.75.75 0 0 0-1.06-1.06L10 6.94z"}),f.createElement("path",{fillRule:"evenodd",d:"M2.75 0A2.75 2.75 0 0 0 0 2.75v10.5A2.75 2.75 0 0 0 2.75 16h14.5A2.75 2.75 0 0 0 20 13.25V2.75A2.75 2.75 0 0 0 17.25 0zM1.5 2.75c0-.69.56-1.25 1.25-1.25h14.5c.69 0 1.25.56 1.25 1.25v10.5c0 .69-.56 1.25-1.25 1.25H2.75c-.69 0-1.25-.56-1.25-1.25z",clipRule:"evenodd"}))),Fa=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8 0a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0V.75A.75.75 0 0 1 8 0Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M8 12a.75.75 0 0 1 .75.75v2.5a.75.75 0 0 1-1.5 0v-2.5A.75.75 0 0 1 8 12Z",clipRule:"evenodd",opacity:.7}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M12 1.072a.75.75 0 0 1 .274 1.024l-1.25 2.165a.75.75 0 0 1-1.299-.75l1.25-2.165A.75.75 0 0 1 12 1.072Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M6 11.464a.75.75 0 0 1 .274 1.025l-1.25 2.165a.75.75 0 0 1-1.299-.75l1.25-2.165A.75.75 0 0 1 6 11.464Z",clipRule:"evenodd",opacity:.6}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M14.928 4a.75.75 0 0 1-.274 1.025l-2.165 1.25a.75.75 0 1 1-.75-1.3l2.165-1.25A.75.75 0 0 1 14.928 4Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.536 10a.75.75 0 0 1-.275 1.024l-2.165 1.25a.75.75 0 0 1-.75-1.298l2.165-1.25A.75.75 0 0 1 4.536 10Z",clipRule:"evenodd",opacity:.5}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M16 8a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h2.5A.75.75 0 0 1 16 8Z",clipRule:"evenodd"}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4 8a.75.75 0 0 1-.75.75H.75a.75.75 0 0 1 0-1.5h2.5A.75.75 0 0 1 4 8Z",clipRule:"evenodd",opacity:.4}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M14.928 12a.75.75 0 0 1-1.024.274l-2.165-1.25a.75.75 0 0 1 .75-1.299l2.165 1.25A.75.75 0 0 1 14.928 12Z",clipRule:"evenodd",opacity:.9}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M4.536 6a.75.75 0 0 1-1.025.275l-2.165-1.25a.75.75 0 1 1 .75-1.3l2.165 1.25A.75.75 0 0 1 4.536 6Z",clipRule:"evenodd",opacity:.3}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M12 14.928a.75.75 0 0 1-1.024-.274l-1.25-2.165a.75.75 0 0 1 1.298-.75l1.25 2.165A.75.75 0 0 1 12 14.928Z",clipRule:"evenodd",opacity:.8}),f.createElement("path",{fill:"currentColor",fillRule:"evenodd",d:"M6 4.536a.75.75 0 0 1-1.024-.275l-1.25-2.165a.75.75 0 1 1 1.299-.75l1.25 2.165A.75.75 0 0 1 6 4.536Z",clipRule:"evenodd",opacity:.2})),Ab=n=>f.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:16,height:16,fill:"none",...n},f.createElement("g",{stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5},f.createElement("path",{d:"M13.25 7H9m0 0V2.75M9 7l5.25-5.25M2.75 9H7m0 0v4.25M7 9l-5.25 5.25"}))),Db=f.forwardRef(function({trackRef:n,...e},t){const i=nr(),{mergedProps:r,inFocus:s}=Q0({trackRef:n??i,props:e});return f.createElement(tr.Consumer,null,a=>a!==void 0&&f.createElement("button",{ref:t,...r},e.children?e.children:s?f.createElement(Ab,null):f.createElement(Tb,null)))}),Rr=f.forwardRef(function({kind:n,initialSelection:e,onActiveDeviceChange:t,onDeviceListChange:i,onDeviceSelectError:r,exactMatch:s,track:a,requestPermissions:o,onError:c,...l},u){const d=ir(),h=f.useRef("default"),p=f.useCallback(y=>{d&&d.emit(I.MediaDevicesError,y),c?.(y)},[d,c]),{devices:b,activeDeviceId:m,setActiveMediaDevice:T,className:k}=tb({kind:n,room:d,track:a,requestPermissions:o,onError:p});f.useEffect(()=>{e!==void 0&&T(e)},[T]),f.useEffect(()=>{typeof i=="function"&&i(b)},[i,b]),f.useEffect(()=>{m!==h.current&&t?.(m),h.current=m},[m]);const w=async y=>{try{await T(y,{exact:s??!0})}catch(C){if(C instanceof Error)r?.(C);else throw C}},M=f.useMemo(()=>Pt(l,{className:k},{className:"lk-list"}),[k,l]),v=!!b.find(y=>y.label.toLowerCase().startsWith("default"));function g(y,C,x){return y===C||!v&&x===0&&C==="default"}return f.createElement("ul",{ref:u,...M},b.map((y,C)=>f.createElement("li",{key:y.deviceId,id:y.deviceId,"data-lk-active":g(y.deviceId,m,C),"aria-selected":g(y.deviceId,m,C),role:"option"},f.createElement("button",{className:"lk-button",onClick:()=>w(y.deviceId)},y.label))))}),Lb=f.forwardRef(function({label:n,...e},t){const i=Zs(),{mergedProps:r,canPlayAudio:s}=sb({room:i,props:e}),{mergedProps:a,canPlayVideo:o}=ob({room:i,props:r}),{style:c,...l}=a;return c.display=s&&o?"none":"block",f.createElement("button",{ref:t,style:c,...l},n??`Start ${s?"Video":"Audio"}`)});function Au(n,e){switch(n){case P.Source.Microphone:return e?f.createElement(Rb,null):f.createElement(Pb,null);case P.Source.Camera:return e?f.createElement(yb,null):f.createElement(bb,null);case P.Source.ScreenShare:return e?f.createElement(Mb,null):f.createElement(Mu,null);default:return}}function Nb(n){switch(n){case Je.Excellent:return f.createElement(_b,null);case Je.Good:return f.createElement(Ib,null);case Je.Poor:return f.createElement(Ob,null);default:return f.createElement(xb,null)}}const _r=f.forwardRef(function({showIcon:n,...e},t){const{buttonProps:i,enabled:r}=ub(e),[s,a]=f.useState(!1);return f.useEffect(()=>{a(!0)},[]),s&&f.createElement("button",{ref:t,...i},(n??!0)&&Au(e.source,r),e.children)}),Ub=f.forwardRef(function(n,e){const{className:t,quality:i}=$0(n),r=f.useMemo(()=>({...Pt(n,{className:t}),"data-lk-quality":i}),[i,n,t]);return f.createElement("div",{ref:e,...r},n.children??Nb(i))}),ja=f.forwardRef(function({participant:n,...e},t){const i=Jn(n),{className:r,infoObserver:s}=f.useMemo(()=>l0(i),[i]),{identity:a,name:o}=Fe(s,{name:i.name,identity:i.identity,metadata:i.metadata}),c=f.useMemo(()=>Pt(e,{className:r,"data-lk-participant-name":o}),[e,r,o]);return f.createElement("span",{ref:t,...c},o!==""?o:a,e.children)}),Fb=f.forwardRef(function({trackRef:n,show:e="always",...t},i){const{className:r,isMuted:s}=lb(n),a=e==="always"||e==="muted"&&s||e==="unmuted"&&!s,o=f.useMemo(()=>Pt(t,{className:r}),[r,t]);return a?f.createElement("div",{ref:i,...o,"data-lk-muted":s},t.children??Au(n.source,!s)):null}),jb=n=>f.createElement("svg",{width:320,height:320,viewBox:"0 0 320 320",preserveAspectRatio:"xMidYMid meet",fill:"none",xmlns:"http://www.w3.org/2000/svg",...n},f.createElement("path",{d:"M160 180C204.182 180 240 144.183 240 100C240 55.8172 204.182 20 160 20C115.817 20 79.9997 55.8172 79.9997 100C79.9997 144.183 115.817 180 160 180Z",fill:"white",fillOpacity:.25}),f.createElement("path",{d:"M97.6542 194.614C103.267 191.818 109.841 192.481 115.519 195.141C129.025 201.466 144.1 205 159.999 205C175.899 205 190.973 201.466 204.48 195.141C210.158 192.481 216.732 191.818 222.345 194.614C262.703 214.719 291.985 253.736 298.591 300.062C300.15 310.997 291.045 320 280 320H39.9997C28.954 320 19.8495 310.997 21.4087 300.062C28.014 253.736 57.2966 214.72 97.6542 194.614Z",fill:"white",fillOpacity:.25}));function Du(n,e={}){const[t,i]=f.useState(ls(n)),[r,s]=f.useState(t?.isMuted),[a,o]=f.useState(t?.isSubscribed),[c,l]=f.useState(t?.track),[u,d]=f.useState("landscape"),h=f.useRef(),{className:p,trackObserver:b}=f.useMemo(()=>Kv(n),[n.participant.sid??n.participant.identity,n.source,ye(n)&&n.publication.trackSid]);return f.useEffect(()=>{const m=b.subscribe(T=>{G.debug("update track",T),i(T),s(T?.isMuted),o(T?.isSubscribed),l(T?.track)});return()=>m?.unsubscribe()},[b]),f.useEffect(()=>{var m,T;return c&&(h.current&&c.detach(h.current),(m=e.element)!=null&&m.current&&!(n.participant.isLocal&&c?.kind==="audio")&&c.attach(e.element.current)),h.current=(T=e.element)==null?void 0:T.current,()=>{h.current&&c?.detach(h.current)}},[c,e.element]),f.useEffect(()=>{var m,T;if(typeof((m=t?.dimensions)==null?void 0:m.width)=="number"&&typeof((T=t?.dimensions)==null?void 0:T.height)=="number"){const k=t.dimensions.width>t.dimensions.height?"landscape":"portrait";d(k)}},[t]),{publication:t,isMuted:r,isSubscribed:a,track:c,elementProps:Pt(e.props,{className:p,"data-lk-local-participant":n.participant.isLocal,"data-lk-source":t?.source,...t?.kind==="video"&&{"data-lk-orientation":u}})}}var Ir,Ba;function Bb(){if(Ba)return Ir;Ba=1;var n="Expected a function",e=NaN,t="[object Symbol]",i=/^\s+|\s+$/g,r=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,a=/^0o[0-7]+$/i,o=parseInt,c=typeof ei=="object"&&ei&&ei.Object===Object&&ei,l=typeof self=="object"&&self&&self.Object===Object&&self,u=c||l||Function("return this")(),d=Object.prototype,h=d.toString,p=Math.max,b=Math.min,m=function(){return u.Date.now()};function T(g,y,C){var x,_,O,D,j,z,ee=0,_e=!1,te=!1,re=!0;if(typeof g!="function")throw new TypeError(n);y=v(y)||0,k(C)&&(_e=!!C.leading,te="maxWait"in C,O=te?p(v(C.maxWait)||0,y):O,re="trailing"in C?!!C.trailing:re);function Se(W){var ve=x,pe=_;return x=_=void 0,ee=W,D=g.apply(pe,ve),D}function we(W){return ee=W,j=setTimeout(N,y),_e?Se(W):D}function mt(W){var ve=W-z,pe=W-ee,Yn=y-ve;return te?b(Yn,O-pe):Yn}function E(W){var ve=W-z,pe=W-ee;return z===void 0||ve>=y||ve<0||te&&pe>=O}function N(){var W=m();if(E(W))return V(W);j=setTimeout(N,mt(W))}function V(W){return j=void 0,re&&x?Se(W):(x=_=void 0,D)}function q(){j!==void 0&&clearTimeout(j),ee=0,x=z=_=j=void 0}function Q(){return j===void 0?D:V(m())}function X(){var W=m(),ve=E(W);if(x=arguments,_=this,z=W,ve){if(j===void 0)return we(z);if(te)return j=setTimeout(N,y),Se(z)}return j===void 0&&(j=setTimeout(N,y)),D}return X.cancel=q,X.flush=Q,X}function k(g){var y=typeof g;return!!g&&(y=="object"||y=="function")}function w(g){return!!g&&typeof g=="object"}function M(g){return typeof g=="symbol"||w(g)&&h.call(g)==t}function v(g){if(typeof g=="number")return g;if(M(g))return e;if(k(g)){var y=typeof g.valueOf=="function"?g.valueOf():g;g=k(y)?y+"":y}if(typeof g!="string")return g===0?g:+g;g=g.replace(i,"");var C=s.test(g);return C||a.test(g)?o(g.slice(2),C?2:8):r.test(g)?e:+g}return Ir=T,Ir}var Vb=Bb();const Va=Hl(Vb);function qb(n){const e=f.useRef(n);e.current=n,f.useEffect(()=>()=>{e.current()},[])}function Wb(n,e=500,t){const i=f.useRef();qb(()=>{i.current&&i.current.cancel()});const r=f.useMemo(()=>{const s=Va(n,e,t),a=(...o)=>s(...o);return a.cancel=()=>{s.cancel()},a.isPending=()=>!!i.current,a.flush=()=>s.flush(),a},[n,e,t]);return f.useEffect(()=>{i.current=Va(n,e,t)},[n,e,t]),r}function Hb(n,e,t){const i=((l,u)=>l===u),r=n instanceof Function?n():n,[s,a]=f.useState(r),o=f.useRef(r),c=Wb(a,e,t);return i(o.current,r)||(c(r),o.current=r),[s,c]}function Kb({threshold:n=0,root:e=null,rootMargin:t="0%",freezeOnceVisible:i=!1,initialIsIntersecting:r=!1,onChange:s}={}){var a;const[o,c]=f.useState(null),[l,u]=f.useState(()=>({isIntersecting:r,entry:void 0})),d=f.useRef();d.current=s;const h=((a=l.entry)==null?void 0:a.isIntersecting)&&i;f.useEffect(()=>{if(!o||!("IntersectionObserver"in window)||h)return;const m=new IntersectionObserver(T=>{const k=Array.isArray(m.thresholds)?m.thresholds:[m.thresholds];T.forEach(w=>{const M=w.isIntersecting&&k.some(v=>w.intersectionRatio>=v);u({isIntersecting:M,entry:w}),d.current&&d.current(M,w)})},{threshold:n,root:e,rootMargin:t});return m.observe(o),()=>{m.disconnect()}},[o,JSON.stringify(n),e,t,h,i]);const p=f.useRef(null);f.useEffect(()=>{var m;!o&&(m=l.entry)!=null&&m.target&&!i&&!h&&p.current!==l.entry.target&&(p.current=l.entry.target,u({isIntersecting:r,entry:void 0}))},[o,l.entry,i,h,r]);const b=[c,!!l.isIntersecting,l.entry];return b.ref=b[0],b.isIntersecting=b[1],b.entry=b[2],b}const zb=f.forwardRef(function({onTrackClick:n,onClick:e,onSubscriptionStatusChanged:t,trackRef:i,manageSubscription:r,...s},a){const o=kn(i),c=f.useRef(null);f.useImperativeHandle(a,()=>c.current);const l=Kb({root:c.current}),[u]=Hb(l,3e3);f.useEffect(()=>{r&&o.publication instanceof _i&&u?.isIntersecting===!1&&l?.isIntersecting===!1&&o.publication.setSubscribed(!1)},[u,o,r]),f.useEffect(()=>{r&&o.publication instanceof _i&&l?.isIntersecting===!0&&o.publication.setSubscribed(!0)},[l,o,r]);const{elementProps:d,publication:h,isSubscribed:p}=Du(o,{element:c,props:s});f.useEffect(()=>{t?.(!!p)},[p,t]);const b=m=>{e?.(m),n?.({participant:o?.participant,track:h})};return f.createElement("video",{ref:c,...d,muted:!0,onClick:b})}),Lu=f.forwardRef(function({trackRef:n,onSubscriptionStatusChanged:e,volume:t,...i},r){const s=kn(n),a=f.useRef(null);f.useImperativeHandle(r,()=>a.current);const{elementProps:o,isSubscribed:c,track:l,publication:u}=Du(s,{element:a,props:i});return f.useEffect(()=>{e?.(!!c)},[c,e]),f.useEffect(()=>{l===void 0||t===void 0||(l instanceof Il?l.setVolume(t):G.warn("Volume can only be set on remote audio tracks."))},[t,l]),f.useEffect(()=>{u===void 0||i.muted===void 0||(u instanceof _i?u.setEnabled(!i.muted):G.warn("Can only call setEnabled on remote track publications."))},[i.muted,u,l]),f.createElement("audio",{ref:a,...o})});function Gb(n){const e=!!Cu();return n.participant&&!e?f.createElement(Tu.Provider,{value:n.participant},n.children):f.createElement(f.Fragment,null,n.children)}function $b(n){const e=!!nr();return n.trackRef&&!e?f.createElement(Qs.Provider,{value:n.trackRef},n.children):f.createElement(f.Fragment,null,n.children)}const us=f.forwardRef(function({trackRef:n,children:e,onParticipantClick:t,disableSpeakingIndicator:i,...r},s){var a,o;const c=kn(n),{elementProps:l}=ib({htmlProps:r,disableSpeakingIndicator:i,onParticipantClick:t,trackRef:c}),u=mb(c.participant),d=$n(),h=(a=N0())==null?void 0:a.autoSubscription,p=f.useCallback(b=>{c.source&&!b&&d&&d.pin.dispatch&&lu(c,d.pin.state)&&d.pin.dispatch({msg:"clear_pin"})},[c,d]);return f.createElement("div",{ref:s,style:{position:"relative"},...l},f.createElement($b,{trackRef:c},f.createElement(Gb,{participant:c.participant},e??f.createElement(f.Fragment,null,ye(c)&&(((o=c.publication)==null?void 0:o.kind)==="video"||c.source===P.Source.Camera||c.source===P.Source.ScreenShare)?f.createElement(zb,{trackRef:c,onSubscriptionStatusChanged:p,manageSubscription:h}):ye(c)&&f.createElement(Lu,{trackRef:c,onSubscriptionStatusChanged:p}),f.createElement("div",{className:"lk-participant-placeholder"},f.createElement(jb,null)),f.createElement("div",{className:"lk-participant-metadata"},f.createElement("div",{className:"lk-participant-metadata-item"},c.source===P.Source.Camera?f.createElement(f.Fragment,null,u&&f.createElement(wb,{style:{marginRight:"0.25rem"}}),f.createElement(Fb,{trackRef:{participant:c.participant,source:P.Source.Microphone},show:"muted"}),f.createElement(ja,null)):f.createElement(f.Fragment,null,f.createElement(Mu,{style:{marginRight:"0.25rem"}}),f.createElement(ja,null,"'s screen"))),f.createElement(Ub,{className:"lk-participant-metadata-item"}))),f.createElement(Db,{trackRef:c}))))});function Jb(n){const e=Pt(n,{className:"lk-focus-layout"});return f.createElement("div",{...e},n.children)}function Yb({trackRef:n,...e}){return f.createElement(us,{trackRef:n,...e})}function Nu({tracks:n,...e}){return f.createElement(f.Fragment,null,n.map(t=>f.createElement(Qs.Provider,{value:t,key:Ee(t)},Ru(e.children))))}function Qb({totalPageCount:n,nextPage:e,prevPage:t,currentPage:i,pagesContainer:r}){const[s,a]=f.useState(!1);return f.useEffect(()=>{let o;return r&&(o=E0(r.current,2e3).subscribe(a)),()=>{o&&o.unsubscribe()}},[r]),f.createElement("div",{className:"lk-pagination-control","data-lk-user-interaction":s},f.createElement("button",{className:"lk-button",onClick:t},f.createElement(Ua,null)),f.createElement("span",{className:"lk-pagination-count"},`${i} of ${n}`),f.createElement("button",{className:"lk-button",onClick:e},f.createElement(Ua,null)))}const Xb=f.forwardRef(function({totalPageCount:n,currentPage:e},t){const i=new Array(n).fill("").map((r,s)=>s+1===e?f.createElement("span",{"data-lk-active":!0,key:s}):f.createElement("span",{key:s}));return f.createElement("div",{ref:t,className:"lk-pagination-indicator"},i)});function Zb({tracks:n,...e}){const t=f.createRef(),i=f.useMemo(()=>Pt(e,{className:"lk-grid-layout"}),[e]),{layout:r}=X0(t,n.length),s=nb(r.maxTiles,n);return ab(t,{onLeftSwipe:s.nextPage,onRightSwipe:s.prevPage}),f.createElement("div",{ref:t,"data-lk-pagination":s.totalPageCount>1,...i},f.createElement(Nu,{tracks:s.tracks},e.children),n.length>r.maxTiles&&f.createElement(f.Fragment,null,f.createElement(Xb,{totalPageCount:s.totalPageCount,currentPage:s.currentPage}),f.createElement(Qb,{pagesContainer:t,...s})))}const ey=130,ty=140,ny=1,Uu=16/10,iy=(1-Uu)*-1;function ry({tracks:n,orientation:e,...t}){const i=f.useRef(null),[r,s]=f.useState(0),{width:a,height:o}=_u(i),c=e||(o>=a?"vertical":"horizontal"),l=c==="vertical"?Math.max(a*iy,ey):Math.max(o*Uu,ty),u=yv(),d=Math.max(c==="vertical"?(o-u)/l:(a-u)/l,ny);let h=Math.round(d);Math.abs(d-r)<.5?h=Math.round(r):r!==d&&s(d);const p=Iu(n,h);return f.useLayoutEffect(()=>{i.current&&(i.current.dataset.lkOrientation=c,i.current.style.setProperty("--lk-max-visible-tiles",h.toString()))},[h,c]),f.createElement("aside",{key:c,className:"lk-carousel",ref:i,...t},f.createElement(Nu,{tracks:p},t.children))}function sy({value:n,onPinChange:e,onWidgetChange:t,children:i}){const r=L0(n);return f.useEffect(()=>{G.debug("PinState Updated",{state:r.pin.state}),e&&r.pin.state&&e(r.pin.state)},[r.pin.state,e]),f.useEffect(()=>{G.debug("Widget Updated",{widgetState:r.widget.state}),t&&r.widget.state&&t(r.widget.state)},[t,r.widget.state]),f.createElement(tr.Provider,{value:r},i)}function oy({room:n,volume:e,muted:t}){const i=Ou([P.Source.Microphone,P.Source.ScreenShareAudio,P.Source.Unknown],{updateOnlyOn:[],onlySubscribed:!0,room:n}).filter(r=>!r.participant.isLocal&&r.publication.kind===P.Kind.Audio);return f.createElement("div",{style:{display:"none"}},i.map(r=>f.createElement(Lu,{key:Ee(r),trackRef:r,volume:e,muted:t})))}function ay(n){const e=f.useMemo(()=>Pt(n,{className:"lk-toast"}),[n]);return f.createElement("div",{...e},n.children)}function cy(n){const[e,t]=f.useState(void 0),i=eo(n.room);return f.useEffect(()=>{switch(i){case Z.Reconnecting:t(f.createElement(f.Fragment,null,f.createElement(Fa,{className:"lk-spinner"})," Reconnecting"));break;case Z.Connecting:t(f.createElement(f.Fragment,null,f.createElement(Fa,{className:"lk-spinner"})," Connecting"));break;case Z.Disconnected:t(f.createElement(f.Fragment,null,"Disconnected"));break;default:t(void 0);break}},[i]),e?f.createElement(ay,{className:"lk-toast-connection-state"},e):f.createElement(f.Fragment,null)}const ly=f.forwardRef(function({entry:n,hideName:e=!1,hideTimestamp:t=!1,messageFormatter:i,...r},s){var a,o,c,l;const u=f.useMemo(()=>i?i(n.message):n.message,[n.message,i]),d=!!n.editTimestamp,h=new Date(n.timestamp),p=typeof navigator<"u"?navigator.language:"en-US",b=((a=n.from)==null?void 0:a.name)??((o=n.from)==null?void 0:o.identity);return f.createElement("li",{ref:s,className:"lk-chat-entry",title:h.toLocaleTimeString(p,{timeStyle:"full"}),"data-lk-message-origin":(c=n.from)!=null&&c.isLocal?"local":"remote",...r},(!t||!e||d)&&f.createElement("span",{className:"lk-meta-data"},!e&&f.createElement("strong",{className:"lk-participant-name"},b),(!t||d)&&f.createElement("span",{className:"lk-timestamp"},d&&"edited ",h.toLocaleTimeString(p,{timeStyle:"short"}))),f.createElement("span",{className:"lk-message-body"},u),f.createElement("span",{className:"lk-message-attachements"},(l=n.attachedFiles)==null?void 0:l.map(m=>m.type.startsWith("image/")&&f.createElement("img",{style:{maxWidth:"300px",maxHeight:"300px"},key:m.name,src:URL.createObjectURL(m),alt:m.name}))))});function uy({messageFormatter:n,messageDecoder:e,messageEncoder:t,channelTopic:i,...r}){const s=f.useRef(null),a=f.useRef(null),o=f.useMemo(()=>({messageDecoder:e,messageEncoder:t,channelTopic:i}),[e,t,i]),{chatMessages:c,send:l,isSending:u}=fb(o),d=$n(),h=f.useRef(0);async function p(b){b.preventDefault(),a.current&&a.current.value.trim()!==""&&(await l(a.current.value),a.current.value="",a.current.focus())}return f.useEffect(()=>{var b;s&&((b=s.current)==null||b.scrollTo({top:s.current.scrollHeight}))},[s,c]),f.useEffect(()=>{var b,m,T,k,w;if(!d||c.length===0)return;if((b=d.widget.state)!=null&&b.showChat&&c.length>0&&h.current!==((m=c[c.length-1])==null?void 0:m.timestamp)){h.current=(T=c[c.length-1])==null?void 0:T.timestamp;return}const M=c.filter(g=>!h.current||g.timestamp>h.current).length,{widget:v}=d;M>0&&((k=v.state)==null?void 0:k.unreadMessages)!==M&&((w=v.dispatch)==null||w.call(v,{msg:"unread_msg",count:M}))},[c,d?.widget]),f.createElement("div",{...r,className:"lk-chat"},f.createElement("div",{className:"lk-chat-header"},"Messages",d&&f.createElement(xu,{className:"lk-close-button"},f.createElement(kb,null))),f.createElement("ul",{className:"lk-list lk-chat-messages",ref:s},r.children?c.map((b,m)=>Ru(r.children,{entry:b,key:b.id??m,messageFormatter:n})):c.map((b,m,T)=>{const k=m>=1&&T[m-1].from===b.from,w=m>=1&&b.timestamp-T[m-1].timestamp<6e4;return f.createElement(ly,{key:b.id??m,hideName:k,hideTimestamp:k===!1?!1:w,entry:b,messageFormatter:n})})),f.createElement("form",{className:"lk-chat-form",onSubmit:p},f.createElement("input",{className:"lk-form-control lk-chat-form-input",disabled:u,ref:a,type:"text",placeholder:"Enter a message...",onInput:b=>b.stopPropagation(),onKeyDown:b=>b.stopPropagation(),onKeyUp:b=>b.stopPropagation()}),f.createElement("button",{type:"submit",className:"lk-button lk-chat-form-button",disabled:u},"Send")))}function qa({kind:n,initialSelection:e,onActiveDeviceChange:t,tracks:i,requestPermissions:r=!1,...s}){const[a,o]=f.useState(!1),[c,l]=f.useState([]),[u,d]=f.useState(!0),[h,p]=f.useState(r),b=(w,M)=>{G.debug("handle device change"),o(!1),t?.(w,M)},m=f.useRef(null),T=f.useRef(null);f.useLayoutEffect(()=>{a&&p(!0)},[a]),f.useLayoutEffect(()=>{let w;return m.current&&T.current&&(c||u)&&(w=Sv(m.current,T.current,(M,v)=>{T.current&&Object.assign(T.current.style,{left:`${M}px`,top:`${v}px`})})),d(!1),()=>{w?.()}},[m,T,c,u]);const k=f.useCallback(w=>{T.current&&w.target!==m.current&&a&&Tv(T.current,w)&&o(!1)},[a,T,m]);return f.useEffect(()=>(document.addEventListener("click",k),()=>{document.removeEventListener("click",k)}),[k]),f.createElement(f.Fragment,null,f.createElement("button",{className:"lk-button lk-button-menu","aria-pressed":a,...s,onClick:()=>o(!a),ref:m},s.children),!s.disabled&&f.createElement("div",{className:"lk-device-menu",ref:T,style:{visibility:a?"visible":"hidden"}},n?f.createElement(Rr,{initialSelection:e,onActiveDeviceChange:w=>b(n,w),onDeviceListChange:l,kind:n,track:i?.[n],requestPermissions:h}):f.createElement(f.Fragment,null,f.createElement("div",{className:"lk-device-menu-heading"},"Audio inputs"),f.createElement(Rr,{kind:"audioinput",onActiveDeviceChange:w=>b("audioinput",w),onDeviceListChange:l,track:i?.audioinput,requestPermissions:h}),f.createElement("div",{className:"lk-device-menu-heading"},"Video inputs"),f.createElement(Rr,{kind:"videoinput",onActiveDeviceChange:w=>b("videoinput",w),onDeviceListChange:l,track:i?.videoinput,requestPermissions:h}))))}function dy(){f.useEffect(()=>{j0()},[])}function hy({props:n}){const{dispatch:e,state:t}=Su().widget,i="lk-button lk-settings-toggle";return{mergedProps:f.useMemo(()=>pt(n,{className:i,onClick:()=>{e&&e({msg:"toggle_settings"})},"aria-pressed":t!=null&&t.showSettings?"true":"false"}),[n,i,e,t])}}const fy=f.forwardRef(function(n,e){const{mergedProps:t}=hy({props:n});return f.createElement("button",{ref:e,...t},n.children)}),py=n=>{switch(n){case P.Source.Camera:return 1;case P.Source.Microphone:return 2;case P.Source.ScreenShare:return 3;default:return 0}};function my({variation:n,controls:e,saveUserChoices:t=!0,onDeviceError:i,...r}){var s;const[a,o]=f.useState(!1),c=$n();f.useEffect(()=>{var _,O;((_=c?.widget.state)==null?void 0:_.showChat)!==void 0&&o((O=c?.widget.state)==null?void 0:O.showChat)},[(s=c?.widget.state)==null?void 0:s.showChat]);const l=G0(`(max-width: ${a?1e3:760}px)`)?"minimal":"verbose";n??(n=l);const u={leave:!0,...e},d=eb();if(!d)u.camera=!1,u.chat=!1,u.microphone=!1,u.screenShare=!1;else{const _=O=>d.canPublish&&(d.canPublishSources.length===0||d.canPublishSources.includes(py(O)));u.camera??(u.camera=_(P.Source.Camera)),u.microphone??(u.microphone=_(P.Source.Microphone)),u.screenShare??(u.screenShare=_(P.Source.ScreenShare)),u.chat??(u.chat=d.canPublishData&&e?.chat)}const h=f.useMemo(()=>n==="minimal"||n==="verbose",[n]),p=f.useMemo(()=>n==="textOnly"||n==="verbose",[n]),b=_v(),[m,T]=f.useState(!1),k=f.useCallback(_=>{T(_)},[T]),w=Pt({className:"lk-control-bar"},r),{saveAudioInputEnabled:M,saveVideoInputEnabled:v,saveAudioInputDeviceId:g,saveVideoInputDeviceId:y}=pb({preventSave:!t}),C=f.useCallback((_,O)=>O?M(_):null,[M]),x=f.useCallback((_,O)=>O?v(_):null,[v]);return f.createElement("div",{...w},u.microphone&&f.createElement("div",{className:"lk-button-group"},f.createElement(_r,{source:P.Source.Microphone,showIcon:h,onChange:C,onDeviceError:_=>i?.({source:P.Source.Microphone,error:_})},p&&"Microphone"),f.createElement("div",{className:"lk-button-group-menu"},f.createElement(qa,{kind:"audioinput",onActiveDeviceChange:(_,O)=>g(O??"default")}))),u.camera&&f.createElement("div",{className:"lk-button-group"},f.createElement(_r,{source:P.Source.Camera,showIcon:h,onChange:x,onDeviceError:_=>i?.({source:P.Source.Camera,error:_})},p&&"Camera"),f.createElement("div",{className:"lk-button-group-menu"},f.createElement(qa,{kind:"videoinput",onActiveDeviceChange:(_,O)=>y(O??"default")}))),u.screenShare&&b&&f.createElement(_r,{source:P.Source.ScreenShare,captureOptions:{audio:!0,selfBrowserSurface:"include"},showIcon:h,onChange:k,onDeviceError:_=>i?.({source:P.Source.ScreenShare,error:_})},p&&(m?"Stop screen share":"Share screen")),u.chat&&f.createElement(xu,null,h&&f.createElement(Sb,null),p&&"Chat"),u.settings&&f.createElement(fy,null,h&&f.createElement(Cb,null),p&&"Settings"),u.leave&&f.createElement(vb,null,h&&f.createElement(Eb,null),p&&"Leave"),f.createElement(Lb,null))}function Sy({chatMessageFormatter:n,chatMessageDecoder:e,chatMessageEncoder:t,SettingsComponent:i,...r}){var s,a;const[o,c]=f.useState({showChat:!1,unreadMessages:0,showSettings:!1}),l=f.useRef(null),u=Ou([{source:P.Source.Camera,withPlaceholder:!0},{source:P.Source.ScreenShare,withPlaceholder:!1}],{updateOnlyOn:[I.ActiveSpeakersChanged],onlySubscribed:!1}),d=T=>{G.debug("updating widget state",T),c(T)},h=D0(),p=u.filter(ye).filter(T=>T.publication.source===P.Source.ScreenShare),b=(s=rb(h))==null?void 0:s[0],m=u.filter(T=>!vv(T,b));return f.useEffect(()=>{var T,k,w,M,v,g;if(p.some(y=>y.publication.isSubscribed)&&l.current===null?(G.debug("Auto set screen share focus:",{newScreenShareTrack:p[0]}),(k=(T=h.pin).dispatch)==null||k.call(T,{msg:"set_pin",trackReference:p[0]}),l.current=p[0]):l.current&&!p.some(y=>{var C,x;return y.publication.trackSid===((x=(C=l.current)==null?void 0:C.publication)==null?void 0:x.trackSid)})&&(G.debug("Auto clearing screen share focus."),(M=(w=h.pin).dispatch)==null||M.call(w,{msg:"clear_pin"}),l.current=null),b&&!ye(b)){const y=u.find(C=>C.participant.identity===b.participant.identity&&C.source===b.source);y!==b&&ye(y)&&((g=(v=h.pin).dispatch)==null||g.call(v,{msg:"set_pin",trackReference:y}))}},[p.map(T=>`${T.publication.trackSid}_${T.publication.isSubscribed}`).join(),(a=b?.publication)==null?void 0:a.trackSid,u]),dy(),f.createElement("div",{className:"lk-video-conference",...r},kv()&&f.createElement(sy,{value:h,onWidgetChange:d},f.createElement("div",{className:"lk-video-conference-inner"},b?f.createElement("div",{className:"lk-focus-layout-wrapper"},f.createElement(Jb,null,f.createElement(ry,{tracks:m},f.createElement(us,null)),b&&f.createElement(Yb,{trackRef:b}))):f.createElement("div",{className:"lk-grid-layout-wrapper"},f.createElement(Zb,{tracks:u},f.createElement(us,null))),f.createElement(my,{controls:{chat:!0,settings:!!i}})),f.createElement(uy,{style:{display:o.showChat?"grid":"none"},messageFormatter:n,messageEncoder:t,messageDecoder:e}),i&&f.createElement("div",{className:"lk-settings-menu-modal",style:{display:o.showSettings?"block":"none"}},f.createElement(i,null))),f.createElement(oy,null),f.createElement(cy,null))}export{qu as R,ky as W,f as a,vy as b,Sy as c,gy as d,ju as g,Vu as r};
