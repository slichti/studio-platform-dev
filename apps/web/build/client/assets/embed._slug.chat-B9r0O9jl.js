import{w as q,u as H,h as W}from"./chunk-JZWAC4HX-Cg_gv2PJ.js";import{j as e}from"./vendor-puck-D_CB0wXL.js";import{a as o}from"./vendor-sentry-DugYw-Ne.js";import{C as X}from"./ChatWindow-BSmn-T_8.js";import{M as B}from"./message-circle-BZuCfo3t.js";import{X as F}from"./x-Bbpoc0N5.js";import"./send-RRFVKZfr.js";import"./createLucideIcon-BOpDDQ2B.js";const oe=q(function(){const{apiUrl:d,tenant:n}=H(),{slug:a}=W(),[T,j]=o.useState("welcome"),[m,S]=o.useState(null),[v,N]=o.useState(!1),x=(()=>{if(!n?.chatConfig?.schedule)return!0;const{timezone:t,schedule:r}=n.chatConfig;try{const s=new Date,i=new Intl.DateTimeFormat("en-US",{timeZone:t||"UTC",weekday:"short",hour:"numeric",minute:"numeric",hour12:!1}).formatToParts(s),y=i.find(u=>u.type==="weekday")?.value,l=parseInt(i.find(u=>u.type==="hour")?.value||"0"),p=parseInt(i.find(u=>u.type==="minute")?.value||"0"),c=l*60+p;if(!y)return!0;const g=r[y];if(!g||!Array.isArray(g)||g.length!==2)return!1;const[P,I]=g,[M,_]=P.split(":").map(Number),[A,D]=I.split(":").map(Number),J=M*60+_,U=A*60+D;return c>=J&&c<U}catch(s){return console.error("Timezone Check Error",s),!0}})(),[b,k]=o.useState(""),[w,$]=o.useState(""),[h,R]=o.useState(""),[C,E]=o.useState(null);o.useEffect(()=>{const t=localStorage.getItem(`chat_session_${a}`);if(t)try{const r=JSON.parse(t);S(r),j("chat")}catch{localStorage.removeItem(`chat_session_${a}`)}},[a]);const O=async t=>{t.preventDefault(),N(!0);try{const s=await(await fetch(`${d}/guest/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:b,email:w})})).json();if(s.error)throw new Error(s.error);const f=s.token,i=s.user,l=await(await fetch(`${d}/chat/rooms`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`,"X-Tenant-Slug":a||""},body:JSON.stringify({type:"support",name:`Support: ${b}`,customer_email:w,metadata:{source:"widget",initialMessage:h},priority:"normal",routedRole:C||void 0})})).json();if(l.error)throw new Error(l.error);const p=l.id;h.trim()&&await fetch(`${d}/chat/rooms/${p}/messages`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`,"X-Tenant-Slug":a||""},body:JSON.stringify({content:h})});const c={token:f,roomId:p,user:i};S(c),localStorage.setItem(`chat_session_${a}`,JSON.stringify(c)),j("chat")}catch(r){alert("Failed to start chat: "+r.message)}finally{N(!1)}},z=()=>{window.parent.postMessage({type:"studio-chat-close"},"*")};return T==="welcome"?e.jsxs("div",{className:"h-screen w-screen bg-white flex flex-col font-sans",children:[e.jsx("div",{className:"bg-blue-600 p-4 text-white flex justify-between items-center shadow-md",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{size:20}),e.jsx("h1",{className:"font-semibold",children:"Support Chat"})]})}),e.jsxs("div",{className:"flex-1 p-6 flex flex-col justify-center",children:[e.jsx("p",{className:"text-zinc-600 mb-6 text-center",children:x?"Welcome! Please fill in your details to start a support chat with us.":`We are currently offline. Please leave a message and we'll get back to you at ${n?.chatConfig?.offlineEmail||"email"}.`}),e.jsxs("form",{onSubmit:O,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Name"}),e.jsx("input",{required:!0,className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",placeholder:"Your Name",value:b,onChange:t=>k(t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Email"}),e.jsx("input",{required:!0,type:"email",className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",placeholder:"you@example.com",value:w,onChange:t=>$(t.target.value)})]}),n?.settings?.chatConfig&&Array.isArray(n.settings.chatConfig)&&n.settings.chatConfig.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Topic"}),e.jsxs("select",{className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",value:C||"",onChange:t=>E(t.target.value||null),children:[e.jsx("option",{value:"",children:"Select a topic..."}),n.settings.chatConfig.map(t=>e.jsx("option",{value:t.routeToRole||"",children:t.label},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-zinc-700 mb-1",children:"Message"}),e.jsx("textarea",{required:!0,rows:3,className:"w-full border border-zinc-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:outline-none",placeholder:"How can we help?",value:h,onChange:t=>R(t.target.value)})]}),e.jsx("button",{type:"submit",disabled:v,className:`w-full text-white font-semibold py-3 rounded-lg shadow-sm disabled:opacity-50 ${x?"bg-blue-600 hover:bg-blue-700":"bg-zinc-800 hover:bg-zinc-900"}`,children:v?"Sending...":x?"Start Chat":"Send Message"})]})]}),e.jsx("div",{className:"p-4 text-center text-xs text-zinc-400 border-t border-zinc-100",children:"Powered by Studio Platform"})]}):m?e.jsx("div",{className:"h-screen w-screen bg-white",children:e.jsxs("div",{className:"h-full flex flex-col relative",children:[e.jsx("div",{className:"absolute top-0 right-0 z-50 p-2 hidden",children:e.jsx("button",{onClick:z,children:e.jsx(F,{})})}),e.jsx(X,{roomId:m.roomId,token:m.token,currentUser:m.user,wsUrl:d,onClose:z})]})}):null});export{oe as default};
